<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">






  
  
  <link rel="stylesheet" media="all" href="/lib/Han/dist/han.min.css?v=3.3">




<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="google-site-verification" content="WSWvVPyzUsUM54ydNcrE1pUzdYt5xGKnqD1i7XpWVF8" />














  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png?v=5.1.4">


  <link rel="mask-icon" href="/images/safari-pinned-tab.svg?v=5.1.4" color="#222">


  <link rel="manifest" href="/images/site.webmanifest">


  <meta name="msapplication-config" content="/images/browserconfig.xml" />



  <meta name="keywords" content="Welcome" />










<meta name="description" content="学习、生活、闲谈、足球">
<meta property="og:type" content="website">
<meta property="og:title" content="一只病猫">
<meta property="og:url" content="https://dinghuang.github.io/index.html">
<meta property="og:site_name" content="一只病猫">
<meta property="og:description" content="学习、生活、闲谈、足球">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="一只病猫">
<meta name="twitter:description" content="学习、生活、闲谈、足球">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":true},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://dinghuang.github.io/"/>





  <title>一只病猫</title>
  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-108021384-1', 'auto');
  ga('send', 'pageview');
</script>


  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?00a1ba3f5c477c92d7c1ccbb00c6427b";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">一只病猫</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">静坐常思己过，闲谈莫论人非</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
            分类
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="st-search-show-outputs">
          
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <form class="site-search-form">
  <input type="text" id="st-search-input" class="st-search-input st-default-search-input" />
</form>

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'HcRPHRrBuwozvgUoLNyX','2.0.0');
</script>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dinghuang.github.io/2022/06/08/Spock单元测试/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="强壮的病猫">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/dinghuang.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一只病猫">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2022/06/08/Spock单元测试/" itemprop="url">Spock-Spring-Gradle 单元测试</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2022-06-08T15:47:00+08:00">
                2022-06-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JAVA/" itemprop="url" rel="index">
                    <span itemprop="name">JAVA</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2022/06/08/Spock单元测试/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2022/06/08/Spock单元测试/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Spock介绍"><a href="#Spock介绍" class="headerlink" title="Spock介绍"></a>Spock介绍</h1><p><code>Spock</code>是国外一款优秀的测试框架，基于<code>BDD</code>（行为驱动开发）思想实现，功能非常强大。<code>Spock</code>结合<code>Groovy</code>动态语言的特点，提供了各种标签，并采用简单、通用、结构化的描述语言，让编写测试代码更加简洁、高效。<code>Spock</code>作为测试框架，在开发效率、可读性和维护性方面均取得了不错的收益。</p>
<h1 id="修改项目配置"><a href="#修改项目配置" class="headerlink" title="修改项目配置"></a>修改项目配置</h1><p>项目用<code>gradle</code>管理，用的是<code>7.4.2</code>版本，<code>spock</code>用的是<code>2.0-M3-groovy-3.0</code>版本。</p>
<h2 id="配置修改"><a href="#配置修改" class="headerlink" title="配置修改"></a>配置修改</h2><p>修改文件<code>build.gradle</code>并添加依赖<br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">List</span> spockTest = [</span><br><span class="line">        <span class="string">"org.spockframework:spock-core:2.0-M3-groovy-3.0"</span>,</span><br><span class="line">        <span class="string">"org.spockframework:spock-spring:2.0-M3-groovy-3.0"</span>,</span><br><span class="line">        <span class="string">"org.mockito:mockito-core:4.3.1"</span>,</span><br><span class="line">        <span class="string">"org.mockito:mockito-inline:4.3.1"</span>,</span><br><span class="line">        <span class="string">"org.springframework.boot:spring-boot-starter-test"</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    <span class="attribute">implementation</span> <span class="string">'org.codehaus.groovy:groovy:3.0.5'</span></span><br><span class="line">    testImplementation spockTest</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sourceSets &#123;</span><br><span class="line">    <span class="section">main</span> &#123;</span><br><span class="line">        <span class="section">java</span> &#123; <span class="attribute">srcDirs</span> = [<span class="string">'src/main/java'</span>] &#125;</span><br><span class="line">        resources &#123; <span class="attribute">srcDirs</span> = [<span class="string">'src/main/resources'</span>] &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    test &#123;</span><br><span class="line">        <span class="section">java</span> &#123; <span class="attribute">srcDirs</span> = [<span class="string">'src/test/groovy'</span>] &#125;</span><br><span class="line">        resources &#123; <span class="attribute">srcDirs</span> = [<span class="string">'src/test/resources'</span>] &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">apply from: <span class="string">'test.gradle'</span></span><br></pre></td></tr></table></figure></p>
<p>修改<code>test.gradle</code>，这步主要是和<code>jacoco</code>结合生成报告（带覆盖率，用的<code>jacoco</code>的<code>offline</code>特性）<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">apply <span class="keyword">from</span>: <span class="string">'testFilesConf.gradle'</span></span><br><span class="line">apply plugin: <span class="string">'java'</span></span><br><span class="line">apply plugin: <span class="string">"groovy"</span></span><br><span class="line">apply plugin: <span class="string">"jacoco"</span></span><br><span class="line"></span><br><span class="line">jacoco &#123;</span><br><span class="line">    toolVersion = <span class="string">"0.8.7"</span></span><br><span class="line">    reportsDir = <span class="keyword">file</span>(<span class="string">"$buildDir/customJacocoReportDir"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">configurations</span> &#123;</span><br><span class="line">    jacocoAnt</span><br><span class="line">    jacocoRuntime</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">test &#123;</span><br><span class="line">    useJUnitPlatform()</span><br><span class="line">    maxHeapSize = <span class="string">"1G"</span></span><br><span class="line">    jacoco &#123;</span><br><span class="line">        destinationFile = <span class="keyword">file</span>(<span class="string">"$buildDir/jacoco/test.exec"</span>)</span><br><span class="line">        classDumpDir = <span class="keyword">file</span>(<span class="string">"$buildDir/jacoco/classpathdumps"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    testLogging &#123;</span><br><span class="line">        afterSuite &#123; desc, result -&gt;</span><br><span class="line">            <span class="keyword">if</span> (!desc.parent) &#123;</span><br><span class="line">                <span class="keyword">println</span> <span class="string">"Unit Tests: $&#123;result.resultType&#125; ($&#123;result.testCount&#125; tests, $&#123;result.successfulTestCount&#125; successes, $&#123;result.failedTestCount&#125; failures, $&#123;result.skippedTestCount&#125; skipped)"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> excludedSourcesPattern = [<span class="string">'**/entity/**'</span>, <span class="string">'**/dto/**'</span>]</span><br><span class="line"></span><br><span class="line">jacocoTestReport &#123;</span><br><span class="line">    reports &#123;</span><br><span class="line">        html.enabled <span class="keyword">true</span></span><br><span class="line">        csv.enabled <span class="keyword">false</span></span><br><span class="line">        xml.enabled <span class="keyword">true</span></span><br><span class="line">        xml.destination <span class="keyword">file</span>(<span class="string">"$buildDir/jacocoHtml/jacocoXml.xml"</span>)</span><br><span class="line">        html.destination <span class="keyword">file</span>(<span class="string">"$buildDir/reports/jacoco/test/html"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    afterEvaluate &#123;</span><br><span class="line">        getClassDirectories().setFrom(</span><br><span class="line">                classDirectories.files.<span class="keyword">collect</span> &#123;</span><br><span class="line">                    <span class="keyword">fileTree</span>(dir: it, excludes: excludedSourcesPattern)</span><br><span class="line">                &#125;</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> compileClassPath = [  <span class="string">"$&#123;project.buildDir&#125;/classes/java/main"</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">task</span> instrument(dependsOn: [<span class="string">'classes'</span>]) &#123;</span><br><span class="line">    ext.outputDir = buildDir.path + <span class="string">'/intermediates/classes-instrumented/Java'</span></span><br><span class="line">    <span class="keyword">doLast</span> &#123;</span><br><span class="line">        <span class="keyword">ant</span>.taskdef(name: <span class="string">'instrument'</span>,</span><br><span class="line">                classname: <span class="string">'org.jacoco.ant.InstrumentTask'</span>,</span><br><span class="line">                <span class="keyword">classpath</span>: <span class="keyword">configurations</span>.jacocoAnt.asPath)</span><br><span class="line">        <span class="keyword">ant</span>.instrument(destdir: outputDir) &#123;</span><br><span class="line">            compileClassPath.<span class="keyword">each</span> &#123;</span><br><span class="line">                fileset(dir: it)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">gradle.taskGraph.whenReady &#123; graph -&gt;</span><br><span class="line">    <span class="keyword">if</span> (graph.hasTask(instrument)) &#123;</span><br><span class="line">        tasks.withType(Test) &#123;</span><br><span class="line">            <span class="keyword">doFirst</span> &#123;</span><br><span class="line">                systemProperty <span class="string">'jacoco-agent.destfile'</span>, buildDir.path + <span class="string">'/jacoco/test.exec'</span></span><br><span class="line">                <span class="keyword">classpath</span> = files(instrument.outputDir) + <span class="keyword">classpath</span> + <span class="keyword">configurations</span>.jacocoRuntime</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">task</span> jacocoReport(dependsOn: [<span class="string">'instrument'</span>, <span class="string">'test'</span>]) &#123;</span><br><span class="line">    <span class="keyword">doLast</span> &#123;</span><br><span class="line">        <span class="keyword">ant</span>.taskdef(name: <span class="string">'report'</span>,</span><br><span class="line">                classname: <span class="string">'org.jacoco.ant.ReportTask'</span>,</span><br><span class="line">                <span class="keyword">classpath</span>: <span class="keyword">configurations</span>.jacocoAnt.asPath)</span><br><span class="line">        <span class="keyword">ant</span>.report() &#123;</span><br><span class="line">            executiondata &#123;</span><br><span class="line">                <span class="keyword">ant</span>.<span class="keyword">file</span>(<span class="keyword">file</span>: buildDir.path + <span class="string">"/jacoco/test.exec"</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            structure(name: <span class="keyword">project</span>.name) &#123;</span><br><span class="line">                classfiles &#123;</span><br><span class="line">                    compileClassPath.<span class="keyword">each</span> &#123;</span><br><span class="line">                        fileset(dir: it)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                sourcefiles &#123;</span><br><span class="line">                    fileset(dir: <span class="string">'src/main/java'</span>)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            html(destdir: buildDir.path + <span class="string">'/reports/jacoco'</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">check.dependsOn jacocoTestReport</span><br></pre></td></tr></table></figure></p>
<h2 id="对Spring的封装"><a href="#对Spring的封装" class="headerlink" title="对Spring的封装"></a>对Spring的封装</h2><p>这边对Spring做了一个封装，可以做成一个测试的maven模块，先写一个自定义注解，主要是用作Spring容器的启动，同时制定启动的配置文件为test<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @version 1.0</span></span><br><span class="line"><span class="comment"> * @Author: dinghuang</span></span><br><span class="line"><span class="comment"> * @Description:</span></span><br><span class="line"><span class="comment"> * @Date: since 2022/5/30 16:03</span></span><br><span class="line"><span class="comment"> * @Modify By: dinghuang</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="variable">@Target</span>(ElementType.TYPE)</span><br><span class="line"><span class="variable">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="variable">@Documented</span></span><br><span class="line"><span class="variable">@Inherited</span></span><br><span class="line"><span class="variable">@SpringBootTest</span>(webEnvironment = RANDOM_PORT, classes = ServerApplication.class)</span><br><span class="line"><span class="variable">@ActiveProfiles</span>(<span class="string">"test"</span>)</span><br><span class="line"><span class="variable">@Stepwise</span></span><br><span class="line">public <span class="variable">@interface</span> CustomTest &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个时候我们在test的resource下面的<code>application.properties</code>修改一下配置<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spring<span class="selector-class">.profiles</span><span class="selector-class">.active</span>=test</span><br></pre></td></tr></table></figure></p>
<p>接下来就是写代码了</p>
<h1 id="代码编写"><a href="#代码编写" class="headerlink" title="代码编写"></a>代码编写</h1><p>代码写在<code>test</code>目录下，跟<code>junit</code>不一样的是，目录结构是：<code>test-&gt;groovy-&gt;xxxx.xxx.xxx</code></p>
<blockquote>
<p>需要<code>IDEA</code>把<code>groovy</code>的<code>mark directory</code>设置成<code>test root</code></p>
</blockquote>
<h2 id="单元测试"><a href="#单元测试" class="headerlink" title="单元测试"></a>单元测试</h2><p>这边不懂Spock的语法的，可以百度下，这边直接略过</p>
<p>先看业务代码，业务很简单，查一个字典表返回数据<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: dinghuang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>:</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: since 2022/4/1 18:05</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Modify</span> By: dinghuang</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SysDictService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(SysDictService.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SysDictDao sysDictDao;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function">String <span class="title">getDictName</span><span class="params">(String dict)</span> </span>&#123;</span><br><span class="line">        SysDict sysDict = sysDictDao.selectByPrimaryKey(dict);</span><br><span class="line">        <span class="function"><span class="keyword">return</span> sysDict.<span class="title">getDictname</span><span class="params">()</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="Mock模拟"><a href="#Mock模拟" class="headerlink" title="Mock模拟"></a>Mock模拟</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @Author: dinghuang</span></span><br><span class="line"><span class="comment"> * @Description:</span></span><br><span class="line"><span class="comment"> * @Date: since 2022/5/30 16:18</span></span><br><span class="line"><span class="comment"> * @version 1.0</span></span><br><span class="line"><span class="comment"> * @Modify By: dinghuang</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@CustomTest</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestControllerTest</span> <span class="keyword">extends</span> <span class="title">Specification</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="type">SysDictTestService</span> sysDictTestService</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SpringBean</span></span><br><span class="line">    <span class="type">SysDictDao</span> sysDictDao = <span class="type">Mock</span>()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> '<span class="title">Mock测试</span>'</span>() &#123;</span><br><span class="line">        given:</span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">dict</span> </span>= '系统'</span><br><span class="line">        <span class="number">1</span> * sysDictDao.selectByPrimaryKey(dict) &gt;&gt; <span class="keyword">new</span> <span class="type">SysDict</span>('系统')</span><br><span class="line"></span><br><span class="line">        when:</span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">result</span> </span>= sysDictTestService.getDictName(dict)</span><br><span class="line"></span><br><span class="line">        then:</span><br><span class="line">        result == '系统'</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Where使用"><a href="#Where使用" class="headerlink" title="Where使用"></a>Where使用</h3><p>正常我们单元测试率有个分支覆盖率指标，如果用junit写太麻烦了，用spock可以非常简洁，假如字典的逻辑不同的dictName有不同的处理逻辑<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @Author: dinghuang</span></span><br><span class="line"><span class="comment"> * @Description:</span></span><br><span class="line"><span class="comment"> * @Date: since 2022/5/30 16:18</span></span><br><span class="line"><span class="comment"> * @version 1.0</span></span><br><span class="line"><span class="comment"> * @Modify By: dinghuang</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@CustomTest</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestControllerTest</span> <span class="keyword">extends</span> <span class="title">Specification</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="type">SysDictTestService</span> sysDictTestService</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SpringBean</span></span><br><span class="line">    <span class="type">SysDictDao</span> sysDictDao = <span class="type">Mock</span>()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> '<span class="title">Where测试</span>'</span>() &#123;</span><br><span class="line">        given:</span><br><span class="line">        sysDictDao.selectByPrimaryKey(a) &gt;&gt; d</span><br><span class="line"></span><br><span class="line">        when:</span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">b</span> </span>= sysDictTestService.getDictName(a)</span><br><span class="line"></span><br><span class="line">        then:</span><br><span class="line">        b == c</span><br><span class="line"></span><br><span class="line">        where:</span><br><span class="line">        a       | d                       || c</span><br><span class="line">        <span class="symbol">'1000</span>0' | <span class="keyword">new</span> <span class="type">SysDict</span>('系统')       || '系统'</span><br><span class="line">        <span class="symbol">'1000</span>4' | <span class="keyword">new</span> <span class="type">SysDict</span>('多点登录处理方式') || '多点登录处理方式'</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里可以用<code>@Unroll</code>注解，可以把每一次调用作为一个单独的测试用例运行，这样运行后的单元测试结果更加直观：<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">@Unroll</span><br><span class="line"><span class="function"><span class="keyword">def</span> '<span class="title">Where</span>测试'<span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="symbol">given:</span></span><br><span class="line">    sysDictDao.selectByPrimaryKey(a) <span class="meta">&gt;&gt; </span>d</span><br><span class="line"></span><br><span class="line">    <span class="symbol">when:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">b</span> = <span class="title">sysDictTestService</span>.<span class="title">getDictName</span><span class="params">(a)</span></span></span><br><span class="line"></span><br><span class="line">    <span class="symbol">then:</span></span><br><span class="line">    b == c</span><br><span class="line"></span><br><span class="line">    <span class="symbol">where:</span></span><br><span class="line">    a       <span class="params">| d                       |</span><span class="params">| c</span></span><br><span class="line"><span class="params">    '10000' |</span> new SysDict(<span class="string">'系统'</span>)       <span class="params">||</span> <span class="string">'系统'</span></span><br><span class="line">    <span class="string">'10004'</span> <span class="params">| new SysDict('多点登录处理方式') |</span><span class="params">| '多点登录处理方式'</span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">&#125;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="测试异常"><a href="#测试异常" class="headerlink" title="测试异常"></a>测试异常</h3><p>先修改一下业务代码，如下<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: dinghuang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>:</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: since 2022/4/1 18:05</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Modify</span> By: dinghuang</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SysDictTestService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(SysDictTestService.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SysDictDao sysDictDao;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function">String <span class="title">getDictName</span><span class="params">(String dict)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"测试异常"</span>.equals(dict)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BusinessException(ErrorCodeEnum.SYS_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">        SysDict sysDict = sysDictDao.selectByPrimaryKey(dict);</span><br><span class="line">        <span class="function"><span class="keyword">return</span> sysDict.<span class="title">getDictname</span><span class="params">()</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>写异常测试类<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @Author: dinghuang</span></span><br><span class="line"><span class="comment"> * @Description:</span></span><br><span class="line"><span class="comment"> * @Date: since 2022/5/30 16:18</span></span><br><span class="line"><span class="comment"> * @version 1.0</span></span><br><span class="line"><span class="comment"> * @Modify By: dinghuang</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@CustomTest</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestControllerTest</span> <span class="keyword">extends</span> <span class="title">Specification</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="type">SysDictTestService</span> sysDictTestService</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> '<span class="title">测试异常</span>'</span>() &#123;</span><br><span class="line">        given:</span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">dict</span> </span>= '测试异常'</span><br><span class="line"></span><br><span class="line">        when:</span><br><span class="line">        sysDictTestService.getDictName(dict)</span><br><span class="line"></span><br><span class="line">        then:</span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">exception</span> </span>= thrown(<span class="type">BusinessException</span>)</span><br><span class="line">        exception.errorCode == <span class="symbol">'2137999</span>9'</span><br><span class="line">        exception.message == <span class="symbol">'bizErrCode</span>=<span class="number">21379999</span>,bizErrMsg=系统异常'</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="静态方法Mock"><a href="#静态方法Mock" class="headerlink" title="静态方法Mock"></a>静态方法Mock</h3><p>先修改一下业务代码<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: dinghuang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>:</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: since 2022/4/1 18:05</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Modify</span> By: dinghuang</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SysDictTestService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(SysDictTestService.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SysDictDao sysDictDao;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function">String <span class="title">getDateStr</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">return</span> DateUtil.<span class="title">getCurrentSysDate</span><span class="params">()</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DateUtil</span> </span>&#123;</span><br><span class="line">     <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">String</span> getCurrentSysDate() &#123;</span><br><span class="line">        <span class="keyword">return</span> getDate(<span class="keyword">new</span> <span class="type">Date</span>(), yyyyMMdd_PATTERN);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>静态方法测试<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @Author: dinghuang</span></span><br><span class="line"><span class="comment"> * @Description:</span></span><br><span class="line"><span class="comment"> * @Date: since 2022/5/30 16:18</span></span><br><span class="line"><span class="comment"> * @version 1.0</span></span><br><span class="line"><span class="comment"> * @Modify By: dinghuang</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@CustomTest</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestControllerTest</span> <span class="keyword">extends</span> <span class="title">Specification</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="type">SysDictTestService</span> sysDictTestService</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Shared</span></span><br><span class="line">    <span class="type">MockedStatic</span>&lt;<span class="type">DateUtil</span>&gt; dateUtilMockedStatic</span><br><span class="line"></span><br><span class="line">    void setup() &#123;</span><br><span class="line">        dateUtilMockedStatic = <span class="type">Mockito</span>.mockStatic(<span class="type">DateUtil</span>.<span class="keyword">class</span>)</span><br><span class="line">        <span class="comment">// mock静态类</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> '<span class="title">测试异常</span>'</span>() &#123;</span><br><span class="line">        given:</span><br><span class="line">        <span class="type">Mockito</span>.when(<span class="type">DateUtil</span>.getCurrentSysDate()).thenReturn(<span class="string">"1991-01-02"</span>)</span><br><span class="line"></span><br><span class="line">        when:</span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">date</span> </span>= sysDictTestService.getDateStr()</span><br><span class="line"></span><br><span class="line">        then:</span><br><span class="line">        date == <span class="string">"1991-01-02"</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="测试sql"><a href="#测试sql" class="headerlink" title="测试sql"></a>测试sql</h3><p>这个原理是在每个单元测试可以写一个前置后置处理方法，比如跑测试A，会自动跑测试A的前置，把数据库初始化进去，数据初始化进去，用的是H2内存数据库，但是这个东西对特定数据库的一些语法不支持，所以不太建议这么做，简单的sql的确可以测试出问题</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 直接获取待测试的mapper</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">def</span> personInfoMapper = MapperUtil.getMapper(PersonInfoMapper.<span class="keyword">class</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 测试数据准备，通常为sql表结构创建用的ddl，支持多个文件以逗号分隔。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">def</span> setup() &#123;</span><br><span class="line">executeSqlScriptFile(<span class="string">"com/xxx/xxx/xxx/......../schema.sql"</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 数据表清除，通常待drop的数据表</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">def</span> cleanup() &#123;</span><br><span class="line">dropTables(<span class="string">"person_info"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 直接构造数据库中的数据表,此方法适用于数据量较小的mapper sql测试</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@MyDbUnit</span>(</span><br><span class="line">    content = &#123;</span><br><span class="line">        person_info(<span class="string">id:</span> <span class="number">1</span>, <span class="string">name:</span> <span class="string">"abc"</span>, <span class="string">age:</span> <span class="number">21</span>)</span><br><span class="line">        person_info(<span class="string">id:</span> <span class="number">2</span>, <span class="string">name:</span> <span class="string">"bcd"</span>, <span class="string">age:</span> <span class="number">22</span>)</span><br><span class="line">        person_info(<span class="string">id:</span> <span class="number">3</span>, <span class="string">name:</span> <span class="string">"cde"</span>, <span class="string">age:</span> <span class="number">23</span>)</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line"><span class="keyword">def</span> <span class="string">"demo1_01"</span>() &#123;</span><br><span class="line"><span class="string">when:</span></span><br><span class="line"><span class="keyword">int</span> beforeCount = personInfoMapper.count()</span><br><span class="line"><span class="comment">// groovy sql用于快速执行sql，不仅能验证数据结果，也可向数据中添加数据。</span></span><br><span class="line"><span class="keyword">def</span> result = <span class="keyword">new</span> Sql(dataSource).firstRow(<span class="string">"select * from `person_info`"</span>) </span><br><span class="line"><span class="keyword">int</span> deleteCount = personInfoMapper.deleteById(<span class="number">1</span>L)</span><br><span class="line"><span class="keyword">int</span> afterCount = personInfoMapper.count()</span><br><span class="line"></span><br><span class="line"><span class="string">then:</span></span><br><span class="line">beforeCount == <span class="number">3</span></span><br><span class="line">result.name == <span class="string">"abc"</span></span><br><span class="line">deleteCount == <span class="number">1</span></span><br><span class="line">afterCount == <span class="number">2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="报告"><a href="#报告" class="headerlink" title="报告"></a>报告</h3><p>正常运行完成<code>gradle test</code>会生成报告在路径<code>build\reports\tests\test\index.html</code>，这个是html的，没有覆盖率的情况，如图所示：</p>
<p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/common/WechatIMG758.png" alt=""></p>
<p>运行我们<code>test.gradle</code>中自己写的task，<code>gradle jacocoReport</code>，会生成单元测试覆盖报告在路径<code>build\reports\jacoco\index.html</code>，如图所示</p>
<p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/common/WechatIMG759.png" alt=""></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dinghuang.github.io/2022/03/07/RocketMQ安装使用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="强壮的病猫">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/dinghuang.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一只病猫">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2022/03/07/RocketMQ安装使用/" itemprop="url">RocketMQ安装使用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2022-03-07T15:47:00+08:00">
                2022-03-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2022/03/07/RocketMQ安装使用/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2022/03/07/RocketMQ安装使用/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>RocketMQ 一个纯 Java、分布式、队列模型的开源消息中间件，前身是 MetaQ，是阿里研发的一个队列模型的消息中间件，后开源给 apache 基金会成为了 apache的顶级开源项目，具有高性能、高可靠、高实时、分布式特点。</p>
<h2 id="架构设计"><a href="#架构设计" class="headerlink" title="架构设计"></a>架构设计</h2><p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/common/p68921.png" alt="image"></p>
<ul>
<li>Name Server：是一个几乎无状态节点，可集群部署，在消息队列RocketMQ版中提供命名服务，更新和发现Broker服务。</li>
<li>Broker：消息中转角色，负责存储消息，转发消息。分为Master Broker和Slave Broker，一个Master Broker可以对应多个Slave Broker，但是一个Slave Broker只能对应一个Master Broker。Broker启动后需要完成一次将自己注册至Name Server的操作；随后每隔30s定期向Name Server上报Topic路由信息。</li>
<li>生产者：与Name Server集群中的其中一个节点（随机）建立长连接（Keep-alive），定期从Name Server读取Topic路由信息，并向提供Topic服务的Master Broker建立长连接，且定时向Master Broker发送心跳。</li>
<li>消费者：与Name Server集群中的其中一个节点（随机）建立长连接，定期从Name Server拉取Topic路由信息，并向提供Topic服务的Master Broker、Slave Broker建立长连接，且定时向Master Broker、Slave Broker发送心跳。Consumer既可以从Master Broker订阅消息，也可以从Slave Broker订阅消息，订阅规则由Broker配置决定。</li>
</ul>
<h3 id="部署架构"><a href="#部署架构" class="headerlink" title="部署架构"></a>部署架构</h3><p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/common/rocketmq_architecture_3.png" alt="image"></p>
<ul>
<li><p>NameServer是一个几乎无状态节点，可集群部署，节点之间无任何信息同步。</p>
</li>
<li><p>Broker部署相对复杂，Broker分为Master与Slave，一个Master可以对应多个Slave，但是一个Slave只能对应一个Master，Master与Slave 的对应关系通过指定相同的BrokerName，不同的BrokerId 来定义，BrokerId为0表示Master，非0表示Slave。Master也可以部署多个。每个Broker与NameServer集群中的所有节点建立长连接，定时注册Topic信息到所有NameServer。 注意：当前RocketMQ版本在部署架构上支持一Master多Slave，但只有BrokerId=1的从服务器才会参与消息的读负载。</p>
</li>
<li><p>Producer与NameServer集群中的其中一个节点（随机选择）建立长连接，定期从NameServer获取Topic路由信息，并向提供Topic 服务的Master建立长连接，且定时向Master发送心跳。Producer完全无状态，可集群部署。</p>
</li>
<li><p>Consumer与NameServer集群中的其中一个节点（随机选择）建立长连接，定期从NameServer获取Topic路由信息，并向提供Topic服务的Master、Slave建立长连接，且定时向Master、Slave发送心跳。Consumer既可以从Master订阅消息，也可以从Slave订阅消息，消费者在向Master拉取消息时，Master服务器会根据拉取偏移量与最大偏移量的距离（判断是否读老消息，产生读I/O），以及从服务器是否可读等因素建议下一次是从Master还是Slave拉取。</p>
</li>
</ul>
<p>结合部署架构图，描述集群工作流程：</p>
<ul>
<li>启动NameServer，NameServer起来后监听端口，等待Broker、Producer、Consumer连上来，相当于一个路由控制中心。</li>
<li>Broker启动，跟所有的NameServer保持长连接，定时发送心跳包。心跳包中包含当前Broker信息(IP+端口等)以及存储所有Topic信息。注册成功后，NameServer集群中就有Topic跟Broker的映射关系。</li>
<li>收发消息前，先创建Topic，创建Topic时需要指定该Topic要存储在哪些Broker上，也可以在发送消息时自动创建Topic。</li>
<li>Producer发送消息，启动时先跟NameServer集群中的其中一台建立长连接，并从NameServer中获取当前发送的Topic存在哪些Broker上，轮询从队列列表中选择一个队列，然后与队列所在的Broker建立长连接从而向Broker发消息。</li>
<li>Consumer跟Producer类似，跟其中一台NameServer建立长连接，获取当前订阅Topic存在哪些Broker上，然后直接跟Broker建立连接通道，开始消费消息。<h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2></li>
</ul>
<h3 id="消息模型（Message-Model）"><a href="#消息模型（Message-Model）" class="headerlink" title="消息模型（Message Model）"></a>消息模型（Message Model）</h3><p>RocketMQ主要由 Producer、Broker、Consumer 三部分组成，其中Producer 负责生产消息，Consumer 负责消费消息，Broker 负责存储消息。Broker 在实际部署过程中对应一台服务器，每个 Broker 可以存储多个Topic的消息，每个Topic的消息也可以分片存储于不同的 Broker。Message Queue 用于存储消息的物理地址，每个Topic中的消息地址存储于多个 Message Queue 中。ConsumerGroup 由多个Consumer 实例构成。</p>
<h3 id="消息生产者（Producer）"><a href="#消息生产者（Producer）" class="headerlink" title="消息生产者（Producer）"></a>消息生产者（Producer）</h3><p>负责生产消息，一般由业务系统负责生产消息。一个消息生产者会把业务应用系统里产生的消息发送到broker服务器。RocketMQ提供多种发送方式，同步发送、异步发送、顺序发送、单向发送。同步和异步方式均需要Broker返回确认信息，单向发送不需要。</p>
<h3 id="消息消费者（Consumer）"><a href="#消息消费者（Consumer）" class="headerlink" title="消息消费者（Consumer）"></a>消息消费者（Consumer）</h3><p>负责消费消息，一般是后台系统负责异步消费。一个消息消费者会从Broker服务器拉取消息、并将其提供给应用程序。从用户应用的角度而言提供了两种消费形式：拉取式消费、推动式消费。</p>
<h3 id="主题（Topic）"><a href="#主题（Topic）" class="headerlink" title="主题（Topic）"></a>主题（Topic）</h3><p>表示一类消息的集合，每个主题包含若干条消息，每条消息只能属于一个主题，是RocketMQ进行消息订阅的基本单位。</p>
<h3 id="代理服务器（Broker-Server）"><a href="#代理服务器（Broker-Server）" class="headerlink" title="代理服务器（Broker Server）"></a>代理服务器（Broker Server）</h3><p>消息中转角色，负责存储消息、转发消息。代理服务器在RocketMQ系统中负责接收从生产者发送来的消息并存储、同时为消费者的拉取请求作准备。代理服务器也存储消息相关的元数据，包括消费者组、消费进度偏移和主题和队列消息等。</p>
<p>Broker包含了以下几个重要子模块：</p>
<ul>
<li>Remoting Module：整个Broker的实体，负责处理来自clients端的请求。</li>
<li>Client Manager：负责管理客户端(Producer/Consumer)和维护Consumer的Topic订阅信息</li>
<li>Store Service：提供方便简单的API接口处理消息存储到物理硬盘和查询功能。</li>
<li>HA Service：高可用服务，提供Master Broker 和 Slave Broker之间的数据同步功能。</li>
<li>Index Service：根据特定的Message key对投递到Broker的消息进行索引服务，以提供消息的快速查询。<br><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/common/rocketmq_architecture_1.png" alt="image"><h3 id="名字服务（Name-Server）"><a href="#名字服务（Name-Server）" class="headerlink" title="名字服务（Name Server）"></a>名字服务（Name Server）</h3>名称服务充当路由消息的提供者。生产者或消费者能够通过名字服务查找各主题相应的Broker IP列表。多个Namesrv实例组成集群，但相互独立，没有信息交换。</li>
</ul>
<h3 id="拉取式消费（Pull-Consumer）"><a href="#拉取式消费（Pull-Consumer）" class="headerlink" title="拉取式消费（Pull Consumer）"></a>拉取式消费（Pull Consumer）</h3><p>Consumer消费的一种类型，应用通常主动调用Consumer的拉消息方法从Broker服务器拉消息、主动权由应用控制。一旦获取了批量消息，应用就会启动消费过程。</p>
<h3 id="推动式消费（Push-Consumer）"><a href="#推动式消费（Push-Consumer）" class="headerlink" title="推动式消费（Push Consumer）"></a>推动式消费（Push Consumer）</h3><p>Consumer消费的一种类型，该模式下Broker收到数据后会主动推送给消费端，该消费模式一般实时性较高。</p>
<h3 id="生产者组（Producer-Group）"><a href="#生产者组（Producer-Group）" class="headerlink" title="生产者组（Producer Group）"></a>生产者组（Producer Group）</h3><p>同一类Producer的集合，这类Producer发送同一类消息且发送逻辑一致。如果发送的是事务消息且原始生产者在发送之后崩溃，则Broker服务器会联系同一生产者组的其他生产者实例以提交或回溯消费。</p>
<h3 id="消费者组（Consumer-Group）"><a href="#消费者组（Consumer-Group）" class="headerlink" title="消费者组（Consumer Group）"></a>消费者组（Consumer Group）</h3><p>同一类Consumer的集合，这类Consumer通常消费同一类消息且消费逻辑一致。消费者组使得在消息消费方面，实现负载均衡和容错的目标变得非常容易。要注意的是，消费者组的消费者实例必须订阅完全相同的Topic。RocketMQ 支持两种消息模式：集群消费（Clustering）和广播消费（Broadcasting）。</p>
<h3 id="集群消费（Clustering）"><a href="#集群消费（Clustering）" class="headerlink" title="集群消费（Clustering）"></a>集群消费（Clustering）</h3><p>集群消费模式下,相同Consumer Group的每个Consumer实例平均分摊消息。</p>
<h3 id="广播消费（Broadcasting）"><a href="#广播消费（Broadcasting）" class="headerlink" title="广播消费（Broadcasting）"></a>广播消费（Broadcasting）</h3><p>广播消费模式下，相同Consumer Group的每个Consumer实例都接收全量的消息。</p>
<h3 id="普通顺序消息（Normal-Ordered-Message）"><a href="#普通顺序消息（Normal-Ordered-Message）" class="headerlink" title="普通顺序消息（Normal Ordered Message）"></a>普通顺序消息（Normal Ordered Message）</h3><p>普通顺序消费模式下，消费者通过同一个消息队列（ Topic 分区，称作 Message Queue） 收到的消息是有顺序的，不同消息队列收到的消息则可能是无顺序的。</p>
<h3 id="严格顺序消息（Strictly-Ordered-Message）"><a href="#严格顺序消息（Strictly-Ordered-Message）" class="headerlink" title="严格顺序消息（Strictly Ordered Message）"></a>严格顺序消息（Strictly Ordered Message）</h3><p>严格顺序消息模式下，消费者收到的所有消息均是有顺序的。</p>
<h3 id="消息（Message）"><a href="#消息（Message）" class="headerlink" title="消息（Message）"></a>消息（Message）</h3><p>消息系统所传输信息的物理载体，生产和消费数据的最小单位，每条消息必须属于一个主题。RocketMQ中每个消息拥有唯一的Message ID，且可以携带具有业务标识的Key。系统提供了通过Message ID和Key查询消息的功能。</p>
<h3 id="标签（Tag）"><a href="#标签（Tag）" class="headerlink" title="标签（Tag）"></a>标签（Tag）</h3><p>为消息设置的标志，用于同一主题下区分不同类型的消息。来自同一业务单元的消息，可以根据不同业务目的在同一主题下设置不同标签。标签能够有效地保持代码的清晰度和连贯性，并优化RocketMQ提供的查询系统。消费者可以根据Tag实现对不同子主题的不同消费逻辑，实现更好的扩展性。</p>
<h2 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h2><h3 id="订阅与发布"><a href="#订阅与发布" class="headerlink" title="订阅与发布"></a>订阅与发布</h3><p>消息的发布是指某个生产者向某个topic发送消息；消息的订阅是指某个消费者关注了某个topic中带有某些tag的消息，进而从该topic消费数据。</p>
<h3 id="消息顺序"><a href="#消息顺序" class="headerlink" title="消息顺序"></a>消息顺序</h3><p>消息有序指的是一类消息消费时，能按照发送的顺序来消费。例如：一个订单产生了三条消息分别是订单创建、订单付款、订单完成。消费时要按照这个顺序消费才能有意义，但是同时订单之间是可以并行消费的。RocketMQ可以严格的保证消息有序。</p>
<p>顺序消息分为全局顺序消息与分区顺序消息，全局顺序是指某个Topic下的所有消息都要保证顺序；部分顺序消息只要保证每一组消息被顺序消费即可。</p>
<ul>
<li>全局顺序<br>对于指定的一个 Topic，所有消息按照严格的先入先出（FIFO）的顺序进行发布和消费。<br>适用场景：性能要求不高，所有的消息严格按照 FIFO 原则进行消息发布和消费的场景</li>
<li>分区顺序<br>对于指定的一个 Topic，所有消息根据 sharding key 进行区块分区。 同一个分区内的消息按照严格的 FIFO 顺序进行发布和消费。 Sharding key 是顺序消息中用来区分不同分区的关键字段，和普通消息的 Key 是完全不同的概念。<br>适用场景：性能要求高，以 sharding key 作为分区字段，在同一个区块中严格的按照 FIFO 原则进行消息发布和消费的场景。<h3 id="消息过滤"><a href="#消息过滤" class="headerlink" title="消息过滤"></a>消息过滤</h3>RocketMQ的消费者可以根据Tag进行消息过滤，也支持自定义属性过滤。消息过滤目前是在Broker端实现的，优点是减少了对于Consumer无用消息的网络传输，缺点是增加了Broker的负担、而且实现相对复杂。<h3 id="消息可靠性"><a href="#消息可靠性" class="headerlink" title="消息可靠性"></a>消息可靠性</h3>RocketMQ支持消息的高可靠，影响消息可靠性的几种情况：<br>1) Broker非正常关闭<br>2) Broker异常Crash<br>3) OS Crash<br>4) 机器掉电，但是能立即恢复供电情况<br>5) 机器无法开机（可能是cpu、主板、内存等关键设备损坏）<br>6) 磁盘设备损坏</li>
</ul>
<p>1)、2)、3)、4) 四种情况都属于硬件资源可立即恢复情况，RocketMQ在这四种情况下能保证消息不丢，或者丢失少量数据（依赖刷盘方式是同步还是异步）。</p>
<p>5)、6)属于单点故障，且无法恢复，一旦发生，在此单点上的消息全部丢失。RocketMQ在这两种情况下，通过异步复制，可保证99%的消息不丢，但是仍然会有极少量的消息可能丢失。通过同步双写技术可以完全避免单点，同步双写势必会影响性能，适合对消息可靠性要求极高的场合，例如与Money相关的应用。注：RocketMQ从3.0版本开始支持同步双写。</p>
<h3 id="至少一次"><a href="#至少一次" class="headerlink" title="至少一次"></a>至少一次</h3><p>至少一次(At least Once)指每个消息必须投递一次。Consumer先Pull消息到本地，消费完成后，才向服务器返回ack，如果没有消费一定不会ack消息，所以RocketMQ可以很好的支持此特性。</p>
<h3 id="回溯消费"><a href="#回溯消费" class="headerlink" title="回溯消费"></a>回溯消费</h3><p>回溯消费是指Consumer已经消费成功的消息，由于业务上需求需要重新消费，要支持此功能，Broker在向Consumer投递成功消息后，消息仍然需要保留。并且重新消费一般是按照时间维度，例如由于Consumer系统故障，恢复后需要重新消费1小时前的数据，那么Broker要提供一种机制，可以按照时间维度来回退消费进度。RocketMQ支持按照时间回溯消费，时间维度精确到毫秒。</p>
<h3 id="事务消息"><a href="#事务消息" class="headerlink" title="事务消息"></a>事务消息</h3><p>RocketMQ事务消息（Transactional Message）是指应用本地事务和发送消息操作可以被定义到全局事务中，要么同时成功，要么同时失败。RocketMQ的事务消息提供类似 X/Open XA 的分布事务功能，通过事务消息能达到分布式事务的最终一致。</p>
<h3 id="定时消息"><a href="#定时消息" class="headerlink" title="定时消息"></a>定时消息</h3><p>定时消息（延迟队列）是指消息发送到broker后，不会立即被消费，等待特定时间投递给真正的topic。<br>broker有配置项messageDelayLevel，默认值为“1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2h”，18个level。可以配置自定义messageDelayLevel。注意，messageDelayLevel是broker的属性，不属于某个topic。发消息时，设置delayLevel等级即可：msg.setDelayLevel(level)。level有以下三种情况：</p>
<ul>
<li>level == 0，消息为非延迟消息</li>
<li>1&lt;=level&lt;=maxLevel，消息延迟特定时间，例如level==1，延迟1s</li>
<li>level &gt; maxLevel，则level== maxLevel，例如level==20，延迟2h</li>
</ul>
<p>定时消息会暂存在名为SCHEDULE_TOPIC_XXXX的topic中，并根据delayTimeLevel存入特定的queue，queueId = delayTimeLevel – 1，即一个queue只存相同延迟的消息，保证具有相同发送延迟的消息能够顺序消费。broker会调度地消费SCHEDULE_TOPIC_XXXX，将消息写入真实的topic。</p>
<p>需要注意的是，定时消息会在第一次写入和调度写入真实topic时都会计数，因此发送数量、tps都会变高。</p>
<h3 id="消息重试"><a href="#消息重试" class="headerlink" title="消息重试"></a>消息重试</h3><p>Consumer消费消息失败后，要提供一种重试机制，令消息再消费一次。Consumer消费消息失败通常可以认为有以下几种情况：</p>
<ul>
<li>由于消息本身的原因，例如反序列化失败，消息数据本身无法处理（例如话费充值，当前消息的手机号被注销，无法充值）等。这种错误通常需要跳过这条消息，再消费其它消息，而这条失败的消息即使立刻重试消费，99%也不成功，所以最好提供一种定时重试机制，即过10秒后再重试。</li>
<li>由于依赖的下游应用服务不可用，例如db连接不可用，外系统网络不可达等。遇到这种错误，即使跳过当前失败的消息，消费其他消息同样也会报错。这种情况建议应用sleep 30s，再消费下一条消息，这样可以减轻Broker重试消息的压力。</li>
</ul>
<p>RocketMQ会为每个消费组都设置一个Topic名称为“%RETRY%+consumerGroup”的重试队列（这里需要注意的是，这个Topic的重试队列是针对消费组，而不是针对每个Topic设置的），用于暂时保存因为各种异常而导致Consumer端无法消费的消息。考虑到异常恢复起来需要一些时间，会为重试队列设置多个重试级别，每个重试级别都有与之对应的重新投递延时，重试次数越多投递延时就越大。RocketMQ对于重试消息的处理是先保存至Topic名称为“SCHEDULE_TOPIC_XXXX”的延迟队列中，后台定时任务按照对应的时间进行Delay后重新保存至“%RETRY%+consumerGroup”的重试队列中。</p>
<h3 id="消息重投"><a href="#消息重投" class="headerlink" title="消息重投"></a>消息重投</h3><p>生产者在发送消息时，同步消息失败会重投，异步消息有重试，oneway没有任何保证。消息重投保证消息尽可能发送成功、不丢失，但可能会造成消息重复，消息重复在RocketMQ中是无法避免的问题。消息重复在一般情况下不会发生，当出现消息量大、网络抖动，消息重复就会是大概率事件。另外，生产者主动重发、consumer负载变化也会导致重复消息。如下方法可以设置消息重试策略：</p>
<ul>
<li>retryTimesWhenSendFailed:同步发送失败重投次数，默认为2，因此生产者会最多尝试发送retryTimesWhenSendFailed + 1次。不会选择上次失败的broker，尝试向其他broker发送，最大程度保证消息不丢。超过重投次数，抛出异常，由客户端保证消息不丢。当出现RemotingException、MQClientException和部分MQBrokerException时会重投。</li>
<li>retryTimesWhenSendAsyncFailed:异步发送失败重试次数，异步重试不会选择其他broker，仅在同一个broker上做重试，不保证消息不丢。</li>
<li>retryAnotherBrokerWhenNotStoreOK:消息刷盘（主或备）超时或slave不可用（返回状态非SEND_OK），是否尝试发送到其他broker，默认false。十分重要消息可以开启。</li>
</ul>
<h3 id="流量控制"><a href="#流量控制" class="headerlink" title="流量控制"></a>流量控制</h3><p>生产者流控，因为broker处理能力达到瓶颈；消费者流控，因为消费能力达到瓶颈。</p>
<p>生产者流控：</p>
<ul>
<li>commitLog文件被锁时间超过osPageCacheBusyTimeOutMills时，参数默认为1000ms，返回流控。</li>
<li>如果开启transientStorePoolEnable == true，且broker为异步刷盘的主机，且transientStorePool中资源不足，拒绝当前send请求，返回流控。</li>
<li>broker每隔10ms检查send请求队列头部请求的等待时间，如果超过waitTimeMillsInSendQueue，默认200ms，拒绝当前send请求，返回流控。</li>
<li>broker通过拒绝send 请求方式实现流量控制。</li>
</ul>
<p>注意，生产者流控，不会尝试消息重投。</p>
<p>消费者流控：</p>
<ul>
<li>消费者本地缓存消息数超过pullThresholdForQueue时，默认1000。</li>
<li>消费者本地缓存消息大小超过pullThresholdSizeForQueue时，默认100MB。</li>
<li>消费者本地缓存消息跨度超过consumeConcurrentlyMaxSpan时，默认2000。</li>
</ul>
<p>消费者流控的结果是降低拉取频率。</p>
<h3 id="死信队列"><a href="#死信队列" class="headerlink" title="死信队列"></a>死信队列</h3><p>死信队列用于处理无法被正常消费的消息。当一条消息初次消费失败，消息队列会自动进行消息重试；达到最大重试次数后，若消费依然失败，则表明消费者在正常情况下无法正确地消费该消息，此时，消息队列 不会立刻将消息丢弃，而是将其发送到该消费者对应的特殊队列中。</p>
<p>RocketMQ将这种正常情况下无法被消费的消息称为死信消息（Dead-Letter Message），将存储死信消息的特殊队列称为死信队列（Dead-Letter Queue）。在RocketMQ中，可以通过使用console控制台对死信队列中的消息进行重发来使得消费者实例再次进行消费。</p>
<h1 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h1><h2 id="Docker部署"><a href="#Docker部署" class="headerlink" title="Docker部署"></a>Docker部署</h2><h3 id="构建镜像"><a href="#构建镜像" class="headerlink" title="构建镜像"></a>构建镜像</h3><p>克隆代码<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="keyword">clone</span> <span class="title">https</span>://github.com/apache/rocketmq-docker.git</span><br></pre></td></tr></table></figure></p>
<p>构建镜像<code>rocketmq</code><br><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cd</span> image-build</span><br><span class="line">#<span class="keyword">sh</span> build-image.<span class="keyword">sh</span> RMQ-<span class="keyword">VERSION</span> BASE-IMAGE</span><br><span class="line"><span class="keyword">sh</span> build-image.<span class="keyword">sh</span> 4.9.2 centos</span><br></pre></td></tr></table></figure></p>
<p>查看镜像<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker images | grep rocket</span><br><span class="line">apacherocketmq/rocketmq                                <span class="number">4.9</span><span class="number">.2</span>               <span class="number">67902205</span>ef2c        About a minute ago   <span class="number">519</span>MB</span><br></pre></td></tr></table></figure></p>
<p>构建rocketmq-dashboard镜像<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">sh</span> <span class="selector-tag">build-image-dashboard</span><span class="selector-class">.sh</span> 1<span class="selector-class">.0</span><span class="selector-class">.0</span> <span class="selector-tag">centos</span></span><br></pre></td></tr></table></figure></p>
<p>最后如下所示：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">REPOSITORY                                             TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">apache/rocketmq-dashboard                              <span class="number">1.0</span><span class="number">.0</span>-centos        <span class="number">0</span>cc392fe7d27        <span class="number">5</span> minutes ago       <span class="number">821</span>MB</span><br><span class="line">apacherocketmq/rocketmq                                <span class="number">4.9</span><span class="number">.2</span>               <span class="number">67902205</span>ef2c        <span class="number">7</span> days ago          <span class="number">519</span>MB</span><br></pre></td></tr></table></figure></p>
<h3 id="单机部署（单Master模式）"><a href="#单机部署（单Master模式）" class="headerlink" title="单机部署（单Master模式）"></a>单机部署（单Master模式）</h3><p>这种方式风险较大，一旦Broker重启或者宕机时，会导致整个服务不可用。不建议线上环境使用,可以用于本地测试。</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置日志路径以及存储路径</span></span><br><span class="line">mkdir -p <span class="regexp">/Users/</span>dinghuang<span class="regexp">/Documents/</span>Tool<span class="regexp">/rocketMQ/</span>data<span class="regexp">/namesrv/</span>logs</span><br><span class="line">mkdir -p <span class="regexp">/Users/</span>dinghuang<span class="regexp">/Documents/</span>Tool<span class="regexp">/rocketMQ/</span>data<span class="regexp">/namesrv/</span>store</span><br><span class="line"><span class="comment"># 创建日志、数据存储、以及配置存放的挂载路径</span></span><br><span class="line">mkdir -p <span class="regexp">/Users/</span>dinghuang<span class="regexp">/Documents/</span>Tool<span class="regexp">/rocketMQ/</span>data<span class="regexp">/broker/</span>logs</span><br><span class="line">mkdir -p <span class="regexp">/Users/</span>dinghuang<span class="regexp">/Documents/</span>Tool<span class="regexp">/rocketMQ/</span>data<span class="regexp">/broker/</span>store</span><br><span class="line">mkdir -p <span class="regexp">/Users/</span>dinghuang<span class="regexp">/Documents/</span>Tool<span class="regexp">/rocketMQ/</span>etc<span class="regexp">/broker</span></span><br></pre></td></tr></table></figure>
<p>Broker配置文件创建<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi <span class="regexp">/Users/</span>dinghuang<span class="regexp">/Documents/</span>Tool<span class="regexp">/rocketMQ/</span>etc<span class="regexp">/broker/</span>broker.conf</span><br></pre></td></tr></table></figure></p>
<p>文件内容如下<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">brokerClusterName</span> = dh-docker</span><br><span class="line"><span class="attr">brokerName</span> = dh-docker-a</span><br><span class="line"><span class="attr">brokerId</span> = <span class="number">0</span></span><br><span class="line"><span class="attr">deleteWhen</span> = <span class="number">04</span></span><br><span class="line"><span class="attr">fileReservedTime</span> = <span class="number">48</span></span><br><span class="line"><span class="attr">brokerRole</span> = ASYNC_MASTER</span><br><span class="line"><span class="attr">flushDiskType</span> = ASYNC_FLUSH</span><br><span class="line"><span class="comment">#Docker环境需要设置成宿主机IP</span></span><br><span class="line"><span class="attr">brokerIP1</span> = <span class="number">10.38</span>.<span class="number">1.201</span></span><br></pre></td></tr></table></figure></p>
<p>编写Docker-compose文件<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">vi</span> <span class="selector-tag">docker-compose</span><span class="selector-class">.yml</span></span><br></pre></td></tr></table></figure></p>
<p>内容如下<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">version:</span> <span class="string">'3'</span></span><br><span class="line"><span class="symbol">services:</span></span><br><span class="line">  <span class="meta">#Service for nameserver</span></span><br><span class="line"><span class="symbol">  namesrv:</span></span><br><span class="line"><span class="symbol">    image:</span> apacherocketmq/rocketmq:<span class="number">4.9</span><span class="number">.2</span></span><br><span class="line"><span class="symbol">    container_name:</span> rocketmq-namesrv</span><br><span class="line"><span class="symbol">    ports:</span></span><br><span class="line">      - <span class="number">9876</span>:<span class="number">9876</span></span><br><span class="line"><span class="symbol">    environment:</span></span><br><span class="line">      - JAVA_OPT_EXT=-server -Xms256m -Xmx256m -Xmn256m</span><br><span class="line"><span class="symbol">    volumes:</span></span><br><span class="line">      - /Users<span class="meta-keyword">/dinghuang/</span>Documents/Tool/rocketMQ<span class="meta-keyword">/data/</span>namesrv/logs:<span class="meta-keyword">/root/</span>logs</span><br><span class="line"><span class="symbol">    command:</span> sh mqnamesrv</span><br><span class="line"></span><br><span class="line">  <span class="meta">#Service for broker</span></span><br><span class="line"><span class="symbol">  broker:</span></span><br><span class="line"><span class="symbol">    image:</span> apacherocketmq/rocketmq:<span class="number">4.9</span><span class="number">.2</span></span><br><span class="line"><span class="symbol">    container_name:</span> rocketmq-broker</span><br><span class="line"><span class="symbol">    links:</span></span><br><span class="line">      - namesrv</span><br><span class="line"><span class="symbol">    depends_on:</span></span><br><span class="line">      - namesrv</span><br><span class="line"><span class="symbol">    ports:</span></span><br><span class="line">      - <span class="number">10909</span>:<span class="number">10909</span></span><br><span class="line">      - <span class="number">10911</span>:<span class="number">10911</span></span><br><span class="line">      - <span class="number">10912</span>:<span class="number">10912</span></span><br><span class="line"><span class="symbol">    environment:</span></span><br><span class="line">      - NAMESRV_ADDR=namesrv:<span class="number">9876</span></span><br><span class="line">      - JAVA_OPT_EXT=-server -Xms512m -Xmx512m -Xmn256m</span><br><span class="line"><span class="symbol">    volumes:</span></span><br><span class="line">      - /Users<span class="meta-keyword">/dinghuang/</span>Documents/Tool/rocketMQ<span class="meta-keyword">/data/</span>broker/logs:<span class="meta-keyword">/home/</span>rocketmq/logs</span><br><span class="line">      - /Users<span class="meta-keyword">/dinghuang/</span>Documents/Tool/rocketMQ<span class="meta-keyword">/data/</span>broker/store:<span class="meta-keyword">/home/</span>rocketmq/store</span><br><span class="line">      - /Users<span class="meta-keyword">/dinghuang/</span>Documents/Tool/rocketMQ<span class="meta-keyword">/etc/</span>broker/broker.conf:<span class="meta-keyword">/home/</span>rocketmq<span class="meta-keyword">/conf/</span>broker.conf</span><br><span class="line"><span class="symbol">    command:</span> sh mqbroker -c <span class="meta-keyword">/home/</span>rocketmq<span class="meta-keyword">/conf/</span>broker.conf</span><br><span class="line"></span><br><span class="line">  <span class="meta">#Service for rocketmq-dashboard</span></span><br><span class="line"><span class="symbol">  dashboard:</span></span><br><span class="line"><span class="symbol">    image:</span> apache/rocketmq-dashboard:<span class="number">1.0</span><span class="number">.0</span>-centos</span><br><span class="line"><span class="symbol">    container_name:</span> rocketmq-dashboard</span><br><span class="line"><span class="symbol">    ports:</span></span><br><span class="line">      - <span class="number">8080</span>:<span class="number">8080</span></span><br><span class="line"><span class="symbol">    links:</span></span><br><span class="line">      - namesrv</span><br><span class="line"><span class="symbol">    depends_on:</span></span><br><span class="line">      - namesrv</span><br><span class="line"><span class="symbol">    environment:</span></span><br><span class="line">      - NAMESRV_ADDR=namesrv:<span class="number">9876</span></span><br></pre></td></tr></table></figure></p>
<p>运行命令<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose -f ./docker-compose<span class="selector-class">.yml</span> up</span><br></pre></td></tr></table></figure></p>
<p>运行日志如下：<br><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/common/WechatIMG729.png" alt="image"><br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CONTAINER ID        IMAGE                                                 COMMAND                  CREATED             STATUS                       PORTS                                                                      NAMES</span><br><span class="line">ed6f1b7e8864        apache/rocketmq-dashboard:<span class="number">1.0</span><span class="meta">.0</span>-centos                <span class="string">"java -jar bin/rocke…"</span>   <span class="number">4</span> minutes ago       <span class="meta">Up</span> <span class="number">2</span> seconds                 <span class="number">0.0</span><span class="meta">.0</span><span class="meta">.0</span>:<span class="number">8080</span>-&gt;<span class="number">8080</span>/tcp                                                     rocketmq-dashboard</span><br><span class="line">293cf31b9263        apacherocketmq/rocketmq:<span class="number">4.9</span><span class="meta">.2</span>                         <span class="string">"sh mqbroker -c /hom…"</span>   <span class="number">4</span> minutes ago       <span class="meta">Up</span> <span class="number">14</span> seconds                <span class="number">0.0</span><span class="meta">.0</span><span class="meta">.0</span>:<span class="number">10909</span>-&gt;<span class="number">10909</span>/tcp, <span class="number">9876</span>/tcp, <span class="number">0.0</span><span class="meta">.0</span><span class="meta">.0</span>:<span class="number">10911</span>-<span class="number">10912</span>-&gt;<span class="number">10911</span>-<span class="number">10912</span>/tcp   rocketmq-broker</span><br><span class="line">3db70550d6c2        apacherocketmq/rocketmq:<span class="number">4.9</span><span class="meta">.2</span>                         <span class="string">"sh mqnamesrv"</span>           <span class="number">4</span> minutes ago       <span class="meta">Up</span> <span class="number">37</span> seconds                <span class="number">10909</span>/tcp, <span class="number">0.0</span><span class="meta">.0</span><span class="meta">.0</span>:<span class="number">9876</span>-&gt;<span class="number">9876</span>/tcp, <span class="number">10911</span>-<span class="number">10912</span>/tcp                         rocketmq-namesrv</span><br></pre></td></tr></table></figure></p>
<p>登录地址：<a href="http://localhost:8080/#/" target="_blank" rel="noopener">http://localhost:8080/#/</a>  访问，如图所示：<br><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/common/WechatIMG730.png" alt="image"></p>
<h2 id="普通部署"><a href="#普通部署" class="headerlink" title="普通部署"></a>普通部署</h2><p>可以参考<a href="https://github.com/apache/rocketmq/blob/master/docs/cn/operation.md" target="_blank" rel="noopener">官方文档</a></p>
<h3 id="单Master模式"><a href="#单Master模式" class="headerlink" title="单Master模式"></a>单Master模式</h3><p>这种方式风险较大，一旦Broker重启或者宕机时，会导致整个服务不可用。不建议线上环境使用,可以用于本地测试。</p>
<h4 id="1）启动-NameServer"><a href="#1）启动-NameServer" class="headerlink" title="1）启动 NameServer"></a>1）启动 NameServer</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### 首先启动Name Server</span></span><br><span class="line">$ nohup sh mqnamesrv &amp;</span><br><span class="line"> </span><br><span class="line"><span class="comment">### 验证Name Server 是否启动成功</span></span><br><span class="line">$ tail -f ~/logs/rocketmqlogs/namesrv.log</span><br><span class="line">The Name Server boot success...</span><br></pre></td></tr></table></figure>
<h4 id="2）启动-Broker"><a href="#2）启动-Broker" class="headerlink" title="2）启动 Broker"></a>2）启动 Broker</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### 启动Broker</span></span><br><span class="line">$ nohup sh bin/mqbroker -n localhost:9876 &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment">### 验证Broker是否启动成功，例如Broker的IP为：192.168.1.2，且名称为broker-a</span></span><br><span class="line">$ tail -f ~/logs/rocketmqlogs/broker.log </span><br><span class="line">The broker[broker<span class="_">-a</span>, 192.169.1.2:10911] boot success...</span><br></pre></td></tr></table></figure>
<h3 id="多Master模式"><a href="#多Master模式" class="headerlink" title="多Master模式"></a>多Master模式</h3><p>一个集群无Slave，全是Master，例如2个Master或者3个Master，这种模式的优缺点如下：</p>
<ul>
<li>优点：配置简单，单个Master宕机或重启维护对应用无影响，在磁盘配置为RAID10时，即使机器宕机不可恢复情况下，由于RAID10磁盘非常可靠，消息也不会丢（异步刷盘丢失少量消息，同步刷盘一条不丢），性能最高；</li>
<li>缺点：单台机器宕机期间，这台机器上未被消费的消息在机器恢复之前不可订阅，消息实时性会受到影响。</li>
</ul>
<h4 id="1）启动NameServer"><a href="#1）启动NameServer" class="headerlink" title="1）启动NameServer"></a>1）启动NameServer</h4><p>NameServer需要先于Broker启动，且如果在生产环境使用，为了保证高可用，建议一般规模的集群启动3个NameServer，各节点的启动命令相同，如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### 首先启动Name Server</span></span><br><span class="line">$ nohup sh mqnamesrv &amp;</span><br><span class="line"> </span><br><span class="line"><span class="comment">### 验证Name Server 是否启动成功</span></span><br><span class="line">$ tail -f ~/logs/rocketmqlogs/namesrv.log</span><br><span class="line">The Name Server boot success...</span><br></pre></td></tr></table></figure>
<h4 id="2）启动Broker集群"><a href="#2）启动Broker集群" class="headerlink" title="2）启动Broker集群"></a>2）启动Broker集群</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### 在机器A，启动第一个Master，例如NameServer的IP为：192.168.1.1</span></span><br><span class="line">$ nohup sh mqbroker -n 192.168.1.1:9876 -c <span class="variable">$ROCKETMQ_HOME</span>/conf/2m-noslave/broker-a.properties &amp;</span><br><span class="line"> </span><br><span class="line"><span class="comment">### 在机器B，启动第二个Master，例如NameServer的IP为：192.168.1.1</span></span><br><span class="line">$ nohup sh mqbroker -n 192.168.1.1:9876 -c <span class="variable">$ROCKETMQ_HOME</span>/conf/2m-noslave/broker-b.properties &amp;</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>如上启动命令是在单个NameServer情况下使用的。对于多个NameServer的集群，Broker启动命令中<code>-n</code>后面的地址列表用分号隔开即可，例如 <code>192.168.1.1:9876;192.161.2:9876</code>。</p>
<h3 id="多Master多Slave模式-异步复制"><a href="#多Master多Slave模式-异步复制" class="headerlink" title="多Master多Slave模式-异步复制"></a>多Master多Slave模式-异步复制</h3><p>每个Master配置一个Slave，有多对Master-Slave，HA采用异步复制方式，主备有短暂消息延迟（毫秒级），这种模式的优缺点如下：</p>
<ul>
<li><p>优点：即使磁盘损坏，消息丢失的非常少，且消息实时性不会受影响，同时Master宕机后，消费者仍然可以从Slave消费，而且此过程对应用透明，不需要人工干预，性能同多Master模式几乎一样；</p>
</li>
<li><p>缺点：Master宕机，磁盘损坏情况下会丢失少量消息。</p>
</li>
</ul>
<h4 id="1）启动NameServer-1"><a href="#1）启动NameServer-1" class="headerlink" title="1）启动NameServer"></a>1）启动NameServer</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### 首先启动Name Server</span></span><br><span class="line">$ nohup sh mqnamesrv &amp;</span><br><span class="line"> </span><br><span class="line"><span class="comment">### 验证Name Server 是否启动成功</span></span><br><span class="line">$ tail -f ~/logs/rocketmqlogs/namesrv.log</span><br><span class="line">The Name Server boot success...</span><br></pre></td></tr></table></figure>
<h4 id="2）启动Broker集群-1"><a href="#2）启动Broker集群-1" class="headerlink" title="2）启动Broker集群"></a>2）启动Broker集群</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### 在机器A，启动第一个Master，例如NameServer的IP为：192.168.1.1</span></span><br><span class="line">$ nohup sh mqbroker -n 192.168.1.1:9876 -c <span class="variable">$ROCKETMQ_HOME</span>/conf/2m-2s-async/broker-a.properties &amp;</span><br><span class="line"> </span><br><span class="line"><span class="comment">### 在机器B，启动第二个Master，例如NameServer的IP为：192.168.1.1</span></span><br><span class="line">$ nohup sh mqbroker -n 192.168.1.1:9876 -c <span class="variable">$ROCKETMQ_HOME</span>/conf/2m-2s-async/broker-b.properties &amp;</span><br><span class="line"> </span><br><span class="line"><span class="comment">### 在机器C，启动第一个Slave，例如NameServer的IP为：192.168.1.1</span></span><br><span class="line">$ nohup sh mqbroker -n 192.168.1.1:9876 -c <span class="variable">$ROCKETMQ_HOME</span>/conf/2m-2s-async/broker<span class="_">-a</span>-s.properties &amp;</span><br><span class="line"> </span><br><span class="line"><span class="comment">### 在机器D，启动第二个Slave，例如NameServer的IP为：192.168.1.1</span></span><br><span class="line">$ nohup sh mqbroker -n 192.168.1.1:9876 -c <span class="variable">$ROCKETMQ_HOME</span>/conf/2m-2s-async/broker-b-s.properties &amp;</span><br></pre></td></tr></table></figure>
<h4 id="多Master多Slave模式-同步双写"><a href="#多Master多Slave模式-同步双写" class="headerlink" title="多Master多Slave模式-同步双写"></a>多Master多Slave模式-同步双写</h4><p>每个Master配置一个Slave，有多对Master-Slave，HA采用同步双写方式，即只有主备都写成功，才向应用返回成功，这种模式的优缺点如下：</p>
<ul>
<li><p>优点：数据与服务都无单点故障，Master宕机情况下，消息无延迟，服务可用性与数据可用性都非常高；</p>
</li>
<li><p>缺点：性能比异步复制模式略低（大约低10%左右），发送单个消息的RT会略高，且目前版本在主节点宕机后，备机不能自动切换为主机。</p>
</li>
</ul>
<h4 id="1）启动NameServer-2"><a href="#1）启动NameServer-2" class="headerlink" title="1）启动NameServer"></a>1）启动NameServer</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### 首先启动Name Server</span></span><br><span class="line">$ nohup sh mqnamesrv &amp;</span><br><span class="line"> </span><br><span class="line"><span class="comment">### 验证Name Server 是否启动成功</span></span><br><span class="line">$ tail -f ~/logs/rocketmqlogs/namesrv.log</span><br><span class="line">The Name Server boot success...</span><br></pre></td></tr></table></figure>
<h4 id="2）启动Broker集群-2"><a href="#2）启动Broker集群-2" class="headerlink" title="2）启动Broker集群"></a>2）启动Broker集群</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### 在机器A，启动第一个Master，例如NameServer的IP为：192.168.1.1</span></span><br><span class="line">$ nohup sh mqbroker -n 192.168.1.1:9876 -c <span class="variable">$ROCKETMQ_HOME</span>/conf/2m-2s-sync/broker-a.properties &amp;</span><br><span class="line"> </span><br><span class="line"><span class="comment">### 在机器B，启动第二个Master，例如NameServer的IP为：192.168.1.1</span></span><br><span class="line">$ nohup sh mqbroker -n 192.168.1.1:9876 -c <span class="variable">$ROCKETMQ_HOME</span>/conf/2m-2s-sync/broker-b.properties &amp;</span><br><span class="line"> </span><br><span class="line"><span class="comment">### 在机器C，启动第一个Slave，例如NameServer的IP为：192.168.1.1</span></span><br><span class="line">$ nohup sh mqbroker -n 192.168.1.1:9876 -c <span class="variable">$ROCKETMQ_HOME</span>/conf/2m-2s-sync/broker<span class="_">-a</span>-s.properties &amp;</span><br><span class="line"> </span><br><span class="line"><span class="comment">### 在机器D，启动第二个Slave，例如NameServer的IP为：192.168.1.1</span></span><br><span class="line">$ nohup sh mqbroker -n 192.168.1.1:9876 -c <span class="variable">$ROCKETMQ_HOME</span>/conf/2m-2s-sync/broker-b-s.properties &amp;</span><br></pre></td></tr></table></figure>
<p>以上Broker与Slave配对是通过指定相同的BrokerName参数来配对，Master的BrokerId必须是0，Slave的BrokerId必须是大于0的数。另外一个Master下面可以挂载多个Slave，同一Master下的多个Slave通过指定不同的BrokerId来区分。$ROCKETMQ_HOME指的RocketMQ安装目录，需要用户自己设置此环境变量。</p>
<h1 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h1><p>加入依赖<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.rocketmq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rocketmq-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.9.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h2 id="Producer"><a href="#Producer" class="headerlink" title="Producer"></a>Producer</h2><h3 id="发送同步消息"><a href="#发送同步消息" class="headerlink" title="发送同步消息"></a>发送同步消息</h3><p>这种可靠性同步地发送方式使用的比较广泛，比如：重要的消息通知，短信通知。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SyncProducer</span> &#123;</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> throws Exception </span>&#123;</span><br><span class="line">    	<span class="comment">// 实例化消息生产者Producer</span></span><br><span class="line">        DefaultMQProducer producer = <span class="keyword">new</span> DefaultMQProducer(<span class="string">"please_rename_unique_group_name"</span>);</span><br><span class="line">    	<span class="comment">// 设置NameServer的地址</span></span><br><span class="line">    	producer.setNamesrvAddr(<span class="string">"localhost:9876"</span>);</span><br><span class="line">    	<span class="comment">// 启动Producer实例</span></span><br><span class="line">        producer.start();</span><br><span class="line">    	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">    	    <span class="comment">// 创建消息，并指定Topic，Tag和消息体</span></span><br><span class="line">    	    Message msg = <span class="keyword">new</span> Message(<span class="string">"TopicTest"</span> <span class="comment">/* Topic */</span>,</span><br><span class="line">        	<span class="string">"TagA"</span> <span class="comment">/* Tag */</span>,</span><br><span class="line">        	(<span class="string">"Hello RocketMQ "</span> + i).getBytes(RemotingHelper.DEFAULT_CHARSET) <span class="comment">/* Message body */</span></span><br><span class="line">        	);</span><br><span class="line">        	<span class="comment">// 发送消息到一个Broker</span></span><br><span class="line">            SendResult sendResult = producer.send(msg);</span><br><span class="line">            <span class="comment">// 通过sendResult返回消息是否成功送达</span></span><br><span class="line">            System.out.<span class="built_in">printf</span>(<span class="string">"%s%n"</span>, sendResult);</span><br><span class="line">    	&#125;</span><br><span class="line">    	<span class="comment">// 如果不再发送消息，关闭Producer实例。</span></span><br><span class="line">    	producer.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>查看消息如图所示：<br><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/common/WechatIMG731.png" alt="image"></p>
<h3 id="发送异步消息"><a href="#发送异步消息" class="headerlink" title="发送异步消息"></a>发送异步消息</h3><p>异步消息通常用在对响应时间敏感的业务场景，即发送端不能容忍长时间地等待Broker的响应。<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    	<span class="comment">// 实例化消息生产者Producer</span></span><br><span class="line">        DefaultMQProducer producer = <span class="keyword">new</span> DefaultMQProducer(<span class="string">"please_rename_unique_group_name"</span>);</span><br><span class="line">    	<span class="comment">// 设置NameServer的地址</span></span><br><span class="line">        producer.setNamesrvAddr(<span class="string">"localhost:9876"</span>);</span><br><span class="line">    	<span class="comment">// 启动Producer实例</span></span><br><span class="line">        producer.start();</span><br><span class="line">        producer.setRetryTimesWhenSendAsyncFailed(<span class="number">0</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">int</span> messageCount = <span class="number">100</span>;</span><br><span class="line">        <span class="comment">// 根据消息数量实例化倒计时计算器</span></span><br><span class="line">	<span class="keyword">final</span> CountDownLatch2 countDownLatch = <span class="keyword">new</span> CountDownLatch2(messageCount);</span><br><span class="line">    	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; messageCount; i++) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> index = i;</span><br><span class="line">            	<span class="comment">// 创建消息，并指定Topic，Tag和消息体</span></span><br><span class="line">                Message msg = <span class="keyword">new</span> Message(<span class="string">"TopicTest"</span>,</span><br><span class="line">                    <span class="string">"TagA"</span>,</span><br><span class="line">                    <span class="string">"OrderID188"</span>,</span><br><span class="line">                    <span class="string">"Hello world"</span>.getBytes(RemotingHelper.DEFAULT_CHARSET));</span><br><span class="line">                <span class="comment">// SendCallback接收异步返回结果的回调</span></span><br><span class="line">                producer.send(msg, <span class="keyword">new</span> SendCallback() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(SendResult sendResult)</span> </span>&#123;</span><br><span class="line">                        countDownLatch.countDown();</span><br><span class="line">                        System.out.printf(<span class="string">"%-10d OK %s %n"</span>, index,</span><br><span class="line">                            sendResult.getMsgId());</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onException</span><span class="params">(Throwable e)</span> </span>&#123;</span><br><span class="line">                        countDownLatch.countDown();</span><br><span class="line">      	                System.out.printf(<span class="string">"%-10d Exception %s %n"</span>, index, e);</span><br><span class="line">      	                e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">            	&#125;);</span><br><span class="line">    	&#125;</span><br><span class="line">	<span class="comment">// 等待5s</span></span><br><span class="line">	countDownLatch.await(<span class="number">5</span>, TimeUnit.SECONDS);</span><br><span class="line">    	<span class="comment">// 如果不再发送消息，关闭Producer实例。</span></span><br><span class="line">    	producer.shutdown();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="单向发送消息"><a href="#单向发送消息" class="headerlink" title="单向发送消息"></a>单向发送消息</h3><p>这种方式主要用在不特别关心发送结果的场景，例如日志发送。<br><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OnewayProducer</span> </span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> void main(<span class="keyword">String</span>[] args) throws Exception&#123;</span><br><span class="line">    	<span class="comment">// 实例化消息生产者Producer</span></span><br><span class="line">        DefaultMQProducer producer = <span class="keyword">new</span> <span class="type">DefaultMQProducer</span>(<span class="string">"please_rename_unique_group_name"</span>);</span><br><span class="line">    	<span class="comment">// 设置NameServer的地址</span></span><br><span class="line">        producer.setNamesrvAddr(<span class="string">"localhost:9876"</span>);</span><br><span class="line">    	<span class="comment">// 启动Producer实例</span></span><br><span class="line">        producer.start();</span><br><span class="line">    	<span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">        	<span class="comment">// 创建消息，并指定Topic，Tag和消息体</span></span><br><span class="line">        	Message msg = <span class="keyword">new</span> <span class="type">Message</span>(<span class="string">"TopicTest"</span> <span class="comment">/* Topic */</span>,</span><br><span class="line">                <span class="string">"TagA"</span> <span class="comment">/* Tag */</span>,</span><br><span class="line">                (<span class="string">"Hello RocketMQ "</span> + i).getBytes(RemotingHelper.DEFAULT_CHARSET) <span class="comment">/* Message body */</span></span><br><span class="line">        	);</span><br><span class="line">        	<span class="comment">// 发送单向消息，没有任何返回结果</span></span><br><span class="line">        	producer.sendOnew<span class="type">ay</span>(msg);</span><br><span class="line"></span><br><span class="line">    	&#125;</span><br><span class="line">    	<span class="comment">// 如果不再发送消息，关闭Producer实例。</span></span><br><span class="line">    	producer.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="Consumer"><a href="#Consumer" class="headerlink" title="Consumer"></a>Consumer</h2><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Consumer</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span>(<span class="params">String[] args</span>) throws InterruptedException, MQClientException </span>&#123;</span><br><span class="line"></span><br><span class="line">    	<span class="comment">// 实例化消费者</span></span><br><span class="line">        DefaultMQPushConsumer consumer = <span class="keyword">new</span> DefaultMQPushConsumer(<span class="string">"please_rename_unique_group_name"</span>);</span><br><span class="line"></span><br><span class="line">    	<span class="comment">// 设置NameServer的地址</span></span><br><span class="line">        consumer.setNamesrvAddr(<span class="string">"localhost:9876"</span>);</span><br><span class="line"></span><br><span class="line">    	<span class="comment">// 订阅一个或者多个Topic，以及Tag来过滤需要消费的消息</span></span><br><span class="line">        consumer.subscribe(<span class="string">"TopicTest"</span>, <span class="string">"*"</span>);</span><br><span class="line">    	<span class="comment">// 注册回调实现类来处理从broker拉取回来的消息</span></span><br><span class="line">        consumer.registerMessageListener(<span class="keyword">new</span> MessageListenerConcurrently() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            <span class="function"><span class="keyword">public</span> ConsumeConcurrentlyStatus <span class="title">consumeMessage</span>(<span class="params">List&lt;MessageExt&gt; msgs, ConsumeConcurrentlyContext context</span>) </span>&#123;</span><br><span class="line">                System.<span class="keyword">out</span>.printf(<span class="string">"%s Receive New Messages: %s %n"</span>, Thread.currentThread().getName(), msgs);</span><br><span class="line">                <span class="comment">// 标记该消息已经被成功消费</span></span><br><span class="line">                <span class="keyword">return</span> ConsumeConcurrentlyStatus.CONSUME_SUCCESS;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 启动消费者实例</span></span><br><span class="line">        consumer.start();</span><br><span class="line">        System.<span class="keyword">out</span>.printf(<span class="string">"Consumer Started.%n"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="顺序消息"><a href="#顺序消息" class="headerlink" title="顺序消息"></a>顺序消息</h2><p>RocketMQ可以严格的保证消息有序，可以分为分区有序或者全局有序。</p>
<blockquote>
<p>顺序消费的原理解析，在默认的情况下消息发送会采取Round Robin轮询方式把消息发送到不同的queue(分区队列)；而消费消息的时候从多个queue上拉取消息，这种情况发送和消费是不能保证顺序。但是如果控制发送的顺序消息只依次发送到同一个queue中，消费的时候只从这个queue上依次拉取，则就保证了顺序。当发送和消费参与的queue只有一个，则是全局有序；如果多个queue参与，则为分区有序，即相对每个queue，消息都是有序的。</p>
</blockquote>
<p>下面用订单进行分区有序的示例。一个订单的顺序流程是：创建、付款、推送、完成。订单号相同的消息会被先后发送到同一个队列中，消费时，同一个OrderId获取到的肯定是同一个队列。</p>
<h3 id="顺序消息生产"><a href="#顺序消息生产" class="headerlink" title="顺序消息生产"></a>顺序消息生产</h3><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.rocketmq.example.order2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.client.producer.DefaultMQProducer;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.client.producer.MessageQueueSelector;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.client.producer.SendResult;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.common.message.Message;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.common.message.MessageQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.<span class="built_in">text</span>.SimpleDateFormat;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Producer，发送顺序消息</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> class Producer &#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="keyword">String</span>[] args) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">       DefaultMQProducer producer = <span class="keyword">new</span> DefaultMQProducer(<span class="string">"please_rename_unique_group_name"</span>);</span><br><span class="line"></span><br><span class="line">       producer.setNamesrvAddr(<span class="string">"127.0.0.1:9876"</span>);</span><br><span class="line"></span><br><span class="line">       producer.start();</span><br><span class="line"></span><br><span class="line">       <span class="keyword">String</span>[] tags = <span class="keyword">new</span> <span class="keyword">String</span>[]&#123;<span class="string">"TagA"</span>, <span class="string">"TagC"</span>, <span class="string">"TagD"</span>&#125;;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 订单列表</span></span><br><span class="line">       List&lt;OrderStep&gt; orderList = <span class="keyword">new</span> Producer().buildOrders();</span><br><span class="line"></span><br><span class="line">       Date date = <span class="keyword">new</span> Date();</span><br><span class="line">       SimpleDateFormat sdf = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>);</span><br><span class="line">       <span class="keyword">String</span> dateStr = sdf.format(date);</span><br><span class="line">       <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">           <span class="comment">// 加个时间前缀</span></span><br><span class="line">           <span class="keyword">String</span> body = dateStr + <span class="string">" Hello RocketMQ "</span> + orderList.<span class="built_in">get</span>(i);</span><br><span class="line">           Message msg = <span class="keyword">new</span> Message(<span class="string">"TopicTest"</span>, tags[i % tags.length], <span class="string">"KEY"</span> + i, body.getBytes());</span><br><span class="line"></span><br><span class="line">           SendResult sendResult = producer.send(msg, <span class="keyword">new</span> MessageQueueSelector() &#123;</span><br><span class="line">               @Override</span><br><span class="line">               <span class="keyword">public</span> MessageQueue select(List&lt;MessageQueue&gt; mqs, Message msg, <span class="keyword">Object</span> arg) &#123;</span><br><span class="line">                   Long id = (Long) arg;  <span class="comment">//根据订单id选择发送queue</span></span><br><span class="line">                   <span class="keyword">long</span> index = id % mqs.<span class="built_in">size</span>();</span><br><span class="line">                   <span class="keyword">return</span> mqs.<span class="built_in">get</span>((<span class="built_in">int</span>) index);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;, orderList.<span class="built_in">get</span>(i).getOrderId());<span class="comment">//订单id</span></span><br><span class="line"></span><br><span class="line">           System.out.<span class="built_in">println</span>(<span class="keyword">String</span>.format(<span class="string">"SendResult status:%s, queueId:%d, body:%s"</span>,</span><br><span class="line">               sendResult.getSendStatus(),</span><br><span class="line">               sendResult.getMessageQueue().getQueueId(),</span><br><span class="line">               body));</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       producer.shutdown();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 订单的步骤</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> class OrderStep &#123;</span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">long</span> orderId;</span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">String</span> desc;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">public</span> <span class="keyword">long</span> getOrderId() &#123;</span><br><span class="line">           <span class="keyword">return</span> orderId;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">public</span> <span class="keyword">void</span> setOrderId(<span class="keyword">long</span> orderId) &#123;</span><br><span class="line">           <span class="keyword">this</span>.orderId = orderId;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">public</span> <span class="keyword">String</span> getDesc() &#123;</span><br><span class="line">           <span class="keyword">return</span> desc;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">public</span> <span class="keyword">void</span> setDesc(<span class="keyword">String</span> desc) &#123;</span><br><span class="line">           <span class="keyword">this</span>.desc = desc;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       @Override</span><br><span class="line">       <span class="keyword">public</span> <span class="keyword">String</span> toString() &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="string">"OrderStep&#123;"</span> +</span><br><span class="line">               <span class="string">"orderId="</span> + orderId +</span><br><span class="line">               <span class="string">", desc='"</span> + desc + <span class="string">'\''</span> +</span><br><span class="line">               <span class="string">'&#125;'</span>;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 生成模拟订单数据</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">private</span> List&lt;OrderStep&gt; buildOrders() &#123;</span><br><span class="line">       List&lt;OrderStep&gt; orderList = <span class="keyword">new</span> ArrayList&lt;OrderStep&gt;();</span><br><span class="line"></span><br><span class="line">       OrderStep orderDemo = <span class="keyword">new</span> OrderStep();</span><br><span class="line">       orderDemo.setOrderId(<span class="number">15103111039</span>L);</span><br><span class="line">       orderDemo.setDesc(<span class="string">"创建"</span>);</span><br><span class="line">       orderList.<span class="built_in">add</span>(orderDemo);</span><br><span class="line"></span><br><span class="line">       orderDemo = <span class="keyword">new</span> OrderStep();</span><br><span class="line">       orderDemo.setOrderId(<span class="number">15103111065</span>L);</span><br><span class="line">       orderDemo.setDesc(<span class="string">"创建"</span>);</span><br><span class="line">       orderList.<span class="built_in">add</span>(orderDemo);</span><br><span class="line"></span><br><span class="line">       orderDemo = <span class="keyword">new</span> OrderStep();</span><br><span class="line">       orderDemo.setOrderId(<span class="number">15103111039</span>L);</span><br><span class="line">       orderDemo.setDesc(<span class="string">"付款"</span>);</span><br><span class="line">       orderList.<span class="built_in">add</span>(orderDemo);</span><br><span class="line"></span><br><span class="line">       orderDemo = <span class="keyword">new</span> OrderStep();</span><br><span class="line">       orderDemo.setOrderId(<span class="number">15103117235</span>L);</span><br><span class="line">       orderDemo.setDesc(<span class="string">"创建"</span>);</span><br><span class="line">       orderList.<span class="built_in">add</span>(orderDemo);</span><br><span class="line"></span><br><span class="line">       orderDemo = <span class="keyword">new</span> OrderStep();</span><br><span class="line">       orderDemo.setOrderId(<span class="number">15103111065</span>L);</span><br><span class="line">       orderDemo.setDesc(<span class="string">"付款"</span>);</span><br><span class="line">       orderList.<span class="built_in">add</span>(orderDemo);</span><br><span class="line"></span><br><span class="line">       orderDemo = <span class="keyword">new</span> OrderStep();</span><br><span class="line">       orderDemo.setOrderId(<span class="number">15103117235</span>L);</span><br><span class="line">       orderDemo.setDesc(<span class="string">"付款"</span>);</span><br><span class="line">       orderList.<span class="built_in">add</span>(orderDemo);</span><br><span class="line"></span><br><span class="line">       orderDemo = <span class="keyword">new</span> OrderStep();</span><br><span class="line">       orderDemo.setOrderId(<span class="number">15103111065</span>L);</span><br><span class="line">       orderDemo.setDesc(<span class="string">"完成"</span>);</span><br><span class="line">       orderList.<span class="built_in">add</span>(orderDemo);</span><br><span class="line"></span><br><span class="line">       orderDemo = <span class="keyword">new</span> OrderStep();</span><br><span class="line">       orderDemo.setOrderId(<span class="number">15103111039</span>L);</span><br><span class="line">       orderDemo.setDesc(<span class="string">"推送"</span>);</span><br><span class="line">       orderList.<span class="built_in">add</span>(orderDemo);</span><br><span class="line"></span><br><span class="line">       orderDemo = <span class="keyword">new</span> OrderStep();</span><br><span class="line">       orderDemo.setOrderId(<span class="number">15103117235</span>L);</span><br><span class="line">       orderDemo.setDesc(<span class="string">"完成"</span>);</span><br><span class="line">       orderList.<span class="built_in">add</span>(orderDemo);</span><br><span class="line"></span><br><span class="line">       orderDemo = <span class="keyword">new</span> OrderStep();</span><br><span class="line">       orderDemo.setOrderId(<span class="number">15103111039</span>L);</span><br><span class="line">       orderDemo.setDesc(<span class="string">"完成"</span>);</span><br><span class="line">       orderList.<span class="built_in">add</span>(orderDemo);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> orderList;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="顺序消费消息"><a href="#顺序消费消息" class="headerlink" title="顺序消费消息"></a>顺序消费消息</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">package org.apache.rocketmq.example.order2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.client.consumer.DefaultMQPushConsumer;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.client.consumer.listener.ConsumeOrderlyContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.client.consumer.listener.ConsumeOrderlyStatus;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.client.consumer.listener.MessageListenerOrderly;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.common.consumer.ConsumeFromWhere;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.common.message.MessageExt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 顺序消息消费，带事务方式（应用可控制Offset什么时候提交）</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumerInOrder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> void main(<span class="type">String</span>[] args) <span class="keyword">throws</span> <span class="type">Exception</span> &#123;</span><br><span class="line">       <span class="type">DefaultMQPushConsumer</span> consumer = new <span class="type">DefaultMQPushConsumer</span>(<span class="string">"please_rename_unique_group_name_3"</span>);</span><br><span class="line">       consumer.setNamesrvAddr(<span class="string">"127.0.0.1:9876"</span>);</span><br><span class="line">       <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * 设置Consumer第一次启动是从队列头部开始消费还是队列尾部开始消费&lt;br&gt;</span></span><br><span class="line"><span class="comment">        * 如果非第一次启动，那么按照上次消费的位置继续消费</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">       consumer.setConsumeFromWhere(<span class="type">ConsumeFromWhere</span>.<span class="type">CONSUME_FROM_FIRST_OFFSET</span>);</span><br><span class="line"></span><br><span class="line">       consumer.subscribe(<span class="string">"TopicTest"</span>, <span class="string">"TagA || TagC || TagD"</span>);</span><br><span class="line"></span><br><span class="line">       consumer.registerMessageListener(new <span class="type">MessageListenerOrderly</span>() &#123;</span><br><span class="line"></span><br><span class="line">           <span class="type">Random</span> random = new <span class="type">Random</span>();</span><br><span class="line"></span><br><span class="line">           @<span class="type">Override</span></span><br><span class="line">           <span class="keyword">public</span> <span class="type">ConsumeOrderlyStatus</span> consumeMessage(<span class="type">List</span>&lt;<span class="type">MessageExt</span>&gt; msgs, <span class="type">ConsumeOrderlyContext</span> context) &#123;</span><br><span class="line">               context.setAutoCommit(<span class="literal">true</span>);</span><br><span class="line">               <span class="keyword">for</span> (<span class="type">MessageExt</span> msg : msgs) &#123;</span><br><span class="line">                   <span class="comment">// 可以看到每个queue有唯一的consume线程来消费, 订单对每个queue(分区)有序</span></span><br><span class="line">                   <span class="type">System</span>.out.<span class="built_in">println</span>(<span class="string">"consumeThread="</span> + <span class="type">Thread</span>.currentThread().getName() + <span class="string">"queueId="</span> + msg.getQueueId() + <span class="string">", content:"</span> + new <span class="type">String</span>(msg.getBody()));</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                   <span class="comment">//模拟业务逻辑处理中...</span></span><br><span class="line">                   <span class="type">TimeUnit</span>.<span class="type">SECONDS</span>.sleep(random.nextInt(<span class="number">10</span>));</span><br><span class="line">               &#125; <span class="keyword">catch</span> (<span class="type">Exception</span> e) &#123;</span><br><span class="line">                   e.printStackTrace();</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">return</span> <span class="type">ConsumeOrderlyStatus</span>.<span class="type">SUCCESS</span>;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br><span class="line"></span><br><span class="line">       consumer.start();</span><br><span class="line"></span><br><span class="line">       <span class="type">System</span>.out.<span class="built_in">println</span>(<span class="string">"Consumer Started."</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="延时消息"><a href="#延时消息" class="headerlink" title="延时消息"></a>延时消息</h3><p>比如电商里，提交了一个订单就可以发送一个延时消息，1h后去检查这个订单的状态，如果还是未付款就取消订单释放库存。</p>
<blockquote>
<p>现在RocketMq并不支持任意时间的延时，需要设置几个固定的延时等级(1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2h)，从1s到2h分别对应着等级1到18 消息消费失败会进入延时消息队列，消息发送时间与设置的延时等级和重试次数有关，详见代码SendMessageProcessor.java</p>
</blockquote>
<p>启动消费者等待传入订阅消息</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"><span class="meta-keyword">import</span> org.apache.rocketmq.client.consumer.DefaultMQPushConsumer;</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">import</span> org.apache.rocketmq.client.consumer.listener.ConsumeConcurrentlyContext;</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">import</span> org.apache.rocketmq.client.consumer.listener.ConsumeConcurrentlyStatus;</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">import</span> org.apache.rocketmq.client.consumer.listener.MessageListenerConcurrently;</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">import</span> org.apache.rocketmq.common.message.MessageExt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="meta-keyword">import</span> java.util.List;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @author dinghuang123@gmail.com</span></span><br><span class="line"><span class="comment"> * @since 2022/3/4</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ScheduledMessageConsumer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> main(String[] args) throws Exception &#123;</span><br><span class="line">        <span class="comment">// 实例化消费者</span></span><br><span class="line">        DefaultMQPushConsumer consumer = <span class="keyword">new</span> DefaultMQPushConsumer(<span class="string">"ExampleConsumer"</span>);</span><br><span class="line">        <span class="comment">// 订阅Topics</span></span><br><span class="line">        consumer.subscribe(<span class="string">"TestTopic"</span>, <span class="string">"*"</span>);</span><br><span class="line">        consumer.setNamesrvAddr(<span class="string">"127.0.0.1:9876"</span>);</span><br><span class="line">        <span class="comment">// 注册消息监听者</span></span><br><span class="line">        consumer.registerMessageListener(<span class="keyword">new</span> MessageListenerConcurrently() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            <span class="keyword">public</span> ConsumeConcurrentlyStatus consumeMessage(List&lt;MessageExt&gt; messages, ConsumeConcurrentlyContext context) &#123;</span><br><span class="line">                <span class="keyword">for</span> (MessageExt message : messages) &#123;</span><br><span class="line">                    <span class="comment">// Print approximate delay time period</span></span><br><span class="line">                    System.out.println(<span class="string">"Receive message[msgId="</span> + message.getMsgId() + <span class="string">"] "</span> + <span class="keyword">new</span> String(message.getBody()) + (System.currentTimeMillis() - message.getBornTimestamp()) + <span class="string">"ms later"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> ConsumeConcurrentlyStatus.CONSUME_SUCCESS;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 启动消费者</span></span><br><span class="line">        consumer.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>发送延时消息<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.client.producer.DefaultMQProducer;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.common.message.Message;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> dinghuang123@gmail.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2022/3/4</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ScheduledMessageProducer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 实例化一个生产者来产生延时消息</span></span><br><span class="line">        DefaultMQProducer producer = <span class="keyword">new</span> DefaultMQProducer(<span class="string">"ExampleProducerGroup"</span>);</span><br><span class="line">        <span class="comment">// 启动生产者</span></span><br><span class="line">        producer.setNamesrvAddr(<span class="string">"127.0.0.1:9876"</span>);</span><br><span class="line">        producer.start();</span><br><span class="line">        <span class="keyword">int</span> totalMessagesToSend = <span class="number">100</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; totalMessagesToSend; i++) &#123;</span><br><span class="line">            Message message = <span class="keyword">new</span> Message(<span class="string">"TestTopic"</span>, (<span class="string">"Hello scheduled message "</span> + i).getBytes());</span><br><span class="line">            <span class="comment">// 设置延时等级3,这个消息将在10s之后发送(现在只支持固定的几个时间,详看delayTimeLevel)</span></span><br><span class="line">            message.setDelayTimeLevel(<span class="number">3</span>);</span><br><span class="line">            <span class="comment">// 发送消息</span></span><br><span class="line">            producer.send(message);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 关闭生产者</span></span><br><span class="line">        producer.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>将会看到消息的消费比存储时间晚10秒。<br><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Receive <span class="keyword">message</span>[msgId=<span class="number">7</span>F0000016C4918B4AAC2130BFEB90055] Hello scheduled <span class="keyword">message</span> <span class="number">859992</span>ms later</span><br><span class="line">Receive <span class="keyword">message</span>[msgId=<span class="number">7</span>F0000016C4918B4AAC2130BFEBD0056] Hello scheduled <span class="keyword">message</span> <span class="number">869992</span>ms later</span><br></pre></td></tr></table></figure></p>
<h3 id="批量消息"><a href="#批量消息" class="headerlink" title="批量消息"></a>批量消息</h3><p>批量发送消息能显著提高传递小消息的性能。限制是这些批量消息应该有相同的topic，相同的waitStoreMsgOK，而且不能是延时消息。此外，这一批消息的总大小不应超过4MB。</p>
<p>每次只发送不超过4MB的消息，则很容易使用批处理，样例如下<br><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.rocketmq.client.producer.DefaultMQProducer;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.common.message.Message;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @author dinghuang123@gmail.com</span></span><br><span class="line"><span class="comment"> * @since 2022/3/3</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BatchProducer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> void main(<span class="keyword">String</span>[] args) throws Exception &#123;</span><br><span class="line">        <span class="comment">// 实例化消息生产者Producer</span></span><br><span class="line">        DefaultMQProducer producer = <span class="keyword">new</span> <span class="type">DefaultMQProducer</span>(<span class="string">"please_rename_unique_group_name"</span>);</span><br><span class="line">        <span class="comment">// 设置NameServer的地址</span></span><br><span class="line">        producer.setNamesrvAddr(<span class="string">"127.0.0.1:9876"</span>);</span><br><span class="line">        <span class="comment">// 启动Producer实例</span></span><br><span class="line">        producer.start();</span><br><span class="line">        List&lt;Message&gt; messages = <span class="keyword">new</span> <span class="type">ArrayList</span>&lt;&gt;();</span><br><span class="line">        messages.add(<span class="keyword">new</span> <span class="type">Message</span>(<span class="string">"BatchTest"</span>, <span class="string">"TagA"</span>, <span class="string">"OrderID001"</span>, <span class="string">"Hello world 0"</span>.getBytes()));</span><br><span class="line">        messages.add(<span class="keyword">new</span> <span class="type">Message</span>(<span class="string">"BatchTest"</span>, <span class="string">"TagA"</span>, <span class="string">"OrderID002"</span>, <span class="string">"Hello world 1"</span>.getBytes()));</span><br><span class="line">        messages.add(<span class="keyword">new</span> <span class="type">Message</span>(<span class="string">"BatchTest"</span>, <span class="string">"TagA"</span>, <span class="string">"OrderID003"</span>, <span class="string">"Hello world 2"</span>.getBytes()));</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            producer.send(messages);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="comment">//处理error</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果不再发送消息，关闭Producer实例。</span></span><br><span class="line">        producer.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"><span class="meta-keyword">import</span> org.apache.rocketmq.client.consumer.DefaultMQPushConsumer;</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">import</span> org.apache.rocketmq.client.consumer.listener.ConsumeConcurrentlyContext;</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">import</span> org.apache.rocketmq.client.consumer.listener.ConsumeConcurrentlyStatus;</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">import</span> org.apache.rocketmq.client.consumer.listener.MessageListenerConcurrently;</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">import</span> org.apache.rocketmq.client.exception.MQClientException;</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">import</span> org.apache.rocketmq.common.message.MessageExt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="meta-keyword">import</span> java.util.List;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @author dinghuang123@gmail.com</span></span><br><span class="line"><span class="comment"> * @since 2022/3/3</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BatchConsumer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> main(String[] args) throws MQClientException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 实例化消费者</span></span><br><span class="line">        DefaultMQPushConsumer consumer = <span class="keyword">new</span> DefaultMQPushConsumer(<span class="string">"please_rename_unique_group_name"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置NameServer的地址</span></span><br><span class="line">        consumer.setNamesrvAddr(<span class="string">"127.0.0.1:9876"</span>);</span><br><span class="line">        <span class="comment">// 订阅一个或者多个Topic，以及Tag来过滤需要消费的消息</span></span><br><span class="line">        consumer.subscribe(<span class="string">"BatchTest"</span>, <span class="string">"*"</span>);</span><br><span class="line">        <span class="comment">//指定批量消费的最大值，默认是1</span></span><br><span class="line">        consumer.setConsumeMessageBatchMaxSize(<span class="number">5</span>);</span><br><span class="line">        <span class="comment">//批量拉取消息的数量，默认是32</span></span><br><span class="line">        consumer.setPullBatchSize(<span class="number">30</span>);</span><br><span class="line">        consumer.registerMessageListener(<span class="keyword">new</span> MessageListenerConcurrently() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            <span class="keyword">public</span> ConsumeConcurrentlyStatus consumeMessage(List&lt;MessageExt&gt; msgs, ConsumeConcurrentlyContext context) &#123;</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">"一次收到"</span> + msgs.size() + <span class="string">"消息"</span>);</span><br><span class="line">                <span class="keyword">return</span> ConsumeConcurrentlyStatus.CONSUME_SUCCESS;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 启动消费者实例</span></span><br><span class="line">        consumer.start();</span><br><span class="line">        System.out.printf(<span class="string">"Consumer Started.%n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>消息列表分割</p>
<p>复杂度只有当你发送大批量时才会增长，你可能不确定它是否超过了大小限制（4MB）。这时候你最好把你的消息列表分割一下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.rocketmq.demo.rocket;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.client.producer.DefaultMQProducer;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.common.message.Message;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> dinghuang123@gmail.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2022/3/3</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SplitBatchProducer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 实例化消息生产者Producer</span></span><br><span class="line">        DefaultMQProducer producer = <span class="keyword">new</span> DefaultMQProducer(<span class="string">"please_rename_unique_group_name"</span>);</span><br><span class="line">        <span class="comment">// 设置NameServer的地址</span></span><br><span class="line">        producer.setNamesrvAddr(<span class="string">"127.0.0.1:9876"</span>);</span><br><span class="line">        <span class="comment">// 启动Producer实例</span></span><br><span class="line">        producer.start();</span><br><span class="line">        <span class="comment">//把大的消息分裂成若干个小的消息</span></span><br><span class="line">        List&lt;Message&gt; messages = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">            messages.add(<span class="keyword">new</span> Message(<span class="string">"BatchTest"</span>, <span class="string">"TagA"</span>, <span class="string">"OrderID002"</span>, (<span class="string">"Hello world "</span> + i).getBytes()));</span><br><span class="line">        &#125;</span><br><span class="line">        ListSplitter splitter = <span class="keyword">new</span> ListSplitter(messages);</span><br><span class="line">        <span class="keyword">while</span> (splitter.hasNext()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                List&lt;Message&gt; listItem = splitter.next();</span><br><span class="line">                producer.send(listItem);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                <span class="comment">//处理error</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果不再发送消息，关闭Producer实例。</span></span><br><span class="line">        producer.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ListSplitter</span> <span class="keyword">implements</span> <span class="title">Iterator</span>&lt;<span class="title">List</span>&lt;<span class="title">Message</span>&gt;&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> SIZE_LIMIT = <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">4</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Message&gt; messages;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> currIndex;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ListSplitter</span><span class="params">(List&lt;Message&gt; messages)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.messages = messages;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> currIndex &lt; messages.size();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> List&lt;Message&gt; <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">int</span> startIndex = getStartIndex();</span><br><span class="line">            <span class="keyword">int</span> nextIndex = startIndex;</span><br><span class="line">            <span class="keyword">int</span> totalSize = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (; nextIndex &lt; messages.size(); nextIndex++) &#123;</span><br><span class="line">                Message message = messages.get(nextIndex);</span><br><span class="line">                <span class="keyword">int</span> tmpSize = calcMessageSize(message);</span><br><span class="line">                <span class="keyword">if</span> (tmpSize + totalSize &gt; SIZE_LIMIT) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    totalSize += tmpSize;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            List&lt;Message&gt; subList = messages.subList(startIndex, nextIndex);</span><br><span class="line">            currIndex = nextIndex;</span><br><span class="line">            <span class="keyword">return</span> subList;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">getStartIndex</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            Message currMessage = messages.get(currIndex);</span><br><span class="line">            <span class="keyword">int</span> tmpSize = calcMessageSize(currMessage);</span><br><span class="line">            <span class="keyword">while</span> (tmpSize &gt; SIZE_LIMIT) &#123;</span><br><span class="line">                currIndex += <span class="number">1</span>;</span><br><span class="line">                Message message = messages.get(currIndex);</span><br><span class="line">                tmpSize = calcMessageSize(message);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> currIndex;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">calcMessageSize</span><span class="params">(Message message)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">int</span> tmpSize = message.getTopic().length() + message.getBody().length;</span><br><span class="line">            Map&lt;String, String&gt; properties = message.getProperties();</span><br><span class="line">            <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; entry : properties.entrySet()) &#123;</span><br><span class="line">                tmpSize += entry.getKey().length() + entry.getValue().length();</span><br><span class="line">            &#125;</span><br><span class="line">            tmpSize = tmpSize + <span class="number">20</span>; <span class="comment">// 增加⽇日志的开销20字节</span></span><br><span class="line">            <span class="keyword">return</span> tmpSize;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="过滤消息"><a href="#过滤消息" class="headerlink" title="过滤消息"></a>过滤消息</h3><p>TAG是一个简单而有用的设计，其可以来选择您想要的消息。例如：<br><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DefaultMQPushConsumer consumer = <span class="keyword">new</span> <span class="type">DefaultMQPushConsumer</span>(<span class="string">"CID_EXAMPLE"</span>);</span><br><span class="line">consumer.subscribe(<span class="string">"TOPIC"</span>, <span class="string">"TAGA || TAGB || TAGC"</span>);</span><br></pre></td></tr></table></figure></p>
<p>消费者将接收包含TAGA或TAGB或TAGC的消息。但是限制是一个消息只能有一个标签，这对于复杂的场景可能不起作用。在这种情况下，可以使用SQL表达式筛选消息。SQL特性可以通过发送消息时的属性来进行计算。在RocketMQ定义的语法下，可以实现一些简单的逻辑。下面是一个例子：<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">------------</span><br><span class="line">| message  |</span><br><span class="line">|----------|  a &gt; 5 AND b = <span class="emphasis">'abc'</span></span><br><span class="line">| a = 10   |  --------------------&gt; Gotten</span><br><span class="line">| b = <span class="emphasis">'abc'</span>|</span><br><span class="line">| c = true |</span><br><span class="line">------------</span><br><span class="line">------------</span><br><span class="line">| message  |</span><br><span class="line">|----------|   a &gt; 5 AND b = <span class="emphasis">'abc'</span></span><br><span class="line">| a = 1    |  --------------------&gt; Missed</span><br><span class="line">| b = <span class="emphasis">'abc'</span>|</span><br><span class="line">| c = true |</span><br><span class="line">------------</span><br></pre></td></tr></table></figure></p>
<h4 id="基本语法"><a href="#基本语法" class="headerlink" title="基本语法"></a>基本语法</h4><p>RocketMQ只定义了一些基本语法来支持这个特性。你也可以很容易地扩展它。</p>
<ul>
<li>数值比较，比如：&gt;，&gt;=，&lt;，&lt;=，BETWEEN，=；</li>
<li>字符比较，比如：=，&lt;&gt;，IN；</li>
<li>IS NULL 或者 IS NOT NULL；</li>
<li>逻辑符号 AND，OR，NOT；</li>
</ul>
<p>常量支持类型为：</p>
<ul>
<li>数值，比如：123，3.1415；</li>
<li>字符，比如：’abc’，必须用单引号包裹起来；</li>
<li>NULL，特殊的常量</li>
<li>布尔值，TRUE 或 FALSE</li>
</ul>
<p>只有使用push模式的消费者才能用使用SQL92标准的sql语句，接口如下：<br><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> subscribe(finalString topic, <span class="keyword">final</span> MessageSelector messageSelector)</span><br></pre></td></tr></table></figure></p>
<h4 id="使用-1"><a href="#使用-1" class="headerlink" title="使用"></a>使用</h4><h5 id="生产者"><a href="#生产者" class="headerlink" title="生产者"></a>生产者</h5><p>发送消息时，你能通过<code>putUserProperty</code>来设置消息的属性<br><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">DefaultMQProducer producer = <span class="keyword">new</span> <span class="type">DefaultMQProducer</span>(<span class="string">"please_rename_unique_group_name"</span>);</span><br><span class="line">producer.start();</span><br><span class="line">Message msg = <span class="keyword">new</span> <span class="type">Message</span>(<span class="string">"TopicTest"</span>,</span><br><span class="line">   tag,</span><br><span class="line">   (<span class="string">"Hello RocketMQ "</span> + i).getBytes(RemotingHelper.DEFAULT_CHARSET)</span><br><span class="line">);</span><br><span class="line"><span class="comment">// 设置一些属性</span></span><br><span class="line">msg.putUserProperty(<span class="string">"a"</span>, <span class="keyword">String</span>.valueOf(i));</span><br><span class="line">SendResult sendResult = producer.send(msg);</span><br><span class="line"></span><br><span class="line">producer.shutdown();</span><br></pre></td></tr></table></figure></p>
<h5 id="消费者"><a href="#消费者" class="headerlink" title="消费者"></a>消费者</h5><p>用MessageSelector.bySql来使用sql筛选消息<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">DefaultMQPushConsumer consumer = <span class="keyword">new</span> DefaultMQPushConsumer(<span class="string">"please_rename_unique_group_name_4"</span>);</span><br><span class="line"><span class="comment">// 只有订阅的消息有这个属性a, a &gt;=0 and a &lt;= 3</span></span><br><span class="line">consumer.subscribe(<span class="string">"TopicTest"</span>, MessageSelector.bySql(<span class="string">"a between 0 and 3"</span>);</span><br><span class="line">consumer.registerMessageListener(<span class="keyword">new</span> MessageListenerConcurrently() &#123;</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> <span class="function">ConsumeConcurrentlyStatus <span class="title">consumeMessage</span><span class="params">(List&lt;MessageExt&gt; msgs, ConsumeConcurrentlyContext context)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> ConsumeConcurrentlyStatus.CONSUME_SUCCESS;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;);</span><br><span class="line">consumer.start();</span><br></pre></td></tr></table></figure></p>
<h3 id="消息事务"><a href="#消息事务" class="headerlink" title="消息事务"></a>消息事务</h3><p>事务消息共有三种状态，提交状态、回滚状态、中间状态：</p>
<ul>
<li>TransactionStatus.CommitTransaction: 提交事务，它允许消费者消费此消息。</li>
<li>TransactionStatus.RollbackTransaction: 回滚事务，它代表该消息将被删除，不允许被消费。</li>
<li>TransactionStatus.Unknown: 中间状态，它代表需要检查消息队列来确定状态。</li>
</ul>
<h4 id="创建事务性生产者"><a href="#创建事务性生产者" class="headerlink" title="创建事务性生产者"></a>创建事务性生产者</h4><p>使用 TransactionMQProducer类创建生产者，并指定唯一的 ProducerGroup，就可以设置自定义线程池来处理这些检查请求。执行本地事务后、需要根据执行结果对消息队列进行回复。回传的事务状态在请参考前一节。<br><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.rocketmq.demo.rocket;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.client.exception.MQClientException;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.client.producer.SendResult;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.client.producer.TransactionListener;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.client.producer.TransactionMQProducer;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.common.message.Message;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.remoting.common.RemotingHelper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.UnsupportedEncodingException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @author dinghuang123@gmail.com</span></span><br><span class="line"><span class="comment"> * @since 2022/3/7</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransactionProducer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> void main(<span class="keyword">String</span>[] args) throws MQClientException, InterruptedException &#123;</span><br><span class="line">        TransactionListener transactionListener = <span class="keyword">new</span> <span class="type">TransactionListenerImpl</span>();</span><br><span class="line">        TransactionMQProducer producer = <span class="keyword">new</span> <span class="type">TransactionMQProducer</span>(<span class="string">"please_rename_unique_group_name"</span>);</span><br><span class="line">        ExecutorService executorService = <span class="keyword">new</span> <span class="type">ThreadPoolExecutor</span>(<span class="number">2</span>, <span class="number">5</span>, <span class="number">100</span>, TimeUnit.SECONDS, <span class="keyword">new</span> <span class="type">ArrayBlockingQueue</span>&lt;Runnable&gt;(<span class="number">2000</span>), <span class="keyword">new</span> <span class="type">ThreadFactory</span>() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            <span class="keyword">public</span> Thread <span class="keyword">new</span><span class="type">Thread</span>(Runnable r) &#123;</span><br><span class="line">                Thread thread = <span class="keyword">new</span> <span class="type">Thread</span>(r);</span><br><span class="line">                thread.setName(<span class="string">"client-transaction-msg-check-thread"</span>);</span><br><span class="line">                <span class="keyword">return</span> thread;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        producer.setNamesrvAddr(<span class="string">"127.0.0.1:9876"</span>);</span><br><span class="line">        producer.setExecutorService(executorService);</span><br><span class="line">        producer.setTransactionListener(transactionListener);</span><br><span class="line">        producer.start();</span><br><span class="line">        <span class="keyword">String</span>[] tags = <span class="keyword">new</span> <span class="type">String</span>[]&#123;<span class="string">"TagA"</span>, <span class="string">"TagB"</span>, <span class="string">"TagC"</span>, <span class="string">"TagD"</span>, <span class="string">"TagE"</span>&#125;;</span><br><span class="line">        <span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Message msg =</span><br><span class="line">                        <span class="keyword">new</span> <span class="type">Message</span>(<span class="string">"TransactionTopicTest"</span>, tags[i % tags.length], <span class="string">"KEY"</span> + i,</span><br><span class="line">                                (<span class="string">"Hello RocketMQ "</span> + i).getBytes(RemotingHelper.DEFAULT_CHARSET));</span><br><span class="line">                SendResult sendResult = producer.sendMessageInTransaction(msg, <span class="literal">null</span>);</span><br><span class="line">                System.out.printf(<span class="string">"%s%n"</span>, sendResult);</span><br><span class="line">                Thread.sleep(<span class="number">10</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (MQClientException | UnsupportedEncodingException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt; <span class="number">100000</span>; i++) &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        producer.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.rocketmq.demo.rocket;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.client.consumer.DefaultMQPushConsumer;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.client.consumer.listener.ConsumeConcurrentlyContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.client.consumer.listener.ConsumeConcurrentlyStatus;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.client.consumer.listener.MessageListenerConcurrently;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.client.exception.MQClientException;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.common.message.MessageExt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> dinghuang123@gmail.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2022/3/3</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransactionConsumer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException, MQClientException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 实例化消费者</span></span><br><span class="line">        DefaultMQPushConsumer consumer = <span class="keyword">new</span> DefaultMQPushConsumer(<span class="string">"please_rename_unique_group_name"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置NameServer的地址</span></span><br><span class="line">        consumer.setNamesrvAddr(<span class="string">"127.0.0.1:9876"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 订阅一个或者多个Topic，以及Tag来过滤需要消费的消息</span></span><br><span class="line">        consumer.subscribe(<span class="string">"TransactionTopicTest"</span>, <span class="string">"*"</span>);</span><br><span class="line">        <span class="comment">// 注册回调实现类来处理从broker拉取回来的消息</span></span><br><span class="line">        consumer.registerMessageListener(<span class="keyword">new</span> MessageListenerConcurrently() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> ConsumeConcurrentlyStatus <span class="title">consumeMessage</span><span class="params">(List&lt;MessageExt&gt; msgs, ConsumeConcurrentlyContext context)</span> </span>&#123;</span><br><span class="line">                System.out.printf(<span class="string">"%s Receive New Messages: %s %n"</span>, Thread.currentThread().getName(), msgs);</span><br><span class="line">                <span class="comment">// 标记该消息已经被成功消费</span></span><br><span class="line">                <span class="keyword">return</span> ConsumeConcurrentlyStatus.CONSUME_SUCCESS;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 启动消费者实例</span></span><br><span class="line">        consumer.start();</span><br><span class="line">        System.out.printf(<span class="string">"Consumer Started.%n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="实现事务的监听接口"><a href="#实现事务的监听接口" class="headerlink" title="实现事务的监听接口"></a>实现事务的监听接口</h4><p>当发送半消息成功时，我们使用 executeLocalTransaction 方法来执行本地事务。它返回前一节中提到的三个事务状态之一。checkLocalTransaction 方法用于检查本地事务状态，并回应消息队列的检查请求。它也是返回前一节中提到的三个事务状态之一。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.rocketmq.demo.rocket;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.client.producer.LocalTransactionState;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.client.producer.TransactionListener;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.common.message.Message;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.common.message.MessageExt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentHashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> dinghuang123@gmail.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2022/3/7</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransactionListenerImpl</span> <span class="keyword">implements</span> <span class="title">TransactionListener</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> AtomicInteger transactionIndex = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">private</span> ConcurrentHashMap&lt;String, Integer&gt; localTrans = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LocalTransactionState <span class="title">executeLocalTransaction</span><span class="params">(Message msg, Object arg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> value = transactionIndex.getAndIncrement();</span><br><span class="line">        <span class="keyword">int</span> status = value % <span class="number">3</span>;</span><br><span class="line">        localTrans.put(msg.getTransactionId(), status);</span><br><span class="line">        System.out.println(<span class="keyword">new</span> String(msg.getBody()) + <span class="string">":executeLocalTransaction:"</span> + msg.getTransactionId() + <span class="string">":"</span> + status + <span class="string">":"</span> + value);</span><br><span class="line">        <span class="keyword">return</span> LocalTransactionState.UNKNOW;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LocalTransactionState <span class="title">checkLocalTransaction</span><span class="params">(MessageExt msg)</span> </span>&#123;</span><br><span class="line">        Integer status = localTrans.get(msg.getTransactionId());</span><br><span class="line">        System.out.println(<span class="keyword">new</span> String(msg.getBody()) + <span class="string">":"</span> + <span class="string">"checkLocalTransaction"</span> + <span class="string">":"</span> + status );</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != status) &#123;</span><br><span class="line">            <span class="keyword">switch</span> (status) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                    <span class="keyword">return</span> LocalTransactionState.UNKNOW;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                    <span class="keyword">return</span> LocalTransactionState.COMMIT_MESSAGE;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                    <span class="keyword">return</span> LocalTransactionState.ROLLBACK_MESSAGE;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> LocalTransactionState.COMMIT_MESSAGE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="事务消息使用上的限制"><a href="#事务消息使用上的限制" class="headerlink" title="事务消息使用上的限制"></a>事务消息使用上的限制</h4><ul>
<li>事务消息不支持延时消息和批量消息。</li>
<li>为了避免单个消息被检查太多次而导致半队列消息累积，我们默认将单个消息的检查次数限制为 15 次，但是用户可以通过 Broker 配置文件的 transactionCheckMax参数来修改此限制。如果已经检查某条消息超过 N 次的话（ N = transactionCheckMax ） 则 Broker 将丢弃此消息，并在默认情况下同时打印错误日志。用户可以通过重写 AbstractTransactionalMessageCheckListener 类来修改这个行为。</li>
<li>事务消息将在 Broker 配置文件中的参数 transactionTimeout 这样的特定时间长度之后被检查。当发送事务消息时，用户还可以通过设置用户属性 CHECK_IMMUNITY_TIME_IN_SECONDS 来改变这个限制，该参数优先于 transactionTimeout 参数。</li>
<li>事务性消息可能不止一次被检查或消费。</li>
<li>提交给用户的目标主题消息可能会失败，目前这依日志的记录而定。它的高可用性通过 RocketMQ 本身的高可用性机制来保证，如果希望确保事务消息不丢失、并且事务完整性得到保证，建议使用同步的双重写入机制。</li>
<li>事务消息的生产者 ID 不能与其他类型消息的生产者 ID 共享。与其他类型的消息不同，事务消息允许反向查询、MQ服务器能通过它们的生产者 ID 查询到消费者。</li>
</ul>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p><a href="https://github.com/apache/rocketmq/blob/master/docs/cn/RocketMQ_Example.md#7-logappender%E6%A0%B7%E4%BE%8B" target="_blank" rel="noopener">地址</a></p>
<h1 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h1><h2 id="1-生产者"><a href="#1-生产者" class="headerlink" title="1   生产者"></a>1   生产者</h2><h3 id="1-1-发送消息注意事项"><a href="#1-1-发送消息注意事项" class="headerlink" title="1.1 发送消息注意事项"></a>1.1 发送消息注意事项</h3><h4 id="1-Tags的使用"><a href="#1-Tags的使用" class="headerlink" title="1  Tags的使用"></a>1  Tags的使用</h4><p>一个应用尽可能用一个Topic，而消息子类型则可以用tags来标识。tags可以由应用自由设置，只有生产者在发送消息设置了tags，消费方在订阅消息时才可以利用tags通过broker做消息过滤：message.setTags(“TagA”)。  </p>
<h4 id="2-Keys的使用"><a href="#2-Keys的使用" class="headerlink" title="2 Keys的使用"></a>2 Keys的使用</h4><p>每个消息在业务层面的唯一标识码要设置到keys字段，方便将来定位消息丢失问题。服务器会为每个消息创建索引（哈希索引），应用可以通过topic、key来查询这条消息内容，以及消息被谁消费。由于是哈希索引，请务必保证key尽可能唯一，这样可以避免潜在的哈希冲突。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 订单Id   </span></span><br><span class="line">String orderId = <span class="string">"20034568923546"</span>;   </span><br><span class="line">message.setKeys(orderId);</span><br></pre></td></tr></table></figure>
<h4 id="3-日志的打印"><a href="#3-日志的打印" class="headerlink" title="3 日志的打印"></a>3 日志的打印</h4><p>消息发送成功或者失败要打印消息日志，务必要打印SendResult和key字段。send消息方法只要不抛异常，就代表发送成功。发送成功会有多个状态，在sendResult里定义。以下对每个状态进行说明：     </p>
<ul>
<li><strong>SEND_OK</strong></li>
</ul>
<p>消息发送成功。要注意的是消息发送成功也不意味着它是可靠的。要确保不会丢失任何消息，还应启用同步Master服务器或同步刷盘，即SYNC_MASTER或SYNC_FLUSH。</p>
<ul>
<li><strong>FLUSH_DISK_TIMEOUT</strong></li>
</ul>
<p>消息发送成功但是服务器刷盘超时。此时消息已经进入服务器队列（内存），只有服务器宕机，消息才会丢失。消息存储配置参数中可以设置刷盘方式和同步刷盘时间长度，如果Broker服务器设置了刷盘方式为同步刷盘，即FlushDiskType=SYNC_FLUSH（默认为异步刷盘方式），当Broker服务器未在同步刷盘时间内（默认为5s）完成刷盘，则将返回该状态——刷盘超时。</p>
<ul>
<li><strong>FLUSH_SLAVE_TIMEOUT</strong></li>
</ul>
<p>消息发送成功，但是服务器同步到Slave时超时。此时消息已经进入服务器队列，只有服务器宕机，消息才会丢失。如果Broker服务器的角色是同步Master，即SYNC_MASTER（默认是异步Master即ASYNC_MASTER），并且从Broker服务器未在同步刷盘时间（默认为5秒）内完成与主服务器的同步，则将返回该状态——数据同步到Slave服务器超时。</p>
<ul>
<li><strong>SLAVE_NOT_AVAILABLE</strong></li>
</ul>
<p>消息发送成功，但是此时Slave不可用。如果Broker服务器的角色是同步Master，即SYNC_MASTER（默认是异步Master服务器即ASYNC_MASTER），但没有配置slave Broker服务器，则将返回该状态——无Slave服务器可用。</p>
<h3 id="1-2-消息发送失败处理方式"><a href="#1-2-消息发送失败处理方式" class="headerlink" title="1.2 消息发送失败处理方式"></a>1.2 消息发送失败处理方式</h3><p>Producer的send方法本身支持内部重试，重试逻辑如下：</p>
<ul>
<li>至多重试2次。</li>
<li>如果同步模式发送失败，则轮转到下一个Broker，如果异步模式发送失败，则只会在当前Broker进行重试。这个方法的总耗时时间不超过sendMsgTimeout设置的值，默认10s。</li>
<li>如果本身向broker发送消息产生超时异常，就不会再重试。</li>
</ul>
<p>以上策略也是在一定程度上保证了消息可以发送成功。如果业务对消息可靠性要求比较高，建议应用增加相应的重试逻辑：比如调用send同步方法发送失败时，则尝试将消息存储到db，然后由后台线程定时重试，确保消息一定到达Broker。</p>
<p>上述db重试方式为什么没有集成到MQ客户端内部做，而是要求应用自己去完成，主要基于以下几点考虑：首先，MQ的客户端设计为无状态模式，方便任意的水平扩展，且对机器资源的消耗仅仅是cpu、内存、网络。其次，如果MQ客户端内部集成一个KV存储模块，那么数据只有同步落盘才能较可靠，而同步落盘本身性能开销较大，所以通常会采用异步落盘，又由于应用关闭过程不受MQ运维人员控制，可能经常会发生 kill -9 这样暴力方式关闭，造成数据没有及时落盘而丢失。第三，Producer所在机器的可靠性较低，一般为虚拟机，不适合存储重要数据。综上，建议重试过程交由应用来控制。</p>
<h3 id="1-3选择oneway形式发送"><a href="#1-3选择oneway形式发送" class="headerlink" title="1.3选择oneway形式发送"></a>1.3选择oneway形式发送</h3><p>通常消息的发送是这样一个过程：</p>
<ul>
<li>客户端发送请求到服务器</li>
<li>服务器处理请求</li>
<li>服务器向客户端返回应答</li>
</ul>
<p>所以，一次消息发送的耗时时间是上述三个步骤的总和，而某些场景要求耗时非常短，但是对可靠性要求并不高，例如日志收集类应用，此类应用可以采用oneway形式调用，oneway形式只发送请求不等待应答，而发送请求在客户端实现层面仅仅是一个操作系统系统调用的开销，即将数据写入客户端的socket缓冲区，此过程耗时通常在微秒级。</p>
<h2 id="2-消费者"><a href="#2-消费者" class="headerlink" title="2   消费者"></a>2   消费者</h2><h3 id="2-1-消费过程幂等"><a href="#2-1-消费过程幂等" class="headerlink" title="2.1 消费过程幂等"></a>2.1 消费过程幂等</h3><p>RocketMQ无法避免消息重复（Exactly-Once），所以如果业务对消费重复非常敏感，务必要在业务层面进行去重处理。可以借助关系数据库进行去重。首先需要确定消息的唯一键，可以是msgId，也可以是消息内容中的唯一标识字段，例如订单Id等。在消费之前判断唯一键是否在关系数据库中存在。如果不存在则插入，并消费，否则跳过。（实际过程要考虑原子性问题，判断是否存在可以尝试插入，如果报主键冲突，则插入失败，直接跳过）</p>
<p>msgId一定是全局唯一标识符，但是实际使用中，可能会存在相同的消息有两个不同msgId的情况（消费者主动重发、因客户端重投机制导致的重复等），这种情况就需要使业务字段进行重复消费。</p>
<h3 id="2-2-消费速度慢的处理方式"><a href="#2-2-消费速度慢的处理方式" class="headerlink" title="2.2 消费速度慢的处理方式"></a>2.2 消费速度慢的处理方式</h3><h4 id="1-提高消费并行度"><a href="#1-提高消费并行度" class="headerlink" title="1 提高消费并行度"></a>1 提高消费并行度</h4><p>绝大部分消息消费行为都属于 IO 密集型，即可能是操作数据库，或者调用 RPC，这类消费行为的消费速度在于后端数据库或者外系统的吞吐量，通过增加消费并行度，可以提高总的消费吞吐量，但是并行度增加到一定程度，反而会下降。所以，应用必须要设置合理的并行度。 如下有几种修改消费并行度的方法：</p>
<ul>
<li>同一个 ConsumerGroup 下，通过增加 Consumer 实例数量来提高并行度（需要注意的是超过订阅队列数的 Consumer 实例无效）。可以通过加机器，或者在已有机器启动多个进程的方式。</li>
<li>提高单个 Consumer 的消费并行线程，通过修改参数 consumeThreadMin、consumeThreadMax实现。</li>
</ul>
<h4 id="2-批量方式消费"><a href="#2-批量方式消费" class="headerlink" title="2   批量方式消费"></a>2   批量方式消费</h4><p>某些业务流程如果支持批量方式消费，则可以很大程度上提高消费吞吐量，例如订单扣款类应用，一次处理一个订单耗时 1 s，一次处理 10 个订单可能也只耗时 2 s，这样即可大幅度提高消费的吞吐量，通过设置 consumer的 consumeMessageBatchMaxSize 返个参数，默认是 1，即一次只消费一条消息，例如设置为 N，那么每次消费的消息数小于等于 N。</p>
<h4 id="3-跳过非重要消息"><a href="#3-跳过非重要消息" class="headerlink" title="3   跳过非重要消息"></a>3   跳过非重要消息</h4><p>发生消息堆积时，如果消费速度一直追不上发送速度，如果业务对数据要求不高的话，可以选择丢弃不重要的消息。例如，当某个队列的消息数堆积到100000条以上，则尝试丢弃部分或全部消息，这样就可以快速追上发送消息的速度。示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ConsumeConcurrentlyStatus <span class="title">consumeMessage</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        List&lt;MessageExt&gt; msgs,</span></span></span><br><span class="line"><span class="function"><span class="params">        ConsumeConcurrentlyContext context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> offset = msgs.get(<span class="number">0</span>).getQueueOffset();</span><br><span class="line">    String maxOffset =</span><br><span class="line">            msgs.get(<span class="number">0</span>).getProperty(Message.PROPERTY_MAX_OFFSET);</span><br><span class="line">    <span class="keyword">long</span> diff = Long.parseLong(maxOffset) - offset;</span><br><span class="line">    <span class="keyword">if</span> (diff &gt; <span class="number">100000</span>) &#123;</span><br><span class="line">        <span class="comment">// TODO 消息堆积情况的特殊处理</span></span><br><span class="line">        <span class="keyword">return</span> ConsumeConcurrentlyStatus.CONSUME_SUCCESS;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// TODO 正常消费过程</span></span><br><span class="line">    <span class="keyword">return</span> ConsumeConcurrentlyStatus.CONSUME_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4-优化每条消息消费过程"><a href="#4-优化每条消息消费过程" class="headerlink" title="4 优化每条消息消费过程"></a>4 优化每条消息消费过程</h4><p>举例如下，某条消息的消费过程如下：</p>
<ul>
<li>根据消息从 DB 查询【数据 1】</li>
<li>根据消息从 DB 查询【数据 2】</li>
<li>复杂的业务计算</li>
<li>向 DB 插入【数据 3】</li>
<li>向 DB 插入【数据 4】</li>
</ul>
<p>这条消息的消费过程中有4次与 DB的 交互，如果按照每次 5ms 计算，那么总共耗时 20ms，假设业务计算耗时 5ms，那么总过耗时 25ms，所以如果能把 4 次 DB 交互优化为 2 次，那么总耗时就可以优化到 15ms，即总体性能提高了 40%。所以应用如果对时延敏感的话，可以把DB部署在SSD硬盘，相比于SCSI磁盘，前者的RT会小很多。</p>
<h3 id="2-3-消费打印日志"><a href="#2-3-消费打印日志" class="headerlink" title="2.3 消费打印日志"></a>2.3 消费打印日志</h3><p>如果消息量较少，建议在消费入口方法打印消息，消费耗时等，方便后续排查问题。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ConsumeConcurrentlyStatus <span class="title">consumeMessage</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">         List&lt;MessageExt&gt; msgs,</span></span></span><br><span class="line"><span class="function"><span class="params">         ConsumeConcurrentlyContext context)</span> </span>&#123;</span><br><span class="line">     log.info(<span class="string">"RECEIVE_MSG_BEGIN: "</span> + msgs.toString());</span><br><span class="line">     <span class="comment">// TODO 正常消费过程</span></span><br><span class="line">     <span class="keyword">return</span> ConsumeConcurrentlyStatus.CONSUME_SUCCESS;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>如果能打印每条消息消费耗时，那么在排查消费慢等线上问题时，会更方便。</p>
<h3 id="2-4-其他消费建议"><a href="#2-4-其他消费建议" class="headerlink" title="2.4 其他消费建议"></a>2.4 其他消费建议</h3><h4 id="1-关于消费者和订阅"><a href="#1-关于消费者和订阅" class="headerlink" title="1 关于消费者和订阅"></a>1 关于消费者和订阅</h4><p>第一件需要注意的事情是，不同的消费者组可以独立的消费一些 topic，并且每个消费者组都有自己的消费偏移量，请确保同一组内的每个消费者订阅信息保持一致。</p>
<h4 id="2-关于有序消息"><a href="#2-关于有序消息" class="headerlink" title="2 关于有序消息"></a>2 关于有序消息</h4><p>消费者将锁定每个消息队列，以确保他们被逐个消费，虽然这将会导致性能下降，但是当你关心消息顺序的时候会很有用。我们不建议抛出异常，你可以返回 ConsumeOrderlyStatus.SUSPEND_CURRENT_QUEUE_A_MOMENT 作为替代。</p>
<h4 id="3-关于并发消费"><a href="#3-关于并发消费" class="headerlink" title="3 关于并发消费"></a>3 关于并发消费</h4><p>顾名思义，消费者将并发消费这些消息，建议你使用它来获得良好性能，我们不建议抛出异常，你可以返回 ConsumeConcurrentlyStatus.RECONSUME_LATER 作为替代。</p>
<h4 id="4-关于消费状态Consume-Status"><a href="#4-关于消费状态Consume-Status" class="headerlink" title="4 关于消费状态Consume Status"></a>4 关于消费状态Consume Status</h4><p>对于并发的消费监听器，你可以返回 RECONSUME_LATER 来通知消费者现在不能消费这条消息，并且希望可以稍后重新消费它。然后，你可以继续消费其他消息。对于有序的消息监听器，因为你关心它的顺序，所以不能跳过消息，但是你可以返回SUSPEND_CURRENT_QUEUE_A_MOMENT 告诉消费者等待片刻。</p>
<h4 id="5-关于Blocking"><a href="#5-关于Blocking" class="headerlink" title="5 关于Blocking"></a>5 关于Blocking</h4><p>不建议阻塞监听器，因为它会阻塞线程池，并最终可能会终止消费进程</p>
<h4 id="6-关于线程数设置"><a href="#6-关于线程数设置" class="headerlink" title="6 关于线程数设置"></a>6 关于线程数设置</h4><p>消费者使用 ThreadPoolExecutor 在内部对消息进行消费，所以你可以通过设置 setConsumeThreadMin 或 setConsumeThreadMax 来改变它。</p>
<h4 id="7-关于消费位点"><a href="#7-关于消费位点" class="headerlink" title="7 关于消费位点"></a>7 关于消费位点</h4><p>当建立一个新的消费者组时，需要决定是否需要消费已经存在于 Broker 中的历史消息CONSUME_FROM_LAST_OFFSET 将会忽略历史消息，并消费之后生成的任何消息。CONSUME_FROM_FIRST_OFFSET 将会消费每个存在于 Broker 中的信息。你也可以使用 CONSUME_FROM_TIMESTAMP 来消费在指定时间戳后产生的消息。</p>
<h2 id="3-Broker"><a href="#3-Broker" class="headerlink" title="3   Broker"></a>3   Broker</h2><h3 id="3-1-Broker-角色"><a href="#3-1-Broker-角色" class="headerlink" title="3.1 Broker 角色"></a>3.1 Broker 角色</h3><p> Broker 角色分为 ASYNC_MASTER（异步主机）、SYNC_MASTER（同步主机）以及SLAVE（从机）。如果对消息的可靠性要求比较严格，可以采用 SYNC_MASTER加SLAVE的部署方式。如果对消息可靠性要求不高，可以采用ASYNC_MASTER加SLAVE的部署方式。如果只是测试方便，则可以选择仅ASYNC_MASTER或仅SYNC_MASTER的部署方式。</p>
<h3 id="3-2-FlushDiskType"><a href="#3-2-FlushDiskType" class="headerlink" title="3.2 FlushDiskType"></a>3.2 FlushDiskType</h3><p>SYNC_FLUSH（同步刷新）相比于ASYNC_FLUSH（异步处理）会损失很多性能，但是也更可靠，所以需要根据实际的业务场景做好权衡。</p>
<h3 id="3-3-Broker-配置"><a href="#3-3-Broker-配置" class="headerlink" title="3.3 Broker 配置"></a>3.3 Broker 配置</h3><table>
<thead>
<tr>
<th>参数名</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>listenPort</td>
<td>10911</td>
<td>接受客户端连接的监听端口</td>
</tr>
<tr>
<td>namesrvAddr</td>
<td>null</td>
<td>nameServer 地址</td>
</tr>
<tr>
<td>brokerIP1</td>
<td>网卡的 InetAddress</td>
<td>当前 broker 监听的 IP</td>
</tr>
<tr>
<td>brokerIP2</td>
<td>跟 brokerIP1 一样</td>
<td>存在主从 broker 时，如果在 broker 主节点上配置了 brokerIP2 属性，broker 从节点会连接主节点配置的 brokerIP2 进行同步</td>
</tr>
<tr>
<td>brokerName</td>
<td>null</td>
<td>broker 的名称</td>
</tr>
<tr>
<td>brokerClusterName</td>
<td>DefaultCluster</td>
<td>本 broker 所属的 Cluser 名称</td>
</tr>
<tr>
<td>brokerId</td>
<td>0</td>
<td>broker id, 0 表示 master, 其他的正整数表示 slave</td>
</tr>
<tr>
<td>storePathRootDir</td>
<td>$HOME/store/</td>
<td>存储根路径</td>
</tr>
<tr>
<td>storePathCommitLog</td>
<td>$HOME/store/commitlog/</td>
<td>存储 commit log 的路径</td>
</tr>
<tr>
<td>mappedFileSizeCommitLog</td>
<td>1024 <em> 1024 </em> 1024(1G)</td>
<td>commit log 的映射文件大小</td>
</tr>
<tr>
<td>deleteWhen</td>
<td>04</td>
<td>在每天的什么时间删除已经超过文件保留时间的 commit log</td>
</tr>
<tr>
<td>fileReservedTime</td>
<td>72</td>
<td>以小时计算的文件保留时间</td>
</tr>
<tr>
<td>brokerRole</td>
<td>ASYNC_MASTER</td>
<td>SYNC_MASTER/ASYNC_MASTER/SLAVE</td>
</tr>
<tr>
<td>flushDiskType</td>
<td>ASYNC_FLUSH</td>
<td>SYNC_FLUSH/ASYNC_FLUSH SYNC_FLUSH 模式下的 broker 保证在收到确认生产者之前将消息刷盘。ASYNC_FLUSH 模式下的 broker 则利用刷盘一组消息的模式，可以取得更好的性能。</td>
</tr>
</tbody>
</table>
<h2 id="4-NameServer"><a href="#4-NameServer" class="headerlink" title="4  NameServer"></a>4  NameServer</h2><p>RocketMQ 中，Name Servers 被设计用来做简单的路由管理。其职责包括：</p>
<ul>
<li>Brokers 定期向每个名称服务器注册路由数据。</li>
<li>名称服务器为客户端，包括生产者，消费者和命令行客户端提供最新的路由信息。</li>
</ul>
<h2 id="5-客户端配置"><a href="#5-客户端配置" class="headerlink" title="5 客户端配置"></a>5 客户端配置</h2><p> 相对于RocketMQ的Broker集群，生产者和消费者都是客户端。本小节主要描述生产者和消费者公共的行为配置。</p>
<h3 id="5-1-客户端寻址方式"><a href="#5-1-客户端寻址方式" class="headerlink" title="5.1 客户端寻址方式"></a>5.1 客户端寻址方式</h3><p>RocketMQ可以令客户端找到Name Server, 然后通过Name Server再找到Broker。如下所示有多种配置方式，优先级由高到低，高优先级会覆盖低优先级。</p>
<ul>
<li>代码中指定Name Server地址，多个namesrv地址之间用分号分割   </li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">producer.setNamesrvAddr(<span class="string">"192.168.0.1:9876;192.168.0.2:9876"</span>);  </span><br><span class="line"></span><br><span class="line">consumer.setNamesrvAddr(<span class="string">"192.168.0.1:9876;192.168.0.2:9876"</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>Java启动参数中指定Name Server地址</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Drocketmq.namesrv.addr=192.168.0.1:9876;192.168.0.2:9876</span><br></pre></td></tr></table></figure>
<ul>
<li>环境变量指定Name Server地址</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export   NAMESRV_ADDR=192.168.0.1:9876;192.168.0.2:9876</span><br></pre></td></tr></table></figure>
<ul>
<li>HTTP静态服务器寻址（默认）</li>
</ul>
<p>客户端启动后，会定时访问一个静态HTTP服务器，地址如下：<a href="http://jmenv.tbsite.net:8080/rocketmq/nsaddr" target="_blank" rel="noopener">http://jmenv.tbsite.net:8080/rocketmq/nsaddr</a>，这个URL的返回内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">192.168.0.1:9876;192.168.0.2:9876</span><br></pre></td></tr></table></figure>
<p>客户端默认每隔2分钟访问一次这个HTTP服务器，并更新本地的Name Server地址。URL已经在代码中硬编码，可通过修改/etc/hosts文件来改变要访问的服务器，例如在/etc/hosts增加如下配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">10.232.22.67    jmenv.tbsite.net</span><br></pre></td></tr></table></figure></p>
<p>推荐使用HTTP静态服务器寻址方式，好处是客户端部署简单，且Name Server集群可以热升级。</p>
<h3 id="5-2-客户端配置"><a href="#5-2-客户端配置" class="headerlink" title="5.2 客户端配置"></a>5.2 客户端配置</h3><p>DefaultMQProducer、TransactionMQProducer、DefaultMQPushConsumer、DefaultMQPullConsumer都继承于ClientConfig类，ClientConfig为客户端的公共配置类。客户端的配置都是get、set形式，每个参数都可以用spring来配置，也可以在代码中配置，例如namesrvAddr这个参数可以这样配置，producer.setNamesrvAddr(“192.168.0.1:9876”)，其他参数同理。</p>
<h4 id="1-客户端的公共配置"><a href="#1-客户端的公共配置" class="headerlink" title="1  客户端的公共配置"></a>1  客户端的公共配置</h4><table>
<thead>
<tr>
<th>参数名</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>namesrvAddr</td>
<td></td>
<td>Name Server地址列表，多个NameServer地址用分号隔开</td>
</tr>
<tr>
<td>clientIP</td>
<td>本机IP</td>
<td>客户端本机IP地址，某些机器会发生无法识别客户端IP地址情况，需要应用在代码中强制指定</td>
</tr>
<tr>
<td>instanceName</td>
<td>DEFAULT</td>
<td>客户端实例名称，客户端创建的多个Producer、Consumer实际是共用一个内部实例（这个实例包含网络连接、线程资源等）</td>
</tr>
<tr>
<td>clientCallbackExecutorThreads</td>
<td>4</td>
<td>通信层异步回调线程数</td>
</tr>
<tr>
<td>pollNameServerInteval</td>
<td>30000</td>
<td>轮询Name Server间隔时间，单位毫秒</td>
</tr>
<tr>
<td>heartbeatBrokerInterval</td>
<td>30000</td>
<td>向Broker发送心跳间隔时间，单位毫秒</td>
</tr>
<tr>
<td>persistConsumerOffsetInterval</td>
<td>5000</td>
<td>持久化Consumer消费进度间隔时间，单位毫秒</td>
</tr>
</tbody>
</table>
<h4 id="2-Producer配置"><a href="#2-Producer配置" class="headerlink" title="2  Producer配置"></a>2  Producer配置</h4><table>
<thead>
<tr>
<th>参数名</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>producerGroup</td>
<td>DEFAULT_PRODUCER</td>
<td>Producer组名，多个Producer如果属于一个应用，发送同样的消息，则应该将它们归为同一组</td>
</tr>
<tr>
<td>createTopicKey</td>
<td>TBW102</td>
<td>在发送消息时，自动创建服务器不存在的topic，需要指定Key，该Key可用于配置发送消息所在topic的默认路由。</td>
</tr>
<tr>
<td>defaultTopicQueueNums</td>
<td>4</td>
<td>在发送消息，自动创建服务器不存在的topic时，默认创建的队列数</td>
</tr>
<tr>
<td>sendMsgTimeout</td>
<td>3000</td>
<td>发送消息超时时间，单位毫秒</td>
</tr>
<tr>
<td>compressMsgBodyOverHowmuch</td>
<td>4096</td>
<td>消息Body超过多大开始压缩（Consumer收到消息会自动解压缩），单位字节</td>
</tr>
<tr>
<td>retryAnotherBrokerWhenNotStoreOK</td>
<td>FALSE</td>
<td>如果发送消息返回sendResult，但是sendStatus!=SEND_OK，是否重试发送</td>
</tr>
<tr>
<td>retryTimesWhenSendFailed</td>
<td>2</td>
<td>如果消息发送失败，最大重试次数，该参数只对同步发送模式起作用</td>
</tr>
<tr>
<td>maxMessageSize</td>
<td>4MB</td>
<td>客户端限制的消息大小，超过报错，同时服务端也会限制，所以需要跟服务端配合使用。</td>
</tr>
<tr>
<td>transactionCheckListener</td>
<td></td>
<td>事务消息回查监听器，如果发送事务消息，必须设置</td>
</tr>
<tr>
<td>checkThreadPoolMinSize</td>
<td>1</td>
<td>Broker回查Producer事务状态时，线程池最小线程数</td>
</tr>
<tr>
<td>checkThreadPoolMaxSize</td>
<td>1</td>
<td>Broker回查Producer事务状态时，线程池最大线程数</td>
</tr>
<tr>
<td>checkRequestHoldMax</td>
<td>2000</td>
<td>Broker回查Producer事务状态时，Producer本地缓冲请求队列大小</td>
</tr>
<tr>
<td>RPCHook</td>
<td>null</td>
<td>该参数是在Producer创建时传入的，包含消息发送前的预处理和消息响应后的处理两个接口，用户可以在第一个接口中做一些安全控制或者其他操作。</td>
</tr>
</tbody>
</table>
<h4 id="3-PushConsumer配置"><a href="#3-PushConsumer配置" class="headerlink" title="3  PushConsumer配置"></a>3  PushConsumer配置</h4><table>
<thead>
<tr>
<th>参数名</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>consumerGroup</td>
<td>DEFAULT_CONSUMER</td>
<td>Consumer组名，多个Consumer如果属于一个应用，订阅同样的消息，且消费逻辑一致，则应该将它们归为同一组</td>
</tr>
<tr>
<td>messageModel</td>
<td>CLUSTERING</td>
<td>消费模型支持集群消费和广播消费两种</td>
</tr>
<tr>
<td>consumeFromWhere</td>
<td>CONSUME_FROM_LAST_OFFSET</td>
<td>Consumer启动后，默认从上次消费的位置开始消费，这包含两种情况：一种是上次消费的位置未过期，则消费从上次中止的位置进行；一种是上次消费位置已经过期，则从当前队列第一条消息开始消费</td>
</tr>
<tr>
<td>consumeTimestamp</td>
<td>半个小时前</td>
<td>只有当consumeFromWhere值为CONSUME_FROM_TIMESTAMP时才起作用。</td>
</tr>
<tr>
<td>allocateMessageQueueStrategy</td>
<td>AllocateMessageQueueAveragely</td>
<td>Rebalance算法实现策略</td>
</tr>
<tr>
<td>subscription</td>
<td></td>
<td>订阅关系</td>
</tr>
<tr>
<td>messageListener</td>
<td></td>
<td>消息监听器</td>
</tr>
<tr>
<td>offsetStore</td>
<td></td>
<td>消费进度存储</td>
</tr>
<tr>
<td>consumeThreadMin</td>
<td>20</td>
<td>消费线程池最小线程数</td>
</tr>
<tr>
<td>consumeThreadMax</td>
<td>20</td>
<td>消费线程池最大线程数</td>
</tr>
<tr>
<td>consumeConcurrentlyMaxSpan</td>
<td>2000</td>
<td>单队列并行消费允许的最大跨度</td>
</tr>
<tr>
<td>pullThresholdForQueue</td>
<td>1000</td>
<td>拉消息本地队列缓存消息最大数</td>
</tr>
<tr>
<td>pullInterval</td>
<td>0</td>
<td>拉消息间隔，由于是长轮询，所以为0，但是如果应用为了流控，也可以设置大于0的值，单位毫秒</td>
</tr>
<tr>
<td>consumeMessageBatchMaxSize</td>
<td>1</td>
<td>批量消费，一次消费多少条消息</td>
</tr>
<tr>
<td>pullBatchSize</td>
<td>32</td>
<td>批量拉消息，一次最多拉多少条</td>
</tr>
</tbody>
</table>
<h4 id="4-PullConsumer配置"><a href="#4-PullConsumer配置" class="headerlink" title="4  PullConsumer配置"></a>4  PullConsumer配置</h4><table>
<thead>
<tr>
<th>参数名</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>consumerGroup</td>
<td>DEFAULT_CONSUMER</td>
<td>Consumer组名，多个Consumer如果属于一个应用，订阅同样的消息，且消费逻辑一致，则应该将它们归为同一组</td>
</tr>
<tr>
<td>brokerSuspendMaxTimeMillis</td>
<td>20000</td>
<td>长轮询，Consumer拉消息请求在Broker挂起最长时间，单位毫秒</td>
</tr>
<tr>
<td>consumerTimeoutMillisWhenSuspend</td>
<td>30000</td>
<td>长轮询，Consumer拉消息请求在Broker挂起超过指定时间，客户端认为超时，单位毫秒</td>
</tr>
<tr>
<td>consumerPullTimeoutMillis</td>
<td>10000</td>
<td>非长轮询，拉消息超时时间，单位毫秒</td>
</tr>
<tr>
<td>messageModel</td>
<td>BROADCASTING</td>
<td>消息支持两种模式：集群消费和广播消费</td>
</tr>
<tr>
<td>messageQueueListener</td>
<td></td>
<td>监听队列变化</td>
</tr>
<tr>
<td>offsetStore</td>
<td></td>
<td>消费进度存储</td>
</tr>
<tr>
<td>registerTopics</td>
<td></td>
<td>注册的topic集合</td>
</tr>
<tr>
<td>allocateMessageQueueStrategy</td>
<td>AllocateMessageQueueAveragely</td>
<td>Rebalance算法实现策略</td>
</tr>
</tbody>
</table>
<h4 id="5-Message数据结构"><a href="#5-Message数据结构" class="headerlink" title="5  Message数据结构"></a>5  Message数据结构</h4><table>
<thead>
<tr>
<th>字段名</th>
<th>默认值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>Topic</td>
<td>null</td>
<td>必填，消息所属topic的名称</td>
</tr>
<tr>
<td>Body</td>
<td>null</td>
<td>必填，消息体</td>
</tr>
<tr>
<td>Tags</td>
<td>null</td>
<td>选填，消息标签，方便服务器过滤使用。目前只支持每个消息设置一个tag</td>
</tr>
<tr>
<td>Keys</td>
<td>null</td>
<td>选填，代表这条消息的业务关键词，服务器会根据keys创建哈希索引，设置后，可以在Console系统根据Topic、Keys来查询消息，由于是哈希索引，请尽可能保证key唯一，例如订单号，商品Id等。</td>
</tr>
<tr>
<td>Flag</td>
<td>0</td>
<td>选填，完全由应用来设置，RocketMQ不做干预</td>
</tr>
<tr>
<td>DelayTimeLevel</td>
<td>0</td>
<td>选填，消息延时级别，0表示不延时，大于0会延时特定的时间才会被消费</td>
</tr>
<tr>
<td>WaitStoreMsgOK</td>
<td>TRUE</td>
<td>选填，表示消息是否在服务器落盘后才返回应答。</td>
</tr>
</tbody>
</table>
<h2 id="6-系统配置"><a href="#6-系统配置" class="headerlink" title="6  系统配置"></a>6  系统配置</h2><p>本小节主要介绍系统（JVM/OS）相关的配置。</p>
<h3 id="6-1-JVM选项"><a href="#6-1-JVM选项" class="headerlink" title="6.1 JVM选项"></a>6.1 JVM选项</h3><p>推荐使用最新发布的JDK 1.8版本。通过设置相同的Xms和Xmx值来防止JVM调整堆大小以获得更好的性能。简单的JVM配置如下所示：</p>
<figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">-<span class="keyword">server</span> -Xms8g -Xmx8g -Xmn4g</span><br></pre></td></tr></table></figure>
<p>如果您不关心RocketMQ Broker的启动时间，还有一种更好的选择，就是通过“预触摸”Java堆以确保在JVM初始化期间每个页面都将被分配。那些不关心启动时间的人可以启用它：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">-XX</span><span class="selector-pseudo">:+AlwaysPreTouch</span></span><br></pre></td></tr></table></figure></p>
<p>禁用偏置锁定可能会减少JVM暂停，<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">-XX</span><span class="selector-pseudo">:-UseBiasedLocking</span></span><br></pre></td></tr></table></figure></p>
<p>至于垃圾回收，建议使用带JDK 1.8的G1收集器。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-XX:+UseG1GC -XX:G1HeapRegionSize=16m   </span><br><span class="line">-XX:G1ReservePercent=25 </span><br><span class="line">-XX:InitiatingHeapOccupancyPercent=30</span><br></pre></td></tr></table></figure>
<p>这些GC选项看起来有点激进，但事实证明它在我们的生产环境中具有良好的性能。另外不要把-XX:MaxGCPauseMillis的值设置太小，否则JVM将使用一个小的年轻代来实现这个目标，这将导致非常频繁的minor GC，所以建议使用rolling GC日志文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-XX:+UseGCLogFileRotation   </span><br><span class="line">-XX:NumberOfGCLogFiles=5 </span><br><span class="line">-XX:GCLogFileSize=30m</span><br></pre></td></tr></table></figure>
<p>如果写入GC文件会增加代理的延迟，可以考虑将GC日志文件重定向到内存文件系统：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Xloggc:/dev/shm/mq_gc_%p.log123</span><br></pre></td></tr></table></figure>
<h3 id="6-2-Linux内核参数"><a href="#6-2-Linux内核参数" class="headerlink" title="6.2 Linux内核参数"></a>6.2 Linux内核参数</h3><p>os.sh脚本在bin文件夹中列出了许多内核参数，可以进行微小的更改然后用于生产用途。下面的参数需要注意，更多细节请参考/proc/sys/vm/*的<a href="https://www.kernel.org/doc/Documentation/sysctl/vm.txt" target="_blank" rel="noopener">文档</a></p>
<ul>
<li><strong>vm.extra_free_kbytes</strong>，告诉VM在后台回收（kswapd）启动的阈值与直接回收（通过分配进程）的阈值之间保留额外的可用内存。RocketMQ使用此参数来避免内存分配中的长延迟。（与具体内核版本相关）</li>
<li><strong>vm.min_free_kbytes</strong>，如果将其设置为低于1024KB，将会巧妙的将系统破坏，并且系统在高负载下容易出现死锁。</li>
<li><strong>vm.max_map_count</strong>，限制一个进程可能具有的最大内存映射区域数。RocketMQ将使用mmap加载CommitLog和ConsumeQueue，因此建议将为此参数设置较大的值。（agressiveness –&gt; aggressiveness）</li>
<li><strong>vm.swappiness</strong>，定义内核交换内存页面的积极程度。较高的值会增加攻击性，较低的值会减少交换量。建议将值设置为10来避免交换延迟。</li>
<li><strong>File descriptor limits</strong>，RocketMQ需要为文件（CommitLog和ConsumeQueue）和网络连接打开文件描述符。我们建议设置文件描述符的值为655350。</li>
<li><a href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Performance_Tuning_Guide/ch06s04s02.html" target="_blank" rel="noopener">Disk scheduler</a>，RocketMQ建议使用I/O截止时间调度器，它试图为请求提供有保证的延迟。<br><a href="[]("></a>)</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dinghuang.github.io/2022/01/14/分布式系统认证方案/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="强壮的病猫">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/dinghuang.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一只病猫">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2022/01/14/分布式系统认证方案/" itemprop="url">分布式系统认证方案</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2022-01-14T15:47:00+08:00">
                2022-01-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JAVA/" itemprop="url" rel="index">
                    <span itemprop="name">JAVA</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2022/01/14/分布式系统认证方案/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2022/01/14/分布式系统认证方案/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <h1 id="分布式系统认证方案"><a href="#分布式系统认证方案" class="headerlink" title="分布式系统认证方案"></a>分布式系统认证方案</h1><p>需要满足以下需求</p>
<ul>
<li>统一认证授权：不同客户端均采用一致的认证、授权、会话判断机制，实现统一认证授权服务。</li>
<li>多样的认证场景：支持用户名密码、短信验证码、二维码、人脸识别等各种认证方式，并可以灵活的切换和扩展。</li>
<li>应用接入认证：，提供安全的系统对接机制，并可开放部分<code>API</code>给第三方使用。并且内部服务和外部第三方服务均采用统一的接入机制。</li>
</ul>
<h2 id="分布式认证方案"><a href="#分布式认证方案" class="headerlink" title="分布式认证方案"></a>分布式认证方案</h2><h3 id="基于Session的认证方式"><a href="#基于Session的认证方式" class="headerlink" title="基于Session的认证方式"></a>基于Session的认证方式</h3><h4 id="session复制"><a href="#session复制" class="headerlink" title="session复制"></a>session复制</h4><p>将服务器A的<code>session</code>，复制到服务器B，同样将服务器B的<code>session</code>也复制到服务器A，这样两台服务器的<code>session</code>就一致了。像<code>tomcat</code>等<code>web</code>容器都支持<code>session</code>复制的功能，在同一个局域网内，一台服务器的<code>session</code>会广播给其他服务器。</p>
<p><strong>缺点</strong>：同一个网段内服务器太多，每个服务器都会去复制<code>session</code>，会造成服务器内存浪费。</p>
<p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/common/32ddf89eaf8116e96578b34174cb8d4d.png" alt="image"></p>
<h4 id="session黏性"><a href="#session黏性" class="headerlink" title="session黏性"></a>session黏性</h4><p>利用<code>Nginx</code>服务器的反向代理，将服务器A和服务器B进行代理，然后采用<code>ip_hash</code>的负载策略，将客户端和服务器进行绑定，也就是说客户端A第一次访问的是服务器B，那么第二次访问也必然是服务器B，这样就不存在<code>session</code>不一致的问题了。</p>
<p><strong>缺点</strong>：如果服务器A宕机了，那么客户端A和客户端B的<code>session</code>就会出现丢失。<br><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/common/1ee1b2b5126e2c273b8b6f4df1d27881.png" alt="image"></p>
<h4 id="session集中管理"><a href="#session集中管理" class="headerlink" title="session集中管理"></a>session集中管理</h4><p>这种方式就是将所有服务器的<code>session</code>进行统一管理，可以使用<code>v</code>等高性能服务器来集中管理<code>session</code>，而且<code>spring</code>官方提供的<code>spirng-session</code>就是这样处理<code>session</code>的一致性问题。这也是目前企业开发用到的比较多的一种分布式<code>session</code>解决方案。</p>
<h3 id="基于Token的认证方式"><a href="#基于Token的认证方式" class="headerlink" title="基于Token的认证方式"></a>基于Token的认证方式</h3><p>基于<code>token</code>的认证方式，服务端不用存储认证数据，易维护扩展性强， 客户端可以把<code>token</code>存在任意地方，并且可以实现<code>web</code>和<code>app</code>统一认证机制。<br><code>token</code>认证方式对第三方应用接入更适合，因为它更开放，可使用当前有流行的开放协议<code>Oauth2.0</code>、<code>JWT</code>等。一般情况服务端无需存储会话信息，减轻了服务端的压力。</p>
<p><code>缺点</code>：<code>token</code>由于自包含信息，因此一般数据量较大，而且每次请求<br>都需要传递，因此比较占带宽。另外，<code>token</code>的签名验签操作也会给<code>cpu</code>带来额外的处理负担。</p>
<p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/common/20200427151958303.png" alt="image"></p>
<h4 id="验证流程"><a href="#验证流程" class="headerlink" title="验证流程"></a>验证流程</h4><p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/common/20200427152702654.png" alt="image"><br>1  用户通过接入方（应用）登录，接入方采取<code>OAuth2.0</code>方式在统一认证服务(<code>oauth-service</code>)中认证。</p>
<p>2 认证服务调用验证该用户的身份是否合法，并获取用户权限信息。</p>
<p>3 认证服务获取接入方权限信息，并验证接入方是否合法。</p>
<p>4 若登录用户以及接入方都合法，认证服务生成<code>jwt</code>令牌返回给接入方，其中<code>jwt</code>中包含了用户权限及接入方权限。</p>
<p>5 后续，接入方携带<code>jwt</code>令牌对<code>API</code>网关内的微服务资源进行访问。</p>
<p>6 <code>API</code>网关对令牌解析、并验证接入方的权限是否能够访问本次请求的微服务。</p>
<p>7 如果接入方的权限没问题，<code>API</code>网关将原请求<code>header</code>中附加解析后的明文<code>Token</code>，并将请求转发至微服务。</p>
<p>8 微服务收到请求，明文<code>token</code>中包含登录用户的身份和权限信息。因此后续微服务自己可以干两件事：</p>
<ul>
<li>用户授权拦截（看当前用户是否有权访问该资源）</li>
<li>将用户信息存储进当前线程上下文（有利于后续业务逻辑随时<br>获取当前用户信息）</li>
</ul>
<h4 id="OAuth2-0"><a href="#OAuth2-0" class="headerlink" title="OAuth2.0"></a>OAuth2.0</h4><p><code>OAuth</code>（开放授权）是一个开放标准，允许用户授权第三方移动应用访问他们存储在另外的服务提供者上的信息，而不需要将用户名和密码提供给第三方移动应用或分享他们数据的所有内容。<code>OAuth2.0</code>是<code>OAuth</code>协议的延续版本，但不向后兼容<code>OAuth1.0</code>即完全废止了<code>OAuth1.0</code>。</p>
<p><code>OAuth2</code>中的四种认证授权模式</p>
<ul>
<li>授权码模式（<code>authorization code</code>）</li>
<li>简化模式/隐式授权模式（<code>implicit</code>）</li>
<li>密码模式（<code>password</code>）</li>
<li>客户端模式（<code>client credentials</code>）</li>
</ul>
<p><code>OAuth2.0</code>包括以下角色</p>
<ul>
<li>客户端:本身不存储资源，需要通过资源拥有者的授权去请求资源服务器的资源，比如:<code>Android</code>客户端、<code>Web</code>客户端（浏览器端）、微信客户端等。</li>
<li>资源拥有者:通常为用户，也可以是应用程序，即该资源的拥有者。</li>
<li>授权服务器（认证服务器）:用于服务提供商对资源拥有的身份进行认证、对访问资源进行授权，认证成功后会给客户端发放令牌（<code>access_token</code>），作为客户端访问资源服务器的凭据。</li>
<li>资源服务器: 存储资源的服务器。</li>
</ul>
<h5 id="JWT-token"><a href="#JWT-token" class="headerlink" title="JWT token"></a>JWT token</h5><p><code>JWT</code>的全称是<code>JSON Web Tokens</code>，它由下面2部分组成：</p>
<ul>
<li><code>Authorization</code> (授权) : 这是使用<code>JWT</code>的最常见场景。一旦用户登录，后续每个请求都将包含<code>JWT</code>，允许用户访问该令牌允许的路由、服务和资源。单点登录是现在广泛使用的<code>JWT</code>的一个特性，因为它的开销很小，并且可以轻松地跨域使用。</li>
<li><code>Information Exchange</code> (信息交换) : <code>JWT</code>可以被签名，例如，用公钥/私钥对，可以验证内容没有被篡改。</li>
</ul>
<p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/common/874963-20180709124807031-664967381.png" alt="image"></p>
<ul>
<li><code>Header</code>：<code>token</code>的类型（<code>JWT</code>）和算法名称（比如：<code>HMAC SHA256</code>或者<code>RSA</code>等等）</li>
<li><code>Payload</code>：<code>JWT</code>的第二部分是<code>payload</code>，它包含声明（要求）。声明是关于实体(通常是用户)和其他数据的声明。声明有三种类型: <code>registered</code>, <code>public</code> 和 <code>private</code>。</li>
<li><code>Signature</code>：签名是用于验证消息在传递过程中有没有被更改，并且，对于使用私钥签名的<code>token</code>，它还可以验证JWT的发送方是否为它所称的发送方。</li>
</ul>
<blockquote>
<p>注意，不要在<code>JWT</code>的<code>payload</code>或<code>header</code>中放置敏感信息，除非它们是加密的</p>
</blockquote>
<h5 id="授权码模式"><a href="#授权码模式" class="headerlink" title="授权码模式"></a>授权码模式</h5><p><strong>举例：小米账户授权</strong><br><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/common/%E5%B0%8F%E7%B1%B3%E6%8E%88%E6%9D%83%E6%B5%81%E7%A8%8B.png" alt="image"><br><code>Authorization Code</code>授权分为两步，首先获取<code>Authorization Code</code>，然后用<code>Code</code>换取<code>Access Token</code>。其流程示意图如下<br><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/common/AuthorizationCode%E4%BA%A4%E4%BA%92%E6%B5%81%E7%A8%8B.png" alt="image"></p>
<p>一般会有下面的注意事项：</p>
<ul>
<li><code>Authorization Code</code>只能使用一次，不可重复使用</li>
<li><code>Authorization Code</code>有效时间为5分钟, 在返回<code>Authorization Code</code>5分钟之后失效</li>
</ul>
<h5 id="简化模式"><a href="#简化模式" class="headerlink" title="简化模式"></a>简化模式</h5><p>简化模式相对于授权码模式，少了获取<code>code</code>以及用<code>code</code>换<code>token</code>这一步，用户授权后，认证服务器直接返回一个<code>token</code>。</p>
<h5 id="密码模式"><a href="#密码模式" class="headerlink" title="密码模式"></a>密码模式</h5><p>这个模式流程简单，但很不安全，一般用在强信任的两个系统。</p>
<h5 id="客户端模式"><a href="#客户端模式" class="headerlink" title="客户端模式"></a>客户端模式</h5><p>分配一个账号密码，每一个账户密码资源服务器会对允许请求的资源做权限控制。可以用这个账号密码来获取<code>token</code>，通过这个<code>token</code>去获取资源服务器允许你请求的资源，之所以使用<code>token</code>而不直接使用账户密码还是为了安全考虑，<code>token</code>有过期机制，过期后需要使用账户密码重新获取<code>token</code>，很多时候这个重新获取的业务场景被称为签到。</p>
<blockquote>
<p>认证服务器会给准入的接入方一个身份，用于接入时的凭据:<br><code>client_id</code>：客户端标识，<code>client_secret</code>：客户端秘钥<br>因此，准确来说，授权服务器对两种<code>OAuth2.0</code>中的两个角色进行认证授权，分别是资源拥有者、客户端。</p>
</blockquote>
<h2 id="Spring-Security-OAuth2"><a href="#Spring-Security-OAuth2" class="headerlink" title="Spring-Security-OAuth2"></a>Spring-Security-OAuth2</h2><p><code>Spring-Security-OAuth2</code>是对<code>OAuth2</code>的一种实现，<code>OAuth2.0</code>的服务提供方涵盖两个服务，即授权服务 (<code>Authorization Server</code>，也叫认证服务) 和资源服务 (<code>Resource Server</code>)，使用 <code>Spring Security OAuth2</code> 的时候你可以选择把它们在同一个应用程序中实现，也可以选择建立使用同一个授权服务的多个资源服务。</p>
<h3 id="SpringSecurity-过滤器"><a href="#SpringSecurity-过滤器" class="headerlink" title="SpringSecurity 过滤器"></a>SpringSecurity 过滤器</h3><p>两个至关重要的类：<code>OncePerRequestFilter</code>和<code>GenericFilterBean</code>，在过滤器链的过滤器中，或多或少间接或直接继承到</p>
<ul>
<li><code>OncePerRequestFilter</code>顾名思义，能够确保在一次请求只通过一次<code>filter</code>，而不需要重复执行。</li>
<li><p><code>GenericFilterBean</code>是<code>javax.servlet.Filter</code>接口的一个基本的实现类</p>
<ul>
<li><code>GenericFilterBean</code>将<code>web.xml</code>中<code>filter</code>标签中的配置参数<code>-init-param</code>项作为<code>bean</code>的属性</li>
<li><code>GenericFilterBean</code>可以简单地成为任何类型的<code>filter</code>的父类</li>
<li><code>GenericFilterBean</code>的子类可以自定义一些自己需要的属性</li>
<li><code>GenericFilterBean</code>，将实际的过滤工作留给他的子类来完成，这就导致了他的子类不得不实现<code>doFilter</code>方法</li>
<li><code>GenericFilterBean</code>不依赖于<code>Spring</code>的<code>ApplicationContext</code>，<code>Filters</code>通常不会直接读取他们的容器信息（<code>ApplicationContext concept</code>）而是通过访问<code>spring</code>容器（<code>Spring root application context</code>）中的<code>service beans</code>来获取，通常是通过调用<code>filter</code>里面的<code>getServletContext()</code> 方法来获取<h4 id="WebAsyncManagerIntegrationFilter"><a href="#WebAsyncManagerIntegrationFilter" class="headerlink" title="WebAsyncManagerIntegrationFilter"></a>WebAsyncManagerIntegrationFilter</h4></li>
</ul>
</li>
<li><p>根据请求封装获取<code>WebAsyncManager</code></p>
</li>
<li>从<code>WebAsyncManager</code>获取/注册<code>SecurityContextCallableProcessingInterceptor</code></li>
</ul>
<h4 id="SecurityContextPersistenceFilter"><a href="#SecurityContextPersistenceFilter" class="headerlink" title="SecurityContextPersistenceFilter"></a>SecurityContextPersistenceFilter</h4><ul>
<li>先实例<code>SecurityContextHolder</code>-&gt;<code>HttpSessionSecurityContextRepository</code>（下面以<code>repo</code>代替）.作用：其会从<code>Session</code>中取出已认证用户的信息,提高效率,避免每一次请求都要查询用户认证信息。</li>
<li>根据请求和响应构建<code>HttpRequestResponseHolder</code></li>
<li><code>repo</code>根据<code>HttpRequestResponseHolder</code>加载<code>context</code>获取<code>SecurityContext</code></li>
<li><code>SecurityContextHolder</code>将获得到的<code>SecurityContext</code>设置到<code>Context</code>中，然后继续向下执行其他过滤器</li>
<li><code>finally</code>-&gt; <code>SecurityContextHolder</code>获取<code>SecurityContext</code>，然后清除，并将其和请求信息保存到<code>repo</code>，从请求中移除<code>FILTER_APPLIED</code>属性</li>
</ul>
<h4 id="HeaderWriterFilter"><a href="#HeaderWriterFilter" class="headerlink" title="HeaderWriterFilter"></a>HeaderWriterFilter</h4><ul>
<li>往该请求的<code>Header</code>中添加相应的信息,在<code>http</code>标签内部使用<code>security</code>:<code>headers</code>来控制</li>
</ul>
<h4 id="CsrfFilter"><a href="#CsrfFilter" class="headerlink" title="CsrfFilter"></a>CsrfFilter</h4><ul>
<li><code>csrf</code>又称跨域请求伪造，攻击方通过伪造用户请求访问受信任站点。</li>
<li>对需要验证的请求验证是否包含<code>csrf</code>的<code>token</code>信息，如果不包含，则报错。这样攻击网站无法获取到<code>token</code>信息，则跨域提交的信息都无法通过过滤器的校验。</li>
</ul>
<h4 id="LogoutFilter"><a href="#LogoutFilter" class="headerlink" title="LogoutFilter"></a>LogoutFilter</h4><ul>
<li>匹配<code>URL</code>,默认为<code>/logout</code></li>
<li>匹配成功后则用户退出,清除认证信息</li>
</ul>
<h4 id="RequestCacheAwareFilter"><a href="#RequestCacheAwareFilter" class="headerlink" title="RequestCacheAwareFilter"></a>RequestCacheAwareFilter</h4><ul>
<li>通过<code>HttpSessionRequestCache</code>内部维护了一个<code>RequestCache</code>，用于缓存<code>HttpServletRequest</code></li>
</ul>
<h4 id="SecurityContextHolderAwareRequestFilter"><a href="#SecurityContextHolderAwareRequestFilter" class="headerlink" title="SecurityContextHolderAwareRequestFilter"></a>SecurityContextHolderAwareRequestFilter</h4><ul>
<li>针对<code>ServletRequest</code>进行了一次包装，使得<code>request</code>具有更加丰富的<code>API</code></li>
</ul>
<h4 id="AnonymousAuthenticationFilter"><a href="#AnonymousAuthenticationFilter" class="headerlink" title="AnonymousAuthenticationFilter"></a>AnonymousAuthenticationFilter</h4><ul>
<li>当<code>SecurityContextHolder</code>中认证信息为空,则会创建一个匿名用户存入到<code>SecurityContextHolder</code>中。匿名身份过滤器，这个过滤器很重要，需要将它与<code>UsernamePasswordAuthenticationFilter</code> 放在一起比较理解，<code>spring security</code>为了兼容未登录的访问，也走了一套认证流程，只不过是一个匿名的身份。</li>
<li>匿名认证过滤器是<code>Spirng Security</code>为了整体逻辑的统一性，即使是未通过认证的用户，也给予了一个匿名身份。而<code>AnonymousAuthenticationFilter</code>该过滤器的位置也是非常的科学的，它位于常用的身份认证过滤器（如<code>UsernamePasswordAuthenticationFilter</code>、<code>BasicAuthenticationFilter</code>、<code>RememberMeAuthenticationFilter</code>）之后，意味着只有在上述身份过滤器执行完毕后，<code>SecurityContext</code>依旧没有用户信息，<code>AnonymousAuthenticationFilte</code>该过滤器才会有意义—-基于用户一个匿名身份。</li>
</ul>
<h4 id="SessionManagementFilter"><a href="#SessionManagementFilter" class="headerlink" title="SessionManagementFilter"></a>SessionManagementFilter</h4><ul>
<li><code>securityContextRepository</code>限制同一用户开启多个会话的数量</li>
<li><code>SessionAuthenticationStrategy</code>防止<code>session-fixation protection attack</code>（保护非匿名用户）</li>
</ul>
<h4 id="ExceptionTranslationFilter"><a href="#ExceptionTranslationFilter" class="headerlink" title="ExceptionTranslationFilter"></a>ExceptionTranslationFilter</h4><ul>
<li><code>ExceptionTranslationFilter</code>异常转换过滤器位于整个<code>springSecurityFilterChain</code>的后方，用来转换整个链路中出现的异常</li>
<li>此过滤器的作用是处理中<code>FilterSecurityInterceptor</code>抛出的异常，然后将请求重定向到对应页面，或返回对应的响应错误代码</li>
</ul>
<h4 id="FilterSecurityInterceptor"><a href="#FilterSecurityInterceptor" class="headerlink" title="FilterSecurityInterceptor"></a>FilterSecurityInterceptor</h4><ul>
<li>获取到所配置资源访问的授权信息</li>
<li>根据<code>SecurityContextHolder</code>中存储的用户信息来决定其是否有权限</li>
<li>主要一些实现功能在其父类<code>AbstractSecurityInterceptor</code>中</li>
</ul>
<h4 id="UsernamePasswordAuthenticationFilter"><a href="#UsernamePasswordAuthenticationFilter" class="headerlink" title="UsernamePasswordAuthenticationFilter"></a>UsernamePasswordAuthenticationFilter</h4><ul>
<li>表单认证是最常用的一个认证方式，一个最直观的业务场景便是允许用户在表单中输入用户名和密码进行登录，而这背后的<code>UsernamePasswordAuthenticationFilter</code>，在整个<code>Spring Security</code>的认证体系中则扮演着至关重要的角色</li>
</ul>
<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p><code>pom.xml</code><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-freemarker<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.data<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-data-commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-oauth2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>授权服务器配置:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAuthorizationServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthorizationServer</span> <span class="keyword">extends</span> <span class="title">AuthorizationServerConfigurerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TokenStore tokenStore;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ClientDetailsService clientDetailsService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AuthorizationCodeServices authorizationCodeServices;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AuthenticationManager authenticationManager;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//令牌访问端点</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthorizationServerEndpointsConfigurer endpoints)</span> </span>&#123;</span><br><span class="line">        endpoints</span><br><span class="line">                .authenticationManager(authenticationManager)</span><br><span class="line">                .authorizationCodeServices(authorizationCodeServices)</span><br><span class="line">                .tokenServices(tokenService())</span><br><span class="line">                .allowedTokenEndpointRequestMethods(HttpMethod.POST);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//注意这个部分,到时候和请求链接的参数比对</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(ClientDetailsServiceConfigurer clients)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        clients.inMemory() <span class="comment">//用内存存储</span></span><br><span class="line">                .withClient(<span class="string">"c1"</span>)</span><br><span class="line">                .secret(<span class="keyword">new</span> BCryptPasswordEncoder().encode(<span class="string">"secret"</span>)) <span class="comment">//客户端密钥</span></span><br><span class="line">                .resourceIds(<span class="string">"res1"</span>)  <span class="comment">//资源列表</span></span><br><span class="line">                .authorizedGrantTypes(<span class="string">"authorization_code"</span>, <span class="string">"password"</span>, <span class="string">"client_credentials"</span>, <span class="string">"refresh_token"</span>)</span><br><span class="line">                .scopes(<span class="string">"all"</span>)<span class="comment">//允许授权范围</span></span><br><span class="line">                .autoApprove(<span class="keyword">false</span>)</span><br><span class="line">                .redirectUris(<span class="string">"http://www.baidu.com"</span>); <span class="comment">//验证回调地址</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//令牌管理服务</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AuthorizationServerTokenServices <span class="title">tokenService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        DefaultTokenServices service = <span class="keyword">new</span> DefaultTokenServices();</span><br><span class="line">        service.setClientDetailsService(clientDetailsService); <span class="comment">//客户端服务信息</span></span><br><span class="line">        service.setSupportRefreshToken(<span class="keyword">true</span>); <span class="comment">// 是否产生刷新令牌</span></span><br><span class="line">        service.setTokenStore(tokenStore); <span class="comment">//令牌存储策略</span></span><br><span class="line">        service.setAccessTokenValiditySeconds(<span class="number">7200</span>);<span class="comment">// 令牌默认有效期2小时</span></span><br><span class="line">        service.setRefreshTokenValiditySeconds(<span class="number">259200</span>);<span class="comment">// 刷新令牌默认有效期3天</span></span><br><span class="line">        <span class="keyword">return</span> service;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 令牌访问端点安全策略</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthorizationServerSecurityConfigurer security)</span> </span>&#123;</span><br><span class="line">        security</span><br><span class="line">                .tokenKeyAccess(<span class="string">"permitAll()"</span>)  <span class="comment">//oauth2/token_key</span></span><br><span class="line">                .checkTokenAccess(<span class="string">"permitAll()"</span>) <span class="comment">//oauth/check_key</span></span><br><span class="line">                .allowFormAuthenticationForClients(); <span class="comment">// 表单认证 (申请令牌)</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AuthorizationCodeServices <span class="title">authorizationCodeServices</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//设置授权码模式的授权码如何 存取，暂时采用内存方式</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> InMemoryAuthorizationCodeServices();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果要用数据库就在这个<code>UserDetailsService</code>编码<br><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomUserDetailsService</span> <span class="keyword"><span class="keyword">implements</span> <span class="type">UserDetailsService</span></span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    <span class="keyword">public</span> UserDetails loadUserByUsername(<span class="keyword">String</span> login) throws UsernameNotFoundException &#123;</span><br><span class="line">        <span class="comment">// 1. 查询用户 数据库查出角色权限</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 设置角色</span></span><br><span class="line">        Collection&lt;GrantedAuthority&gt; grantedAuthorities = <span class="keyword">new</span> <span class="type">ArrayList</span>&lt;&gt;();</span><br><span class="line">        GrantedAuthority grantedAuthority;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"admin"</span>.equals(login)) &#123;</span><br><span class="line">            grantedAuthority = <span class="keyword">new</span> <span class="type">SimpleGrantedAuthority</span>(<span class="string">"ADMIN"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            grantedAuthority = <span class="keyword">new</span> <span class="type">SimpleGrantedAuthority</span>(<span class="string">"USER"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        grantedAuthorities.add(grantedAuthority);</span><br><span class="line">        <span class="comment">//写死 用户密码123以及角色 USER 查出来的密码和比对的加密算法要传入进去</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="type">User</span>(login,</span><br><span class="line">                <span class="keyword">new</span> <span class="type">BCryptPasswordEncoder</span>().encode(<span class="string">"123"</span>), grantedAuthorities);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 在config包下定义TokenConfig，</span></span><br><span class="line"><span class="comment"> * 我们暂时先使用InMemoryTokenStore，生成一个普通的令牌。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TokenConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TokenStore <span class="title">tokenStore</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> InMemoryTokenStore();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@Configuration</span></span><br><span class="line"><span class="variable">@EnableGlobalMethodSecurity</span>(securedEnabled = true,prePostEnabled = true)</span><br><span class="line">public class WebSecurityConfig extends WebSecurityConfigurerAdapter &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//认证管理器</span></span><br><span class="line">    <span class="variable">@Bean</span></span><br><span class="line">    public AuthenticationManager authenticationManagerBean() throws Exception &#123;</span><br><span class="line">        <span class="selector-tag">return</span> <span class="selector-tag">super</span><span class="selector-class">.authenticationManagerBean</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//密码编码器</span></span><br><span class="line">    @<span class="selector-tag">Bean</span></span><br><span class="line">    <span class="selector-tag">public</span> <span class="selector-tag">PasswordEncoder</span> <span class="selector-tag">passwordEncoder</span>() &#123;</span><br><span class="line">        <span class="selector-tag">return</span> <span class="selector-tag">new</span> <span class="selector-tag">BCryptPasswordEncoder</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//安全拦截机制（最重要）</span></span><br><span class="line">    @<span class="selector-tag">Override</span></span><br><span class="line">    <span class="selector-tag">protected</span> <span class="selector-tag">void</span> <span class="selector-tag">configure</span>(HttpSecurity http) <span class="selector-tag">throws</span> <span class="selector-tag">Exception</span> &#123;</span><br><span class="line">        <span class="selector-tag">http</span><span class="selector-class">.csrf</span>()<span class="selector-class">.disable</span>()</span><br><span class="line">                <span class="selector-class">.authorizeRequests</span>()</span><br><span class="line">                <span class="selector-class">.antMatchers</span>(<span class="string">"/r/r1"</span>)<span class="selector-class">.hasAnyAuthority</span>(<span class="string">"p1"</span>)</span><br><span class="line">                <span class="selector-class">.antMatchers</span>(<span class="string">"/login*"</span>)<span class="selector-class">.permitAll</span>()</span><br><span class="line">                <span class="selector-class">.anyRequest</span>()<span class="selector-class">.authenticated</span>()</span><br><span class="line">                <span class="selector-class">.and</span>()</span><br><span class="line">                <span class="selector-class">.formLogin</span>()</span><br><span class="line">        ;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>访问<code>http://localhost:8000/oauth/authorize?client_id=pa&amp;reponse_type=code&amp;scope=all&amp;redirect_uri=http://www.baidu.com</code><br><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/common/20200427170419370.png" alt="image"><br>确认授权:<br><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/common/20200427170432285.png" alt="image"><br>获取到授权码:<br><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/common/20200427171656730.png" alt="image"></p>
<p>[参考]</p>
<p><a href="https://www.codenong.com/cs105791529/" target="_blank" rel="noopener">循序渐进之单点登录（4）–分布式系统认证(OAuth2,JWT)
</a></p>
<p><a href="https://juejin.cn/post/6844903542306668551" target="_blank" rel="noopener">Spring Security 核心过滤器链分析</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dinghuang.github.io/2021/11/12/分布式锁/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="强壮的病猫">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/dinghuang.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一只病猫">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/11/12/分布式锁/" itemprop="url">分布式锁</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-11-12T15:47:00+08:00">
                2021-11-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JAVA/" itemprop="url" rel="index">
                    <span itemprop="name">JAVA</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2021/11/12/分布式锁/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2021/11/12/分布式锁/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <p>参考<a href="https://mp.weixin.qq.com/s/35aCS_5GqLyzZS3VobL6fg" target="_blank" rel="noopener">文章</a></p>
<p><a href="https://minios.strongsickcat.com/dinghuang-blog-picture/common/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81.pptx" target="_blank" rel="noopener">PPT下载</a></p>
<h1 id="分布式锁"><a href="#分布式锁" class="headerlink" title="分布式锁"></a>分布式锁</h1><h2 id="为什么需要分布式锁"><a href="#为什么需要分布式锁" class="headerlink" title="为什么需要分布式锁"></a>为什么需要分布式锁</h2><p>常见的是秒杀场景，订单服务部署了多个服务实例。如秒杀商品有 4 个，第一个用户购买 3 个，第二个用户购买 2 个，理想状态下第一个用户能购买成功，第二个用户提示购买失败，反之亦可。而实际可能出现的情况是，两个用户都得到库存为 4，第一个用户买到了 3 个，更新库存之前，第二个用户下了 2 个商品的订单，更新库存为 2，导致业务逻辑出错。</p>
<p>在上面的场景中，商品的库存是共享变量，面对高并发情形，需要保证对资源的访问互斥。在单机环境中，比如 Java 语言中其实提供了很多并发处理相关的 API，但是这些 API 在分布式场景中就无能为力了，由于分布式系统具备多线程和多进程的特点，且分布在不同机器中，synchronized 和 lock 关键字将失去原有锁的效果，。仅依赖这些语言自身提供的 API 并不能实现分布式锁的功能，因此需要想想其它方法实现分布式锁。</p>
<h2 id="分布式锁三个属性和两大类"><a href="#分布式锁三个属性和两大类" class="headerlink" title="分布式锁三个属性和两大类"></a>分布式锁三个属性和两大类</h2><p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/common/WechatIMG666.png" alt="image"></p>
<p>总的来说，分布式锁服务有三个必备的性质</p>
<ul>
<li>互斥（Mutual Exclusion），这是锁最基本的功能，同一时刻只能有一个客户端持有锁；</li>
<li>避免死锁（Dead lock free），如果某个客户端获得锁之后花了太长时间处理，或者客户端发生了故障，锁无法释放会导致整个处理流程无法进行下去，所以要避免死锁。最常见的是通过设置一个 TTL(Time To Live，存活时间) 来避免死锁。假设设置 TTL 为 3 秒，如果 3 秒过后锁还没有被释放，系统也会自动释放该锁（TTL 的设置要非常小心！这个时长取决于你的业务逻辑）。可是这也存在一个问题，假如进程1获取了锁，然后由于某些原因（下面会说到）没有来得及更新 TTL；3秒后进程2来获取锁，由于 TTL 已过，进程2可以获得锁并开始处理，此时同时有两个客户端持有锁，可能会产生意外行为。所以不能只有 TTL，还需要给锁附加一个唯一 ID (或 fencing token)来标识锁。上述逻辑中，当进程 1 获取到锁后记为 LOCK_1；TTL 过后进程 2 获取到的锁记为 LOCK_2。之后，可以在应用层面或锁服务层面检查该 id，来阻断旧的请求。</li>
<li>容错（Fault tolerance），为避免单点故障，锁服务需要具有一定容错性。大体有两种容错方式，一种是锁服务本身是一个集群，能够自动故障切换(ZooKeeper、etcd)；另一种是客户端向多个独立的锁服务发起请求，其中某个锁服务故障时仍然可以从其他锁服务读取到锁信息(Redlock)，代价是一个客户端要获取多把锁，并且要求每台机器的时钟都是一样的，否则 TTL 会不一致，可能有的机器会提前释放锁，有的机器会太晚释放锁，导致出现问题。</li>
</ul>
<blockquote>
<p>值得注意的是，容错会以性能为代价，容错性取决于你的系统级别，如果你的系统可以承担分布式锁存在误差，那么单节点或者简单的主从复制也许就能满足；如果你的系统非常严格，例如金融系统或航天系统，那么就要考虑每个 corner case</p>
</blockquote>
<p>先把分布式锁分为两大类：自旋类和监听类。</p>
<ul>
<li><p>自旋类包括基于数据库的实现和基于 Redis 的实现，这类实现需要客户端不停反复请求锁服务查看是否能够获取到锁；</p>
</li>
<li><p>监听类主要包括基于 ZooKeeper 或 etcd 实现的分布式锁，这类实现客户端只需监听(watch) 某个 key，当锁可用时锁服务会通知客户端，无需客户端不停请求锁服务。</p>
</li>
</ul>
<h2 id="基于数据库的实现"><a href="#基于数据库的实现" class="headerlink" title="基于数据库的实现"></a>基于数据库的实现</h2><h3 id="基于数据库表的增删"><a href="#基于数据库表的增删" class="headerlink" title="基于数据库表的增删"></a>基于数据库表的增删</h3><ul>
<li>互斥:通过某个独立的数据库（或文件），当获取到数据时，往数据库中插入一条数据。之后的进程想要获取数据，会先检查数据库是否存在记录，就能够知道是否有别的进程持有锁.</li>
<li>避免死锁:增加时间戳字段和自增 id 字段，同时在后台启动一个线程定时释放和清理过期的锁.</li>
<li>容错:通过主从同步复制来实现容错.</li>
</ul>
<table>
<thead>
<tr>
<th>字段</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>自增 id，唯一标识锁</td>
</tr>
<tr>
<td>key</td>
<td>锁名称</td>
</tr>
<tr>
<td>value</td>
<td>自定义字段</td>
</tr>
<tr>
<td>ttl</td>
<td>存活时间，定时清理，避免死锁</td>
</tr>
</tbody>
</table>
<h3 id="基于数据库排他锁"><a href="#基于数据库排他锁" class="headerlink" title="基于数据库排他锁"></a>基于数据库排他锁</h3><p>还可以通过数据库的排他锁来实现分布式锁。基于 Mysql 的 InnoDB 引擎，可以使用以下方法来实现加锁操作：<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lock</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    connection.setAutoCommit(<span class="literal">false</span>)</span><br><span class="line">    <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(count &lt; <span class="number">4</span>)&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">lock</span> <span class="keyword">where</span> lock_name=xxx <span class="keyword">for</span> update;</span><br><span class="line">            <span class="keyword">if</span>(结果不为空)&#123;</span><br><span class="line">                <span class="comment">//代表获取到锁</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//为空或者抛异常的话都表示没有获取到锁</span></span><br><span class="line">        sleep(<span class="number">1000</span>);</span><br><span class="line">        count++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> LockException();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在查询语句后面增加 for update，数据库会在查询过程中给数据库表增加排他锁。当某条记录被加上排他锁之后，其他线程无法再在该行记录上增加排他锁。其他没有获取到锁的就会阻塞在上述 select 语句上，可能的结果有 2 种，在超时之前获取到了锁，在超时之前仍未获取到锁。</p>
<p>获得排它锁的线程即可获得分布式锁，当获取到锁之后，可以执行业务逻辑，执行完业务之后释放锁。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>基于数据库的实现较为繁琐，要自己维护锁的 TTL；除非使用分布式数据库，否则主从复制的故障切换并不轻松。</p>
<p>除了麻烦之外，在高并发常见下数据库读写是非常缓慢的，会导致系统性能存在瓶颈。如果采用多个独立数据库进行容错，那性能就更差了。</p>
<p>于是，为了分布式锁的性能，开始转向基于 Redis 或者 memcache 等内存存储系统来实现分布式锁。</p>
<h2 id="基于-Redis-的实现"><a href="#基于-Redis-的实现" class="headerlink" title="基于 Redis 的实现"></a>基于 Redis 的实现</h2><p>分布式锁最多的恐怕就是基于 Redis 的实现。首先从单节点 Redis 开始。</p>
<h3 id="基于单节点-Redis-的分布式锁"><a href="#基于单节点-Redis-的分布式锁" class="headerlink" title="基于单节点 Redis 的分布式锁"></a>基于单节点 Redis 的分布式锁</h3><p>一条命令实现写 key + 设置过期时间，否则原子性无法保证可能出现死锁。于是就有了以下命令(redis的lua脚本):<br><figure class="highlight q"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> <span class="built_in">key</span> <span class="built_in">value</span> nx px <span class="number">10000</span></span><br></pre></td></tr></table></figure></p>
<p>set 命令后的 5 个参数分别是：</p>
<ul>
<li>第一个为 key 作为锁名；</li>
<li>第二个为 value，一般传入一个唯一 id，例如一个随机数或者客户端 mac 地址 + uuid；</li>
<li>第三个为 NX，意思是 SET IF NOT EXIST，即只有 key 不存在时才进行 set 操作；若 key 已经存在(锁已被占)，则不做任何操作；</li>
<li>第四个为 PX，作用是给这个 key 加一个过期时间，具体时间长短由第五个参数决定；</li>
<li>第五个为具体的过期时间，对应第四个参数 PX 是毫秒，EX 是秒；</li>
</ul>
<p>一般会使用开源的redission去实现，具体逻辑如图所示:<br><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/common/59572ed0f6957d315488a6c24e9d0907.jpeg" alt="image"></p>
<p>这个方案在互斥性和避免死锁上性能良好，且非常轻量。但单节点的 Redis 存在单点故障。注意，Redis 主从复制是异步的，所以加入从节点会增加破坏互斥性的风险。为了实现容错性，就有了基于多节点 Redis 的分布式锁，即 Redlock。</p>
<h3 id="基于多节点-Redis-的分布式锁"><a href="#基于多节点-Redis-的分布式锁" class="headerlink" title="基于多节点 Redis 的分布式锁"></a>基于多节点 Redis 的分布式锁</h3><p>Redlock 用到多个独立的 Redis 节点，其思想简而言之，是在多个 Redis 实际都获取锁，其中一个宕机了，只要还有超过半数节点可用，就可以继续提供锁服务。</p>
<p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/common/WechatIMG667.png" alt="image"></p>
<p>如图所示，Redlock 获取锁的大致步骤如下，：</p>
<ul>
<li>依次对多个 Redis 实例进行加锁(一般是3个或5个)，加锁命令使用单实例 Redis 的加锁命令；</li>
<li>为了避免在某个节点长时间获取不到锁而阻塞，每次获取锁操作也有一个超时时间，远小于 TTL，超过超时时间则认为失败，继续向下一个节点获取锁；</li>
<li>计算整个获取多把锁的总消耗时间，只有在超过半数节点都成功获取锁，并且总消耗时间小于 TTL，则认为成功持有锁；</li>
<li>成功获取锁后，要重新计算 TTL = TTL - 总消耗时间；</li>
<li>如果获取锁失败，要向所有 redis 实例发送释放锁的命令。</li>
<li>释放锁操作就是向所有实例都发送删除 key 命令。</li>
</ul>
<p>Redlock 容错性依赖于一个时间戳的计算，这在分布式系统中并不受待见，于是有了一场著名的论战。</p>
<h4 id="Redlock-论战"><a href="#Redlock-论战" class="headerlink" title="Redlock 论战"></a>Redlock 论战</h4><p>DDIA 的作者 Martin Kleppmann 大佬发表了著名的文章《How to do distributed locking》，表示 Redlock 并不可靠，该文章主要阐述了两个观点：</p>
<ul>
<li>Redis 命令避免了死锁但可能会不满足互斥性，因为没有自增 id 或 fencing token 来阻断同时获得锁的两个客户端；</li>
<li>Redlock 基于时间戳的合理性值得怀疑，多台服务器难以保证时间一致；</li>
</ul>
<p>第一点如下图所示，Client 1 获取锁后发生了 STW GC(或缺页等问题)，TTL 过期后 Client 2 获取了锁，此时两个客户端持有锁，违反了互斥性。后续写操作自然就可能存在问题。</p>
<p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/common/WechatIMG668.png" alt="image"><br>我们在避免死锁时提到，需要另外用单调递增 id (Martin 称之为 fencing token，也叫序列号)来标识每一个锁。增加 id 后逻辑如下图所示，最后的 Client 1 的写请求因为 token 是旧的，会被存储系统拒绝。<br><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/common/WechatIMG669.png" alt="image"></p>
<p>第二点 Martin 认为，Redlock 的时间戳计算方式不可靠，每台服务器的走时并不绝对准确，例如 NTP 进行同步时系统会发生时钟漂移，即当前服务器的时间戳突然变大或变小，这都会影响 Redlock 的计算。</p>
<p>Martin 的这篇文章引起了大家对分布式锁广泛讨论。Redis 作者 antirez 也不甘示弱，发表文章《Is Redlock safe?》进行反驳，回应了上述两个问题，总结了 antirez 的论点：</p>
<ul>
<li>针对第一点，虽然 Redlock 提供不了自增 id 这样的字段，但是由客户端指定的字段 value 也可以实现唯一标识，并通过 read-modify-write 原子操作来进行检查；</li>
<li>时钟发送漂移肯定会影响 Redlock 安全性，可是通过恰当的运维，例如不要随意人为修改时钟、将一次大的 NTP 时钟调整转换成多次微小的调整等方式，使时钟修改不超过某个范围就不会对 Redlock 产生影响。</li>
</ul>
<blockquote>
<p>非常推荐阅读争论的两篇文章，但篇幅所限我只提取了观点。关于争论的详细内容张铁蕾老师的文章《<a href="http://mp.weixin.qq.com/s?__biz=MzA4NTg1MjM0Mg==&amp;mid=2657261521&amp;idx=1&amp;sn=7bbb80c8fe4f9dff7cd6a8883cc8fc0a&amp;chksm=84479e08b330171e89732ec1460258a85afe73299c263fcc7df3c77cbeac0573ad7211902649&amp;scene=21#wechat_redirect" target="_blank" rel="noopener">基于Redis的分布式锁到底安全吗（下）</a>？》也有着比较完整的中文回顾。</p>
</blockquote>
<p>对于这两个问题，我想谈谈我的理解。</p>
<p>对于第一个问题，文章开头“三大属性”我们就分析过，增加 TTL 来避免死锁就会对互斥性产生影响，无论基于 Redis 还是基于 Zookeeper 实现都会存在该问题。antirez 观点是 Redlock 也可以用 value 作为唯一标识来阻断操作，这确实没问题，我也挑不出毛病。但我们可以思考下，实际编程中读者您觉得使用一个自增 id 进行判断容易还是使用 read-modify-write 操作更容易呢？（实际上，一开始我都不怎么理解什么是 read-modify-write 操作）</p>
<p>我认为 fencing token 是一个更好的解决方案，一个单调自增的 id 更符合我们的直觉，同时也更好进行 debug。</p>
<p>作为 fencing token 的一个实际参考，Hazelcast 的文章 “Distributed Locks are Dead; Long Live Distributed Locks!” 给出了一个 FencedLock 解决方案，并且通过了 Jepsen 测试。</p>
<p>第二个问题，时钟漂移是否应该引起注意呢？antirez 的观点是时钟确实会影响 Redlock，但可以通过合理运维避免。</p>
<p>Julia Evans(也是很出名的技术博主)也写了一篇后续文章 “TIL: clock skew exists”，来讨论时钟漂移的问题是否真的值得引起注意。最终得出的结论是：有界的时钟漂移不是一个安全的假设。</p>
<p>事实上，时钟问题并不罕见，例如：</p>
<p>Nelson Minar 在1999年发表了论文，通过调查发现，NTP 服务器经常提供不正确的时间；</p>
<p>aphyr 的文章《The trouble with timestamps》也总结了时间戳在分布式系统中的麻烦；</p>
<p>Google 在 Spanner 中投入大量精力来处理时间问题，并发明了 TrueTime 这一授时系统；</p>
<p>闰秒也会导致时钟漂移，不过闰秒确实非常罕见（即使是现在，闰秒依然会导致许多问题，以后我们会专门谈谈）。</p>
<p>通过上述例子，时钟问题是真实存在的，如果你的系统对分布式锁的安全性要求严格，不想造成任何系统和金钱上的损失，那么你应该考虑所有的边缘情况。</p>
<p>Martin Kleppmann 没有回复任何 Hacker News 的评论，他觉得自己想要表达的都已经说完了，他不想参与争论，他认为实际上一个分布式系统到底该怎么做取决于你如何管理你的系统。</p>
<p>本文想表达的也是这样的观点，软件工程没有银弹，这些 trade-off 取决于你系统的重要级别，你怎么管理你的分布式系统。</p>
<p>只不过分布式系统研究人员通常会非常关注那些看似非常不可能在你的电脑上发生的事情(例如：时钟偏移)，原因是：</p>
<p>需要找出某个算法来解决此类问题，因此需要考虑所有 corner case；</p>
<p>分布式系统中会有成千上万的机器，那么不大可能发生的事情会变得极有可能；</p>
<p>其中一些问题其实是很常见的（例如：网络分区）。</p>
<h2 id="基于共识算法实现"><a href="#基于共识算法实现" class="headerlink" title="基于共识算法实现"></a>基于共识算法实现</h2><p>分布式锁属于分布式互斥问题(distributed mutual exclusion)，实际上 Lamport 在那篇经典论文 “Time, clocks, and the ordering of events in a distributed system” 中早就证明了使用状态机能够去中心化解决多进程互斥问题，而共识算法就能实现这样的状态机。</p>
<blockquote>
<p>“共识”的意思是保证所有的参与者都有相同的认知（可以理解为强一致性）。共识算法本身可以依据是否有恶意节点分为两类，大部分时候共识算法指的都是没有恶意节点的那一类，即系统中的节点不会向其他节点发送恶意请求，比如欺骗请求。共识算法中最有名的应该是Paxos算法。</p>
</blockquote>
<p>容错性当然离不开共识算法，这个时候不再让客户端依次上多个锁，而是让锁服务器通过共识算法复制到多数派节点，然后再回复客户端。由于共识算法本身不依赖系统时间戳而是逻辑时钟（Raft 的任期或 Paxos 的 epoch），故不存在时钟漂移问题。</p>
<p>其次，死锁避免问题依然需要 TTL 和自增 id 等手段，通过锁服务给每次加锁请求标识上单调递增 id。</p>
<p>通过以上两种方法，可以得到一个更可靠的分布式锁。代价是:需要一个实现共识算法的第三方组件。</p>
<h3 id="基于-ZooKeeper-实现"><a href="#基于-ZooKeeper-实现" class="headerlink" title="基于 ZooKeeper 实现"></a>基于 ZooKeeper 实现</h3><p>ZooKeeper是一个分布式的、开放源码的分布式协调服务，是Google的Chubby一个开源的实现，是Hadoop和Hbase的重要组件。它是一个为分布式应用提供一致性服务的软件，提供的功能包括：配置维护、域名服务、分布式同步、组服务等。由于Hadoop生态系统中很多项目都依赖于zookeeper，如Pig，Hive等， 似乎很像一个动物园管理员，于是取名为Zookeeper。</p>
<p>基于 ZooKeeper 实现的分布式锁依赖以下两个节点属性：</p>
<ul>
<li>sequence：顺序节点，ZooKeeper 会将一个10位带有0填充的序列号附加到客户端设置的 znode 路径之后。例如 locknode/guid-lock- 会返回 locknode/guid-lock-0000000001；</li>
<li>ephemeral：临时节点，当客户端和 ZooKeeper 连接断开时，临时节点会被删除，能够避免死锁。但这个断开检测依然有一定心跳延迟，所以仍然需要自增 id 来避免互斥性被破坏。</li>
</ul>
<p>ZooKeeper 官方文档有提供现成的分布式锁实现方法：</p>
<ul>
<li>首先调用 create()，锁路径例如 locknode/guid-lock-，并设置 sequence 和 ephemeral 标志。guid 是客户端的唯一标识，如果 create() 创建失败可以通过 guid 来进行检查，下面会提到；</li>
<li>调用 getChildren() 获取子节点列表，不要设置 watch 标志（很重要，可以避免 Herd Effect，即惊群效应）；</li>
<li>检查 2 中的子节点列表，如果步骤 1 中创建成功并且返回的序列号后缀是最小的，则客户端持有该分布式锁，到此结束；</li>
<li>如果发现序列不是最小的，则从子节点列表中选择比当前序列号小一位的节点记为 p，客户端调用 exist(p, watch=true)，即监听 p，当 p 被删除时收到通知（该节点只有比自己小一位的节点释放时才能获得锁）；</li>
<li>如果 exist() 返回 null，即前一个分布式锁被释放了，转到步骤 2；否则需要一直等待步骤 4 中 watch 的通知。</li>
</ul>
<p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/common/WechatIMG1.jpeg" alt="image"><br>如上图所示，每个客户端只监听比自己小的 znode，可以避免惊群效应。</p>
<p>获取锁的伪代码如下：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">n = <span class="keyword">create</span>(l + “/guid-<span class="keyword">lock</span>-”, EPHEMERAL|<span class="keyword">SEQUENTIAL</span>)</span><br><span class="line">C = getChildren(l, <span class="literal">false</span>)</span><br><span class="line"><span class="keyword">if</span> n <span class="keyword">is</span> lowest znode <span class="keyword">in</span> C, <span class="keyword">exit</span></span><br><span class="line">p = znode <span class="keyword">in</span> C ordered just <span class="keyword">before</span> n</span><br><span class="line"><span class="keyword">goto</span> <span class="number">2</span></span><br></pre></td></tr></table></figure></p>
<p>释放锁非常简单：客户端直接删除他们在步骤 1 创建的 znode 节点。</p>
<p>有几点需要注意：</p>
<ul>
<li>删除一个 znode 只会导致一个客户端被唤醒，因为每个节点正好被一个客户端 watch 着，通过这种方式，可以避免惊群效应；</li>
<li>没有轮询或超时；</li>
<li>如果在调用 create() 时 ZooKeeper 创建锁成功但没有返回给客户端就失败了，客户端收到错误响应后，应该先调用 getChildren() 并检查该路径是否包含 guid 来避免这一问题。</li>
</ul>
<p>当然，虽然 ZooKeeper 的实现看起来更为可靠，但根据你实现锁的方式，可能还是会有大量的锁逻辑调试、锁争抢等问题。</p>
<p>基于 ZooKeeper 的分布式锁性能介于基于 Mysql 和基于 Redis 的实现之间，性能上当然不如单节点 Redis。</p>
<p>此外，Zookeeper 中创建和删除节点只能通过 Leader 节点来执行，然后将数据同步到集群中的其他节点。分布式环境中难免存在网络抖动，导致客户端和 Zookeeper 集群之间的 session 连接中断，此时 Zookeeper 服务端以为客户端挂了，就会删除临时节点。其他客户端就可以获取到分布式锁了，导致了同时获取锁的不一致问题。</p>
<p>ZooKeeper 的另一个缺点是需要另外维护一套 ZooKeeper 服务（已有则忽略）</p>
<h3 id="etcd"><a href="#etcd" class="headerlink" title="etcd"></a>etcd</h3><p>Etcd 是著名的分布式 key-value 存储结构，因在 Kubernetes 中使用而闻名。etcd 同样可以用来实现分布式锁，官方也很贴心的提供了 clientv3 包给开发者快速实现分布式锁。</p>
<p>来看下 etcd 是如何解决分布式锁“三大问题”的：</p>
<ul>
<li>互斥：etcd 支持事务，通过事务创建 key 和检查 key 是否存在，可以保证互斥性；</li>
<li>容错：etcd 基于 Raft 共识算法，写 key 成功至少需要超过半数节点确认，这就保证了容错性；</li>
<li>死锁：etcd 支持租约(Lease)机制，可以对 key 设置租约存活时间(TTL)，到期后该 key 将失效删除，避免死锁；etc 也支持租约续期，如果客户端还未处理完可以继续续约；同时 etcd 也有自增 id。</li>
</ul>
<p>为了帮助开发者快速实现分布式锁，etcd 给出了 clientv3 包，其中分布式锁在 concurrency 包中。按照官方文档给出的案例1，首先创建一个新的会话(session)并指定租约的 TTL，然后实例化一个 NewMutex() 之后就可以调用 Lock() 和 Unlock() 进行抢锁和释放锁。代码如下：<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cli</span>, <span class="keyword">err</span> := clientv3.New(clientv3.Config&#123;Endpoints: endpoints&#125;)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">err</span> != nil &#123;</span><br><span class="line">   <span class="keyword">log</span>.Fatal(<span class="keyword">err</span>)</span><br><span class="line">&#125;</span><br><span class="line">defer <span class="keyword">cli</span>.<span class="keyword">Close</span>()</span><br><span class="line"></span><br><span class="line">s, <span class="keyword">err</span> := concurrency.NewSession(<span class="keyword">cli</span>, concurrency.WithTTL(10))</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">err</span> != nil &#123;</span><br><span class="line">   <span class="keyword">log</span>.Fatal(<span class="keyword">err</span>)</span><br><span class="line">&#125;</span><br><span class="line">defer s.<span class="keyword">Close</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">m</span> := concurrency.NewMutex(s, <span class="string">"/my-lock/"</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">err</span> := <span class="keyword">m</span>.Lock(context.TODO()); <span class="keyword">err</span> != nil &#123;</span><br><span class="line">   <span class="keyword">log</span>.Fatal(<span class="keyword">err</span>)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="string">"acquired lock for s"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">err</span> := <span class="keyword">m</span>.Unlock(context.TODO()); <span class="keyword">err</span> != nil &#123;</span><br><span class="line">   <span class="keyword">log</span>.Fatal(<span class="keyword">err</span>)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="string">"released lock for s"</span>)</span><br></pre></td></tr></table></figure></p>
<p>基于如上分析的思路，绘制出实现 etcd 分布式锁的流程图</p>
<p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/common/20210429173943675.png" alt="image"><br>其中 Lock() 函数的源代码很容易找到，由于篇幅我就不放出来了，但源代码中可以看到的一些其他机制包括：</p>
<ul>
<li>Revision 机制。一个全局序列号，跟 ZooKeeper 的序列号类似，可以用来避免 watch 惊群；</li>
<li>Prefix 机制。即上述代码中 etcd 会创建一个前缀为 /my-lock/ 的 key(/my-lock/ + LeaseID)，分布式锁由该前缀下 revision 最小(最早创建)的 key 获得；</li>
<li>Watch 机制。跟 ZooKeeper 一样，客户端会监听 revision 比自己小的 key，当比自己小的 key 释放锁后，尝试去获得锁。</li>
</ul>
<p>本质上 etcd 和 ZooKeeper 对分布式锁的实现是类似的。</p>
<p>选择 etcd 的原因可能有：</p>
<ul>
<li>生产环境中已经大规模部署了 etcd 集群；</li>
<li>etcd 在保证强一致性的同时真的够快，性能介于 Redis 和 ZooKeeper 之间；</li>
<li>许多语言都有 etcd 的客户端库，很容易使用；</li>
</ul>
<h2 id="该如何实现分布式锁"><a href="#该如何实现分布式锁" class="headerlink" title="该如何实现分布式锁"></a>该如何实现分布式锁</h2><p>应该区分，分布式锁的用途和业务场景，如果从安全性的角度上考虑，如果要保证绝对的一致性，建议使用zookeeper，同时还要考虑，是否还要使用数据库的锁。</p>
<p>如果只是为了协调各个服务，防止重复处理，锁偶尔失效也可以接受，可以使用Redis。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dinghuang.github.io/2021/06/08/Seata部署使用(1.4.2)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="强壮的病猫">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/dinghuang.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一只病猫">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/06/08/Seata部署使用(1.4.2)/" itemprop="url">Seata部署使用(1.4.2)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-06-08T15:47:00+08:00">
                2021-06-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JAVA/" itemprop="url" rel="index">
                    <span itemprop="name">JAVA</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2021/06/08/Seata部署使用(1.4.2)/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2021/06/08/Seata部署使用(1.4.2)/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <p>源码地址： <a href="https://github.com/seata/seata.git" target="_blank" rel="noopener">https://github.com/seata/seata.git</a> </p>
<h1 id="前期准备"><a href="#前期准备" class="headerlink" title="前期准备"></a>前期准备</h1><h2 id="xa模式"><a href="#xa模式" class="headerlink" title="xa模式"></a>xa模式</h2><p>确保mysql版本&gt;5.7 并且开启了XA事务支持</p>
<h2 id="at模式"><a href="#at模式" class="headerlink" title="at模式"></a>at模式</h2><p>每个mysql库执行脚本<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="string">`undo_log`</span></span><br><span class="line">(</span><br><span class="line">    <span class="string">`branch_id`</span>     <span class="built_in">BIGINT</span>       <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'branch transaction id'</span>,</span><br><span class="line">    <span class="string">`xid`</span>           <span class="built_in">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'global transaction id'</span>,</span><br><span class="line">    <span class="string">`context`</span>       <span class="built_in">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'undo_log context,such as serialization'</span>,</span><br><span class="line">    <span class="string">`rollback_info`</span> LONGBLOB     <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'rollback info'</span>,</span><br><span class="line">    <span class="string">`log_status`</span>    <span class="built_in">INT</span>(<span class="number">11</span>)      <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'0:normal status,1:defense status'</span>,</span><br><span class="line">    <span class="string">`log_created`</span>   DATETIME(<span class="number">6</span>)  <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'create datetime'</span>,</span><br><span class="line">    <span class="string">`log_modified`</span>  DATETIME(<span class="number">6</span>)  <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'modify datetime'</span>,</span><br><span class="line">    <span class="keyword">UNIQUE</span> <span class="keyword">KEY</span> <span class="string">`ux_undo_log`</span> (<span class="string">`xid`</span>, <span class="string">`branch_id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span> = <span class="keyword">InnoDB</span></span><br><span class="line">  AUTO_INCREMENT = <span class="number">1</span></span><br><span class="line">  <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span> = utf8 <span class="keyword">COMMENT</span> =<span class="string">'AT transaction mode undo table'</span>;</span><br></pre></td></tr></table></figure></p>
<h2 id="saga模式"><a href="#saga模式" class="headerlink" title="saga模式"></a>saga模式</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- -------------------------------- The script used for sage  --------------------------------</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="string">`seata_state_machine_def`</span></span><br><span class="line">(</span><br><span class="line">    <span class="string">`id`</span>               <span class="built_in">VARCHAR</span>(<span class="number">32</span>)  <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'id'</span>,</span><br><span class="line">    <span class="string">`name`</span>             <span class="built_in">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'name'</span>,</span><br><span class="line">    <span class="string">`tenant_id`</span>        <span class="built_in">VARCHAR</span>(<span class="number">32</span>)  <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'tenant id'</span>,</span><br><span class="line">    <span class="string">`app_name`</span>         <span class="built_in">VARCHAR</span>(<span class="number">32</span>)  <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'application name'</span>,</span><br><span class="line">    <span class="string">`type`</span>             <span class="built_in">VARCHAR</span>(<span class="number">20</span>)  <span class="keyword">COMMENT</span> <span class="string">'state language type'</span>,</span><br><span class="line">    <span class="string">`comment_`</span>         <span class="built_in">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">COMMENT</span> <span class="string">'comment'</span>,</span><br><span class="line">    <span class="string">`ver`</span>              <span class="built_in">VARCHAR</span>(<span class="number">16</span>)  <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'version'</span>,</span><br><span class="line">    <span class="string">`gmt_create`</span>       DATETIME(<span class="number">3</span>)  <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'create time'</span>,</span><br><span class="line">    <span class="string">`status`</span>           <span class="built_in">VARCHAR</span>(<span class="number">2</span>)   <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'status(AC:active|IN:inactive)'</span>,</span><br><span class="line">    <span class="string">`content`</span>          <span class="built_in">TEXT</span> <span class="keyword">COMMENT</span> <span class="string">'content'</span>,</span><br><span class="line">    <span class="string">`recover_strategy`</span> <span class="built_in">VARCHAR</span>(<span class="number">16</span>) <span class="keyword">COMMENT</span> <span class="string">'transaction recover strategy(compensate|retry)'</span>,</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span> = <span class="keyword">InnoDB</span></span><br><span class="line">  <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span> = utf8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="string">`seata_state_machine_inst`</span></span><br><span class="line">(</span><br><span class="line">    <span class="string">`id`</span>                  <span class="built_in">VARCHAR</span>(<span class="number">128</span>)            <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'id'</span>,</span><br><span class="line">    <span class="string">`machine_id`</span>          <span class="built_in">VARCHAR</span>(<span class="number">32</span>)             <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'state machine definition id'</span>,</span><br><span class="line">    <span class="string">`tenant_id`</span>           <span class="built_in">VARCHAR</span>(<span class="number">32</span>)             <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'tenant id'</span>,</span><br><span class="line">    <span class="string">`parent_id`</span>           <span class="built_in">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">COMMENT</span> <span class="string">'parent id'</span>,</span><br><span class="line">    <span class="string">`gmt_started`</span>         DATETIME(<span class="number">3</span>)             <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'start time'</span>,</span><br><span class="line">    <span class="string">`business_key`</span>        <span class="built_in">VARCHAR</span>(<span class="number">48</span>) <span class="keyword">COMMENT</span> <span class="string">'business key'</span>,</span><br><span class="line">    <span class="string">`start_params`</span>        <span class="built_in">TEXT</span> <span class="keyword">COMMENT</span> <span class="string">'start parameters'</span>,</span><br><span class="line">    <span class="string">`gmt_end`</span>             DATETIME(<span class="number">3</span>) <span class="keyword">COMMENT</span> <span class="string">'end time'</span>,</span><br><span class="line">    <span class="string">`excep`</span>               <span class="built_in">BLOB</span> <span class="keyword">COMMENT</span> <span class="string">'exception'</span>,</span><br><span class="line">    <span class="string">`end_params`</span>          <span class="built_in">TEXT</span> <span class="keyword">COMMENT</span> <span class="string">'end parameters'</span>,</span><br><span class="line">    <span class="string">`status`</span>              <span class="built_in">VARCHAR</span>(<span class="number">2</span>) <span class="keyword">COMMENT</span> <span class="string">'status(SU succeed|FA failed|UN unknown|SK skipped|RU running)'</span>,</span><br><span class="line">    <span class="string">`compensation_status`</span> <span class="built_in">VARCHAR</span>(<span class="number">2</span>) <span class="keyword">COMMENT</span> <span class="string">'compensation status(SU succeed|FA failed|UN unknown|SK skipped|RU running)'</span>,</span><br><span class="line">    <span class="string">`is_running`</span>          TINYINT(<span class="number">1</span>) <span class="keyword">COMMENT</span> <span class="string">'is running(0 no|1 yes)'</span>,</span><br><span class="line">    <span class="string">`gmt_updated`</span>         DATETIME(<span class="number">3</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>),</span><br><span class="line">    <span class="keyword">UNIQUE</span> <span class="keyword">KEY</span> <span class="string">`unikey_buz_tenant`</span> (<span class="string">`business_key`</span>, <span class="string">`tenant_id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span> = <span class="keyword">InnoDB</span></span><br><span class="line">  <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span> = utf8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="string">`seata_state_inst`</span></span><br><span class="line">(</span><br><span class="line">    <span class="string">`id`</span>                       <span class="built_in">VARCHAR</span>(<span class="number">48</span>)  <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'id'</span>,</span><br><span class="line">    <span class="string">`machine_inst_id`</span>          <span class="built_in">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'state machine instance id'</span>,</span><br><span class="line">    <span class="string">`name`</span>                     <span class="built_in">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'state name'</span>,</span><br><span class="line">    <span class="string">`type`</span>                     <span class="built_in">VARCHAR</span>(<span class="number">20</span>)  <span class="keyword">COMMENT</span> <span class="string">'state type'</span>,</span><br><span class="line">    <span class="string">`service_name`</span>             <span class="built_in">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">COMMENT</span> <span class="string">'service name'</span>,</span><br><span class="line">    <span class="string">`service_method`</span>           <span class="built_in">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">COMMENT</span> <span class="string">'method name'</span>,</span><br><span class="line">    <span class="string">`service_type`</span>             <span class="built_in">VARCHAR</span>(<span class="number">16</span>) <span class="keyword">COMMENT</span> <span class="string">'service type'</span>,</span><br><span class="line">    <span class="string">`business_key`</span>             <span class="built_in">VARCHAR</span>(<span class="number">48</span>) <span class="keyword">COMMENT</span> <span class="string">'business key'</span>,</span><br><span class="line">    <span class="string">`state_id_compensated_for`</span> <span class="built_in">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">COMMENT</span> <span class="string">'state compensated for'</span>,</span><br><span class="line">    <span class="string">`state_id_retried_for`</span>     <span class="built_in">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">COMMENT</span> <span class="string">'state retried for'</span>,</span><br><span class="line">    <span class="string">`gmt_started`</span>              DATETIME(<span class="number">3</span>)  <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'start time'</span>,</span><br><span class="line">    <span class="string">`is_for_update`</span>            TINYINT(<span class="number">1</span>) <span class="keyword">COMMENT</span> <span class="string">'is service for update'</span>,</span><br><span class="line">    <span class="string">`input_params`</span>             <span class="built_in">TEXT</span> <span class="keyword">COMMENT</span> <span class="string">'input parameters'</span>,</span><br><span class="line">    <span class="string">`output_params`</span>            <span class="built_in">TEXT</span> <span class="keyword">COMMENT</span> <span class="string">'output parameters'</span>,</span><br><span class="line">    <span class="string">`status`</span>                   <span class="built_in">VARCHAR</span>(<span class="number">2</span>)   <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'status(SU succeed|FA failed|UN unknown|SK skipped|RU running)'</span>,</span><br><span class="line">    <span class="string">`excep`</span>                    <span class="built_in">BLOB</span> <span class="keyword">COMMENT</span> <span class="string">'exception'</span>,</span><br><span class="line">    <span class="string">`gmt_updated`</span>              DATETIME(<span class="number">3</span>) <span class="keyword">COMMENT</span> <span class="string">'update time'</span>,</span><br><span class="line">    <span class="string">`gmt_end`</span>                  DATETIME(<span class="number">3</span>) <span class="keyword">COMMENT</span> <span class="string">'end time'</span>,</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>, <span class="string">`machine_inst_id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span> = <span class="keyword">InnoDB</span></span><br><span class="line">  <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span> = utf8;</span><br></pre></td></tr></table></figure>
<h2 id="部署TC"><a href="#部署TC" class="headerlink" title="部署TC"></a>部署TC</h2><p>执行mysql脚本<br><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">-- -------------------------------- The script used when storeMode is 'db' --------------------------------</span><br><span class="line">-- the table to store GlobalSession data</span><br><span class="line"><span class="keyword">CREATE</span> TABLE <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="symbol">`global_table`</span></span><br><span class="line">(</span><br><span class="line">    <span class="symbol">`xid`</span>                       VARCHAR(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="symbol">`transaction_id`</span>            BIGINT,</span><br><span class="line">    <span class="symbol">`status`</span>                    TINYINT      <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="symbol">`application_id`</span>            VARCHAR(<span class="number">32</span>),</span><br><span class="line">    <span class="symbol">`transaction_service_group`</span> VARCHAR(<span class="number">32</span>),</span><br><span class="line">    <span class="symbol">`transaction_name`</span>          VARCHAR(<span class="number">128</span>),</span><br><span class="line">    <span class="symbol">`timeout`</span>                   INT,</span><br><span class="line">    <span class="symbol">`begin_time`</span>                BIGINT,</span><br><span class="line">    <span class="symbol">`application_data`</span>          VARCHAR(<span class="number">2000</span>),</span><br><span class="line">    <span class="symbol">`gmt_create`</span>                DATETIME,</span><br><span class="line">    <span class="symbol">`gmt_modified`</span>              DATETIME,</span><br><span class="line">    <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (<span class="symbol">`xid`</span>),</span><br><span class="line">    <span class="keyword">KEY</span> <span class="symbol">`idx_gmt_modified_status`</span> (<span class="symbol">`gmt_modified`</span>, <span class="symbol">`status`</span>),</span><br><span class="line">    <span class="keyword">KEY</span> <span class="symbol">`idx_transaction_id`</span> (<span class="symbol">`transaction_id`</span>)</span><br><span class="line">) ENGINE = InnoDB</span><br><span class="line">  DEFAULT CHARSET = utf8;</span><br><span class="line"></span><br><span class="line">-- the table to store BranchSession data</span><br><span class="line"><span class="keyword">CREATE</span> TABLE <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="symbol">`branch_table`</span></span><br><span class="line">(</span><br><span class="line">    <span class="symbol">`branch_id`</span>         BIGINT       <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="symbol">`xid`</span>               VARCHAR(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="symbol">`transaction_id`</span>    BIGINT,</span><br><span class="line">    <span class="symbol">`resource_group_id`</span> VARCHAR(<span class="number">32</span>),</span><br><span class="line">    <span class="symbol">`resource_id`</span>       VARCHAR(<span class="number">256</span>),</span><br><span class="line">    <span class="symbol">`branch_type`</span>       VARCHAR(<span class="number">8</span>),</span><br><span class="line">    <span class="symbol">`status`</span>            TINYINT,</span><br><span class="line">    <span class="symbol">`client_id`</span>         VARCHAR(<span class="number">64</span>),</span><br><span class="line">    <span class="symbol">`application_data`</span>  VARCHAR(<span class="number">2000</span>),</span><br><span class="line">    <span class="symbol">`gmt_create`</span>        DATETIME(<span class="number">6</span>),</span><br><span class="line">    <span class="symbol">`gmt_modified`</span>      DATETIME(<span class="number">6</span>),</span><br><span class="line">    <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (<span class="symbol">`branch_id`</span>),</span><br><span class="line">    <span class="keyword">KEY</span> <span class="symbol">`idx_xid`</span> (<span class="symbol">`xid`</span>)</span><br><span class="line">) ENGINE = InnoDB</span><br><span class="line">  DEFAULT CHARSET = utf8;</span><br><span class="line"></span><br><span class="line">-- the table to store lock data</span><br><span class="line"><span class="keyword">CREATE</span> TABLE <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="symbol">`lock_table`</span></span><br><span class="line">(</span><br><span class="line">    <span class="symbol">`row_key`</span>        VARCHAR(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="symbol">`xid`</span>            VARCHAR(<span class="number">128</span>),</span><br><span class="line">    <span class="symbol">`transaction_id`</span> BIGINT,</span><br><span class="line">    <span class="symbol">`branch_id`</span>      BIGINT       <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="symbol">`resource_id`</span>    VARCHAR(<span class="number">256</span>),</span><br><span class="line">    <span class="symbol">`table_name`</span>     VARCHAR(<span class="number">32</span>),</span><br><span class="line">    <span class="symbol">`pk`</span>             VARCHAR(<span class="number">36</span>),</span><br><span class="line">    <span class="symbol">`gmt_create`</span>     DATETIME,</span><br><span class="line">    <span class="symbol">`gmt_modified`</span>   DATETIME,</span><br><span class="line">    <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (<span class="symbol">`row_key`</span>),</span><br><span class="line">    <span class="keyword">KEY</span> <span class="symbol">`idx_branch_id`</span> (<span class="symbol">`branch_id`</span>)</span><br><span class="line">) ENGINE = InnoDB</span><br><span class="line">  DEFAULT CHARSET = utf8;</span><br></pre></td></tr></table></figure></p>
<p>如果使用源码编译的话，需要注释掉，或者idea导入插件protobuf support<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--        &lt;module&gt;seata-serializer-protobuf&lt;/module&gt;--&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>修改配置<code>registry.conf</code>、<code>file.conf</code>，如果需要不同的环境区分不同的配置，新建文件<code>registry-dev.conf</code>、<code>file-dev.conf</code>，然后启动启动类<code>io.seata.server.Server</code>，启动的jvm参数加上变量<code>-DseataEnv=uat</code>，这样就可以实现多环境启动了。</p>
<p>到server目录下，打包部署服务器:<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn clean package -Dmaven<span class="selector-class">.test</span><span class="selector-class">.skip</span>=true -Prelease-seata</span><br></pre></td></tr></table></figure></p>
<p>会生成制品，制品目录在<code>/distribution</code>，如果是部署服务器上面或者是通过docker镜像部署的话，可以参考<code>/distribution/Dockerfile</code>，或者直接通过下面的命令启动<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh ./bin/seata-server.sh -p <span class="number">8091</span> -h <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> -n <span class="number">1</span> -e uat</span><br></pre></td></tr></table></figure></p>
<p>具体参数如下</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>全写</th>
<th>作用</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>-h</td>
<td>–host</td>
<td>指定在注册中心注册的 IP</td>
<td>不指定时获取当前的 IP，外部访问部署在云环境和容器中的 server 建议指定</td>
</tr>
<tr>
<td>-p</td>
<td>–port</td>
<td>指定 server 启动的端口</td>
<td>默认为 8091</td>
</tr>
<tr>
<td>-m</td>
<td>–storeMode</td>
<td>事务日志存储方式</td>
<td>支持file,db,redis，默认为 file 注:redis需seata-server 1.3版本及以上</td>
</tr>
<tr>
<td>-n</td>
<td>–serverNode</td>
<td>用于指定seata-server节点ID</td>
<td>如 1,2,3…, 默认为 1</td>
</tr>
<tr>
<td>-e</td>
<td>–seataEnv</td>
<td>指定 seata-server 运行环境</td>
<td>如 dev, test 等, 服务启动时会使用 registry-dev.conf 这样的配置</td>
</tr>
</tbody>
</table>
<p>可以查看在我本地输出脚本的完整的jvm参数<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/Library/</span>Java<span class="regexp">/JavaVirtualMachines/</span>jdk1<span class="number">.8</span><span class="number">.0</span>_181.jdk<span class="regexp">/Contents/</span>Home<span class="regexp">/bin/</span>java -server -Xmx2048m -Xms2048m -Xmn1024m -Xss512k -<span class="string">XX:</span>SurvivorRatio=<span class="number">10</span> -<span class="string">XX:</span>MetaspaceSize=<span class="number">128</span>m -<span class="string">XX:</span>MaxMetaspaceSize=<span class="number">256</span>m -<span class="string">XX:</span>MaxDirectMemorySize=<span class="number">1024</span>m -<span class="string">XX:</span>-OmitStackTraceInFastThrow -<span class="string">XX:</span>-UseAdaptiveSizePolicy -<span class="string">XX:</span>+HeapDumpOnOutOfMemoryError -<span class="string">XX:</span>HeapDumpPath=<span class="regexp">/Users/</span>dinghuang<span class="regexp">/Documents/</span>workSpace<span class="regexp">/github/</span>seata<span class="regexp">/distribution/</span>seata-server<span class="number">-1.4</span><span class="number">.2</span><span class="regexp">/logs/</span>java_heapdump.hprof -<span class="string">XX:</span>+DisableExplicitGC -<span class="string">XX:</span>+CMSParallelRemarkEnabled -<span class="string">XX:</span>+UseCMSInitiatingOccupancyOnly -<span class="string">XX:</span>CMSInitiatingOccupancyFraction=<span class="number">75</span> -<span class="string">Xloggc:</span><span class="regexp">/Users/</span>dinghuang<span class="regexp">/Documents/</span>workSpace<span class="regexp">/github/</span>seata<span class="regexp">/distribution/</span>seata-server<span class="number">-1.4</span><span class="number">.2</span><span class="regexp">/logs/</span>seata_gc.log -<span class="string">verbose:</span>gc -Dio.netty.leakDetectionLevel=advanced -Dlogback.color.disable-<span class="keyword">for</span>-bat=<span class="literal">true</span> -classpath <span class="regexp">/Users/</span>dinghuang<span class="regexp">/Documents/</span>workSpace<span class="regexp">/github/</span>seata<span class="regexp">/distribution/</span>seata-server<span class="number">-1.4</span><span class="number">.2</span><span class="regexp">/conf:/</span>Users<span class="regexp">/dinghuang/</span>Documents<span class="regexp">/workSpace/</span>github<span class="regexp">/seata/</span>distribution<span class="regexp">/seata-server-1.4.2/</span>lib<span class="comment">/* -Dapp.name=seata-server -Dapp.pid=23748 -Dapp.repo=/Users/dinghuang/Documents/workSpace/github/seata/distribution/seata-server-1.4.2/lib -Dapp.home=/Users/dinghuang/Documents/workSpace/github/seata/distribution/seata-server-1.4.2 -Dbasedir=/Users/dinghuang/Documents/workSpace/github/seata/distribution/seata-server-1.4.2 io.seata.server.Server -e uat</span></span><br></pre></td></tr></table></figure></p>
<p>如果配置中心使用apollo，可以参考这篇文章：<a href="https://www.studying.icu/pages/94a254/#seata" target="_blank" rel="noopener">https://www.studying.icu/pages/94a254/#seata</a>  （1.4.2有bug，apollo的配置不能用，建议用1.4.1）</p>
<h1 id="Spring框架使用"><a href="#Spring框架使用" class="headerlink" title="Spring框架使用"></a>Spring框架使用</h1><p>pom.xml引入包<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/io.seata/seata-spring-boot-starter --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.seata<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>seata-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>修改application.yml配置文件（1.4.2有bug，apollo的配置不能用，建议用1.4.1）<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">seata:</span></span><br><span class="line"><span class="attr">  enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  application-id:</span> <span class="string">applicationName</span></span><br><span class="line"><span class="attr">  tx-service-group:</span> <span class="string">my_test_tx_group</span></span><br><span class="line"><span class="attr">  enable-auto-data-source-proxy:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  data-source-proxy-mode:</span> <span class="string">AT</span></span><br><span class="line"><span class="attr">  use-jdk-proxy:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">  excludes-for-auto-proxying:</span> <span class="string">firstClassNameForExclude,secondClassNameForExclude</span></span><br><span class="line"><span class="attr">  client:</span></span><br><span class="line"><span class="attr">    rm:</span></span><br><span class="line"><span class="attr">      async-commit-buffer-limit:</span> <span class="number">10000</span></span><br><span class="line"><span class="attr">      report-retry-count:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">      table-meta-check-enable:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">      report-success-enable:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">      saga-branch-register-enable:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">      saga-json-parser:</span> <span class="string">fastjson</span></span><br><span class="line"><span class="attr">      saga-retry-persist-mode-update:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">      saga-compensate-persist-mode-update:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">      lock:</span></span><br><span class="line"><span class="attr">        retry-interval:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">        retry-times:</span> <span class="number">30</span></span><br><span class="line"><span class="attr">        retry-policy-branch-rollback-on-conflict:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    tm:</span></span><br><span class="line"><span class="attr">      commit-retry-count:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">      rollback-retry-count:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">      default-global-transaction-timeout:</span> <span class="number">60000</span></span><br><span class="line"><span class="attr">      degrade-check:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">      degrade-check-period:</span> <span class="number">2000</span></span><br><span class="line"><span class="attr">      degrade-check-allow-times:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">    undo:</span></span><br><span class="line"><span class="attr">      data-validation:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      log-serialization:</span> <span class="string">jackson</span></span><br><span class="line"><span class="attr">      log-table:</span> <span class="string">undo_log</span></span><br><span class="line"><span class="attr">      only-care-update-columns:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      compress:</span></span><br><span class="line"><span class="attr">        enable:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">        type:</span> <span class="string">zip</span></span><br><span class="line"><span class="attr">        threshold:</span> <span class="number">64</span><span class="string">k</span></span><br><span class="line"><span class="attr">    load-balance:</span></span><br><span class="line"><span class="attr">      type:</span> <span class="string">RandomLoadBalance</span></span><br><span class="line"><span class="attr">      virtual-nodes:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">  service:</span></span><br><span class="line"><span class="attr">    vgroup-mapping:</span></span><br><span class="line"><span class="attr">      my_test_tx_group:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">    grouplist:</span></span><br><span class="line"><span class="attr">      default:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8091</span></span><br><span class="line"><span class="attr">    enable-degrade:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">    disable-global-transaction:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">  transport:</span></span><br><span class="line"><span class="attr">    shutdown:</span></span><br><span class="line"><span class="attr">      wait:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">    thread-factory:</span></span><br><span class="line"><span class="attr">      boss-thread-prefix:</span> <span class="string">NettyBoss</span></span><br><span class="line"><span class="attr">      worker-thread-prefix:</span> <span class="string">NettyServerNIOWorker</span></span><br><span class="line"><span class="attr">      server-executor-thread-prefix:</span> <span class="string">NettyServerBizHandler</span></span><br><span class="line"><span class="attr">      share-boss-worker:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">      client-selector-thread-prefix:</span> <span class="string">NettyClientSelector</span></span><br><span class="line"><span class="attr">      client-selector-thread-size:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">      client-worker-thread-prefix:</span> <span class="string">NettyClientWorkerThread</span></span><br><span class="line"><span class="attr">      worker-thread-size:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">      boss-thread-size:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">    server:</span> <span class="string">NIO</span></span><br><span class="line"><span class="attr">    heartbeat:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    serialization:</span> <span class="string">seata</span></span><br><span class="line"><span class="attr">    compressor:</span> <span class="string">none</span></span><br><span class="line"><span class="attr">    enable-client-batch-send-request:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  config:</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">file</span></span><br><span class="line"><span class="attr">    consul:</span></span><br><span class="line"><span class="attr">      server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8500</span></span><br><span class="line"><span class="attr">    apollo:</span></span><br><span class="line"><span class="attr">      apollo-meta:</span> <span class="attr">http://192.168.1.204:8801</span></span><br><span class="line"><span class="attr">      app-id:</span> <span class="string">seata-server</span></span><br><span class="line"><span class="attr">      namespace:</span> <span class="string">application</span></span><br><span class="line"><span class="attr">      apollo-accesskey-secret:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">    etcd3:</span></span><br><span class="line"><span class="attr">      server-addr:</span> <span class="attr">http://localhost:2379</span></span><br><span class="line"><span class="attr">    nacos:</span></span><br><span class="line"><span class="attr">      namespace:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">      server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span></span><br><span class="line"><span class="attr">      group:</span> <span class="string">SEATA_GROUP</span></span><br><span class="line"><span class="attr">      username:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">      password:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">    zk:</span></span><br><span class="line"><span class="attr">      server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:2181</span></span><br><span class="line"><span class="attr">      session-timeout:</span> <span class="number">6000</span></span><br><span class="line"><span class="attr">      connect-timeout:</span> <span class="number">2000</span></span><br><span class="line"><span class="attr">      username:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">      password:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">    custom:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">  registry:</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">file</span></span><br><span class="line"><span class="attr">    file:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">file.conf</span></span><br><span class="line"><span class="attr">    consul:</span></span><br><span class="line"><span class="attr">      server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8500</span></span><br><span class="line"><span class="attr">      acl-token:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">    etcd3:</span></span><br><span class="line"><span class="attr">      server-addr:</span> <span class="attr">http://localhost:2379</span></span><br><span class="line"><span class="attr">    eureka:</span></span><br><span class="line"><span class="attr">      weight:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">      service-url:</span> <span class="attr">http://localhost:8761/eureka</span></span><br><span class="line"><span class="attr">    nacos:</span></span><br><span class="line"><span class="attr">      application:</span> <span class="string">seata-server</span></span><br><span class="line"><span class="attr">      server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span></span><br><span class="line">      <span class="string">group</span> <span class="string">:</span> <span class="string">"SEATA_GROUP"</span></span><br><span class="line"><span class="attr">      namespace:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">      username:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">      password:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">    redis:</span></span><br><span class="line"><span class="attr">      server-addr:</span> <span class="attr">localhost:6379</span></span><br><span class="line"><span class="attr">      db:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">      password:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">      timeout:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">    sofa:</span></span><br><span class="line"><span class="attr">      server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:9603</span></span><br><span class="line"><span class="attr">      region:</span> <span class="string">DEFAULT_ZONE</span></span><br><span class="line"><span class="attr">      datacenter:</span> <span class="string">DefaultDataCenter</span></span><br><span class="line"><span class="attr">      group:</span> <span class="string">SEATA_GROUP</span></span><br><span class="line"><span class="attr">      address-wait-time:</span> <span class="number">3000</span></span><br><span class="line"><span class="attr">      application:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">    zk:</span></span><br><span class="line"><span class="attr">      server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:2181</span></span><br><span class="line"><span class="attr">      session-timeout:</span> <span class="number">6000</span></span><br><span class="line"><span class="attr">      connect-timeout:</span> <span class="number">2000</span></span><br><span class="line"><span class="attr">      username:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">      password:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">    custom:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">  log:</span></span><br><span class="line"><span class="attr">    exception-rate:</span> <span class="number">100</span></span><br></pre></td></tr></table></figure></p>
<p>具体的例子可以看<br><a href="https://github.com/seata/seata-samples" target="_blank" rel="noopener">https://github.com/seata/seata-samples</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dinghuang.github.io/2021/03/18/DDD领域驱动设计/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="强壮的病猫">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/dinghuang.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一只病猫">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/03/18/DDD领域驱动设计/" itemprop="url">DDD领域驱动设计</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-03-18T15:47:00+08:00">
                2021-03-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JAVA/" itemprop="url" rel="index">
                    <span itemprop="name">JAVA</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2021/03/18/DDD领域驱动设计/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2021/03/18/DDD领域驱动设计/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p><a href="https://github.com/dinghuang/spring-cloud-framework/tree/master/dinghuang-framework-parent/dinghuang-framework-core" target="_blank" rel="noopener">代码地址</a></p>
</blockquote>
<h1 id="什么是DDD"><a href="#什么是DDD" class="headerlink" title="什么是DDD"></a>什么是DDD</h1><p>对于一个架构师来说，在软件开发中如何降低系统复杂度是一个永恒的挑战，无论是 94 年 GoF 的 Design Patterns ， 99 年的 Martin Fowler 的 Refactoring ， 02 年的 P of EAA ，还是 03 年的 Enterprise Integration Patterns ，都是通过一系列的设计模式或范例来降低一些常见的复杂度。</p>
<p>但是问题在于，这些书的理念是通过技术手段解决技术问题，但并没有从根本上解决业务的问题。所以 03 年 Eric Evans 的 Domain Driven Design 一书，以及后续 Vaughn Vernon 的 Implementing DDD ， Uncle Bob 的 Clean Architecture 等书，真正的从业务的角度出发，为全世界绝大部分做纯业务的开发提供了一整套的架构思路。</p>
<p>DDD 不是一套框架，而是一种架构思想，所以在代码层面缺乏了足够的约束，导致 DDD 在实际应用中上手门槛很高，甚至可以说绝大部分人都对 DDD 的理解有所偏差，所有认知的最终目的都是基于合理的代码结构、框架和约束，来降低 DDD 的实践门槛，提升代码质量、可测试性、安全性、健壮性。</p>
<h1 id="好的架构设计"><a href="#好的架构设计" class="headerlink" title="好的架构设计"></a>好的架构设计</h1><p>在做架构设计时，一个好的架构应该需要实现以下几个目标：</p>
<ul>
<li>独立于框架：架构不应该依赖某个外部的库或框架，不应该被框架的结构所束缚。</li>
<li>独立于UI：前台展示的样式可能会随时发生变化（今天可能是网页、明天可能变成console、后天是独立app），但是底层架构不应该随之而变化。</li>
<li>独立于底层数据源：无论今天你用MySQL、Oracle还是MongoDB、CouchDB，甚至使用文件系统，软件架构不应该因为不同的底层数据储存方式而产生巨大改变。</li>
<li>独立于外部依赖：无论外部依赖如何变更、升级，业务的核心逻辑不应该随之而大幅变化。<br>可测试：无论外部依赖了什么数据库、硬件、UI或者服务，业务的逻辑应该都能够快速被验证正确性。</li>
</ul>
<h1 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h1><h2 id="领域模型（DOMAIN）"><a href="#领域模型（DOMAIN）" class="headerlink" title="领域模型（DOMAIN）"></a>领域模型（DOMAIN）</h2><ul>
<li>模型是对客观世界事物的一种抽象和简化。</li>
<li>它是从某个角度反映人对客观世界事物的一种认识。</li>
<li>它用于对事物的本质进行深入细致的研究。</li>
</ul>
<p>举一个常见的例子：一个函数写了几千行，里面的if-else写了一大堆，计算各种业务规则。另一个人接手之后，分析了好几个月，才把业务逻辑彻底理清楚。从表面来看，这是代码写的不规范，要重构，把一个几千行的函数拆成一个个小的函数。从根本上来讲，就是“重要逻辑”隐藏在代码里面，没有“显性”的表达出来。这里可以引用一个观点：建模的本质就是把“重要的东西进行显性化，并进而把这些显性化的构造块，互相串联起来，组成一个体系“。</p>
<p>DDD通过建立一个业务域到软件域的通用模型，把问题空间同解决方案空间联系在一起，真正把领域的知识挖掘出来，让领域专家可以去驱动软件的实现。</p>
<p>映射概念：切分的服务。</p>
<p>领域就是范围。范围的重点是边界。领域的核心思想是将问题逐级细分来减低业务和系统的复杂度，这也是 DDD 讨论的核心。</p>
<p>如果说你要盖一栋房子，那么你需要以下的东西</p>
<p>有一块地<br>楼共有6层<br>每层有4个套房<br>那么你的领域是什么呢？</p>
<p>领域是房子么？可能，但是你应该知道，如果你把房子作为你的领域，那么你可能会忽略很多的小的需求。你设计的房子必须设计那里是让人住的。那么，一般而言的“房子”可能会让我们忽略一些细节，所以，我们应该缩小我们的领域，那就是“民房”。</p>
<p>那么，当你和建筑工人或买房子的人说起你设计的房子时，你所说的“民房”就可以很容易的被人理解了。当承包商告诉你要设计一个6层每层4套房子的时候，在语言上你是否稍微修改了一下呢？现在如果你让建筑工人到一个地方建“房子”，他们可能并没有考虑到一些“民房”的一些特性。但是如果你说了“民房”呢，他们肯定会做出合理的分析。</p>
<p>这就是我们将要说到的“通用语言”</p>
<h3 id="子域"><a href="#子域" class="headerlink" title="子域"></a>子域</h3><p>映射概念：子服务。</p>
<p>领域可以进一步划分成子领域，即子域。这是处理高度复杂领域的设计思想，它试图分离技术实现的复杂性。这个拆分的里面在很多架构里都有，比如 C4。</p>
<h3 id="核心域"><a href="#核心域" class="headerlink" title="核心域"></a>核心域</h3><p>映射概念：核心服务。</p>
<p>在领域划分过程中，会不断划分子域，子域按重要程度会被划分成三类：核心域、通用域、支撑域。</p>
<p>决定产品核心竞争力的子域就是核心域，没有太多个性化诉求。</p>
<p>桃树的例子，有根、茎、叶、花、果、种子等六个子域，不同人理解的核心域不同，比如在果园里，核心域就是果是核心域，在公园里，核心域则是花。有时为了核心域的营养供应，还会剪掉通用域和支撑域（茎、叶等）。</p>
<h3 id="通用域"><a href="#通用域" class="headerlink" title="通用域"></a>通用域</h3><p>映射概念：中间件服务或第三方服务。</p>
<p>被多个子域使用的通用功能就是通用域，没有太多企业特征，比如权限认证。</p>
<h3 id="支撑域"><a href="#支撑域" class="headerlink" title="支撑域"></a>支撑域</h3><p>映射概念：企业公共服务。</p>
<p>对于功能来讲是必须存在的，但它不对产品核心竞争力产生影响，也不包含通用功能，有企业特征，不具有通用性，比如数据代码类的数字字典系统。</p>
<h2 id="统一语言（-Ubiquitous-language-）"><a href="#统一语言（-Ubiquitous-language-）" class="headerlink" title="统一语言（ Ubiquitous language ）"></a>统一语言（ Ubiquitous language ）</h2><p>映射概念：统一概念。</p>
<p>关于统一语言必要性，有一个经典的通天塔故事，人类想建一座通天塔，进度很快，上帝害怕了，于是上帝让建造者说不通的语言，这样通天塔就再也没有能建起来了。统一语言是一件事情能顺利开展的基础。</p>
<p>由于语言上存在鸿沟，领域专家们只能模糊地描述他们想要的东西，开发人员虽然努力去理解一个自己不熟悉的领域但也只能形成模糊的认识，结果就是各说各的话，或者都是一知半解，最后到上线前才会发现漏了这个漏了那个。</p>
<p>定义上下文的含义。它的价值是可以解决交流障碍，不管你是 RD、PM、QA 等什么角色，让每个团队使用统一的语言（概念）来交流，甚至可读性更好的代码。</p>
<p>通用语言包含属于和用例场景，并且能直接反应在代码中。</p>
<p>可以在事件风暴（开会）中来统一语言，甚至是中英文的映射、业务与代码模型的映射等。可以使用一个表格来记录。</p>
<p>通用语言也并不是像，XML、Schema或Java这样的语言，它是一种自然的但经过浓缩的领域语言，它是一种开发与用户共享的语言，用来描述问题和领域模型。通用语言不是把从用户那里听到的内容翻译为开发的语言，而是为了减少误解，让用户更容易理解的草图，从而可以真正的帮助纠正错误，帮助开发获取有关的领域新知识。</p>
<p>统一语言体现在两个方面：</p>
<ul>
<li>统一的领域术语</li>
<li>领域术语通常表示对象命名，如商品、订单等，对应实体对象</li>
</ul>
<h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><p>民航业的运输统计指标为例，牵涉到与运量、运力以及周转量相关的术语，就存在 ICAO（International Civil Aviation Organization，国际民用航空组织）与IATA（International Air Transport Association，国际航空运输协会）两大体系，而中国民航局又有自己的中文解释，航空公司和各大机场亦有自己衍生的定义</p>
<p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/common/WechatIMG2.png" alt="image"></p>
<p>如果我们不明白城市对运量与航段运量的真正含义，就可能混淆这两种指标的统计计算规则。这种术语理解错误带来的缺陷往往难以发现，除非业务分析人员、开发人员与测试人员能就此知识达成一致的正确理解。</p>
<h2 id="限界上下文（-Bounded-Context-）"><a href="#限界上下文（-Bounded-Context-）" class="headerlink" title="限界上下文（ Bounded Context ）"></a>限界上下文（ Bounded Context ）</h2><p>映射概念：服务职责划分的边界。</p>
<p>限界上下文，限的意思就是划分、规定，界就是界限、或者一个边界，上下文就是业务的整个流程，总的来说，可以称限界上下文为业务流程在一个划定的界限中，我们知道，业务的描述是通过通用语言来表述的，限界上下文和通用语言的关系就是：在一个特定的限界上下文只使用一套通用语言，并且保证它的清晰性和简洁性。</p>
<p>定义上下文的边界。领域模型存在边界之内。对于同一个概念，不同上下文会有不同的理解，比如商品，在销售阶段叫商品，在运输阶段就叫货品。理论上，限界上下文的边界就是微服务的边界，因此，理解限界上下文在设计中非常重要。</p>
<p>一个有界上下文可以是一个很小的程序，包括他自己的领域，自己的代码和自己的存储机制，在一个上下文里，他们应该在逻辑上一致，每个有界上下文应该独立于其他的有界上下文。</p>
<h3 id="上下文映射图（Context-Mapping）"><a href="#上下文映射图（Context-Mapping）" class="headerlink" title="上下文映射图（Context Mapping）"></a>上下文映射图（Context Mapping）</h3><p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/common/0_Dig5eOh00vMkqOiw.jpg" alt="image"></p>
<h3 id="有界上下文例子"><a href="#有界上下文例子" class="headerlink" title="有界上下文例子"></a>有界上下文例子</h3><p>考虑一下电商系统，最初你可以认为他是一个商店上下文，但是你看的更细点，你会发现其他的上下文，例如：库存，物流，账户等。</p>
<p>合理的拆分一个大型的有界上下文可以让你的应用程序模块化，并且让你区分不同的关注点，而且让应用程序更易于管理和升级。每个有界上下文都有相应的责任和操作。合理的上下文划分可以让我们更容易的找到逻辑所在的位置，从而避免“大泥球”。</p>
<h3 id="什么是“大泥球”（BBOM，Big-ball-of-mud）"><a href="#什么是“大泥球”（BBOM，Big-ball-of-mud）" class="headerlink" title="什么是“大泥球”（BBOM，Big ball of mud）"></a>什么是“大泥球”（BBOM，Big ball of mud）</h3><p>大泥球是一个不规则的、杂乱的、松散的泥巴，这类系统是典型的高度重复，快速修复，无意义增长的系统。混乱的消息传递，在一个地方几乎所有的重要信息都是全局的和重复的，所有的系统架构都可能没有被很好的定义。</p>
<p>我们的目标是避免所有的BBOM</p>
<p>我们还来说说“民房领域”吧，我们有几个有界上下文：</p>
<ul>
<li>电力供应</li>
<li>停车位</li>
<li>套房</li>
<li>等等</li>
<li><p>详细说一下“套房”吧，套房是由不同的房间组成，每个房间又有不同的门窗。那么现在关于屋里面的窗户就有两个问题了：</p>
</li>
<li><p>问题1：你可以想象出来没有屋子的窗户么？</p>
</li>
<li>问题2：如果一个窗户没有了容纳他的屋子，那么它有没有唯一的标识？</li>
</ul>
<p>回答上面的问题会揭示出DDD中下面的概念：</p>
<ul>
<li>实体（Entity）</li>
<li>值对象(Value Object)</li>
<li>聚合和聚合根(Aggreates &amp; Aggrate root)</li>
</ul>
<h2 id="实体（-Entity-）"><a href="#实体（-Entity-）" class="headerlink" title="实体（ Entity ）"></a>实体（ Entity ）</h2><p>映射概念：Domain 或 entity。</p>
<p>许多对象不是由它们的属性来定义，而是通过一系列的连续性（continuity）和标识（identity）来从根本上定义的。只要一个对象在生命周期中能够保持连续性，并且独立于它的属性（即使这些属性对系统用户非常重要），那它就是一个实体。</p>
<p>对于实体Entity，实体核心是用唯一的标识符来定义，而不是通过属性来定义。即即使属性完全相同也可能是两个不同的对象。同时实体本身有状态的，实体又演进的生命周期，实体本身会体现出相关的业务行为，业务行为会实体属性或状态造成影响和改变。无论两个实体是多么的相似，他们都是不同的实体。</p>
<p>例如：</p>
<ul>
<li>你家的卧室</li>
<li>博客的文章</li>
<li>博客的用户</li>
</ul>
<h2 id="值对象（-Value-Objects-）"><a href="#值对象（-Value-Objects-）" class="headerlink" title="值对象（ Value Objects ）"></a>值对象（ Value Objects ）</h2><p>映射概念：Domain 或 entity。</p>
<p>当你只关心某个对象的属性时，该对象便可作为一个值对象。为其添加有意义的属性，并赋予它相应的行为。我们需要将值对象看成不变对象，不要给它任何身份标识，还应该尽量避免像实体对象一样的复杂性。</p>
<p>如果从值对象本身无状态，不可变，并且不分配具体的标识层面来看。那么值对象可以仅仅理解为实际的Entity对象的一个属性结合而已。该值对象附属在一个实际的实体对象上面。值对象本身不存在一个独立的生命周期，也一般不会产生独立的行为。</p>
<p>定义值对象的关键是值对象没有“唯一标识”。</p>
<p>比如 money，让它具有 id 显然是不合理的，你也不可能通过 id 查询一个 money。</p>
<p>定义值对象要依照具体场景的区分来看，你甚至可以把 Article 中的 Author 当成一个值对象，但一定要清楚，Author 独立存在的时候是实体，或者要拿 Author 做复杂的业务逻辑，那么 Author 也会升级为聚合根。</p>
<h2 id="防腐层（facade）"><a href="#防腐层（facade）" class="headerlink" title="防腐层（facade）"></a>防腐层（facade）</h2><p>亦称适配层。在一个上下文中，有时需要对外部上下文进行访问，通常会引入防腐层的概念来对外部上下文的访问进行一次转义。</p>
<p>有以下几种情况会考虑引入防腐层：</p>
<ul>
<li>需要将外部上下文中的模型翻译成本上下文理解的模型。</li>
<li>不同上下文之间的团队协作关系，如果是供奉者关系，建议引入防腐层，避免外部上下文变化对本上下文的侵蚀。</li>
<li>该访问本上下文使用广泛，为了避免改动影响范围过大。</li>
</ul>
<p>如果内部多个上下文对外部上下文需要访问，那么可以考虑将其放到通用上下文中。</p>
<h2 id="领域服务（-Domain-Services-）"><a href="#领域服务（-Domain-Services-）" class="headerlink" title="领域服务（ Domain Services ）"></a>领域服务（ Domain Services ）</h2><p>领域中的一些概念不太适合建模为对象，即归类到实体对象或值对象，因为它们本质上就是一些操作，一些动作，而不是事物。这些操作或动作往往会涉及到多个领域对象，并且需要协调这些领域对象共同完成这个操作或动作。如果强行将这些操作职责分配给任何一个对象，则被分配的对象就是承担一些不该承担的职责，从而会导致对象的职责不明确很混乱。但是基于类的面向对象语言规定任何属性或行为都必须放在对象里面。所以我们需要寻找一种新的模式来表示这种跨多个对象的操作，DDD认为服务是一个很自然的范式用来对应这种跨多个对象的操作，所以就有了领域服务这个模式。和领域对象不同，领域服务是以动词开头来命名的，比如资金转帐服务可以命名为MoneyTransferService。当然，你也可以把服务理解为一个对象，但这和一般意义上的对象有些区别。因为一般的领域对象都是有状态和行为的，而领域服务没有状态只有行为。需要强调的是领域服务是无状态的，它存在的意义就是协调领域对象共完成某个操作，所有的状态还是都保存在相应的领域对象中。我觉得模型（实体）与服务（场景）是对领域的一种划分，模型关注领域的个体行为，场景关注领域的群体行为，模型关注领域的静态结构，场景关注领域的动态功能。这也符合了现实中出现的各种现象，有动有静，有独立有协作。</p>
<p>领域服务还有一个很重要的功能就是可以避免领域逻辑泄露到应用层。因为如果没有领域服务，那么应用层会直接调用领域对象完成本该是属于领域服务该做的操作，这样一来，领域层可能会把一部分领域知识泄露到应用层。因为应用层需要了解每个领域对象的业务功能，具有哪些信息，以及它可能会与哪些其他领域对象交互，怎么交互等一系列领域知识。因此，引入领域服务可以有效的防治领域层的逻辑泄露到应用层。对于应用层来说，从可理解的角度来讲，通过调用领域服务提供的简单易懂但意义明确的接口肯定也要比直接操纵领域对象容易的多。</p>
<p>说到领域服务，还需要提一下软件中一般有三种服务：应用层服务、领域服务、基础服务。</p>
<h3 id="应用层服务"><a href="#应用层服务" class="headerlink" title="应用层服务"></a>应用层服务</h3><ul>
<li>获取输入（如一个XML请求）；</li>
<li>发送消息给领域层服务，要求其实现转帐的业务逻辑；</li>
<li>领域层服务处理成功，则调用基础层服务发送Email通知；</li>
</ul>
<h3 id="领域层服务"><a href="#领域层服务" class="headerlink" title="领域层服务"></a>领域层服务</h3><ul>
<li>获取源帐号和目标帐号，分别通知源帐号和目标帐号进行扣除金额和增加金额的操作；</li>
<li>提供返回结果给应用层；</li>
</ul>
<h3 id="基础层服务"><a href="#基础层服务" class="headerlink" title="基础层服务"></a>基础层服务</h3><p>按照应用层的请求，发送Email通知；</p>
<p>所以，从上面的例子中可以清晰的看出，每种服务的职责</p>
<h2 id="领域事件（-Domain-Events-）"><a href="#领域事件（-Domain-Events-）" class="headerlink" title="领域事件（ Domain Events ）"></a>领域事件（ Domain Events ）</h2><p>领域专家所关心的发生在领域中的一些事件。<br>将领域中所发生的活动建模成一系列的离散事件。每个事件都用领域对象来表示。领域事件是领域模型的组成部分，表示领域中所发生的事情。</p>
<p>一个领域事件可以理解为是发生在一个特定领域中的事件，是你希望在同一个领域中其他部分知道并产生后续动作的事件。但是并不是所有发生过的事情都可以成为领域事件。一个领域事件必须对业务有价值，有助于形成完整的业务闭环，也即一个领域事件将导致进一步的业务操作。</p>
<p>领域事件可以是业务流程的一个步骤，例如订单提交，客户付费100元，订单完工等。领域事件也可以是定时发生的事情，例如每晚对账完成。或者是一个事件发生后引发的后续动作，例如客户输错密码三次后发生锁定账户的事件。</p>
<p>如果在通用语言中存在“当a发生时，我们就需要做到b。”这样的描述，则表明a可以定义成一个领域事件。领域事件的命名一般也就是“产生事件的对象名称+完成的动作的过去式”的形式，比如：订单已经发货的事件（OrderDispatchedEvent）、订单已被收货和确认的事件（OrderConfirmedEvent）等。</p>
<h3 id="为什么需要领域事件"><a href="#为什么需要领域事件" class="headerlink" title="为什么需要领域事件"></a>为什么需要领域事件</h3><p>领域事件也是一种基于事件的架构（EDA）。事件架构的好处可以把处理的流程解耦，实现系统可扩展性，提高主业务流程的内聚性。</p>
<p>举例而言：用户提交一个订单，系统在完成订单保存后，可能还需要发送一个通知，另外可以产生一系列的后台服务的活动。如果把这一系列的动作放入一个处理过程中，会产生几个的明显问题：<br>一个是订单提交的的事务比较长，性能会有问题，甚至在极端情况下容易引发数据库的严重故障；另外订单提交的服务内聚性差，可维护性差，在业务流程发生变更时候，需要频繁修改主程序。</p>
<p>如果改为事件驱动模式，把订单提交后触发一个事件，在订单保存后，触发订单提交事件。通知和后续的各种服务动作可以通过订阅这个事件，在自己的实现空间内实现对应的逻辑，这样就把订单提交和后续其他非主要活动从订单提交业务中剥离，实现了订单提交业务高内聚和低耦合性。</p>
<p>领域事件也继承了事件的作用，当领域中发生了一些活动后，通过领域事件可以把这些活动所产生的副作用显式而不是隐式的表达出来，这种影响可以影响一个或多个聚合对象，而且可以获得更好的扩展性，对数据的锁影响也更小。</p>
<h4 id="领域事件的特点"><a href="#领域事件的特点" class="headerlink" title="领域事件的特点"></a>领域事件的特点</h4><p>首先是解决领域的聚合性问题。DDD中的聚合有一个原则是，在单个事务中，只允许对一个聚合对象进行修改，由此产生的其他改变必须在单独的事务中完成。如果一个业务跨多个聚合对象，领域事件会是一个不错的工具来解决这个问题。通过领域事件的方式可以达到各个组件之间的数据一致性，通过最终一致性取代事务一致性。</p>
<ul>
<li><p>首先是解决领域的聚合性问题。DDD中的聚合有一个原则是，在单个事务中，只允许对一个聚合对象进行修改，由此产生的其他改变必须在单独的事务中完成。如果一个业务跨多个聚合对象，领域事件会是一个不错的工具来解决这个问题。通过领域事件的方式可以达到各个组件之间的数据一致性，通过最终一致性取代事务一致性。</p>
</li>
<li><p>其次领域事件也是一种领域分析的工具，有时从领域专家的话中，我们看不出领域事件的迹象，但是业务需求依然有可能需要领域事件。动态流的事件模型加上结合DDD的聚合实体状态和BC，可以有效进行领域建模。</p>
</li>
</ul>
<p>领域事件可以通过观察者模式和订阅模式进行实现。比较常见的实现方式是事件总线（Event Bus）。</p>
<h2 id="模块（-Modules-）"><a href="#模块（-Modules-）" class="headerlink" title="模块（ Modules ）"></a>模块（ Modules ）</h2><p>模块（Module）是 DDD 中明确提到的一种控制限界上下文的手段，在我们的工程中，一般尽量用一个模块来表示一个领域的限界上下文。</p>
<p>如代码中所示，一般的工程中包的组织方式为 {com.公司名.组织架构.业务.上下文.*}，这样的组织结构能够明确地将一个上下文限定在包的内部。</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"><span class="meta-keyword">import</span> com.company.team.bussiness.counter.*;</span><span class="comment">//计数上下文</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">import</span> com.company.team.bussiness.category.*;</span><span class="comment">//分类上下文</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">import</span> com.company.team.bussiness.comment.*;</span><span class="comment">//评论上下文</span></span><br></pre></td></tr></table></figure>
<p>对于模块内的组织结构，一般情况下我们是按照领域对象、领域服务、领域资源库、防腐层等组织方式定义的。</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"><span class="meta-keyword">import</span> com.company.team.bussiness.cms.domain.valobj.*;</span><span class="comment">//领域对象-值对象</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">import</span> com.company.team.bussiness.cms.domain.entity.*;</span><span class="comment">//领域对象-实体</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">import</span> com.company.team.bussiness.cms.domain.aggregate.*;</span><span class="comment">//领域对象-聚合根</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">import</span> com.company.team.bussiness.cms.service.*;</span><span class="comment">//领域服务</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">import</span> com.company.team.bussiness.cms.repo.*;</span><span class="comment">//领域资源库</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">import</span> com.company.team.bussiness.cms.facade.*;</span><span class="comment">//领域防腐层</span></span><br></pre></td></tr></table></figure>
<h2 id="聚合（-Aggregate-）"><a href="#聚合（-Aggregate-）" class="headerlink" title="聚合（ Aggregate ）"></a>聚合（ Aggregate ）</h2><p>映射概念：包。</p>
<p>聚合，它通过定义对象之间清晰的所属关系和边界来实现领域模型的内聚，并避免了错综复杂的难以维护的对象关系网的形成。聚合定义了一组具有内聚关系的相关对象的集合，我们把聚合看作是一个修改数据的单元。</p>
<h3 id="聚合有以下一些特点："><a href="#聚合有以下一些特点：" class="headerlink" title="聚合有以下一些特点："></a>聚合有以下一些特点：</h3><ul>
<li>每个聚合有一个根和一个边界，边界定义了一个聚合内部有哪些实体或值对象，根是聚合内的某个实体；</li>
<li>聚合内部的对象之间可以相互引用，但是聚合外部如果要访问聚合内部的对象时，必须通过聚合根开始导航，绝对不能绕过聚合根直接访问聚合内的对象，也就是说聚合根是外部可以保持 对它的引用的唯一元素；</li>
<li>聚合内除根以外的其他实体的唯一标识都是本地标识，也就是只要在聚合内部保持唯一即可，因为它们总是从属于这个聚合的；</li>
<li>聚合根负责与外部其他对象打交道并维护自己内部的业务规则；</li>
<li>基于聚合的以上概念，我们可以推论出从数据库查询时的单元也是以聚合为一个单元，也就是说我们不能直接查询聚合内部的某个非根的对象；</li>
<li>聚合内部的对象可以保持对其他聚合根的引用；</li>
<li>删除一个聚合根时必须同时删除该聚合内</li>
</ul>
<h2 id="聚合根"><a href="#聚合根" class="headerlink" title="聚合根"></a>聚合根</h2><p>映射概念：包。</p>
<p>一个上下文内可能包含多个聚合，每个聚合都有一个根实体，叫做聚合根，一个聚合只有一个聚合根。</p>
<h4 id="关于如何识别聚合以及聚合根的问题："><a href="#关于如何识别聚合以及聚合根的问题：" class="headerlink" title="关于如何识别聚合以及聚合根的问题："></a>关于如何识别聚合以及聚合根的问题：</h4><p>可以先从业务的角度深入思考，然后慢慢分析出有哪些对象是：</p>
<ul>
<li>有独立存在的意义，即它是不依赖于其他对象的存在它才有意义的；</li>
<li>可以被独立访问的，还是必须通过某个其他对象导航得到的；</li>
</ul>
<h4 id="如何识别聚合"><a href="#如何识别聚合" class="headerlink" title="如何识别聚合"></a>如何识别聚合</h4><p>我觉得这个需要从业务的角度深入分析哪些对象它们的关系是内聚的，即我们会把他们看成是一个整体来考虑的；然后这些对象我们就可以把它们放在一个聚合内。所谓关系是内聚的，是指这些对象之间必须保持一个固定规则，固定规则是指在数据变化时必须保持不变的一致性规则。当我们在修改一个聚合时，我们必须在事务级别确保整个聚合内的所有对象满足这个固定规则。作为一条建议，聚合尽量不要太大，否则即便能够做到在事务级别保持聚合的业务规则完整性，也可能会带来一定的性能问题。有分析报告显示，通常在大部分领域模型中，有70%的聚合通常只有一个实体，即聚合根，该实体内部没有包含其他实体，只包含一些值对象；另外30%的聚合中，基本上也只包含两到三个实体。这意味着大部分的聚合都只是一个实体，该实体同时也是聚合根。</p>
<h4 id="如何识别聚合根"><a href="#如何识别聚合根" class="headerlink" title="如何识别聚合根"></a>如何识别聚合根</h4><p>如果一个聚合只有一个实体，那么这个实体就是聚合根；如果有多个实体，那么我们可以思考聚合内哪个对象有独立存在的意义并且可以和外部直接进行交互。</p>
<p>上面给出的例子中：</p>
<p>房子、订单和问题是聚合根<br>窗户、订单备注和问题详情是聚合<br>当数据改变时，所有相关的对象被看作一个整体。</p>
<p>所有的外部数据访问都需要通过同一个根节点进入，这个根就是根节点</p>
<h2 id="资源库（-Repository-）"><a href="#资源库（-Repository-）" class="headerlink" title="资源库（ Repository ）"></a>资源库（ Repository ）</h2><ul>
<li>仓储被设计出来的目的是基于这个原因：领域模型中的对象自从被创建出来后不会一直留在内存中活动的，当它不活动时会被持久化到数据库中，然后当需要的时候我们会重建该对象；重建对象就是根据数据库中已存储的对象的状态重新创建对象的过程；所以，可见重建对象是一个和数据库打交道的过程。从更广义的角度来理解，我们经常会像集合一样从某个类似集合的地方根据某个条件获取一个或一些对象，往集合中添加对象或移除对象。也就是说，我们需要提供一种机制，可以提供类似集合的接口来帮助我们管理对象。仓储就是基于这样的思想被设计出来的；</li>
<li>仓储里面存放的对象一定是聚合，原因是之前提到的领域模型中是以聚合的概念去划分边界的；聚合是我们更新对象的一个边界，事实上我们把整个聚合看成是一个整体概念，要么一起被取出来，要么一起被删除。我们永远不会单独对某个聚合内的子对象进行单独查询或做更新操作。因此，我们只对聚合设计仓储。</li>
<li>仓储还有一个重要的特征就是分为仓储定义部分和仓储实现部分，在领域模型中我们定义仓储的接口，而在基础设施层实现具体的仓储。这样做的原因是：由于仓储背后的实现都是在和数据库打交道，但是我们又不希望客户（如应用层）把重点放在如何从数据库获取数据的问题上，因为这样做会导致客户（应用层）代码很混乱，很可能会因此而忽略了领域模型的存在。所以我们需要提供一个简单明了的接口，供客户使用，确保客户能以最简单的方式获取领域对象，从而可以让它专心的不会被什么数据访问代码打扰的情况下协调领域对象完成业务逻辑。这种通过接口来隔离封装变化的做法其实很常见。由于客户面对的是抽象的接口并不是具体的实现，所以我们可以随时替换仓储的真实实现，这很有助于我们做单元测试。</li>
<li>尽管仓储可以像集合一样在内存中管理对象，但是仓储一般不负责事务处理。一般事务处理会交给一个叫“工作单元（Unit Of Work）”的东西。关于工作单元的详细信息我在下面的讨论中会讲到。</li>
<li>另外，仓储在设计查询接口时，可能还会用到规格模式（Specification Pattern），我见过的最厉害的规格模式应该就是LINQ以及DLINQ查询了。一般我们会根据项目中查询的灵活度要求来选择适合的仓储查询接口设计。通常情况下只需要定义简单明了的具有固定查询参数的查询接口就可以了。只有是在查询条件是动态指定的情况下才可能需要用到Specification等模式。</li>
</ul>
<p>领域对象需要资源存储，资源库可以理解成 DAO，但它比 DAO 更宽泛，存储的手段可以是多样化的，常见的无非是数据库、分布式缓存、本地缓存等。资源库（Repository）的作用，就是对领域的存储和访问进行统一管理的对象。</p>
<p>在系统中，我们是通过如下的方式组织资源库的。</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"><span class="meta-keyword">import</span> com.company.team.bussiness.repo.dao.ArticleDao;</span><span class="comment">//数据库访问对象-文章</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">import</span> com.company.team.bussiness.repo.dao.CommentDao;</span><span class="comment">//数据库访问对象-评论</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">import</span> com.company.team.bussiness.repo.dao.po.ArticlePO;</span><span class="comment">//数据库持久化对象-文章</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">import</span> com.company.team.bussiness.repo.dao.po.CommentPO;</span><span class="comment">//数据库持久化对象-评论</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">import</span> com.company.team.bussiness.repo.cache.ArticleObj;</span><span class="comment">//分布式缓存访问对象-文章缓存访问</span></span><br></pre></td></tr></table></figure>
<p>资源库对外的整体访问由 Repository 提供，它聚合了各个资源库的数据信息，同时也承担了资源存储的逻辑（例如缓存更新机制等）。</p>
<h1 id="四种-Domain-模式"><a href="#四种-Domain-模式" class="headerlink" title="四种 Domain 模式"></a>四种 Domain 模式</h1><p>除了晦涩难懂的概念外，让我们最难接受的可能就是模型的运用了，Spring 思想中，Domain 只是数据的载体，所有行为都在 Service 中使用 Domain 封装后流转，而 OOP 讲究一对象维度来执行业务，所以，DDD 中的对象是用行为的（理解这点非常重要哦）。</p>
<p>这里我为你总结了全部的四种领域模式，供你区分和理解：</p>
<ul>
<li>失血模型</li>
<li>贫血模型</li>
<li>充血模型</li>
<li>胀血模型</li>
</ul>
<h2 id="失血模型"><a href="#失血模型" class="headerlink" title="失血模型"></a>失血模型</h2><p>Domain Object 只有属性的 getter/setter 方法的纯数据类，所有的业务逻辑完全由 business object 来完成。</p>
<h2 id="贫血模型"><a href="#贫血模型" class="headerlink" title="贫血模型"></a>贫血模型</h2><p>简单来说，就是 Domain Object 包含了不依赖于持久化的领域逻辑，而那些依赖持久化的领域逻辑被分离到 Service 层。</p>
<p>意这个模式不在 Domain 层里依赖 DAO。持久化的工作还需要在 DAO 或者 Service 中进行。</p>
<p>这样做的优缺点</p>
<p>优点：各层单向依赖，结构清晰。</p>
<p>缺点：</p>
<ul>
<li>Domain Object 的部分比较紧密依赖的持久化 Domain Logic 被分离到 Service 层，显得不够 OO</li>
<li>Service 层过于厚重</li>
</ul>
<h2 id="充血模型"><a href="#充血模型" class="headerlink" title="充血模型"></a>充血模型</h2><p>充血模型和第二种模型差不多，区别在于业务逻辑划分，将绝大多数业务逻辑放到 Domain 中，Service 是很薄的一层，封装少量业务逻辑，并且不和 DAO 打交道：</p>
<blockquote>
<p>Service (事务封装) —&gt; Domain Object &lt;—&gt; DAO</p>
</blockquote>
<p>所有业务逻辑都在 Domain 中，事务管理也在 Item 中实现。这样做的优缺点如下。</p>
<p>优点：</p>
<ul>
<li>更加符合 OO 的原则；</li>
<li><p>Service 层很薄，只充当 Facade 的角色，不和 DAO 打交道。<br>缺点：</p>
</li>
<li><p>DAO 和 Domain Object 形成了双向依赖，复杂的双向依赖会导致很多潜在的问题。</p>
</li>
<li>如何划分 Service 层逻辑和 Domain 层逻辑是非常含混的，在实际项目中，由于设计和开发人员的水平差异，可能 导致整个结构的混乱无序。</li>
</ul>
<h2 id="充血模型-1"><a href="#充血模型-1" class="headerlink" title="充血模型"></a>充血模型</h2><p>基于充血模型的第三个缺点，干脆取消 Service 层，只剩下 Domain Object 和 DAO 两层，在 Domain Object 的 Domain Logic 上面封装事务。</p>
<blockquote>
<p>Domain Object (事务封装，业务逻辑) &lt;—&gt; DAO</p>
</blockquote>
<p>似乎 Ruby on rails 就是这种模型，它甚至把 Domain Object 和 DAO 都合并了。</p>
<p>这样做的优缺点：</p>
<ul>
<li>简化了分层</li>
<li>也算符合 OO</li>
</ul>
<p>该模型缺点：</p>
<ul>
<li>很多不是 Domain Logic 的 Service 逻辑也被强行放入 Domain Object ，引起了 Domain Object 模型的不稳定；</li>
<li>Domain Object 暴露给 Web 层过多的信息，可能引起意想不到的副作用。</li>
</ul>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/common/v2-32711c0238ff0ee8a15af95faf13c2c9_1440w.jpg" alt="image"></p>
<h1 id="DDD分层架构"><a href="#DDD分层架构" class="headerlink" title="DDD分层架构"></a>DDD分层架构</h1><p>优点：</p>
<ul>
<li>开发人员可以只关注整个结构中的某一层。</li>
<li>可以很容易的用新的实现来替换原有层次的实现。</li>
<li>可以降低层与层之间的依赖。</li>
<li>有利于标准化。</li>
<li>利于各层逻辑的复用。<br>缺点：</li>
<li>降低了系统的性能。这是显然的，因为增加了中间层，不过可以通过缓存机制来改善。</li>
<li>可能会导致级联的修改。这种修改尤其体现在自上而下的方向，不过可以通过依赖倒置来改善。</li>
</ul>
<h2 id="四层架构"><a href="#四层架构" class="headerlink" title="四层架构"></a>四层架构</h2><p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/common/WechatIMG9.png" alt="image"></p>
<ul>
<li>User Interface为用户界面层（或表示层），负责向用户显示信息和解释用户命令。这里指的用户可以是另一个计算机系统，不一定是使用用户界面的人。</li>
<li>Application为应用层，定义软件要完成的任务，并且指挥表达领域概念的对象来解决问题。这一层所负责的工作对业务来说意义重大，也是与其它系统的应用层进行交互的必要渠道。应用层要尽量简单，不包含业务规则或者知识，而只为下一层中的领域对象协调任务，分配工作，使它们互相协作。它没有反映业务情况的状态，但是却可以具有另外一种状态，为用户或程序显示某个任务的进度。</li>
<li>Domain为领域层（或模型层），负责表达业务概念，业务状态信息以及业务规则。尽管保存业务状态的技术细节是由基础设施层实现的，但是反映业务情况的状态是由本层控制并且使用的。领域层是业务软件的核心，领域模型位于这一层。</li>
<li>Infrastructure层为基础实施层，向其他层提供通用的技术能力：为应用层传递消息，为领域层提供持久化机制，为用户界面层绘制屏幕组件，等等。基础设施层还能够通过架构框架来支持四个层次间的交互模式。<br>传统的四层架构都是限定型松散分层架构，即Infrastructure层的任意上层都可以访问该层（“L”型），而其它层遵守严格分层架构</li>
</ul>
<p>在四层架构模式的实践中，对于分层的本地化定义主要为：</p>
<ul>
<li>User Interface层主要是Restful消息处理，配置文件解析，等等。</li>
<li>Application层主要是多进程管理及调度，多线程管理及调度，多协程调度和状态机管理，等等。</li>
<li>Domain层主要是领域模型的实现，包括领域对象的确立，这些对象的生命周期管理及关系，领域服务的定义，领域事件的发布，等等。</li>
<li>Infrastructure层主要是业务平台，编程框架，第三方库的封装，基础算法，等等。</li>
</ul>
<blockquote>
<p>严格意义上来说，User Interface指的是用户界面，Restful消息和配置文件解析等处理应该放在Application层，User Interface层没有的话就空缺。但User Interface也可以理解为用户接口，所以将Restful消息和配置文件解析等处理放在User Interface层也行。</p>
</blockquote>
<h2 id="五层架构"><a href="#五层架构" class="headerlink" title="五层架构"></a>五层架构</h2><p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/common/WechatIMG10.png" alt="image"></p>
<ul>
<li>User Interface是用户接口层，主要用于处理用户发送的Restful请求和解析用户输入的配置文件等，并将信息传递给Application层的接口。</li>
<li>Application层是应用层，负责多进程管理及调度、多线程管理及调度、多协程调度和维护业务实例的状态模型。当调度层收到用户接口层的请求后，委托Context层与本次业务相关的上下文进行处理。</li>
<li>Context是环境层，以上下文为单位，将Domain层的领域对象cast成合适的role，让role交互起来完成业务逻辑。</li>
<li>Domain层是领域层，定义领域模型，不仅包括领域对象及其之间关系的建模，还包括对象的角色role的显式建模。</li>
<li>Infrastructure层是基础实施层，为其他层提供通用的技术能力：业务平台，编程框架，持久化机制，消息机制，第三方库的封装，通用算法，等等。</li>
</ul>
<p>很多DDD落地实践，都是面向控制面或管理面且消息交互比较多的系统。这类系统的一次业务，包含一组同步消息或异步消息构成的序列，如果都放在Context层，会导致该层的代码比较复杂，于是我们考虑：</p>
<ul>
<li>Context层在面向控制面或管理面且消息交互比较多的系统中又分裂成两层，即Context层和大Context层。</li>
<li>Context层处理单位为Action，对应一条同步消息或异步消息。</li>
<li>大Context层对应一个事务处理，由一个Action序列组成，一般通过Transaction DSL实现，所以我们习惯把大Context层叫做Transaction DSL层。</li>
<li>Application层在面向控制面或管理面且消息交互比较多的系统中经常会做一些调度相关的工作，所以我们习惯把Application层叫做Scheduler层。</li>
</ul>
<p>因此，在面向控制面或管理面且消息交互比较多的系统中，DDD分层架构模式就变成了六层，<br><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/common/WechatIMG11.png" alt="image"></p>
<p>在实践中，将这六层的本地化定义为：</p>
<ul>
<li>User Interface是用户接口层，主要用于处理用户发送的Restful请求和解析用户输入的配置文件等，并将信息传递给Scheduler层的接口。</li>
<li>Scheduler是调度层，负责多进程管理及调度、多线程管理及调度、多协程调度和维护业务实例的状态模型。当调度层收到用户接口层的请求后，委托Transaction层与本次操作相关的事务进行处理。</li>
<li>Transaction是事务层，对应一个业务流程，比如UE Attach，将多个同步消息或异步消息的处理序列组合成一个事务，而且在大多场景下，都有选择结构。万一事务执行失败，则立即进行回滚。当事务层收到调度层的请求后，委托Context层的Action进行处理，常常还伴随使用Context层的Specification（谓词）进行Action的选择。</li>
<li>Context是环境层，以Action为单位，处理一条同步消息或异步消息，将Domain层的领域对象cast成合适的role，让role交互起来完成业务逻辑。环境层通常也包括Specification的实现，即通过Domain层的知识去完成一个条件判断。</li>
<li>Domain层是领域层，定义领域模型，不仅包括领域对象及其之间关系的建模，还包括对象的角色role的显式建模。</li>
<li>Infrastructure层是基础实施层，为其他层提供通用的技术能力：业务平台，编程框架，持久化机制，消息机制，第三方库的封装，通用算法，等等。</li>
</ul>
<p>事务层的核心是事务模型，事务模型的框架代码一般放在基础设施层。</p>
<p>综上所述，DDD六层架构可以看做是DDD五层架构在特定领域的变体，我们统称为DDD五层架构，而DDD五层架构与传统的四层架构类似，都是限定型松散分层架构。</p>
<h2 id="六边形架构"><a href="#六边形架构" class="headerlink" title="六边形架构"></a>六边形架构</h2><p>有一种方法可以改进分层架构，即依赖倒置原则(Dependency Inversion Principle, DIP)，它通过改变不同层之间的依赖关系达到改进目的。</p>
<blockquote>
<p>依赖倒置原则由Robert C. Martin提出，正式定义为：<br>高层模块不应该依赖于底层模块，两者都应该依赖于抽象。<br>抽象不应该依赖于细节，细节应该依赖于抽象。</p>
</blockquote>
<p>根据该定义，DDD分层架构中的低层组件应该依赖于高层组件提供的接口，即无论高层还是低层都依赖于抽象，整个分层架构好像被推平了。如果我们把分层架构推平，再向其中加入一些对称性，就会出现一种具有对称性特征的架构风格，即六边形架构。六边形架构是Alistair Cockburn在2005年提出的，在这种架构中，不同的客户通过“平等”的方式与系统交互。需要新的客户吗？不是问题。只需要添加一个新的适配器将客户输入转化成能被系统API所理解的参数就行。同时，对于每种特定的输出，都有一个新建的适配器负责完成相应的转化功能。</p>
<p>六边形架构也称为端口与适配器，如下图所示：<br><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/common/8906859-c7a0c865b8217865.png" alt="image"></p>
<p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/common/8906859-27500c1a61ca00ec.png" alt="image"></p>
<p>六边形每条不同的边代表了不同类型的端口，端口要么处理输入，要么处理输出。对于每种外界类型，都有一个适配器与之对应，外界通过应用层API与内部进行交互。上图中有3个客户请求均抵达相同的输入端口（适配器A、B和C），另一个客户请求使用了适配器D。假设前3个请求使用了HTTP协议（浏览器、REST和SOAP等），而后一个请求使用了AMQP协议（比如RabbitMQ）。端口并没有明确的定义，它是一个非常灵活的概念。无论采用哪种方式对端口进行划分，当客户请求到达时，都应该有相应的适配器对输入进行转化，然后端口将调用应用程序的某个操作或者向应用程序发送一个事件，控制权由此交给内部区域。<br>应用程序通过公共API接收客户请求，使用领域模型来处理请求。我们可以将DDD战术设计的建模元素Repository的实现看作是持久化适配器，该适配器用于访问先前存储的聚合实例或者保存新的聚合实例。正如图中的适配器E、F和G所展示的，我们可以通过不同的方式实现资源库，比如关系型数据库、基于文档的存储、分布式缓存或内存存储等。如果应用程序向外界发送领域事件消息，我们将使用适配器H进行处理。该适配器处理消息输出，而上面提到的处理AMQP消息的适配器则是处理消息输入的，因此应该使用不同的端口。</p>
<p>我们在实际的项目开发中，不同层的组件可以同时开发。当一个组件的功能明确后，就可以立即启动开发。由于该组件的用户有多个，并且这些用户的侧重点不同，所以需要提供多个不同的接口。同时，这些用户的认识也是不断深入的，可能会多次重构相关的接口。于是，组件的多个用户经常会找组件的开发者讨论这些问题，无形中降低了组件的开发效率。<br>我们换一种方式，组件的开发者在明确了组件的功能后就专注于功能的开发，确保功能稳定和高效。组件的用户自己定义组件的接口（端口），然后基于接口写测试，并不断演进接口。在跨层集成测试时，由组件开发者或用户再开发一个适配器就可以了。</p>
<h3 id="六边形架构模式的演变"><a href="#六边形架构模式的演变" class="headerlink" title="六边形架构模式的演变"></a>六边形架构模式的演变</h3><p>尽管六边形架构模式已经很好，但是没有最好只有更好，演变没有尽头。在六边形架构模式提出后的这些年，又依次衍生出三种六边形架构模式的变体，感兴趣的读者可以点击链接自行学习：</p>
<ul>
<li>Jeffrey Palermo在2008年提出了洋葱架构，六边形架构是洋葱架构的一个超集。</li>
<li>Robert C. Martin在2012年提出了干净架构（Clean Architecture），这是六边形架构的一个变体。</li>
<li>Russ Miles在2013年提出了Life Preserver设计，这是一种基于六边形架构的设计。</li>
</ul>
<h1 id="DDD实践"><a href="#DDD实践" class="headerlink" title="DDD实践"></a>DDD实践</h1><p>假如你是一个团队 Leader 或者架构师，当你接手一个旧系统维护及重构的任务时，你该如何改造呢？是否觉得哪里都不对但由于业务认知的不熟悉而无从下手呢？</p>
<ul>
<li>通过公共平台大概梳理出系统之间的调用关系（一般中等以上公司都具备 RPC 和 HTTP 调用关系，无脑的挨个系统查询即可），画出来的可能会很乱，也可能会比较清晰，但这就是现状。</li>
<li>分配组员每个人认领几个项目，来梳理项目维度关系，这些关系包括：对外接口、交互、用例、MQ 等的详细说明。个别核心系统可以画出内部实体或者聚合根。</li>
<li>小组开会，挨个 review 每个系统的业务概念，达到组内统一语言。</li>
<li>根据以上资料，即可看出哪些不合理的调用关系（比如循环调用、不规范的调用等），甚至不合理的分层。</li>
<li>根据主线业务自顶向下细分领域，以及限界上下文。此过程可能会颠覆之前的系统划分。</li>
<li>根据业务复杂性，指定领域模型，选择贫血或者充血模型。团队内部最好实行统一习惯，以免出现交接成本过大。</li>
<li>分工进行开发，并设置 deadline，注意，不要单一的设置一个 deadline，要设置中间 check 时间，比如 dealline 是 1 月 20 日，还要设置两个 check 时间，分别沟通代码风格及边界职责，以免 deadline 时延期。</li>
</ul>
<h3 id="事件风暴（Event-Storming）"><a href="#事件风暴（Event-Storming）" class="headerlink" title="事件风暴（Event Storming）"></a>事件风暴（Event Storming）</h3><p>事件风暴也被称为事件建模，形式有点类似于头脑风暴的方法,通过事件风暴的方法可以快速分析复杂业务领域，完成领域建模的目标。</p>
<p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/common/WechatIMG3.png" alt="image"></p>
<blockquote>
<p>事件风暴是一项团队活动，旨在通过领域事件识别出聚合根，进而划分微服务的限界上下文。在活动中，团队先通过头脑风暴的形式罗列出领域中所有的领域事件，整合之后形成最终的领域事件集合，然后对于每一个事件，标注出导致该事件的命令（Command），再然后为每个事件标注出命令发起方的角色，命令可以是用户发起，也可以是第三方系统调用或者是定时器触发等。最后对事件进行分类整理出聚合根以及限界上下文。</p>
</blockquote>
<p>事件风暴方法通常有以下几个步骤：</p>
<ul>
<li>邀请合适的人参加</li>
<li>提供无限制的建模空间</li>
<li>发掘领域事件，可使用橙色贴纸标识</li>
<li>发掘领域事件的来源，探询命令，可使用蓝色贴纸标识。多种来源也可以- 考虑用不同颜色来区分，例如用黄色表示角色，粉色表示外部系统，红色表示时间触发。</li>
<li>寻找聚合，可用绿色贴纸标识</li>
<li>持续探索，发掘子域，BC，用户角色，验收测试标准，补充信息等。</li>
</ul>
<p>事件风暴的步骤可以如下图所示：<br><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/common/WechatIMG4.png" alt="image"></p>
<p>在我们的一次产品的重构活动中也采用了事件风暴方法。系统代码维护了10几年，代码中存在大量的“坏味道”：重复代码，过长函数，过大的类，过长的参数列表，发散式变化，霰弹式修改，镀金问题，注释不清等问题。实际研发过程中也是经常出现一点改动都可能会引起不可预测的结果，重构势在必行。</p>
<p>但是在重构过程中，也没有人可以说清楚现有系统的逻辑，如何重构成为了一个难题。重构过程我们引入了咨询公司给我们的方法，采用了事件风暴的办法，通过对领域中所发生的事情（也就是领域事件）来探索这个领域，并且使用便签来描述领域中的事件，这些便签会沿着时间轴贴到一个很大的建模面板上。</p>
<p>举例来说，能够引发事件的事情包括用户行为、外部系统所发生的事情以及时间的流逝。事件也有助于找到领域的边界，对术语的不同阐述可能就意味着存在边界。</p>
<p>准备工作，四色贴纸：</p>
<ul>
<li>橙色：事件，某个动作的结果，以“XX已XX”的方式表示，比如“用户信息已查询”</li>
<li>蓝色：属性，事件相关的输入、输出数据等</li>
<li>黄色：命令，某个动作，比如“查找用户信息”</li>
<li>绿色：实体，命令的触发者</li>
<li>开始梳理业务，将结果贴到白版上</li>
<li>继续深入梳理，将整个过程的模型、关键数据等梳理出来，贴在白板上<br>确定重构指导思路，执行重构动作，重构的同时引入单元测试保障重构的质量</li>
</ul>
<h1 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h1><p>我们先看一个简单的例子，这个 case 的业务逻辑如下：</p>
<blockquote>
<p>一个新应用在全国通过 地推业务员 做推广，需要做一个用户注册系统，同时希望在用户注册后能够通过用户电话（先假设仅限座机）的地域（区号）对业务员发奖金。</p>
</blockquote>
<p>先不要去纠结这个根据用户电话去发奖金的业务逻辑是否合理，也先不要去管用户是否应该在注册时和业务员做绑定，这里我们看的主要还是如何更加合理的去实现这个逻辑。一个简单的用户和用户注册的代码实现如下：</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    Long userId;</span><br><span class="line">    <span class="keyword">String</span> name;</span><br><span class="line">    <span class="keyword">String</span> phone;</span><br><span class="line">    <span class="keyword">String</span> address;</span><br><span class="line">    Long repId;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RegistrationServiceImpl</span> <span class="keyword"><span class="keyword">implements</span> <span class="type">RegistrationService</span></span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> SalesRepRepository salesRepRepo;</span><br><span class="line">    <span class="keyword">private</span> UserRepository userRepo;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> User register(<span class="keyword">String</span> name, <span class="keyword">String</span> phone, <span class="keyword">String</span> address) </span><br><span class="line">      throws ValidationException &#123;</span><br><span class="line">        <span class="comment">// 校验逻辑</span></span><br><span class="line">        <span class="keyword">if</span> (name == <span class="literal">null</span> || name.length() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">ValidationException</span>(<span class="string">"name"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (phone == <span class="literal">null</span> || !isValidPhoneNumber(phone)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">ValidationException</span>(<span class="string">"phone"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 此处省略address的校验逻辑</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 取电话号里的区号，然后通过区号找到区域内的SalesRep</span></span><br><span class="line">        <span class="keyword">String</span> areaCode = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">String</span>[] areas = <span class="keyword">new</span> <span class="type">String</span>[]&#123;<span class="string">"0571"</span>, <span class="string">"021"</span>, <span class="string">"010"</span>&#125;;</span><br><span class="line">        <span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt; phone.length(); i++) &#123;</span><br><span class="line">            <span class="keyword">String</span> prefix = phone.substring(<span class="number">0</span>, i);</span><br><span class="line">            <span class="keyword">if</span> (Arrays.asList(areas).contains(prefix)) &#123;</span><br><span class="line">                areaCode = prefix;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        SalesRep rep = salesRepRepo.findRep(areaCode);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 最后创建用户，落盘，然后返回</span></span><br><span class="line">        User user = <span class="keyword">new</span> <span class="type">User</span>();</span><br><span class="line">        user.name = name;</span><br><span class="line">        user.phone = phone;</span><br><span class="line">        user.address = address;</span><br><span class="line">        <span class="keyword">if</span> (rep != <span class="literal">null</span>) &#123;</span><br><span class="line">            user.repId = rep.repId;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> userRepo.save(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> boolean isValidPhoneNumber(<span class="keyword">String</span> phone) &#123;</span><br><span class="line">        <span class="keyword">String</span> pattern = <span class="string">"^0[1-9]&#123;2,3&#125;-?\\d&#123;8&#125;$"</span>;</span><br><span class="line">        <span class="keyword">return</span> phone.matches(pattern);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们日常绝大部分代码和模型其实都跟这个是类似的，乍一看貌似没啥问题，但我们再深入一步，从以下四个维度去分析一下：接口的清晰度（可阅读性）、数据验证和错误处理、业务逻辑代码的清晰度、和可测试性。</p>
<h2 id="问题1-接口的清晰度"><a href="#问题1-接口的清晰度" class="headerlink" title="问题1 - 接口的清晰度"></a>问题1 - 接口的清晰度</h2><p>在Java代码中，对于一个方法来说所有的参数名在编译时丢失，留下的仅仅是一个参数类型的列表，所以我们重新看一下以上的接口定义，其实在运行时仅仅是：</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">User</span> <span class="title">register</span>(<span class="keyword">String</span>, <span class="keyword">String</span>, <span class="keyword">String</span>);</span><br></pre></td></tr></table></figure>
<p>所以以下的代码是一段编译器完全不会报错的，很难通过看代码就能发现的 bug ：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service.<span class="keyword">register</span>(<span class="string">"殷浩"</span>, <span class="string">"浙江省杭州市余杭区文三西路969号"</span>, <span class="string">"0571-12345678"</span>);</span><br></pre></td></tr></table></figure>
<p>当然，在真实代码中运行时会报错，但这种 bug 是在运行时被发现的，而不是在编译时。普通的 Code Review 也很难发现这种问题，很有可能是代码上线后才会被暴露出来。这里的思考是，有没有办法在编码时就避免这种可能会出现的问题？</p>
<p>另外一种常见的，特别是在查询服务中容易出现的例子如下：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">User findByName(String name);</span><br><span class="line">User findByPhone(String phone);</span><br><span class="line">User findByNameAndPhone(String name, String phone);</span><br></pre></td></tr></table></figure>
<p>在这个场景下，由于入参都是 String 类型，不得不在方法名上面加上 ByXXX 来区分，而 findByNameAndPhone 同样也会陷入前面的入参顺序错误的问题，而且和前面的入参不同，这里参数顺序如果输错了，方法不会报错只会返回 null，而这种 bug 更加难被发现。这里的思考是，有没有办法让方法入参一目了然，避免入参错误导致的 bug ？</p>
<h2 id="问题2-数据验证和错误处理"><a href="#问题2-数据验证和错误处理" class="headerlink" title="问题2 - 数据验证和错误处理"></a>问题2 - 数据验证和错误处理</h2><p>在前面这段数据校验代码：<br><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (phone == <span class="literal">null</span> || !isValidPhoneNumber(phone)) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">ValidationException</span>(<span class="string">"phone"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在日常编码中经常会出现，一般来说这种代码需要出现在方法的最前端，确保能够 fail-fast 。但是假设你有多个类似的接口和类似的入参，在每个方法里这段逻辑会被重复。而更严重的是如果未来我们要拓展电话号去包含手机时，很可能需要加入以下代码：</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (phone == <span class="literal">null</span> || !isValidPhoneNumber(phone) || !isValidCellNumber(phone)) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">ValidationException</span>(<span class="string">"phone"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果你有很多个地方用到了 phone 这个入参，但是有个地方忘记修改了，会造成 bug 。这是一个 DRY 原则被违背时经常会发生的问题。</p>
<p>如果有个新的需求，需要把入参错误的原因返回，那么这段代码就变得更加复杂：</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (phone == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">ValidationException</span>(<span class="string">"phone不能为空"</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!isValidPhoneNumber(phone)) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">ValidationException</span>(<span class="string">"phone格式错误"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以想像得到，代码里充斥着大量的类似代码块时，维护成本要有多高。</p>
<p>最后，在这个业务方法里，会（隐性或显性的）抛 ValidationException，所以需要外部调用方去try/catch，而业务逻辑异常和数据校验异常被混在了一起，是否是合理的？</p>
<p>在传统Java架构里有几个办法能够去解决一部分问题，常见的如BeanValidation注解或ValidationUtils类，比如：<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Use Bean Validation</span></span><br><span class="line"><span class="selector-tag">User</span> <span class="selector-tag">registerWithBeanValidation</span>(</span><br><span class="line">  <span class="variable">@NotNull</span> <span class="variable">@NotBlank</span> String name,</span><br><span class="line">  <span class="variable">@NotNull</span> <span class="variable">@Pattern</span>(regexp = <span class="string">"^0?[1-9]&#123;2,3&#125;-?\\d&#123;8&#125;$"</span>) String phone,</span><br><span class="line">  <span class="variable">@NotNull</span> String address</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Use ValidationUtils:</span></span><br><span class="line"><span class="selector-tag">public</span> <span class="selector-tag">User</span> <span class="selector-tag">registerWithUtils</span>(String name, String phone, String address) &#123;</span><br><span class="line">    <span class="selector-tag">ValidationUtils</span><span class="selector-class">.validateName</span>(name); <span class="comment">// throws ValidationException</span></span><br><span class="line">    <span class="selector-tag">ValidationUtils</span><span class="selector-class">.validatePhone</span>(phone);</span><br><span class="line">    <span class="selector-tag">ValidationUtils</span><span class="selector-class">.validateAddress</span>(address);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>但这几个传统的方法同样有问题，</p>
<p>BeanValidation：</p>
<ul>
<li>通常只能解决简单的校验逻辑，复杂的校验逻辑一样要写代码实现定制校验器</li>
<li>在添加了新校验逻辑时，同样会出现在某些地方忘记添加一个注解的情况，DRY原则还是会被违背</li>
</ul>
<p>ValidationUtils类：</p>
<ul>
<li>当大量的校验逻辑集中在一个类里之后，违背了Single Responsibility单一性原则，导致代码混乱和不可维护</li>
<li>业务异常和校验异常还是会混杂</li>
</ul>
<p>所以，有没有一种方法，能够一劳永逸的解决所有校验的问题以及降低后续的维护成本和异常处理成本呢？</p>
<h2 id="问题3-业务代码的清晰度"><a href="#问题3-业务代码的清晰度" class="headerlink" title="问题3 - 业务代码的清晰度"></a>问题3 - 业务代码的清晰度</h2><p>在这段代码里：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">String areaCode = <span class="literal">null</span>;</span><br><span class="line">String[] areas = new String[]&#123;<span class="string">"0571"</span>, <span class="string">"021"</span>, <span class="string">"010"</span>&#125;;</span><br><span class="line"><span class="keyword">for</span> (int i = 0; i &lt; phone.length(); i++) &#123;</span><br><span class="line">    String<span class="built_in"> prefix </span>= phone.substring(0, i);</span><br><span class="line">    <span class="keyword">if</span> (Arrays.asList(areas).contains(prefix)) &#123;</span><br><span class="line">        areaCode = prefix;</span><br><span class="line">        break;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">SalesRep rep = salesRepRepo.findRep(areaCode);</span><br></pre></td></tr></table></figure>
<p>实际上出现了另外一种常见的情况，那就是从一些入参里抽取一部分数据，然后调用一个外部依赖获取更多的数据，然后通常从新的数据中再抽取部分数据用作其他的作用。这种代码通常被称作“胶水代码”，其本质是由于外部依赖的服务的入参并不符合我们原始的入参导致的。比如，如果SalesRepRepository包含一个findRepByPhone的方法，则上面大部分的代码都不必要了。</p>
<p>所以，一个常见的办法是将这段代码抽离出来，变成独立的一个或多个方法：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">private static String findAreaCode(String phone) &#123;</span><br><span class="line">    <span class="keyword">for</span> (int i = 0; i &lt; phone.length(); i++) &#123;</span><br><span class="line">        String<span class="built_in"> prefix </span>= phone.substring(0, i);</span><br><span class="line">        <span class="keyword">if</span> (isAreaCode(prefix)) &#123;</span><br><span class="line">            return prefix;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private static boolean isAreaCode(String prefix) &#123;</span><br><span class="line">    String[] areas = new String[]&#123;<span class="string">"0571"</span>, <span class="string">"021"</span>&#125;;</span><br><span class="line">    return Arrays.asList(areas).contains(prefix);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后原始代码变为：</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">String areaCode</span> = findAreaCode(phone);</span><br><span class="line"><span class="attribute">SalesRep rep</span> = salesRepRepo.findRep(areaCode);</span><br></pre></td></tr></table></figure>
<p>而为了复用以上的方法，可能会抽离出一个静态工具类 PhoneUtils 。但是这里要思考的是，静态工具类是否是最好的实现方式呢？当你的项目里充斥着大量的静态工具类，业务代码散在多个文件当中时，你是否还能找到核心的业务逻辑呢？</p>
<h2 id="问题4-可测试性"><a href="#问题4-可测试性" class="headerlink" title="问题4 - 可测试性"></a>问题4 - 可测试性</h2><p>为了保证代码质量，每个方法里的每个入参的每个可能出现的条件都要有 TC 覆盖（假设我们先不去测试内部业务逻辑），所以在我们这个方法里需要以下的 TC ：</p>
<p>假如一个方法有 N 个参数，每个参数有 M 个校验逻辑，至少要有 N * M 个 TC 。</p>
<p>如果这时候在该方法中加入一个新的入参字段 fax ，即使 fax 和 phone 的校验逻辑完全一致，为了保证 TC 覆盖率，也一样需要 M 个新的 TC 。</p>
<p>而假设有 P 个方法中都用到了 phone 这个字段，这 P 个方法都需要对该字段进行测试，也就是说整体需要：</p>
<p>P <em> N </em> M</p>
<p>个测试用例才能完全覆盖所有数据验证的问题，在日常项目中，这个测试的成本非常之高，导致大量的代码没被覆盖到。而没被测试覆盖到的代码才是最有可能出现问题的地方。</p>
<p>在这个情况下，降低测试成本 == 提升代码质量，如何能够降低测试的成本呢？</p>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>我们回头先重新看一下原始的 use case，并且标注其中可能重要的概念：</p>
<p>一个新应用在全国通过 地推业务员 做推广，需要做一个用户的注册系统，在用户注册后能够通过用户电话号的区号对业务员发奖金。</p>
<p>在分析了 use case 后，发现其中地推业务员、用户本身自带 ID 属性，属于 Entity（实体），而注册系统属于 Application Service（应用服务），这几个概念已经有存在。但是发现电话号这个概念却完全被隐藏到了代码之中。我们可以问一下自己，取电话号的区号的逻辑是否属于用户（用户的区号？）？是否属于注册服务（注册的区号？）？如果都不是很贴切，那就说明这个逻辑应该属于一个独立的概念。所以这里引入我们第一个原则：</p>
<p>Make Implicit Concepts Explicit</p>
<h3 id="将隐性的概念显性化"><a href="#将隐性的概念显性化" class="headerlink" title="将隐性的概念显性化"></a>将隐性的概念显性化</h3><p>在这里，我们可以看到，原来电话号仅仅是用户的一个参数，属于隐形概念，但实际上电话号的区号才是真正的业务逻辑，而我们需要将电话号的概念显性化，通过写一个Value Object：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> PhoneNumber &#123;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> final <span class="built_in">String</span> <span class="built_in">number</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">String</span> getNumber() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">number</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> PhoneNumber(<span class="built_in">String</span> <span class="built_in">number</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">number</span> == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ValidationException(<span class="string">"number不能为空"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isValid(<span class="built_in">number</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ValidationException(<span class="string">"number格式错误"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.number = <span class="built_in">number</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">String</span> getAreaCode() &#123;</span><br><span class="line">        <span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt; <span class="built_in">number</span>.length(); i++) &#123;</span><br><span class="line">            <span class="built_in">String</span> prefix = <span class="built_in">number</span>.substring(<span class="number">0</span>, i);</span><br><span class="line">            <span class="keyword">if</span> (isAreaCode(prefix)) &#123;</span><br><span class="line">                <span class="keyword">return</span> prefix;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">boolean</span> isAreaCode(<span class="built_in">String</span> prefix) &#123;</span><br><span class="line">        <span class="built_in">String</span>[] areas = <span class="keyword">new</span> <span class="built_in">String</span>[]&#123;<span class="string">"0571"</span>, <span class="string">"021"</span>, <span class="string">"010"</span>&#125;;</span><br><span class="line">        <span class="keyword">return</span> Arrays.asList(areas).contains(prefix);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">boolean</span> isValid(<span class="built_in">String</span> <span class="built_in">number</span>) &#123;</span><br><span class="line">        <span class="built_in">String</span> pattern = <span class="string">"^0?[1-9]&#123;2,3&#125;-?\\d&#123;8&#125;$"</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">number</span>.matches(pattern);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里面有几个很重要的元素：</p>
<ul>
<li>通过 private final String number 确保 PhoneNumber 是一个（Immutable）Value Object。（一般来说 VO 都是 Immutable 的，这里只是重点强调一下）</li>
<li>校验逻辑都放在了 constructor 里面，确保只要 PhoneNumber 类被创建出来后，一定是校验通过的。</li>
<li>之前的 findAreaCode 方法变成了 PhoneNumber 类里的 getAreaCode ，突出了 areaCode 是 PhoneNumber 的一个计算属性。</li>
</ul>
<p>这样做完之后，我们发现把 PhoneNumber 显性化之后，其实是生成了一个 Type（数据类型）和一个 Class（类）：</p>
<ul>
<li>Type 指我们在今后的代码里可以通过 PhoneNumber 去显性的标识电话号这个概念</li>
<li>Class 指我们可以把所有跟电话号相关的逻辑完整的收集到一个文件里<br>这两个概念加起来，构造成了本文标题的 Domain Primitive（DP）。</li>
</ul>
<p>我们看一下全面使用了 DP 之后效果：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> &#123;</span></span><br><span class="line">    UserId userId;</span><br><span class="line">    Name name;</span><br><span class="line">    PhoneNumber phone;</span><br><span class="line">    Address address;</span><br><span class="line">    RepId repId;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> User register(</span><br><span class="line">  <span class="meta">@NotNull</span> Name name,</span><br><span class="line">  <span class="meta">@NotNull</span> PhoneNumber phone,</span><br><span class="line">  <span class="meta">@NotNull</span> Address address</span><br><span class="line">) &#123;</span><br><span class="line">    <span class="comment">// 找到区域内的SalesRep</span></span><br><span class="line">    SalesRep rep = salesRepRepo.findRep(phone.getAreaCode());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 最后创建用户，落盘，然后返回，这部分代码实际上也能用Builder解决</span></span><br><span class="line">    User user = <span class="keyword">new</span> User();</span><br><span class="line">    user.name = name;</span><br><span class="line">    user.phone = phone;</span><br><span class="line">    user.address = address;</span><br><span class="line">    <span class="keyword">if</span> (rep != <span class="literal">null</span>) &#123;</span><br><span class="line">        user.repId = rep.repId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> userRepo.saveUser(user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们可以看到在使用了 DP 之后，所有的数据验证逻辑和非业务流程的逻辑都消失了，剩下都是核心业务逻辑，可以一目了然。我们重新用上面的四个维度评估一下：</p>
<h2 id="评估1-接口的清晰度"><a href="#评估1-接口的清晰度" class="headerlink" title="评估1 - 接口的清晰度"></a>评估1 - 接口的清晰度</h2><p>重构后的方法签名变成了很清晰的：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public<span class="built_in"> User </span>register(Name, PhoneNumber, Address)</span><br></pre></td></tr></table></figure>
<p>而之前容易出现的bug，如果按照现在的写法</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service.register(<span class="keyword">new</span> <span class="type">Name</span>(<span class="string">"殷浩"</span>), <span class="keyword">new</span> <span class="type">Address</span>(<span class="string">"浙江省杭州市余杭区文三西路969号"</span>), <span class="keyword">new</span> <span class="type">PhoneNumber</span>(<span class="string">"0571-12345678"</span>));</span><br></pre></td></tr></table></figure>
<p>让接口 API 变得很干净，易拓展。</p>
<h2 id="评估2-数据验证和错误处理"><a href="#评估2-数据验证和错误处理" class="headerlink" title="评估2 - 数据验证和错误处理"></a>评估2 - 数据验证和错误处理</h2><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">public</span> <span class="selector-tag">User</span> <span class="selector-tag">register</span>(</span><br><span class="line">  <span class="variable">@NotNull</span> Name name,</span><br><span class="line">  <span class="variable">@NotNull</span> PhoneNumber phone,</span><br><span class="line">  <span class="variable">@NotNull</span> Address address</span><br><span class="line">) <span class="comment">// no throws</span></span><br></pre></td></tr></table></figure>
<p>如前文代码展示的，重构后的方法里，完全没有了任何数据验证的逻辑，也不会抛 ValidationException 。原因是因为 DP 的特性，只要是能够带到入参里的一定是正确的或 null（Bean Validation 或 lombok 的注解能解决 null 的问题）。所以我们把数据验证的工作量前置到了调用方，而调用方本来就是应该提供合法数据的，所以更加合适。</p>
<p>再展开来看，使用DP的另一个好处就是代码遵循了 DRY 原则和单一性原则，如果未来需要修改 PhoneNumber 的校验逻辑，只需要在一个文件里修改即可，所有使用到了 PhoneNumber 的地方都会生效。</p>
<h2 id="评估3-业务代码的清晰度"><a href="#评估3-业务代码的清晰度" class="headerlink" title="评估3 - 业务代码的清晰度"></a>评估3 - 业务代码的清晰度</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SalesRep rep = salesRepRepo.findRep(phone.getAreaCode());</span><br><span class="line">User<span class="built_in"> user </span>= xxx;</span><br><span class="line">return userRepo.save(user);</span><br></pre></td></tr></table></figure>
<p>除了在业务方法里不需要校验数据之外，原来的一段胶水代码 findAreaCode 被改为了 PhoneNumber 类的一个计算属性 getAreaCode ，让代码清晰度大大提升。而且胶水代码通常都不可复用，但是使用了 DP 后，变成了可复用、可测试的代码。我们能看到，在刨除了数据验证代码、胶水代码之后，剩下的都是核心业务逻辑。（ Entity 相关的重构在后面文章会谈到，这次先忽略）</p>
<h2 id="评估4-可测试性"><a href="#评估4-可测试性" class="headerlink" title="评估4 - 可测试性"></a>评估4 - 可测试性</h2><p>当我们将 PhoneNumber 抽取出来之后，在来看测试的 TC ：</p>
<p>首先 PhoneNumber 本身还是需要 M 个测试用例，但是由于我们只需要测试单一对象，每个用例的代码量会大大降低，维护成本降低。<br>每个方法里的每个参数，现在只需要覆盖为 null 的情况就可以了，其他的 case 不可能发生（因为只要不是 null 就一定是合法的）<br>所以，单个方法的 TC 从原来的 N * M 变成了今天的 N + M 。同样的，多个方法的 TC 数量变成了</p>
<p>N + M + P</p>
<p>这个数量一般来说要远低于原来的数量 N<em> M </em> P ，让测试成本极大的降低。</p>
<h2 id="评估总结"><a href="#评估总结" class="headerlink" title="评估总结"></a>评估总结</h2><h2 id="进阶使用"><a href="#进阶使用" class="headerlink" title="进阶使用"></a>进阶使用</h2><p>在上文我介绍了 DP 的第一个原则：将隐性的概念显性化。在这里我将介绍 DP 的另外两个原则，用一个新的案例。</p>
<h2 id="▍案例1-转账"><a href="#▍案例1-转账" class="headerlink" title="▍案例1 - 转账"></a>▍案例1 - 转账</h2><p>假设现在要实现一个功能，让A用户可以支付 x 元给用户 B ，可能的实现如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pay</span><span class="params">(BigDecimal money, Long recipientId)</span> </span>&#123;</span><br><span class="line">    BankService.transfer(money, <span class="string">"CNY"</span>, recipientId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果这个是境内转账，并且境内的货币永远不变，该方法貌似没啥问题，但如果有一天货币变更了（比如欧元区曾经出现的问题），或者我们需要做跨境转账，该方法是明显的 bug ，因为 money 对应的货币不一定是 CNY 。</p>
<p>在这个 case 里，当我们说“支付 x 元”时，除了 x 本身的数字之外，实际上是有一个隐含的概念那就是货币“元”。但是在原始的入参里，之所以只用了 BigDecimal 的原因是我们认为 CNY 货币是默认的，是一个隐含的条件，但是在我们写代码时，需要把所有隐性的条件显性化，而这些条件整体组成当前的上下文。所以 DP 的第二个原则是：</p>
<p>Make Implicit Context Explicit</p>
<p>将 隐性的 上下文 显性化</p>
<p>所以当我们做这个支付功能时，实际上需要的一个入参是支付金额 + 支付货币。我们可以把这两个概念组合成为一个独立的完整概念：Money。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Value</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Money</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> BigDecimal amount;</span><br><span class="line">    <span class="keyword">private</span> Currency currency;</span><br><span class="line">    <span class="keyword">public</span> Money(BigDecimal amount, Currency currency) &#123;</span><br><span class="line">        <span class="keyword">this</span>.amount = amount;</span><br><span class="line">        <span class="keyword">this</span>.currency = currency;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而原有的代码则变为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pay</span><span class="params">(Money money, Long recipientId)</span> </span>&#123;</span><br><span class="line">    BankService.transfer(money, recipientId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过将默认货币这个隐性的上下文概念显性化，并且和金额合并为 Money ，我们可以避免很多当前看不出来，但未来可能会暴雷的bug。</p>
<h2 id="案例2-跨境转账"><a href="#案例2-跨境转账" class="headerlink" title="案例2 - 跨境转账"></a>案例2 - 跨境转账</h2><p>前面的案例升级一下，假设用户可能要做跨境转账从 CNY 到 USD ，并且货币汇率随时在波动：</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public void pay(Money money, Currency targetCurrency, Long recipientId) &#123;</span><br><span class="line">    if (money.getCurrency().equals(targetCurrency)) &#123;</span><br><span class="line">        <span class="keyword">BankService.transfer(money, </span>recipientId)<span class="comment">;</span></span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        <span class="keyword">BigDecimal </span>rate = ExchangeService.getRate(money.getCurrency(), targetCurrency)<span class="comment">;</span></span><br><span class="line">        <span class="keyword">BigDecimal </span>targetAmount = money.getAmount().<span class="keyword">multiply(new </span><span class="keyword">BigDecimal(rate));</span></span><br><span class="line"><span class="keyword"> </span>       Money targetMoney = new Money(targetAmount, targetCurrency)<span class="comment">;</span></span><br><span class="line">        <span class="keyword">BankService.transfer(targetMoney, </span>recipientId)<span class="comment">;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这个case里，由于 targetCurrency 不一定和 money 的 Curreny 一致，需要调用一个服务去取汇率，然后做计算。最后用计算后的结果做转账。</p>
<p>这个case最大的问题在于，金额的计算被包含在了支付的服务中，涉及到的对象也有2个 Currency ，2 个 Money ，1 个 BigDecimal ，总共 5 个对象。这种涉及到多个对象的业务逻辑，需要用 DP 包装掉，所以这里引出 DP 的第三个原则：</p>
<p>Encapsulate Multi-Object Behavior</p>
<p>封装 多对象 行为</p>
<p>在这个 case 里，可以将转换汇率的功能，封装到一个叫做 ExchangeRate 的 DP 里：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">@Value</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ExchangeRate</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> BigDecimal rate;</span><br><span class="line">    <span class="keyword">private</span> Currency <span class="keyword">from</span>;</span><br><span class="line">    <span class="keyword">private</span> Currency to;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ExchangeRate</span>(<span class="params">BigDecimal rate, Currency <span class="keyword">from</span>, Currency to</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.rate = rate;</span><br><span class="line">        <span class="keyword">this</span>.<span class="keyword">from</span> = <span class="keyword">from</span>;</span><br><span class="line">        <span class="keyword">this</span>.to = to;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Money <span class="title">exchange</span>(<span class="params">Money fromMoney</span>) </span>&#123;</span><br><span class="line">        notNull(fromMoney);</span><br><span class="line">        isTrue(<span class="keyword">this</span>.<span class="keyword">from</span>.<span class="keyword">equals</span>(fromMoney.getCurrency()));</span><br><span class="line">        BigDecimal targetAmount = fromMoney.getAmount().multiply(rate);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Money(targetAmount, to);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ExchangeRate汇率对象，通过封装金额计算逻辑以及各种校验逻辑，让原始代码变得极其简单：<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public void pay(Money money, Currency targetCurrency, Long recipientId) &#123;</span><br><span class="line">    ExchangeRate rate = ExchangeService.getRate(money.getCurrency(), targetCurrency)<span class="comment">;</span></span><br><span class="line">    Money targetMoney = rate.exchange(money)<span class="comment">;</span></span><br><span class="line">    <span class="keyword">BankService.transfer(targetMoney, </span>recipientId)<span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="讨论和总结"><a href="#讨论和总结" class="headerlink" title="讨论和总结"></a>讨论和总结</h2><h3 id="▍Domain-Primitive-的定义"><a href="#▍Domain-Primitive-的定义" class="headerlink" title="▍Domain Primitive 的定义"></a>▍Domain Primitive 的定义</h3><p>让我们重新来定义一下 Domain Primitive ：Domain Primitive 是一个在特定领域里，拥有精准定义的、可自我验证的、拥有行为的 Value Object 。</p>
<p>DP是一个传统意义上的Value Object，拥有Immutable的特性<br>DP是一个完整的概念整体，拥有精准定义<br>DP使用业务域中的原生语言<br>DP可以是业务域的最小组成部分、也可以构建复杂组合<br>注：Domain Primitive的概念和命名来自于Dan Bergh Johnsson &amp; Daniel Deogun的书 Secure by Design。</p>
<h3 id="▍使用-Domain-Primitive-的三原则"><a href="#▍使用-Domain-Primitive-的三原则" class="headerlink" title="▍使用 Domain Primitive 的三原则"></a>▍使用 Domain Primitive 的三原则</h3><p>让隐性的概念显性化<br>让隐性的上下文显性化<br>封装多对象行为</p>
<h3 id="▍Domain-Primitive-和-DDD-里-Value-Object-的区别"><a href="#▍Domain-Primitive-和-DDD-里-Value-Object-的区别" class="headerlink" title="▍Domain Primitive 和 DDD 里 Value Object 的区别"></a>▍Domain Primitive 和 DDD 里 Value Object 的区别</h3><p>在 DDD 中， Value Object 这个概念其实已经存在：</p>
<p>在 Evans 的 DDD 蓝皮书中，Value Object 更多的是一个非 Entity 的值对象<br>在Vernon的IDDD红皮书中，作者更多的关注了Value Object的Immutability、Equals方法、Factory方法等<br>Domain Primitive 是 Value Object 的进阶版，在原始 VO 的基础上要求每个 DP 拥有概念的整体，而不仅仅是值对象。在 VO 的 Immutable 基础上增加了 Validity 和行为。当然同样的要求无副作用（side-effect free）。</p>
<h3 id="▍Domain-Primitive-和-Data-Transfer-Object-DTO-的区别"><a href="#▍Domain-Primitive-和-Data-Transfer-Object-DTO-的区别" class="headerlink" title="▍Domain Primitive 和 Data Transfer Object (DTO) 的区别"></a>▍Domain Primitive 和 Data Transfer Object (DTO) 的区别</h3><p>在日常开发中经常会碰到的另一个数据结构是 DTO ，比如方法的入参和出参。DP 和 DTO 的区别如下：</p>
<h3 id="▍什么情况下应该用-Domain-Primitive"><a href="#▍什么情况下应该用-Domain-Primitive" class="headerlink" title="▍什么情况下应该用 Domain Primitive"></a>▍什么情况下应该用 Domain Primitive</h3><p>常见的 DP 的使用场景包括：</p>
<p>有格式限制的 String：比如Name，PhoneNumber，OrderNumber，ZipCode，Address等<br>有限制的Integer：比如OrderId（&gt;0），Percentage（0-100%），Quantity（&gt;=0）等<br>可枚举的 int ：比如 Status（一般不用Enum因为反序列化问题）<br>Double 或 BigDecimal：一般用到的 Double 或 BigDecimal 都是有业务含义的，比如 Temperature、Money、Amount、ExchangeRate、Rating 等<br>复杂的数据结构：比如 Map&lt;String, List<integer>&gt; 等，尽量能把 Map 的所有操作包装掉，仅暴露必要行为</integer></p>
<h2 id="实战-老应用重构的流程"><a href="#实战-老应用重构的流程" class="headerlink" title="实战 - 老应用重构的流程"></a>实战 - 老应用重构的流程</h2><p>在新应用中使用 DP 是比较简单的，但在老应用中使用 DP 是可以遵循以下流程按部就班的升级。在此用本文的第一个 case 为例。</p>
<h3 id="▍第一步-创建-Domain-Primitive，收集所有-DP-行为"><a href="#▍第一步-创建-Domain-Primitive，收集所有-DP-行为" class="headerlink" title="▍第一步 - 创建 Domain Primitive，收集所有 DP 行为"></a>▍第一步 - 创建 Domain Primitive，收集所有 DP 行为</h3><p>在前文中，我们发现取电话号的区号这个是一个可以独立出来的、可以放入 PhoneNumber 这个 Class 的逻辑。类似的，在真实的项目中，以前散落在各个服务或工具类里面的代码，可以都抽出来放在 DP 里，成为 DP 自己的行为或属性。这里面的原则是：所有抽离出来的方法要做到无状态，比如原来是 static 的方法。如果原来的方法有状态变更，需要将改变状态的部分和不改状态的部分分离，然后将无状态的部分融入 DP 。因为 DP 本身不能带状态，所以一切需要改变状态的代码都不属于 DP 的范畴。</p>
<p>(代码参考 PhoneNumber 的代码，这里不再重复)</p>
<h3 id="▍第二步-替换数据校验和无状态逻辑"><a href="#▍第二步-替换数据校验和无状态逻辑" class="headerlink" title="▍第二步 - 替换数据校验和无状态逻辑"></a>▍第二步 - 替换数据校验和无状态逻辑</h3><p>为了保障现有方法的兼容性，在第二步不会去修改接口的签名，而是通过代码替换原有的校验逻辑和根 DP 相关的业务逻辑。比如：</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> User register(<span class="keyword">String</span> name, <span class="keyword">String</span> phone, <span class="keyword">String</span> address)</span><br><span class="line">        throws ValidationException &#123;</span><br><span class="line">    <span class="keyword">if</span> (name == <span class="literal">null</span> || name.length() == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">ValidationException</span>(<span class="string">"name"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (phone == <span class="literal">null</span> || !isValidPhoneNumber(phone)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">ValidationException</span>(<span class="string">"phone"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">String</span> areaCode = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">String</span>[] areas = <span class="keyword">new</span> <span class="type">String</span>[]&#123;<span class="string">"0571"</span>, <span class="string">"021"</span>, <span class="string">"010"</span>&#125;;</span><br><span class="line">    <span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt; phone.length(); i++) &#123;</span><br><span class="line">        <span class="keyword">String</span> prefix = phone.substring(<span class="number">0</span>, i);</span><br><span class="line">        <span class="keyword">if</span> (Arrays.asList(areas).contains(prefix)) &#123;</span><br><span class="line">            areaCode = prefix;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    SalesRep rep = salesRepRepo.findRep(areaCode);</span><br><span class="line">    <span class="comment">// 其他代码...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过 DP 替换代码后：</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> User register(<span class="keyword">String</span> name, <span class="keyword">String</span> phone, <span class="keyword">String</span> address)</span><br><span class="line">        throws ValidationException &#123;</span><br><span class="line">    </span><br><span class="line">    Name _name = <span class="keyword">new</span> <span class="type">Name</span>(name);</span><br><span class="line">    PhoneNumber _phone = <span class="keyword">new</span> <span class="type">PhoneNumber</span>(phone);</span><br><span class="line">    Address _address = <span class="keyword">new</span> <span class="type">Address</span>(address);</span><br><span class="line">    </span><br><span class="line">    SalesRep rep = salesRepRepo.findRep(_phone.getAreaCode());</span><br><span class="line">    <span class="comment">// 其他代码...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过 new PhoneNumber(phone) 这种代码，替代了原有的校验代码。</p>
<p>通过 _phone.getAreaCode() 替换了原有的无状态的业务逻辑。</p>
<p>▍第三步 - 创建新接口<br>创建新接口，将DP的代码提升到接口参数层：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public<span class="built_in"> User </span>register(Name name, PhoneNumber phone,<span class="built_in"> Address </span>address) &#123;</span><br><span class="line">    SalesRep rep = salesRepRepo.findRep(phone.getAreaCode());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>▍第四步 - 修改外部调用</p>
<p>外部调用方需要修改调用链路，比如：</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">service.register(<span class="string">"殷浩"</span>, <span class="string">"0571-12345678"</span>, <span class="string">"浙江省杭州市余杭区文三西路969号"</span>);</span><br><span class="line">改为：</span><br><span class="line"></span><br><span class="line">service.register(<span class="keyword">new</span> <span class="type">Name</span>(<span class="string">"殷浩"</span>), <span class="keyword">new</span> <span class="type">PhoneNumber</span>(<span class="string">"0571-12345678"</span>), <span class="keyword">new</span> <span class="type">Address</span>(<span class="string">"浙江省杭州市余杭区文三西路969号"</span>));</span><br></pre></td></tr></table></figure>
<p>通过以上 4 步，就能让你的代码变得更加简洁、优雅、健壮、安全。你还在等什么？今天就去尝试吧！</p>
<h1 id="应用架构设计"><a href="#应用架构设计" class="headerlink" title="应用架构设计"></a>应用架构设计</h1><p>设计原则</p>
<ul>
<li>单一性原则（Single Responsibility Principle）：单一性原则要求一个对象/类应该只有一个变更的原因。但是在这个案例里，代码可能会因为任意一个外部依赖或计算逻辑的改变而改变。</li>
<li>依赖反转原则（Dependency Inversion Principle）：依赖反转原则要求在代码中依赖抽象，而不是具体的实现。在这个案例里外部依赖都是具体的实现，比如YahooForexService虽然是一个接口类，但是它对应的是依赖了Yahoo提供的具体服务，所以也算是依赖了实现。同样的KafkaTemplate、MyBatis的DAO实现都属于具体实现。</li>
<li>开放封闭原则（Open Closed Principle）：开放封闭原则指开放扩展，但是封闭修改。在这个案例里的金额计算属于可能会被修改的代码，这个时候该逻辑应该需要被包装成为不可修改的计算类，新功能通过计算类的拓展实现。</li>
</ul>
<h2 id="需求背景"><a href="#需求背景" class="headerlink" title="需求背景"></a>需求背景</h2><p>我们先看一个简单的案例需求如下：</p>
<p>用户可以通过银行网页转账给另一个账号，支持跨币种转账。</p>
<p>同时因为监管和对账需求，需要记录本次转账活动。</p>
<p>拿到这个需求之后，一个开发可能会经历一些技术选型，最终可能拆解需求如下：</p>
<p>1、从MySql数据库中找到转出和转入的账户，选择用 MyBatis 的 mapper 实现 DAO；2、从 Yahoo（或其他渠道）提供的汇率服务获取转账的汇率信息（底层是 http 开放接口）；</p>
<p>3、计算需要转出的金额，确保账户有足够余额，并且没超出每日转账上限；</p>
<p>4、实现转入和转出操作，扣除手续费，保存数据库；</p>
<p>5、发送 Kafka 审计消息，以便审计和对账用；</p>
<p>而一个简单的代码实现如下：<br><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransferController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> TransferService transferService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Result&lt;Boolean&gt; transfer(<span class="keyword">String</span> targetAccountNumber, BigDecimal amount, HttpSession session) &#123;</span><br><span class="line">        Long userId = (Long) session.getAttribute(<span class="string">"userId"</span>);</span><br><span class="line">        <span class="keyword">return</span> transferService.transfer(userId, targetAccountNumber, amount, <span class="string">"CNY"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransferServiceImpl</span> <span class="keyword"><span class="keyword">implements</span> <span class="type">TransferService</span></span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> final <span class="keyword">String</span> TOPIC_AUDIT_LOG = <span class="string">"TOPIC_AUDIT_LOG"</span>;</span><br><span class="line">    <span class="keyword">private</span> AccountMapper accountDAO;</span><br><span class="line">    <span class="keyword">private</span> KafkaTemplate&lt;<span class="keyword">String</span>, <span class="keyword">String</span>&gt; kafkaTemplate;</span><br><span class="line">    <span class="keyword">private</span> YahooForexService yahooForex;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    <span class="keyword">public</span> Result&lt;Boolean&gt; transfer(Long sourceUserId, <span class="keyword">String</span> targetAccountNumber, BigDecimal targetAmount, <span class="keyword">String</span> targetCurrency) &#123;</span><br><span class="line">        <span class="comment">// 1. 从数据库读取数据，忽略所有校验逻辑如账号是否存在等</span></span><br><span class="line">        AccountDO sourceAccountDO = accountDAO.selectByUserId(sourceUserId);</span><br><span class="line">        AccountDO targetAccountDO = accountDAO.selectByAccountNumber(targetAccountNumber);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 业务参数校验</span></span><br><span class="line">        <span class="keyword">if</span> (!targetAccountDO.getCurrency().equals(targetCurrency)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">InvalidCurrencyException</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 获取外部数据，并且包含一定的业务逻辑</span></span><br><span class="line">        <span class="comment">// exchange rate = 1 source currency = X target currency</span></span><br><span class="line">        BigDecimal exchangeRate = BigDecimal.ONE;</span><br><span class="line">        <span class="keyword">if</span> (sourceAccountDO.getCurrency().equals(targetCurrency)) &#123;</span><br><span class="line">            exchangeRate = yahooForex.getExchangeRate(sourceAccountDO.getCurrency(), targetCurrency);</span><br><span class="line">        &#125;</span><br><span class="line">        BigDecimal sourceAmount = targetAmount.divide(exchangeRate, RoundingMode.DOWN);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. 业务参数校验</span></span><br><span class="line">        <span class="keyword">if</span> (sourceAccountDO.getAvailable().compareTo(sourceAmount) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">InsufficientFundsException</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (sourceAccountDO.getDailyLimit().compareTo(sourceAmount) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">DailyLimitExceededException</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. 计算新值，并且更新字段</span></span><br><span class="line">        BigDecimal <span class="keyword">new</span><span class="type">Source</span> = sourceAccountDO.getAvailable().subtract(sourceAmount);</span><br><span class="line">        BigDecimal <span class="keyword">new</span><span class="type">Target</span> = targetAccountDO.getAvailable().add(targetAmount);</span><br><span class="line">        sourceAccountDO.setAvailable(<span class="keyword">new</span><span class="type">Source</span>);</span><br><span class="line">        targetAccountDO.setAvailable(<span class="keyword">new</span><span class="type">Target</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6. 更新到数据库</span></span><br><span class="line">        accountDAO.update(sourceAccountDO);</span><br><span class="line">        accountDAO.update(targetAccountDO);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7. 发送审计消息</span></span><br><span class="line">        <span class="keyword">String</span> message = sourceUserId + <span class="string">","</span> + targetAccountNumber + <span class="string">","</span> + targetAmount + <span class="string">","</span> + targetCurrency;</span><br><span class="line">        kafkaTemplate.send(TOPIC_AUDIT_LOG, message);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.success(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="流程图"><a href="#流程图" class="headerlink" title="流程图"></a>流程图</h2><p>在重构之前，我们先画一张流程图，描述当前代码在做的每个步骤：<br><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/DDD%E9%A2%86%E5%9F%9F%E9%A9%B1%E5%8A%A8%E8%AE%BE%E8%AE%A1.jpeg" alt="image"></p>
<p>这是一个传统的三层分层结构：UI层、业务层、和基础设施层。上层对于下层有直接的依赖关系，导致耦合度过高。在业务层中对于下层的基础设施有强依赖，耦合度高。我们需要对这张图上的每个节点做抽象和整理，来降低对外部依赖的耦合度。</p>
<h2 id="抽象数据存储层"><a href="#抽象数据存储层" class="headerlink" title="抽象数据存储层"></a>抽象数据存储层</h2><p>第一步常见的操作是将Data Access层做抽象，降低系统对数据库的直接依赖。具体的方法如下：</p>
<p>新建Account实体对象：一个实体（Entity）是拥有ID的域对象，除了拥有数据之外，同时拥有行为。Entity和数据库储存格式无关，在设计中要以该领域的通用严谨语言（Ubiquitous Language）为依据。<br>新建对象储存接口类AccountRepository：Repository只负责Entity对象的存储和读取，而Repository的实现类完成数据库存储的细节。通过加入Repository接口，底层的数据库连接可以通过不同的实现类而替换。</p>
<p>具体的简单代码实现如下：</p>
<p>Account实体类：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Account</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> AccountId id;</span><br><span class="line">    <span class="keyword">private</span> AccountNumber accountNumber;</span><br><span class="line">    <span class="keyword">private</span> UserId userId;</span><br><span class="line">    <span class="keyword">private</span> Money available;</span><br><span class="line">    <span class="keyword">private</span> Money dailyLimit;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">withdraw</span><span class="params">(Money money)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 转出</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deposit</span><span class="params">(Money money)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 转入</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>和AccountRepository及MyBatis实现类：<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AccountRepository</span> </span>&#123;</span><br><span class="line">    <span class="function">Account <span class="title">find</span><span class="params">(AccountId id)</span></span>;</span><br><span class="line">    <span class="function">Account <span class="title">find</span><span class="params">(AccountNumber accountNumber)</span></span>;</span><br><span class="line">    <span class="function">Account <span class="title">find</span><span class="params">(UserId userId)</span></span>;</span><br><span class="line">    <span class="function">Account <span class="title">save</span><span class="params">(Account account)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccountRepositoryImpl</span> <span class="keyword">implements</span> <span class="title">AccountRepository</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AccountMapper accountDAO;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AccountBuilder accountBuilder;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function">Account <span class="title">find</span><span class="params">(AccountId id)</span> </span>&#123;</span><br><span class="line">        AccountDO accountDO = accountDAO.selectById(id.getValue());</span><br><span class="line">        <span class="function"><span class="keyword">return</span> accountBuilder.<span class="title">toAccount</span><span class="params">(accountDO)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function">Account <span class="title">find</span><span class="params">(AccountNumber accountNumber)</span> </span>&#123;</span><br><span class="line">        AccountDO accountDO = accountDAO.selectByAccountNumber(accountNumber.getValue());</span><br><span class="line">        <span class="function"><span class="keyword">return</span> accountBuilder.<span class="title">toAccount</span><span class="params">(accountDO)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function">Account <span class="title">find</span><span class="params">(UserId userId)</span> </span>&#123;</span><br><span class="line">        AccountDO accountDO = accountDAO.selectByUserId(userId.getId());</span><br><span class="line">        <span class="function"><span class="keyword">return</span> accountBuilder.<span class="title">toAccount</span><span class="params">(accountDO)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function">Account <span class="title">save</span><span class="params">(Account account)</span> </span>&#123;</span><br><span class="line">        AccountDO accountDO = accountBuilder.fromAccount(account);</span><br><span class="line">        <span class="keyword">if</span> (accountDO.getId() == <span class="keyword">null</span>) &#123;</span><br><span class="line">            accountDAO.insert(accountDO);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            accountDAO.update(accountDO);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">return</span> accountBuilder.<span class="title">toAccount</span><span class="params">(accountDO)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Account实体类和AccountDO数据类的对比如下：</p>
<ul>
<li>Data Object数据类：AccountDO是单纯的和数据库表的映射关系，每个字段对应数据库表的一个column，这种对象叫Data Object。DO只有数据，没有行为。AccountDO的作用是对数据库做快速映射，避免直接在代码里写SQL。无论你用的是MyBatis还是Hibernate这种ORM，从数据库来的都应该先直接映射到DO上，但是代码里应该完全避免直接操作 DO。</li>
<li>Entity实体类：Account 是基于领域逻辑的实体类，它的字段和数据库储存不需要有必然的联系。Entity包含数据，同时也应该包含行为。在 Account 里，字段也不仅仅是String等基础类型，而应该尽可能用上一讲的 Domain Primitive 代替，可以避免大量的校验代码。</li>
</ul>
<p>DAO 和 Repository 类的对比如下：</p>
<ul>
<li>DAO对应的是一个特定的数据库类型的操作，相当于SQL的封装。所有操作的对象都是DO类，所有接口都可以根据数据库实现的不同而改变。比如，insert 和 update 属于数据库专属的操作。</li>
<li>Repository对应的是Entity对象读取储存的抽象，在接口层面做统一，不关注底层实现。比如，通过 save 保存一个Entity对象，但至于具体是 insert 还是 update 并不关心。Repository的具体实现类通过调用DAO来实现各种操作，通过Builder/Factory对象实现AccountDO 到 Account之间的转化</li>
</ul>
<h3 id="Repository和Entity"><a href="#Repository和Entity" class="headerlink" title="Repository和Entity"></a>Repository和Entity</h3><ul>
<li>通过Account对象，避免了其他业务逻辑代码和数据库的直接耦合，避免了当数据库字段变化时，大量业务逻辑也跟着变的问题。</li>
<li>通过Repository，改变业务代码的思维方式，让业务逻辑不再面向数据库编程，而是面向领域模型编程。</li>
<li>Account属于一个完整的内存中对象，可以比较容易的做完整的测试覆盖，包含其行为。</li>
<li>Repository作为一个接口类，可以比较容易的实现Mock或Stub，可以很容易测试。</li>
<li>AccountRepositoryImpl实现类，由于其职责被单一出来，只需要关注Account到AccountDO的映射关系和Repository方法到DAO方法之间的映射关系，相对于来说更容易测试。</li>
</ul>
<p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/v2-1ee42f0915a33f6f000707c974792495_1440w.jpeg" alt="image"></p>
<h2 id="抽象第三方服务"><a href="#抽象第三方服务" class="headerlink" title="抽象第三方服务"></a>抽象第三方服务</h2><p>类似对于数据库的抽象，所有第三方服务也需要通过抽象解决第三方服务不可控，入参出参强耦合的问题。在这个例子里我们抽象出 ExchangeRateService 的服务，和一个ExchangeRate的Domain Primitive类：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ExchangeRateService</span> </span>&#123;</span><br><span class="line">    <span class="function">ExchangeRate <span class="title">getExchangeRate</span><span class="params">(Currency source, Currency <span class="keyword">target</span>)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExchangeRateServiceImpl</span> <span class="keyword">implements</span> <span class="title">ExchangeRateService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> YahooForexService yahooForexService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function">ExchangeRate <span class="title">getExchangeRate</span><span class="params">(Currency source, Currency <span class="keyword">target</span>)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (source.equals(<span class="keyword">target</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ExchangeRate(BigDecimal.ONE, source, <span class="keyword">target</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        BigDecimal forex = yahooForexService.getExchangeRate(source.getValue(), <span class="keyword">target</span>.getValue());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ExchangeRate(forex, source, <span class="keyword">target</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="防腐层（ACL）"><a href="#防腐层（ACL）" class="headerlink" title="防腐层（ACL）"></a>防腐层（ACL）</h3><p>这种常见的设计模式叫做Anti-Corruption Layer（防腐层或ACL）。很多时候我们的系统会去依赖其他的系统，而被依赖的系统可能包含不合理的数据结构、API、协议或技术实现，如果对外部系统强依赖，会导致我们的系统被”腐蚀“。这个时候，通过在系统间加入一个防腐层，能够有效的隔离外部依赖和内部逻辑，无论外部如何变更，内部代码可以尽可能的保持不变。</p>
<p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/v2-952c66bf1d97e78af66873dd50fe124d_1440w.jpeg" alt="image"></p>
<p>ACL 不仅仅只是多了一层调用，在实际开发中ACL能够提供更多强大的功能：</p>
<ul>
<li>适配器：很多时候外部依赖的数据、接口和协议并不符合内部规范，通过适配器模式，可以将数据转化逻辑封装到ACL内部，降低对业务代码的侵入。在这个案例里，我们通过封装了ExchangeRate和Currency对象，转化了对方的入参和出参，让入参出参更符合我们的标准。</li>
<li>缓存：对于频繁调用且数据变更不频繁的外部依赖，通过在ACL里嵌入缓存逻辑，能够有效的降低对于外部依赖的请求压力。同时，很多时候缓存逻辑是写在业务代码里的，通过将缓存逻辑嵌入ACL，能够降低业务代码的复杂度。</li>
<li>兜底：如果外部依赖的稳定性较差，一个能够有效提升我们系统稳定性的策略是通过ACL起到兜底的作用，比如当外部依赖出问题后，返回最近一次成功的缓存或业务兜底数据。这种兜底逻辑一般都比较复杂，如果散落在核心业务代码中会很难维护，通过集中在ACL中，更加容易被测试和修改。</li>
<li>易于测试：类似于之前的Repository，ACL的接口类能够很容易的实现Mock或Stub，以便于单元测试。</li>
<li>功能开关：有些时候我们希望能在某些场景下开放或关闭某个接口的功能，或者让某个接口返回一个特定的值，我们可以在ACL配置功能开关来实现，而不会对真实业务代码造成影响。同时，使用功能开关也能让我们容易的实现Monkey测试，而不需要真正物理性的关闭外部依赖。</li>
</ul>
<p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/v2-dbec337d0e361426cc58864e67756adb_1440w.jpeg" alt="image"></p>
<h2 id="抽象中间件"><a href="#抽象中间件" class="headerlink" title="抽象中间件"></a>抽象中间件</h2><p>类似于2.2的第三方服务的抽象，对各种中间件的抽象的目的是让业务代码不再依赖中间件的实现逻辑。因为中间件通常需要有通用型，中间件的接口通常是String或Byte[] 类型的，导致序列化/反序列化逻辑通常和业务逻辑混杂在一起，造成胶水代码。通过中间件的ACL抽象，减少重复胶水代码。</p>
<p>在这个案例里，我们通过封装一个抽象的AuditMessageProducer和AuditMessage DP对象，实现对底层kafka实现的隔离：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Value</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuditMessage</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> UserId userId;</span><br><span class="line">    <span class="keyword">private</span> AccountNumber source;</span><br><span class="line">    <span class="keyword">private</span> AccountNumber <span class="keyword">target</span>;</span><br><span class="line">    <span class="keyword">private</span> Money money;</span><br><span class="line">    <span class="keyword">private</span> Date date;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function">String <span class="title">serialize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userId + <span class="string">","</span> + source + <span class="string">","</span> + <span class="keyword">target</span> + <span class="string">","</span> + money + <span class="string">","</span> + date;   </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function">AuditMessage <span class="title">deserialize</span><span class="params">(String value)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// todo</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AuditMessageProducer</span> </span>&#123;</span><br><span class="line">    <span class="function">SendResult <span class="title">send</span><span class="params">(AuditMessage message)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuditMessageProducerImpl</span> <span class="keyword">implements</span> <span class="title">AuditMessageProducer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TOPIC_AUDIT_LOG = <span class="string">"TOPIC_AUDIT_LOG"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> KafkaTemplate&lt;String, String&gt; kafkaTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function">SendResult <span class="title">send</span><span class="params">(AuditMessage message)</span> </span>&#123;</span><br><span class="line">        String messageBody = message.serialize();</span><br><span class="line">        kafkaTemplate.send(TOPIC_AUDIT_LOG, messageBody);</span><br><span class="line">        <span class="function"><span class="keyword">return</span> SendResult.<span class="title">success</span><span class="params">()</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/v2-24099ac4f31bf9472bcf8b19ffaf48ab_1440w.jpeg" alt="image"></p>
<h2 id="封装业务逻辑"><a href="#封装业务逻辑" class="headerlink" title="封装业务逻辑"></a>封装业务逻辑</h2><h3 id="用Domain-Primitive封装跟实体无关的无状态计算逻辑"><a href="#用Domain-Primitive封装跟实体无关的无状态计算逻辑" class="headerlink" title="用Domain Primitive封装跟实体无关的无状态计算逻辑"></a>用Domain Primitive封装跟实体无关的无状态计算逻辑</h3><p>在这个案例里使用ExchangeRate来封装汇率计算逻辑：<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">BigDecimal </span>exchangeRate = <span class="keyword">BigDecimal.ONE;</span></span><br><span class="line"><span class="keyword">if </span>(sourceAccountDO.getCurrency().equals(targetCurrency)) &#123;</span><br><span class="line">    exchangeRate = yahooForex.getExchangeRate(sourceAccountDO.getCurrency(), targetCurrency)<span class="comment">;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">BigDecimal </span>sourceAmount = targetAmount.<span class="keyword">divide(exchangeRate, </span>RoundingMode.DOWN)<span class="comment">;</span></span><br></pre></td></tr></table></figure></p>
<p>变为：<br><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">ExchangeRate exchangeRate</span> = exchangeRateService.getExchangeRate(sourceAccount.getCurrency(), targetMoney.getCurrency());</span><br><span class="line"><span class="attribute">Money sourceMoney</span> = exchangeRate.exchangeTo(targetMoney);</span><br></pre></td></tr></table></figure></p>
<h3 id="用Entity封装单对象的有状态的行为，包括业务校验"><a href="#用Entity封装单对象的有状态的行为，包括业务校验" class="headerlink" title="用Entity封装单对象的有状态的行为，包括业务校验"></a>用Entity封装单对象的有状态的行为，包括业务校验</h3><p>用Account实体类封装所有Account的行为，包括业务校验如下：</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">@Data</span><br><span class="line"><span class="keyword">public</span> class Account &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> AccountId id;</span><br><span class="line">    <span class="keyword">private</span> AccountNumber accountNumber;</span><br><span class="line">    <span class="keyword">private</span> UserId userId;</span><br><span class="line">    <span class="keyword">private</span> Money <span class="built_in">available</span>;</span><br><span class="line">    <span class="keyword">private</span> Money dailyLimit;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Currency getCurrency() &#123;</span><br><span class="line">        <span class="built_in">return</span> <span class="keyword">this</span>.<span class="built_in">available</span>.getCurrency();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 转入</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> deposit(Money money) &#123;</span><br><span class="line">        <span class="built_in">if</span> (!<span class="keyword">this</span>.getCurrency().equals(money.getCurrency())) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InvalidCurrencyException();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.<span class="built_in">available</span> = <span class="keyword">this</span>.<span class="built_in">available</span>.add(money);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 转出</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> withdraw(Money money) &#123;</span><br><span class="line">        <span class="built_in">if</span> (<span class="keyword">this</span>.<span class="built_in">available</span>.compareTo(money) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InsufficientFundsException();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">if</span> (<span class="keyword">this</span>.dailyLimit.compareTo(money) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> DailyLimitExceededException();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.<span class="built_in">available</span> = <span class="keyword">this</span>.<span class="built_in">available</span>.subtract(money);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>原有的业务代码则可以简化为：<br><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sourceAccount.deposit(sourceMoney)<span class="comment">;</span></span><br><span class="line">targetAccount.withdraw(targetMoney)<span class="comment">;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="用Domain-Service封装多对象逻辑"><a href="#用Domain-Service封装多对象逻辑" class="headerlink" title="用Domain Service封装多对象逻辑"></a>用Domain Service封装多对象逻辑</h3><p>在这个案例里，我们发现这两个账号的转出和转入实际上是一体的，也就是说这种行为应该被封装到一个对象中去。特别是考虑到未来这个逻辑可能会产生变化：比如增加一个扣手续费的逻辑。这个时候在原有的TransferService中做并不合适，在任何一个Entity或者Domain Primitive里也不合适，需要有一个新的类去包含跨域对象的行为。这种对象叫做Domain Service。</p>
<p>我们创建一个AccountTransferService的类：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AccountTransferService</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">transfer</span><span class="params">(Account sourceAccount, Account targetAccount, Money targetMoney, ExchangeRate exchangeRate)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccountTransferServiceImpl</span> <span class="keyword">implements</span> <span class="title">AccountTransferService</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> ExchangeRateService exchangeRateService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transfer</span><span class="params">(Account sourceAccount, Account targetAccount, Money targetMoney, ExchangeRate exchangeRate)</span> </span>&#123;</span><br><span class="line">        Money sourceMoney = exchangeRate.exchangeTo(targetMoney);</span><br><span class="line">        sourceAccount.deposit(sourceMoney);</span><br><span class="line">        targetAccount.withdraw(targetMoney);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>而原始代码则简化为一行：<br><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">accountTransferService.<span class="built_in">transfer</span>(sourceAccount, targetAccount, targetMoney, exchangeRate);</span><br></pre></td></tr></table></figure></p>
<p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/v2-14d91a1f537b39307cf72a437ff3c60f_1440w.jpeg" alt="image"></p>
<h2 id="重构后结果分析"><a href="#重构后结果分析" class="headerlink" title="重构后结果分析"></a>重构后结果分析</h2><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransferServiceImplNew</span> <span class="keyword"><span class="keyword">implements</span> <span class="type">TransferService</span></span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> AccountRepository accountRepository;</span><br><span class="line">    <span class="keyword">private</span> AuditMessageProducer auditMessageProducer;</span><br><span class="line">    <span class="keyword">private</span> ExchangeRateService exchangeRateService;</span><br><span class="line">    <span class="keyword">private</span> AccountTransferService accountTransferService;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    <span class="keyword">public</span> Result&lt;Boolean&gt; transfer(Long sourceUserId, <span class="keyword">String</span> targetAccountNumber, BigDecimal targetAmount, <span class="keyword">String</span> targetCurrency) &#123;</span><br><span class="line">        <span class="comment">// 参数校验</span></span><br><span class="line">        Money targetMoney = <span class="keyword">new</span> <span class="type">Money</span>(targetAmount, <span class="keyword">new</span> <span class="type">Currency</span>(targetCurrency));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 读数据</span></span><br><span class="line">        Account sourceAccount = accountRepository.find(<span class="keyword">new</span> <span class="type">UserId</span>(sourceUserId));</span><br><span class="line">        Account targetAccount = accountRepository.find(<span class="keyword">new</span> <span class="type">AccountNumber</span>(targetAccountNumber));</span><br><span class="line">        ExchangeRate exchangeRate = exchangeRateService.getExchangeRate(sourceAccount.getCurrency(), targetMoney.getCurrency());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 业务逻辑</span></span><br><span class="line">        accountTransferService.transfer(sourceAccount, targetAccount, targetMoney, exchangeRate);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 保存数据</span></span><br><span class="line">        accountRepository.save(sourceAccount);</span><br><span class="line">        accountRepository.save(targetAccount);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 发送审计消息</span></span><br><span class="line">        AuditMessage message = <span class="keyword">new</span> <span class="type">AuditMessage</span>(sourceAccount, targetAccount, targetMoney);</span><br><span class="line">        auditMessageProducer.send(message);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.success(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看出来，经过重构后的代码有以下几个特征：</p>
<ul>
<li>业务逻辑清晰，数据存储和业务逻辑完全分隔。</li>
<li>Entity、Domain Primitive、Domain Service都是独立的对象，没有任何外部依赖，但是却包含了所有核心业务逻辑，可以单独完整测试。</li>
<li>原有的TransferService不再包括任何计算逻辑，仅仅作为组件编排，所有逻辑均delegate到其他组件。这种仅包含Orchestration（编排）的服务叫做Application Service（应用服务）。</li>
</ul>
<p>我们可以根据新的结构重新画一张图：</p>
<p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/v2-44ebd98e1697c75e119aa1d94a8f7768_1440w.jpeg" alt="image"></p>
<p>然后通过重新编排后该图变为：</p>
<p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/v2-5182bc6ecf7fe977b5968d9181a414aa_1440w.jpeg" alt="image"></p>
<p>我们可以发现，通过对外部依赖的抽象和内部逻辑的封装重构，应用整体的依赖关系变了：</p>
<ul>
<li>最底层不再是数据库，而是Entity、Domain Primitive和Domain Service。这些对象不依赖任何外部服务和框架，而是纯内存中的数据和操作。这些对象我们打包为Domain Layer（领域层）。领域层没有任何外部依赖关系。</li>
<li>再其次的是负责组件编排的Application Service，但是这些服务仅仅依赖了一些抽象出来的ACL类和Repository类，而其具体实现类是通过依赖注入注进来的。Application Service、Repository、ACL等我们统称为Application Layer（应用层）。应用层 依赖 领域层，但不依赖具体实现。</li>
<li>最后是ACL，Repository等的具体实现，这些实现通常依赖外部具体的技术实现和框架，所以统称为Infrastructure Layer（基础设施层）。Web框架里的对象如Controller之类的通常也属于基础设施层。</li>
<li></li>
</ul>
<p>如果今天能够重新写这段代码，考虑到最终的依赖关系，我们可能先写Domain层的业务逻辑，然后再写Application层的组件编排，最后才写每个外部依赖的具体实现。这种架构思路和代码组织结构就叫做Domain-Driven Design（领域驱动设计，或DDD）。所以DDD不是一个特殊的架构设计，而是所有Transction Script代码经过合理重构后一定会抵达的终点。</p>
<h2 id="DDD的六边形架构"><a href="#DDD的六边形架构" class="headerlink" title="DDD的六边形架构"></a>DDD的六边形架构</h2><p>在我们传统的代码里，我们一般都很注重每个外部依赖的实现细节和规范，但是今天我们需要敢于抛弃掉原有的理念，重新审视代码结构。在上面重构的代码里，如果抛弃掉所有Repository、ACL、Producer等的具体实现细节，我们会发现每一个对外部的抽象类其实就是输入或输出，类似于计算机系统中的I/O节点。这个观点在CQRS架构中也同样适用，将所有接口分为Command（输入）和Query（输出）两种。除了I/O之外其他的内部逻辑，就是应用业务的核心逻辑。基于这个基础，Alistair Cockburn在2005年提出了Hexagonal Architecture（六边形架构），又被称之为Ports and Adapters（端口和适配器架构）。</p>
<p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/v2-11af1ddff05b42025e83e204e71c9a5b_1440w.png" alt="image"></p>
<p>在这张图中：</p>
<ul>
<li>I/O的具体实现在模型的最外层</li>
<li>每个I/O的适配器在灰色地带</li>
<li>每个Hex的边是一个端口</li>
<li>Hex的中央是应用的核心领域模型</li>
</ul>
<p>在Hex中，架构的组织关系第一次变成了一个二维的内外关系，而不是传统一维的上下关系。同时在Hex架构中我们第一次发现UI层、DB层、和各种中间件层实际上是没有本质上区别的，都只是数据的输入和输出，而不是在传统架构中的最上层和最下层。</p>
<p>除了2005年的Hex架构，2008年 Jeffery Palermo的Onion Architecture（洋葱架构）和2017年 Robert Martin的Clean Architecture（干净架构），都是极为类似的思想。除了命名不一样、切入点不一样之外，其他的整体架构都是基于一个二维的内外关系。这也说明了基于DDD的架构最终的形态都是类似的。Herberto Graca有一个很全面的图包含了绝大部分现实中的端口类，值得借鉴。<br><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/v2-9e83433ede22b4d45e08c067b02e661f_1440w.jpeg" alt="image"></p>
<h3 id="代码组织结构"><a href="#代码组织结构" class="headerlink" title="代码组织结构"></a>代码组织结构</h3><p>为了有效的组织代码结构，避免下层代码依赖到上层实现的情况，在Java中我们可以通过POM Module和POM依赖来处理相互的关系。通过Spring/SpringBoot的容器来解决运行时动态注入具体实现的依赖的问题。一个简单的依赖关系图如下：<br><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/123312kjsalkdkal.jpeg" alt="image"></p>
<p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/v2-b3d0dccea152b7e846dc60ca3d615093_1440w.jpeg" alt="image"></p>
<h4 id="Types-模块"><a href="#Types-模块" class="headerlink" title="Types 模块"></a>Types 模块</h4><p>Types模块是保存可以对外暴露的Domain Primitives的地方。Domain Primitives因为是无状态的逻辑，可以对外暴露，所以经常被包含在对外的API接口中，需要单独成为模块。Types模块不依赖任何类库，纯 POJO 。</p>
<p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/v2-59a53da7e651770e2e1d96bafdf6a503_1440w.jpeg" alt="image"></p>
<h4 id="Domain-模块"><a href="#Domain-模块" class="headerlink" title="Domain 模块"></a>Domain 模块</h4><p>Domain 模块是核心业务逻辑的集中地，包含有状态的Entity、领域服务Domain Service、以及各种外部依赖的接口类（如Repository、ACL、中间件等。Domain模块仅依赖Types模块，也是纯 POJO 。</p>
<p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/v2-1c36105863c3f5187260a02548dd813b_1440w.jpeg" alt="image"></p>
<h4 id="Application模块"><a href="#Application模块" class="headerlink" title="Application模块"></a>Application模块</h4><p>Application模块主要包含Application Service和一些相关的类。Application模块依赖Domain模块。还是不依赖任何框架，纯POJO。<br><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/v2-b9a185f16cd6203796b582e7c43479d3_1440w.jpeg" alt="image"></p>
<h4 id="Infrastructure模块"><a href="#Infrastructure模块" class="headerlink" title="Infrastructure模块"></a>Infrastructure模块</h4><p>Infrastructure模块包含了Persistence、Messaging、External等模块。比如：Persistence模块包含数据库DAO的实现，包含Data Object、ORM Mapper、Entity到DO的转化类等。Persistence模块要依赖具体的ORM类库，比如MyBatis。如果需要用Spring-Mybatis提供的注解方案，则需要依赖Spring。</p>
<p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/v2-31fb63320e200bd58ec087ba4cab195d_1440w.jpeg" alt="image"></p>
<h4 id="Web模块"><a href="#Web模块" class="headerlink" title="Web模块"></a>Web模块</h4><p>Web模块包含Controller等相关代码。如果用SpringMVC则需要依赖Spring。<br><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/v2-71623c8f80edb4f7a6a0bceb8ebe85f5_1440w.jpeg" alt="image"></p>
<h4 id="Start模块"><a href="#Start模块" class="headerlink" title="Start模块"></a>Start模块</h4><p>Start模块是SpringBoot的启动类。</p>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><ul>
<li>Types，Domain模块都属于无外部依赖的纯POJO，基本上都可以100%的被单元测试覆盖。</li>
<li>Application模块的代码依赖外部抽象类，需要通过测试框架去Mock所有外部依赖，但仍然可以100%被单元测试。</li>
<li>Infrastructure的每个模块的代码相对独立，接口数量比较少，相对比较容易写单测。但是由于依赖了外部I/O，速度上不可能很快，但好在模块的变动不会很频繁，属于一劳永逸。</li>
<li>Web模块有两种测试方法：通过Spring的MockMVC测试，或者通过HttpClient调用接口测试。但是在测试时最好把Controller依赖的服务类都Mock掉。一般来说当你把Controller的逻辑都后置到Application Service中时，Controller的逻辑变得极为简单，很容易100%覆盖。</li>
<li>Start模块：通常应用的集成测试写在start里。当其他模块的单元测试都能100%覆盖后，集成测试用来验证整体链路的真实性。</li>
</ul>
<h2 id="代码的演进-变化速度"><a href="#代码的演进-变化速度" class="headerlink" title="代码的演进/变化速度"></a>代码的演进/变化速度</h2><p>在传统架构中，代码从上到下的变化速度基本上是一致的，改个需求需要从接口、到业务逻辑、到数据库全量变更，而第三方变更可能会导致整个代码的重写。但是在DDD中不同模块的代码的演进速度是不一样的：</p>
<ul>
<li>Domain层属于核心业务逻辑，属于经常被修改的地方。比如：原来不需要扣手续费，现在需要了之类的。通过Entity能够解决基于单个对象的逻辑变更，通过Domain Service解决多个对象间的业务逻辑变更。</li>
<li>Application层属于Use Case（业务用例）。业务用例一般都是描述比较大方向的需求，接口相对稳定，特别是对外的接口一般不会频繁变更。添加业务用例可以通过新增Application Service或者新增接口实现功能的扩展。</li>
<li>Infrastructure层属于最低频变更的。一般这个层的模块只有在外部依赖变更了之后才会跟着升级，而外部依赖的变更频率一般远低于业务逻辑的变更频率。<br>所以在DDD架构中，能明显看出越外层的代码越稳定，越内层的代码演进越快，真正体现了领域“驱动”的核心思想。</li>
</ul>
<h2 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h2><p>DDD不是一个什么特殊的架构，而是任何传统代码经过合理的重构之后最终一定会抵达的终点。DDD的架构能够有效的解决传统架构中的问题：</p>
<ul>
<li>高可维护性：当外部依赖变更时，内部代码只用变更跟外部对接的模块，其他业务逻辑不变。</li>
<li>高可扩展性：做新功能时，绝大部分的代码都能复用，仅需要增加核心业务逻辑即可。</li>
<li>高可测试性：每个拆分出来的模块都符合单一性原则，绝大部分不依赖框架，可以快速的单元测试，做到100%覆盖。</li>
<li>代码结构清晰：通过POM module可以解决模块间的依赖关系， 所有外接模块都可以单独独立成Jar包被复用。当团队形成规范后，可以快速的定位到相关代码。</li>
</ul>
<h1 id="Repository模式"><a href="#Repository模式" class="headerlink" title="Repository模式"></a>Repository模式</h1><p>为什么要用 Repository</p>
<blockquote>
<p>实体模型 vs. 贫血模型</p>
</blockquote>
<p>Entity（实体）这个词在计算机领域的最初应用可能是来自于Peter Chen在1976年的“The Entity-Relationship Model - Toward a Unified View of Data”（ER模型），用来描述实体之间的关系，而ER模型后来逐渐的演变成为一个数据模型，在关系型数据库中代表了数据的储存方式。而2006年的JPA标准，通过@Entity等注解，以及Hibernate等ORM框架的实现，让很多Java开发对Entity的理解停留在了数据映射层面，忽略了Entity实体的本身行为，造成今天很多的模型仅包含了实体的数据和属性，而所有的业务逻辑都被分散在多个服务、Controller、Utils工具类中，这个就是Martin Fowler所说的的Anemic Domain Model（贫血领域模型）。如何知道你的模型是贫血的呢？可以看一下你代码中是否有以下的几个特征：</p>
<ul>
<li>有大量的XxxDO对象：这里DO虽然有时候代表了Domain Object，但实际上仅仅是数据库表结构的映射，里面没有包含（或包含了很少的）业务逻辑；</li>
<li>服务和Controller里有大量的业务逻辑：比如校验逻辑、计算逻辑、格式转化逻辑、对象关系逻辑、数据存储逻辑等；</li>
<li>大量的Utils工具类等。</li>
</ul>
<p>而贫血模型的缺陷是非常明显的：</p>
<ul>
<li>无法保护模型对象的完整性和一致性：因为对象的所有属性都是公开的，只能由调用方来维护模型的一致性，而这个是没有保障的；之前曾经出现的案例就是调用方没有能维护模型数据的一致性，导致脏数据使用时出现bug，这一类的 bug还特别隐蔽，很难排查到。</li>
<li>对象操作的可发现性极差：单纯从对象的属性上很难看出来都有哪些业务逻辑，什么时候可以被调用，以及可以赋值的边界是什么；比如说，Long类型的值是否可以是0或者负数？</li>
<li>代码逻辑重复：比如校验逻辑、计算逻辑，都很容易出现在多个服务、多个代码块里，提升维护成本和bug出现的概率；一类常见的bug就是当贫血模型变更后，校验逻辑由于出现在多个地方，没有能跟着变，导致校验失败或失效。</li>
<li>代码的健壮性差：比如一个数据模型的变化可能导致从上到下的所有代码的变更。</li>
<li>强依赖底层实现：业务代码里强依赖了底层数据库、网络/中间件协议、第三方服务等，造成核心逻辑代码的僵化且维护成本高。</li>
</ul>
<p>虽然贫血模型有很大的缺陷，但是在我们日常的代码中，我见过的99%的代码都是基于贫血模型，为什么呢？我总结了以下几点：</p>
<ul>
<li>数据库思维：从有了数据库的那一天起，开发人员的思考方式就逐渐从“写业务逻辑“转变为了”写数据库逻辑”，也就是我们经常说的在写CRUD代码。</li>
<li>贫血模型“简单”：贫血模型的优势在于“简单”，仅仅是对数据库表的字段映射，所以可以从前到后用统一格式串通。这里简单打了引号，是因为它只是表面上的简单，实际上当未来有模型变更时，你会发现其实并不简单，每次变更都是非常复杂的事情</li>
<li>脚本思维：很多常见的代码都属于“脚本”或“胶水代码”，也就是流程式代码。脚本代码的好处就是比较容易理解，但长久来看缺乏健壮性，维护成本会越来越高。</li>
</ul>
<p>但是可能最核心的原因在于，实际上我们在日常开发中，混淆了两个概念：</p>
<ul>
<li>数据模型（Data Model）：指业务数据该如何持久化，以及数据之间的关系，也就是传统的ER模型；</li>
<li>业务模型/领域模型（Domain Model）：指业务逻辑中，相关联的数据该如何联动。</li>
</ul>
<p>所以，解决这个问题的根本方案，就是要在代码里严格区分Data Model和Domain Model，具体的规范会在后文详细描述。在真实代码结构中，Data Model和 Domain Model实际上会分别在不同的层里，Data Model只存在于数据层，而Domain Model在领域层，而链接了这两层的关键对象，就是Repository。</p>
<blockquote>
<p>Repository的价值</p>
</blockquote>
<p>在传统的数据库驱动开发中，我们会对数据库操作做一个封装，一般叫做Data Access Object（DAO）。DAO的核心价值是封装了拼接SQL、维护数据库连接、事务等琐碎的底层逻辑，让业务开发可以专注于写代码。但是在本质上，DAO的操作还是数据库操作，DAO的某个方法还是在直接操作数据库和数据模型，只是少写了部分代码。在Uncle Bob的《代码整洁之道》一书里，作者用了一个非常形象的描述：</p>
<ul>
<li>硬件（Hardware）：指创造了之后不可（或者很难）变更的东西。数据库对于开发来说，就属于”硬件“，数据库选型后基本上后面不会再变，比如：用了MySQL就很难再改为MongoDB，改造成本过高。</li>
<li>软件（Software）：指创造了之后可以随时修改的东西。对于开发来说，业务代码应该追求做”软件“，因为业务流程、规则在不停的变化，我们的代码也应该能随时变化。</li>
<li>固件（Firmware）：即那些强烈依赖了硬件的软件。我们常见的是路由器里的固件或安卓的固件等等。固件的特点是对硬件做了抽象，但仅能适配某款硬件，不能通用。所以今天不存在所谓的通用安卓固件，而是每个手机都需要有自己的固件。</li>
<li></li>
</ul>
<p>从上面的描述我们能看出来，数据库在本质上属于”硬件“，DAO 在本质上属于”固件“，而我们自己的代码希望是属于”软件“。但是，固件有个非常不好的特性，那就是会传播，也就是说当一个软件强依赖了固件时，由于固件的限制，会导致软件也变得难以变更，最终让软件变得跟固件一样难以变更。</p>
<h2 id="模型对象代码规范"><a href="#模型对象代码规范" class="headerlink" title="模型对象代码规范"></a>模型对象代码规范</h2><p>这边要解决这个问题，首先要指定编码规约</p>
<blockquote>
<p>对象类型</p>
</blockquote>
<p>在讲Repository规范之前，我们需要先讲清楚3种模型的区别，Entity、Data Object (DO)和Data Transfer Object (DTO)：</p>
<ul>
<li>Data Object （DO、数据对象）：实际上是我们在日常工作中最常见的数据模型。但是在DDD的规范里，DO应该仅仅作为数据库物理表格的映射，不能参与到业务逻辑中。为了简单明了，DO的字段类型和名称应该和数据库物理表格的字段类型和名称一一对应，这样我们不需要去跑到数据库上去查一个字段的类型和名称。（当然，实际上也没必要一摸一样，只要你在Mapper那一层做到字段映射）</li>
<li>Entity（实体对象）：实体对象是我们正常业务应该用的业务模型，它的字段和方法应该和业务语言保持一致，和持久化方式无关。也就是说，Entity和DO很可能有着完全不一样的字段命名和字段类型，甚至嵌套关系。Entity的生命周期应该仅存在于内存中，不需要可序列化和可持久化。</li>
<li>DTO（传输对象）：主要作为Application层的入参和出参，比如CQRS里的Command、Query、Event，以及Request、Response等都属于DTO的范畴。DTO的价值在于适配不同的业务场景的入参和出参，避免让业务对象变成一个万能大对象。</li>
</ul>
<h2 id="模型所在模块和转化器"><a href="#模型所在模块和转化器" class="headerlink" title="模型所在模块和转化器"></a>模型所在模块和转化器</h2><p>于现在从一个对象变为3+个对象，对象间需要通过转化器（Converter/Mapper）来互相转化。而这三种对象在代码中所在的位置也不一样，简单总结如下：<br><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/common/v2-93a7e4f3d3bda78cf8ba33411a5d3e2d_1440w.jpeg" alt="image"></p>
<blockquote>
<p>这边DO结尾的文件是跟数据库一一对应的，DTO是跟前端或者其他系统协商的，只有DTO需要序列化，Entity是不固定的，实际的属性设置是根据业务来的。这边我推荐用一个mapper层，所有文件都以Mapper结尾，在Mapper层做转换，这边具体的转换用一个工具很好用，叫MapStruct。</p>
</blockquote>
<p>从使用复杂度角度来看，区分了DO、Entity、DTO带来了代码量的膨胀（从1个变成了3+2+N个）。但是在实际复杂业务场景下，通过功能来区分模型带来的价值是功能性的单一和可测试、可预期，最终反而是逻辑复杂性的降低。</p>
<p>我自己的项目因为是简单的业务模型，所以用了通用的贫血模型，规范的项目目录结构如下所示（这边缺少了entity和防腐层的设计）：</p>
<p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/common/WechatIMG629.png" alt="image"></p>
<h1 id="DDD领域层的一些设计规范"><a href="#DDD领域层的一些设计规范" class="headerlink" title="DDD领域层的一些设计规范"></a>DDD领域层的一些设计规范</h1><p>上面我主要针对同一个例子对比了OOP、ECS和DDD的3种实现，比较如下：</p>
<ul>
<li>基于继承关系的OOP代码：OOP的代码最好写，也最容易理解，所有的规则代码都写在对象里，但是当领域规则变得越来越复杂时，其结构会限制它的发展。新的规则有可能会导致代码的整体重构。</li>
<li>基于组件化的ECS代码：ECS代码有最高的灵活性、可复用性、及性能，但极具弱化了实体类的内聚，所有的业务逻辑都写在了服务里，会导致业务的一致性无法保障，对商业系统会有较大的影响。</li>
<li>基于领域对象 + 领域服务的DDD架构：DDD的规则其实最复杂，同时要考虑到实体类的内聚和保证不变性（Invariants），也要考虑跨对象规则代码的归属，甚至要考虑到具体领域服务的调用方式，理解成本比较高。</li>
</ul>
<h2 id="实体类（Entity）"><a href="#实体类（Entity）" class="headerlink" title="实体类（Entity）"></a>实体类（Entity）</h2><p>大多数DDD架构的核心都是实体类，实体类包含了一个领域里的状态、以及对状态的直接操作。Entity最重要的设计原则是保证实体的不变性（Invariants），也就是说要确保无论外部怎么操作，一个实体内部的属性都不能出现相互冲突，状态不一致的情况。所以几个设计原则如下：</p>
<p>创建即一致<br>在贫血模型里，通常见到的代码是一个模型通过手动new出来之后，由调用方一个参数一个参数的赋值，这就很容易产生遗漏，导致实体状态不一致。所以DDD里实体创建的方法有两种：</p>
<p>constructor参数要包含所有必要属性，或者在constructor里有合理的默认值。</p>
<blockquote>
<p>使用Factory模式来降低调用方复杂度</p>
</blockquote>
<h3 id="尽量避免public-setter"><a href="#尽量避免public-setter" class="headerlink" title="尽量避免public setter"></a>尽量避免public setter</h3><p>一个最容易导致不一致性的原因是实体暴露了public的setter方法，特别是set单一参数会导致状态不一致的情况。比如，一个订单可能包含订单状态（下单、已支付、已发货、已收货）、支付单、物流单等子实体，如果一个调用方能随意去set订单状态，就有可能导致订单状态和子实体匹配不上，导致业务流程走不通的情况。所以在实体里，需要通过行为方法来修改内部状态。</p>
<h3 id="通过聚合根保证主子实体的一致性"><a href="#通过聚合根保证主子实体的一致性" class="headerlink" title="通过聚合根保证主子实体的一致性"></a>通过聚合根保证主子实体的一致性</h3><p>在稍微复杂一点的领域里，通常主实体会包含子实体，这时候主实体就需要起到聚合根的作用，即：</p>
<ul>
<li>子实体不能单独存在，只能通过聚合根的方法获取到。任何外部的对象都不能直接保留子实体的引用</li>
<li>子实体没有独立的Repository，不可以单独保存和取出，必须要通过聚合根的Repository实例化</li>
<li>子实体可以单独修改自身状态，但是多个子实体之间的状态一致性需要聚合根来保障</li>
</ul>
<p>常见的电商域中聚合的案例如主子订单模型、商品/SKU模型、跨子订单优惠、跨店优惠模型等。很多聚合根和Repository的设计规范在我前面一篇关于Repository的文章中已经详细解释过，可以拿来参考。</p>
<h3 id="不可以强依赖其他聚合根实体或领域服务"><a href="#不可以强依赖其他聚合根实体或领域服务" class="headerlink" title="不可以强依赖其他聚合根实体或领域服务"></a>不可以强依赖其他聚合根实体或领域服务</h3><p>一个实体的原则是高内聚、低耦合，即一个实体类不能直接在内部直接依赖一个外部的实体或服务。这个原则和绝大多数ORM框架都有比较严重的冲突，所以是一个在开发过程中需要特别注意的。这个原则的必要原因包括：对外部对象的依赖性会直接导致实体无法被单测；以及一个实体无法保证外部实体变更后不会影响本实体的一致性和正确性。</p>
<p>所以，正确的对外部依赖的方法有两种：</p>
<ul>
<li>只保存外部实体的ID：这里我再次强烈建议使用强类型的ID对象，而不是Long型ID。强类型的ID对象不单单能自我包含验证代码，保证ID值的正确性，同时还能确保各种入参不会因为参数顺序变化而出bug。具体可以参考Domain Primitive。</li>
<li>针对于“无副作用”的外部依赖，通过方法入参的方式传入。比如上文中的equip(Weapon，EquipmentService）方法。</li>
</ul>
<p>如果方法对外部依赖有副作用，不能通过方法入参的方式，只能通过Domain Service解决，见下文。</p>
<h3 id="任何实体的行为只能直接影响到本实体（和其子实体）"><a href="#任何实体的行为只能直接影响到本实体（和其子实体）" class="headerlink" title="任何实体的行为只能直接影响到本实体（和其子实体）"></a>任何实体的行为只能直接影响到本实体（和其子实体）</h3><p>这个原则更多是一个确保代码可读性、可理解的原则，即任何实体的行为不能有“直接”的”副作用“，即直接修改其他的实体类。这么做的好处是代码读下来不会产生意外。</p>
<p>另一个遵守的原因是可以降低未知的变更的风险。在一个系统里一个实体对象的所有变更操作应该都是预期内的，如果一个实体能随意被外部直接修改的话，会增加代码bug的风险。</p>
<h2 id="领域服务（Domain-Service）"><a href="#领域服务（Domain-Service）" class="headerlink" title="领域服务（Domain Service）"></a>领域服务（Domain Service）</h2><p>在上文讲到，领域服务其实也分很多种，在这里根据上文总结出来三种常见的：</p>
<h3 id="单对象策略型"><a href="#单对象策略型" class="headerlink" title="单对象策略型"></a>单对象策略型</h3><p>这种领域对象主要面向的是单个实体对象的变更，但涉及到多个领域对象或外部依赖的一些规则。在上文中，EquipmentService即为此类：</p>
<ul>
<li>变更的对象是Player的参数</li>
<li>读取的是Player和Weapon的数据，可能还包括从外部读取一些数据</li>
</ul>
<p>在这种类型下，实体应该通过方法入参的方式传入这种领域服务，然后通过Double Dispatch来反转调用领域服务的方法。</p>
<h3 id="跨对象事务型"><a href="#跨对象事务型" class="headerlink" title="跨对象事务型"></a>跨对象事务型</h3><p>当一个行为会直接修改多个实体时，不能再通过单一实体的方法作处理，而必须直接使用领域服务的方法来做操作。在这里，领域服务更多的起到了跨对象事务的作用，确保多个实体的变更之间是有一致性的。</p>
<h3 id="通用组件型"><a href="#通用组件型" class="headerlink" title="通用组件型"></a>通用组件型</h3><p>这种类型的领域服务更像ECS里的System，提供了组件化的行为，但本身又不直接绑死在一种实体类上。</p>
<h2 id="策略对象（Domain-Policy）"><a href="#策略对象（Domain-Policy）" class="headerlink" title="策略对象（Domain Policy）"></a>策略对象（Domain Policy）</h2><p>Policy或者Strategy设计模式是一个通用的设计模式，但是在DDD架构中会经常出现，其核心就是封装领域规则。</p>
<p>一个Policy是一个无状态的单例对象，通常需要至少2个方法：canApply 和 一个业务方法。其中，canApply方法用来判断一个Policy是否适用于当前的上下文，如果适用则调用方会去触发业务方法。通常，为了降低一个Policy的可测试性和复杂度，Policy不应该直接操作对象，而是通过返回计算后的值，在Domain Service里对对象进行操作。</p>
<p>除了本文里静态注入多个Policy以及手动排优先级之外，在日常开发中经常能见到通过Java的SPI机制或类SPI机制注册Policy，以及通过不同的Priority方案对Policy进行排序，在这里就不作太多的展开了。</p>
<h2 id="领域事件介绍"><a href="#领域事件介绍" class="headerlink" title="领域事件介绍"></a>领域事件介绍</h2><p>领域事件是一个在领域里发生了某些事后，希望领域里其他对象能够感知到的通知机制。在上面的案例里，代码之所以会越来越复杂，其根本的原因是反应代码（比如升级）直接和上面的事件触发条件（比如收到经验）直接耦合，而且这种耦合性是隐性的。领域事件的好处就是将这种隐性的副作用“显性化”，通过一个显性的事件，将事件触发和事件处理解耦，最终起到代码更清晰、扩展性更好的目的。</p>
<p>所以，领域事件是在DDD里，比较推荐使用的跨实体“副作用”传播机制。</p>
<h3 id="领域事件实现"><a href="#领域事件实现" class="headerlink" title="领域事件实现"></a>领域事件实现</h3><p>和消息队列中间件不同的是，领域事件通常是立即执行的、在同一个进程内、可能是同步或异步。我们可以通过一个EventBus来实现进程内的通知机制，简单实现如下：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 实现者：瑜进 2019/11/28</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EventBus</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册器</span></span><br><span class="line">    @Getter</span><br><span class="line">    <span class="keyword">private</span> final EventRegistry invokerRegistry = <span class="keyword">new</span> EventRegistry(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 事件分发器</span></span><br><span class="line">    <span class="keyword">private</span> final EventDispatcher dispatcher = <span class="keyword">new</span> EventDispatcher(ExecutorFactory.getDirectExecutor());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 异步事件分发器</span></span><br><span class="line">    <span class="keyword">private</span> final EventDispatcher asyncDispatcher = <span class="keyword">new</span> EventDispatcher(ExecutorFactory.getThreadPoolExecutor());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 事件分发</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> boolean <span class="title">dispatch</span>(<span class="params">Event <span class="keyword">event</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> dispatch(<span class="keyword">event</span>, dispatcher);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 异步事件分发</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> boolean <span class="title">dispatchAsync</span>(<span class="params">Event <span class="keyword">event</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> dispatch(<span class="keyword">event</span>, asyncDispatcher);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 内部事件分发</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> boolean <span class="title">dispatch</span>(<span class="params">Event <span class="keyword">event</span>, EventDispatcher dispatcher</span>) </span>&#123;</span><br><span class="line">        checkEvent(<span class="keyword">event</span>);</span><br><span class="line">        <span class="comment">// 1.获取事件数组</span></span><br><span class="line">        Set&lt;Invoker&gt; invokers = invokerRegistry.getInvokers(<span class="keyword">event</span>);</span><br><span class="line">        <span class="comment">// 2.一个事件可以被监听N次，不关心调用结果</span></span><br><span class="line">        dispatcher.dispatch(<span class="keyword">event</span>, invokers);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 事件总线注册</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span>(<span class="params">Object listener</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (listener == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"listener can not be null!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        invokerRegistry.register(listener);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkEvent</span>(<span class="params">Event <span class="keyword">event</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">event</span> == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"event"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!(<span class="keyword">event</span> instanceof Event)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Event type must by "</span> + Event.class);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用方式：<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">LevelUpEvent</span> <span class="title">implements</span> <span class="title">Event</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Player player;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">LevelUpHandler</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span>(<span class="params">Player player</span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Player</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receiveExp</span>(<span class="params"><span class="keyword">int</span> <span class="keyword">value</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.exp += <span class="keyword">value</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.exp &gt;= <span class="number">100</span>) &#123;</span><br><span class="line">            LevelUpEvent <span class="keyword">event</span> = <span class="keyword">new</span> LevelUpEvent(<span class="keyword">this</span>);</span><br><span class="line">            EventBus.dispatch(<span class="keyword">event</span>);</span><br><span class="line">            <span class="keyword">this</span>.exp = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">@Test</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    EventBus.register(<span class="keyword">new</span> LevelUpHandler());</span><br><span class="line">    player.setLevel(<span class="number">1</span>);</span><br><span class="line">    player.receiveExp(<span class="number">100</span>);</span><br><span class="line">    assertThat(player.getLevel()).<span class="keyword">equals</span>(<span class="number">2</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="目前领域事件的缺陷和展望"><a href="#目前领域事件的缺陷和展望" class="headerlink" title="目前领域事件的缺陷和展望"></a>目前领域事件的缺陷和展望</h2><p>从上面代码可以看出来，领域事件的很好的实施依赖EventBus、Dispatcher、Invoker这些属于框架级别的支持。同时另一个问题是因为Entity不能直接依赖外部对象，所以EventBus目前只能是一个全局的Singleton，而大家都应该知道全局Singleton对象很难被单测。这就容易导致Entity对象无法被很容易的被完整单测覆盖全。</p>
<p>另一种解法是侵入Entity，对每个Entity增加一个List:<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Player</span> &#123;</span><br><span class="line">  List&lt;Event&gt; events;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receiveExp</span>(<span class="params"><span class="keyword">int</span> <span class="keyword">value</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.exp += <span class="keyword">value</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.exp &gt;= <span class="number">100</span>) &#123;</span><br><span class="line">            LevelUpEvent <span class="keyword">event</span> = <span class="keyword">new</span> LevelUpEvent(<span class="keyword">this</span>);</span><br><span class="line">            events.<span class="keyword">add</span>(<span class="keyword">event</span>); <span class="comment">// 把event加进去</span></span><br><span class="line">            <span class="keyword">this</span>.exp = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Test</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    EventBus.register(<span class="keyword">new</span> LevelUpHandler());</span><br><span class="line">    player.setLevel(<span class="number">1</span>);</span><br><span class="line">    player.receiveExp(<span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(Event <span class="keyword">event</span>: player.getEvents()) &#123; <span class="comment">// 在这里显性的dispatch事件</span></span><br><span class="line">        EventBus.dispatch(<span class="keyword">event</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    assertThat(player.getLevel()).<span class="keyword">equals</span>(<span class="number">2</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>但是能看出来这种解法不但会侵入实体本身，同时也需要比较啰嗦的显性在调用方dispatch事件，也不是一个好的解决方案。</p>
<p>也许未来会有一个框架能让我们既不依赖全局Singleton，也不需要显性去处理事件，但目前的方案基本都有或多或少的缺陷，大家在使用中可以注意。</p>
<h1 id="总结-2"><a href="#总结-2" class="headerlink" title="总结"></a>总结</h1><p>在真实的业务逻辑里，我们的领域模型或多或少的都有一定的“特殊性”，如果100%的要符合DDD规范可能会比较累，所以最主要的是梳理一个对象行为的影响面，然后作出设计决策，即：</p>
<ul>
<li>是仅影响单一对象还是多个对象，</li>
<li>规则未来的拓展性、灵活性，</li>
<li>性能要求，</li>
<li>副作用的处理，等等</li>
</ul>
<p>当然，很多时候一个好的设计是多种因素的取舍，需要大家有一定的积累，真正理解每个架构背后的逻辑和优缺点。一个好的架构师不是有一个正确答案，而是能从多个方案中选出一个最平衡的方案。</p>
<p>参考文章：</p>
<ul>
<li><a href="https://zhuanlan.zhihu.com/p/340911587" target="_blank" rel="noopener">阿里技术专家详解 DDD 系列 第一讲- Domain Primitive</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/343388831" target="_blank" rel="noopener">阿里技术专家详解DDD系列 第二讲 - 应用架构</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/348706530" target="_blank" rel="noopener">阿里技术专家详解DDD系列 第三讲 - Repository模式</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/356518017" target="_blank" rel="noopener">阿里技术专家详解DDD系列 第四讲 - 领域层设计规范</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dinghuang.github.io/2020/12/11/Skyworking实践/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="强壮的病猫">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/dinghuang.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一只病猫">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/12/11/Skyworking实践/" itemprop="url">SkyWalking实践</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-12-11T15:47:00+08:00">
                2020-12-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JAVA/" itemprop="url" rel="index">
                    <span itemprop="name">JAVA</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/12/11/Skyworking实践/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/12/11/Skyworking实践/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>SkyWalking是一个开源的可观察性平台，用于收集，分析，聚合和可视化来自服务和云本机基础结构的数据。SkyWalking提供了一种简便的方法来维护您的分布式系统的清晰视图，即使在整个云中也是如此。它是一种现代APM，专门为基于云的基于容器的分布式系统而设计。</p>
<h2 id="为什么要使用SkyWalking"><a href="#为什么要使用SkyWalking" class="headerlink" title="为什么要使用SkyWalking"></a>为什么要使用SkyWalking</h2><p>SkyWalking提供了用于在许多不同情况下观察和监视分布式系统的解决方案。首先，与传统方法一样，SkyWalking为服务提供自动仪器代理，例如Java，C＃，Node.js，Go，PHP和Nginx LUA。（并呼吁提供Python和C ++ SDK贡献）。在多语言，持续部署的环境中，云本机基础架构变得越来越强大，但也越来越复杂。SkyWalking的服务网格接收器使SkyWalking能够从Istio / Envoy和Linkerd等服务网格框架接收遥测数据，从而使用户能够了解整个分布式系统。</p>
<p>SkyWalking为服务，服务实例，端点提供可观察性功能。服务，实例和端点这些术语在当今到处都有使用，因此值得在SkyWalking的上下文中定义它们的特定含义：</p>
<ul>
<li>服务。表示一组/一组工作负载，这些工作负载为传入请求提供相同的行为。您可以在使用乐器代理或SDK时定义服务名称。SkyWalking也可以使用您在Istio等平台中定义的名称。</li>
<li>服务实例。服务组中的每个单独工作负载都称为实例。像pods在Kubernetes中一样，它不必是单个OS进程，但是，如果您使用仪器代理，则实例实际上是一个真正的OS进程。</li>
<li>端点。服务中用于传入请求的路径，例如HTTP URI路径或gRPC服务类+方法签名。<br>通过SkyWalking，用户可以了解服务和端点之间的拓扑关系，查看每个服务/服务实例/端点的指标并设置警报规则。</li>
</ul>
<p>此外，可以整合</p>
<ul>
<li>其他使用SkyWalking本机代理程序和SDK以及Zipkin，Jaeger和OpenCensus进行的分布式跟踪。</li>
<li>其他度量系统，例如Prometheus，Sleuth（Micrometer）。</li>
</ul>
<h2 id="架构设计"><a href="#架构设计" class="headerlink" title="架构设计"></a>架构设计</h2><p>SkyWalking分为四个部分：</p>
<ul>
<li>探针：收集数据并重新格式化以符合SkyWalking要求（不同的探针支持不同的来源）。</li>
<li>平台后端：支持数据聚合，分析并驱动从探针到UI的流程。该分析包括SkyWalking本机跟踪和度量标准，包括Istio和Envoy遥测的第三方，Zipkin跟踪格式等。您甚至可以通过使用针对本机度量标准的Observability Analysis Language和针对扩展度量标准的Meter System来定制聚合和分析。</li>
<li>存储：存储设备通过开放/可插入的界面存储SkyWalking数据。您可以选择现有的实现，例如ElasticSearch，H2或由Sharding-Sphere管理的MySQL集群，也可以实现自己的实现。欢迎新存储实现者使用补丁！</li>
<li>UI：是一个高度可定制的基于Web的界面，允许SkyWalking最终用户可视化和管理SkyWalking数据。</li>
</ul>
<p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/687474703a2f2f736b7977616c6b696e672e6170616368652e6f72672f6173736574732f6672616d652d76382e6a70673f753d3230323030343233.jpeg" alt="image"></p>
<h1 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h1><p>本文章基于官方源码tag:<code>v8.3.0</code></p>
<h2 id="源码编译"><a href="#源码编译" class="headerlink" title="源码编译"></a>源码编译</h2><p>修改<code>.mvn/jvm.config</code><br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-Dhttp.<span class="attribute">proxyHost</span>=proxy_ip</span><br><span class="line">-Dhttp.<span class="attribute">proxyPort</span>=proxy_port</span><br><span class="line">-Dhttps.<span class="attribute">proxyHost</span>=proxy_ip</span><br><span class="line">-Dhttps.<span class="attribute">proxyPort</span>=proxy_port </span><br><span class="line">-Dhttp.<span class="attribute">proxyUser</span>=username</span><br><span class="line">-Dhttp.<span class="attribute">proxyPassword</span>=password</span><br></pre></td></tr></table></figure></p>
<p>下载git源码<br><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">git</span> clone --<span class="keyword">branch </span><span class="built_in">v8</span>.<span class="number">3</span>.<span class="number">0</span> https://github.com/apache/skywalking.git</span><br><span class="line"><span class="symbol">git</span> <span class="keyword">submodule </span>init</span><br><span class="line"><span class="symbol">git</span> <span class="keyword">submodule </span>update</span><br></pre></td></tr></table></figure></p>
<p>执行编译<br><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./mvnw clean <span class="keyword">package</span> <span class="title">-DskipTests</span></span><br></pre></td></tr></table></figure></p>
<p>打包后的都会在<code>/dist</code>目录下</p>
<h2 id="下载制品"><a href="#下载制品" class="headerlink" title="下载制品"></a>下载制品</h2><p>推荐直接下载<a href="https://mirror.bit.edu.cn/apache/skywalking/8.3.0/apache-skywalking-apm-8.3.0.tar.gz" target="_blank" rel="noopener">成品</a></p>
<h2 id="服务启动"><a href="#服务启动" class="headerlink" title="服务启动"></a>服务启动</h2><p>进入目录<code>/bin</code>，windows和linux的启动脚本都在里面，可以直接启动。</p>
<p>执行命令<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.<span class="regexp">/dist-material/</span>bin<span class="regexp">/startup.sh</span></span><br></pre></td></tr></table></figure></p>
<p>现在服务端就启起来了，可以打开后台地址查看(默认是8080端口): <a href="http://localhost:8080,界面如下：" target="_blank" rel="noopener">http://localhost:8080,界面如下：</a><br><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/WechatIMG8155.png" alt="image"><br><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/WechatIMG8158.png" alt="image"></p>
<p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/WechatIMG8162.png" alt="image"></p>
<p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/WechatIMG8153.png" alt="image"></p>
<p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/WechatIMG8154.png" alt="image"></p>
<p>客户端需要提前准备开墙信息，默认的启动端口是8080，数据采集的端口是11800</p>
<p>默认的存储是用内存数据库H2来存储的，建议改掉，不然数据会跟着服务重启丢失，而且服务占用内存会很大。修改的话在目录<code>/config</code>下有3个文件可以改：</p>
<ul>
<li>application.yml</li>
<li>log4j.xml</li>
<li>alarm-settings.yml</li>
</ul>
<p>其中<code>application.yml</code>配置如下<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">cluster:</span></span><br><span class="line"><span class="attr">  selector:</span> <span class="string">$&#123;SW_CLUSTER:standalone&#125;</span></span><br><span class="line"><span class="attr">  standalone:</span></span><br><span class="line">  <span class="comment"># Please check your ZooKeeper is 3.5+, However, it is also compatible with ZooKeeper 3.4.x. Replace the ZooKeeper 3.5+</span></span><br><span class="line">  <span class="comment"># library the oap-libs folder with your ZooKeeper 3.4.x library.</span></span><br><span class="line"><span class="attr">  zookeeper:</span></span><br><span class="line"><span class="attr">    nameSpace:</span> <span class="string">$&#123;SW_NAMESPACE:""&#125;</span></span><br><span class="line"><span class="attr">    hostPort:</span> <span class="string">$&#123;SW_CLUSTER_ZK_HOST_PORT:localhost:2181&#125;</span></span><br><span class="line">    <span class="comment"># Retry Policy</span></span><br><span class="line"><span class="attr">    baseSleepTimeMs:</span> <span class="string">$&#123;SW_CLUSTER_ZK_SLEEP_TIME:1000&#125;</span> <span class="comment"># initial amount of time to wait between retries</span></span><br><span class="line"><span class="attr">    maxRetries:</span> <span class="string">$&#123;SW_CLUSTER_ZK_MAX_RETRIES:3&#125;</span> <span class="comment"># max number of times to retry</span></span><br><span class="line">    <span class="comment"># Enable ACL</span></span><br><span class="line"><span class="attr">    enableACL:</span> <span class="string">$&#123;SW_ZK_ENABLE_ACL:false&#125;</span> <span class="comment"># disable ACL in default</span></span><br><span class="line"><span class="attr">    schema:</span> <span class="string">$&#123;SW_ZK_SCHEMA:digest&#125;</span> <span class="comment"># only support digest schema</span></span><br><span class="line"><span class="attr">    expression:</span> <span class="string">$&#123;SW_ZK_EXPRESSION:skywalking:skywalking&#125;</span></span><br><span class="line"><span class="attr">  kubernetes:</span></span><br><span class="line"><span class="attr">    namespace:</span> <span class="string">$&#123;SW_CLUSTER_K8S_NAMESPACE:default&#125;</span></span><br><span class="line"><span class="attr">    labelSelector:</span> <span class="string">$&#123;SW_CLUSTER_K8S_LABEL:app=collector,release=skywalking&#125;</span></span><br><span class="line"><span class="attr">    uidEnvName:</span> <span class="string">$&#123;SW_CLUSTER_K8S_UID:SKYWALKING_COLLECTOR_UID&#125;</span></span><br><span class="line"><span class="attr">  consul:</span></span><br><span class="line"><span class="attr">    serviceName:</span> <span class="string">$&#123;SW_SERVICE_NAME:"SkyWalking_OAP_Cluster"&#125;</span></span><br><span class="line">    <span class="comment"># Consul cluster nodes, example: 10.0.0.1:8500,10.0.0.2:8500,10.0.0.3:8500</span></span><br><span class="line"><span class="attr">    hostPort:</span> <span class="string">$&#123;SW_CLUSTER_CONSUL_HOST_PORT:localhost:8500&#125;</span></span><br><span class="line"><span class="attr">    aclToken:</span> <span class="string">$&#123;SW_CLUSTER_CONSUL_ACLTOKEN:""&#125;</span></span><br><span class="line"><span class="attr">  etcd:</span></span><br><span class="line"><span class="attr">    serviceName:</span> <span class="string">$&#123;SW_SERVICE_NAME:"SkyWalking_OAP_Cluster"&#125;</span></span><br><span class="line">    <span class="comment"># etcd cluster nodes, example: 10.0.0.1:2379,10.0.0.2:2379,10.0.0.3:2379</span></span><br><span class="line"><span class="attr">    hostPort:</span> <span class="string">$&#123;SW_CLUSTER_ETCD_HOST_PORT:localhost:2379&#125;</span></span><br><span class="line"><span class="attr">  nacos:</span></span><br><span class="line"><span class="attr">    serviceName:</span> <span class="string">$&#123;SW_SERVICE_NAME:"SkyWalking_OAP_Cluster"&#125;</span></span><br><span class="line"><span class="attr">    hostPort:</span> <span class="string">$&#123;SW_CLUSTER_NACOS_HOST_PORT:localhost:8848&#125;</span></span><br><span class="line">    <span class="comment"># Nacos Configuration namespace</span></span><br><span class="line"><span class="attr">    namespace:</span> <span class="string">$&#123;SW_CLUSTER_NACOS_NAMESPACE:"public"&#125;</span></span><br><span class="line">    <span class="comment"># Nacos auth username</span></span><br><span class="line"><span class="attr">    username:</span> <span class="string">$&#123;SW_CLUSTER_NACOS_USERNAME:""&#125;</span></span><br><span class="line"><span class="attr">    password:</span> <span class="string">$&#123;SW_CLUSTER_NACOS_PASSWORD:""&#125;</span></span><br><span class="line">    <span class="comment"># Nacos auth accessKey</span></span><br><span class="line"><span class="attr">    accessKey:</span> <span class="string">$&#123;SW_CLUSTER_NACOS_ACCESSKEY:""&#125;</span></span><br><span class="line"><span class="attr">    secretKey:</span> <span class="string">$&#123;SW_CLUSTER_NACOS_SECRETKEY:""&#125;</span></span><br><span class="line"><span class="attr">core:</span></span><br><span class="line"><span class="attr">  selector:</span> <span class="string">$&#123;SW_CORE:default&#125;</span></span><br><span class="line"><span class="attr">  default:</span></span><br><span class="line">    <span class="comment"># Mixed: Receive agent data, Level 1 aggregate, Level 2 aggregate</span></span><br><span class="line">    <span class="comment"># Receiver: Receive agent data, Level 1 aggregate</span></span><br><span class="line">    <span class="comment"># Aggregator: Level 2 aggregate</span></span><br><span class="line"><span class="attr">    role:</span> <span class="string">$&#123;SW_CORE_ROLE:Mixed&#125;</span> <span class="comment"># Mixed/Receiver/Aggregator</span></span><br><span class="line"><span class="attr">    restHost:</span> <span class="string">$&#123;SW_CORE_REST_HOST:0.0.0.0&#125;</span></span><br><span class="line"><span class="attr">    restPort:</span> <span class="string">$&#123;SW_CORE_REST_PORT:12800&#125;</span></span><br><span class="line"><span class="attr">    restContextPath:</span> <span class="string">$&#123;SW_CORE_REST_CONTEXT_PATH:/&#125;</span></span><br><span class="line"><span class="attr">    restMinThreads:</span> <span class="string">$&#123;SW_CORE_REST_JETTY_MIN_THREADS:1&#125;</span></span><br><span class="line"><span class="attr">    restMaxThreads:</span> <span class="string">$&#123;SW_CORE_REST_JETTY_MAX_THREADS:200&#125;</span></span><br><span class="line"><span class="attr">    restIdleTimeOut:</span> <span class="string">$&#123;SW_CORE_REST_JETTY_IDLE_TIMEOUT:30000&#125;</span></span><br><span class="line"><span class="attr">    restAcceptorPriorityDelta:</span> <span class="string">$&#123;SW_CORE_REST_JETTY_DELTA:0&#125;</span></span><br><span class="line"><span class="attr">    restAcceptQueueSize:</span> <span class="string">$&#123;SW_CORE_REST_JETTY_QUEUE_SIZE:0&#125;</span></span><br><span class="line"><span class="attr">    gRPCHost:</span> <span class="string">$&#123;SW_CORE_GRPC_HOST:0.0.0.0&#125;</span></span><br><span class="line"><span class="attr">    gRPCPort:</span> <span class="string">$&#123;SW_CORE_GRPC_PORT:11800&#125;</span></span><br><span class="line"><span class="attr">    maxConcurrentCallsPerConnection:</span> <span class="string">$&#123;SW_CORE_GRPC_MAX_CONCURRENT_CALL:0&#125;</span></span><br><span class="line"><span class="attr">    maxMessageSize:</span> <span class="string">$&#123;SW_CORE_GRPC_MAX_MESSAGE_SIZE:0&#125;</span></span><br><span class="line"><span class="attr">    gRPCThreadPoolQueueSize:</span> <span class="string">$&#123;SW_CORE_GRPC_POOL_QUEUE_SIZE:-1&#125;</span></span><br><span class="line"><span class="attr">    gRPCThreadPoolSize:</span> <span class="string">$&#123;SW_CORE_GRPC_THREAD_POOL_SIZE:-1&#125;</span></span><br><span class="line"><span class="attr">    gRPCSslEnabled:</span> <span class="string">$&#123;SW_CORE_GRPC_SSL_ENABLED:false&#125;</span></span><br><span class="line"><span class="attr">    gRPCSslKeyPath:</span> <span class="string">$&#123;SW_CORE_GRPC_SSL_KEY_PATH:""&#125;</span></span><br><span class="line"><span class="attr">    gRPCSslCertChainPath:</span> <span class="string">$&#123;SW_CORE_GRPC_SSL_CERT_CHAIN_PATH:""&#125;</span></span><br><span class="line"><span class="attr">    gRPCSslTrustedCAPath:</span> <span class="string">$&#123;SW_CORE_GRPC_SSL_TRUSTED_CA_PATH:""&#125;</span></span><br><span class="line"><span class="attr">    downsampling:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">Hour</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">Day</span></span><br><span class="line">    <span class="comment"># Set a timeout on metrics data. After the timeout has expired, the metrics data will automatically be deleted.</span></span><br><span class="line"><span class="attr">    enableDataKeeperExecutor:</span> <span class="string">$&#123;SW_CORE_ENABLE_DATA_KEEPER_EXECUTOR:true&#125;</span> <span class="comment"># Turn it off then automatically metrics data delete will be close.</span></span><br><span class="line"><span class="attr">    dataKeeperExecutePeriod:</span> <span class="string">$&#123;SW_CORE_DATA_KEEPER_EXECUTE_PERIOD:5&#125;</span> <span class="comment"># How often the data keeper executor runs periodically, unit is minute</span></span><br><span class="line"><span class="attr">    recordDataTTL:</span> <span class="string">$&#123;SW_CORE_RECORD_DATA_TTL:3&#125;</span> <span class="comment"># Unit is day</span></span><br><span class="line"><span class="attr">    metricsDataTTL:</span> <span class="string">$&#123;SW_CORE_METRICS_DATA_TTL:7&#125;</span> <span class="comment"># Unit is day</span></span><br><span class="line">    <span class="comment"># Cache metrics data for 1 minute to reduce database queries, and if the OAP cluster changes within that minute,</span></span><br><span class="line">    <span class="comment"># the metrics may not be accurate within that minute.</span></span><br><span class="line"><span class="attr">    enableDatabaseSession:</span> <span class="string">$&#123;SW_CORE_ENABLE_DATABASE_SESSION:true&#125;</span></span><br><span class="line"><span class="attr">    topNReportPeriod:</span> <span class="string">$&#123;SW_CORE_TOPN_REPORT_PERIOD:10&#125;</span> <span class="comment"># top_n record worker report cycle, unit is minute</span></span><br><span class="line">    <span class="comment"># Extra model column are the column defined by in the codes, These columns of model are not required logically in aggregation or further query,</span></span><br><span class="line">    <span class="comment"># and it will cause more load for memory, network of OAP and storage.</span></span><br><span class="line">    <span class="comment"># But, being activated, user could see the name in the storage entities, which make users easier to use 3rd party tool, such as Kibana-&gt;ES, to query the data by themselves.</span></span><br><span class="line"><span class="attr">    activeExtraModelColumns:</span> <span class="string">$&#123;SW_CORE_ACTIVE_EXTRA_MODEL_COLUMNS:false&#125;</span></span><br><span class="line">    <span class="comment"># The max length of service + instance names should be less than 200</span></span><br><span class="line"><span class="attr">    serviceNameMaxLength:</span> <span class="string">$&#123;SW_SERVICE_NAME_MAX_LENGTH:70&#125;</span></span><br><span class="line"><span class="attr">    instanceNameMaxLength:</span> <span class="string">$&#123;SW_INSTANCE_NAME_MAX_LENGTH:70&#125;</span></span><br><span class="line">    <span class="comment"># The max length of service + endpoint names should be less than 240</span></span><br><span class="line"><span class="attr">    endpointNameMaxLength:</span> <span class="string">$&#123;SW_ENDPOINT_NAME_MAX_LENGTH:150&#125;</span></span><br><span class="line">    <span class="comment"># Define the set of span tag keys, which should be searchable through the GraphQL.</span></span><br><span class="line"><span class="attr">    searchableTracesTags:</span> <span class="string">$&#123;SW_SEARCHABLE_TAG_KEYS:http.method,status_code,db.type,db.instance,mq.queue,mq.topic,mq.broker&#125;</span></span><br><span class="line"><span class="attr">storage:</span></span><br><span class="line"><span class="attr">  selector:</span> <span class="string">$&#123;SW_STORAGE:h2&#125;</span></span><br><span class="line"><span class="attr">  elasticsearch:</span></span><br><span class="line"><span class="attr">    nameSpace:</span> <span class="string">$&#123;SW_NAMESPACE:""&#125;</span></span><br><span class="line"><span class="attr">    clusterNodes:</span> <span class="string">$&#123;SW_STORAGE_ES_CLUSTER_NODES:localhost:9200&#125;</span></span><br><span class="line"><span class="attr">    protocol:</span> <span class="string">$&#123;SW_STORAGE_ES_HTTP_PROTOCOL:"http"&#125;</span></span><br><span class="line"><span class="attr">    user:</span> <span class="string">$&#123;SW_ES_USER:""&#125;</span></span><br><span class="line"><span class="attr">    password:</span> <span class="string">$&#123;SW_ES_PASSWORD:""&#125;</span></span><br><span class="line"><span class="attr">    trustStorePath:</span> <span class="string">$&#123;SW_STORAGE_ES_SSL_JKS_PATH:""&#125;</span></span><br><span class="line"><span class="attr">    trustStorePass:</span> <span class="string">$&#123;SW_STORAGE_ES_SSL_JKS_PASS:""&#125;</span></span><br><span class="line"><span class="attr">    secretsManagementFile:</span> <span class="string">$&#123;SW_ES_SECRETS_MANAGEMENT_FILE:""&#125;</span> <span class="comment"># Secrets management file in the properties format includes the username, password, which are managed by 3rd party tool.</span></span><br><span class="line"><span class="attr">    dayStep:</span> <span class="string">$&#123;SW_STORAGE_DAY_STEP:1&#125;</span> <span class="comment"># Represent the number of days in the one minute/hour/day index.</span></span><br><span class="line"><span class="attr">    indexShardsNumber:</span> <span class="string">$&#123;SW_STORAGE_ES_INDEX_SHARDS_NUMBER:1&#125;</span> <span class="comment"># Shard number of new indexes</span></span><br><span class="line"><span class="attr">    indexReplicasNumber:</span> <span class="string">$&#123;SW_STORAGE_ES_INDEX_REPLICAS_NUMBER:1&#125;</span> <span class="comment"># Replicas number of new indexes</span></span><br><span class="line">    <span class="comment"># Super data set has been defined in the codes, such as trace segments.The following 3 config would be improve es performance when storage super size data in es.</span></span><br><span class="line"><span class="attr">    superDatasetDayStep:</span> <span class="string">$&#123;SW_SUPERDATASET_STORAGE_DAY_STEP:-1&#125;</span> <span class="comment"># Represent the number of days in the super size dataset record index, the default value is the same as dayStep when the value is less than 0</span></span><br><span class="line"><span class="attr">    superDatasetIndexShardsFactor:</span> <span class="string">$&#123;SW_STORAGE_ES_SUPER_DATASET_INDEX_SHARDS_FACTOR:5&#125;</span> <span class="comment">#  This factor provides more shards for the super data set, shards number = indexShardsNumber * superDatasetIndexShardsFactor. Also, this factor effects Zipkin and Jaeger traces.</span></span><br><span class="line"><span class="attr">    superDatasetIndexReplicasNumber:</span> <span class="string">$&#123;SW_STORAGE_ES_SUPER_DATASET_INDEX_REPLICAS_NUMBER:0&#125;</span> <span class="comment"># Represent the replicas number in the super size dataset record index, the default value is 0.</span></span><br><span class="line"><span class="attr">    bulkActions:</span> <span class="string">$&#123;SW_STORAGE_ES_BULK_ACTIONS:1000&#125;</span> <span class="comment"># Execute the async bulk record data every $&#123;SW_STORAGE_ES_BULK_ACTIONS&#125; requests</span></span><br><span class="line"><span class="attr">    syncBulkActions:</span> <span class="string">$&#123;SW_STORAGE_ES_SYNC_BULK_ACTIONS:50000&#125;</span> <span class="comment"># Execute the sync bulk metrics data every $&#123;SW_STORAGE_ES_SYNC_BULK_ACTIONS&#125; requests</span></span><br><span class="line"><span class="attr">    flushInterval:</span> <span class="string">$&#123;SW_STORAGE_ES_FLUSH_INTERVAL:10&#125;</span> <span class="comment"># flush the bulk every 10 seconds whatever the number of requests</span></span><br><span class="line"><span class="attr">    concurrentRequests:</span> <span class="string">$&#123;SW_STORAGE_ES_CONCURRENT_REQUESTS:2&#125;</span> <span class="comment"># the number of concurrent requests</span></span><br><span class="line"><span class="attr">    resultWindowMaxSize:</span> <span class="string">$&#123;SW_STORAGE_ES_QUERY_MAX_WINDOW_SIZE:10000&#125;</span></span><br><span class="line"><span class="attr">    metadataQueryMaxSize:</span> <span class="string">$&#123;SW_STORAGE_ES_QUERY_MAX_SIZE:5000&#125;</span></span><br><span class="line"><span class="attr">    segmentQueryMaxSize:</span> <span class="string">$&#123;SW_STORAGE_ES_QUERY_SEGMENT_SIZE:200&#125;</span></span><br><span class="line"><span class="attr">    profileTaskQueryMaxSize:</span> <span class="string">$&#123;SW_STORAGE_ES_QUERY_PROFILE_TASK_SIZE:200&#125;</span></span><br><span class="line"><span class="attr">    advanced:</span> <span class="string">$&#123;SW_STORAGE_ES_ADVANCED:""&#125;</span></span><br><span class="line"><span class="attr">  elasticsearch7:</span></span><br><span class="line"><span class="attr">    nameSpace:</span> <span class="string">$&#123;SW_NAMESPACE:""&#125;</span></span><br><span class="line"><span class="attr">    clusterNodes:</span> <span class="string">$&#123;SW_STORAGE_ES_CLUSTER_NODES:localhost:9200&#125;</span></span><br><span class="line"><span class="attr">    protocol:</span> <span class="string">$&#123;SW_STORAGE_ES_HTTP_PROTOCOL:"http"&#125;</span></span><br><span class="line"><span class="attr">    trustStorePath:</span> <span class="string">$&#123;SW_STORAGE_ES_SSL_JKS_PATH:""&#125;</span></span><br><span class="line"><span class="attr">    trustStorePass:</span> <span class="string">$&#123;SW_STORAGE_ES_SSL_JKS_PASS:""&#125;</span></span><br><span class="line"><span class="attr">    dayStep:</span> <span class="string">$&#123;SW_STORAGE_DAY_STEP:1&#125;</span> <span class="comment"># Represent the number of days in the one minute/hour/day index.</span></span><br><span class="line"><span class="attr">    indexShardsNumber:</span> <span class="string">$&#123;SW_STORAGE_ES_INDEX_SHARDS_NUMBER:1&#125;</span> <span class="comment"># Shard number of new indexes</span></span><br><span class="line"><span class="attr">    indexReplicasNumber:</span> <span class="string">$&#123;SW_STORAGE_ES_INDEX_REPLICAS_NUMBER:1&#125;</span> <span class="comment"># Replicas number of new indexes</span></span><br><span class="line">    <span class="comment"># Super data set has been defined in the codes, such as trace segments.The following 3 config would be improve es performance when storage super size data in es.</span></span><br><span class="line"><span class="attr">    superDatasetDayStep:</span> <span class="string">$&#123;SW_SUPERDATASET_STORAGE_DAY_STEP:-1&#125;</span> <span class="comment"># Represent the number of days in the super size dataset record index, the default value is the same as dayStep when the value is less than 0</span></span><br><span class="line"><span class="attr">    superDatasetIndexShardsFactor:</span> <span class="string">$&#123;SW_STORAGE_ES_SUPER_DATASET_INDEX_SHARDS_FACTOR:5&#125;</span> <span class="comment">#  This factor provides more shards for the super data set, shards number = indexShardsNumber * superDatasetIndexShardsFactor. Also, this factor effects Zipkin and Jaeger traces.</span></span><br><span class="line"><span class="attr">    superDatasetIndexReplicasNumber:</span> <span class="string">$&#123;SW_STORAGE_ES_SUPER_DATASET_INDEX_REPLICAS_NUMBER:0&#125;</span> <span class="comment"># Represent the replicas number in the super size dataset record index, the default value is 0.</span></span><br><span class="line"><span class="attr">    user:</span> <span class="string">$&#123;SW_ES_USER:""&#125;</span></span><br><span class="line"><span class="attr">    password:</span> <span class="string">$&#123;SW_ES_PASSWORD:""&#125;</span></span><br><span class="line"><span class="attr">    secretsManagementFile:</span> <span class="string">$&#123;SW_ES_SECRETS_MANAGEMENT_FILE:""&#125;</span> <span class="comment"># Secrets management file in the properties format includes the username, password, which are managed by 3rd party tool.</span></span><br><span class="line"><span class="attr">    bulkActions:</span> <span class="string">$&#123;SW_STORAGE_ES_BULK_ACTIONS:1000&#125;</span> <span class="comment"># Execute the async bulk record data every $&#123;SW_STORAGE_ES_BULK_ACTIONS&#125; requests</span></span><br><span class="line"><span class="attr">    syncBulkActions:</span> <span class="string">$&#123;SW_STORAGE_ES_SYNC_BULK_ACTIONS:50000&#125;</span> <span class="comment"># Execute the sync bulk metrics data every $&#123;SW_STORAGE_ES_SYNC_BULK_ACTIONS&#125; requests</span></span><br><span class="line"><span class="attr">    flushInterval:</span> <span class="string">$&#123;SW_STORAGE_ES_FLUSH_INTERVAL:10&#125;</span> <span class="comment"># flush the bulk every 10 seconds whatever the number of requests</span></span><br><span class="line"><span class="attr">    concurrentRequests:</span> <span class="string">$&#123;SW_STORAGE_ES_CONCURRENT_REQUESTS:2&#125;</span> <span class="comment"># the number of concurrent requests</span></span><br><span class="line"><span class="attr">    resultWindowMaxSize:</span> <span class="string">$&#123;SW_STORAGE_ES_QUERY_MAX_WINDOW_SIZE:10000&#125;</span></span><br><span class="line"><span class="attr">    metadataQueryMaxSize:</span> <span class="string">$&#123;SW_STORAGE_ES_QUERY_MAX_SIZE:5000&#125;</span></span><br><span class="line"><span class="attr">    segmentQueryMaxSize:</span> <span class="string">$&#123;SW_STORAGE_ES_QUERY_SEGMENT_SIZE:200&#125;</span></span><br><span class="line"><span class="attr">    profileTaskQueryMaxSize:</span> <span class="string">$&#123;SW_STORAGE_ES_QUERY_PROFILE_TASK_SIZE:200&#125;</span></span><br><span class="line"><span class="attr">    advanced:</span> <span class="string">$&#123;SW_STORAGE_ES_ADVANCED:""&#125;</span></span><br><span class="line"><span class="attr">  h2:</span></span><br><span class="line"><span class="attr">    driver:</span> <span class="string">$&#123;SW_STORAGE_H2_DRIVER:org.h2.jdbcx.JdbcDataSource&#125;</span></span><br><span class="line"><span class="attr">    url:</span> <span class="string">$&#123;SW_STORAGE_H2_URL:jdbc:h2:mem:skywalking-oap-db&#125;</span></span><br><span class="line"><span class="attr">    user:</span> <span class="string">$&#123;SW_STORAGE_H2_USER:sa&#125;</span></span><br><span class="line"><span class="attr">    metadataQueryMaxSize:</span> <span class="string">$&#123;SW_STORAGE_H2_QUERY_MAX_SIZE:5000&#125;</span></span><br><span class="line"><span class="attr">    maxSizeOfArrayColumn:</span> <span class="string">$&#123;SW_STORAGE_MAX_SIZE_OF_ARRAY_COLUMN:20&#125;</span></span><br><span class="line"><span class="attr">    numOfSearchableValuesPerTag:</span> <span class="string">$&#123;SW_STORAGE_NUM_OF_SEARCHABLE_VALUES_PER_TAG:2&#125;</span></span><br><span class="line"><span class="attr">  mysql:</span></span><br><span class="line"><span class="attr">    properties:</span></span><br><span class="line"><span class="attr">      jdbcUrl:</span> <span class="string">$&#123;SW_JDBC_URL:"jdbc:mysql://localhost:3306/swtest"&#125;</span></span><br><span class="line">      <span class="string">dataSource.user:</span> <span class="string">$&#123;SW_DATA_SOURCE_USER:root&#125;</span></span><br><span class="line">      <span class="string">dataSource.password:</span> <span class="string">$&#123;SW_DATA_SOURCE_PASSWORD:root@1234&#125;</span></span><br><span class="line">      <span class="string">dataSource.cachePrepStmts:</span> <span class="string">$&#123;SW_DATA_SOURCE_CACHE_PREP_STMTS:true&#125;</span></span><br><span class="line">      <span class="string">dataSource.prepStmtCacheSize:</span> <span class="string">$&#123;SW_DATA_SOURCE_PREP_STMT_CACHE_SQL_SIZE:250&#125;</span></span><br><span class="line">      <span class="string">dataSource.prepStmtCacheSqlLimit:</span> <span class="string">$&#123;SW_DATA_SOURCE_PREP_STMT_CACHE_SQL_LIMIT:2048&#125;</span></span><br><span class="line">      <span class="string">dataSource.useServerPrepStmts:</span> <span class="string">$&#123;SW_DATA_SOURCE_USE_SERVER_PREP_STMTS:true&#125;</span></span><br><span class="line"><span class="attr">    metadataQueryMaxSize:</span> <span class="string">$&#123;SW_STORAGE_MYSQL_QUERY_MAX_SIZE:5000&#125;</span></span><br><span class="line"><span class="attr">    maxSizeOfArrayColumn:</span> <span class="string">$&#123;SW_STORAGE_MAX_SIZE_OF_ARRAY_COLUMN:20&#125;</span></span><br><span class="line"><span class="attr">    numOfSearchableValuesPerTag:</span> <span class="string">$&#123;SW_STORAGE_NUM_OF_SEARCHABLE_VALUES_PER_TAG:2&#125;</span></span><br><span class="line"><span class="attr">  tidb:</span></span><br><span class="line"><span class="attr">    properties:</span></span><br><span class="line"><span class="attr">      jdbcUrl:</span> <span class="string">$&#123;SW_JDBC_URL:"jdbc:mysql://localhost:4000/tidbswtest"&#125;</span></span><br><span class="line">      <span class="string">dataSource.user:</span> <span class="string">$&#123;SW_DATA_SOURCE_USER:root&#125;</span></span><br><span class="line">      <span class="string">dataSource.password:</span> <span class="string">$&#123;SW_DATA_SOURCE_PASSWORD:""&#125;</span></span><br><span class="line">      <span class="string">dataSource.cachePrepStmts:</span> <span class="string">$&#123;SW_DATA_SOURCE_CACHE_PREP_STMTS:true&#125;</span></span><br><span class="line">      <span class="string">dataSource.prepStmtCacheSize:</span> <span class="string">$&#123;SW_DATA_SOURCE_PREP_STMT_CACHE_SQL_SIZE:250&#125;</span></span><br><span class="line">      <span class="string">dataSource.prepStmtCacheSqlLimit:</span> <span class="string">$&#123;SW_DATA_SOURCE_PREP_STMT_CACHE_SQL_LIMIT:2048&#125;</span></span><br><span class="line">      <span class="string">dataSource.useServerPrepStmts:</span> <span class="string">$&#123;SW_DATA_SOURCE_USE_SERVER_PREP_STMTS:true&#125;</span></span><br><span class="line">      <span class="string">dataSource.useAffectedRows:</span> <span class="string">$&#123;SW_DATA_SOURCE_USE_AFFECTED_ROWS:true&#125;</span></span><br><span class="line"><span class="attr">    metadataQueryMaxSize:</span> <span class="string">$&#123;SW_STORAGE_MYSQL_QUERY_MAX_SIZE:5000&#125;</span></span><br><span class="line"><span class="attr">    maxSizeOfArrayColumn:</span> <span class="string">$&#123;SW_STORAGE_MAX_SIZE_OF_ARRAY_COLUMN:20&#125;</span></span><br><span class="line"><span class="attr">    numOfSearchableValuesPerTag:</span> <span class="string">$&#123;SW_STORAGE_NUM_OF_SEARCHABLE_VALUES_PER_TAG:2&#125;</span></span><br><span class="line"><span class="attr">  influxdb:</span></span><br><span class="line">    <span class="comment"># InfluxDB configuration</span></span><br><span class="line"><span class="attr">    url:</span> <span class="string">$&#123;SW_STORAGE_INFLUXDB_URL:http://localhost:8086&#125;</span></span><br><span class="line"><span class="attr">    user:</span> <span class="string">$&#123;SW_STORAGE_INFLUXDB_USER:root&#125;</span></span><br><span class="line"><span class="attr">    password:</span> <span class="string">$&#123;SW_STORAGE_INFLUXDB_PASSWORD:&#125;</span></span><br><span class="line"><span class="attr">    database:</span> <span class="string">$&#123;SW_STORAGE_INFLUXDB_DATABASE:skywalking&#125;</span></span><br><span class="line"><span class="attr">    actions:</span> <span class="string">$&#123;SW_STORAGE_INFLUXDB_ACTIONS:1000&#125;</span> <span class="comment"># the number of actions to collect</span></span><br><span class="line"><span class="attr">    duration:</span> <span class="string">$&#123;SW_STORAGE_INFLUXDB_DURATION:1000&#125;</span> <span class="comment"># the time to wait at most (milliseconds)</span></span><br><span class="line"><span class="attr">    batchEnabled:</span> <span class="string">$&#123;SW_STORAGE_INFLUXDB_BATCH_ENABLED:true&#125;</span></span><br><span class="line"><span class="attr">    fetchTaskLogMaxSize:</span> <span class="string">$&#123;SW_STORAGE_INFLUXDB_FETCH_TASK_LOG_MAX_SIZE:5000&#125;</span> <span class="comment"># the max number of fetch task log in a request</span></span><br><span class="line"></span><br><span class="line"><span class="attr">agent-analyzer:</span></span><br><span class="line"><span class="attr">  selector:</span> <span class="string">$&#123;SW_AGENT_ANALYZER:default&#125;</span></span><br><span class="line"><span class="attr">  default:</span></span><br><span class="line"><span class="attr">    sampleRate:</span> <span class="string">$&#123;SW_TRACE_SAMPLE_RATE:10000&#125;</span> <span class="comment"># The sample rate precision is 1/10000. 10000 means 100% sample in default.</span></span><br><span class="line"><span class="attr">    slowDBAccessThreshold:</span> <span class="string">$&#123;SW_SLOW_DB_THRESHOLD:default:200,mongodb:100&#125;</span> <span class="comment"># The slow database access thresholds. Unit ms.</span></span><br><span class="line"><span class="attr">    forceSampleErrorSegment:</span> <span class="string">$&#123;SW_FORCE_SAMPLE_ERROR_SEGMENT:true&#125;</span> <span class="comment"># When sampling mechanism active, this config can open(true) force save some error segment. true is default.</span></span><br><span class="line"><span class="attr">    segmentStatusAnalysisStrategy:</span> <span class="string">$&#123;SW_SEGMENT_STATUS_ANALYSIS_STRATEGY:FROM_SPAN_STATUS&#125;</span> <span class="comment"># Determine the final segment status from the status of spans. Available values are `FROM_SPAN_STATUS` , `FROM_ENTRY_SPAN` and `FROM_FIRST_SPAN`. `FROM_SPAN_STATUS` represents the segment status would be error if any span is in error status. `FROM_ENTRY_SPAN` means the segment status would be determined by the status of entry spans only. `FROM_FIRST_SPAN` means the segment status would be determined by the status of the first span only.</span></span><br><span class="line">    <span class="comment"># Nginx and Envoy agents can't get the real remote address.</span></span><br><span class="line">    <span class="comment"># Exit spans with the component in the list would not generate the client-side instance relation metrics.</span></span><br><span class="line"><span class="attr">    noUpstreamRealAddressAgents:</span> <span class="string">$&#123;SW_NO_UPSTREAM_REAL_ADDRESS:6000,9000&#125;</span></span><br><span class="line"><span class="attr">    slowTraceSegmentThreshold:</span> <span class="string">$&#123;SW_SLOW_TRACE_SEGMENT_THRESHOLD:-1&#125;</span> <span class="comment"># Setting this threshold about the latency would make the slow trace segments sampled if they cost more time, even the sampling mechanism activated. The default value is `-1`, which means would not sample slow traces. Unit, millisecond.</span></span><br><span class="line"><span class="attr">    meterAnalyzerActiveFiles:</span> <span class="string">$&#123;SW_METER_ANALYZER_ACTIVE_FILES:&#125;</span> <span class="comment"># Which files could be meter analyzed, files split by ","</span></span><br><span class="line"></span><br><span class="line"><span class="attr">receiver-sharing-server:</span></span><br><span class="line"><span class="attr">  selector:</span> <span class="string">$&#123;SW_RECEIVER_SHARING_SERVER:default&#125;</span></span><br><span class="line"><span class="attr">  default:</span></span><br><span class="line">    <span class="comment"># For Jetty server</span></span><br><span class="line"><span class="attr">    restHost:</span> <span class="string">$&#123;SW_RECEIVER_SHARING_REST_HOST:0.0.0.0&#125;</span></span><br><span class="line"><span class="attr">    restPort:</span> <span class="string">$&#123;SW_RECEIVER_SHARING_REST_PORT:0&#125;</span></span><br><span class="line"><span class="attr">    contextPath:</span> <span class="string">$&#123;SW_RECEIVER_SHARING_REST_CONTEXT_PATH:/&#125;</span></span><br><span class="line"><span class="attr">    restMinThreads:</span> <span class="string">$&#123;SW_RECEIVER_SHARING_JETTY_MIN_THREADS:1&#125;</span></span><br><span class="line"><span class="attr">    restMaxThreads:</span> <span class="string">$&#123;SW_RECEIVER_SHARING_JETTY_MAX_THREADS:200&#125;</span></span><br><span class="line"><span class="attr">    restIdleTimeOut:</span> <span class="string">$&#123;SW_RECEIVER_SHARING_JETTY_IDLE_TIMEOUT:30000&#125;</span></span><br><span class="line"><span class="attr">    restAcceptorPriorityDelta:</span> <span class="string">$&#123;SW_RECEIVER_SHARING_JETTY_DELTA:0&#125;</span></span><br><span class="line"><span class="attr">    restAcceptQueueSize:</span> <span class="string">$&#123;SW_RECEIVER_SHARING_JETTY_QUEUE_SIZE:0&#125;</span></span><br><span class="line">    <span class="comment"># For gRPC server</span></span><br><span class="line"><span class="attr">    gRPCHost:</span> <span class="string">$&#123;SW_RECEIVER_GRPC_HOST:0.0.0.0&#125;</span></span><br><span class="line"><span class="attr">    gRPCPort:</span> <span class="string">$&#123;SW_RECEIVER_GRPC_PORT:0&#125;</span></span><br><span class="line"><span class="attr">    maxConcurrentCallsPerConnection:</span> <span class="string">$&#123;SW_RECEIVER_GRPC_MAX_CONCURRENT_CALL:0&#125;</span></span><br><span class="line"><span class="attr">    maxMessageSize:</span> <span class="string">$&#123;SW_RECEIVER_GRPC_MAX_MESSAGE_SIZE:0&#125;</span></span><br><span class="line"><span class="attr">    gRPCThreadPoolQueueSize:</span> <span class="string">$&#123;SW_RECEIVER_GRPC_POOL_QUEUE_SIZE:0&#125;</span></span><br><span class="line"><span class="attr">    gRPCThreadPoolSize:</span> <span class="string">$&#123;SW_RECEIVER_GRPC_THREAD_POOL_SIZE:0&#125;</span></span><br><span class="line"><span class="attr">    gRPCSslEnabled:</span> <span class="string">$&#123;SW_RECEIVER_GRPC_SSL_ENABLED:false&#125;</span></span><br><span class="line"><span class="attr">    gRPCSslKeyPath:</span> <span class="string">$&#123;SW_RECEIVER_GRPC_SSL_KEY_PATH:""&#125;</span></span><br><span class="line"><span class="attr">    gRPCSslCertChainPath:</span> <span class="string">$&#123;SW_RECEIVER_GRPC_SSL_CERT_CHAIN_PATH:""&#125;</span></span><br><span class="line"><span class="attr">    authentication:</span> <span class="string">$&#123;SW_AUTHENTICATION:""&#125;</span></span><br><span class="line"><span class="attr">receiver-register:</span></span><br><span class="line"><span class="attr">  selector:</span> <span class="string">$&#123;SW_RECEIVER_REGISTER:default&#125;</span></span><br><span class="line"><span class="attr">  default:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">receiver-trace:</span></span><br><span class="line"><span class="attr">  selector:</span> <span class="string">$&#123;SW_RECEIVER_TRACE:default&#125;</span></span><br><span class="line"><span class="attr">  default:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">receiver-jvm:</span></span><br><span class="line"><span class="attr">  selector:</span> <span class="string">$&#123;SW_RECEIVER_JVM:default&#125;</span></span><br><span class="line"><span class="attr">  default:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">receiver-clr:</span></span><br><span class="line"><span class="attr">  selector:</span> <span class="string">$&#123;SW_RECEIVER_CLR:default&#125;</span></span><br><span class="line"><span class="attr">  default:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">receiver-profile:</span></span><br><span class="line"><span class="attr">  selector:</span> <span class="string">$&#123;SW_RECEIVER_PROFILE:default&#125;</span></span><br><span class="line"><span class="attr">  default:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">service-mesh:</span></span><br><span class="line"><span class="attr">  selector:</span> <span class="string">$&#123;SW_SERVICE_MESH:default&#125;</span></span><br><span class="line"><span class="attr">  default:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">envoy-metric:</span></span><br><span class="line"><span class="attr">  selector:</span> <span class="string">$&#123;SW_ENVOY_METRIC:default&#125;</span></span><br><span class="line"><span class="attr">  default:</span></span><br><span class="line"><span class="attr">    acceptMetricsService:</span> <span class="string">$&#123;SW_ENVOY_METRIC_SERVICE:true&#125;</span></span><br><span class="line"><span class="attr">    alsHTTPAnalysis:</span> <span class="string">$&#123;SW_ENVOY_METRIC_ALS_HTTP_ANALYSIS:""&#125;</span></span><br><span class="line">    <span class="comment"># `k8sServiceNameRule` allows you to customize the service name in ALS via Kubernetes metadata,</span></span><br><span class="line">    <span class="comment"># the available variables are `pod`, `service`, f.e., you can use `$&#123;service.metadata.name&#125;-$&#123;pod.metadata.labels.version&#125;`</span></span><br><span class="line">    <span class="comment"># to append the version number to the service name.</span></span><br><span class="line">    <span class="comment"># Be careful, when using environment variables to pass this configuration, use single quotes(`''`) to avoid it being evaluated by the shell.</span></span><br><span class="line"><span class="attr">    k8sServiceNameRule:</span> <span class="string">$&#123;K8S_SERVICE_NAME_RULE:"$&#123;service.metadata.name&#125;"&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">prometheus-fetcher:</span></span><br><span class="line"><span class="attr">  selector:</span> <span class="string">$&#123;SW_PROMETHEUS_FETCHER:-&#125;</span></span><br><span class="line"><span class="attr">  default:</span></span><br><span class="line"><span class="attr">    enabledRules:</span> <span class="string">$&#123;SW_PROMETHEUS_FETCHER_ENABLED_RULES:"self"&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">kafka-fetcher:</span></span><br><span class="line"><span class="attr">  selector:</span> <span class="string">$&#123;SW_KAFKA_FETCHER:-&#125;</span></span><br><span class="line"><span class="attr">  default:</span></span><br><span class="line"><span class="attr">    bootstrapServers:</span> <span class="string">$&#123;SW_KAFKA_FETCHER_SERVERS:localhost:9092&#125;</span></span><br><span class="line"><span class="attr">    partitions:</span> <span class="string">$&#123;SW_KAFKA_FETCHER_PARTITIONS:3&#125;</span></span><br><span class="line"><span class="attr">    replicationFactor:</span> <span class="string">$&#123;SW_KAFKA_FETCHER_PARTITIONS_FACTOR:2&#125;</span></span><br><span class="line"><span class="attr">    enableMeterSystem:</span> <span class="string">$&#123;SW_KAFKA_FETCHER_ENABLE_METER_SYSTEM:false&#125;</span></span><br><span class="line"><span class="attr">    isSharding:</span> <span class="string">$&#123;SW_KAFKA_FETCHER_IS_SHARDING:false&#125;</span></span><br><span class="line"><span class="attr">    consumePartitions:</span> <span class="string">$&#123;SW_KAFKA_FETCHER_CONSUME_PARTITIONS:""&#125;</span></span><br><span class="line"><span class="attr">    kafkaHandlerThreadPoolSize:</span> <span class="string">$&#123;SW_KAFKA_HANDLER_THREAD_POOL_SIZE:-1&#125;</span></span><br><span class="line"><span class="attr">    kafkaHandlerThreadPoolQueueSize:</span> <span class="string">$&#123;SW_KAFKA_HANDLER_THREAD_POOL_QUEUE_SIZE:-1&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">receiver-meter:</span></span><br><span class="line"><span class="attr">  selector:</span> <span class="string">$&#123;SW_RECEIVER_METER:default&#125;</span></span><br><span class="line"><span class="attr">  default:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">receiver-otel:</span></span><br><span class="line"><span class="attr">  selector:</span> <span class="string">$&#123;SW_OTEL_RECEIVER:-&#125;</span></span><br><span class="line"><span class="attr">  default:</span></span><br><span class="line"><span class="attr">    enabledHandlers:</span> <span class="string">$&#123;SW_OTEL_RECEIVER_ENABLED_HANDLERS:"oc"&#125;</span></span><br><span class="line"><span class="attr">    enabledOcRules:</span> <span class="string">$&#123;SW_OTEL_RECEIVER_ENABLED_OC_RULES:"istio-controlplane"&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">receiver_zipkin:</span></span><br><span class="line"><span class="attr">  selector:</span> <span class="string">$&#123;SW_RECEIVER_ZIPKIN:-&#125;</span></span><br><span class="line"><span class="attr">  default:</span></span><br><span class="line"><span class="attr">    host:</span> <span class="string">$&#123;SW_RECEIVER_ZIPKIN_HOST:0.0.0.0&#125;</span></span><br><span class="line"><span class="attr">    port:</span> <span class="string">$&#123;SW_RECEIVER_ZIPKIN_PORT:9411&#125;</span></span><br><span class="line"><span class="attr">    contextPath:</span> <span class="string">$&#123;SW_RECEIVER_ZIPKIN_CONTEXT_PATH:/&#125;</span></span><br><span class="line"><span class="attr">    jettyMinThreads:</span> <span class="string">$&#123;SW_RECEIVER_ZIPKIN_JETTY_MIN_THREADS:1&#125;</span></span><br><span class="line"><span class="attr">    jettyMaxThreads:</span> <span class="string">$&#123;SW_RECEIVER_ZIPKIN_JETTY_MAX_THREADS:200&#125;</span></span><br><span class="line"><span class="attr">    jettyIdleTimeOut:</span> <span class="string">$&#123;SW_RECEIVER_ZIPKIN_JETTY_IDLE_TIMEOUT:30000&#125;</span></span><br><span class="line"><span class="attr">    jettyAcceptorPriorityDelta:</span> <span class="string">$&#123;SW_RECEIVER_ZIPKIN_JETTY_DELTA:0&#125;</span></span><br><span class="line"><span class="attr">    jettyAcceptQueueSize:</span> <span class="string">$&#123;SW_RECEIVER_ZIPKIN_QUEUE_SIZE:0&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">receiver_jaeger:</span></span><br><span class="line"><span class="attr">  selector:</span> <span class="string">$&#123;SW_RECEIVER_JAEGER:-&#125;</span></span><br><span class="line"><span class="attr">  default:</span></span><br><span class="line"><span class="attr">    gRPCHost:</span> <span class="string">$&#123;SW_RECEIVER_JAEGER_HOST:0.0.0.0&#125;</span></span><br><span class="line"><span class="attr">    gRPCPort:</span> <span class="string">$&#123;SW_RECEIVER_JAEGER_PORT:14250&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">receiver-browser:</span></span><br><span class="line"><span class="attr">  selector:</span> <span class="string">$&#123;SW_RECEIVER_BROWSER:default&#125;</span></span><br><span class="line"><span class="attr">  default:</span></span><br><span class="line">    <span class="comment"># The sample rate precision is 1/10000. 10000 means 100% sample in default.</span></span><br><span class="line"><span class="attr">    sampleRate:</span> <span class="string">$&#123;SW_RECEIVER_BROWSER_SAMPLE_RATE:10000&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">query:</span></span><br><span class="line"><span class="attr">  selector:</span> <span class="string">$&#123;SW_QUERY:graphql&#125;</span></span><br><span class="line"><span class="attr">  graphql:</span></span><br><span class="line"><span class="attr">    path:</span> <span class="string">$&#123;SW_QUERY_GRAPHQL_PATH:/graphql&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">alarm:</span></span><br><span class="line"><span class="attr">  selector:</span> <span class="string">$&#123;SW_ALARM:default&#125;</span></span><br><span class="line"><span class="attr">  default:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">telemetry:</span></span><br><span class="line"><span class="attr">  selector:</span> <span class="string">$&#123;SW_TELEMETRY:none&#125;</span></span><br><span class="line"><span class="attr">  none:</span></span><br><span class="line"><span class="attr">  prometheus:</span></span><br><span class="line"><span class="attr">    host:</span> <span class="string">$&#123;SW_TELEMETRY_PROMETHEUS_HOST:0.0.0.0&#125;</span></span><br><span class="line"><span class="attr">    port:</span> <span class="string">$&#123;SW_TELEMETRY_PROMETHEUS_PORT:1234&#125;</span></span><br><span class="line"><span class="attr">    sslEnabled:</span> <span class="string">$&#123;SW_TELEMETRY_PROMETHEUS_SSL_ENABLED:false&#125;</span></span><br><span class="line"><span class="attr">    sslKeyPath:</span> <span class="string">$&#123;SW_TELEMETRY_PROMETHEUS_SSL_KEY_PATH:""&#125;</span></span><br><span class="line"><span class="attr">    sslCertChainPath:</span> <span class="string">$&#123;SW_TELEMETRY_PROMETHEUS_SSL_CERT_CHAIN_PATH:""&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">configuration:</span></span><br><span class="line"><span class="attr">  selector:</span> <span class="string">$&#123;SW_CONFIGURATION:none&#125;</span></span><br><span class="line"><span class="attr">  none:</span></span><br><span class="line"><span class="attr">  grpc:</span></span><br><span class="line"><span class="attr">    host:</span> <span class="string">$&#123;SW_DCS_SERVER_HOST:""&#125;</span></span><br><span class="line"><span class="attr">    port:</span> <span class="string">$&#123;SW_DCS_SERVER_PORT:80&#125;</span></span><br><span class="line"><span class="attr">    clusterName:</span> <span class="string">$&#123;SW_DCS_CLUSTER_NAME:SkyWalking&#125;</span></span><br><span class="line"><span class="attr">    period:</span> <span class="string">$&#123;SW_DCS_PERIOD:20&#125;</span></span><br><span class="line"><span class="attr">  apollo:</span></span><br><span class="line"><span class="attr">    apolloMeta:</span> <span class="string">$&#123;SW_CONFIG_APOLLO:http://localhost:8080&#125;</span></span><br><span class="line"><span class="attr">    apolloCluster:</span> <span class="string">$&#123;SW_CONFIG_APOLLO_CLUSTER:default&#125;</span></span><br><span class="line"><span class="attr">    apolloEnv:</span> <span class="string">$&#123;SW_CONFIG_APOLLO_ENV:""&#125;</span></span><br><span class="line"><span class="attr">    appId:</span> <span class="string">$&#123;SW_CONFIG_APOLLO_APP_ID:skywalking&#125;</span></span><br><span class="line"><span class="attr">    period:</span> <span class="string">$&#123;SW_CONFIG_APOLLO_PERIOD:5&#125;</span></span><br><span class="line"><span class="attr">  zookeeper:</span></span><br><span class="line"><span class="attr">    period:</span> <span class="string">$&#123;SW_CONFIG_ZK_PERIOD:60&#125;</span> <span class="comment"># Unit seconds, sync period. Default fetch every 60 seconds.</span></span><br><span class="line"><span class="attr">    nameSpace:</span> <span class="string">$&#123;SW_CONFIG_ZK_NAMESPACE:/default&#125;</span></span><br><span class="line"><span class="attr">    hostPort:</span> <span class="string">$&#123;SW_CONFIG_ZK_HOST_PORT:localhost:2181&#125;</span></span><br><span class="line">    <span class="comment"># Retry Policy</span></span><br><span class="line"><span class="attr">    baseSleepTimeMs:</span> <span class="string">$&#123;SW_CONFIG_ZK_BASE_SLEEP_TIME_MS:1000&#125;</span> <span class="comment"># initial amount of time to wait between retries</span></span><br><span class="line"><span class="attr">    maxRetries:</span> <span class="string">$&#123;SW_CONFIG_ZK_MAX_RETRIES:3&#125;</span> <span class="comment"># max number of times to retry</span></span><br><span class="line"><span class="attr">  etcd:</span></span><br><span class="line"><span class="attr">    period:</span> <span class="string">$&#123;SW_CONFIG_ETCD_PERIOD:60&#125;</span> <span class="comment"># Unit seconds, sync period. Default fetch every 60 seconds.</span></span><br><span class="line"><span class="attr">    group:</span> <span class="string">$&#123;SW_CONFIG_ETCD_GROUP:skywalking&#125;</span></span><br><span class="line"><span class="attr">    serverAddr:</span> <span class="string">$&#123;SW_CONFIG_ETCD_SERVER_ADDR:localhost:2379&#125;</span></span><br><span class="line"><span class="attr">    clusterName:</span> <span class="string">$&#123;SW_CONFIG_ETCD_CLUSTER_NAME:default&#125;</span></span><br><span class="line"><span class="attr">  consul:</span></span><br><span class="line">    <span class="comment"># Consul host and ports, separated by comma, e.g. 1.2.3.4:8500,2.3.4.5:8500</span></span><br><span class="line"><span class="attr">    hostAndPorts:</span> <span class="string">$&#123;SW_CONFIG_CONSUL_HOST_AND_PORTS:1.2.3.4:8500&#125;</span></span><br><span class="line">    <span class="comment"># Sync period in seconds. Defaults to 60 seconds.</span></span><br><span class="line"><span class="attr">    period:</span> <span class="string">$&#123;SW_CONFIG_CONSUL_PERIOD:60&#125;</span></span><br><span class="line">    <span class="comment"># Consul aclToken</span></span><br><span class="line"><span class="attr">    aclToken:</span> <span class="string">$&#123;SW_CONFIG_CONSUL_ACL_TOKEN:""&#125;</span></span><br><span class="line"><span class="attr">  k8s-configmap:</span></span><br><span class="line"><span class="attr">    period:</span> <span class="string">$&#123;SW_CONFIG_CONFIGMAP_PERIOD:60&#125;</span></span><br><span class="line"><span class="attr">    namespace:</span> <span class="string">$&#123;SW_CLUSTER_K8S_NAMESPACE:default&#125;</span></span><br><span class="line"><span class="attr">    labelSelector:</span> <span class="string">$&#123;SW_CLUSTER_K8S_LABEL:app=collector,release=skywalking&#125;</span></span><br><span class="line"><span class="attr">  nacos:</span></span><br><span class="line">    <span class="comment"># Nacos Server Host</span></span><br><span class="line"><span class="attr">    serverAddr:</span> <span class="string">$&#123;SW_CONFIG_NACOS_SERVER_ADDR:127.0.0.1&#125;</span></span><br><span class="line">    <span class="comment"># Nacos Server Port</span></span><br><span class="line"><span class="attr">    port:</span> <span class="string">$&#123;SW_CONFIG_NACOS_SERVER_PORT:8848&#125;</span></span><br><span class="line">    <span class="comment"># Nacos Configuration Group</span></span><br><span class="line"><span class="attr">    group:</span> <span class="string">$&#123;SW_CONFIG_NACOS_SERVER_GROUP:skywalking&#125;</span></span><br><span class="line">    <span class="comment"># Nacos Configuration namespace</span></span><br><span class="line"><span class="attr">    namespace:</span> <span class="string">$&#123;SW_CONFIG_NACOS_SERVER_NAMESPACE:&#125;</span></span><br><span class="line">    <span class="comment"># Unit seconds, sync period. Default fetch every 60 seconds.</span></span><br><span class="line"><span class="attr">    period:</span> <span class="string">$&#123;SW_CONFIG_NACOS_PERIOD:60&#125;</span></span><br><span class="line">    <span class="comment"># Nacos auth username</span></span><br><span class="line"><span class="attr">    username:</span> <span class="string">$&#123;SW_CONFIG_NACOS_USERNAME:""&#125;</span></span><br><span class="line"><span class="attr">    password:</span> <span class="string">$&#123;SW_CONFIG_NACOS_PASSWORD:""&#125;</span></span><br><span class="line">    <span class="comment"># Nacos auth accessKey</span></span><br><span class="line"><span class="attr">    accessKey:</span> <span class="string">$&#123;SW_CONFIG_NACOS_ACCESSKEY:""&#125;</span></span><br><span class="line"><span class="attr">    secretKey:</span> <span class="string">$&#123;SW_CONFIG_NACOS_SECRETKEY:""&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">exporter:</span></span><br><span class="line"><span class="attr">  selector:</span> <span class="string">$&#123;SW_EXPORTER:-&#125;</span></span><br><span class="line"><span class="attr">  grpc:</span></span><br><span class="line"><span class="attr">    targetHost:</span> <span class="string">$&#123;SW_EXPORTER_GRPC_HOST:127.0.0.1&#125;</span></span><br><span class="line"><span class="attr">    targetPort:</span> <span class="string">$&#123;SW_EXPORTER_GRPC_PORT:9870&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">health-checker:</span></span><br><span class="line"><span class="attr">  selector:</span> <span class="string">$&#123;SW_HEALTH_CHECKER:-&#125;</span></span><br><span class="line"><span class="attr">  default:</span></span><br><span class="line"><span class="attr">    checkIntervalSeconds:</span> <span class="string">$&#123;SW_HEALTH_CHECKER_INTERVAL_SECONDS:5&#125;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="插件安装"><a href="#插件安装" class="headerlink" title="插件安装"></a>插件安装</h3><p>Java代理插件都是可插入的。可以optional-plugins在代理或第三方存储库下的文件夹中提供可选插件。要使用这些插件，需要将目标插件jar文件放入/plugins。</p>
<p>目前已有的插件有：</p>
<ul>
<li><a href="https://github.com/apache/skywalking/blob/8.3.0/docs-hotfix/docs/en/setup/service-agent/java-agent/agent-optional-plugins/Spring-annotation-plugin.md" target="_blank" rel="noopener">Plugin of tracing Spring annotation beans</a></li>
<li><a href="https://github.com/apache/skywalking/blob/8.3.0/docs-hotfix/docs/en/setup/service-agent/java-agent/agent-optional-plugins/Oracle-Resin-plugins.md" target="_blank" rel="noopener">tracing Oracle and Resin</a></li>
<li><a href="https://github.com/apache/skywalking/blob/8.3.0/docs-hotfix/docs/en/setup/service-agent/java-agent/agent-optional-plugins/trace-ignore-plugin.md" target="_blank" rel="noopener">Filter traces through specified endpoint name patterns</a></li>
<li>Plugin of Gson serialization lib in optional plugin folder.</li>
<li>Plugin of Zookeeper 3.4.x in optional plugin folder. The reason of being optional plugin is, many business irrelevant traces are generated, which cause extra payload to agents and backends. At the same time, those traces may be just heartbeat(s).</li>
<li>Customize enhance Trace methods based on description files, rather than write plugin or change source codes.</li>
<li>Plugin of Spring Cloud Gateway 2.1.x in optional plugin folder. Please only active this plugin when you install agent in Spring Gateway. spring-cloud-gateway-2.x-plugin and spring-webflux-5.x-plugin are both required.</li>
<li>Plugin of Spring Transaction in optional plugin folder. The reason of being optional plugin is, many local span are generated, which also spend more CPU, memory and network.</li>
<li>Plugin of Kotlin coroutine provides the tracing across coroutines automatically. As it will add local spans to all across routines scenarios, Please assess the performance impact.</li>
<li>Plugin of quartz-scheduler-2.x in the optional plugin folder. The reason for being an optional plugin is, many task scheduling systems are based on quartz-scheduler, this will cause duplicate tracing and link different sub-tasks as they share the same quartz level trigger, such as ElasticJob.</li>
<li>Plugin of spring-webflux-5.x in the optional plugin folder. Please only activate this plugin when you use webflux alone as a web container. If you are using SpringMVC 5 or Spring Gateway, you don’t need this plugin.</li>
</ul>
<h3 id="前端配置"><a href="#前端配置" class="headerlink" title="前端配置"></a>前端配置</h3><p>前端配置在文件夹<code>webapp</code>的<code>webapp.yml</code>文件里面。</p>
<h2 id="客户端接入"><a href="#客户端接入" class="headerlink" title="客户端接入"></a>客户端接入</h2><h3 id="java应用"><a href="#java应用" class="headerlink" title="java应用"></a>java应用</h3><p>执行命令里面加上<br><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -javaagent:/path/<span class="keyword">to</span>/skywalking-<span class="built_in">agent</span>/skywalking-<span class="built_in">agent</span>.jar -Dskywalking_config=/path/<span class="keyword">to</span>/<span class="built_in">agent</span>.config -jar yourApp.jar</span><br></pre></td></tr></table></figure></p>
<p>这里另外设置了agent的配置，具体agent的配置可以参考<a href="https://github.com/apache/skywalking/blob/8.3.0/docs-hotfix/docs/en/setup/service-agent/java-agent/README.md" target="_blank" rel="noopener">官方文档</a>，这里贴上我自己的配置:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Licensed to the Apache Software Foundation (ASF) under one</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> or more contributor license agreements.  See the NOTICE file</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> distributed with this work <span class="keyword">for</span> additional information</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> regarding copyright ownership.  The ASF licenses this file</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> to you under the Apache License, Version 2.0 (the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="string">"License"</span>); you may not use this file except <span class="keyword">in</span> compliance</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> with the License.  You may obtain a copy of the License at</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">     http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Unless required by applicable law or agreed to <span class="keyword">in</span> writing, software</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> distributed under the License is distributed on an <span class="string">"AS IS"</span> BASIS,</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> See the License <span class="keyword">for</span> the specific language governing permissions and</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> limitations under the License.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The agent namespace</span></span><br><span class="line">agent.namespace=$&#123;SW_AGENT_NAMESPACE:LOCAL&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The service name <span class="keyword">in</span> UI</span></span><br><span class="line">agent.service_name=$&#123;SW_AGENT_NAME:Activiti&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The number of sampled traces per 3 seconds</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Negative or zero means off, by default</span></span><br><span class="line">agent.sample_n_per_3_secs=$&#123;SW_AGENT_SAMPLE:-1&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Authentication active is based on backend setting, see application.yml <span class="keyword">for</span> more details.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> agent.authentication = <span class="variable">$&#123;SW_AGENT_AUTHENTICATION:xxxx&#125;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The max amount of spans <span class="keyword">in</span> a single segment.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Through this config item, SkyWalking keep your application memory cost estimated.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> agent.span_limit_per_segment=<span class="variable">$&#123;SW_AGENT_SPAN_LIMIT:150&#125;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Ignore the segments <span class="keyword">if</span> their operation names end with these suffix.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> agent.ignore_suffix=<span class="variable">$&#123;SW_AGENT_IGNORE_SUFFIX:.jpg,.jpeg,.js,.css,.png,.bmp,.gif,.ico,.mp3,.mp4,.html,.svg&#125;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> If <span class="literal">true</span>, SkyWalking agent will save all instrumented classes files <span class="keyword">in</span> `/debugging` folder.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> SkyWalking team may ask <span class="keyword">for</span> these files <span class="keyword">in</span> order to resolve compatible problem.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> agent.is_open_debugging_class = <span class="variable">$&#123;SW_AGENT_OPEN_DEBUG:true&#125;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> If <span class="literal">true</span>, SkyWalking agent will cache all instrumented classes files to memory or disk files (decided by class cache mode),</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> allow other javaagent to enhance those classes that enhanced by SkyWalking agent.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> agent.is_cache_enhanced_class = <span class="variable">$&#123;SW_AGENT_CACHE_CLASS:false&#125;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The instrumented classes cache mode: MEMORY or FILE</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> MEMORY: cache class bytes to memory, <span class="keyword">if</span> instrumented classes is too many or too large, it may take up more memory</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> FILE: cache class bytes <span class="keyword">in</span> `/class-cache` folder, automatically clean up cached class files when the application exits</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> agent.class_cache_mode = <span class="variable">$&#123;SW_AGENT_CLASS_CACHE_MODE:MEMORY&#125;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The operationName max length</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Notice, <span class="keyword">in</span> the current practice, we don<span class="string">'t recommend the length over 190.</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> agent.operation_name_threshold=<span class="variable">$&#123;SW_AGENT_OPERATION_NAME_THRESHOLD:150&#125;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> If <span class="literal">true</span>, skywalking agent will <span class="built_in">enable</span> profile when user create a new profile task. Otherwise <span class="built_in">disable</span> profile.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> profile.active=<span class="variable">$&#123;SW_AGENT_PROFILE_ACTIVE:true&#125;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Parallel monitor segment count</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> profile.max_parallel=<span class="variable">$&#123;SW_AGENT_PROFILE_MAX_PARALLEL:5&#125;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Max monitor segment time(minutes), <span class="keyword">if</span> current segment monitor time out of <span class="built_in">limit</span>, <span class="keyword">then</span> stop it.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> profile.duration=<span class="variable">$&#123;SW_AGENT_PROFILE_DURATION:10&#125;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Max dump thread stack depth</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> profile.dump_max_stack_depth=<span class="variable">$&#123;SW_AGENT_PROFILE_DUMP_MAX_STACK_DEPTH:500&#125;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Snapshot transport to backend buffer size</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> profile.snapshot_transport_buffer_size=<span class="variable">$&#123;SW_AGENT_PROFILE_SNAPSHOT_TRANSPORT_BUFFER_SIZE:50&#125;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Backend service addresses.</span></span><br><span class="line">collector.backend_service=$&#123;SW_AGENT_COLLECTOR_BACKEND_SERVICES:127.0.0.1:11800&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Logging file_name</span></span><br><span class="line">logging.file_name=$&#123;SW_LOGGING_FILE_NAME:skywalking-api.log&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Logging level</span></span><br><span class="line">logging.level=$&#123;SW_LOGGING_LEVEL:INFO&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Logging dir</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> logging.dir=<span class="variable">$&#123;SW_LOGGING_DIR:""&#125;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Logging max_file_size, default: 300 * 1024 * 1024 = 314572800</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> logging.max_file_size=<span class="variable">$&#123;SW_LOGGING_MAX_FILE_SIZE:314572800&#125;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The max <span class="built_in">history</span> <span class="built_in">log</span> files. When rollover happened, <span class="keyword">if</span> <span class="built_in">log</span> files exceed this number,</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">then</span> the oldest file will be delete. Negative or zero means off, by default.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> logging.max_history_files=<span class="variable">$&#123;SW_LOGGING_MAX_HISTORY_FILES:-1&#125;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Listed exceptions would not be treated as an error. Because <span class="keyword">in</span> some codes, the exception is being used as a way of controlling business flow.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Besides, the annotation named IgnoredException <span class="keyword">in</span> the trace toolkit is another way to configure ignored exceptions.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> statuscheck.ignored_exceptions=<span class="variable">$&#123;SW_STATUSCHECK_IGNORED_EXCEPTIONS:&#125;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The max recursive depth when checking the exception traced by the agent. Typically, we don<span class="string">'t recommend setting this more than 10, which could cause a performance issue. Negative value and 0 would be ignored, which means all exceptions would make the span tagged in error status.</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> statuscheck.max_recursive_depth=<span class="variable">$&#123;SW_STATUSCHECK_MAX_RECURSIVE_DEPTH:1&#125;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Mount the specific folders of the plugins. Plugins <span class="keyword">in</span> mounted folders would work.</span></span><br><span class="line">plugin.mount=$&#123;SW_MOUNT_FOLDERS:plugins,activations&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Exclude activated plugins</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> plugin.exclude_plugins=<span class="variable">$&#123;SW_EXCLUDE_PLUGINS:&#125;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> mysql plugin configuration</span></span><br><span class="line">plugin.mysql.trace_sql_parameters=$&#123;SW_MYSQL_TRACE_SQL_PARAMETERS:true&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Kafka producer configuration</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> plugin.kafka.bootstrap_servers=<span class="variable">$&#123;SW_KAFKA_BOOTSTRAP_SERVERS:localhost:9092&#125;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Match spring bean with regex expression <span class="keyword">for</span> classname</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> plugin.springannotation.classname_match_regex=<span class="variable">$&#123;SW_SPRINGANNOTATION_CLASSNAME_MATCH_REGEX:&#125;</span></span></span><br></pre></td></tr></table></figure></p>
<h3 id="NodeJs接入"><a href="#NodeJs接入" class="headerlink" title="NodeJs接入"></a>NodeJs接入</h3><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">import <span class="built_in">Agent</span> <span class="keyword">from</span> <span class="string">'skywalking'</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">Agent</span>.start(&#123;</span><br><span class="line">  serviceName: <span class="string">''</span>,</span><br><span class="line">  serviceInstance: <span class="string">''</span>,</span><br><span class="line">  collectorAddress: <span class="string">''</span>,</span><br><span class="line">  authorization: <span class="string">''</span>,</span><br><span class="line">  maxBufferSize: <span class="number">1000</span>,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>参数包括：</p>
<p>Environment Variable | Description | Default<br>| — | — | — |<br>| <code>SW_AGENT_NAME</code> | The name of the service | <code>your-nodejs-service</code> |<br>| <code>SW_AGENT_INSTANCE</code> | The name of the service instance | Randomly generated |<br>| <code>SW_AGENT_COLLECTOR_BACKEND_SERVICES</code> | The backend OAP server address | <code>127.0.0.1:11800</code> |<br>| <code>SW_AGENT_AUTHENTICATION</code> | The authentication token to verify that the agent is trusted by the backend OAP, as for how to configure the backend, refer to <a href="https://github.com/apache/skywalking/blob/4f0f39ffccdc9b41049903cc540b8904f7c9728e/oap-server/server-bootstrap/src/main/resources/application.yml#L155-L158" target="_blank" rel="noopener">the yaml</a>. | not set |<br>| <code>SW_AGENT_LOGGING_LEVEL</code> | The logging level, could be one of <code>CRITICAL</code>, <code>FATAL</code>, <code>ERROR</code>, <code>WARN</code>(<code>WARNING</code>), <code>INFO</code>, <code>DEBUG</code> | <code>INFO</code> |<br>| <code>SW_AGENT_MAX_BUFFER_SIZE</code> | The maximum buffer size before sending the segment data to backend | <code>&#39;1000&#39;</code> |</p>
<h3 id="前端接入"><a href="#前端接入" class="headerlink" title="前端接入"></a>前端接入</h3><p>可以参考<a href="https://github.com/apache/skywalking-client-js" target="_blank" rel="noopener">官方文档</a></p>
<h2 id="高级功能"><a href="#高级功能" class="headerlink" title="高级功能"></a>高级功能</h2><h3 id="自己开发插件"><a href="#自己开发插件" class="headerlink" title="自己开发插件"></a>自己开发插件</h3><p>可以参考<a href="https://insights.thoughtworks.cn/skywalking-plugin-guide/" target="_blank" rel="noopener">文章</a>，已经写得很好了。。。我不需要再表述了.</p>
<p>开发插件后，可以给官方<a href="https://skywalking.apache.org/zh/2019-01-21-agent-plugin-practice/" target="_blank" rel="noopener">贡献一下</a></p>
<h3 id="浏览器端监控、使用标签查询、指标分析语言"><a href="#浏览器端监控、使用标签查询、指标分析语言" class="headerlink" title="浏览器端监控、使用标签查询、指标分析语言"></a>浏览器端监控、使用标签查询、指标分析语言</h3><p>参考<a href="https://skywalking.apache.org/zh/2020-10-29-skywalking8-2-release/" target="_blank" rel="noopener">官方文档</a></p>
<p>SkyWalking浏览器监视也提供以下数据: PV（page views，页面浏览量）， UV（unique visitors，独立访客数），浏览量前 N 的页面（Top N Page Views）等。这些数据可以为产品队伍优化他们的产品提供线索。</p>
<p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/plugin.intellij.assistant.mybaitslog-2020.1-1.0.3.jpg" alt="image"></p>
<p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/0081Kckwly1gkl5gnpi0dj30zk0m843n.jpg" alt="image"></p>
<h3 id="服务性能指标监控"><a href="#服务性能指标监控" class="headerlink" title="服务性能指标监控"></a>服务性能指标监控</h3><p>Skywalking还可以查看具体Service的性能指标，根据相关的性能指标可以分析系统的瓶颈所在并提出优化方案。</p>
<p>在服务调用拓扑图上点击相应的节点我们可以看到该服务的</p>
<ul>
<li>SLA: 服务可用性（主要是通过请求成功与失败次数来计算）</li>
<li>CPM: 每分钟调用次数</li>
<li>Avg Response Time: 平均响应时间</li>
</ul>
<p>从应用整体外部来看我们可以监测到应用在一定时间段内的</p>
<ul>
<li>服务可用性指标SLA</li>
<li>每分钟平均响应数</li>
<li>平均响应时间</li>
<li>服务进程PID</li>
<li>服务所在物理机的IP、HostName、Operation System</li>
</ul>
<h3 id="服务告警"><a href="#服务告警" class="headerlink" title="服务告警"></a>服务告警</h3><p>通过webhook的方式让我们可以自定义我们告警信息的通知方式。诸如:邮件通知、微信通知、短信通知等。</p>
<p>先来看一下告警的规则配置。在<code>alarm-settings.xml</code>中可以配置告警规则，告警规则支持自定义。</p>
<p>一份告警配置由以下几部分组成：</p>
<ul>
<li><code>service_resp_time_rule</code>：告警规则名称 <code>***_rule</code> （规则名称可以自定义但是必须以<code>_rule</code>结尾</li>
<li><code>indicator-name</code>：指标数据名称： 定义参见<code>http://t.cn/EGhfbmd</code></li>
<li><code>op</code>: 操作符： &gt; , &lt; , = 【当然你可以自己扩展开发其他的操作符】</li>
<li><code>threshold</code>：目标值：指标数据的目标数据 如sample中的1000就是服务响应时间，配合上操作符就是大于1000ms的服务响应</li>
<li><code>period</code>: 告警检查周期：多久检查一次当前的指标数据是否符合告警规则</li>
<li><code>counts</code>: 达到告警阈值的次数</li>
<li><code>silence-period</code>：忽略相同告警信息的周期</li>
<li><code>message</code>：告警信息</li>
<li><code>webhooks</code>：服务告警通知服务地</li>
</ul>
<p>Skywalking通过HttpClient的方式远程调用在配置项webhooks中定义的告警通知服务地址。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dinghuang.github.io/2020/12/08/Mysql最佳实践/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="强壮的病猫">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/dinghuang.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一只病猫">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/12/08/Mysql最佳实践/" itemprop="url">Mysql最佳实践</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-12-08T15:47:00+08:00">
                2020-12-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/" itemprop="url" rel="index">
                    <span itemprop="name">数据库</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/12/08/Mysql最佳实践/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/12/08/Mysql最佳实践/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <h1 id="建表规约"><a href="#建表规约" class="headerlink" title="建表规约"></a>建表规约</h1><h2 id="强制要求"><a href="#强制要求" class="headerlink" title="强制要求"></a>强制要求</h2><ol>
<li>表达是与否概念的字段，必须使用 <code>is_xxx</code> 的方式命名，数据类型是 <code>unsigned tinyint</code> （<code>1</code> 表示是， <code>0</code> 表示否）。<ul>
<li>说明： 任何字段如果为非负数，必须是 <code>unsigned</code>。</li>
<li>正例： 表达逻辑删除的字段名 <code>is_deleted</code>， 1 表示删除， 0 表示未删除。</li>
</ul>
</li>
<li>表名、字段名必须使用小写字母或数字，禁止出现数字开头，禁止两个下划线中间只出现数字。<ul>
<li>数据库字段名的修改代价很大，因为无法进行预发布，所以字段名称需要慎重考虑。</li>
<li>说明： MySQL 在 Windows 下不区分大小写，但在 Linux 下默认是区分大小写。因此，数据库名、表名、字段名，都不允许出现任何大写字母，避免节外生枝。</li>
<li>正例： <code>hap_admin</code>， <code>rdc_config</code>， <code>level3_name</code></li>
<li>反例： HapAdmin， rdcConfig， level_3_name</li>
</ul>
</li>
<li>表名不使用复数名词。<ul>
<li>说明： 表名应该仅仅表示表里面的实体内容，不应该表示实体数量，对应于 DO 类名也是单数形式，符合表达习惯。</li>
</ul>
</li>
<li>禁用保留字，如 <code>desc</code>、 <code>range</code>、 <code>match</code>、 <code>delayed</code> 等， 请参考 MySQL 官方保留字。</li>
<li>主键索引名为 <code>pk_字段名</code>； 唯一索引名为 <code>uk_字段名</code>； 普通索引名则为 <code>idx_字段名</code>。<ul>
<li>说明： pk_ 即 primary key； uk_ 即 unique key； idx_ 即 index 的简称。</li>
</ul>
</li>
<li>小数类型为 <code>decimal</code>，禁止使用 float 和 double。<ul>
<li>说明： float 和 double 在存储的时候，存在精度损失的问题，很可能在值的比较时，得到不正确的结果。如果存储的数据范围超过 decimal 的范围，建议将数据拆成整数和小数分开存储。</li>
</ul>
</li>
<li>如果存储的字符串长度几乎相等，使用 char 定长字符串类型。</li>
<li>varchar 是可变长字符串，不预先分配存储空间，长度不要超过5000，如果存储长度大于此值，定义字段类型为 text，独立出来一张表，用主键来对应，避免影响其它字段索引效率。<ul>
<li>说明： 该表的命名以 <code>原表名_字段缩写</code> 的格式命名。</li>
</ul>
</li>
<li><p>表必备字段： <code>id</code>, <code>create_date</code>, <code>last_update_date</code>, <code>create_by</code> , <code>last_update_by</code> , <code>object_version_number</code>。</p>
<ul>
<li>说明： 其中 id 必为主键，类型为 unsigned bigint、单表时自增、步长为 1。 </li>
<li><p><code>create_date</code>, <code>last_update_date</code> 的类型均为 datetime 类型，前者现在时表示主动创建，后者过去分词表示被动更新。</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">column</span>(<span class="attribute">name</span>: <span class="string">"object_version_number"</span>, <span class="attribute">type</span>: <span class="string">"BIGINT UNSIGNED"</span>, <span class="attribute">defaultValue</span>: <span class="string">"1"</span>)</span><br><span class="line"><span class="selector-tag">column</span>(<span class="attribute">name</span>: <span class="string">"created_by"</span>, <span class="attribute">type</span>: <span class="string">"BIGINT UNSIGNED"</span>, <span class="attribute">defaultValue</span>: <span class="string">"0"</span>)</span><br><span class="line"><span class="selector-tag">column</span>(<span class="attribute">name</span>: <span class="string">"creation_date"</span>, <span class="attribute">type</span>: <span class="string">"DATETIME"</span>, <span class="attribute">defaultValueComputed</span>: <span class="string">"CURRENT_TIMESTAMP"</span>)</span><br><span class="line"><span class="selector-tag">column</span>(<span class="attribute">name</span>: <span class="string">"last_updated_by"</span>, <span class="attribute">type</span>: <span class="string">"BIGINT UNSIGNED"</span>, <span class="attribute">defaultValue</span>: <span class="string">"0"</span>)</span><br><span class="line"><span class="selector-tag">column</span>(<span class="attribute">name</span>: <span class="string">"last_update_date"</span>, <span class="attribute">type</span>: <span class="string">"DATETIME"</span>, <span class="attribute">defaultValueComputed</span>: <span class="string">"CURRENT_TIMESTAMP"</span>)</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>表的命名最好是加上“业务名称_表的作用”。</p>
<ul>
<li>正例： <code>kanban_task</code> / <code>devops_project</code> / <code>website_config</code></li>
</ul>
</li>
<li><p>id类型没有特殊要求，必须使用bigint unsigned，禁止使用int，即使现在的数据量很小。id如果是数字类型的话，必须是8个字节。参见最后例子</p>
<ul>
<li>方便对接外部系统，还有可能产生很多废数据</li>
<li>避免废弃数据对系统id的影响</li>
<li>未来分库分表，自动生成id，一般也是8个字节</li>
</ul>
</li>
<li><p>更新数据表记录时，必须同时更新记录对应的 last_update_date 字段值为当前时间,</p>
<h2 id="推荐规约"><a href="#推荐规约" class="headerlink" title="推荐规约"></a>推荐规约</h2></li>
</ol>
<ol>
<li>库名与应用名称尽量一致。</li>
<li>如果修改字段含义或对字段表示的状态追加时，需要及时更新字段注释。</li>
<li>字段允许适当冗余，以提高查询性能，但必须考虑数据一致。冗余字段应遵循：<ul>
<li>不是频繁修改的字段。</li>
<li>不是 <code>varchar</code> 超长字段，更不能是 <code>text</code> 字段。</li>
</ul>
<ul>
<li>正例： 商品类目名称使用频率高， 字段长度短，名称基本一成不变， 可在相关联的表中冗余存储类目名称，避免关联查询。</li>
</ul>
</li>
<li>单表行数超过 500 万行或者单表容量超过 2GB，才推荐进行分库分表。<ul>
<li>说明： 如果预计三年后的数据量根本达不到这个级别，请不要在创建表时就分库分表。</li>
</ul>
</li>
</ol>
<h2 id="规约参考"><a href="#规约参考" class="headerlink" title="规约参考"></a>规约参考</h2><ol>
<li><p>合适的字符存储长度，不但节约数据库表空间、节约索引存储，更重要的是提升检索速度。</p>
<ul>
<li><p>正例： 如下表，其中无符号值可以避免误存负数，且扩大了表示范围。</p>
<p>|对象|年龄区间|类型|字节|表示范围|<br>|—-|——–|—-|—-|——–|<br>|人|150岁之内|<code>unsigned tinyint</code>|1|无符号值： 0 到 255|<br>|龟|数百岁|<code>unsigned smallint</code>|2|无符号值： 0 到 65535|<br>|恐龙化石|数千万年|<code>unsigned int</code>|4|无符号值： 0 到约 42.9 亿|<br>|太阳|约 50 亿年|<code>unsigned bigint</code>|8|无符号值： 0 到约 10 的 19 次方|</p>
</li>
</ul>
</li>
</ol>
<h1 id="索引规约"><a href="#索引规约" class="headerlink" title="索引规约"></a>索引规约</h1><h2 id="强制要求-1"><a href="#强制要求-1" class="headerlink" title="强制要求"></a>强制要求</h2><ol>
<li>业务上具有唯一特性的字段，即使是多个字段的组合，也必须建成唯一索引。<ul>
<li>说明：不要以为唯一索引影响了insert速度，这个速度损耗可以忽略，但提高查找速度是明显的；另外，即使在应用层做了非常完善的校验控制，只要没有唯一索引，根据墨菲定律，必然有脏数据产生。</li>
</ul>
</li>
<li>超过三个表禁止join。需要join的字段，数据类型必须绝对一致；多表关联查询时，保证被关联的字段需要有索引。<ul>
<li>说明：即使双表join也要注意表索引、SQL性能。</li>
</ul>
</li>
<li>在varchar字段上建立索引时，必须指定索引长度，没必要对全字段建立索引，根据实际文本区分度决定索引长度即可。<ul>
<li>说明：索引的长度与区分度是一对矛盾体，一般对字符串类型数据，长度为 20 的索引，区分度会高达90%以上，可以使用 count(distinct left(列名,索引长度))/count(*)的区分度来确定。</li>
</ul>
</li>
<li>页面搜索严禁左模糊或者全模糊，如果需要请走搜索引擎来解决(项目前期数据量不大可以不遵循这个要求，后续改进，不过需要留痕)。<ul>
<li>说明：索引文件具有B-Tree的最左前缀匹配特性，如果左边的值未确定，那么无法使用此索引。</li>
</ul>
</li>
</ol>
<h2 id="推荐规约-1"><a href="#推荐规约-1" class="headerlink" title="推荐规约"></a>推荐规约</h2><ol>
<li>如果有<code>order by</code>的场景，请注意利用索引的有序性。<code>order by</code> 最后的字段是组合索引的一部分，并且放在索引组合顺序的最后，避免出现file_sort的情况，影响查询性能。<ul>
<li>正例： where a=? and b=? order by c; 索引： a_b_c</li>
<li>反例： 索引中有范围查找，那么索引有序性无法利用，如： WHERE a&gt;10 ORDER BY b; 索引a_b无法排序。</li>
</ul>
</li>
<li>利用覆盖索引来进行查询操作， 避免回表。<ul>
<li>说明：如果一本书需要知道第 11 章是什么标题，会翻开第 11章对应的那一页吗？目录浏览一下就好，这个目录就是起到覆盖索引的作用。</li>
<li>正例：能够建立索引的种类分为主键索引、唯一索引、普通索引三种，而覆盖索引只是一种查询的一种效果，用explain 的结果，extra 列会出现： using index。</li>
</ul>
</li>
<li><p>利用延迟关联或者子查询优化超多分页场景。</p>
<ul>
<li>说明：MySQL 并不是跳过 offset 行，而是取 offset+N 行，然后返回放弃前offset行，返回N行，那当 offset 特别大的时候，效率就非常的低下，要么控制返回的总页数，要么对超过特定阈值的页数进行SQL改写。</li>
<li>正例：先快速定位需要获取的 id 段，然后再关联：  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> a.* <span class="keyword">FROM</span> 表 <span class="number">1</span> a, (<span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> 表 <span class="number">1</span> <span class="keyword">where</span> 条件 <span class="keyword">LIMIT</span> <span class="number">100000</span>,<span class="number">20</span> ) b <span class="keyword">where</span> a.id=b.id</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>SQL 性能优化的目标：至少要达到 range 级别，要求是ref级别，如果可以是consts最好。</p>
<ul>
<li>说明：<ol>
<li>consts 单表中最多只有一个匹配行（主键或者唯一索引），在优化阶段即可读取到数据。</li>
<li>ref 指的是使用普通的索引（<code>normal index</code>） 。</li>
<li>range 对索引进行范围检索。</li>
</ol>
</li>
<li>反例： explain 表的结果， type=index，索引物理文件全扫描，速度非常慢，这个 index 级别比较 range 还低，与全表扫描是小巫见大巫。</li>
</ul>
</li>
<li>建组合索引的时候，区分度最高的在最左边。<ul>
<li>正例： 如果 where a=? and b=? ， a列的几乎接近于唯一值，那么只需要单建 idx_a 索引即可。</li>
<li>说明： 存在非等号和等号混合判断条件时，在建索引时，请把等号条件的列前置。如： where a&gt;? and b=? 那么即使 a 的区分度更高，也必须把 b 放在索引的最前列。</li>
</ul>
</li>
<li>防止因字段类型不同造成的隐式转换，导致索引失效。</li>
</ol>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li>索引占磁盘空间，不要重复的索引，尽量短  </li>
<li>只给常用的查询条件加索引  </li>
<li>过滤性高的列建索引，取值范围固定的列不建索引 </li>
<li>唯一的记录添加唯一索引  </li>
<li>频繁更新的列不要建索引  </li>
<li>不要对索引列运算  </li>
<li>同样过滤效果下，保持索引长度最小  </li>
<li>合理利用组合索引，注意索引字段先后顺序  </li>
<li>多列组合索引，过滤性高的字段最前  </li>
<li>order by 字段建立索引，避免 filesort  </li>
<li>组合索引，不同的排序顺序不能使用索引  </li>
<li>&lt;&gt;!=无法使用索引</li>
</ul>
<h2 id="规约参考-1"><a href="#规约参考-1" class="headerlink" title="规约参考"></a>规约参考</h2><ol>
<li>创建索引时避免有如下极端误解：<ol>
<li>宁滥勿缺。 认为一个查询就需要建一个索引。</li>
<li>宁缺勿滥。认为索引会消耗空间、严重拖慢更新和新增速度。</li>
<li>抵制惟一索引。认为业务的惟一性一律需要在应用层通过“先查后插”方式解决。</li>
</ol>
</li>
</ol>
<h1 id="SQL-语句"><a href="#SQL-语句" class="headerlink" title="SQL 语句"></a>SQL 语句</h1><h2 id="强制要求-2"><a href="#强制要求-2" class="headerlink" title="强制要求"></a>强制要求</h2><ol>
<li>不要使用 count(列名)或 count(常量)来替代 <code>count(\*)</code>， count(*)是 SQL92 定义的标准统计行数的语法，跟数据库无关，跟 NULL 和非 NULL 无关。<ul>
<li>说明： count(*)会统计值为 NULL 的行，而 count(列名)不会统计此列为 NULL 值的行。</li>
</ul>
</li>
<li><code>count(distinct col)</code> 计算该列除 NULL 之外的不重复行数， 注意 count(distinct col1, col2) 如果其中一列全为 NULL，那么即使另一列有不同的值，也返回为 0。</li>
<li><p>当某一列的值全是 NULL 时， count(col)的返回结果为 0，但 sum(col)的返回结果为 NULL，因此使用 sum()时需注意 NPE 问题。</p>
<ul>
<li>正例： 可以使用如下方式来避免 sum 的 NPE 问题：   <figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT IF(<span class="name">ISNULL</span>(<span class="name">SUM</span>(<span class="name">g</span>)),<span class="number">0</span>,SUM(<span class="name">g</span>))</span><br><span class="line">FROM table<span class="comment">;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>使用 ISNULL()来判断是否为 NULL 值。</p>
<ul>
<li>说明： NULL 与任何值的直接比较都为 NULL。<ol>
<li>NULL&lt;&gt;NULL 的返回结果是 NULL， 而不是 false。</li>
<li>NULL=NULL 的返回结果是 NULL， 而不是 true。</li>
<li>NULL&lt;&gt;1 的返回结果是 NULL，而不是 true。</li>
</ol>
</li>
</ul>
</li>
<li>在代码中写分页查询逻辑时，若 count 为 0 应直接返回，避免执行后面的分页语句。</li>
<li>不得使用外键与级联，一切外键概念必须在应用层解决。<ul>
<li>说明：以学生和成绩的关系为例，学生表中的 student_id是主键，那么成绩表中的 student_id 则为外键。如果更新学生表中的 student_id，同时触发成绩表中的 student_id 更新， 即为级联更新。外键与级联更新适用于单机低并发，不适合分布式、高并发集群；级联更新是强阻塞，存在数据库更新风暴的风险:外键影响数据库的插入速度。</li>
</ul>
</li>
<li>禁止使用存储过程，存储过程难以调试和扩展，更没有移植性。</li>
<li>数据订正（特别是删除、 修改记录操作） 时，要先 select，避免出现误删除，确认无误才能执行更新语句。</li>
</ol>
<h2 id="推荐规约-2"><a href="#推荐规约-2" class="headerlink" title="推荐规约"></a>推荐规约</h2><ol>
<li>in 操作能避免则避免，若实在避免不了，需要仔细评估 in 后边的集合元素数量，控制在 1000 个之内。(多的话用 EXISTS 或 NOT EXISTS 代替)</li>
</ol>
<h2 id="规约参考-2"><a href="#规约参考-2" class="headerlink" title="规约参考"></a>规约参考</h2><ol>
<li><p>如果有全球化需要，所有的字符存储与表示，均以 utf-8 编码，注意字符统计函数的区别。</p>
<ul>
<li><p>说明：</p>
  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">LENGTH</span>(<span class="string">"轻松工作"</span>)；\\返回为 <span class="number">12</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">CHARACTER_LENGTH</span>(<span class="string">"轻松工作"</span>)；\\返回为 <span class="number">4</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>如果需要存储表情，那么选择 utf8mb4 来进行存储，注意它与 utf-8 编码的区别。</p>
</li>
</ul>
</li>
<li>不建议在开发代码中使用此语句 TRUNCATE TABLE<ul>
<li>TRUNCATE TABLE 比 DELETE 速度快，且使用的系统和事务日志资源少，但 TRUNCATE 无事务且不触发 trigger，有可能造成事故，故不建议在开发代码中使用此语句。</li>
<li>说明： TRUNCATE TABLE 在功能上与不带 WHERE 子句的 DELETE 语句相同。</li>
</ul>
</li>
</ol>
<h3 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h3><ul>
<li>能够快速缩小结果集的 WHERE 条件写在前面，如果有恒量条 件，也尽量放在前面 ，例如 where 1=1  </li>
<li>避免使用 GROUP BY、DISTINCT 等语句的使用，避免联表查 询和子查询 </li>
<li>能够使用索引的字段尽量进行有效的合理排列  </li>
<li>针对索引字段使用 &gt;, &gt;=, =, &lt;, &lt;=, IF NULL 和 BETWEEN 将会 使用索引，如果对某个索引字段进行 LIKE 查询，使用 LIKE   ‘%abc%’ 不能使用索引，使用 LIKE ‘abc%’ 将能够使用索引  </li>
<li>如果在 SQL 里使用了 MySQL部分自带函数，索引将失效</li>
<li>避免直接使用 select *,只取需要的字段，增加使用覆盖索引使用的可能  </li>
<li>对于大数据量的查询，尽量避免在 SQL 语句中使用 order by 字<br>句 </li>
<li>连表查询的情况下，要确保关联条件的数据类型一致，避免嵌<br>套子查询  </li>
<li>对于连续的数值，使用 between 代替 in  </li>
<li>where 语句中尽量不要使用 CASE 条件  </li>
<li>当只要一行数据时使用 LIMIT 1</li>
</ul>
<h1 id="ORM-映射"><a href="#ORM-映射" class="headerlink" title="ORM 映射"></a>ORM 映射</h1><h2 id="强制要求-3"><a href="#强制要求-3" class="headerlink" title="强制要求"></a>强制要求</h2><ol>
<li>在表查询中，一律不要使用 * 作为查询的字段列表，需要哪些字段必须明确写明。<ul>
<li>说明： <ol>
<li>增加查询分析器解析成本.</li>
<li>增减字段容易与 resultMap 配置不一致。</li>
</ol>
</li>
</ul>
</li>
<li>POJO 类的布尔属性不能加 is，而数据库字段必须加 is_，要求在 resultMap 中进行<br>字段与属性之间的映射。</li>
<li>不要用 resultClass 当返回参数，即使所有类属性名与数据库字段一一对应，也需要定义；反过来，每一个表也必然有一个与之对应。<ul>
<li>说明： 配置映射关系，使字段与 DO 类解耦，方便维护。</li>
</ul>
</li>
<li>sql.xml 配置参数使用： <code>#{}</code>， <code>#param#</code> 不要使用${} 此种方式容易出现 SQL 注入。</li>
<li><p>iBATIS 自带的 queryForList(String statementName,int start,int size)不推荐使用。</p>
<ul>
<li>说明：其实现方式是在数据库取到 statementName对应的SQL语句的所有记录，再通过 subList<br>取 start,size 的子集合。</li>
<li>正例：   <figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;<span class="keyword">String</span>, <span class="keyword">Object</span>&gt; <span class="built_in">map</span> = <span class="keyword">new</span> <span class="keyword">HashMap</span>&lt;<span class="keyword">String</span>, <span class="keyword">Object</span>&gt;();</span><br><span class="line"><span class="built_in">map</span>.put(<span class="string">"start"</span>, start);</span><br><span class="line"><span class="built_in">map</span>.put(<span class="string">"size"</span>, <span class="built_in">size</span>);</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>不允许直接拿 HashMap 与 Hashtable 作为查询结果集的输出。</p>
<ul>
<li>说明： resultClass=”Hashtable”， 会置入字段名和属性值，但是值的类型不可控。</li>
</ul>
</li>
<li>更新数据表记录时，必须同时更新记录对应的 gmt_modified 字段值为当前时间。</li>
</ol>
<h2 id="推荐规约-3"><a href="#推荐规约-3" class="headerlink" title="推荐规约"></a>推荐规约</h2><ol>
<li>不要写一个大而全的数据更新接口。 传入为 POJO 类，不管是不是自己的目标更新字<br>段，都进行 <code>update table set c1=value1,c2=value2,c3=value3;</code> 这是不对的。执行 SQL时， 不要更新无改动的字段，一是易出错； 二是效率低； 三是增加 binlog 存储。</li>
</ol>
<h2 id="规约参考-3"><a href="#规约参考-3" class="headerlink" title="规约参考"></a>规约参考</h2><ol>
<li><code>@Transactional</code> 事务不要滥用。事务会影响数据库的 QPS，另外使用事务的地方需要考虑各方面的回滚方案，包括缓存回滚、搜索引擎回滚、消息补偿、统计修正等。</li>
<li><code>&lt;isEqual&gt;</code>中的 <code>compareValue</code> 是与属性值对比的常量，一般是数字，表示相等时带上此条件； <code>&lt;isNotEmpty&gt;</code>表示不为空且不为 <code>null</code> 时执行；<code>&lt;isNotNull&gt;</code>表示不为 <code>null</code> 值时执行。</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dinghuang.github.io/2020/11/08/Git提交规范/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="强壮的病猫">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/dinghuang.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一只病猫">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/11/08/Git提交规范/" itemprop="url">Git提交规范</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-11-08T15:47:00+08:00">
                2020-11-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/GIT/" itemprop="url" rel="index">
                    <span itemprop="name">GIT</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/11/08/Git提交规范/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/11/08/Git提交规范/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <h1 id="设置用户"><a href="#设置用户" class="headerlink" title="设置用户"></a>设置用户</h1><p>首次拉代码后，在目录下用命令行设置用户信息</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git<span class="built_in"> config </span>core.ignorecase <span class="literal">false</span></span><br><span class="line">git<span class="built_in"> config </span>--global user.name <span class="string">"张三"</span></span><br><span class="line">git<span class="built_in"> config </span>--global user.email san.zhang@gmail.com</span><br></pre></td></tr></table></figure>
<h1 id="Git-Commit规范"><a href="#Git-Commit规范" class="headerlink" title="Git Commit规范"></a>Git Commit规范</h1><p>规定格式如下：<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="params">&lt;type&gt;</span>(<span class="params">&lt;scope&gt;</span>): <span class="params">&lt;subject&gt;</span> <span class="meta">#issue_number</span></span><br><span class="line"></span><br><span class="line"><span class="params">&lt;description&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>其中，type、scope、subject是必需的，description 可以省略。不管是哪一个部分，任何一行都不得超过72个字符（或100个字符）。这是为了避免自动换行影响美观。</p>
<h2 id="type-必须-取值说明"><a href="#type-必须-取值说明" class="headerlink" title="type(必须)取值说明"></a>type(必须)取值说明</h2><p>type用于说明 commit 的类别:</p>
<ul>
<li>feat: (feature)增加新功能</li>
<li>fix: 修补bug</li>
<li>docs: 文档（documentation）， 只改动了文档相关的内容</li>
<li>style: 不影响代码含义的改动，例如去掉空格、改变缩进、增删分号</li>
<li>build: 构造工具的或者外部依赖的改动，例如webpack，npm</li>
<li>refactor: 代码重构时使用</li>
<li>revert：回滚到上一个版本,执行git revert打印的message</li>
<li>test:  添加测试或者修改现有测试</li>
<li>pref: 提高性能的改动</li>
<li>chore: 不修改src或者test的其余修改，例如构建过程或辅助工具的变动</li>
<li>merge：代码合并</li>
<li>sync：同步主线或分支的Bug</li>
<li>ci: 与CI（持续集成服务）有关的改动</li>
</ul>
<h2 id="scope-可选-取值说明"><a href="#scope-可选-取值说明" class="headerlink" title="scope(可选)取值说明"></a>scope(可选)取值说明</h2><p>scope用于说明 commit影响的范围，比如数据层、控制层、视图层等等，视项目不同而不同。例如：<br>node-pc/common rrd-h5/activity，而we-sdk不需指定模块名。如果一次commit修改多个模块，建议拆分成多次commit，以便更好追踪和维护。后加入项目的新成员应遵循已有的 scope 约定（通过 git log可以查看某个文件的提交历史），不要自己编造。使用首字母小写的驼峰命名。除具体的模块、组件名之外，可以使用 base 表示基础结构、框架相关的改动，用 misc 表示杂项改动，用 all 表示大范围重构。</p>
<p>例如在Angular，可以是location，browser，compile，compile，rootScope， ngHref，ngClick，ngView等。如果你的修改影响了不止一个scope，你可以使用*代替。</p>
<h2 id="subject-必须"><a href="#subject-必须" class="headerlink" title="subject(必须)"></a>subject(必须)</h2><p>subject是 commit 目的的简短描述，50 个字符左右的简要说明。</p>
<h2 id="中文"><a href="#中文" class="headerlink" title="中文"></a>中文</h2><ul>
<li>结尾不加句号或其他标点符号。</li>
<li>根据以上规范git commit message将是如下的格式：<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">fix</span><span class="params">(DAO)</span></span>:用户查询缺少username属性 </span><br><span class="line"><span class="function"><span class="title">feat</span><span class="params">(Controller)</span></span>:用户查询接口开发</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>以上就是我们梳理的git commit规范，那么我们这样规范git commit到底有哪些好处呢？</p>
<ul>
<li>便于程序员对提交历史进行追溯，了解发生了什么情况。</li>
<li>一旦约束了commit message，意味着我们将慎重的进行每一次提交，不能再一股脑的把各种各样的改动都放在一个git commit里面，这样一来整个代码改动的历史也将更加清晰。</li>
<li>格式化的commit message才可以用于自动化输出Change log。</li>
</ul>
<h2 id="英文"><a href="#英文" class="headerlink" title="英文"></a>英文</h2><p>首字母小写，通常是动宾结构，描述做了什么事情，动词用一般现在时，禁止出现 update code ， fix bug 等无实际意义的描述，好的例子： select connector by sorting free memory （不需要形如 update about how to select connector … 的啰嗦写法）, fix success tip can not show on IE8 （不需要形如 fix bug of … 的啰嗦写法）</p>
<ul>
<li>以动词开头，使用第一人称现在时，比如change，而不是changed或changes</li>
<li>尽量使用简单句保证简洁性</li>
<li>第一个字母小写</li>
<li>结尾不加句号（.）</li>
<li>通过翻译检测工具确认英文的正确性和可读性</li>
</ul>
<h2 id="body"><a href="#body" class="headerlink" title="body"></a>body</h2><p>body填写详细描述，主要描述改动之前的情况及修改动机，对于小的修改不作要求，但是重大需求、更新等必须添加body来作说明。</p>
<h2 id="break-changes"><a href="#break-changes" class="headerlink" title="break changes"></a>break changes</h2><p>break changes指明是否产生了破坏性修改，涉及break changes的改动必须指明该项，类似版本升级、接口参数减少、接口删除、迁移等。</p>
<h2 id="affect-issues"><a href="#affect-issues" class="headerlink" title="affect issues"></a>affect issues</h2><p>affect issues指明是否影响了某个问题。例如我们使用jira时，我们在commit message中可以填写其影响的JIRA_ID，若要开启该功能需要先打通jira与gitlab。</p>
<h2 id="使用Commitizen工具"><a href="#使用Commitizen工具" class="headerlink" title="使用Commitizen工具"></a>使用Commitizen工具</h2><p>安装commitizen<br><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm <span class="keyword">install</span> -g commitizen</span><br></pre></td></tr></table></figure></p>
<p>安装完成后，使用<br><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">(base) [@dinghuangMacPro:test (master)]$git add .</span><br><span class="line">(base) [@dinghuangMacPro:test (master)]$git cz</span><br><span class="line"><span class="meta">#会出现下面的，按照提示写入</span></span><br><span class="line">(base) [@dinghuangMacPro:test (master)]$ git cz</span><br><span class="line">cz-cli@<span class="number">4.2</span><span class="number">.2</span>, cz-conventional-changelog@<span class="number">3.3</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line">? <span class="keyword">Select</span> the type <span class="keyword">of</span> change that you<span class="comment">'re committing: (Use arrow keys)</span></span><br><span class="line">❯ feat:     A <span class="keyword">new</span> feature</span><br><span class="line">  fix:      A bug fix</span><br><span class="line">  docs:     Documentation only changes</span><br><span class="line">  style:    Changes that <span class="keyword">do</span> <span class="keyword">not</span> affect the meaning <span class="keyword">of</span> the code (white-space, formatting, missing semi-colons, etc)</span><br><span class="line">  refactor: A code change that neither fixes a bug nor adds a feature</span><br><span class="line">  perf:     A code change that improves performance</span><br><span class="line">  test:     Adding missing tests <span class="keyword">or</span> correcting existing tests</span><br><span class="line">(Move up <span class="keyword">and</span> down <span class="keyword">to</span> reveal more choices)</span><br><span class="line"></span><br><span class="line"><span class="meta">#选择类型后</span></span><br><span class="line">? <span class="keyword">Select</span> the type <span class="keyword">of</span> change that you<span class="comment">'re committing: feat:     A new feature</span></span><br><span class="line">? What <span class="keyword">is</span> the scope <span class="keyword">of</span> this change (e.g. component <span class="keyword">or</span> file name): (press enter <span class="keyword">to</span> <span class="keyword">skip</span>) add aa.txt</span><br><span class="line">? Write a <span class="built_in">short</span>, imperative tense description <span class="keyword">of</span> the change (max <span class="number">82</span> chars):</span><br><span class="line"> (<span class="number">4</span>) 新增文件</span><br><span class="line">? Provide a longer description <span class="keyword">of</span> the change: (press enter <span class="keyword">to</span> <span class="keyword">skip</span>)</span><br><span class="line"> 长描述：这是我第一次的提交</span><br><span class="line">? Are there any breaking changes? No</span><br><span class="line">? Does this change affect any open issues? Yes</span><br><span class="line">? Add issue references (e.g. <span class="string">"fix #123"</span>, <span class="string">"re #123"</span>.):</span><br><span class="line"> feat <span class="meta">#123</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#查看生成的git commit信息</span></span><br><span class="line">(base) [@dinghuangMacPro:test (master)]$ git log</span><br><span class="line">commit <span class="number">00</span>d63b2c54c502bb75725e5a461d6ce9499910bc (HEAD -&gt; master)</span><br><span class="line">Author: 丁煌 &lt;dinghuang123@gmail.com&gt;</span><br><span class="line"><span class="built_in">Date</span>:   Wed Nov <span class="number">25</span> <span class="number">13</span>:<span class="number">39</span>:<span class="number">13</span> <span class="number">2020</span> +<span class="number">0800</span></span><br><span class="line"></span><br><span class="line">    feat(add aa.txt): 新增文件</span><br><span class="line"></span><br><span class="line">    长描述：这是我第一次的提交</span><br><span class="line"></span><br><span class="line">    feat <span class="meta">#123</span></span><br></pre></td></tr></table></figure></p>
<p>自动生成Change log<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install -g conventional-changelog-cli</span><br><span class="line">conventional-changelog -<span class="selector-tag">p</span> angular -<span class="selector-tag">i</span> CHANGELOG<span class="selector-class">.md</span> -s</span><br></pre></td></tr></table></figure></p>
<p>这个插件是根据当前分支提交的所有commit信息来生成对应的changelog，一般是在开发完成后，封代码后去进行生成。如果自动生成的有问题，可以根据自己的需求进行修改。</p>
<h1 id="分支规范"><a href="#分支规范" class="headerlink" title="分支规范"></a>分支规范</h1><h2 id="分支基本原则"><a href="#分支基本原则" class="headerlink" title="分支基本原则"></a>分支基本原则</h2><p>基本原则：master为保护分支，不直接在master上进行代码修改和提交。</p>
<p>开发日常需求或者项目时，从master分支上checkout一个feature分支进行开发或者bugfix分支进行bug修复，功能测试完毕并且项目发布上线后，将feature分支合并到主干master，并且打Tag发布，最后删除开发分支。</p>
<h2 id="分支命名规范"><a href="#分支命名规范" class="headerlink" title="分支命名规范"></a>分支命名规范</h2><p>例如：</p>
<ul>
<li>分支版本命名规则：分支类型 分支发布时间 分支功能。比如：feature_20200401_#issueNum<ul>
<li>分支类型包括：feature、bugfix、refactor三种类型，即新功能开发、bug修复和代码重构</li>
<li>时间使用年月日进行命名，不足2位补0</li>
<li>分支功能命名使用snake case命名法，即下划线命名。</li>
</ul>
</li>
<li>Tag包括3位版本，前缀使用v。比如v1.2.31。Tag命名规范：<ul>
<li>新功能开发使用第2位版本号，bug修复使用第3位版本号</li>
<li>核心基础库或者Node中间价可以在大版本发布请使用灰度版本号，在版本后面加上后缀，用中划线分隔。alpha或者belta后面加上次数，即第几次alpha(具体可以查看语义化版本)：<ul>
<li>v2.0.0-alpha-1</li>
<li>v2.0.0-belta-1</li>
</ul>
</li>
</ul>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dinghuang.github.io/2020/10/20/SpringBoot2.X Security Oauth2 JWT/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="强壮的病猫">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/dinghuang.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一只病猫">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/10/20/SpringBoot2.X Security Oauth2 JWT/" itemprop="url">SpringBoot2.X Security Oauth2 JWT</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-10-20T15:47:00+08:00">
                2020-10-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/10/20/SpringBoot2.X Security Oauth2 JWT/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/10/20/SpringBoot2.X Security Oauth2 JWT/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p><a href="hhttps://spring.io/projects/spring-security" target="_blank" rel="noopener">官网地址</a></p>
<p><a href="https://docs.spring.io/spring-security/site/docs/4.0.x/reference/html/introduction.html#what-is-acegi-security" target="_blank" rel="noopener">官方文档</a></p>
<p>Spring Security，这是一种基于 Spring AOP 和 Servlet 过滤器的安全框架。它提供全面的安全性解决方案，同时在 Web 请求级和方法调用级处理身份确认和授权。</p>
<p>Spring Security当前支持与所有以下技术的身份验证集</p>
<ul>
<li>HTTP BASIC authentication headers (an IETF RFC-based standard)</li>
<li>HTTP Digest authentication headers (an IETF RFC-based standard)</li>
<li>HTTP X.509 client certificate exchange (an IETF RFC-based standard)</li>
<li>LDAP (a very common approach to cross-platform authentication needs, especially in large environments)</li>
<li>Form-based authentication (for simple user interface needs)</li>
<li>OpenID authentication</li>
<li>Authentication based on pre-established request headers (such as Computer Associates Siteminder)</li>
<li>JA-SIG Central Authentication Service (otherwise known as CAS, which is a popular open source single sign-on system)</li>
<li>Transparent authentication context propagation for Remote Method Invocation (RMI) and HttpInvoker (a Spring remoting protocol)</li>
<li>Automatic “remember-me” authentication (so you can tick a box to avoid re-authentication for a predetermined period of time)</li>
<li>Anonymous authentication (allowing every unauthenticated call to automatically assume a particular security identity)</li>
<li>Run-as authentication (which is useful if one call should proceed with a different security identity)</li>
<li>Java Authentication and Authorization Service (JAAS)</li>
<li>JEE container autentication (so you can still use Container - Managed Authentication if desired)</li>
<li>Kerberos</li>
<li>Java Open Source Single Sign On (JOSSO) *</li>
<li>OpenNMS Network Management Platform *</li>
<li>AppFuse *</li>
<li>AndroMDA *</li>
<li>Mule ESB *</li>
<li>Direct Web Request (DWR) *</li>
<li>Grails *</li>
<li>Tapestry *</li>
<li>JTrac *</li>
<li>Jasypt *</li>
<li>Roller *</li>
<li>Elastic Path *</li>
<li>Atlassian Crowd *</li>
<li>Your own authentication systems (see below) </li>
</ul>
<p>涉及以下系统组件：<br>客户端：它可以是任何平台上的任何Web服务使用者。简而言之，它可以是另一个WebService，UI应用程序或Mobile平台，它们希望通过应用程序以安全的方式读写数据。<br>授权服务器：验证用户凭据，并颁发令牌。它根据不同的授予类型发行令牌。下面列出了最常见的<a href="hhttps://tools.ietf.org/html/draft-ietf-oauth-v2-31" target="_blank" rel="noopener">OAuth 2.0</a>授权类型：</p>
<ul>
<li>Authorization Code</li>
<li>Implicit</li>
<li>Password</li>
<li>Client Credentials</li>
<li>Device Code</li>
<li>Refresh Token</li>
</ul>
<p>名词解释可以看<a href="https://projects.spring.io/spring-security-oauth/docs/oauth2.html" target="_blank" rel="noopener">SpringOauth2官方文档</a></p>
<h1 id="架构设计"><a href="#架构设计" class="headerlink" title="架构设计"></a>架构设计</h1><p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/spring-boot-authentication-spring-security-architecture.png" alt="image"></p>
<h2 id="名词解释"><a href="#名词解释" class="headerlink" title="名词解释"></a>名词解释</h2><p>– WebSecurityConfigurerAdapter 是我们安全实施的关键。它提供HttpSecurity配置以配置cors，csrf，会话管理以及受保护资源的规则。我们还可以扩展和定制包含以下元素的默认配置。</p>
<p>– UserDetailsService 接口有一种方法可以按用户名加载User并返回UserDetailsSpring Security可以用于认证和验证的对象。</p>
<p>– UserDetails 包含用于构建身份验证对象的必要信息（例如：用户名，密码，授权机构）。</p>
<p>– UsernamePasswordAuthenticationToken 从登录请求中获取{用户名，密码}，AuthenticationManager将使用它来认证登录帐户。</p>
<p>– AuthenticationManager 有一个DaoAuthenticationProvider（与帮助UserDetailsService＆PasswordEncoder）来验证UsernamePasswordAuthenticationToken对象。如果成功，则AuthenticationManager返回完全填充的身份验证对象（包括授予的权限）。</p>
<p>– OncePerRequestFilter 对我们API的每个请求执行一次。它提供了一种doFilterInternal()方法，我们将实现解析和验证JWT，加载用户详细信息（使用UserDetailsService），检查授权（使用UsernamePasswordAuthenticationToken）。</p>
<p>– AuthenticationEntryPoint 当客户端未经身份验证访问受保护的资源时，将捕获未经授权的错误并返回401。</p>
<h2 id="认证流程"><a href="#认证流程" class="headerlink" title="认证流程"></a>认证流程</h2><p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/oauth-auth-code_c4oi91.png" alt="image"></p>
<h1 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h1><h2 id="引入maven包"><a href="#引入maven包" class="headerlink" title="引入maven包"></a>引入maven包</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span><span class="meta">?&gt;</span></span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">	<span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.1.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.security.oauth2<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-security-oauth2-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0.BUILD-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">packaging</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">modules</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">module</span>&gt;</span>auth-server<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">module</span>&gt;</span>client-app<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">module</span>&gt;</span>resource-server<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">modules</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.security.oauth<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-security-oauth2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.security.oauth.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-security-oauth2-autoconfigure<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.1.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.security<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-security-jwt<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.1.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.jsonwebtoken<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jjwt<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">version</span>&gt;</span>0.9.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>核心代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.security.oauth.config;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.AuthenticationException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.AuthenticationEntryPoint;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> dinghuang123@gmail.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2020/10/20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomerAuthenticationEntryPointConfiguration</span> <span class="keyword">implements</span> <span class="title">AuthenticationEntryPoint</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commence</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, AuthenticationException e)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        <span class="comment">//处理异常消息通知</span></span><br><span class="line">        httpServletResponse.getWriter().write(<span class="string">"暂无权限访问"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.security.oauth.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.AuthenticationProvider;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.UsernamePasswordAuthenticationToken;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.Authentication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.AuthenticationException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.authority.AuthorityUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.context.SecurityContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.User;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> dinghuang123@gmail.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2020/10/20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomerAuthenticationProviderConfiguration</span> <span class="keyword">implements</span> <span class="title">AuthenticationProvider</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Authentication <span class="title">authenticate</span><span class="params">(Authentication authentication)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">        <span class="comment">//这里做自定义的用户校验,可以对用户进行继承扩展</span></span><br><span class="line">        User user = <span class="keyword">new</span> User((String) authentication.getPrincipal(), (String) authentication.getCredentials(), AuthorityUtils.commaSeparatedStringToAuthorityList(<span class="string">"admin"</span>));</span><br><span class="line">        <span class="comment">//这里可以通过继承AbstractAuthenticationToken进行扩展</span></span><br><span class="line">        UsernamePasswordAuthenticationToken usernamePasswordAuthenticationToken = <span class="keyword">new</span> UsernamePasswordAuthenticationToken(authentication.getPrincipal(), authentication.getCredentials());</span><br><span class="line">        usernamePasswordAuthenticationToken.setDetails(user);</span><br><span class="line">        SecurityContextHolder.getContext().setAuthentication(usernamePasswordAuthenticationToken);</span><br><span class="line">        <span class="keyword">return</span> usernamePasswordAuthenticationToken;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(Class&lt;?&gt; aClass)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">package</span> <span class="selector-tag">org</span><span class="selector-class">.springframework</span><span class="selector-class">.security</span><span class="selector-class">.oauth</span><span class="selector-class">.config</span>;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">org</span><span class="selector-class">.springframework</span><span class="selector-class">.beans</span><span class="selector-class">.factory</span><span class="selector-class">.annotation</span><span class="selector-class">.Autowired</span>;</span><br><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">org</span><span class="selector-class">.springframework</span><span class="selector-class">.context</span><span class="selector-class">.annotation</span><span class="selector-class">.Configuration</span>;</span><br><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">org</span><span class="selector-class">.springframework</span><span class="selector-class">.security</span><span class="selector-class">.authentication</span><span class="selector-class">.AuthenticationManager</span>;</span><br><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">org</span><span class="selector-class">.springframework</span><span class="selector-class">.security</span><span class="selector-class">.core</span><span class="selector-class">.Authentication</span>;</span><br><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">org</span><span class="selector-class">.springframework</span><span class="selector-class">.security</span><span class="selector-class">.core</span><span class="selector-class">.AuthenticationException</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @author dinghuang123@gmail.com</span></span><br><span class="line"><span class="comment"> * @since 2020/10/20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">@<span class="keyword">Configuration</span></span><br><span class="line"><span class="keyword">public</span> class CustomerAuthenticationManager implements AuthenticationManager &#123;</span><br><span class="line"></span><br><span class="line">    @<span class="keyword">Autowired</span></span><br><span class="line">    private CustomerAuthenticationProviderConfiguration customerAuthenticationProviderConfiguration;</span><br><span class="line"></span><br><span class="line">    @<span class="keyword">Override</span></span><br><span class="line">    public Authentication authenticate(Authentication authentication) throws AuthenticationException &#123;</span><br><span class="line">        <span class="selector-tag">return</span> <span class="selector-tag">customerAuthenticationProviderConfiguration</span><span class="selector-class">.authenticate</span>(<span class="selector-tag">authentication</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.security.oauth.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth.properties.Oauth2ClientProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth.properties.Oauth2Properties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.builders.InMemoryClientDetailsServiceBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.configurers.ClientDetailsServiceConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.AuthorizationServerConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.EnableAuthorizationServer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configurers.AuthorizationServerEndpointsConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configurers.AuthorizationServerSecurityConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.TokenStore;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.store.JwtAccessTokenConverter;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> dinghuang123@gmail.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2020/10/20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAuthorizationServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomerAuthorizationServerConfiguration</span> <span class="keyword">extends</span> <span class="title">AuthorizationServerConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TokenStore tokenStore;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JwtAccessTokenConverter jwtAccessTokenConverter;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CustomerAuthenticationManager customerAuthenticationManager;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Oauth2Properties oauth2Properties;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CustomerWebResponseExceptionTranslator customerWebResponseExceptionTranslator;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthorizationServerEndpointsConfigurer authorizationServerEndpointsConfigurer)</span> </span>&#123;</span><br><span class="line">        authorizationServerEndpointsConfigurer.tokenEnhancer(jwtAccessTokenConverter)</span><br><span class="line">                .tokenStore(tokenStore)</span><br><span class="line">                .authenticationManager(customerAuthenticationManager)</span><br><span class="line">                .exceptionTranslator(customerWebResponseExceptionTranslator);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthorizationServerSecurityConfigurer authorizationServerSecurityConfigurer)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        authorizationServerSecurityConfigurer.tokenKeyAccess(<span class="string">"permitAll()"</span>)</span><br><span class="line">                .allowFormAuthenticationForClients()</span><br><span class="line">                .checkTokenAccess(<span class="string">"isAuthenticated"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(ClientDetailsServiceConfigurer clientDetailsServiceConfigurer)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        InMemoryClientDetailsServiceBuilder inMemoryClientDetailsServiceBuilder = clientDetailsServiceConfigurer.inMemory();</span><br><span class="line">        <span class="keyword">for</span> (Oauth2ClientProperties oauth2ClientProperties : oauth2Properties.getClients()) &#123;</span><br><span class="line">            inMemoryClientDetailsServiceBuilder.withClient(oauth2ClientProperties.getClientId())</span><br><span class="line">                    .secret(bCryptPasswordEncoder().encode(oauth2ClientProperties.getClientSecret()))</span><br><span class="line">                    .accessTokenValiditySeconds(oauth2ClientProperties.getAccessTokenValiditySeconds())</span><br><span class="line">                    .refreshTokenValiditySeconds(oauth2ClientProperties.getRefreshTokenValiditySeconds())</span><br><span class="line">                    .authorizedGrantTypes(<span class="string">"refresh_token"</span>, <span class="string">"password"</span>, <span class="string">"authorization_code"</span>)</span><br><span class="line">                    .scopes(oauth2ClientProperties.getScopes());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> BCryptPasswordEncoder <span class="title">bCryptPasswordEncoder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BCryptPasswordEncoder();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">package</span> <span class="selector-tag">org</span><span class="selector-class">.springframework</span><span class="selector-class">.security</span><span class="selector-class">.oauth</span><span class="selector-class">.config</span>;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">org</span><span class="selector-class">.springframework</span><span class="selector-class">.beans</span><span class="selector-class">.factory</span><span class="selector-class">.annotation</span><span class="selector-class">.Autowired</span>;</span><br><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">org</span><span class="selector-class">.springframework</span><span class="selector-class">.context</span><span class="selector-class">.annotation</span><span class="selector-class">.Configuration</span>;</span><br><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">org</span><span class="selector-class">.springframework</span><span class="selector-class">.security</span><span class="selector-class">.authentication</span><span class="selector-class">.AuthenticationManager</span>;</span><br><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">org</span><span class="selector-class">.springframework</span><span class="selector-class">.security</span><span class="selector-class">.config</span><span class="selector-class">.annotation</span><span class="selector-class">.web</span><span class="selector-class">.builders</span><span class="selector-class">.HttpSecurity</span>;</span><br><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">org</span><span class="selector-class">.springframework</span><span class="selector-class">.security</span><span class="selector-class">.config</span><span class="selector-class">.annotation</span><span class="selector-class">.web</span><span class="selector-class">.configuration</span><span class="selector-class">.EnableWebSecurity</span>;</span><br><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">org</span><span class="selector-class">.springframework</span><span class="selector-class">.security</span><span class="selector-class">.config</span><span class="selector-class">.annotation</span><span class="selector-class">.web</span><span class="selector-class">.configuration</span><span class="selector-class">.WebSecurityConfigurerAdapter</span>;</span><br><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">org</span><span class="selector-class">.springframework</span><span class="selector-class">.security</span><span class="selector-class">.oauth</span><span class="selector-class">.filter</span><span class="selector-class">.CustomerOauth2AuthenticationProcessingFilter</span>;</span><br><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">org</span><span class="selector-class">.springframework</span><span class="selector-class">.security</span><span class="selector-class">.web</span><span class="selector-class">.authentication</span><span class="selector-class">.AnonymousAuthenticationFilter</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @author dinghuang123@gmail.com</span></span><br><span class="line"><span class="comment"> * @since 2020/10/20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">@<span class="keyword">Configuration</span></span><br><span class="line">@<span class="keyword">EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> class CustomerSecurityConfiguration extends WebSecurityConfigurerAdapter &#123;</span><br><span class="line"></span><br><span class="line">    @<span class="keyword">Autowired</span></span><br><span class="line">    private CustomerAuthenticationManager customerAuthenticationManager;</span><br><span class="line">    @<span class="keyword">Autowired</span></span><br><span class="line">    private CustomerAuthenticationEntryPointConfiguration customerAuthenticationEntryPointConfiguration;</span><br><span class="line">    @<span class="keyword">Autowired</span></span><br><span class="line">    private CustomerOauth2AuthenticationProcessingFilter customerOauth2AuthenticationProcessingFilter;</span><br><span class="line"></span><br><span class="line">    @<span class="keyword">Override</span></span><br><span class="line">    protected void configure(HttpSecurity httpSecurity) throws  Exception&#123;</span><br><span class="line">        <span class="selector-tag">httpSecurity</span><span class="selector-class">.authorizeRequests</span>()<span class="selector-class">.anyRequest</span>()<span class="selector-class">.authenticated</span>()<span class="selector-class">.and</span>()<span class="selector-class">.addFilterBefore</span>(<span class="selector-tag">customerOauth2AuthenticationProcessingFilter</span>, <span class="selector-tag">AnonymousAuthenticationFilter</span><span class="selector-class">.class</span>)</span><br><span class="line">                <span class="selector-class">.csrf</span>()<span class="selector-class">.disable</span>()<span class="selector-class">.exceptionHandling</span>()<span class="selector-class">.authenticationEntryPoint</span>(<span class="selector-tag">customerAuthenticationEntryPointConfiguration</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @<span class="keyword">Override</span></span><br><span class="line">    public AuthenticationManager authenticationManager()&#123;</span><br><span class="line">        <span class="selector-tag">return</span> <span class="selector-tag">customerAuthenticationManager</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.security.oauth.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.common.exceptions.OAuth2Exception;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.error.WebResponseExceptionTranslator;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> dinghuang123@gmail.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2020/10/20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomerWebResponseExceptionTranslator</span> <span class="keyword">implements</span> <span class="title">WebResponseExceptionTranslator</span>&lt;<span class="title">OAuth2Exception</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseEntity&lt;OAuth2Exception&gt; <span class="title">translate</span><span class="params">(Exception e)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//自定义认证失败信息</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.security.oauth.config.token;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.AbstractAuthenticationToken;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.OAuth2Authentication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.AuthenticationKeyGenerator;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> dinghuang123@gmail.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2020/10/20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomerAuthenticationKeyGeneratorConfiguration</span> <span class="keyword">implements</span> <span class="title">AuthenticationKeyGenerator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">extractKey</span><span class="params">(OAuth2Authentication authentication)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//自定义token生成，可以用来实现ip控制登录用户只能有一个，顶掉登录</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.security.oauth.config.token;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.<span class="type">JwtHandlerAdapter</span>;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.<span class="type">Configuration</span>;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.common.<span class="type">OAuth2AccessToken</span>;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.<span class="type">OAuth2Authentication</span>;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.store.<span class="type">JwtAccessTokenConverter</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @author dinghuang123@gmail.com</span></span><br><span class="line"><span class="comment"> * @since 2020/10/20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">CustomerJwtAccessTokenConverterConfiguration</span> <span class="keyword">extends</span> <span class="title">JwtAccessTokenConverter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    public <span class="type">OAuth2AccessToken</span> enhance(<span class="type">OAuth2AccessToken</span> oAuth2AccessToken, <span class="type">OAuth2Authentication</span> oAuth2Authentication)&#123;</span><br><span class="line">       <span class="comment">//可以实现jwt的token放一些用户信息</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.enhance(oAuth2AccessToken,oAuth2Authentication);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.security.oauth.config.token;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.<span class="keyword">annotation</span>.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.<span class="keyword">annotation</span>.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.<span class="keyword">annotation</span>.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.<span class="keyword">data</span>.redis.connection.RedisConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth.properties.Oauth2Properties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.TokenStore;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.store.JwtAccessTokenConverter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.store.redis.RedisTokenStore;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> dinghuang123<span class="doctag">@gmail</span>.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2020/10/20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomerJwtStoreConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisConnectionFactory redisConnectionFactory;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Oauth2Properties oauth2Properties;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CustomerAuthenticationKeyGeneratorConfiguration customerAuthenticationKeyGeneratorConfiguration;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CustomerJwtAccessTokenConverterConfiguration customerJwtAccessTokenConverterConfiguration;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> TokenStore redisTokenStore() &#123;</span><br><span class="line">        RedisTokenStore redisTokenStore = new RedisTokenStore(redisConnectionFactory);</span><br><span class="line">        redisTokenStore.setAuthenticationKeyGenerator(customerAuthenticationKeyGeneratorConfiguration);</span><br><span class="line">        <span class="keyword">return</span> redisTokenStore;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> JwtAccessTokenConverter jwtAccessTokenConverter() &#123;</span><br><span class="line">        customerJwtAccessTokenConverterConfiguration.setSigningKey(oauth2Properties.getJwtSigningKey());</span><br><span class="line">        <span class="keyword">return</span> customerJwtAccessTokenConverterConfiguration;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.security.oauth.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.InitializingBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.Authentication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.context.SecurityContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth.config.CustomerAuthenticationProviderConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth.properties.Oauth2Properties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.AntPathMatcher;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> dinghuang123@gmail.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2020/10/20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomerOauth2AuthenticationProcessingFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span>, <span class="title">InitializingBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Oauth2Properties oauth2Properties;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CustomerAuthenticationProviderConfiguration customerAuthenticationProviderConfiguration;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        HttpServletRequest httpServletRequest = (HttpServletRequest) servletRequest;</span><br><span class="line">        <span class="comment">//白名单过滤</span></span><br><span class="line">        AntPathMatcher antPathMatcher = <span class="keyword">new</span> AntPathMatcher();</span><br><span class="line">        <span class="keyword">for</span> (String path : oauth2Properties.getPermitUrl().split(<span class="string">","</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (antPathMatcher.match(path, httpServletRequest.getPathInfo())) &#123;</span><br><span class="line">                filterChain.doFilter(servletRequest, servletResponse);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//自定义验证</span></span><br><span class="line">        Authentication authentication = getFromRequest(httpServletRequest);</span><br><span class="line">        <span class="keyword">if</span> (authentication == <span class="keyword">null</span>) &#123;</span><br><span class="line">            SecurityContextHolder.clearContext();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            SecurityContextHolder.getContext().setAuthentication(customerAuthenticationProviderConfiguration.authenticate(authentication));</span><br><span class="line">        &#125;</span><br><span class="line">        filterChain.doFilter(servletRequest, servletResponse);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Authentication <span class="title">getFromRequest</span><span class="params">(HttpServletRequest httpServletRequest)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//todo 这里可以自己去实现</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.security.oauth.properties;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> dinghuang123@gmail.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2020/10/20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Oauth2ClientProperties</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String clientId;</span><br><span class="line">    <span class="keyword">private</span> String clientSecret;</span><br><span class="line">    <span class="keyword">private</span> String scopes;</span><br><span class="line">    <span class="keyword">private</span> Integer accessTokenValiditySeconds;</span><br><span class="line">    <span class="keyword">private</span> Integer refreshTokenValiditySeconds;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getClientId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> clientId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setClientId</span><span class="params">(String clientId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.clientId = clientId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getClientSecret</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> clientSecret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setClientSecret</span><span class="params">(String clientSecret)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.clientSecret = clientSecret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getScopes</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> scopes;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setScopes</span><span class="params">(String scopes)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.scopes = scopes;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getAccessTokenValiditySeconds</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> accessTokenValiditySeconds;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAccessTokenValiditySeconds</span><span class="params">(Integer accessTokenValiditySeconds)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.accessTokenValiditySeconds = accessTokenValiditySeconds;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getRefreshTokenValiditySeconds</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> refreshTokenValiditySeconds;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRefreshTokenValiditySeconds</span><span class="params">(Integer refreshTokenValiditySeconds)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.refreshTokenValiditySeconds = refreshTokenValiditySeconds;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.security.oauth.properties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> dinghuang123@gmail.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2020/10/20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"security.oauth2"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Oauth2Properties</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String jwtSigningKey;</span><br><span class="line">    <span class="keyword">private</span> String permitUrl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Oauth2ClientProperties[] clients = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getJwtSigningKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> jwtSigningKey;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setJwtSigningKey</span><span class="params">(String jwtSigningKey)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.jwtSigningKey = jwtSigningKey;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPermitUrl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> permitUrl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPermitUrl</span><span class="params">(String permitUrl)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.permitUrl = permitUrl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Oauth2ClientProperties[] getClients() &#123;</span><br><span class="line">        <span class="keyword">return</span> clients;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setClients</span><span class="params">(Oauth2ClientProperties[] clients)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.clients = clients;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">server:</span></span><br><span class="line"><span class="symbol">  port:</span> <span class="number">8090</span></span><br><span class="line"><span class="symbol">spring:</span></span><br><span class="line"><span class="symbol">  redis:</span></span><br><span class="line"><span class="symbol">    host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line"><span class="symbol">    port:</span> <span class="number">6379</span></span><br><span class="line"><span class="symbol">    password:</span></span><br><span class="line"><span class="symbol">security:</span></span><br><span class="line"><span class="symbol">  oauth2:</span></span><br><span class="line"><span class="symbol">    jwtSigningKey:</span> admin</span><br><span class="line"><span class="symbol">    permitUrl:</span> <span class="meta-keyword">/oauth/</span>**</span><br><span class="line">    clients[<span class="number">0</span>]:</span><br><span class="line"><span class="symbol">      clientId:</span> client</span><br><span class="line"><span class="symbol">      clientSecret:</span> client</span><br><span class="line"><span class="symbol">      scopes:</span> all</span><br><span class="line"><span class="symbol">      accessTokenValiditySeconds:</span> <span class="number">864000</span></span><br><span class="line"><span class="symbol">      refreshTokenValiditySeconds:</span> <span class="number">864000</span></span><br><span class="line"><span class="symbol">logging:</span></span><br><span class="line"><span class="symbol">  level:</span></span><br><span class="line"><span class="symbol">    root:</span> WARN</span><br><span class="line">    org.springframework.web: INFO</span><br><span class="line">    org.springframework.security: INFO</span><br><span class="line">    org.springframework.security.oauth2: INFO</span><br></pre></td></tr></table></figure>
<h2 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h2><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">curl</span> -H <span class="string">"Content-Type: application/json"</span> -X POST <span class="string">"http://localhost:8090/oauth/token?client_id=client&amp;client_secret=client&amp;grant_type=pwssword&amp;username=admin&amp;password&amp;admin"</span></span><br></pre></td></tr></table></figure>
<p><a href="https://github.com/dinghuang/spring-security-oauth2-demo.git" target="_blank" rel="noopener">代码地址</a></p>
<h1 id="结合网关"><a href="#结合网关" class="headerlink" title="结合网关"></a>结合网关</h1><h2 id="架构设计-1"><a href="#架构设计-1" class="headerlink" title="架构设计"></a>架构设计</h2><p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/viaL4.png" alt="image"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
      <div id="sidebar-dimmer"></div>
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/dinghuang.png"
                alt="强壮的病猫" />
            
              <p class="site-author-name" itemprop="name">强壮的病猫</p>
              <p class="site-description motion-element" itemprop="description">学习、生活、闲谈、足球</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">33</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">14</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">14</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/dinghuang" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-globe"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:dinghuang123@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.strongsickcat.com" target="_blank" title="Google">
                      
                        <i class="fa fa-fw fa-google"></i>Google</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 &mdash; <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">强壮的病猫</span>

  
</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
      <div id="needsharebutton-float">
        <span class="btn">
          <i class="fa fa-share-alt" aria-hidden="true"></i>
        </span>
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  

    
      <script id="dsq-count-scr" src="https://dinghuang-1.disqus.com/count.js" async></script>
    

    

  




	





  














  





  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  
  
  
  <link rel="stylesheet" href="/lib/needsharebutton/needsharebutton.css">

  
  
  <script src="/lib/needsharebutton/needsharebutton.js"></script>

  <script>
    
      pbOptions = {};
      
          pbOptions.iconStyle = "box";
      
          pbOptions.boxForm = "horizontal";
      
          pbOptions.position = "bottomCenter";
      
          pbOptions.networks = "Weibo,Wechat,Douban,QQZone,Twitter,Facebook";
      
      new needShareButton('#needsharebutton-postbottom', pbOptions);
    
    
      flOptions = {};
      
          flOptions.iconStyle = "box";
      
          flOptions.boxForm = "horizontal";
      
          flOptions.position = "middleRight";
      
          flOptions.networks = "Weibo,Wechat,Douban,QQZone,Twitter,Facebook";
      
      new needShareButton('#needsharebutton-float', flOptions);
    
  </script>

  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

</body>
</html>
