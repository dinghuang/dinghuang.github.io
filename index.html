<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">






  
  
  <link rel="stylesheet" media="all" href="/lib/Han/dist/han.min.css?v=3.3">




<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="google-site-verification" content="WSWvVPyzUsUM54ydNcrE1pUzdYt5xGKnqD1i7XpWVF8" />














  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png?v=5.1.4">


  <link rel="mask-icon" href="/images/safari-pinned-tab.svg?v=5.1.4" color="#222">


  <link rel="manifest" href="/images/site.webmanifest">


  <meta name="msapplication-config" content="/images/browserconfig.xml" />



  <meta name="keywords" content="Welcome" />










<meta name="description" content="学习、生活、闲谈、足球">
<meta property="og:type" content="website">
<meta property="og:title" content="一只病猫">
<meta property="og:url" content="https://dinghuang.github.io/index.html">
<meta property="og:site_name" content="一只病猫">
<meta property="og:description" content="学习、生活、闲谈、足球">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="一只病猫">
<meta name="twitter:description" content="学习、生活、闲谈、足球">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":true},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://dinghuang.github.io/"/>





  <title>一只病猫</title>
  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-108021384-1', 'auto');
  ga('send', 'pageview');
</script>


  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?00a1ba3f5c477c92d7c1ccbb00c6427b";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">一只病猫</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">静坐常思己过，闲谈莫论人非</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
            分类
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="st-search-show-outputs">
          
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <form class="site-search-form">
  <input type="text" id="st-search-input" class="st-search-input st-default-search-input" />
</form>

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'HcRPHRrBuwozvgUoLNyX','2.0.0');
</script>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dinghuang.github.io/2021/06/08/Seata部署使用(1.4.2)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="强壮的病猫">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/dinghuang.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一只病猫">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/06/08/Seata部署使用(1.4.2)/" itemprop="url">Seata部署使用(1.4.2)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-06-08T15:47:00+08:00">
                2021-06-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JAVA/" itemprop="url" rel="index">
                    <span itemprop="name">JAVA</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2021/06/08/Seata部署使用(1.4.2)/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2021/06/08/Seata部署使用(1.4.2)/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <p>源码地址： <a href="https://github.com/seata/seata.git" target="_blank" rel="noopener">https://github.com/seata/seata.git</a> </p>
<h1 id="前期准备"><a href="#前期准备" class="headerlink" title="前期准备"></a>前期准备</h1><h2 id="xa模式"><a href="#xa模式" class="headerlink" title="xa模式"></a>xa模式</h2><p>确保mysql版本&gt;5.7 并且开启了XA事务支持</p>
<h2 id="at模式"><a href="#at模式" class="headerlink" title="at模式"></a>at模式</h2><p>每个mysql库执行脚本<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="string">`undo_log`</span></span><br><span class="line">(</span><br><span class="line">    <span class="string">`branch_id`</span>     <span class="built_in">BIGINT</span>       <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'branch transaction id'</span>,</span><br><span class="line">    <span class="string">`xid`</span>           <span class="built_in">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'global transaction id'</span>,</span><br><span class="line">    <span class="string">`context`</span>       <span class="built_in">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'undo_log context,such as serialization'</span>,</span><br><span class="line">    <span class="string">`rollback_info`</span> LONGBLOB     <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'rollback info'</span>,</span><br><span class="line">    <span class="string">`log_status`</span>    <span class="built_in">INT</span>(<span class="number">11</span>)      <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'0:normal status,1:defense status'</span>,</span><br><span class="line">    <span class="string">`log_created`</span>   DATETIME(<span class="number">6</span>)  <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'create datetime'</span>,</span><br><span class="line">    <span class="string">`log_modified`</span>  DATETIME(<span class="number">6</span>)  <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'modify datetime'</span>,</span><br><span class="line">    <span class="keyword">UNIQUE</span> <span class="keyword">KEY</span> <span class="string">`ux_undo_log`</span> (<span class="string">`xid`</span>, <span class="string">`branch_id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span> = <span class="keyword">InnoDB</span></span><br><span class="line">  AUTO_INCREMENT = <span class="number">1</span></span><br><span class="line">  <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span> = utf8 <span class="keyword">COMMENT</span> =<span class="string">'AT transaction mode undo table'</span>;</span><br></pre></td></tr></table></figure></p>
<h2 id="saga模式"><a href="#saga模式" class="headerlink" title="saga模式"></a>saga模式</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- -------------------------------- The script used for sage  --------------------------------</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="string">`seata_state_machine_def`</span></span><br><span class="line">(</span><br><span class="line">    <span class="string">`id`</span>               <span class="built_in">VARCHAR</span>(<span class="number">32</span>)  <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'id'</span>,</span><br><span class="line">    <span class="string">`name`</span>             <span class="built_in">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'name'</span>,</span><br><span class="line">    <span class="string">`tenant_id`</span>        <span class="built_in">VARCHAR</span>(<span class="number">32</span>)  <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'tenant id'</span>,</span><br><span class="line">    <span class="string">`app_name`</span>         <span class="built_in">VARCHAR</span>(<span class="number">32</span>)  <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'application name'</span>,</span><br><span class="line">    <span class="string">`type`</span>             <span class="built_in">VARCHAR</span>(<span class="number">20</span>)  <span class="keyword">COMMENT</span> <span class="string">'state language type'</span>,</span><br><span class="line">    <span class="string">`comment_`</span>         <span class="built_in">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">COMMENT</span> <span class="string">'comment'</span>,</span><br><span class="line">    <span class="string">`ver`</span>              <span class="built_in">VARCHAR</span>(<span class="number">16</span>)  <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'version'</span>,</span><br><span class="line">    <span class="string">`gmt_create`</span>       DATETIME(<span class="number">3</span>)  <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'create time'</span>,</span><br><span class="line">    <span class="string">`status`</span>           <span class="built_in">VARCHAR</span>(<span class="number">2</span>)   <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'status(AC:active|IN:inactive)'</span>,</span><br><span class="line">    <span class="string">`content`</span>          <span class="built_in">TEXT</span> <span class="keyword">COMMENT</span> <span class="string">'content'</span>,</span><br><span class="line">    <span class="string">`recover_strategy`</span> <span class="built_in">VARCHAR</span>(<span class="number">16</span>) <span class="keyword">COMMENT</span> <span class="string">'transaction recover strategy(compensate|retry)'</span>,</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span> = <span class="keyword">InnoDB</span></span><br><span class="line">  <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span> = utf8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="string">`seata_state_machine_inst`</span></span><br><span class="line">(</span><br><span class="line">    <span class="string">`id`</span>                  <span class="built_in">VARCHAR</span>(<span class="number">128</span>)            <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'id'</span>,</span><br><span class="line">    <span class="string">`machine_id`</span>          <span class="built_in">VARCHAR</span>(<span class="number">32</span>)             <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'state machine definition id'</span>,</span><br><span class="line">    <span class="string">`tenant_id`</span>           <span class="built_in">VARCHAR</span>(<span class="number">32</span>)             <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'tenant id'</span>,</span><br><span class="line">    <span class="string">`parent_id`</span>           <span class="built_in">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">COMMENT</span> <span class="string">'parent id'</span>,</span><br><span class="line">    <span class="string">`gmt_started`</span>         DATETIME(<span class="number">3</span>)             <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'start time'</span>,</span><br><span class="line">    <span class="string">`business_key`</span>        <span class="built_in">VARCHAR</span>(<span class="number">48</span>) <span class="keyword">COMMENT</span> <span class="string">'business key'</span>,</span><br><span class="line">    <span class="string">`start_params`</span>        <span class="built_in">TEXT</span> <span class="keyword">COMMENT</span> <span class="string">'start parameters'</span>,</span><br><span class="line">    <span class="string">`gmt_end`</span>             DATETIME(<span class="number">3</span>) <span class="keyword">COMMENT</span> <span class="string">'end time'</span>,</span><br><span class="line">    <span class="string">`excep`</span>               <span class="built_in">BLOB</span> <span class="keyword">COMMENT</span> <span class="string">'exception'</span>,</span><br><span class="line">    <span class="string">`end_params`</span>          <span class="built_in">TEXT</span> <span class="keyword">COMMENT</span> <span class="string">'end parameters'</span>,</span><br><span class="line">    <span class="string">`status`</span>              <span class="built_in">VARCHAR</span>(<span class="number">2</span>) <span class="keyword">COMMENT</span> <span class="string">'status(SU succeed|FA failed|UN unknown|SK skipped|RU running)'</span>,</span><br><span class="line">    <span class="string">`compensation_status`</span> <span class="built_in">VARCHAR</span>(<span class="number">2</span>) <span class="keyword">COMMENT</span> <span class="string">'compensation status(SU succeed|FA failed|UN unknown|SK skipped|RU running)'</span>,</span><br><span class="line">    <span class="string">`is_running`</span>          TINYINT(<span class="number">1</span>) <span class="keyword">COMMENT</span> <span class="string">'is running(0 no|1 yes)'</span>,</span><br><span class="line">    <span class="string">`gmt_updated`</span>         DATETIME(<span class="number">3</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>),</span><br><span class="line">    <span class="keyword">UNIQUE</span> <span class="keyword">KEY</span> <span class="string">`unikey_buz_tenant`</span> (<span class="string">`business_key`</span>, <span class="string">`tenant_id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span> = <span class="keyword">InnoDB</span></span><br><span class="line">  <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span> = utf8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="string">`seata_state_inst`</span></span><br><span class="line">(</span><br><span class="line">    <span class="string">`id`</span>                       <span class="built_in">VARCHAR</span>(<span class="number">48</span>)  <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'id'</span>,</span><br><span class="line">    <span class="string">`machine_inst_id`</span>          <span class="built_in">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'state machine instance id'</span>,</span><br><span class="line">    <span class="string">`name`</span>                     <span class="built_in">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'state name'</span>,</span><br><span class="line">    <span class="string">`type`</span>                     <span class="built_in">VARCHAR</span>(<span class="number">20</span>)  <span class="keyword">COMMENT</span> <span class="string">'state type'</span>,</span><br><span class="line">    <span class="string">`service_name`</span>             <span class="built_in">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">COMMENT</span> <span class="string">'service name'</span>,</span><br><span class="line">    <span class="string">`service_method`</span>           <span class="built_in">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">COMMENT</span> <span class="string">'method name'</span>,</span><br><span class="line">    <span class="string">`service_type`</span>             <span class="built_in">VARCHAR</span>(<span class="number">16</span>) <span class="keyword">COMMENT</span> <span class="string">'service type'</span>,</span><br><span class="line">    <span class="string">`business_key`</span>             <span class="built_in">VARCHAR</span>(<span class="number">48</span>) <span class="keyword">COMMENT</span> <span class="string">'business key'</span>,</span><br><span class="line">    <span class="string">`state_id_compensated_for`</span> <span class="built_in">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">COMMENT</span> <span class="string">'state compensated for'</span>,</span><br><span class="line">    <span class="string">`state_id_retried_for`</span>     <span class="built_in">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">COMMENT</span> <span class="string">'state retried for'</span>,</span><br><span class="line">    <span class="string">`gmt_started`</span>              DATETIME(<span class="number">3</span>)  <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'start time'</span>,</span><br><span class="line">    <span class="string">`is_for_update`</span>            TINYINT(<span class="number">1</span>) <span class="keyword">COMMENT</span> <span class="string">'is service for update'</span>,</span><br><span class="line">    <span class="string">`input_params`</span>             <span class="built_in">TEXT</span> <span class="keyword">COMMENT</span> <span class="string">'input parameters'</span>,</span><br><span class="line">    <span class="string">`output_params`</span>            <span class="built_in">TEXT</span> <span class="keyword">COMMENT</span> <span class="string">'output parameters'</span>,</span><br><span class="line">    <span class="string">`status`</span>                   <span class="built_in">VARCHAR</span>(<span class="number">2</span>)   <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'status(SU succeed|FA failed|UN unknown|SK skipped|RU running)'</span>,</span><br><span class="line">    <span class="string">`excep`</span>                    <span class="built_in">BLOB</span> <span class="keyword">COMMENT</span> <span class="string">'exception'</span>,</span><br><span class="line">    <span class="string">`gmt_updated`</span>              DATETIME(<span class="number">3</span>) <span class="keyword">COMMENT</span> <span class="string">'update time'</span>,</span><br><span class="line">    <span class="string">`gmt_end`</span>                  DATETIME(<span class="number">3</span>) <span class="keyword">COMMENT</span> <span class="string">'end time'</span>,</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>, <span class="string">`machine_inst_id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span> = <span class="keyword">InnoDB</span></span><br><span class="line">  <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span> = utf8;</span><br></pre></td></tr></table></figure>
<h2 id="部署TC"><a href="#部署TC" class="headerlink" title="部署TC"></a>部署TC</h2><p>执行mysql脚本<br><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">-- -------------------------------- The script used when storeMode is 'db' --------------------------------</span><br><span class="line">-- the table to store GlobalSession data</span><br><span class="line"><span class="keyword">CREATE</span> TABLE <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="symbol">`global_table`</span></span><br><span class="line">(</span><br><span class="line">    <span class="symbol">`xid`</span>                       VARCHAR(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="symbol">`transaction_id`</span>            BIGINT,</span><br><span class="line">    <span class="symbol">`status`</span>                    TINYINT      <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="symbol">`application_id`</span>            VARCHAR(<span class="number">32</span>),</span><br><span class="line">    <span class="symbol">`transaction_service_group`</span> VARCHAR(<span class="number">32</span>),</span><br><span class="line">    <span class="symbol">`transaction_name`</span>          VARCHAR(<span class="number">128</span>),</span><br><span class="line">    <span class="symbol">`timeout`</span>                   INT,</span><br><span class="line">    <span class="symbol">`begin_time`</span>                BIGINT,</span><br><span class="line">    <span class="symbol">`application_data`</span>          VARCHAR(<span class="number">2000</span>),</span><br><span class="line">    <span class="symbol">`gmt_create`</span>                DATETIME,</span><br><span class="line">    <span class="symbol">`gmt_modified`</span>              DATETIME,</span><br><span class="line">    <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (<span class="symbol">`xid`</span>),</span><br><span class="line">    <span class="keyword">KEY</span> <span class="symbol">`idx_gmt_modified_status`</span> (<span class="symbol">`gmt_modified`</span>, <span class="symbol">`status`</span>),</span><br><span class="line">    <span class="keyword">KEY</span> <span class="symbol">`idx_transaction_id`</span> (<span class="symbol">`transaction_id`</span>)</span><br><span class="line">) ENGINE = InnoDB</span><br><span class="line">  DEFAULT CHARSET = utf8;</span><br><span class="line"></span><br><span class="line">-- the table to store BranchSession data</span><br><span class="line"><span class="keyword">CREATE</span> TABLE <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="symbol">`branch_table`</span></span><br><span class="line">(</span><br><span class="line">    <span class="symbol">`branch_id`</span>         BIGINT       <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="symbol">`xid`</span>               VARCHAR(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="symbol">`transaction_id`</span>    BIGINT,</span><br><span class="line">    <span class="symbol">`resource_group_id`</span> VARCHAR(<span class="number">32</span>),</span><br><span class="line">    <span class="symbol">`resource_id`</span>       VARCHAR(<span class="number">256</span>),</span><br><span class="line">    <span class="symbol">`branch_type`</span>       VARCHAR(<span class="number">8</span>),</span><br><span class="line">    <span class="symbol">`status`</span>            TINYINT,</span><br><span class="line">    <span class="symbol">`client_id`</span>         VARCHAR(<span class="number">64</span>),</span><br><span class="line">    <span class="symbol">`application_data`</span>  VARCHAR(<span class="number">2000</span>),</span><br><span class="line">    <span class="symbol">`gmt_create`</span>        DATETIME(<span class="number">6</span>),</span><br><span class="line">    <span class="symbol">`gmt_modified`</span>      DATETIME(<span class="number">6</span>),</span><br><span class="line">    <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (<span class="symbol">`branch_id`</span>),</span><br><span class="line">    <span class="keyword">KEY</span> <span class="symbol">`idx_xid`</span> (<span class="symbol">`xid`</span>)</span><br><span class="line">) ENGINE = InnoDB</span><br><span class="line">  DEFAULT CHARSET = utf8;</span><br><span class="line"></span><br><span class="line">-- the table to store lock data</span><br><span class="line"><span class="keyword">CREATE</span> TABLE <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="symbol">`lock_table`</span></span><br><span class="line">(</span><br><span class="line">    <span class="symbol">`row_key`</span>        VARCHAR(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="symbol">`xid`</span>            VARCHAR(<span class="number">128</span>),</span><br><span class="line">    <span class="symbol">`transaction_id`</span> BIGINT,</span><br><span class="line">    <span class="symbol">`branch_id`</span>      BIGINT       <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="symbol">`resource_id`</span>    VARCHAR(<span class="number">256</span>),</span><br><span class="line">    <span class="symbol">`table_name`</span>     VARCHAR(<span class="number">32</span>),</span><br><span class="line">    <span class="symbol">`pk`</span>             VARCHAR(<span class="number">36</span>),</span><br><span class="line">    <span class="symbol">`gmt_create`</span>     DATETIME,</span><br><span class="line">    <span class="symbol">`gmt_modified`</span>   DATETIME,</span><br><span class="line">    <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (<span class="symbol">`row_key`</span>),</span><br><span class="line">    <span class="keyword">KEY</span> <span class="symbol">`idx_branch_id`</span> (<span class="symbol">`branch_id`</span>)</span><br><span class="line">) ENGINE = InnoDB</span><br><span class="line">  DEFAULT CHARSET = utf8;</span><br></pre></td></tr></table></figure></p>
<p>如果使用源码编译的话，需要注释掉，或者idea导入插件protobuf support<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--        &lt;module&gt;seata-serializer-protobuf&lt;/module&gt;--&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>修改配置<code>registry.conf</code>、<code>file.conf</code>，如果需要不同的环境区分不同的配置，新建文件<code>registry-dev.conf</code>、<code>file-dev.conf</code>，然后启动启动类<code>io.seata.server.Server</code>，启动的jvm参数加上变量<code>-DseataEnv=uat</code>，这样就可以实现多环境启动了。</p>
<p>到server目录下，打包部署服务器:<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn clean package -Dmaven<span class="selector-class">.test</span><span class="selector-class">.skip</span>=true -Prelease-seata</span><br></pre></td></tr></table></figure></p>
<p>会生成制品，制品目录在<code>/distribution</code>，如果是部署服务器上面或者是通过docker镜像部署的话，可以参考<code>/distribution/Dockerfile</code>，或者直接通过下面的命令启动<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh ./bin/seata-server.sh -p <span class="number">8091</span> -h <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> -n <span class="number">1</span> -e uat</span><br></pre></td></tr></table></figure></p>
<p>具体参数如下</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>全写</th>
<th>作用</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>-h</td>
<td>–host</td>
<td>指定在注册中心注册的 IP</td>
<td>不指定时获取当前的 IP，外部访问部署在云环境和容器中的 server 建议指定</td>
</tr>
<tr>
<td>-p</td>
<td>–port</td>
<td>指定 server 启动的端口</td>
<td>默认为 8091</td>
</tr>
<tr>
<td>-m</td>
<td>–storeMode</td>
<td>事务日志存储方式</td>
<td>支持file,db,redis，默认为 file 注:redis需seata-server 1.3版本及以上</td>
</tr>
<tr>
<td>-n</td>
<td>–serverNode</td>
<td>用于指定seata-server节点ID</td>
<td>如 1,2,3…, 默认为 1</td>
</tr>
<tr>
<td>-e</td>
<td>–seataEnv</td>
<td>指定 seata-server 运行环境</td>
<td>如 dev, test 等, 服务启动时会使用 registry-dev.conf 这样的配置</td>
</tr>
</tbody>
</table>
<p>可以查看在我本地输出脚本的完整的jvm参数<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/Library/</span>Java<span class="regexp">/JavaVirtualMachines/</span>jdk1<span class="number">.8</span><span class="number">.0</span>_181.jdk<span class="regexp">/Contents/</span>Home<span class="regexp">/bin/</span>java -server -Xmx2048m -Xms2048m -Xmn1024m -Xss512k -<span class="string">XX:</span>SurvivorRatio=<span class="number">10</span> -<span class="string">XX:</span>MetaspaceSize=<span class="number">128</span>m -<span class="string">XX:</span>MaxMetaspaceSize=<span class="number">256</span>m -<span class="string">XX:</span>MaxDirectMemorySize=<span class="number">1024</span>m -<span class="string">XX:</span>-OmitStackTraceInFastThrow -<span class="string">XX:</span>-UseAdaptiveSizePolicy -<span class="string">XX:</span>+HeapDumpOnOutOfMemoryError -<span class="string">XX:</span>HeapDumpPath=<span class="regexp">/Users/</span>dinghuang<span class="regexp">/Documents/</span>workSpace<span class="regexp">/github/</span>seata<span class="regexp">/distribution/</span>seata-server<span class="number">-1.4</span><span class="number">.2</span><span class="regexp">/logs/</span>java_heapdump.hprof -<span class="string">XX:</span>+DisableExplicitGC -<span class="string">XX:</span>+CMSParallelRemarkEnabled -<span class="string">XX:</span>+UseCMSInitiatingOccupancyOnly -<span class="string">XX:</span>CMSInitiatingOccupancyFraction=<span class="number">75</span> -<span class="string">Xloggc:</span><span class="regexp">/Users/</span>dinghuang<span class="regexp">/Documents/</span>workSpace<span class="regexp">/github/</span>seata<span class="regexp">/distribution/</span>seata-server<span class="number">-1.4</span><span class="number">.2</span><span class="regexp">/logs/</span>seata_gc.log -<span class="string">verbose:</span>gc -Dio.netty.leakDetectionLevel=advanced -Dlogback.color.disable-<span class="keyword">for</span>-bat=<span class="literal">true</span> -classpath <span class="regexp">/Users/</span>dinghuang<span class="regexp">/Documents/</span>workSpace<span class="regexp">/github/</span>seata<span class="regexp">/distribution/</span>seata-server<span class="number">-1.4</span><span class="number">.2</span><span class="regexp">/conf:/</span>Users<span class="regexp">/dinghuang/</span>Documents<span class="regexp">/workSpace/</span>github<span class="regexp">/seata/</span>distribution<span class="regexp">/seata-server-1.4.2/</span>lib<span class="comment">/* -Dapp.name=seata-server -Dapp.pid=23748 -Dapp.repo=/Users/dinghuang/Documents/workSpace/github/seata/distribution/seata-server-1.4.2/lib -Dapp.home=/Users/dinghuang/Documents/workSpace/github/seata/distribution/seata-server-1.4.2 -Dbasedir=/Users/dinghuang/Documents/workSpace/github/seata/distribution/seata-server-1.4.2 io.seata.server.Server -e uat</span></span><br></pre></td></tr></table></figure></p>
<p>如果配置中心使用apollo，可以参考这篇文章：<a href="https://www.studying.icu/pages/94a254/#seata" target="_blank" rel="noopener">https://www.studying.icu/pages/94a254/#seata</a>  （1.4.2有bug，apollo的配置不能用，建议用1.4.1）</p>
<h1 id="Spring框架使用"><a href="#Spring框架使用" class="headerlink" title="Spring框架使用"></a>Spring框架使用</h1><p>pom.xml引入包<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/io.seata/seata-spring-boot-starter --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.seata<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>seata-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>修改application.yml配置文件（1.4.2有bug，apollo的配置不能用，建议用1.4.1）<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">seata:</span></span><br><span class="line"><span class="attr">  enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  application-id:</span> <span class="string">applicationName</span></span><br><span class="line"><span class="attr">  tx-service-group:</span> <span class="string">my_test_tx_group</span></span><br><span class="line"><span class="attr">  enable-auto-data-source-proxy:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  data-source-proxy-mode:</span> <span class="string">AT</span></span><br><span class="line"><span class="attr">  use-jdk-proxy:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">  excludes-for-auto-proxying:</span> <span class="string">firstClassNameForExclude,secondClassNameForExclude</span></span><br><span class="line"><span class="attr">  client:</span></span><br><span class="line"><span class="attr">    rm:</span></span><br><span class="line"><span class="attr">      async-commit-buffer-limit:</span> <span class="number">10000</span></span><br><span class="line"><span class="attr">      report-retry-count:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">      table-meta-check-enable:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">      report-success-enable:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">      saga-branch-register-enable:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">      saga-json-parser:</span> <span class="string">fastjson</span></span><br><span class="line"><span class="attr">      saga-retry-persist-mode-update:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">      saga-compensate-persist-mode-update:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">      lock:</span></span><br><span class="line"><span class="attr">        retry-interval:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">        retry-times:</span> <span class="number">30</span></span><br><span class="line"><span class="attr">        retry-policy-branch-rollback-on-conflict:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    tm:</span></span><br><span class="line"><span class="attr">      commit-retry-count:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">      rollback-retry-count:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">      default-global-transaction-timeout:</span> <span class="number">60000</span></span><br><span class="line"><span class="attr">      degrade-check:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">      degrade-check-period:</span> <span class="number">2000</span></span><br><span class="line"><span class="attr">      degrade-check-allow-times:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">    undo:</span></span><br><span class="line"><span class="attr">      data-validation:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      log-serialization:</span> <span class="string">jackson</span></span><br><span class="line"><span class="attr">      log-table:</span> <span class="string">undo_log</span></span><br><span class="line"><span class="attr">      only-care-update-columns:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">      compress:</span></span><br><span class="line"><span class="attr">        enable:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">        type:</span> <span class="string">zip</span></span><br><span class="line"><span class="attr">        threshold:</span> <span class="number">64</span><span class="string">k</span></span><br><span class="line"><span class="attr">    load-balance:</span></span><br><span class="line"><span class="attr">      type:</span> <span class="string">RandomLoadBalance</span></span><br><span class="line"><span class="attr">      virtual-nodes:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">  service:</span></span><br><span class="line"><span class="attr">    vgroup-mapping:</span></span><br><span class="line"><span class="attr">      my_test_tx_group:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">    grouplist:</span></span><br><span class="line"><span class="attr">      default:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8091</span></span><br><span class="line"><span class="attr">    enable-degrade:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">    disable-global-transaction:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">  transport:</span></span><br><span class="line"><span class="attr">    shutdown:</span></span><br><span class="line"><span class="attr">      wait:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">    thread-factory:</span></span><br><span class="line"><span class="attr">      boss-thread-prefix:</span> <span class="string">NettyBoss</span></span><br><span class="line"><span class="attr">      worker-thread-prefix:</span> <span class="string">NettyServerNIOWorker</span></span><br><span class="line"><span class="attr">      server-executor-thread-prefix:</span> <span class="string">NettyServerBizHandler</span></span><br><span class="line"><span class="attr">      share-boss-worker:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">      client-selector-thread-prefix:</span> <span class="string">NettyClientSelector</span></span><br><span class="line"><span class="attr">      client-selector-thread-size:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">      client-worker-thread-prefix:</span> <span class="string">NettyClientWorkerThread</span></span><br><span class="line"><span class="attr">      worker-thread-size:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">      boss-thread-size:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">    server:</span> <span class="string">NIO</span></span><br><span class="line"><span class="attr">    heartbeat:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    serialization:</span> <span class="string">seata</span></span><br><span class="line"><span class="attr">    compressor:</span> <span class="string">none</span></span><br><span class="line"><span class="attr">    enable-client-batch-send-request:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  config:</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">file</span></span><br><span class="line"><span class="attr">    consul:</span></span><br><span class="line"><span class="attr">      server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8500</span></span><br><span class="line"><span class="attr">    apollo:</span></span><br><span class="line"><span class="attr">      apollo-meta:</span> <span class="attr">http://192.168.1.204:8801</span></span><br><span class="line"><span class="attr">      app-id:</span> <span class="string">seata-server</span></span><br><span class="line"><span class="attr">      namespace:</span> <span class="string">application</span></span><br><span class="line"><span class="attr">      apollo-accesskey-secret:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">    etcd3:</span></span><br><span class="line"><span class="attr">      server-addr:</span> <span class="attr">http://localhost:2379</span></span><br><span class="line"><span class="attr">    nacos:</span></span><br><span class="line"><span class="attr">      namespace:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">      server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span></span><br><span class="line"><span class="attr">      group:</span> <span class="string">SEATA_GROUP</span></span><br><span class="line"><span class="attr">      username:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">      password:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">    zk:</span></span><br><span class="line"><span class="attr">      server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:2181</span></span><br><span class="line"><span class="attr">      session-timeout:</span> <span class="number">6000</span></span><br><span class="line"><span class="attr">      connect-timeout:</span> <span class="number">2000</span></span><br><span class="line"><span class="attr">      username:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">      password:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">    custom:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">  registry:</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">file</span></span><br><span class="line"><span class="attr">    file:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">file.conf</span></span><br><span class="line"><span class="attr">    consul:</span></span><br><span class="line"><span class="attr">      server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8500</span></span><br><span class="line"><span class="attr">      acl-token:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">    etcd3:</span></span><br><span class="line"><span class="attr">      server-addr:</span> <span class="attr">http://localhost:2379</span></span><br><span class="line"><span class="attr">    eureka:</span></span><br><span class="line"><span class="attr">      weight:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">      service-url:</span> <span class="attr">http://localhost:8761/eureka</span></span><br><span class="line"><span class="attr">    nacos:</span></span><br><span class="line"><span class="attr">      application:</span> <span class="string">seata-server</span></span><br><span class="line"><span class="attr">      server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span></span><br><span class="line">      <span class="string">group</span> <span class="string">:</span> <span class="string">"SEATA_GROUP"</span></span><br><span class="line"><span class="attr">      namespace:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">      username:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">      password:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">    redis:</span></span><br><span class="line"><span class="attr">      server-addr:</span> <span class="attr">localhost:6379</span></span><br><span class="line"><span class="attr">      db:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">      password:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">      timeout:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">    sofa:</span></span><br><span class="line"><span class="attr">      server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:9603</span></span><br><span class="line"><span class="attr">      region:</span> <span class="string">DEFAULT_ZONE</span></span><br><span class="line"><span class="attr">      datacenter:</span> <span class="string">DefaultDataCenter</span></span><br><span class="line"><span class="attr">      group:</span> <span class="string">SEATA_GROUP</span></span><br><span class="line"><span class="attr">      address-wait-time:</span> <span class="number">3000</span></span><br><span class="line"><span class="attr">      application:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">    zk:</span></span><br><span class="line"><span class="attr">      server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:2181</span></span><br><span class="line"><span class="attr">      session-timeout:</span> <span class="number">6000</span></span><br><span class="line"><span class="attr">      connect-timeout:</span> <span class="number">2000</span></span><br><span class="line"><span class="attr">      username:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">      password:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">    custom:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">  log:</span></span><br><span class="line"><span class="attr">    exception-rate:</span> <span class="number">100</span></span><br></pre></td></tr></table></figure></p>
<p>具体的例子可以看<br><a href="https://github.com/seata/seata-samples" target="_blank" rel="noopener">https://github.com/seata/seata-samples</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dinghuang.github.io/2021/03/18/DDD领域驱动设计/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="强壮的病猫">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/dinghuang.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一只病猫">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/03/18/DDD领域驱动设计/" itemprop="url">DDD领域驱动设计</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-03-18T15:47:00+08:00">
                2021-03-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JAVA/" itemprop="url" rel="index">
                    <span itemprop="name">JAVA</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2021/03/18/DDD领域驱动设计/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2021/03/18/DDD领域驱动设计/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p><a href="https://github.com/dinghuang/spring-cloud-framework/tree/master/dinghuang-framework-parent/dinghuang-framework-core" target="_blank" rel="noopener">代码地址</a></p>
</blockquote>
<h1 id="什么是DDD"><a href="#什么是DDD" class="headerlink" title="什么是DDD"></a>什么是DDD</h1><p>对于一个架构师来说，在软件开发中如何降低系统复杂度是一个永恒的挑战，无论是 94 年 GoF 的 Design Patterns ， 99 年的 Martin Fowler 的 Refactoring ， 02 年的 P of EAA ，还是 03 年的 Enterprise Integration Patterns ，都是通过一系列的设计模式或范例来降低一些常见的复杂度。</p>
<p>但是问题在于，这些书的理念是通过技术手段解决技术问题，但并没有从根本上解决业务的问题。所以 03 年 Eric Evans 的 Domain Driven Design 一书，以及后续 Vaughn Vernon 的 Implementing DDD ， Uncle Bob 的 Clean Architecture 等书，真正的从业务的角度出发，为全世界绝大部分做纯业务的开发提供了一整套的架构思路。</p>
<p>DDD 不是一套框架，而是一种架构思想，所以在代码层面缺乏了足够的约束，导致 DDD 在实际应用中上手门槛很高，甚至可以说绝大部分人都对 DDD 的理解有所偏差，所有认知的最终目的都是基于合理的代码结构、框架和约束，来降低 DDD 的实践门槛，提升代码质量、可测试性、安全性、健壮性。</p>
<h1 id="好的架构设计"><a href="#好的架构设计" class="headerlink" title="好的架构设计"></a>好的架构设计</h1><p>在做架构设计时，一个好的架构应该需要实现以下几个目标：</p>
<ul>
<li>独立于框架：架构不应该依赖某个外部的库或框架，不应该被框架的结构所束缚。</li>
<li>独立于UI：前台展示的样式可能会随时发生变化（今天可能是网页、明天可能变成console、后天是独立app），但是底层架构不应该随之而变化。</li>
<li>独立于底层数据源：无论今天你用MySQL、Oracle还是MongoDB、CouchDB，甚至使用文件系统，软件架构不应该因为不同的底层数据储存方式而产生巨大改变。</li>
<li>独立于外部依赖：无论外部依赖如何变更、升级，业务的核心逻辑不应该随之而大幅变化。<br>可测试：无论外部依赖了什么数据库、硬件、UI或者服务，业务的逻辑应该都能够快速被验证正确性。</li>
</ul>
<h1 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h1><h2 id="领域模型（DOMAIN）"><a href="#领域模型（DOMAIN）" class="headerlink" title="领域模型（DOMAIN）"></a>领域模型（DOMAIN）</h2><ul>
<li>模型是对客观世界事物的一种抽象和简化。</li>
<li>它是从某个角度反映人对客观世界事物的一种认识。</li>
<li>它用于对事物的本质进行深入细致的研究。</li>
</ul>
<p>举一个常见的例子：一个函数写了几千行，里面的if-else写了一大堆，计算各种业务规则。另一个人接手之后，分析了好几个月，才把业务逻辑彻底理清楚。从表面来看，这是代码写的不规范，要重构，把一个几千行的函数拆成一个个小的函数。从根本上来讲，就是“重要逻辑”隐藏在代码里面，没有“显性”的表达出来。这里可以引用一个观点：建模的本质就是把“重要的东西进行显性化，并进而把这些显性化的构造块，互相串联起来，组成一个体系“。</p>
<p>DDD通过建立一个业务域到软件域的通用模型，把问题空间同解决方案空间联系在一起，真正把领域的知识挖掘出来，让领域专家可以去驱动软件的实现。</p>
<p>映射概念：切分的服务。</p>
<p>领域就是范围。范围的重点是边界。领域的核心思想是将问题逐级细分来减低业务和系统的复杂度，这也是 DDD 讨论的核心。</p>
<p>如果说你要盖一栋房子，那么你需要以下的东西</p>
<p>有一块地<br>楼共有6层<br>每层有4个套房<br>那么你的领域是什么呢？</p>
<p>领域是房子么？可能，但是你应该知道，如果你把房子作为你的领域，那么你可能会忽略很多的小的需求。你设计的房子必须设计那里是让人住的。那么，一般而言的“房子”可能会让我们忽略一些细节，所以，我们应该缩小我们的领域，那就是“民房”。</p>
<p>那么，当你和建筑工人或买房子的人说起你设计的房子时，你所说的“民房”就可以很容易的被人理解了。当承包商告诉你要设计一个6层每层4套房子的时候，在语言上你是否稍微修改了一下呢？现在如果你让建筑工人到一个地方建“房子”，他们可能并没有考虑到一些“民房”的一些特性。但是如果你说了“民房”呢，他们肯定会做出合理的分析。</p>
<p>这就是我们将要说到的“通用语言”</p>
<h3 id="子域"><a href="#子域" class="headerlink" title="子域"></a>子域</h3><p>映射概念：子服务。</p>
<p>领域可以进一步划分成子领域，即子域。这是处理高度复杂领域的设计思想，它试图分离技术实现的复杂性。这个拆分的里面在很多架构里都有，比如 C4。</p>
<h3 id="核心域"><a href="#核心域" class="headerlink" title="核心域"></a>核心域</h3><p>映射概念：核心服务。</p>
<p>在领域划分过程中，会不断划分子域，子域按重要程度会被划分成三类：核心域、通用域、支撑域。</p>
<p>决定产品核心竞争力的子域就是核心域，没有太多个性化诉求。</p>
<p>桃树的例子，有根、茎、叶、花、果、种子等六个子域，不同人理解的核心域不同，比如在果园里，核心域就是果是核心域，在公园里，核心域则是花。有时为了核心域的营养供应，还会剪掉通用域和支撑域（茎、叶等）。</p>
<h3 id="通用域"><a href="#通用域" class="headerlink" title="通用域"></a>通用域</h3><p>映射概念：中间件服务或第三方服务。</p>
<p>被多个子域使用的通用功能就是通用域，没有太多企业特征，比如权限认证。</p>
<h3 id="支撑域"><a href="#支撑域" class="headerlink" title="支撑域"></a>支撑域</h3><p>映射概念：企业公共服务。</p>
<p>对于功能来讲是必须存在的，但它不对产品核心竞争力产生影响，也不包含通用功能，有企业特征，不具有通用性，比如数据代码类的数字字典系统。</p>
<h2 id="统一语言（-Ubiquitous-language-）"><a href="#统一语言（-Ubiquitous-language-）" class="headerlink" title="统一语言（ Ubiquitous language ）"></a>统一语言（ Ubiquitous language ）</h2><p>映射概念：统一概念。</p>
<p>关于统一语言必要性，有一个经典的通天塔故事，人类想建一座通天塔，进度很快，上帝害怕了，于是上帝让建造者说不通的语言，这样通天塔就再也没有能建起来了。统一语言是一件事情能顺利开展的基础。</p>
<p>由于语言上存在鸿沟，领域专家们只能模糊地描述他们想要的东西，开发人员虽然努力去理解一个自己不熟悉的领域但也只能形成模糊的认识，结果就是各说各的话，或者都是一知半解，最后到上线前才会发现漏了这个漏了那个。</p>
<p>定义上下文的含义。它的价值是可以解决交流障碍，不管你是 RD、PM、QA 等什么角色，让每个团队使用统一的语言（概念）来交流，甚至可读性更好的代码。</p>
<p>通用语言包含属于和用例场景，并且能直接反应在代码中。</p>
<p>可以在事件风暴（开会）中来统一语言，甚至是中英文的映射、业务与代码模型的映射等。可以使用一个表格来记录。</p>
<p>通用语言也并不是像，XML、Schema或Java这样的语言，它是一种自然的但经过浓缩的领域语言，它是一种开发与用户共享的语言，用来描述问题和领域模型。通用语言不是把从用户那里听到的内容翻译为开发的语言，而是为了减少误解，让用户更容易理解的草图，从而可以真正的帮助纠正错误，帮助开发获取有关的领域新知识。</p>
<p>统一语言体现在两个方面：</p>
<ul>
<li>统一的领域术语</li>
<li>领域术语通常表示对象命名，如商品、订单等，对应实体对象</li>
</ul>
<h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><p>民航业的运输统计指标为例，牵涉到与运量、运力以及周转量相关的术语，就存在 ICAO（International Civil Aviation Organization，国际民用航空组织）与IATA（International Air Transport Association，国际航空运输协会）两大体系，而中国民航局又有自己的中文解释，航空公司和各大机场亦有自己衍生的定义</p>
<p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/common/WechatIMG2.png" alt="image"></p>
<p>如果我们不明白城市对运量与航段运量的真正含义，就可能混淆这两种指标的统计计算规则。这种术语理解错误带来的缺陷往往难以发现，除非业务分析人员、开发人员与测试人员能就此知识达成一致的正确理解。</p>
<h2 id="限界上下文（-Bounded-Context-）"><a href="#限界上下文（-Bounded-Context-）" class="headerlink" title="限界上下文（ Bounded Context ）"></a>限界上下文（ Bounded Context ）</h2><p>映射概念：服务职责划分的边界。</p>
<p>限界上下文，限的意思就是划分、规定，界就是界限、或者一个边界，上下文就是业务的整个流程，总的来说，可以称限界上下文为业务流程在一个划定的界限中，我们知道，业务的描述是通过通用语言来表述的，限界上下文和通用语言的关系就是：在一个特定的限界上下文只使用一套通用语言，并且保证它的清晰性和简洁性。</p>
<p>定义上下文的边界。领域模型存在边界之内。对于同一个概念，不同上下文会有不同的理解，比如商品，在销售阶段叫商品，在运输阶段就叫货品。理论上，限界上下文的边界就是微服务的边界，因此，理解限界上下文在设计中非常重要。</p>
<p>一个有界上下文可以是一个很小的程序，包括他自己的领域，自己的代码和自己的存储机制，在一个上下文里，他们应该在逻辑上一致，每个有界上下文应该独立于其他的有界上下文。</p>
<h3 id="上下文映射图（Context-Mapping）"><a href="#上下文映射图（Context-Mapping）" class="headerlink" title="上下文映射图（Context Mapping）"></a>上下文映射图（Context Mapping）</h3><p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/common/0_Dig5eOh00vMkqOiw.jpg" alt="image"></p>
<h3 id="有界上下文例子"><a href="#有界上下文例子" class="headerlink" title="有界上下文例子"></a>有界上下文例子</h3><p>考虑一下电商系统，最初你可以认为他是一个商店上下文，但是你看的更细点，你会发现其他的上下文，例如：库存，物流，账户等。</p>
<p>合理的拆分一个大型的有界上下文可以让你的应用程序模块化，并且让你区分不同的关注点，而且让应用程序更易于管理和升级。每个有界上下文都有相应的责任和操作。合理的上下文划分可以让我们更容易的找到逻辑所在的位置，从而避免“大泥球”。</p>
<h3 id="什么是“大泥球”（BBOM，Big-ball-of-mud）"><a href="#什么是“大泥球”（BBOM，Big-ball-of-mud）" class="headerlink" title="什么是“大泥球”（BBOM，Big ball of mud）"></a>什么是“大泥球”（BBOM，Big ball of mud）</h3><p>大泥球是一个不规则的、杂乱的、松散的泥巴，这类系统是典型的高度重复，快速修复，无意义增长的系统。混乱的消息传递，在一个地方几乎所有的重要信息都是全局的和重复的，所有的系统架构都可能没有被很好的定义。</p>
<p>我们的目标是避免所有的BBOM</p>
<p>我们还来说说“民房领域”吧，我们有几个有界上下文：</p>
<ul>
<li>电力供应</li>
<li>停车位</li>
<li>套房</li>
<li>等等</li>
<li><p>详细说一下“套房”吧，套房是由不同的房间组成，每个房间又有不同的门窗。那么现在关于屋里面的窗户就有两个问题了：</p>
</li>
<li><p>问题1：你可以想象出来没有屋子的窗户么？</p>
</li>
<li>问题2：如果一个窗户没有了容纳他的屋子，那么它有没有唯一的标识？</li>
</ul>
<p>回答上面的问题会揭示出DDD中下面的概念：</p>
<ul>
<li>实体（Entity）</li>
<li>值对象(Value Object)</li>
<li>聚合和聚合根(Aggreates &amp; Aggrate root)</li>
</ul>
<h2 id="实体（-Entity-）"><a href="#实体（-Entity-）" class="headerlink" title="实体（ Entity ）"></a>实体（ Entity ）</h2><p>映射概念：Domain 或 entity。</p>
<p>许多对象不是由它们的属性来定义，而是通过一系列的连续性（continuity）和标识（identity）来从根本上定义的。只要一个对象在生命周期中能够保持连续性，并且独立于它的属性（即使这些属性对系统用户非常重要），那它就是一个实体。</p>
<p>对于实体Entity，实体核心是用唯一的标识符来定义，而不是通过属性来定义。即即使属性完全相同也可能是两个不同的对象。同时实体本身有状态的，实体又演进的生命周期，实体本身会体现出相关的业务行为，业务行为会实体属性或状态造成影响和改变。无论两个实体是多么的相似，他们都是不同的实体。</p>
<p>例如：</p>
<ul>
<li>你家的卧室</li>
<li>博客的文章</li>
<li>博客的用户</li>
</ul>
<h2 id="值对象（-Value-Objects-）"><a href="#值对象（-Value-Objects-）" class="headerlink" title="值对象（ Value Objects ）"></a>值对象（ Value Objects ）</h2><p>映射概念：Domain 或 entity。</p>
<p>当你只关心某个对象的属性时，该对象便可作为一个值对象。为其添加有意义的属性，并赋予它相应的行为。我们需要将值对象看成不变对象，不要给它任何身份标识，还应该尽量避免像实体对象一样的复杂性。</p>
<p>如果从值对象本身无状态，不可变，并且不分配具体的标识层面来看。那么值对象可以仅仅理解为实际的Entity对象的一个属性结合而已。该值对象附属在一个实际的实体对象上面。值对象本身不存在一个独立的生命周期，也一般不会产生独立的行为。</p>
<p>定义值对象的关键是值对象没有“唯一标识”。</p>
<p>比如 money，让它具有 id 显然是不合理的，你也不可能通过 id 查询一个 money。</p>
<p>定义值对象要依照具体场景的区分来看，你甚至可以把 Article 中的 Author 当成一个值对象，但一定要清楚，Author 独立存在的时候是实体，或者要拿 Author 做复杂的业务逻辑，那么 Author 也会升级为聚合根。</p>
<h2 id="防腐层（facade）"><a href="#防腐层（facade）" class="headerlink" title="防腐层（facade）"></a>防腐层（facade）</h2><p>亦称适配层。在一个上下文中，有时需要对外部上下文进行访问，通常会引入防腐层的概念来对外部上下文的访问进行一次转义。</p>
<p>有以下几种情况会考虑引入防腐层：</p>
<ul>
<li>需要将外部上下文中的模型翻译成本上下文理解的模型。</li>
<li>不同上下文之间的团队协作关系，如果是供奉者关系，建议引入防腐层，避免外部上下文变化对本上下文的侵蚀。</li>
<li>该访问本上下文使用广泛，为了避免改动影响范围过大。</li>
</ul>
<p>如果内部多个上下文对外部上下文需要访问，那么可以考虑将其放到通用上下文中。</p>
<h2 id="领域服务（-Domain-Services-）"><a href="#领域服务（-Domain-Services-）" class="headerlink" title="领域服务（ Domain Services ）"></a>领域服务（ Domain Services ）</h2><p>领域中的一些概念不太适合建模为对象，即归类到实体对象或值对象，因为它们本质上就是一些操作，一些动作，而不是事物。这些操作或动作往往会涉及到多个领域对象，并且需要协调这些领域对象共同完成这个操作或动作。如果强行将这些操作职责分配给任何一个对象，则被分配的对象就是承担一些不该承担的职责，从而会导致对象的职责不明确很混乱。但是基于类的面向对象语言规定任何属性或行为都必须放在对象里面。所以我们需要寻找一种新的模式来表示这种跨多个对象的操作，DDD认为服务是一个很自然的范式用来对应这种跨多个对象的操作，所以就有了领域服务这个模式。和领域对象不同，领域服务是以动词开头来命名的，比如资金转帐服务可以命名为MoneyTransferService。当然，你也可以把服务理解为一个对象，但这和一般意义上的对象有些区别。因为一般的领域对象都是有状态和行为的，而领域服务没有状态只有行为。需要强调的是领域服务是无状态的，它存在的意义就是协调领域对象共完成某个操作，所有的状态还是都保存在相应的领域对象中。我觉得模型（实体）与服务（场景）是对领域的一种划分，模型关注领域的个体行为，场景关注领域的群体行为，模型关注领域的静态结构，场景关注领域的动态功能。这也符合了现实中出现的各种现象，有动有静，有独立有协作。</p>
<p>领域服务还有一个很重要的功能就是可以避免领域逻辑泄露到应用层。因为如果没有领域服务，那么应用层会直接调用领域对象完成本该是属于领域服务该做的操作，这样一来，领域层可能会把一部分领域知识泄露到应用层。因为应用层需要了解每个领域对象的业务功能，具有哪些信息，以及它可能会与哪些其他领域对象交互，怎么交互等一系列领域知识。因此，引入领域服务可以有效的防治领域层的逻辑泄露到应用层。对于应用层来说，从可理解的角度来讲，通过调用领域服务提供的简单易懂但意义明确的接口肯定也要比直接操纵领域对象容易的多。</p>
<p>说到领域服务，还需要提一下软件中一般有三种服务：应用层服务、领域服务、基础服务。</p>
<h3 id="应用层服务"><a href="#应用层服务" class="headerlink" title="应用层服务"></a>应用层服务</h3><ul>
<li>获取输入（如一个XML请求）；</li>
<li>发送消息给领域层服务，要求其实现转帐的业务逻辑；</li>
<li>领域层服务处理成功，则调用基础层服务发送Email通知；</li>
</ul>
<h3 id="领域层服务"><a href="#领域层服务" class="headerlink" title="领域层服务"></a>领域层服务</h3><ul>
<li>获取源帐号和目标帐号，分别通知源帐号和目标帐号进行扣除金额和增加金额的操作；</li>
<li>提供返回结果给应用层；</li>
</ul>
<h3 id="基础层服务"><a href="#基础层服务" class="headerlink" title="基础层服务"></a>基础层服务</h3><p>按照应用层的请求，发送Email通知；</p>
<p>所以，从上面的例子中可以清晰的看出，每种服务的职责</p>
<h2 id="领域事件（-Domain-Events-）"><a href="#领域事件（-Domain-Events-）" class="headerlink" title="领域事件（ Domain Events ）"></a>领域事件（ Domain Events ）</h2><p>领域专家所关心的发生在领域中的一些事件。<br>将领域中所发生的活动建模成一系列的离散事件。每个事件都用领域对象来表示。领域事件是领域模型的组成部分，表示领域中所发生的事情。</p>
<p>一个领域事件可以理解为是发生在一个特定领域中的事件，是你希望在同一个领域中其他部分知道并产生后续动作的事件。但是并不是所有发生过的事情都可以成为领域事件。一个领域事件必须对业务有价值，有助于形成完整的业务闭环，也即一个领域事件将导致进一步的业务操作。</p>
<p>领域事件可以是业务流程的一个步骤，例如订单提交，客户付费100元，订单完工等。领域事件也可以是定时发生的事情，例如每晚对账完成。或者是一个事件发生后引发的后续动作，例如客户输错密码三次后发生锁定账户的事件。</p>
<p>如果在通用语言中存在“当a发生时，我们就需要做到b。”这样的描述，则表明a可以定义成一个领域事件。领域事件的命名一般也就是“产生事件的对象名称+完成的动作的过去式”的形式，比如：订单已经发货的事件（OrderDispatchedEvent）、订单已被收货和确认的事件（OrderConfirmedEvent）等。</p>
<h3 id="为什么需要领域事件"><a href="#为什么需要领域事件" class="headerlink" title="为什么需要领域事件"></a>为什么需要领域事件</h3><p>领域事件也是一种基于事件的架构（EDA）。事件架构的好处可以把处理的流程解耦，实现系统可扩展性，提高主业务流程的内聚性。</p>
<p>举例而言：用户提交一个订单，系统在完成订单保存后，可能还需要发送一个通知，另外可以产生一系列的后台服务的活动。如果把这一系列的动作放入一个处理过程中，会产生几个的明显问题：<br>一个是订单提交的的事务比较长，性能会有问题，甚至在极端情况下容易引发数据库的严重故障；另外订单提交的服务内聚性差，可维护性差，在业务流程发生变更时候，需要频繁修改主程序。</p>
<p>如果改为事件驱动模式，把订单提交后触发一个事件，在订单保存后，触发订单提交事件。通知和后续的各种服务动作可以通过订阅这个事件，在自己的实现空间内实现对应的逻辑，这样就把订单提交和后续其他非主要活动从订单提交业务中剥离，实现了订单提交业务高内聚和低耦合性。</p>
<p>领域事件也继承了事件的作用，当领域中发生了一些活动后，通过领域事件可以把这些活动所产生的副作用显式而不是隐式的表达出来，这种影响可以影响一个或多个聚合对象，而且可以获得更好的扩展性，对数据的锁影响也更小。</p>
<h4 id="领域事件的特点"><a href="#领域事件的特点" class="headerlink" title="领域事件的特点"></a>领域事件的特点</h4><p>首先是解决领域的聚合性问题。DDD中的聚合有一个原则是，在单个事务中，只允许对一个聚合对象进行修改，由此产生的其他改变必须在单独的事务中完成。如果一个业务跨多个聚合对象，领域事件会是一个不错的工具来解决这个问题。通过领域事件的方式可以达到各个组件之间的数据一致性，通过最终一致性取代事务一致性。</p>
<ul>
<li><p>首先是解决领域的聚合性问题。DDD中的聚合有一个原则是，在单个事务中，只允许对一个聚合对象进行修改，由此产生的其他改变必须在单独的事务中完成。如果一个业务跨多个聚合对象，领域事件会是一个不错的工具来解决这个问题。通过领域事件的方式可以达到各个组件之间的数据一致性，通过最终一致性取代事务一致性。</p>
</li>
<li><p>其次领域事件也是一种领域分析的工具，有时从领域专家的话中，我们看不出领域事件的迹象，但是业务需求依然有可能需要领域事件。动态流的事件模型加上结合DDD的聚合实体状态和BC，可以有效进行领域建模。</p>
</li>
</ul>
<p>领域事件可以通过观察者模式和订阅模式进行实现。比较常见的实现方式是事件总线（Event Bus）。</p>
<h2 id="模块（-Modules-）"><a href="#模块（-Modules-）" class="headerlink" title="模块（ Modules ）"></a>模块（ Modules ）</h2><p>模块（Module）是 DDD 中明确提到的一种控制限界上下文的手段，在我们的工程中，一般尽量用一个模块来表示一个领域的限界上下文。</p>
<p>如代码中所示，一般的工程中包的组织方式为 {com.公司名.组织架构.业务.上下文.*}，这样的组织结构能够明确地将一个上下文限定在包的内部。</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"><span class="meta-keyword">import</span> com.company.team.bussiness.counter.*;</span><span class="comment">//计数上下文</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">import</span> com.company.team.bussiness.category.*;</span><span class="comment">//分类上下文</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">import</span> com.company.team.bussiness.comment.*;</span><span class="comment">//评论上下文</span></span><br></pre></td></tr></table></figure>
<p>对于模块内的组织结构，一般情况下我们是按照领域对象、领域服务、领域资源库、防腐层等组织方式定义的。</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"><span class="meta-keyword">import</span> com.company.team.bussiness.cms.domain.valobj.*;</span><span class="comment">//领域对象-值对象</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">import</span> com.company.team.bussiness.cms.domain.entity.*;</span><span class="comment">//领域对象-实体</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">import</span> com.company.team.bussiness.cms.domain.aggregate.*;</span><span class="comment">//领域对象-聚合根</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">import</span> com.company.team.bussiness.cms.service.*;</span><span class="comment">//领域服务</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">import</span> com.company.team.bussiness.cms.repo.*;</span><span class="comment">//领域资源库</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">import</span> com.company.team.bussiness.cms.facade.*;</span><span class="comment">//领域防腐层</span></span><br></pre></td></tr></table></figure>
<h2 id="聚合（-Aggregate-）"><a href="#聚合（-Aggregate-）" class="headerlink" title="聚合（ Aggregate ）"></a>聚合（ Aggregate ）</h2><p>映射概念：包。</p>
<p>聚合，它通过定义对象之间清晰的所属关系和边界来实现领域模型的内聚，并避免了错综复杂的难以维护的对象关系网的形成。聚合定义了一组具有内聚关系的相关对象的集合，我们把聚合看作是一个修改数据的单元。</p>
<h3 id="聚合有以下一些特点："><a href="#聚合有以下一些特点：" class="headerlink" title="聚合有以下一些特点："></a>聚合有以下一些特点：</h3><ul>
<li>每个聚合有一个根和一个边界，边界定义了一个聚合内部有哪些实体或值对象，根是聚合内的某个实体；</li>
<li>聚合内部的对象之间可以相互引用，但是聚合外部如果要访问聚合内部的对象时，必须通过聚合根开始导航，绝对不能绕过聚合根直接访问聚合内的对象，也就是说聚合根是外部可以保持 对它的引用的唯一元素；</li>
<li>聚合内除根以外的其他实体的唯一标识都是本地标识，也就是只要在聚合内部保持唯一即可，因为它们总是从属于这个聚合的；</li>
<li>聚合根负责与外部其他对象打交道并维护自己内部的业务规则；</li>
<li>基于聚合的以上概念，我们可以推论出从数据库查询时的单元也是以聚合为一个单元，也就是说我们不能直接查询聚合内部的某个非根的对象；</li>
<li>聚合内部的对象可以保持对其他聚合根的引用；</li>
<li>删除一个聚合根时必须同时删除该聚合内</li>
</ul>
<h2 id="聚合根"><a href="#聚合根" class="headerlink" title="聚合根"></a>聚合根</h2><p>映射概念：包。</p>
<p>一个上下文内可能包含多个聚合，每个聚合都有一个根实体，叫做聚合根，一个聚合只有一个聚合根。</p>
<h4 id="关于如何识别聚合以及聚合根的问题："><a href="#关于如何识别聚合以及聚合根的问题：" class="headerlink" title="关于如何识别聚合以及聚合根的问题："></a>关于如何识别聚合以及聚合根的问题：</h4><p>可以先从业务的角度深入思考，然后慢慢分析出有哪些对象是：</p>
<ul>
<li>有独立存在的意义，即它是不依赖于其他对象的存在它才有意义的；</li>
<li>可以被独立访问的，还是必须通过某个其他对象导航得到的；</li>
</ul>
<h4 id="如何识别聚合"><a href="#如何识别聚合" class="headerlink" title="如何识别聚合"></a>如何识别聚合</h4><p>我觉得这个需要从业务的角度深入分析哪些对象它们的关系是内聚的，即我们会把他们看成是一个整体来考虑的；然后这些对象我们就可以把它们放在一个聚合内。所谓关系是内聚的，是指这些对象之间必须保持一个固定规则，固定规则是指在数据变化时必须保持不变的一致性规则。当我们在修改一个聚合时，我们必须在事务级别确保整个聚合内的所有对象满足这个固定规则。作为一条建议，聚合尽量不要太大，否则即便能够做到在事务级别保持聚合的业务规则完整性，也可能会带来一定的性能问题。有分析报告显示，通常在大部分领域模型中，有70%的聚合通常只有一个实体，即聚合根，该实体内部没有包含其他实体，只包含一些值对象；另外30%的聚合中，基本上也只包含两到三个实体。这意味着大部分的聚合都只是一个实体，该实体同时也是聚合根。</p>
<h4 id="如何识别聚合根"><a href="#如何识别聚合根" class="headerlink" title="如何识别聚合根"></a>如何识别聚合根</h4><p>如果一个聚合只有一个实体，那么这个实体就是聚合根；如果有多个实体，那么我们可以思考聚合内哪个对象有独立存在的意义并且可以和外部直接进行交互。</p>
<p>上面给出的例子中：</p>
<p>房子、订单和问题是聚合根<br>窗户、订单备注和问题详情是聚合<br>当数据改变时，所有相关的对象被看作一个整体。</p>
<p>所有的外部数据访问都需要通过同一个根节点进入，这个根就是根节点</p>
<h2 id="资源库（-Repository-）"><a href="#资源库（-Repository-）" class="headerlink" title="资源库（ Repository ）"></a>资源库（ Repository ）</h2><ul>
<li>仓储被设计出来的目的是基于这个原因：领域模型中的对象自从被创建出来后不会一直留在内存中活动的，当它不活动时会被持久化到数据库中，然后当需要的时候我们会重建该对象；重建对象就是根据数据库中已存储的对象的状态重新创建对象的过程；所以，可见重建对象是一个和数据库打交道的过程。从更广义的角度来理解，我们经常会像集合一样从某个类似集合的地方根据某个条件获取一个或一些对象，往集合中添加对象或移除对象。也就是说，我们需要提供一种机制，可以提供类似集合的接口来帮助我们管理对象。仓储就是基于这样的思想被设计出来的；</li>
<li>仓储里面存放的对象一定是聚合，原因是之前提到的领域模型中是以聚合的概念去划分边界的；聚合是我们更新对象的一个边界，事实上我们把整个聚合看成是一个整体概念，要么一起被取出来，要么一起被删除。我们永远不会单独对某个聚合内的子对象进行单独查询或做更新操作。因此，我们只对聚合设计仓储。</li>
<li>仓储还有一个重要的特征就是分为仓储定义部分和仓储实现部分，在领域模型中我们定义仓储的接口，而在基础设施层实现具体的仓储。这样做的原因是：由于仓储背后的实现都是在和数据库打交道，但是我们又不希望客户（如应用层）把重点放在如何从数据库获取数据的问题上，因为这样做会导致客户（应用层）代码很混乱，很可能会因此而忽略了领域模型的存在。所以我们需要提供一个简单明了的接口，供客户使用，确保客户能以最简单的方式获取领域对象，从而可以让它专心的不会被什么数据访问代码打扰的情况下协调领域对象完成业务逻辑。这种通过接口来隔离封装变化的做法其实很常见。由于客户面对的是抽象的接口并不是具体的实现，所以我们可以随时替换仓储的真实实现，这很有助于我们做单元测试。</li>
<li>尽管仓储可以像集合一样在内存中管理对象，但是仓储一般不负责事务处理。一般事务处理会交给一个叫“工作单元（Unit Of Work）”的东西。关于工作单元的详细信息我在下面的讨论中会讲到。</li>
<li>另外，仓储在设计查询接口时，可能还会用到规格模式（Specification Pattern），我见过的最厉害的规格模式应该就是LINQ以及DLINQ查询了。一般我们会根据项目中查询的灵活度要求来选择适合的仓储查询接口设计。通常情况下只需要定义简单明了的具有固定查询参数的查询接口就可以了。只有是在查询条件是动态指定的情况下才可能需要用到Specification等模式。</li>
</ul>
<p>领域对象需要资源存储，资源库可以理解成 DAO，但它比 DAO 更宽泛，存储的手段可以是多样化的，常见的无非是数据库、分布式缓存、本地缓存等。资源库（Repository）的作用，就是对领域的存储和访问进行统一管理的对象。</p>
<p>在系统中，我们是通过如下的方式组织资源库的。</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"><span class="meta-keyword">import</span> com.company.team.bussiness.repo.dao.ArticleDao;</span><span class="comment">//数据库访问对象-文章</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">import</span> com.company.team.bussiness.repo.dao.CommentDao;</span><span class="comment">//数据库访问对象-评论</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">import</span> com.company.team.bussiness.repo.dao.po.ArticlePO;</span><span class="comment">//数据库持久化对象-文章</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">import</span> com.company.team.bussiness.repo.dao.po.CommentPO;</span><span class="comment">//数据库持久化对象-评论</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">import</span> com.company.team.bussiness.repo.cache.ArticleObj;</span><span class="comment">//分布式缓存访问对象-文章缓存访问</span></span><br></pre></td></tr></table></figure>
<p>资源库对外的整体访问由 Repository 提供，它聚合了各个资源库的数据信息，同时也承担了资源存储的逻辑（例如缓存更新机制等）。</p>
<h1 id="四种-Domain-模式"><a href="#四种-Domain-模式" class="headerlink" title="四种 Domain 模式"></a>四种 Domain 模式</h1><p>除了晦涩难懂的概念外，让我们最难接受的可能就是模型的运用了，Spring 思想中，Domain 只是数据的载体，所有行为都在 Service 中使用 Domain 封装后流转，而 OOP 讲究一对象维度来执行业务，所以，DDD 中的对象是用行为的（理解这点非常重要哦）。</p>
<p>这里我为你总结了全部的四种领域模式，供你区分和理解：</p>
<ul>
<li>失血模型</li>
<li>贫血模型</li>
<li>充血模型</li>
<li>胀血模型</li>
</ul>
<h2 id="失血模型"><a href="#失血模型" class="headerlink" title="失血模型"></a>失血模型</h2><p>Domain Object 只有属性的 getter/setter 方法的纯数据类，所有的业务逻辑完全由 business object 来完成。</p>
<h2 id="贫血模型"><a href="#贫血模型" class="headerlink" title="贫血模型"></a>贫血模型</h2><p>简单来说，就是 Domain Object 包含了不依赖于持久化的领域逻辑，而那些依赖持久化的领域逻辑被分离到 Service 层。</p>
<p>意这个模式不在 Domain 层里依赖 DAO。持久化的工作还需要在 DAO 或者 Service 中进行。</p>
<p>这样做的优缺点</p>
<p>优点：各层单向依赖，结构清晰。</p>
<p>缺点：</p>
<ul>
<li>Domain Object 的部分比较紧密依赖的持久化 Domain Logic 被分离到 Service 层，显得不够 OO</li>
<li>Service 层过于厚重</li>
</ul>
<h2 id="充血模型"><a href="#充血模型" class="headerlink" title="充血模型"></a>充血模型</h2><p>充血模型和第二种模型差不多，区别在于业务逻辑划分，将绝大多数业务逻辑放到 Domain 中，Service 是很薄的一层，封装少量业务逻辑，并且不和 DAO 打交道：</p>
<blockquote>
<p>Service (事务封装) —&gt; Domain Object &lt;—&gt; DAO</p>
</blockquote>
<p>所有业务逻辑都在 Domain 中，事务管理也在 Item 中实现。这样做的优缺点如下。</p>
<p>优点：</p>
<ul>
<li>更加符合 OO 的原则；</li>
<li><p>Service 层很薄，只充当 Facade 的角色，不和 DAO 打交道。<br>缺点：</p>
</li>
<li><p>DAO 和 Domain Object 形成了双向依赖，复杂的双向依赖会导致很多潜在的问题。</p>
</li>
<li>如何划分 Service 层逻辑和 Domain 层逻辑是非常含混的，在实际项目中，由于设计和开发人员的水平差异，可能 导致整个结构的混乱无序。</li>
</ul>
<h2 id="充血模型-1"><a href="#充血模型-1" class="headerlink" title="充血模型"></a>充血模型</h2><p>基于充血模型的第三个缺点，干脆取消 Service 层，只剩下 Domain Object 和 DAO 两层，在 Domain Object 的 Domain Logic 上面封装事务。</p>
<blockquote>
<p>Domain Object (事务封装，业务逻辑) &lt;—&gt; DAO</p>
</blockquote>
<p>似乎 Ruby on rails 就是这种模型，它甚至把 Domain Object 和 DAO 都合并了。</p>
<p>这样做的优缺点：</p>
<ul>
<li>简化了分层</li>
<li>也算符合 OO</li>
</ul>
<p>该模型缺点：</p>
<ul>
<li>很多不是 Domain Logic 的 Service 逻辑也被强行放入 Domain Object ，引起了 Domain Object 模型的不稳定；</li>
<li>Domain Object 暴露给 Web 层过多的信息，可能引起意想不到的副作用。</li>
</ul>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/common/v2-32711c0238ff0ee8a15af95faf13c2c9_1440w.jpg" alt="image"></p>
<h1 id="DDD分层架构"><a href="#DDD分层架构" class="headerlink" title="DDD分层架构"></a>DDD分层架构</h1><p>优点：</p>
<ul>
<li>开发人员可以只关注整个结构中的某一层。</li>
<li>可以很容易的用新的实现来替换原有层次的实现。</li>
<li>可以降低层与层之间的依赖。</li>
<li>有利于标准化。</li>
<li>利于各层逻辑的复用。<br>缺点：</li>
<li>降低了系统的性能。这是显然的，因为增加了中间层，不过可以通过缓存机制来改善。</li>
<li>可能会导致级联的修改。这种修改尤其体现在自上而下的方向，不过可以通过依赖倒置来改善。</li>
</ul>
<h2 id="四层架构"><a href="#四层架构" class="headerlink" title="四层架构"></a>四层架构</h2><p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/common/WechatIMG9.png" alt="image"></p>
<ul>
<li>User Interface为用户界面层（或表示层），负责向用户显示信息和解释用户命令。这里指的用户可以是另一个计算机系统，不一定是使用用户界面的人。</li>
<li>Application为应用层，定义软件要完成的任务，并且指挥表达领域概念的对象来解决问题。这一层所负责的工作对业务来说意义重大，也是与其它系统的应用层进行交互的必要渠道。应用层要尽量简单，不包含业务规则或者知识，而只为下一层中的领域对象协调任务，分配工作，使它们互相协作。它没有反映业务情况的状态，但是却可以具有另外一种状态，为用户或程序显示某个任务的进度。</li>
<li>Domain为领域层（或模型层），负责表达业务概念，业务状态信息以及业务规则。尽管保存业务状态的技术细节是由基础设施层实现的，但是反映业务情况的状态是由本层控制并且使用的。领域层是业务软件的核心，领域模型位于这一层。</li>
<li>Infrastructure层为基础实施层，向其他层提供通用的技术能力：为应用层传递消息，为领域层提供持久化机制，为用户界面层绘制屏幕组件，等等。基础设施层还能够通过架构框架来支持四个层次间的交互模式。<br>传统的四层架构都是限定型松散分层架构，即Infrastructure层的任意上层都可以访问该层（“L”型），而其它层遵守严格分层架构</li>
</ul>
<p>在四层架构模式的实践中，对于分层的本地化定义主要为：</p>
<ul>
<li>User Interface层主要是Restful消息处理，配置文件解析，等等。</li>
<li>Application层主要是多进程管理及调度，多线程管理及调度，多协程调度和状态机管理，等等。</li>
<li>Domain层主要是领域模型的实现，包括领域对象的确立，这些对象的生命周期管理及关系，领域服务的定义，领域事件的发布，等等。</li>
<li>Infrastructure层主要是业务平台，编程框架，第三方库的封装，基础算法，等等。</li>
</ul>
<blockquote>
<p>严格意义上来说，User Interface指的是用户界面，Restful消息和配置文件解析等处理应该放在Application层，User Interface层没有的话就空缺。但User Interface也可以理解为用户接口，所以将Restful消息和配置文件解析等处理放在User Interface层也行。</p>
</blockquote>
<h2 id="五层架构"><a href="#五层架构" class="headerlink" title="五层架构"></a>五层架构</h2><p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/common/WechatIMG10.png" alt="image"></p>
<ul>
<li>User Interface是用户接口层，主要用于处理用户发送的Restful请求和解析用户输入的配置文件等，并将信息传递给Application层的接口。</li>
<li>Application层是应用层，负责多进程管理及调度、多线程管理及调度、多协程调度和维护业务实例的状态模型。当调度层收到用户接口层的请求后，委托Context层与本次业务相关的上下文进行处理。</li>
<li>Context是环境层，以上下文为单位，将Domain层的领域对象cast成合适的role，让role交互起来完成业务逻辑。</li>
<li>Domain层是领域层，定义领域模型，不仅包括领域对象及其之间关系的建模，还包括对象的角色role的显式建模。</li>
<li>Infrastructure层是基础实施层，为其他层提供通用的技术能力：业务平台，编程框架，持久化机制，消息机制，第三方库的封装，通用算法，等等。</li>
</ul>
<p>很多DDD落地实践，都是面向控制面或管理面且消息交互比较多的系统。这类系统的一次业务，包含一组同步消息或异步消息构成的序列，如果都放在Context层，会导致该层的代码比较复杂，于是我们考虑：</p>
<ul>
<li>Context层在面向控制面或管理面且消息交互比较多的系统中又分裂成两层，即Context层和大Context层。</li>
<li>Context层处理单位为Action，对应一条同步消息或异步消息。</li>
<li>大Context层对应一个事务处理，由一个Action序列组成，一般通过Transaction DSL实现，所以我们习惯把大Context层叫做Transaction DSL层。</li>
<li>Application层在面向控制面或管理面且消息交互比较多的系统中经常会做一些调度相关的工作，所以我们习惯把Application层叫做Scheduler层。</li>
</ul>
<p>因此，在面向控制面或管理面且消息交互比较多的系统中，DDD分层架构模式就变成了六层，<br><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/common/WechatIMG11.png" alt="image"></p>
<p>在实践中，将这六层的本地化定义为：</p>
<ul>
<li>User Interface是用户接口层，主要用于处理用户发送的Restful请求和解析用户输入的配置文件等，并将信息传递给Scheduler层的接口。</li>
<li>Scheduler是调度层，负责多进程管理及调度、多线程管理及调度、多协程调度和维护业务实例的状态模型。当调度层收到用户接口层的请求后，委托Transaction层与本次操作相关的事务进行处理。</li>
<li>Transaction是事务层，对应一个业务流程，比如UE Attach，将多个同步消息或异步消息的处理序列组合成一个事务，而且在大多场景下，都有选择结构。万一事务执行失败，则立即进行回滚。当事务层收到调度层的请求后，委托Context层的Action进行处理，常常还伴随使用Context层的Specification（谓词）进行Action的选择。</li>
<li>Context是环境层，以Action为单位，处理一条同步消息或异步消息，将Domain层的领域对象cast成合适的role，让role交互起来完成业务逻辑。环境层通常也包括Specification的实现，即通过Domain层的知识去完成一个条件判断。</li>
<li>Domain层是领域层，定义领域模型，不仅包括领域对象及其之间关系的建模，还包括对象的角色role的显式建模。</li>
<li>Infrastructure层是基础实施层，为其他层提供通用的技术能力：业务平台，编程框架，持久化机制，消息机制，第三方库的封装，通用算法，等等。</li>
</ul>
<p>事务层的核心是事务模型，事务模型的框架代码一般放在基础设施层。</p>
<p>综上所述，DDD六层架构可以看做是DDD五层架构在特定领域的变体，我们统称为DDD五层架构，而DDD五层架构与传统的四层架构类似，都是限定型松散分层架构。</p>
<h2 id="六边形架构"><a href="#六边形架构" class="headerlink" title="六边形架构"></a>六边形架构</h2><p>有一种方法可以改进分层架构，即依赖倒置原则(Dependency Inversion Principle, DIP)，它通过改变不同层之间的依赖关系达到改进目的。</p>
<blockquote>
<p>依赖倒置原则由Robert C. Martin提出，正式定义为：<br>高层模块不应该依赖于底层模块，两者都应该依赖于抽象。<br>抽象不应该依赖于细节，细节应该依赖于抽象。</p>
</blockquote>
<p>根据该定义，DDD分层架构中的低层组件应该依赖于高层组件提供的接口，即无论高层还是低层都依赖于抽象，整个分层架构好像被推平了。如果我们把分层架构推平，再向其中加入一些对称性，就会出现一种具有对称性特征的架构风格，即六边形架构。六边形架构是Alistair Cockburn在2005年提出的，在这种架构中，不同的客户通过“平等”的方式与系统交互。需要新的客户吗？不是问题。只需要添加一个新的适配器将客户输入转化成能被系统API所理解的参数就行。同时，对于每种特定的输出，都有一个新建的适配器负责完成相应的转化功能。</p>
<p>六边形架构也称为端口与适配器，如下图所示：<br><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/common/8906859-c7a0c865b8217865.png" alt="image"></p>
<p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/common/8906859-27500c1a61ca00ec.png" alt="image"></p>
<p>六边形每条不同的边代表了不同类型的端口，端口要么处理输入，要么处理输出。对于每种外界类型，都有一个适配器与之对应，外界通过应用层API与内部进行交互。上图中有3个客户请求均抵达相同的输入端口（适配器A、B和C），另一个客户请求使用了适配器D。假设前3个请求使用了HTTP协议（浏览器、REST和SOAP等），而后一个请求使用了AMQP协议（比如RabbitMQ）。端口并没有明确的定义，它是一个非常灵活的概念。无论采用哪种方式对端口进行划分，当客户请求到达时，都应该有相应的适配器对输入进行转化，然后端口将调用应用程序的某个操作或者向应用程序发送一个事件，控制权由此交给内部区域。<br>应用程序通过公共API接收客户请求，使用领域模型来处理请求。我们可以将DDD战术设计的建模元素Repository的实现看作是持久化适配器，该适配器用于访问先前存储的聚合实例或者保存新的聚合实例。正如图中的适配器E、F和G所展示的，我们可以通过不同的方式实现资源库，比如关系型数据库、基于文档的存储、分布式缓存或内存存储等。如果应用程序向外界发送领域事件消息，我们将使用适配器H进行处理。该适配器处理消息输出，而上面提到的处理AMQP消息的适配器则是处理消息输入的，因此应该使用不同的端口。</p>
<p>我们在实际的项目开发中，不同层的组件可以同时开发。当一个组件的功能明确后，就可以立即启动开发。由于该组件的用户有多个，并且这些用户的侧重点不同，所以需要提供多个不同的接口。同时，这些用户的认识也是不断深入的，可能会多次重构相关的接口。于是，组件的多个用户经常会找组件的开发者讨论这些问题，无形中降低了组件的开发效率。<br>我们换一种方式，组件的开发者在明确了组件的功能后就专注于功能的开发，确保功能稳定和高效。组件的用户自己定义组件的接口（端口），然后基于接口写测试，并不断演进接口。在跨层集成测试时，由组件开发者或用户再开发一个适配器就可以了。</p>
<h3 id="六边形架构模式的演变"><a href="#六边形架构模式的演变" class="headerlink" title="六边形架构模式的演变"></a>六边形架构模式的演变</h3><p>尽管六边形架构模式已经很好，但是没有最好只有更好，演变没有尽头。在六边形架构模式提出后的这些年，又依次衍生出三种六边形架构模式的变体，感兴趣的读者可以点击链接自行学习：</p>
<ul>
<li>Jeffrey Palermo在2008年提出了洋葱架构，六边形架构是洋葱架构的一个超集。</li>
<li>Robert C. Martin在2012年提出了干净架构（Clean Architecture），这是六边形架构的一个变体。</li>
<li>Russ Miles在2013年提出了Life Preserver设计，这是一种基于六边形架构的设计。</li>
</ul>
<h1 id="DDD实践"><a href="#DDD实践" class="headerlink" title="DDD实践"></a>DDD实践</h1><p>假如你是一个团队 Leader 或者架构师，当你接手一个旧系统维护及重构的任务时，你该如何改造呢？是否觉得哪里都不对但由于业务认知的不熟悉而无从下手呢？</p>
<ul>
<li>通过公共平台大概梳理出系统之间的调用关系（一般中等以上公司都具备 RPC 和 HTTP 调用关系，无脑的挨个系统查询即可），画出来的可能会很乱，也可能会比较清晰，但这就是现状。</li>
<li>分配组员每个人认领几个项目，来梳理项目维度关系，这些关系包括：对外接口、交互、用例、MQ 等的详细说明。个别核心系统可以画出内部实体或者聚合根。</li>
<li>小组开会，挨个 review 每个系统的业务概念，达到组内统一语言。</li>
<li>根据以上资料，即可看出哪些不合理的调用关系（比如循环调用、不规范的调用等），甚至不合理的分层。</li>
<li>根据主线业务自顶向下细分领域，以及限界上下文。此过程可能会颠覆之前的系统划分。</li>
<li>根据业务复杂性，指定领域模型，选择贫血或者充血模型。团队内部最好实行统一习惯，以免出现交接成本过大。</li>
<li>分工进行开发，并设置 deadline，注意，不要单一的设置一个 deadline，要设置中间 check 时间，比如 dealline 是 1 月 20 日，还要设置两个 check 时间，分别沟通代码风格及边界职责，以免 deadline 时延期。</li>
</ul>
<h3 id="事件风暴（Event-Storming）"><a href="#事件风暴（Event-Storming）" class="headerlink" title="事件风暴（Event Storming）"></a>事件风暴（Event Storming）</h3><p>事件风暴也被称为事件建模，形式有点类似于头脑风暴的方法,通过事件风暴的方法可以快速分析复杂业务领域，完成领域建模的目标。</p>
<p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/common/WechatIMG3.png" alt="image"></p>
<blockquote>
<p>事件风暴是一项团队活动，旨在通过领域事件识别出聚合根，进而划分微服务的限界上下文。在活动中，团队先通过头脑风暴的形式罗列出领域中所有的领域事件，整合之后形成最终的领域事件集合，然后对于每一个事件，标注出导致该事件的命令（Command），再然后为每个事件标注出命令发起方的角色，命令可以是用户发起，也可以是第三方系统调用或者是定时器触发等。最后对事件进行分类整理出聚合根以及限界上下文。</p>
</blockquote>
<p>事件风暴方法通常有以下几个步骤：</p>
<ul>
<li>邀请合适的人参加</li>
<li>提供无限制的建模空间</li>
<li>发掘领域事件，可使用橙色贴纸标识</li>
<li>发掘领域事件的来源，探询命令，可使用蓝色贴纸标识。多种来源也可以- 考虑用不同颜色来区分，例如用黄色表示角色，粉色表示外部系统，红色表示时间触发。</li>
<li>寻找聚合，可用绿色贴纸标识</li>
<li>持续探索，发掘子域，BC，用户角色，验收测试标准，补充信息等。</li>
</ul>
<p>事件风暴的步骤可以如下图所示：<br><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/common/WechatIMG4.png" alt="image"></p>
<p>在我们的一次产品的重构活动中也采用了事件风暴方法。系统代码维护了10几年，代码中存在大量的“坏味道”：重复代码，过长函数，过大的类，过长的参数列表，发散式变化，霰弹式修改，镀金问题，注释不清等问题。实际研发过程中也是经常出现一点改动都可能会引起不可预测的结果，重构势在必行。</p>
<p>但是在重构过程中，也没有人可以说清楚现有系统的逻辑，如何重构成为了一个难题。重构过程我们引入了咨询公司给我们的方法，采用了事件风暴的办法，通过对领域中所发生的事情（也就是领域事件）来探索这个领域，并且使用便签来描述领域中的事件，这些便签会沿着时间轴贴到一个很大的建模面板上。</p>
<p>举例来说，能够引发事件的事情包括用户行为、外部系统所发生的事情以及时间的流逝。事件也有助于找到领域的边界，对术语的不同阐述可能就意味着存在边界。</p>
<p>准备工作，四色贴纸：</p>
<ul>
<li>橙色：事件，某个动作的结果，以“XX已XX”的方式表示，比如“用户信息已查询”</li>
<li>蓝色：属性，事件相关的输入、输出数据等</li>
<li>黄色：命令，某个动作，比如“查找用户信息”</li>
<li>绿色：实体，命令的触发者</li>
<li>开始梳理业务，将结果贴到白版上</li>
<li>继续深入梳理，将整个过程的模型、关键数据等梳理出来，贴在白板上<br>确定重构指导思路，执行重构动作，重构的同时引入单元测试保障重构的质量</li>
</ul>
<h1 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h1><p>我们先看一个简单的例子，这个 case 的业务逻辑如下：</p>
<blockquote>
<p>一个新应用在全国通过 地推业务员 做推广，需要做一个用户注册系统，同时希望在用户注册后能够通过用户电话（先假设仅限座机）的地域（区号）对业务员发奖金。</p>
</blockquote>
<p>先不要去纠结这个根据用户电话去发奖金的业务逻辑是否合理，也先不要去管用户是否应该在注册时和业务员做绑定，这里我们看的主要还是如何更加合理的去实现这个逻辑。一个简单的用户和用户注册的代码实现如下：</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    Long userId;</span><br><span class="line">    <span class="keyword">String</span> name;</span><br><span class="line">    <span class="keyword">String</span> phone;</span><br><span class="line">    <span class="keyword">String</span> address;</span><br><span class="line">    Long repId;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RegistrationServiceImpl</span> <span class="keyword"><span class="keyword">implements</span> <span class="type">RegistrationService</span></span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> SalesRepRepository salesRepRepo;</span><br><span class="line">    <span class="keyword">private</span> UserRepository userRepo;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> User register(<span class="keyword">String</span> name, <span class="keyword">String</span> phone, <span class="keyword">String</span> address) </span><br><span class="line">      throws ValidationException &#123;</span><br><span class="line">        <span class="comment">// 校验逻辑</span></span><br><span class="line">        <span class="keyword">if</span> (name == <span class="literal">null</span> || name.length() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">ValidationException</span>(<span class="string">"name"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (phone == <span class="literal">null</span> || !isValidPhoneNumber(phone)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">ValidationException</span>(<span class="string">"phone"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 此处省略address的校验逻辑</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 取电话号里的区号，然后通过区号找到区域内的SalesRep</span></span><br><span class="line">        <span class="keyword">String</span> areaCode = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">String</span>[] areas = <span class="keyword">new</span> <span class="type">String</span>[]&#123;<span class="string">"0571"</span>, <span class="string">"021"</span>, <span class="string">"010"</span>&#125;;</span><br><span class="line">        <span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt; phone.length(); i++) &#123;</span><br><span class="line">            <span class="keyword">String</span> prefix = phone.substring(<span class="number">0</span>, i);</span><br><span class="line">            <span class="keyword">if</span> (Arrays.asList(areas).contains(prefix)) &#123;</span><br><span class="line">                areaCode = prefix;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        SalesRep rep = salesRepRepo.findRep(areaCode);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 最后创建用户，落盘，然后返回</span></span><br><span class="line">        User user = <span class="keyword">new</span> <span class="type">User</span>();</span><br><span class="line">        user.name = name;</span><br><span class="line">        user.phone = phone;</span><br><span class="line">        user.address = address;</span><br><span class="line">        <span class="keyword">if</span> (rep != <span class="literal">null</span>) &#123;</span><br><span class="line">            user.repId = rep.repId;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> userRepo.save(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> boolean isValidPhoneNumber(<span class="keyword">String</span> phone) &#123;</span><br><span class="line">        <span class="keyword">String</span> pattern = <span class="string">"^0[1-9]&#123;2,3&#125;-?\\d&#123;8&#125;$"</span>;</span><br><span class="line">        <span class="keyword">return</span> phone.matches(pattern);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们日常绝大部分代码和模型其实都跟这个是类似的，乍一看貌似没啥问题，但我们再深入一步，从以下四个维度去分析一下：接口的清晰度（可阅读性）、数据验证和错误处理、业务逻辑代码的清晰度、和可测试性。</p>
<h2 id="问题1-接口的清晰度"><a href="#问题1-接口的清晰度" class="headerlink" title="问题1 - 接口的清晰度"></a>问题1 - 接口的清晰度</h2><p>在Java代码中，对于一个方法来说所有的参数名在编译时丢失，留下的仅仅是一个参数类型的列表，所以我们重新看一下以上的接口定义，其实在运行时仅仅是：</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">User</span> <span class="title">register</span>(<span class="keyword">String</span>, <span class="keyword">String</span>, <span class="keyword">String</span>);</span><br></pre></td></tr></table></figure>
<p>所以以下的代码是一段编译器完全不会报错的，很难通过看代码就能发现的 bug ：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service.<span class="keyword">register</span>(<span class="string">"殷浩"</span>, <span class="string">"浙江省杭州市余杭区文三西路969号"</span>, <span class="string">"0571-12345678"</span>);</span><br></pre></td></tr></table></figure>
<p>当然，在真实代码中运行时会报错，但这种 bug 是在运行时被发现的，而不是在编译时。普通的 Code Review 也很难发现这种问题，很有可能是代码上线后才会被暴露出来。这里的思考是，有没有办法在编码时就避免这种可能会出现的问题？</p>
<p>另外一种常见的，特别是在查询服务中容易出现的例子如下：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">User findByName(String name);</span><br><span class="line">User findByPhone(String phone);</span><br><span class="line">User findByNameAndPhone(String name, String phone);</span><br></pre></td></tr></table></figure>
<p>在这个场景下，由于入参都是 String 类型，不得不在方法名上面加上 ByXXX 来区分，而 findByNameAndPhone 同样也会陷入前面的入参顺序错误的问题，而且和前面的入参不同，这里参数顺序如果输错了，方法不会报错只会返回 null，而这种 bug 更加难被发现。这里的思考是，有没有办法让方法入参一目了然，避免入参错误导致的 bug ？</p>
<h2 id="问题2-数据验证和错误处理"><a href="#问题2-数据验证和错误处理" class="headerlink" title="问题2 - 数据验证和错误处理"></a>问题2 - 数据验证和错误处理</h2><p>在前面这段数据校验代码：<br><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (phone == <span class="literal">null</span> || !isValidPhoneNumber(phone)) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">ValidationException</span>(<span class="string">"phone"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在日常编码中经常会出现，一般来说这种代码需要出现在方法的最前端，确保能够 fail-fast 。但是假设你有多个类似的接口和类似的入参，在每个方法里这段逻辑会被重复。而更严重的是如果未来我们要拓展电话号去包含手机时，很可能需要加入以下代码：</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (phone == <span class="literal">null</span> || !isValidPhoneNumber(phone) || !isValidCellNumber(phone)) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">ValidationException</span>(<span class="string">"phone"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果你有很多个地方用到了 phone 这个入参，但是有个地方忘记修改了，会造成 bug 。这是一个 DRY 原则被违背时经常会发生的问题。</p>
<p>如果有个新的需求，需要把入参错误的原因返回，那么这段代码就变得更加复杂：</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (phone == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">ValidationException</span>(<span class="string">"phone不能为空"</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!isValidPhoneNumber(phone)) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">ValidationException</span>(<span class="string">"phone格式错误"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以想像得到，代码里充斥着大量的类似代码块时，维护成本要有多高。</p>
<p>最后，在这个业务方法里，会（隐性或显性的）抛 ValidationException，所以需要外部调用方去try/catch，而业务逻辑异常和数据校验异常被混在了一起，是否是合理的？</p>
<p>在传统Java架构里有几个办法能够去解决一部分问题，常见的如BeanValidation注解或ValidationUtils类，比如：<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Use Bean Validation</span></span><br><span class="line"><span class="selector-tag">User</span> <span class="selector-tag">registerWithBeanValidation</span>(</span><br><span class="line">  <span class="variable">@NotNull</span> <span class="variable">@NotBlank</span> String name,</span><br><span class="line">  <span class="variable">@NotNull</span> <span class="variable">@Pattern</span>(regexp = <span class="string">"^0?[1-9]&#123;2,3&#125;-?\\d&#123;8&#125;$"</span>) String phone,</span><br><span class="line">  <span class="variable">@NotNull</span> String address</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Use ValidationUtils:</span></span><br><span class="line"><span class="selector-tag">public</span> <span class="selector-tag">User</span> <span class="selector-tag">registerWithUtils</span>(String name, String phone, String address) &#123;</span><br><span class="line">    <span class="selector-tag">ValidationUtils</span><span class="selector-class">.validateName</span>(name); <span class="comment">// throws ValidationException</span></span><br><span class="line">    <span class="selector-tag">ValidationUtils</span><span class="selector-class">.validatePhone</span>(phone);</span><br><span class="line">    <span class="selector-tag">ValidationUtils</span><span class="selector-class">.validateAddress</span>(address);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>但这几个传统的方法同样有问题，</p>
<p>BeanValidation：</p>
<ul>
<li>通常只能解决简单的校验逻辑，复杂的校验逻辑一样要写代码实现定制校验器</li>
<li>在添加了新校验逻辑时，同样会出现在某些地方忘记添加一个注解的情况，DRY原则还是会被违背</li>
</ul>
<p>ValidationUtils类：</p>
<ul>
<li>当大量的校验逻辑集中在一个类里之后，违背了Single Responsibility单一性原则，导致代码混乱和不可维护</li>
<li>业务异常和校验异常还是会混杂</li>
</ul>
<p>所以，有没有一种方法，能够一劳永逸的解决所有校验的问题以及降低后续的维护成本和异常处理成本呢？</p>
<h2 id="问题3-业务代码的清晰度"><a href="#问题3-业务代码的清晰度" class="headerlink" title="问题3 - 业务代码的清晰度"></a>问题3 - 业务代码的清晰度</h2><p>在这段代码里：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">String areaCode = <span class="literal">null</span>;</span><br><span class="line">String[] areas = new String[]&#123;<span class="string">"0571"</span>, <span class="string">"021"</span>, <span class="string">"010"</span>&#125;;</span><br><span class="line"><span class="keyword">for</span> (int i = 0; i &lt; phone.length(); i++) &#123;</span><br><span class="line">    String<span class="built_in"> prefix </span>= phone.substring(0, i);</span><br><span class="line">    <span class="keyword">if</span> (Arrays.asList(areas).contains(prefix)) &#123;</span><br><span class="line">        areaCode = prefix;</span><br><span class="line">        break;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">SalesRep rep = salesRepRepo.findRep(areaCode);</span><br></pre></td></tr></table></figure>
<p>实际上出现了另外一种常见的情况，那就是从一些入参里抽取一部分数据，然后调用一个外部依赖获取更多的数据，然后通常从新的数据中再抽取部分数据用作其他的作用。这种代码通常被称作“胶水代码”，其本质是由于外部依赖的服务的入参并不符合我们原始的入参导致的。比如，如果SalesRepRepository包含一个findRepByPhone的方法，则上面大部分的代码都不必要了。</p>
<p>所以，一个常见的办法是将这段代码抽离出来，变成独立的一个或多个方法：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">private static String findAreaCode(String phone) &#123;</span><br><span class="line">    <span class="keyword">for</span> (int i = 0; i &lt; phone.length(); i++) &#123;</span><br><span class="line">        String<span class="built_in"> prefix </span>= phone.substring(0, i);</span><br><span class="line">        <span class="keyword">if</span> (isAreaCode(prefix)) &#123;</span><br><span class="line">            return prefix;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private static boolean isAreaCode(String prefix) &#123;</span><br><span class="line">    String[] areas = new String[]&#123;<span class="string">"0571"</span>, <span class="string">"021"</span>&#125;;</span><br><span class="line">    return Arrays.asList(areas).contains(prefix);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后原始代码变为：</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">String areaCode</span> = findAreaCode(phone);</span><br><span class="line"><span class="attribute">SalesRep rep</span> = salesRepRepo.findRep(areaCode);</span><br></pre></td></tr></table></figure>
<p>而为了复用以上的方法，可能会抽离出一个静态工具类 PhoneUtils 。但是这里要思考的是，静态工具类是否是最好的实现方式呢？当你的项目里充斥着大量的静态工具类，业务代码散在多个文件当中时，你是否还能找到核心的业务逻辑呢？</p>
<h2 id="问题4-可测试性"><a href="#问题4-可测试性" class="headerlink" title="问题4 - 可测试性"></a>问题4 - 可测试性</h2><p>为了保证代码质量，每个方法里的每个入参的每个可能出现的条件都要有 TC 覆盖（假设我们先不去测试内部业务逻辑），所以在我们这个方法里需要以下的 TC ：</p>
<p>假如一个方法有 N 个参数，每个参数有 M 个校验逻辑，至少要有 N * M 个 TC 。</p>
<p>如果这时候在该方法中加入一个新的入参字段 fax ，即使 fax 和 phone 的校验逻辑完全一致，为了保证 TC 覆盖率，也一样需要 M 个新的 TC 。</p>
<p>而假设有 P 个方法中都用到了 phone 这个字段，这 P 个方法都需要对该字段进行测试，也就是说整体需要：</p>
<p>P <em> N </em> M</p>
<p>个测试用例才能完全覆盖所有数据验证的问题，在日常项目中，这个测试的成本非常之高，导致大量的代码没被覆盖到。而没被测试覆盖到的代码才是最有可能出现问题的地方。</p>
<p>在这个情况下，降低测试成本 == 提升代码质量，如何能够降低测试的成本呢？</p>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>我们回头先重新看一下原始的 use case，并且标注其中可能重要的概念：</p>
<p>一个新应用在全国通过 地推业务员 做推广，需要做一个用户的注册系统，在用户注册后能够通过用户电话号的区号对业务员发奖金。</p>
<p>在分析了 use case 后，发现其中地推业务员、用户本身自带 ID 属性，属于 Entity（实体），而注册系统属于 Application Service（应用服务），这几个概念已经有存在。但是发现电话号这个概念却完全被隐藏到了代码之中。我们可以问一下自己，取电话号的区号的逻辑是否属于用户（用户的区号？）？是否属于注册服务（注册的区号？）？如果都不是很贴切，那就说明这个逻辑应该属于一个独立的概念。所以这里引入我们第一个原则：</p>
<p>Make Implicit Concepts Explicit</p>
<h3 id="将隐性的概念显性化"><a href="#将隐性的概念显性化" class="headerlink" title="将隐性的概念显性化"></a>将隐性的概念显性化</h3><p>在这里，我们可以看到，原来电话号仅仅是用户的一个参数，属于隐形概念，但实际上电话号的区号才是真正的业务逻辑，而我们需要将电话号的概念显性化，通过写一个Value Object：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> PhoneNumber &#123;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> final <span class="built_in">String</span> <span class="built_in">number</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">String</span> getNumber() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">number</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> PhoneNumber(<span class="built_in">String</span> <span class="built_in">number</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">number</span> == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ValidationException(<span class="string">"number不能为空"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isValid(<span class="built_in">number</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ValidationException(<span class="string">"number格式错误"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.number = <span class="built_in">number</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">String</span> getAreaCode() &#123;</span><br><span class="line">        <span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt; <span class="built_in">number</span>.length(); i++) &#123;</span><br><span class="line">            <span class="built_in">String</span> prefix = <span class="built_in">number</span>.substring(<span class="number">0</span>, i);</span><br><span class="line">            <span class="keyword">if</span> (isAreaCode(prefix)) &#123;</span><br><span class="line">                <span class="keyword">return</span> prefix;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">boolean</span> isAreaCode(<span class="built_in">String</span> prefix) &#123;</span><br><span class="line">        <span class="built_in">String</span>[] areas = <span class="keyword">new</span> <span class="built_in">String</span>[]&#123;<span class="string">"0571"</span>, <span class="string">"021"</span>, <span class="string">"010"</span>&#125;;</span><br><span class="line">        <span class="keyword">return</span> Arrays.asList(areas).contains(prefix);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">boolean</span> isValid(<span class="built_in">String</span> <span class="built_in">number</span>) &#123;</span><br><span class="line">        <span class="built_in">String</span> pattern = <span class="string">"^0?[1-9]&#123;2,3&#125;-?\\d&#123;8&#125;$"</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">number</span>.matches(pattern);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里面有几个很重要的元素：</p>
<ul>
<li>通过 private final String number 确保 PhoneNumber 是一个（Immutable）Value Object。（一般来说 VO 都是 Immutable 的，这里只是重点强调一下）</li>
<li>校验逻辑都放在了 constructor 里面，确保只要 PhoneNumber 类被创建出来后，一定是校验通过的。</li>
<li>之前的 findAreaCode 方法变成了 PhoneNumber 类里的 getAreaCode ，突出了 areaCode 是 PhoneNumber 的一个计算属性。</li>
</ul>
<p>这样做完之后，我们发现把 PhoneNumber 显性化之后，其实是生成了一个 Type（数据类型）和一个 Class（类）：</p>
<ul>
<li>Type 指我们在今后的代码里可以通过 PhoneNumber 去显性的标识电话号这个概念</li>
<li>Class 指我们可以把所有跟电话号相关的逻辑完整的收集到一个文件里<br>这两个概念加起来，构造成了本文标题的 Domain Primitive（DP）。</li>
</ul>
<p>我们看一下全面使用了 DP 之后效果：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> &#123;</span></span><br><span class="line">    UserId userId;</span><br><span class="line">    Name name;</span><br><span class="line">    PhoneNumber phone;</span><br><span class="line">    Address address;</span><br><span class="line">    RepId repId;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> User register(</span><br><span class="line">  <span class="meta">@NotNull</span> Name name,</span><br><span class="line">  <span class="meta">@NotNull</span> PhoneNumber phone,</span><br><span class="line">  <span class="meta">@NotNull</span> Address address</span><br><span class="line">) &#123;</span><br><span class="line">    <span class="comment">// 找到区域内的SalesRep</span></span><br><span class="line">    SalesRep rep = salesRepRepo.findRep(phone.getAreaCode());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 最后创建用户，落盘，然后返回，这部分代码实际上也能用Builder解决</span></span><br><span class="line">    User user = <span class="keyword">new</span> User();</span><br><span class="line">    user.name = name;</span><br><span class="line">    user.phone = phone;</span><br><span class="line">    user.address = address;</span><br><span class="line">    <span class="keyword">if</span> (rep != <span class="literal">null</span>) &#123;</span><br><span class="line">        user.repId = rep.repId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> userRepo.saveUser(user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们可以看到在使用了 DP 之后，所有的数据验证逻辑和非业务流程的逻辑都消失了，剩下都是核心业务逻辑，可以一目了然。我们重新用上面的四个维度评估一下：</p>
<h2 id="评估1-接口的清晰度"><a href="#评估1-接口的清晰度" class="headerlink" title="评估1 - 接口的清晰度"></a>评估1 - 接口的清晰度</h2><p>重构后的方法签名变成了很清晰的：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public<span class="built_in"> User </span>register(Name, PhoneNumber, Address)</span><br></pre></td></tr></table></figure>
<p>而之前容易出现的bug，如果按照现在的写法</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service.register(<span class="keyword">new</span> <span class="type">Name</span>(<span class="string">"殷浩"</span>), <span class="keyword">new</span> <span class="type">Address</span>(<span class="string">"浙江省杭州市余杭区文三西路969号"</span>), <span class="keyword">new</span> <span class="type">PhoneNumber</span>(<span class="string">"0571-12345678"</span>));</span><br></pre></td></tr></table></figure>
<p>让接口 API 变得很干净，易拓展。</p>
<h2 id="评估2-数据验证和错误处理"><a href="#评估2-数据验证和错误处理" class="headerlink" title="评估2 - 数据验证和错误处理"></a>评估2 - 数据验证和错误处理</h2><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">public</span> <span class="selector-tag">User</span> <span class="selector-tag">register</span>(</span><br><span class="line">  <span class="variable">@NotNull</span> Name name,</span><br><span class="line">  <span class="variable">@NotNull</span> PhoneNumber phone,</span><br><span class="line">  <span class="variable">@NotNull</span> Address address</span><br><span class="line">) <span class="comment">// no throws</span></span><br></pre></td></tr></table></figure>
<p>如前文代码展示的，重构后的方法里，完全没有了任何数据验证的逻辑，也不会抛 ValidationException 。原因是因为 DP 的特性，只要是能够带到入参里的一定是正确的或 null（Bean Validation 或 lombok 的注解能解决 null 的问题）。所以我们把数据验证的工作量前置到了调用方，而调用方本来就是应该提供合法数据的，所以更加合适。</p>
<p>再展开来看，使用DP的另一个好处就是代码遵循了 DRY 原则和单一性原则，如果未来需要修改 PhoneNumber 的校验逻辑，只需要在一个文件里修改即可，所有使用到了 PhoneNumber 的地方都会生效。</p>
<h2 id="评估3-业务代码的清晰度"><a href="#评估3-业务代码的清晰度" class="headerlink" title="评估3 - 业务代码的清晰度"></a>评估3 - 业务代码的清晰度</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SalesRep rep = salesRepRepo.findRep(phone.getAreaCode());</span><br><span class="line">User<span class="built_in"> user </span>= xxx;</span><br><span class="line">return userRepo.save(user);</span><br></pre></td></tr></table></figure>
<p>除了在业务方法里不需要校验数据之外，原来的一段胶水代码 findAreaCode 被改为了 PhoneNumber 类的一个计算属性 getAreaCode ，让代码清晰度大大提升。而且胶水代码通常都不可复用，但是使用了 DP 后，变成了可复用、可测试的代码。我们能看到，在刨除了数据验证代码、胶水代码之后，剩下的都是核心业务逻辑。（ Entity 相关的重构在后面文章会谈到，这次先忽略）</p>
<h2 id="评估4-可测试性"><a href="#评估4-可测试性" class="headerlink" title="评估4 - 可测试性"></a>评估4 - 可测试性</h2><p>当我们将 PhoneNumber 抽取出来之后，在来看测试的 TC ：</p>
<p>首先 PhoneNumber 本身还是需要 M 个测试用例，但是由于我们只需要测试单一对象，每个用例的代码量会大大降低，维护成本降低。<br>每个方法里的每个参数，现在只需要覆盖为 null 的情况就可以了，其他的 case 不可能发生（因为只要不是 null 就一定是合法的）<br>所以，单个方法的 TC 从原来的 N * M 变成了今天的 N + M 。同样的，多个方法的 TC 数量变成了</p>
<p>N + M + P</p>
<p>这个数量一般来说要远低于原来的数量 N<em> M </em> P ，让测试成本极大的降低。</p>
<h2 id="评估总结"><a href="#评估总结" class="headerlink" title="评估总结"></a>评估总结</h2><h2 id="进阶使用"><a href="#进阶使用" class="headerlink" title="进阶使用"></a>进阶使用</h2><p>在上文我介绍了 DP 的第一个原则：将隐性的概念显性化。在这里我将介绍 DP 的另外两个原则，用一个新的案例。</p>
<h2 id="▍案例1-转账"><a href="#▍案例1-转账" class="headerlink" title="▍案例1 - 转账"></a>▍案例1 - 转账</h2><p>假设现在要实现一个功能，让A用户可以支付 x 元给用户 B ，可能的实现如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pay</span><span class="params">(BigDecimal money, Long recipientId)</span> </span>&#123;</span><br><span class="line">    BankService.transfer(money, <span class="string">"CNY"</span>, recipientId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果这个是境内转账，并且境内的货币永远不变，该方法貌似没啥问题，但如果有一天货币变更了（比如欧元区曾经出现的问题），或者我们需要做跨境转账，该方法是明显的 bug ，因为 money 对应的货币不一定是 CNY 。</p>
<p>在这个 case 里，当我们说“支付 x 元”时，除了 x 本身的数字之外，实际上是有一个隐含的概念那就是货币“元”。但是在原始的入参里，之所以只用了 BigDecimal 的原因是我们认为 CNY 货币是默认的，是一个隐含的条件，但是在我们写代码时，需要把所有隐性的条件显性化，而这些条件整体组成当前的上下文。所以 DP 的第二个原则是：</p>
<p>Make Implicit Context Explicit</p>
<p>将 隐性的 上下文 显性化</p>
<p>所以当我们做这个支付功能时，实际上需要的一个入参是支付金额 + 支付货币。我们可以把这两个概念组合成为一个独立的完整概念：Money。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Value</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Money</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> BigDecimal amount;</span><br><span class="line">    <span class="keyword">private</span> Currency currency;</span><br><span class="line">    <span class="keyword">public</span> Money(BigDecimal amount, Currency currency) &#123;</span><br><span class="line">        <span class="keyword">this</span>.amount = amount;</span><br><span class="line">        <span class="keyword">this</span>.currency = currency;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而原有的代码则变为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pay</span><span class="params">(Money money, Long recipientId)</span> </span>&#123;</span><br><span class="line">    BankService.transfer(money, recipientId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过将默认货币这个隐性的上下文概念显性化，并且和金额合并为 Money ，我们可以避免很多当前看不出来，但未来可能会暴雷的bug。</p>
<h2 id="案例2-跨境转账"><a href="#案例2-跨境转账" class="headerlink" title="案例2 - 跨境转账"></a>案例2 - 跨境转账</h2><p>前面的案例升级一下，假设用户可能要做跨境转账从 CNY 到 USD ，并且货币汇率随时在波动：</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public void pay(Money money, Currency targetCurrency, Long recipientId) &#123;</span><br><span class="line">    if (money.getCurrency().equals(targetCurrency)) &#123;</span><br><span class="line">        <span class="keyword">BankService.transfer(money, </span>recipientId)<span class="comment">;</span></span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        <span class="keyword">BigDecimal </span>rate = ExchangeService.getRate(money.getCurrency(), targetCurrency)<span class="comment">;</span></span><br><span class="line">        <span class="keyword">BigDecimal </span>targetAmount = money.getAmount().<span class="keyword">multiply(new </span><span class="keyword">BigDecimal(rate));</span></span><br><span class="line"><span class="keyword"> </span>       Money targetMoney = new Money(targetAmount, targetCurrency)<span class="comment">;</span></span><br><span class="line">        <span class="keyword">BankService.transfer(targetMoney, </span>recipientId)<span class="comment">;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这个case里，由于 targetCurrency 不一定和 money 的 Curreny 一致，需要调用一个服务去取汇率，然后做计算。最后用计算后的结果做转账。</p>
<p>这个case最大的问题在于，金额的计算被包含在了支付的服务中，涉及到的对象也有2个 Currency ，2 个 Money ，1 个 BigDecimal ，总共 5 个对象。这种涉及到多个对象的业务逻辑，需要用 DP 包装掉，所以这里引出 DP 的第三个原则：</p>
<p>Encapsulate Multi-Object Behavior</p>
<p>封装 多对象 行为</p>
<p>在这个 case 里，可以将转换汇率的功能，封装到一个叫做 ExchangeRate 的 DP 里：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">@Value</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ExchangeRate</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> BigDecimal rate;</span><br><span class="line">    <span class="keyword">private</span> Currency <span class="keyword">from</span>;</span><br><span class="line">    <span class="keyword">private</span> Currency to;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ExchangeRate</span>(<span class="params">BigDecimal rate, Currency <span class="keyword">from</span>, Currency to</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.rate = rate;</span><br><span class="line">        <span class="keyword">this</span>.<span class="keyword">from</span> = <span class="keyword">from</span>;</span><br><span class="line">        <span class="keyword">this</span>.to = to;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Money <span class="title">exchange</span>(<span class="params">Money fromMoney</span>) </span>&#123;</span><br><span class="line">        notNull(fromMoney);</span><br><span class="line">        isTrue(<span class="keyword">this</span>.<span class="keyword">from</span>.<span class="keyword">equals</span>(fromMoney.getCurrency()));</span><br><span class="line">        BigDecimal targetAmount = fromMoney.getAmount().multiply(rate);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Money(targetAmount, to);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ExchangeRate汇率对象，通过封装金额计算逻辑以及各种校验逻辑，让原始代码变得极其简单：<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public void pay(Money money, Currency targetCurrency, Long recipientId) &#123;</span><br><span class="line">    ExchangeRate rate = ExchangeService.getRate(money.getCurrency(), targetCurrency)<span class="comment">;</span></span><br><span class="line">    Money targetMoney = rate.exchange(money)<span class="comment">;</span></span><br><span class="line">    <span class="keyword">BankService.transfer(targetMoney, </span>recipientId)<span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="讨论和总结"><a href="#讨论和总结" class="headerlink" title="讨论和总结"></a>讨论和总结</h2><h3 id="▍Domain-Primitive-的定义"><a href="#▍Domain-Primitive-的定义" class="headerlink" title="▍Domain Primitive 的定义"></a>▍Domain Primitive 的定义</h3><p>让我们重新来定义一下 Domain Primitive ：Domain Primitive 是一个在特定领域里，拥有精准定义的、可自我验证的、拥有行为的 Value Object 。</p>
<p>DP是一个传统意义上的Value Object，拥有Immutable的特性<br>DP是一个完整的概念整体，拥有精准定义<br>DP使用业务域中的原生语言<br>DP可以是业务域的最小组成部分、也可以构建复杂组合<br>注：Domain Primitive的概念和命名来自于Dan Bergh Johnsson &amp; Daniel Deogun的书 Secure by Design。</p>
<h3 id="▍使用-Domain-Primitive-的三原则"><a href="#▍使用-Domain-Primitive-的三原则" class="headerlink" title="▍使用 Domain Primitive 的三原则"></a>▍使用 Domain Primitive 的三原则</h3><p>让隐性的概念显性化<br>让隐性的上下文显性化<br>封装多对象行为</p>
<h3 id="▍Domain-Primitive-和-DDD-里-Value-Object-的区别"><a href="#▍Domain-Primitive-和-DDD-里-Value-Object-的区别" class="headerlink" title="▍Domain Primitive 和 DDD 里 Value Object 的区别"></a>▍Domain Primitive 和 DDD 里 Value Object 的区别</h3><p>在 DDD 中， Value Object 这个概念其实已经存在：</p>
<p>在 Evans 的 DDD 蓝皮书中，Value Object 更多的是一个非 Entity 的值对象<br>在Vernon的IDDD红皮书中，作者更多的关注了Value Object的Immutability、Equals方法、Factory方法等<br>Domain Primitive 是 Value Object 的进阶版，在原始 VO 的基础上要求每个 DP 拥有概念的整体，而不仅仅是值对象。在 VO 的 Immutable 基础上增加了 Validity 和行为。当然同样的要求无副作用（side-effect free）。</p>
<h3 id="▍Domain-Primitive-和-Data-Transfer-Object-DTO-的区别"><a href="#▍Domain-Primitive-和-Data-Transfer-Object-DTO-的区别" class="headerlink" title="▍Domain Primitive 和 Data Transfer Object (DTO) 的区别"></a>▍Domain Primitive 和 Data Transfer Object (DTO) 的区别</h3><p>在日常开发中经常会碰到的另一个数据结构是 DTO ，比如方法的入参和出参。DP 和 DTO 的区别如下：</p>
<h3 id="▍什么情况下应该用-Domain-Primitive"><a href="#▍什么情况下应该用-Domain-Primitive" class="headerlink" title="▍什么情况下应该用 Domain Primitive"></a>▍什么情况下应该用 Domain Primitive</h3><p>常见的 DP 的使用场景包括：</p>
<p>有格式限制的 String：比如Name，PhoneNumber，OrderNumber，ZipCode，Address等<br>有限制的Integer：比如OrderId（&gt;0），Percentage（0-100%），Quantity（&gt;=0）等<br>可枚举的 int ：比如 Status（一般不用Enum因为反序列化问题）<br>Double 或 BigDecimal：一般用到的 Double 或 BigDecimal 都是有业务含义的，比如 Temperature、Money、Amount、ExchangeRate、Rating 等<br>复杂的数据结构：比如 Map&lt;String, List<integer>&gt; 等，尽量能把 Map 的所有操作包装掉，仅暴露必要行为</integer></p>
<h2 id="实战-老应用重构的流程"><a href="#实战-老应用重构的流程" class="headerlink" title="实战 - 老应用重构的流程"></a>实战 - 老应用重构的流程</h2><p>在新应用中使用 DP 是比较简单的，但在老应用中使用 DP 是可以遵循以下流程按部就班的升级。在此用本文的第一个 case 为例。</p>
<h3 id="▍第一步-创建-Domain-Primitive，收集所有-DP-行为"><a href="#▍第一步-创建-Domain-Primitive，收集所有-DP-行为" class="headerlink" title="▍第一步 - 创建 Domain Primitive，收集所有 DP 行为"></a>▍第一步 - 创建 Domain Primitive，收集所有 DP 行为</h3><p>在前文中，我们发现取电话号的区号这个是一个可以独立出来的、可以放入 PhoneNumber 这个 Class 的逻辑。类似的，在真实的项目中，以前散落在各个服务或工具类里面的代码，可以都抽出来放在 DP 里，成为 DP 自己的行为或属性。这里面的原则是：所有抽离出来的方法要做到无状态，比如原来是 static 的方法。如果原来的方法有状态变更，需要将改变状态的部分和不改状态的部分分离，然后将无状态的部分融入 DP 。因为 DP 本身不能带状态，所以一切需要改变状态的代码都不属于 DP 的范畴。</p>
<p>(代码参考 PhoneNumber 的代码，这里不再重复)</p>
<h3 id="▍第二步-替换数据校验和无状态逻辑"><a href="#▍第二步-替换数据校验和无状态逻辑" class="headerlink" title="▍第二步 - 替换数据校验和无状态逻辑"></a>▍第二步 - 替换数据校验和无状态逻辑</h3><p>为了保障现有方法的兼容性，在第二步不会去修改接口的签名，而是通过代码替换原有的校验逻辑和根 DP 相关的业务逻辑。比如：</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> User register(<span class="keyword">String</span> name, <span class="keyword">String</span> phone, <span class="keyword">String</span> address)</span><br><span class="line">        throws ValidationException &#123;</span><br><span class="line">    <span class="keyword">if</span> (name == <span class="literal">null</span> || name.length() == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">ValidationException</span>(<span class="string">"name"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (phone == <span class="literal">null</span> || !isValidPhoneNumber(phone)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">ValidationException</span>(<span class="string">"phone"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">String</span> areaCode = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">String</span>[] areas = <span class="keyword">new</span> <span class="type">String</span>[]&#123;<span class="string">"0571"</span>, <span class="string">"021"</span>, <span class="string">"010"</span>&#125;;</span><br><span class="line">    <span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt; phone.length(); i++) &#123;</span><br><span class="line">        <span class="keyword">String</span> prefix = phone.substring(<span class="number">0</span>, i);</span><br><span class="line">        <span class="keyword">if</span> (Arrays.asList(areas).contains(prefix)) &#123;</span><br><span class="line">            areaCode = prefix;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    SalesRep rep = salesRepRepo.findRep(areaCode);</span><br><span class="line">    <span class="comment">// 其他代码...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过 DP 替换代码后：</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> User register(<span class="keyword">String</span> name, <span class="keyword">String</span> phone, <span class="keyword">String</span> address)</span><br><span class="line">        throws ValidationException &#123;</span><br><span class="line">    </span><br><span class="line">    Name _name = <span class="keyword">new</span> <span class="type">Name</span>(name);</span><br><span class="line">    PhoneNumber _phone = <span class="keyword">new</span> <span class="type">PhoneNumber</span>(phone);</span><br><span class="line">    Address _address = <span class="keyword">new</span> <span class="type">Address</span>(address);</span><br><span class="line">    </span><br><span class="line">    SalesRep rep = salesRepRepo.findRep(_phone.getAreaCode());</span><br><span class="line">    <span class="comment">// 其他代码...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过 new PhoneNumber(phone) 这种代码，替代了原有的校验代码。</p>
<p>通过 _phone.getAreaCode() 替换了原有的无状态的业务逻辑。</p>
<p>▍第三步 - 创建新接口<br>创建新接口，将DP的代码提升到接口参数层：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public<span class="built_in"> User </span>register(Name name, PhoneNumber phone,<span class="built_in"> Address </span>address) &#123;</span><br><span class="line">    SalesRep rep = salesRepRepo.findRep(phone.getAreaCode());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>▍第四步 - 修改外部调用</p>
<p>外部调用方需要修改调用链路，比如：</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">service.register(<span class="string">"殷浩"</span>, <span class="string">"0571-12345678"</span>, <span class="string">"浙江省杭州市余杭区文三西路969号"</span>);</span><br><span class="line">改为：</span><br><span class="line"></span><br><span class="line">service.register(<span class="keyword">new</span> <span class="type">Name</span>(<span class="string">"殷浩"</span>), <span class="keyword">new</span> <span class="type">PhoneNumber</span>(<span class="string">"0571-12345678"</span>), <span class="keyword">new</span> <span class="type">Address</span>(<span class="string">"浙江省杭州市余杭区文三西路969号"</span>));</span><br></pre></td></tr></table></figure>
<p>通过以上 4 步，就能让你的代码变得更加简洁、优雅、健壮、安全。你还在等什么？今天就去尝试吧！</p>
<h1 id="应用架构设计"><a href="#应用架构设计" class="headerlink" title="应用架构设计"></a>应用架构设计</h1><p>设计原则</p>
<ul>
<li>单一性原则（Single Responsibility Principle）：单一性原则要求一个对象/类应该只有一个变更的原因。但是在这个案例里，代码可能会因为任意一个外部依赖或计算逻辑的改变而改变。</li>
<li>依赖反转原则（Dependency Inversion Principle）：依赖反转原则要求在代码中依赖抽象，而不是具体的实现。在这个案例里外部依赖都是具体的实现，比如YahooForexService虽然是一个接口类，但是它对应的是依赖了Yahoo提供的具体服务，所以也算是依赖了实现。同样的KafkaTemplate、MyBatis的DAO实现都属于具体实现。</li>
<li>开放封闭原则（Open Closed Principle）：开放封闭原则指开放扩展，但是封闭修改。在这个案例里的金额计算属于可能会被修改的代码，这个时候该逻辑应该需要被包装成为不可修改的计算类，新功能通过计算类的拓展实现。</li>
</ul>
<h2 id="需求背景"><a href="#需求背景" class="headerlink" title="需求背景"></a>需求背景</h2><p>我们先看一个简单的案例需求如下：</p>
<p>用户可以通过银行网页转账给另一个账号，支持跨币种转账。</p>
<p>同时因为监管和对账需求，需要记录本次转账活动。</p>
<p>拿到这个需求之后，一个开发可能会经历一些技术选型，最终可能拆解需求如下：</p>
<p>1、从MySql数据库中找到转出和转入的账户，选择用 MyBatis 的 mapper 实现 DAO；2、从 Yahoo（或其他渠道）提供的汇率服务获取转账的汇率信息（底层是 http 开放接口）；</p>
<p>3、计算需要转出的金额，确保账户有足够余额，并且没超出每日转账上限；</p>
<p>4、实现转入和转出操作，扣除手续费，保存数据库；</p>
<p>5、发送 Kafka 审计消息，以便审计和对账用；</p>
<p>而一个简单的代码实现如下：<br><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransferController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> TransferService transferService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Result&lt;Boolean&gt; transfer(<span class="keyword">String</span> targetAccountNumber, BigDecimal amount, HttpSession session) &#123;</span><br><span class="line">        Long userId = (Long) session.getAttribute(<span class="string">"userId"</span>);</span><br><span class="line">        <span class="keyword">return</span> transferService.transfer(userId, targetAccountNumber, amount, <span class="string">"CNY"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransferServiceImpl</span> <span class="keyword"><span class="keyword">implements</span> <span class="type">TransferService</span></span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> final <span class="keyword">String</span> TOPIC_AUDIT_LOG = <span class="string">"TOPIC_AUDIT_LOG"</span>;</span><br><span class="line">    <span class="keyword">private</span> AccountMapper accountDAO;</span><br><span class="line">    <span class="keyword">private</span> KafkaTemplate&lt;<span class="keyword">String</span>, <span class="keyword">String</span>&gt; kafkaTemplate;</span><br><span class="line">    <span class="keyword">private</span> YahooForexService yahooForex;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    <span class="keyword">public</span> Result&lt;Boolean&gt; transfer(Long sourceUserId, <span class="keyword">String</span> targetAccountNumber, BigDecimal targetAmount, <span class="keyword">String</span> targetCurrency) &#123;</span><br><span class="line">        <span class="comment">// 1. 从数据库读取数据，忽略所有校验逻辑如账号是否存在等</span></span><br><span class="line">        AccountDO sourceAccountDO = accountDAO.selectByUserId(sourceUserId);</span><br><span class="line">        AccountDO targetAccountDO = accountDAO.selectByAccountNumber(targetAccountNumber);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 业务参数校验</span></span><br><span class="line">        <span class="keyword">if</span> (!targetAccountDO.getCurrency().equals(targetCurrency)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">InvalidCurrencyException</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 获取外部数据，并且包含一定的业务逻辑</span></span><br><span class="line">        <span class="comment">// exchange rate = 1 source currency = X target currency</span></span><br><span class="line">        BigDecimal exchangeRate = BigDecimal.ONE;</span><br><span class="line">        <span class="keyword">if</span> (sourceAccountDO.getCurrency().equals(targetCurrency)) &#123;</span><br><span class="line">            exchangeRate = yahooForex.getExchangeRate(sourceAccountDO.getCurrency(), targetCurrency);</span><br><span class="line">        &#125;</span><br><span class="line">        BigDecimal sourceAmount = targetAmount.divide(exchangeRate, RoundingMode.DOWN);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. 业务参数校验</span></span><br><span class="line">        <span class="keyword">if</span> (sourceAccountDO.getAvailable().compareTo(sourceAmount) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">InsufficientFundsException</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (sourceAccountDO.getDailyLimit().compareTo(sourceAmount) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">DailyLimitExceededException</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. 计算新值，并且更新字段</span></span><br><span class="line">        BigDecimal <span class="keyword">new</span><span class="type">Source</span> = sourceAccountDO.getAvailable().subtract(sourceAmount);</span><br><span class="line">        BigDecimal <span class="keyword">new</span><span class="type">Target</span> = targetAccountDO.getAvailable().add(targetAmount);</span><br><span class="line">        sourceAccountDO.setAvailable(<span class="keyword">new</span><span class="type">Source</span>);</span><br><span class="line">        targetAccountDO.setAvailable(<span class="keyword">new</span><span class="type">Target</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6. 更新到数据库</span></span><br><span class="line">        accountDAO.update(sourceAccountDO);</span><br><span class="line">        accountDAO.update(targetAccountDO);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7. 发送审计消息</span></span><br><span class="line">        <span class="keyword">String</span> message = sourceUserId + <span class="string">","</span> + targetAccountNumber + <span class="string">","</span> + targetAmount + <span class="string">","</span> + targetCurrency;</span><br><span class="line">        kafkaTemplate.send(TOPIC_AUDIT_LOG, message);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.success(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="流程图"><a href="#流程图" class="headerlink" title="流程图"></a>流程图</h2><p>在重构之前，我们先画一张流程图，描述当前代码在做的每个步骤：<br><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/DDD%E9%A2%86%E5%9F%9F%E9%A9%B1%E5%8A%A8%E8%AE%BE%E8%AE%A1.jpeg" alt="image"></p>
<p>这是一个传统的三层分层结构：UI层、业务层、和基础设施层。上层对于下层有直接的依赖关系，导致耦合度过高。在业务层中对于下层的基础设施有强依赖，耦合度高。我们需要对这张图上的每个节点做抽象和整理，来降低对外部依赖的耦合度。</p>
<h2 id="抽象数据存储层"><a href="#抽象数据存储层" class="headerlink" title="抽象数据存储层"></a>抽象数据存储层</h2><p>第一步常见的操作是将Data Access层做抽象，降低系统对数据库的直接依赖。具体的方法如下：</p>
<p>新建Account实体对象：一个实体（Entity）是拥有ID的域对象，除了拥有数据之外，同时拥有行为。Entity和数据库储存格式无关，在设计中要以该领域的通用严谨语言（Ubiquitous Language）为依据。<br>新建对象储存接口类AccountRepository：Repository只负责Entity对象的存储和读取，而Repository的实现类完成数据库存储的细节。通过加入Repository接口，底层的数据库连接可以通过不同的实现类而替换。</p>
<p>具体的简单代码实现如下：</p>
<p>Account实体类：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Account</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> AccountId id;</span><br><span class="line">    <span class="keyword">private</span> AccountNumber accountNumber;</span><br><span class="line">    <span class="keyword">private</span> UserId userId;</span><br><span class="line">    <span class="keyword">private</span> Money available;</span><br><span class="line">    <span class="keyword">private</span> Money dailyLimit;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">withdraw</span><span class="params">(Money money)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 转出</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deposit</span><span class="params">(Money money)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 转入</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>和AccountRepository及MyBatis实现类：<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AccountRepository</span> </span>&#123;</span><br><span class="line">    <span class="function">Account <span class="title">find</span><span class="params">(AccountId id)</span></span>;</span><br><span class="line">    <span class="function">Account <span class="title">find</span><span class="params">(AccountNumber accountNumber)</span></span>;</span><br><span class="line">    <span class="function">Account <span class="title">find</span><span class="params">(UserId userId)</span></span>;</span><br><span class="line">    <span class="function">Account <span class="title">save</span><span class="params">(Account account)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccountRepositoryImpl</span> <span class="keyword">implements</span> <span class="title">AccountRepository</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AccountMapper accountDAO;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AccountBuilder accountBuilder;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function">Account <span class="title">find</span><span class="params">(AccountId id)</span> </span>&#123;</span><br><span class="line">        AccountDO accountDO = accountDAO.selectById(id.getValue());</span><br><span class="line">        <span class="function"><span class="keyword">return</span> accountBuilder.<span class="title">toAccount</span><span class="params">(accountDO)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function">Account <span class="title">find</span><span class="params">(AccountNumber accountNumber)</span> </span>&#123;</span><br><span class="line">        AccountDO accountDO = accountDAO.selectByAccountNumber(accountNumber.getValue());</span><br><span class="line">        <span class="function"><span class="keyword">return</span> accountBuilder.<span class="title">toAccount</span><span class="params">(accountDO)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function">Account <span class="title">find</span><span class="params">(UserId userId)</span> </span>&#123;</span><br><span class="line">        AccountDO accountDO = accountDAO.selectByUserId(userId.getId());</span><br><span class="line">        <span class="function"><span class="keyword">return</span> accountBuilder.<span class="title">toAccount</span><span class="params">(accountDO)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function">Account <span class="title">save</span><span class="params">(Account account)</span> </span>&#123;</span><br><span class="line">        AccountDO accountDO = accountBuilder.fromAccount(account);</span><br><span class="line">        <span class="keyword">if</span> (accountDO.getId() == <span class="keyword">null</span>) &#123;</span><br><span class="line">            accountDAO.insert(accountDO);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            accountDAO.update(accountDO);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">return</span> accountBuilder.<span class="title">toAccount</span><span class="params">(accountDO)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Account实体类和AccountDO数据类的对比如下：</p>
<ul>
<li>Data Object数据类：AccountDO是单纯的和数据库表的映射关系，每个字段对应数据库表的一个column，这种对象叫Data Object。DO只有数据，没有行为。AccountDO的作用是对数据库做快速映射，避免直接在代码里写SQL。无论你用的是MyBatis还是Hibernate这种ORM，从数据库来的都应该先直接映射到DO上，但是代码里应该完全避免直接操作 DO。</li>
<li>Entity实体类：Account 是基于领域逻辑的实体类，它的字段和数据库储存不需要有必然的联系。Entity包含数据，同时也应该包含行为。在 Account 里，字段也不仅仅是String等基础类型，而应该尽可能用上一讲的 Domain Primitive 代替，可以避免大量的校验代码。</li>
</ul>
<p>DAO 和 Repository 类的对比如下：</p>
<ul>
<li>DAO对应的是一个特定的数据库类型的操作，相当于SQL的封装。所有操作的对象都是DO类，所有接口都可以根据数据库实现的不同而改变。比如，insert 和 update 属于数据库专属的操作。</li>
<li>Repository对应的是Entity对象读取储存的抽象，在接口层面做统一，不关注底层实现。比如，通过 save 保存一个Entity对象，但至于具体是 insert 还是 update 并不关心。Repository的具体实现类通过调用DAO来实现各种操作，通过Builder/Factory对象实现AccountDO 到 Account之间的转化</li>
</ul>
<h3 id="Repository和Entity"><a href="#Repository和Entity" class="headerlink" title="Repository和Entity"></a>Repository和Entity</h3><ul>
<li>通过Account对象，避免了其他业务逻辑代码和数据库的直接耦合，避免了当数据库字段变化时，大量业务逻辑也跟着变的问题。</li>
<li>通过Repository，改变业务代码的思维方式，让业务逻辑不再面向数据库编程，而是面向领域模型编程。</li>
<li>Account属于一个完整的内存中对象，可以比较容易的做完整的测试覆盖，包含其行为。</li>
<li>Repository作为一个接口类，可以比较容易的实现Mock或Stub，可以很容易测试。</li>
<li>AccountRepositoryImpl实现类，由于其职责被单一出来，只需要关注Account到AccountDO的映射关系和Repository方法到DAO方法之间的映射关系，相对于来说更容易测试。</li>
</ul>
<p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/v2-1ee42f0915a33f6f000707c974792495_1440w.jpeg" alt="image"></p>
<h2 id="抽象第三方服务"><a href="#抽象第三方服务" class="headerlink" title="抽象第三方服务"></a>抽象第三方服务</h2><p>类似对于数据库的抽象，所有第三方服务也需要通过抽象解决第三方服务不可控，入参出参强耦合的问题。在这个例子里我们抽象出 ExchangeRateService 的服务，和一个ExchangeRate的Domain Primitive类：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ExchangeRateService</span> </span>&#123;</span><br><span class="line">    <span class="function">ExchangeRate <span class="title">getExchangeRate</span><span class="params">(Currency source, Currency <span class="keyword">target</span>)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExchangeRateServiceImpl</span> <span class="keyword">implements</span> <span class="title">ExchangeRateService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> YahooForexService yahooForexService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function">ExchangeRate <span class="title">getExchangeRate</span><span class="params">(Currency source, Currency <span class="keyword">target</span>)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (source.equals(<span class="keyword">target</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ExchangeRate(BigDecimal.ONE, source, <span class="keyword">target</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        BigDecimal forex = yahooForexService.getExchangeRate(source.getValue(), <span class="keyword">target</span>.getValue());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ExchangeRate(forex, source, <span class="keyword">target</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="防腐层（ACL）"><a href="#防腐层（ACL）" class="headerlink" title="防腐层（ACL）"></a>防腐层（ACL）</h3><p>这种常见的设计模式叫做Anti-Corruption Layer（防腐层或ACL）。很多时候我们的系统会去依赖其他的系统，而被依赖的系统可能包含不合理的数据结构、API、协议或技术实现，如果对外部系统强依赖，会导致我们的系统被”腐蚀“。这个时候，通过在系统间加入一个防腐层，能够有效的隔离外部依赖和内部逻辑，无论外部如何变更，内部代码可以尽可能的保持不变。</p>
<p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/v2-952c66bf1d97e78af66873dd50fe124d_1440w.jpeg" alt="image"></p>
<p>ACL 不仅仅只是多了一层调用，在实际开发中ACL能够提供更多强大的功能：</p>
<ul>
<li>适配器：很多时候外部依赖的数据、接口和协议并不符合内部规范，通过适配器模式，可以将数据转化逻辑封装到ACL内部，降低对业务代码的侵入。在这个案例里，我们通过封装了ExchangeRate和Currency对象，转化了对方的入参和出参，让入参出参更符合我们的标准。</li>
<li>缓存：对于频繁调用且数据变更不频繁的外部依赖，通过在ACL里嵌入缓存逻辑，能够有效的降低对于外部依赖的请求压力。同时，很多时候缓存逻辑是写在业务代码里的，通过将缓存逻辑嵌入ACL，能够降低业务代码的复杂度。</li>
<li>兜底：如果外部依赖的稳定性较差，一个能够有效提升我们系统稳定性的策略是通过ACL起到兜底的作用，比如当外部依赖出问题后，返回最近一次成功的缓存或业务兜底数据。这种兜底逻辑一般都比较复杂，如果散落在核心业务代码中会很难维护，通过集中在ACL中，更加容易被测试和修改。</li>
<li>易于测试：类似于之前的Repository，ACL的接口类能够很容易的实现Mock或Stub，以便于单元测试。</li>
<li>功能开关：有些时候我们希望能在某些场景下开放或关闭某个接口的功能，或者让某个接口返回一个特定的值，我们可以在ACL配置功能开关来实现，而不会对真实业务代码造成影响。同时，使用功能开关也能让我们容易的实现Monkey测试，而不需要真正物理性的关闭外部依赖。</li>
</ul>
<p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/v2-dbec337d0e361426cc58864e67756adb_1440w.jpeg" alt="image"></p>
<h2 id="抽象中间件"><a href="#抽象中间件" class="headerlink" title="抽象中间件"></a>抽象中间件</h2><p>类似于2.2的第三方服务的抽象，对各种中间件的抽象的目的是让业务代码不再依赖中间件的实现逻辑。因为中间件通常需要有通用型，中间件的接口通常是String或Byte[] 类型的，导致序列化/反序列化逻辑通常和业务逻辑混杂在一起，造成胶水代码。通过中间件的ACL抽象，减少重复胶水代码。</p>
<p>在这个案例里，我们通过封装一个抽象的AuditMessageProducer和AuditMessage DP对象，实现对底层kafka实现的隔离：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Value</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuditMessage</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> UserId userId;</span><br><span class="line">    <span class="keyword">private</span> AccountNumber source;</span><br><span class="line">    <span class="keyword">private</span> AccountNumber <span class="keyword">target</span>;</span><br><span class="line">    <span class="keyword">private</span> Money money;</span><br><span class="line">    <span class="keyword">private</span> Date date;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function">String <span class="title">serialize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userId + <span class="string">","</span> + source + <span class="string">","</span> + <span class="keyword">target</span> + <span class="string">","</span> + money + <span class="string">","</span> + date;   </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function">AuditMessage <span class="title">deserialize</span><span class="params">(String value)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// todo</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AuditMessageProducer</span> </span>&#123;</span><br><span class="line">    <span class="function">SendResult <span class="title">send</span><span class="params">(AuditMessage message)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuditMessageProducerImpl</span> <span class="keyword">implements</span> <span class="title">AuditMessageProducer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TOPIC_AUDIT_LOG = <span class="string">"TOPIC_AUDIT_LOG"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> KafkaTemplate&lt;String, String&gt; kafkaTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function">SendResult <span class="title">send</span><span class="params">(AuditMessage message)</span> </span>&#123;</span><br><span class="line">        String messageBody = message.serialize();</span><br><span class="line">        kafkaTemplate.send(TOPIC_AUDIT_LOG, messageBody);</span><br><span class="line">        <span class="function"><span class="keyword">return</span> SendResult.<span class="title">success</span><span class="params">()</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/v2-24099ac4f31bf9472bcf8b19ffaf48ab_1440w.jpeg" alt="image"></p>
<h2 id="封装业务逻辑"><a href="#封装业务逻辑" class="headerlink" title="封装业务逻辑"></a>封装业务逻辑</h2><h3 id="用Domain-Primitive封装跟实体无关的无状态计算逻辑"><a href="#用Domain-Primitive封装跟实体无关的无状态计算逻辑" class="headerlink" title="用Domain Primitive封装跟实体无关的无状态计算逻辑"></a>用Domain Primitive封装跟实体无关的无状态计算逻辑</h3><p>在这个案例里使用ExchangeRate来封装汇率计算逻辑：<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">BigDecimal </span>exchangeRate = <span class="keyword">BigDecimal.ONE;</span></span><br><span class="line"><span class="keyword">if </span>(sourceAccountDO.getCurrency().equals(targetCurrency)) &#123;</span><br><span class="line">    exchangeRate = yahooForex.getExchangeRate(sourceAccountDO.getCurrency(), targetCurrency)<span class="comment">;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">BigDecimal </span>sourceAmount = targetAmount.<span class="keyword">divide(exchangeRate, </span>RoundingMode.DOWN)<span class="comment">;</span></span><br></pre></td></tr></table></figure></p>
<p>变为：<br><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">ExchangeRate exchangeRate</span> = exchangeRateService.getExchangeRate(sourceAccount.getCurrency(), targetMoney.getCurrency());</span><br><span class="line"><span class="attribute">Money sourceMoney</span> = exchangeRate.exchangeTo(targetMoney);</span><br></pre></td></tr></table></figure></p>
<h3 id="用Entity封装单对象的有状态的行为，包括业务校验"><a href="#用Entity封装单对象的有状态的行为，包括业务校验" class="headerlink" title="用Entity封装单对象的有状态的行为，包括业务校验"></a>用Entity封装单对象的有状态的行为，包括业务校验</h3><p>用Account实体类封装所有Account的行为，包括业务校验如下：</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">@Data</span><br><span class="line"><span class="keyword">public</span> class Account &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> AccountId id;</span><br><span class="line">    <span class="keyword">private</span> AccountNumber accountNumber;</span><br><span class="line">    <span class="keyword">private</span> UserId userId;</span><br><span class="line">    <span class="keyword">private</span> Money <span class="built_in">available</span>;</span><br><span class="line">    <span class="keyword">private</span> Money dailyLimit;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Currency getCurrency() &#123;</span><br><span class="line">        <span class="built_in">return</span> <span class="keyword">this</span>.<span class="built_in">available</span>.getCurrency();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 转入</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> deposit(Money money) &#123;</span><br><span class="line">        <span class="built_in">if</span> (!<span class="keyword">this</span>.getCurrency().equals(money.getCurrency())) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InvalidCurrencyException();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.<span class="built_in">available</span> = <span class="keyword">this</span>.<span class="built_in">available</span>.add(money);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 转出</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> withdraw(Money money) &#123;</span><br><span class="line">        <span class="built_in">if</span> (<span class="keyword">this</span>.<span class="built_in">available</span>.compareTo(money) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InsufficientFundsException();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">if</span> (<span class="keyword">this</span>.dailyLimit.compareTo(money) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> DailyLimitExceededException();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.<span class="built_in">available</span> = <span class="keyword">this</span>.<span class="built_in">available</span>.subtract(money);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>原有的业务代码则可以简化为：<br><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sourceAccount.deposit(sourceMoney)<span class="comment">;</span></span><br><span class="line">targetAccount.withdraw(targetMoney)<span class="comment">;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="用Domain-Service封装多对象逻辑"><a href="#用Domain-Service封装多对象逻辑" class="headerlink" title="用Domain Service封装多对象逻辑"></a>用Domain Service封装多对象逻辑</h3><p>在这个案例里，我们发现这两个账号的转出和转入实际上是一体的，也就是说这种行为应该被封装到一个对象中去。特别是考虑到未来这个逻辑可能会产生变化：比如增加一个扣手续费的逻辑。这个时候在原有的TransferService中做并不合适，在任何一个Entity或者Domain Primitive里也不合适，需要有一个新的类去包含跨域对象的行为。这种对象叫做Domain Service。</p>
<p>我们创建一个AccountTransferService的类：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AccountTransferService</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">transfer</span><span class="params">(Account sourceAccount, Account targetAccount, Money targetMoney, ExchangeRate exchangeRate)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccountTransferServiceImpl</span> <span class="keyword">implements</span> <span class="title">AccountTransferService</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> ExchangeRateService exchangeRateService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transfer</span><span class="params">(Account sourceAccount, Account targetAccount, Money targetMoney, ExchangeRate exchangeRate)</span> </span>&#123;</span><br><span class="line">        Money sourceMoney = exchangeRate.exchangeTo(targetMoney);</span><br><span class="line">        sourceAccount.deposit(sourceMoney);</span><br><span class="line">        targetAccount.withdraw(targetMoney);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>而原始代码则简化为一行：<br><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">accountTransferService.<span class="built_in">transfer</span>(sourceAccount, targetAccount, targetMoney, exchangeRate);</span><br></pre></td></tr></table></figure></p>
<p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/v2-14d91a1f537b39307cf72a437ff3c60f_1440w.jpeg" alt="image"></p>
<h2 id="重构后结果分析"><a href="#重构后结果分析" class="headerlink" title="重构后结果分析"></a>重构后结果分析</h2><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransferServiceImplNew</span> <span class="keyword"><span class="keyword">implements</span> <span class="type">TransferService</span></span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> AccountRepository accountRepository;</span><br><span class="line">    <span class="keyword">private</span> AuditMessageProducer auditMessageProducer;</span><br><span class="line">    <span class="keyword">private</span> ExchangeRateService exchangeRateService;</span><br><span class="line">    <span class="keyword">private</span> AccountTransferService accountTransferService;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    <span class="keyword">public</span> Result&lt;Boolean&gt; transfer(Long sourceUserId, <span class="keyword">String</span> targetAccountNumber, BigDecimal targetAmount, <span class="keyword">String</span> targetCurrency) &#123;</span><br><span class="line">        <span class="comment">// 参数校验</span></span><br><span class="line">        Money targetMoney = <span class="keyword">new</span> <span class="type">Money</span>(targetAmount, <span class="keyword">new</span> <span class="type">Currency</span>(targetCurrency));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 读数据</span></span><br><span class="line">        Account sourceAccount = accountRepository.find(<span class="keyword">new</span> <span class="type">UserId</span>(sourceUserId));</span><br><span class="line">        Account targetAccount = accountRepository.find(<span class="keyword">new</span> <span class="type">AccountNumber</span>(targetAccountNumber));</span><br><span class="line">        ExchangeRate exchangeRate = exchangeRateService.getExchangeRate(sourceAccount.getCurrency(), targetMoney.getCurrency());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 业务逻辑</span></span><br><span class="line">        accountTransferService.transfer(sourceAccount, targetAccount, targetMoney, exchangeRate);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 保存数据</span></span><br><span class="line">        accountRepository.save(sourceAccount);</span><br><span class="line">        accountRepository.save(targetAccount);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 发送审计消息</span></span><br><span class="line">        AuditMessage message = <span class="keyword">new</span> <span class="type">AuditMessage</span>(sourceAccount, targetAccount, targetMoney);</span><br><span class="line">        auditMessageProducer.send(message);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.success(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看出来，经过重构后的代码有以下几个特征：</p>
<ul>
<li>业务逻辑清晰，数据存储和业务逻辑完全分隔。</li>
<li>Entity、Domain Primitive、Domain Service都是独立的对象，没有任何外部依赖，但是却包含了所有核心业务逻辑，可以单独完整测试。</li>
<li>原有的TransferService不再包括任何计算逻辑，仅仅作为组件编排，所有逻辑均delegate到其他组件。这种仅包含Orchestration（编排）的服务叫做Application Service（应用服务）。</li>
</ul>
<p>我们可以根据新的结构重新画一张图：</p>
<p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/v2-44ebd98e1697c75e119aa1d94a8f7768_1440w.jpeg" alt="image"></p>
<p>然后通过重新编排后该图变为：</p>
<p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/v2-5182bc6ecf7fe977b5968d9181a414aa_1440w.jpeg" alt="image"></p>
<p>我们可以发现，通过对外部依赖的抽象和内部逻辑的封装重构，应用整体的依赖关系变了：</p>
<ul>
<li>最底层不再是数据库，而是Entity、Domain Primitive和Domain Service。这些对象不依赖任何外部服务和框架，而是纯内存中的数据和操作。这些对象我们打包为Domain Layer（领域层）。领域层没有任何外部依赖关系。</li>
<li>再其次的是负责组件编排的Application Service，但是这些服务仅仅依赖了一些抽象出来的ACL类和Repository类，而其具体实现类是通过依赖注入注进来的。Application Service、Repository、ACL等我们统称为Application Layer（应用层）。应用层 依赖 领域层，但不依赖具体实现。</li>
<li>最后是ACL，Repository等的具体实现，这些实现通常依赖外部具体的技术实现和框架，所以统称为Infrastructure Layer（基础设施层）。Web框架里的对象如Controller之类的通常也属于基础设施层。</li>
<li></li>
</ul>
<p>如果今天能够重新写这段代码，考虑到最终的依赖关系，我们可能先写Domain层的业务逻辑，然后再写Application层的组件编排，最后才写每个外部依赖的具体实现。这种架构思路和代码组织结构就叫做Domain-Driven Design（领域驱动设计，或DDD）。所以DDD不是一个特殊的架构设计，而是所有Transction Script代码经过合理重构后一定会抵达的终点。</p>
<h2 id="DDD的六边形架构"><a href="#DDD的六边形架构" class="headerlink" title="DDD的六边形架构"></a>DDD的六边形架构</h2><p>在我们传统的代码里，我们一般都很注重每个外部依赖的实现细节和规范，但是今天我们需要敢于抛弃掉原有的理念，重新审视代码结构。在上面重构的代码里，如果抛弃掉所有Repository、ACL、Producer等的具体实现细节，我们会发现每一个对外部的抽象类其实就是输入或输出，类似于计算机系统中的I/O节点。这个观点在CQRS架构中也同样适用，将所有接口分为Command（输入）和Query（输出）两种。除了I/O之外其他的内部逻辑，就是应用业务的核心逻辑。基于这个基础，Alistair Cockburn在2005年提出了Hexagonal Architecture（六边形架构），又被称之为Ports and Adapters（端口和适配器架构）。</p>
<p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/v2-11af1ddff05b42025e83e204e71c9a5b_1440w.png" alt="image"></p>
<p>在这张图中：</p>
<ul>
<li>I/O的具体实现在模型的最外层</li>
<li>每个I/O的适配器在灰色地带</li>
<li>每个Hex的边是一个端口</li>
<li>Hex的中央是应用的核心领域模型</li>
</ul>
<p>在Hex中，架构的组织关系第一次变成了一个二维的内外关系，而不是传统一维的上下关系。同时在Hex架构中我们第一次发现UI层、DB层、和各种中间件层实际上是没有本质上区别的，都只是数据的输入和输出，而不是在传统架构中的最上层和最下层。</p>
<p>除了2005年的Hex架构，2008年 Jeffery Palermo的Onion Architecture（洋葱架构）和2017年 Robert Martin的Clean Architecture（干净架构），都是极为类似的思想。除了命名不一样、切入点不一样之外，其他的整体架构都是基于一个二维的内外关系。这也说明了基于DDD的架构最终的形态都是类似的。Herberto Graca有一个很全面的图包含了绝大部分现实中的端口类，值得借鉴。<br><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/v2-9e83433ede22b4d45e08c067b02e661f_1440w.jpeg" alt="image"></p>
<h3 id="代码组织结构"><a href="#代码组织结构" class="headerlink" title="代码组织结构"></a>代码组织结构</h3><p>为了有效的组织代码结构，避免下层代码依赖到上层实现的情况，在Java中我们可以通过POM Module和POM依赖来处理相互的关系。通过Spring/SpringBoot的容器来解决运行时动态注入具体实现的依赖的问题。一个简单的依赖关系图如下：<br><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/123312kjsalkdkal.jpeg" alt="image"></p>
<p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/v2-b3d0dccea152b7e846dc60ca3d615093_1440w.jpeg" alt="image"></p>
<h4 id="Types-模块"><a href="#Types-模块" class="headerlink" title="Types 模块"></a>Types 模块</h4><p>Types模块是保存可以对外暴露的Domain Primitives的地方。Domain Primitives因为是无状态的逻辑，可以对外暴露，所以经常被包含在对外的API接口中，需要单独成为模块。Types模块不依赖任何类库，纯 POJO 。</p>
<p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/v2-59a53da7e651770e2e1d96bafdf6a503_1440w.jpeg" alt="image"></p>
<h4 id="Domain-模块"><a href="#Domain-模块" class="headerlink" title="Domain 模块"></a>Domain 模块</h4><p>Domain 模块是核心业务逻辑的集中地，包含有状态的Entity、领域服务Domain Service、以及各种外部依赖的接口类（如Repository、ACL、中间件等。Domain模块仅依赖Types模块，也是纯 POJO 。</p>
<p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/v2-1c36105863c3f5187260a02548dd813b_1440w.jpeg" alt="image"></p>
<h4 id="Application模块"><a href="#Application模块" class="headerlink" title="Application模块"></a>Application模块</h4><p>Application模块主要包含Application Service和一些相关的类。Application模块依赖Domain模块。还是不依赖任何框架，纯POJO。<br><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/v2-b9a185f16cd6203796b582e7c43479d3_1440w.jpeg" alt="image"></p>
<h4 id="Infrastructure模块"><a href="#Infrastructure模块" class="headerlink" title="Infrastructure模块"></a>Infrastructure模块</h4><p>Infrastructure模块包含了Persistence、Messaging、External等模块。比如：Persistence模块包含数据库DAO的实现，包含Data Object、ORM Mapper、Entity到DO的转化类等。Persistence模块要依赖具体的ORM类库，比如MyBatis。如果需要用Spring-Mybatis提供的注解方案，则需要依赖Spring。</p>
<p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/v2-31fb63320e200bd58ec087ba4cab195d_1440w.jpeg" alt="image"></p>
<h4 id="Web模块"><a href="#Web模块" class="headerlink" title="Web模块"></a>Web模块</h4><p>Web模块包含Controller等相关代码。如果用SpringMVC则需要依赖Spring。<br><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/v2-71623c8f80edb4f7a6a0bceb8ebe85f5_1440w.jpeg" alt="image"></p>
<h4 id="Start模块"><a href="#Start模块" class="headerlink" title="Start模块"></a>Start模块</h4><p>Start模块是SpringBoot的启动类。</p>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><ul>
<li>Types，Domain模块都属于无外部依赖的纯POJO，基本上都可以100%的被单元测试覆盖。</li>
<li>Application模块的代码依赖外部抽象类，需要通过测试框架去Mock所有外部依赖，但仍然可以100%被单元测试。</li>
<li>Infrastructure的每个模块的代码相对独立，接口数量比较少，相对比较容易写单测。但是由于依赖了外部I/O，速度上不可能很快，但好在模块的变动不会很频繁，属于一劳永逸。</li>
<li>Web模块有两种测试方法：通过Spring的MockMVC测试，或者通过HttpClient调用接口测试。但是在测试时最好把Controller依赖的服务类都Mock掉。一般来说当你把Controller的逻辑都后置到Application Service中时，Controller的逻辑变得极为简单，很容易100%覆盖。</li>
<li>Start模块：通常应用的集成测试写在start里。当其他模块的单元测试都能100%覆盖后，集成测试用来验证整体链路的真实性。</li>
</ul>
<h2 id="代码的演进-变化速度"><a href="#代码的演进-变化速度" class="headerlink" title="代码的演进/变化速度"></a>代码的演进/变化速度</h2><p>在传统架构中，代码从上到下的变化速度基本上是一致的，改个需求需要从接口、到业务逻辑、到数据库全量变更，而第三方变更可能会导致整个代码的重写。但是在DDD中不同模块的代码的演进速度是不一样的：</p>
<ul>
<li>Domain层属于核心业务逻辑，属于经常被修改的地方。比如：原来不需要扣手续费，现在需要了之类的。通过Entity能够解决基于单个对象的逻辑变更，通过Domain Service解决多个对象间的业务逻辑变更。</li>
<li>Application层属于Use Case（业务用例）。业务用例一般都是描述比较大方向的需求，接口相对稳定，特别是对外的接口一般不会频繁变更。添加业务用例可以通过新增Application Service或者新增接口实现功能的扩展。</li>
<li>Infrastructure层属于最低频变更的。一般这个层的模块只有在外部依赖变更了之后才会跟着升级，而外部依赖的变更频率一般远低于业务逻辑的变更频率。<br>所以在DDD架构中，能明显看出越外层的代码越稳定，越内层的代码演进越快，真正体现了领域“驱动”的核心思想。</li>
</ul>
<h2 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h2><p>DDD不是一个什么特殊的架构，而是任何传统代码经过合理的重构之后最终一定会抵达的终点。DDD的架构能够有效的解决传统架构中的问题：</p>
<ul>
<li>高可维护性：当外部依赖变更时，内部代码只用变更跟外部对接的模块，其他业务逻辑不变。</li>
<li>高可扩展性：做新功能时，绝大部分的代码都能复用，仅需要增加核心业务逻辑即可。</li>
<li>高可测试性：每个拆分出来的模块都符合单一性原则，绝大部分不依赖框架，可以快速的单元测试，做到100%覆盖。</li>
<li>代码结构清晰：通过POM module可以解决模块间的依赖关系， 所有外接模块都可以单独独立成Jar包被复用。当团队形成规范后，可以快速的定位到相关代码。</li>
</ul>
<h1 id="Repository模式"><a href="#Repository模式" class="headerlink" title="Repository模式"></a>Repository模式</h1><p>为什么要用 Repository</p>
<blockquote>
<p>实体模型 vs. 贫血模型</p>
</blockquote>
<p>Entity（实体）这个词在计算机领域的最初应用可能是来自于Peter Chen在1976年的“The Entity-Relationship Model - Toward a Unified View of Data”（ER模型），用来描述实体之间的关系，而ER模型后来逐渐的演变成为一个数据模型，在关系型数据库中代表了数据的储存方式。而2006年的JPA标准，通过@Entity等注解，以及Hibernate等ORM框架的实现，让很多Java开发对Entity的理解停留在了数据映射层面，忽略了Entity实体的本身行为，造成今天很多的模型仅包含了实体的数据和属性，而所有的业务逻辑都被分散在多个服务、Controller、Utils工具类中，这个就是Martin Fowler所说的的Anemic Domain Model（贫血领域模型）。如何知道你的模型是贫血的呢？可以看一下你代码中是否有以下的几个特征：</p>
<ul>
<li>有大量的XxxDO对象：这里DO虽然有时候代表了Domain Object，但实际上仅仅是数据库表结构的映射，里面没有包含（或包含了很少的）业务逻辑；</li>
<li>服务和Controller里有大量的业务逻辑：比如校验逻辑、计算逻辑、格式转化逻辑、对象关系逻辑、数据存储逻辑等；</li>
<li>大量的Utils工具类等。</li>
</ul>
<p>而贫血模型的缺陷是非常明显的：</p>
<ul>
<li>无法保护模型对象的完整性和一致性：因为对象的所有属性都是公开的，只能由调用方来维护模型的一致性，而这个是没有保障的；之前曾经出现的案例就是调用方没有能维护模型数据的一致性，导致脏数据使用时出现bug，这一类的 bug还特别隐蔽，很难排查到。</li>
<li>对象操作的可发现性极差：单纯从对象的属性上很难看出来都有哪些业务逻辑，什么时候可以被调用，以及可以赋值的边界是什么；比如说，Long类型的值是否可以是0或者负数？</li>
<li>代码逻辑重复：比如校验逻辑、计算逻辑，都很容易出现在多个服务、多个代码块里，提升维护成本和bug出现的概率；一类常见的bug就是当贫血模型变更后，校验逻辑由于出现在多个地方，没有能跟着变，导致校验失败或失效。</li>
<li>代码的健壮性差：比如一个数据模型的变化可能导致从上到下的所有代码的变更。</li>
<li>强依赖底层实现：业务代码里强依赖了底层数据库、网络/中间件协议、第三方服务等，造成核心逻辑代码的僵化且维护成本高。</li>
</ul>
<p>虽然贫血模型有很大的缺陷，但是在我们日常的代码中，我见过的99%的代码都是基于贫血模型，为什么呢？我总结了以下几点：</p>
<ul>
<li>数据库思维：从有了数据库的那一天起，开发人员的思考方式就逐渐从“写业务逻辑“转变为了”写数据库逻辑”，也就是我们经常说的在写CRUD代码。</li>
<li>贫血模型“简单”：贫血模型的优势在于“简单”，仅仅是对数据库表的字段映射，所以可以从前到后用统一格式串通。这里简单打了引号，是因为它只是表面上的简单，实际上当未来有模型变更时，你会发现其实并不简单，每次变更都是非常复杂的事情</li>
<li>脚本思维：很多常见的代码都属于“脚本”或“胶水代码”，也就是流程式代码。脚本代码的好处就是比较容易理解，但长久来看缺乏健壮性，维护成本会越来越高。</li>
</ul>
<p>但是可能最核心的原因在于，实际上我们在日常开发中，混淆了两个概念：</p>
<ul>
<li>数据模型（Data Model）：指业务数据该如何持久化，以及数据之间的关系，也就是传统的ER模型；</li>
<li>业务模型/领域模型（Domain Model）：指业务逻辑中，相关联的数据该如何联动。</li>
</ul>
<p>所以，解决这个问题的根本方案，就是要在代码里严格区分Data Model和Domain Model，具体的规范会在后文详细描述。在真实代码结构中，Data Model和 Domain Model实际上会分别在不同的层里，Data Model只存在于数据层，而Domain Model在领域层，而链接了这两层的关键对象，就是Repository。</p>
<blockquote>
<p>Repository的价值</p>
</blockquote>
<p>在传统的数据库驱动开发中，我们会对数据库操作做一个封装，一般叫做Data Access Object（DAO）。DAO的核心价值是封装了拼接SQL、维护数据库连接、事务等琐碎的底层逻辑，让业务开发可以专注于写代码。但是在本质上，DAO的操作还是数据库操作，DAO的某个方法还是在直接操作数据库和数据模型，只是少写了部分代码。在Uncle Bob的《代码整洁之道》一书里，作者用了一个非常形象的描述：</p>
<ul>
<li>硬件（Hardware）：指创造了之后不可（或者很难）变更的东西。数据库对于开发来说，就属于”硬件“，数据库选型后基本上后面不会再变，比如：用了MySQL就很难再改为MongoDB，改造成本过高。</li>
<li>软件（Software）：指创造了之后可以随时修改的东西。对于开发来说，业务代码应该追求做”软件“，因为业务流程、规则在不停的变化，我们的代码也应该能随时变化。</li>
<li>固件（Firmware）：即那些强烈依赖了硬件的软件。我们常见的是路由器里的固件或安卓的固件等等。固件的特点是对硬件做了抽象，但仅能适配某款硬件，不能通用。所以今天不存在所谓的通用安卓固件，而是每个手机都需要有自己的固件。</li>
<li></li>
</ul>
<p>从上面的描述我们能看出来，数据库在本质上属于”硬件“，DAO 在本质上属于”固件“，而我们自己的代码希望是属于”软件“。但是，固件有个非常不好的特性，那就是会传播，也就是说当一个软件强依赖了固件时，由于固件的限制，会导致软件也变得难以变更，最终让软件变得跟固件一样难以变更。</p>
<h2 id="模型对象代码规范"><a href="#模型对象代码规范" class="headerlink" title="模型对象代码规范"></a>模型对象代码规范</h2><p>这边要解决这个问题，首先要指定编码规约</p>
<blockquote>
<p>对象类型</p>
</blockquote>
<p>在讲Repository规范之前，我们需要先讲清楚3种模型的区别，Entity、Data Object (DO)和Data Transfer Object (DTO)：</p>
<ul>
<li>Data Object （DO、数据对象）：实际上是我们在日常工作中最常见的数据模型。但是在DDD的规范里，DO应该仅仅作为数据库物理表格的映射，不能参与到业务逻辑中。为了简单明了，DO的字段类型和名称应该和数据库物理表格的字段类型和名称一一对应，这样我们不需要去跑到数据库上去查一个字段的类型和名称。（当然，实际上也没必要一摸一样，只要你在Mapper那一层做到字段映射）</li>
<li>Entity（实体对象）：实体对象是我们正常业务应该用的业务模型，它的字段和方法应该和业务语言保持一致，和持久化方式无关。也就是说，Entity和DO很可能有着完全不一样的字段命名和字段类型，甚至嵌套关系。Entity的生命周期应该仅存在于内存中，不需要可序列化和可持久化。</li>
<li>DTO（传输对象）：主要作为Application层的入参和出参，比如CQRS里的Command、Query、Event，以及Request、Response等都属于DTO的范畴。DTO的价值在于适配不同的业务场景的入参和出参，避免让业务对象变成一个万能大对象。</li>
</ul>
<h2 id="模型所在模块和转化器"><a href="#模型所在模块和转化器" class="headerlink" title="模型所在模块和转化器"></a>模型所在模块和转化器</h2><p>于现在从一个对象变为3+个对象，对象间需要通过转化器（Converter/Mapper）来互相转化。而这三种对象在代码中所在的位置也不一样，简单总结如下：<br><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/common/v2-93a7e4f3d3bda78cf8ba33411a5d3e2d_1440w.jpeg" alt="image"></p>
<blockquote>
<p>这边DO结尾的文件是跟数据库一一对应的，DTO是跟前端或者其他系统协商的，只有DTO需要序列化，Entity是不固定的，实际的属性设置是根据业务来的。这边我推荐用一个mapper层，所有文件都以Mapper结尾，在Mapper层做转换，这边具体的转换用一个工具很好用，叫MapStruct。</p>
</blockquote>
<p>从使用复杂度角度来看，区分了DO、Entity、DTO带来了代码量的膨胀（从1个变成了3+2+N个）。但是在实际复杂业务场景下，通过功能来区分模型带来的价值是功能性的单一和可测试、可预期，最终反而是逻辑复杂性的降低。</p>
<p>我自己的项目因为是简单的业务模型，所以用了通用的贫血模型，规范的项目目录结构如下所示（这边缺少了entity和防腐层的设计）：</p>
<p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/common/WechatIMG629.png" alt="image"></p>
<h1 id="DDD领域层的一些设计规范"><a href="#DDD领域层的一些设计规范" class="headerlink" title="DDD领域层的一些设计规范"></a>DDD领域层的一些设计规范</h1><p>上面我主要针对同一个例子对比了OOP、ECS和DDD的3种实现，比较如下：</p>
<ul>
<li>基于继承关系的OOP代码：OOP的代码最好写，也最容易理解，所有的规则代码都写在对象里，但是当领域规则变得越来越复杂时，其结构会限制它的发展。新的规则有可能会导致代码的整体重构。</li>
<li>基于组件化的ECS代码：ECS代码有最高的灵活性、可复用性、及性能，但极具弱化了实体类的内聚，所有的业务逻辑都写在了服务里，会导致业务的一致性无法保障，对商业系统会有较大的影响。</li>
<li>基于领域对象 + 领域服务的DDD架构：DDD的规则其实最复杂，同时要考虑到实体类的内聚和保证不变性（Invariants），也要考虑跨对象规则代码的归属，甚至要考虑到具体领域服务的调用方式，理解成本比较高。</li>
</ul>
<h2 id="实体类（Entity）"><a href="#实体类（Entity）" class="headerlink" title="实体类（Entity）"></a>实体类（Entity）</h2><p>大多数DDD架构的核心都是实体类，实体类包含了一个领域里的状态、以及对状态的直接操作。Entity最重要的设计原则是保证实体的不变性（Invariants），也就是说要确保无论外部怎么操作，一个实体内部的属性都不能出现相互冲突，状态不一致的情况。所以几个设计原则如下：</p>
<p>创建即一致<br>在贫血模型里，通常见到的代码是一个模型通过手动new出来之后，由调用方一个参数一个参数的赋值，这就很容易产生遗漏，导致实体状态不一致。所以DDD里实体创建的方法有两种：</p>
<p>constructor参数要包含所有必要属性，或者在constructor里有合理的默认值。</p>
<blockquote>
<p>使用Factory模式来降低调用方复杂度</p>
</blockquote>
<h3 id="尽量避免public-setter"><a href="#尽量避免public-setter" class="headerlink" title="尽量避免public setter"></a>尽量避免public setter</h3><p>一个最容易导致不一致性的原因是实体暴露了public的setter方法，特别是set单一参数会导致状态不一致的情况。比如，一个订单可能包含订单状态（下单、已支付、已发货、已收货）、支付单、物流单等子实体，如果一个调用方能随意去set订单状态，就有可能导致订单状态和子实体匹配不上，导致业务流程走不通的情况。所以在实体里，需要通过行为方法来修改内部状态。</p>
<h3 id="通过聚合根保证主子实体的一致性"><a href="#通过聚合根保证主子实体的一致性" class="headerlink" title="通过聚合根保证主子实体的一致性"></a>通过聚合根保证主子实体的一致性</h3><p>在稍微复杂一点的领域里，通常主实体会包含子实体，这时候主实体就需要起到聚合根的作用，即：</p>
<ul>
<li>子实体不能单独存在，只能通过聚合根的方法获取到。任何外部的对象都不能直接保留子实体的引用</li>
<li>子实体没有独立的Repository，不可以单独保存和取出，必须要通过聚合根的Repository实例化</li>
<li>子实体可以单独修改自身状态，但是多个子实体之间的状态一致性需要聚合根来保障</li>
</ul>
<p>常见的电商域中聚合的案例如主子订单模型、商品/SKU模型、跨子订单优惠、跨店优惠模型等。很多聚合根和Repository的设计规范在我前面一篇关于Repository的文章中已经详细解释过，可以拿来参考。</p>
<h3 id="不可以强依赖其他聚合根实体或领域服务"><a href="#不可以强依赖其他聚合根实体或领域服务" class="headerlink" title="不可以强依赖其他聚合根实体或领域服务"></a>不可以强依赖其他聚合根实体或领域服务</h3><p>一个实体的原则是高内聚、低耦合，即一个实体类不能直接在内部直接依赖一个外部的实体或服务。这个原则和绝大多数ORM框架都有比较严重的冲突，所以是一个在开发过程中需要特别注意的。这个原则的必要原因包括：对外部对象的依赖性会直接导致实体无法被单测；以及一个实体无法保证外部实体变更后不会影响本实体的一致性和正确性。</p>
<p>所以，正确的对外部依赖的方法有两种：</p>
<ul>
<li>只保存外部实体的ID：这里我再次强烈建议使用强类型的ID对象，而不是Long型ID。强类型的ID对象不单单能自我包含验证代码，保证ID值的正确性，同时还能确保各种入参不会因为参数顺序变化而出bug。具体可以参考Domain Primitive。</li>
<li>针对于“无副作用”的外部依赖，通过方法入参的方式传入。比如上文中的equip(Weapon，EquipmentService）方法。</li>
</ul>
<p>如果方法对外部依赖有副作用，不能通过方法入参的方式，只能通过Domain Service解决，见下文。</p>
<h3 id="任何实体的行为只能直接影响到本实体（和其子实体）"><a href="#任何实体的行为只能直接影响到本实体（和其子实体）" class="headerlink" title="任何实体的行为只能直接影响到本实体（和其子实体）"></a>任何实体的行为只能直接影响到本实体（和其子实体）</h3><p>这个原则更多是一个确保代码可读性、可理解的原则，即任何实体的行为不能有“直接”的”副作用“，即直接修改其他的实体类。这么做的好处是代码读下来不会产生意外。</p>
<p>另一个遵守的原因是可以降低未知的变更的风险。在一个系统里一个实体对象的所有变更操作应该都是预期内的，如果一个实体能随意被外部直接修改的话，会增加代码bug的风险。</p>
<h2 id="领域服务（Domain-Service）"><a href="#领域服务（Domain-Service）" class="headerlink" title="领域服务（Domain Service）"></a>领域服务（Domain Service）</h2><p>在上文讲到，领域服务其实也分很多种，在这里根据上文总结出来三种常见的：</p>
<h3 id="单对象策略型"><a href="#单对象策略型" class="headerlink" title="单对象策略型"></a>单对象策略型</h3><p>这种领域对象主要面向的是单个实体对象的变更，但涉及到多个领域对象或外部依赖的一些规则。在上文中，EquipmentService即为此类：</p>
<ul>
<li>变更的对象是Player的参数</li>
<li>读取的是Player和Weapon的数据，可能还包括从外部读取一些数据</li>
</ul>
<p>在这种类型下，实体应该通过方法入参的方式传入这种领域服务，然后通过Double Dispatch来反转调用领域服务的方法。</p>
<h3 id="跨对象事务型"><a href="#跨对象事务型" class="headerlink" title="跨对象事务型"></a>跨对象事务型</h3><p>当一个行为会直接修改多个实体时，不能再通过单一实体的方法作处理，而必须直接使用领域服务的方法来做操作。在这里，领域服务更多的起到了跨对象事务的作用，确保多个实体的变更之间是有一致性的。</p>
<h3 id="通用组件型"><a href="#通用组件型" class="headerlink" title="通用组件型"></a>通用组件型</h3><p>这种类型的领域服务更像ECS里的System，提供了组件化的行为，但本身又不直接绑死在一种实体类上。</p>
<h2 id="策略对象（Domain-Policy）"><a href="#策略对象（Domain-Policy）" class="headerlink" title="策略对象（Domain Policy）"></a>策略对象（Domain Policy）</h2><p>Policy或者Strategy设计模式是一个通用的设计模式，但是在DDD架构中会经常出现，其核心就是封装领域规则。</p>
<p>一个Policy是一个无状态的单例对象，通常需要至少2个方法：canApply 和 一个业务方法。其中，canApply方法用来判断一个Policy是否适用于当前的上下文，如果适用则调用方会去触发业务方法。通常，为了降低一个Policy的可测试性和复杂度，Policy不应该直接操作对象，而是通过返回计算后的值，在Domain Service里对对象进行操作。</p>
<p>除了本文里静态注入多个Policy以及手动排优先级之外，在日常开发中经常能见到通过Java的SPI机制或类SPI机制注册Policy，以及通过不同的Priority方案对Policy进行排序，在这里就不作太多的展开了。</p>
<h2 id="领域事件介绍"><a href="#领域事件介绍" class="headerlink" title="领域事件介绍"></a>领域事件介绍</h2><p>领域事件是一个在领域里发生了某些事后，希望领域里其他对象能够感知到的通知机制。在上面的案例里，代码之所以会越来越复杂，其根本的原因是反应代码（比如升级）直接和上面的事件触发条件（比如收到经验）直接耦合，而且这种耦合性是隐性的。领域事件的好处就是将这种隐性的副作用“显性化”，通过一个显性的事件，将事件触发和事件处理解耦，最终起到代码更清晰、扩展性更好的目的。</p>
<p>所以，领域事件是在DDD里，比较推荐使用的跨实体“副作用”传播机制。</p>
<h3 id="领域事件实现"><a href="#领域事件实现" class="headerlink" title="领域事件实现"></a>领域事件实现</h3><p>和消息队列中间件不同的是，领域事件通常是立即执行的、在同一个进程内、可能是同步或异步。我们可以通过一个EventBus来实现进程内的通知机制，简单实现如下：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 实现者：瑜进 2019/11/28</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EventBus</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册器</span></span><br><span class="line">    @Getter</span><br><span class="line">    <span class="keyword">private</span> final EventRegistry invokerRegistry = <span class="keyword">new</span> EventRegistry(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 事件分发器</span></span><br><span class="line">    <span class="keyword">private</span> final EventDispatcher dispatcher = <span class="keyword">new</span> EventDispatcher(ExecutorFactory.getDirectExecutor());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 异步事件分发器</span></span><br><span class="line">    <span class="keyword">private</span> final EventDispatcher asyncDispatcher = <span class="keyword">new</span> EventDispatcher(ExecutorFactory.getThreadPoolExecutor());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 事件分发</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> boolean <span class="title">dispatch</span>(<span class="params">Event <span class="keyword">event</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> dispatch(<span class="keyword">event</span>, dispatcher);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 异步事件分发</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> boolean <span class="title">dispatchAsync</span>(<span class="params">Event <span class="keyword">event</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> dispatch(<span class="keyword">event</span>, asyncDispatcher);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 内部事件分发</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> boolean <span class="title">dispatch</span>(<span class="params">Event <span class="keyword">event</span>, EventDispatcher dispatcher</span>) </span>&#123;</span><br><span class="line">        checkEvent(<span class="keyword">event</span>);</span><br><span class="line">        <span class="comment">// 1.获取事件数组</span></span><br><span class="line">        Set&lt;Invoker&gt; invokers = invokerRegistry.getInvokers(<span class="keyword">event</span>);</span><br><span class="line">        <span class="comment">// 2.一个事件可以被监听N次，不关心调用结果</span></span><br><span class="line">        dispatcher.dispatch(<span class="keyword">event</span>, invokers);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 事件总线注册</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span>(<span class="params">Object listener</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (listener == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"listener can not be null!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        invokerRegistry.register(listener);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkEvent</span>(<span class="params">Event <span class="keyword">event</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">event</span> == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"event"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!(<span class="keyword">event</span> instanceof Event)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Event type must by "</span> + Event.class);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用方式：<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">LevelUpEvent</span> <span class="title">implements</span> <span class="title">Event</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Player player;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">LevelUpHandler</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span>(<span class="params">Player player</span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Player</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receiveExp</span>(<span class="params"><span class="keyword">int</span> <span class="keyword">value</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.exp += <span class="keyword">value</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.exp &gt;= <span class="number">100</span>) &#123;</span><br><span class="line">            LevelUpEvent <span class="keyword">event</span> = <span class="keyword">new</span> LevelUpEvent(<span class="keyword">this</span>);</span><br><span class="line">            EventBus.dispatch(<span class="keyword">event</span>);</span><br><span class="line">            <span class="keyword">this</span>.exp = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">@Test</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    EventBus.register(<span class="keyword">new</span> LevelUpHandler());</span><br><span class="line">    player.setLevel(<span class="number">1</span>);</span><br><span class="line">    player.receiveExp(<span class="number">100</span>);</span><br><span class="line">    assertThat(player.getLevel()).<span class="keyword">equals</span>(<span class="number">2</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="目前领域事件的缺陷和展望"><a href="#目前领域事件的缺陷和展望" class="headerlink" title="目前领域事件的缺陷和展望"></a>目前领域事件的缺陷和展望</h2><p>从上面代码可以看出来，领域事件的很好的实施依赖EventBus、Dispatcher、Invoker这些属于框架级别的支持。同时另一个问题是因为Entity不能直接依赖外部对象，所以EventBus目前只能是一个全局的Singleton，而大家都应该知道全局Singleton对象很难被单测。这就容易导致Entity对象无法被很容易的被完整单测覆盖全。</p>
<p>另一种解法是侵入Entity，对每个Entity增加一个List:<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Player</span> &#123;</span><br><span class="line">  List&lt;Event&gt; events;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receiveExp</span>(<span class="params"><span class="keyword">int</span> <span class="keyword">value</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.exp += <span class="keyword">value</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.exp &gt;= <span class="number">100</span>) &#123;</span><br><span class="line">            LevelUpEvent <span class="keyword">event</span> = <span class="keyword">new</span> LevelUpEvent(<span class="keyword">this</span>);</span><br><span class="line">            events.<span class="keyword">add</span>(<span class="keyword">event</span>); <span class="comment">// 把event加进去</span></span><br><span class="line">            <span class="keyword">this</span>.exp = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Test</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    EventBus.register(<span class="keyword">new</span> LevelUpHandler());</span><br><span class="line">    player.setLevel(<span class="number">1</span>);</span><br><span class="line">    player.receiveExp(<span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(Event <span class="keyword">event</span>: player.getEvents()) &#123; <span class="comment">// 在这里显性的dispatch事件</span></span><br><span class="line">        EventBus.dispatch(<span class="keyword">event</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    assertThat(player.getLevel()).<span class="keyword">equals</span>(<span class="number">2</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>但是能看出来这种解法不但会侵入实体本身，同时也需要比较啰嗦的显性在调用方dispatch事件，也不是一个好的解决方案。</p>
<p>也许未来会有一个框架能让我们既不依赖全局Singleton，也不需要显性去处理事件，但目前的方案基本都有或多或少的缺陷，大家在使用中可以注意。</p>
<h1 id="总结-2"><a href="#总结-2" class="headerlink" title="总结"></a>总结</h1><p>在真实的业务逻辑里，我们的领域模型或多或少的都有一定的“特殊性”，如果100%的要符合DDD规范可能会比较累，所以最主要的是梳理一个对象行为的影响面，然后作出设计决策，即：</p>
<ul>
<li>是仅影响单一对象还是多个对象，</li>
<li>规则未来的拓展性、灵活性，</li>
<li>性能要求，</li>
<li>副作用的处理，等等</li>
</ul>
<p>当然，很多时候一个好的设计是多种因素的取舍，需要大家有一定的积累，真正理解每个架构背后的逻辑和优缺点。一个好的架构师不是有一个正确答案，而是能从多个方案中选出一个最平衡的方案。</p>
<p>参考文章：</p>
<ul>
<li><a href="https://zhuanlan.zhihu.com/p/340911587" target="_blank" rel="noopener">阿里技术专家详解 DDD 系列 第一讲- Domain Primitive</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/343388831" target="_blank" rel="noopener">阿里技术专家详解DDD系列 第二讲 - 应用架构</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/348706530" target="_blank" rel="noopener">阿里技术专家详解DDD系列 第三讲 - Repository模式</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/356518017" target="_blank" rel="noopener">阿里技术专家详解DDD系列 第四讲 - 领域层设计规范</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dinghuang.github.io/2020/12/11/Skyworking实践/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="强壮的病猫">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/dinghuang.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一只病猫">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/12/11/Skyworking实践/" itemprop="url">Skyworking实践</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-12-11T15:47:00+08:00">
                2020-12-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JAVA/" itemprop="url" rel="index">
                    <span itemprop="name">JAVA</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/12/11/Skyworking实践/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/12/11/Skyworking实践/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>SkyWalking是一个开源的可观察性平台，用于收集，分析，聚合和可视化来自服务和云本机基础结构的数据。SkyWalking提供了一种简便的方法来维护您的分布式系统的清晰视图，即使在整个云中也是如此。它是一种现代APM，专门为基于云的基于容器的分布式系统而设计。</p>
<h2 id="为什么要使用SkyWalking"><a href="#为什么要使用SkyWalking" class="headerlink" title="为什么要使用SkyWalking"></a>为什么要使用SkyWalking</h2><p>SkyWalking提供了用于在许多不同情况下观察和监视分布式系统的解决方案。首先，与传统方法一样，SkyWalking为服务提供自动仪器代理，例如Java，C＃，Node.js，Go，PHP和Nginx LUA。（并呼吁提供Python和C ++ SDK贡献）。在多语言，持续部署的环境中，云本机基础架构变得越来越强大，但也越来越复杂。SkyWalking的服务网格接收器使SkyWalking能够从Istio / Envoy和Linkerd等服务网格框架接收遥测数据，从而使用户能够了解整个分布式系统。</p>
<p>SkyWalking为服务，服务实例，端点提供可观察性功能。服务，实例和端点这些术语在当今到处都有使用，因此值得在SkyWalking的上下文中定义它们的特定含义：</p>
<ul>
<li>服务。表示一组/一组工作负载，这些工作负载为传入请求提供相同的行为。您可以在使用乐器代理或SDK时定义服务名称。SkyWalking也可以使用您在Istio等平台中定义的名称。</li>
<li>服务实例。服务组中的每个单独工作负载都称为实例。像pods在Kubernetes中一样，它不必是单个OS进程，但是，如果您使用仪器代理，则实例实际上是一个真正的OS进程。</li>
<li>端点。服务中用于传入请求的路径，例如HTTP URI路径或gRPC服务类+方法签名。<br>通过SkyWalking，用户可以了解服务和端点之间的拓扑关系，查看每个服务/服务实例/端点的指标并设置警报规则。</li>
</ul>
<p>此外，可以整合</p>
<ul>
<li>其他使用SkyWalking本机代理程序和SDK以及Zipkin，Jaeger和OpenCensus进行的分布式跟踪。</li>
<li>其他度量系统，例如Prometheus，Sleuth（Micrometer）。</li>
</ul>
<h2 id="架构设计"><a href="#架构设计" class="headerlink" title="架构设计"></a>架构设计</h2><p>SkyWalking分为四个部分：</p>
<ul>
<li>探针：收集数据并重新格式化以符合SkyWalking要求（不同的探针支持不同的来源）。</li>
<li>平台后端：支持数据聚合，分析并驱动从探针到UI的流程。该分析包括SkyWalking本机跟踪和度量标准，包括Istio和Envoy遥测的第三方，Zipkin跟踪格式等。您甚至可以通过使用针对本机度量标准的Observability Analysis Language和针对扩展度量标准的Meter System来定制聚合和分析。</li>
<li>存储：存储设备通过开放/可插入的界面存储SkyWalking数据。您可以选择现有的实现，例如ElasticSearch，H2或由Sharding-Sphere管理的MySQL集群，也可以实现自己的实现。欢迎新存储实现者使用补丁！</li>
<li>UI：是一个高度可定制的基于Web的界面，允许SkyWalking最终用户可视化和管理SkyWalking数据。</li>
</ul>
<p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/687474703a2f2f736b7977616c6b696e672e6170616368652e6f72672f6173736574732f6672616d652d76382e6a70673f753d3230323030343233.jpeg" alt="image"></p>
<h1 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h1><p>本文章基于官方源码tag:<code>v8.3.0</code></p>
<h2 id="源码编译"><a href="#源码编译" class="headerlink" title="源码编译"></a>源码编译</h2><p>修改<code>.mvn/jvm.config</code><br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-Dhttp.<span class="attribute">proxyHost</span>=proxy_ip</span><br><span class="line">-Dhttp.<span class="attribute">proxyPort</span>=proxy_port</span><br><span class="line">-Dhttps.<span class="attribute">proxyHost</span>=proxy_ip</span><br><span class="line">-Dhttps.<span class="attribute">proxyPort</span>=proxy_port </span><br><span class="line">-Dhttp.<span class="attribute">proxyUser</span>=username</span><br><span class="line">-Dhttp.<span class="attribute">proxyPassword</span>=password</span><br></pre></td></tr></table></figure></p>
<p>下载git源码<br><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">git</span> clone --<span class="keyword">branch </span><span class="built_in">v8</span>.<span class="number">3</span>.<span class="number">0</span> https://github.com/apache/skywalking.git</span><br><span class="line"><span class="symbol">git</span> <span class="keyword">submodule </span>init</span><br><span class="line"><span class="symbol">git</span> <span class="keyword">submodule </span>update</span><br></pre></td></tr></table></figure></p>
<p>执行编译<br><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./mvnw clean <span class="keyword">package</span> <span class="title">-DskipTests</span></span><br></pre></td></tr></table></figure></p>
<p>打包后的都会在<code>/dist</code>目录下</p>
<h2 id="下载制品"><a href="#下载制品" class="headerlink" title="下载制品"></a>下载制品</h2><p>推荐直接下载<a href="https://mirror.bit.edu.cn/apache/skywalking/8.3.0/apache-skywalking-apm-8.3.0.tar.gz" target="_blank" rel="noopener">成品</a></p>
<h2 id="服务启动"><a href="#服务启动" class="headerlink" title="服务启动"></a>服务启动</h2><p>进入目录<code>/bin</code>，windows和linux的启动脚本都在里面，可以直接启动。</p>
<p>执行命令<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.<span class="regexp">/dist-material/</span>bin<span class="regexp">/startup.sh</span></span><br></pre></td></tr></table></figure></p>
<p>现在服务端就启起来了，可以打开后台地址查看(默认是8080端口): <a href="http://localhost:8080,界面如下：" target="_blank" rel="noopener">http://localhost:8080,界面如下：</a><br><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/WechatIMG8155.png" alt="image"><br><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/WechatIMG8158.png" alt="image"></p>
<p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/WechatIMG8162.png" alt="image"></p>
<p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/WechatIMG8153.png" alt="image"></p>
<p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/WechatIMG8154.png" alt="image"></p>
<p>客户端需要提前准备开墙信息，默认的启动端口是8080，数据采集的端口是11800</p>
<p>默认的存储是用内存数据库H2来存储的，建议改掉，不然数据会跟着服务重启丢失，而且服务占用内存会很大。修改的话在目录<code>/config</code>下有3个文件可以改：</p>
<ul>
<li>application.yml</li>
<li>log4j.xml</li>
<li>alarm-settings.yml</li>
</ul>
<p>其中<code>application.yml</code>配置如下<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">cluster:</span></span><br><span class="line"><span class="attr">  selector:</span> <span class="string">$&#123;SW_CLUSTER:standalone&#125;</span></span><br><span class="line"><span class="attr">  standalone:</span></span><br><span class="line">  <span class="comment"># Please check your ZooKeeper is 3.5+, However, it is also compatible with ZooKeeper 3.4.x. Replace the ZooKeeper 3.5+</span></span><br><span class="line">  <span class="comment"># library the oap-libs folder with your ZooKeeper 3.4.x library.</span></span><br><span class="line"><span class="attr">  zookeeper:</span></span><br><span class="line"><span class="attr">    nameSpace:</span> <span class="string">$&#123;SW_NAMESPACE:""&#125;</span></span><br><span class="line"><span class="attr">    hostPort:</span> <span class="string">$&#123;SW_CLUSTER_ZK_HOST_PORT:localhost:2181&#125;</span></span><br><span class="line">    <span class="comment"># Retry Policy</span></span><br><span class="line"><span class="attr">    baseSleepTimeMs:</span> <span class="string">$&#123;SW_CLUSTER_ZK_SLEEP_TIME:1000&#125;</span> <span class="comment"># initial amount of time to wait between retries</span></span><br><span class="line"><span class="attr">    maxRetries:</span> <span class="string">$&#123;SW_CLUSTER_ZK_MAX_RETRIES:3&#125;</span> <span class="comment"># max number of times to retry</span></span><br><span class="line">    <span class="comment"># Enable ACL</span></span><br><span class="line"><span class="attr">    enableACL:</span> <span class="string">$&#123;SW_ZK_ENABLE_ACL:false&#125;</span> <span class="comment"># disable ACL in default</span></span><br><span class="line"><span class="attr">    schema:</span> <span class="string">$&#123;SW_ZK_SCHEMA:digest&#125;</span> <span class="comment"># only support digest schema</span></span><br><span class="line"><span class="attr">    expression:</span> <span class="string">$&#123;SW_ZK_EXPRESSION:skywalking:skywalking&#125;</span></span><br><span class="line"><span class="attr">  kubernetes:</span></span><br><span class="line"><span class="attr">    namespace:</span> <span class="string">$&#123;SW_CLUSTER_K8S_NAMESPACE:default&#125;</span></span><br><span class="line"><span class="attr">    labelSelector:</span> <span class="string">$&#123;SW_CLUSTER_K8S_LABEL:app=collector,release=skywalking&#125;</span></span><br><span class="line"><span class="attr">    uidEnvName:</span> <span class="string">$&#123;SW_CLUSTER_K8S_UID:SKYWALKING_COLLECTOR_UID&#125;</span></span><br><span class="line"><span class="attr">  consul:</span></span><br><span class="line"><span class="attr">    serviceName:</span> <span class="string">$&#123;SW_SERVICE_NAME:"SkyWalking_OAP_Cluster"&#125;</span></span><br><span class="line">    <span class="comment"># Consul cluster nodes, example: 10.0.0.1:8500,10.0.0.2:8500,10.0.0.3:8500</span></span><br><span class="line"><span class="attr">    hostPort:</span> <span class="string">$&#123;SW_CLUSTER_CONSUL_HOST_PORT:localhost:8500&#125;</span></span><br><span class="line"><span class="attr">    aclToken:</span> <span class="string">$&#123;SW_CLUSTER_CONSUL_ACLTOKEN:""&#125;</span></span><br><span class="line"><span class="attr">  etcd:</span></span><br><span class="line"><span class="attr">    serviceName:</span> <span class="string">$&#123;SW_SERVICE_NAME:"SkyWalking_OAP_Cluster"&#125;</span></span><br><span class="line">    <span class="comment"># etcd cluster nodes, example: 10.0.0.1:2379,10.0.0.2:2379,10.0.0.3:2379</span></span><br><span class="line"><span class="attr">    hostPort:</span> <span class="string">$&#123;SW_CLUSTER_ETCD_HOST_PORT:localhost:2379&#125;</span></span><br><span class="line"><span class="attr">  nacos:</span></span><br><span class="line"><span class="attr">    serviceName:</span> <span class="string">$&#123;SW_SERVICE_NAME:"SkyWalking_OAP_Cluster"&#125;</span></span><br><span class="line"><span class="attr">    hostPort:</span> <span class="string">$&#123;SW_CLUSTER_NACOS_HOST_PORT:localhost:8848&#125;</span></span><br><span class="line">    <span class="comment"># Nacos Configuration namespace</span></span><br><span class="line"><span class="attr">    namespace:</span> <span class="string">$&#123;SW_CLUSTER_NACOS_NAMESPACE:"public"&#125;</span></span><br><span class="line">    <span class="comment"># Nacos auth username</span></span><br><span class="line"><span class="attr">    username:</span> <span class="string">$&#123;SW_CLUSTER_NACOS_USERNAME:""&#125;</span></span><br><span class="line"><span class="attr">    password:</span> <span class="string">$&#123;SW_CLUSTER_NACOS_PASSWORD:""&#125;</span></span><br><span class="line">    <span class="comment"># Nacos auth accessKey</span></span><br><span class="line"><span class="attr">    accessKey:</span> <span class="string">$&#123;SW_CLUSTER_NACOS_ACCESSKEY:""&#125;</span></span><br><span class="line"><span class="attr">    secretKey:</span> <span class="string">$&#123;SW_CLUSTER_NACOS_SECRETKEY:""&#125;</span></span><br><span class="line"><span class="attr">core:</span></span><br><span class="line"><span class="attr">  selector:</span> <span class="string">$&#123;SW_CORE:default&#125;</span></span><br><span class="line"><span class="attr">  default:</span></span><br><span class="line">    <span class="comment"># Mixed: Receive agent data, Level 1 aggregate, Level 2 aggregate</span></span><br><span class="line">    <span class="comment"># Receiver: Receive agent data, Level 1 aggregate</span></span><br><span class="line">    <span class="comment"># Aggregator: Level 2 aggregate</span></span><br><span class="line"><span class="attr">    role:</span> <span class="string">$&#123;SW_CORE_ROLE:Mixed&#125;</span> <span class="comment"># Mixed/Receiver/Aggregator</span></span><br><span class="line"><span class="attr">    restHost:</span> <span class="string">$&#123;SW_CORE_REST_HOST:0.0.0.0&#125;</span></span><br><span class="line"><span class="attr">    restPort:</span> <span class="string">$&#123;SW_CORE_REST_PORT:12800&#125;</span></span><br><span class="line"><span class="attr">    restContextPath:</span> <span class="string">$&#123;SW_CORE_REST_CONTEXT_PATH:/&#125;</span></span><br><span class="line"><span class="attr">    restMinThreads:</span> <span class="string">$&#123;SW_CORE_REST_JETTY_MIN_THREADS:1&#125;</span></span><br><span class="line"><span class="attr">    restMaxThreads:</span> <span class="string">$&#123;SW_CORE_REST_JETTY_MAX_THREADS:200&#125;</span></span><br><span class="line"><span class="attr">    restIdleTimeOut:</span> <span class="string">$&#123;SW_CORE_REST_JETTY_IDLE_TIMEOUT:30000&#125;</span></span><br><span class="line"><span class="attr">    restAcceptorPriorityDelta:</span> <span class="string">$&#123;SW_CORE_REST_JETTY_DELTA:0&#125;</span></span><br><span class="line"><span class="attr">    restAcceptQueueSize:</span> <span class="string">$&#123;SW_CORE_REST_JETTY_QUEUE_SIZE:0&#125;</span></span><br><span class="line"><span class="attr">    gRPCHost:</span> <span class="string">$&#123;SW_CORE_GRPC_HOST:0.0.0.0&#125;</span></span><br><span class="line"><span class="attr">    gRPCPort:</span> <span class="string">$&#123;SW_CORE_GRPC_PORT:11800&#125;</span></span><br><span class="line"><span class="attr">    maxConcurrentCallsPerConnection:</span> <span class="string">$&#123;SW_CORE_GRPC_MAX_CONCURRENT_CALL:0&#125;</span></span><br><span class="line"><span class="attr">    maxMessageSize:</span> <span class="string">$&#123;SW_CORE_GRPC_MAX_MESSAGE_SIZE:0&#125;</span></span><br><span class="line"><span class="attr">    gRPCThreadPoolQueueSize:</span> <span class="string">$&#123;SW_CORE_GRPC_POOL_QUEUE_SIZE:-1&#125;</span></span><br><span class="line"><span class="attr">    gRPCThreadPoolSize:</span> <span class="string">$&#123;SW_CORE_GRPC_THREAD_POOL_SIZE:-1&#125;</span></span><br><span class="line"><span class="attr">    gRPCSslEnabled:</span> <span class="string">$&#123;SW_CORE_GRPC_SSL_ENABLED:false&#125;</span></span><br><span class="line"><span class="attr">    gRPCSslKeyPath:</span> <span class="string">$&#123;SW_CORE_GRPC_SSL_KEY_PATH:""&#125;</span></span><br><span class="line"><span class="attr">    gRPCSslCertChainPath:</span> <span class="string">$&#123;SW_CORE_GRPC_SSL_CERT_CHAIN_PATH:""&#125;</span></span><br><span class="line"><span class="attr">    gRPCSslTrustedCAPath:</span> <span class="string">$&#123;SW_CORE_GRPC_SSL_TRUSTED_CA_PATH:""&#125;</span></span><br><span class="line"><span class="attr">    downsampling:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">Hour</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">Day</span></span><br><span class="line">    <span class="comment"># Set a timeout on metrics data. After the timeout has expired, the metrics data will automatically be deleted.</span></span><br><span class="line"><span class="attr">    enableDataKeeperExecutor:</span> <span class="string">$&#123;SW_CORE_ENABLE_DATA_KEEPER_EXECUTOR:true&#125;</span> <span class="comment"># Turn it off then automatically metrics data delete will be close.</span></span><br><span class="line"><span class="attr">    dataKeeperExecutePeriod:</span> <span class="string">$&#123;SW_CORE_DATA_KEEPER_EXECUTE_PERIOD:5&#125;</span> <span class="comment"># How often the data keeper executor runs periodically, unit is minute</span></span><br><span class="line"><span class="attr">    recordDataTTL:</span> <span class="string">$&#123;SW_CORE_RECORD_DATA_TTL:3&#125;</span> <span class="comment"># Unit is day</span></span><br><span class="line"><span class="attr">    metricsDataTTL:</span> <span class="string">$&#123;SW_CORE_METRICS_DATA_TTL:7&#125;</span> <span class="comment"># Unit is day</span></span><br><span class="line">    <span class="comment"># Cache metrics data for 1 minute to reduce database queries, and if the OAP cluster changes within that minute,</span></span><br><span class="line">    <span class="comment"># the metrics may not be accurate within that minute.</span></span><br><span class="line"><span class="attr">    enableDatabaseSession:</span> <span class="string">$&#123;SW_CORE_ENABLE_DATABASE_SESSION:true&#125;</span></span><br><span class="line"><span class="attr">    topNReportPeriod:</span> <span class="string">$&#123;SW_CORE_TOPN_REPORT_PERIOD:10&#125;</span> <span class="comment"># top_n record worker report cycle, unit is minute</span></span><br><span class="line">    <span class="comment"># Extra model column are the column defined by in the codes, These columns of model are not required logically in aggregation or further query,</span></span><br><span class="line">    <span class="comment"># and it will cause more load for memory, network of OAP and storage.</span></span><br><span class="line">    <span class="comment"># But, being activated, user could see the name in the storage entities, which make users easier to use 3rd party tool, such as Kibana-&gt;ES, to query the data by themselves.</span></span><br><span class="line"><span class="attr">    activeExtraModelColumns:</span> <span class="string">$&#123;SW_CORE_ACTIVE_EXTRA_MODEL_COLUMNS:false&#125;</span></span><br><span class="line">    <span class="comment"># The max length of service + instance names should be less than 200</span></span><br><span class="line"><span class="attr">    serviceNameMaxLength:</span> <span class="string">$&#123;SW_SERVICE_NAME_MAX_LENGTH:70&#125;</span></span><br><span class="line"><span class="attr">    instanceNameMaxLength:</span> <span class="string">$&#123;SW_INSTANCE_NAME_MAX_LENGTH:70&#125;</span></span><br><span class="line">    <span class="comment"># The max length of service + endpoint names should be less than 240</span></span><br><span class="line"><span class="attr">    endpointNameMaxLength:</span> <span class="string">$&#123;SW_ENDPOINT_NAME_MAX_LENGTH:150&#125;</span></span><br><span class="line">    <span class="comment"># Define the set of span tag keys, which should be searchable through the GraphQL.</span></span><br><span class="line"><span class="attr">    searchableTracesTags:</span> <span class="string">$&#123;SW_SEARCHABLE_TAG_KEYS:http.method,status_code,db.type,db.instance,mq.queue,mq.topic,mq.broker&#125;</span></span><br><span class="line"><span class="attr">storage:</span></span><br><span class="line"><span class="attr">  selector:</span> <span class="string">$&#123;SW_STORAGE:h2&#125;</span></span><br><span class="line"><span class="attr">  elasticsearch:</span></span><br><span class="line"><span class="attr">    nameSpace:</span> <span class="string">$&#123;SW_NAMESPACE:""&#125;</span></span><br><span class="line"><span class="attr">    clusterNodes:</span> <span class="string">$&#123;SW_STORAGE_ES_CLUSTER_NODES:localhost:9200&#125;</span></span><br><span class="line"><span class="attr">    protocol:</span> <span class="string">$&#123;SW_STORAGE_ES_HTTP_PROTOCOL:"http"&#125;</span></span><br><span class="line"><span class="attr">    user:</span> <span class="string">$&#123;SW_ES_USER:""&#125;</span></span><br><span class="line"><span class="attr">    password:</span> <span class="string">$&#123;SW_ES_PASSWORD:""&#125;</span></span><br><span class="line"><span class="attr">    trustStorePath:</span> <span class="string">$&#123;SW_STORAGE_ES_SSL_JKS_PATH:""&#125;</span></span><br><span class="line"><span class="attr">    trustStorePass:</span> <span class="string">$&#123;SW_STORAGE_ES_SSL_JKS_PASS:""&#125;</span></span><br><span class="line"><span class="attr">    secretsManagementFile:</span> <span class="string">$&#123;SW_ES_SECRETS_MANAGEMENT_FILE:""&#125;</span> <span class="comment"># Secrets management file in the properties format includes the username, password, which are managed by 3rd party tool.</span></span><br><span class="line"><span class="attr">    dayStep:</span> <span class="string">$&#123;SW_STORAGE_DAY_STEP:1&#125;</span> <span class="comment"># Represent the number of days in the one minute/hour/day index.</span></span><br><span class="line"><span class="attr">    indexShardsNumber:</span> <span class="string">$&#123;SW_STORAGE_ES_INDEX_SHARDS_NUMBER:1&#125;</span> <span class="comment"># Shard number of new indexes</span></span><br><span class="line"><span class="attr">    indexReplicasNumber:</span> <span class="string">$&#123;SW_STORAGE_ES_INDEX_REPLICAS_NUMBER:1&#125;</span> <span class="comment"># Replicas number of new indexes</span></span><br><span class="line">    <span class="comment"># Super data set has been defined in the codes, such as trace segments.The following 3 config would be improve es performance when storage super size data in es.</span></span><br><span class="line"><span class="attr">    superDatasetDayStep:</span> <span class="string">$&#123;SW_SUPERDATASET_STORAGE_DAY_STEP:-1&#125;</span> <span class="comment"># Represent the number of days in the super size dataset record index, the default value is the same as dayStep when the value is less than 0</span></span><br><span class="line"><span class="attr">    superDatasetIndexShardsFactor:</span> <span class="string">$&#123;SW_STORAGE_ES_SUPER_DATASET_INDEX_SHARDS_FACTOR:5&#125;</span> <span class="comment">#  This factor provides more shards for the super data set, shards number = indexShardsNumber * superDatasetIndexShardsFactor. Also, this factor effects Zipkin and Jaeger traces.</span></span><br><span class="line"><span class="attr">    superDatasetIndexReplicasNumber:</span> <span class="string">$&#123;SW_STORAGE_ES_SUPER_DATASET_INDEX_REPLICAS_NUMBER:0&#125;</span> <span class="comment"># Represent the replicas number in the super size dataset record index, the default value is 0.</span></span><br><span class="line"><span class="attr">    bulkActions:</span> <span class="string">$&#123;SW_STORAGE_ES_BULK_ACTIONS:1000&#125;</span> <span class="comment"># Execute the async bulk record data every $&#123;SW_STORAGE_ES_BULK_ACTIONS&#125; requests</span></span><br><span class="line"><span class="attr">    syncBulkActions:</span> <span class="string">$&#123;SW_STORAGE_ES_SYNC_BULK_ACTIONS:50000&#125;</span> <span class="comment"># Execute the sync bulk metrics data every $&#123;SW_STORAGE_ES_SYNC_BULK_ACTIONS&#125; requests</span></span><br><span class="line"><span class="attr">    flushInterval:</span> <span class="string">$&#123;SW_STORAGE_ES_FLUSH_INTERVAL:10&#125;</span> <span class="comment"># flush the bulk every 10 seconds whatever the number of requests</span></span><br><span class="line"><span class="attr">    concurrentRequests:</span> <span class="string">$&#123;SW_STORAGE_ES_CONCURRENT_REQUESTS:2&#125;</span> <span class="comment"># the number of concurrent requests</span></span><br><span class="line"><span class="attr">    resultWindowMaxSize:</span> <span class="string">$&#123;SW_STORAGE_ES_QUERY_MAX_WINDOW_SIZE:10000&#125;</span></span><br><span class="line"><span class="attr">    metadataQueryMaxSize:</span> <span class="string">$&#123;SW_STORAGE_ES_QUERY_MAX_SIZE:5000&#125;</span></span><br><span class="line"><span class="attr">    segmentQueryMaxSize:</span> <span class="string">$&#123;SW_STORAGE_ES_QUERY_SEGMENT_SIZE:200&#125;</span></span><br><span class="line"><span class="attr">    profileTaskQueryMaxSize:</span> <span class="string">$&#123;SW_STORAGE_ES_QUERY_PROFILE_TASK_SIZE:200&#125;</span></span><br><span class="line"><span class="attr">    advanced:</span> <span class="string">$&#123;SW_STORAGE_ES_ADVANCED:""&#125;</span></span><br><span class="line"><span class="attr">  elasticsearch7:</span></span><br><span class="line"><span class="attr">    nameSpace:</span> <span class="string">$&#123;SW_NAMESPACE:""&#125;</span></span><br><span class="line"><span class="attr">    clusterNodes:</span> <span class="string">$&#123;SW_STORAGE_ES_CLUSTER_NODES:localhost:9200&#125;</span></span><br><span class="line"><span class="attr">    protocol:</span> <span class="string">$&#123;SW_STORAGE_ES_HTTP_PROTOCOL:"http"&#125;</span></span><br><span class="line"><span class="attr">    trustStorePath:</span> <span class="string">$&#123;SW_STORAGE_ES_SSL_JKS_PATH:""&#125;</span></span><br><span class="line"><span class="attr">    trustStorePass:</span> <span class="string">$&#123;SW_STORAGE_ES_SSL_JKS_PASS:""&#125;</span></span><br><span class="line"><span class="attr">    dayStep:</span> <span class="string">$&#123;SW_STORAGE_DAY_STEP:1&#125;</span> <span class="comment"># Represent the number of days in the one minute/hour/day index.</span></span><br><span class="line"><span class="attr">    indexShardsNumber:</span> <span class="string">$&#123;SW_STORAGE_ES_INDEX_SHARDS_NUMBER:1&#125;</span> <span class="comment"># Shard number of new indexes</span></span><br><span class="line"><span class="attr">    indexReplicasNumber:</span> <span class="string">$&#123;SW_STORAGE_ES_INDEX_REPLICAS_NUMBER:1&#125;</span> <span class="comment"># Replicas number of new indexes</span></span><br><span class="line">    <span class="comment"># Super data set has been defined in the codes, such as trace segments.The following 3 config would be improve es performance when storage super size data in es.</span></span><br><span class="line"><span class="attr">    superDatasetDayStep:</span> <span class="string">$&#123;SW_SUPERDATASET_STORAGE_DAY_STEP:-1&#125;</span> <span class="comment"># Represent the number of days in the super size dataset record index, the default value is the same as dayStep when the value is less than 0</span></span><br><span class="line"><span class="attr">    superDatasetIndexShardsFactor:</span> <span class="string">$&#123;SW_STORAGE_ES_SUPER_DATASET_INDEX_SHARDS_FACTOR:5&#125;</span> <span class="comment">#  This factor provides more shards for the super data set, shards number = indexShardsNumber * superDatasetIndexShardsFactor. Also, this factor effects Zipkin and Jaeger traces.</span></span><br><span class="line"><span class="attr">    superDatasetIndexReplicasNumber:</span> <span class="string">$&#123;SW_STORAGE_ES_SUPER_DATASET_INDEX_REPLICAS_NUMBER:0&#125;</span> <span class="comment"># Represent the replicas number in the super size dataset record index, the default value is 0.</span></span><br><span class="line"><span class="attr">    user:</span> <span class="string">$&#123;SW_ES_USER:""&#125;</span></span><br><span class="line"><span class="attr">    password:</span> <span class="string">$&#123;SW_ES_PASSWORD:""&#125;</span></span><br><span class="line"><span class="attr">    secretsManagementFile:</span> <span class="string">$&#123;SW_ES_SECRETS_MANAGEMENT_FILE:""&#125;</span> <span class="comment"># Secrets management file in the properties format includes the username, password, which are managed by 3rd party tool.</span></span><br><span class="line"><span class="attr">    bulkActions:</span> <span class="string">$&#123;SW_STORAGE_ES_BULK_ACTIONS:1000&#125;</span> <span class="comment"># Execute the async bulk record data every $&#123;SW_STORAGE_ES_BULK_ACTIONS&#125; requests</span></span><br><span class="line"><span class="attr">    syncBulkActions:</span> <span class="string">$&#123;SW_STORAGE_ES_SYNC_BULK_ACTIONS:50000&#125;</span> <span class="comment"># Execute the sync bulk metrics data every $&#123;SW_STORAGE_ES_SYNC_BULK_ACTIONS&#125; requests</span></span><br><span class="line"><span class="attr">    flushInterval:</span> <span class="string">$&#123;SW_STORAGE_ES_FLUSH_INTERVAL:10&#125;</span> <span class="comment"># flush the bulk every 10 seconds whatever the number of requests</span></span><br><span class="line"><span class="attr">    concurrentRequests:</span> <span class="string">$&#123;SW_STORAGE_ES_CONCURRENT_REQUESTS:2&#125;</span> <span class="comment"># the number of concurrent requests</span></span><br><span class="line"><span class="attr">    resultWindowMaxSize:</span> <span class="string">$&#123;SW_STORAGE_ES_QUERY_MAX_WINDOW_SIZE:10000&#125;</span></span><br><span class="line"><span class="attr">    metadataQueryMaxSize:</span> <span class="string">$&#123;SW_STORAGE_ES_QUERY_MAX_SIZE:5000&#125;</span></span><br><span class="line"><span class="attr">    segmentQueryMaxSize:</span> <span class="string">$&#123;SW_STORAGE_ES_QUERY_SEGMENT_SIZE:200&#125;</span></span><br><span class="line"><span class="attr">    profileTaskQueryMaxSize:</span> <span class="string">$&#123;SW_STORAGE_ES_QUERY_PROFILE_TASK_SIZE:200&#125;</span></span><br><span class="line"><span class="attr">    advanced:</span> <span class="string">$&#123;SW_STORAGE_ES_ADVANCED:""&#125;</span></span><br><span class="line"><span class="attr">  h2:</span></span><br><span class="line"><span class="attr">    driver:</span> <span class="string">$&#123;SW_STORAGE_H2_DRIVER:org.h2.jdbcx.JdbcDataSource&#125;</span></span><br><span class="line"><span class="attr">    url:</span> <span class="string">$&#123;SW_STORAGE_H2_URL:jdbc:h2:mem:skywalking-oap-db&#125;</span></span><br><span class="line"><span class="attr">    user:</span> <span class="string">$&#123;SW_STORAGE_H2_USER:sa&#125;</span></span><br><span class="line"><span class="attr">    metadataQueryMaxSize:</span> <span class="string">$&#123;SW_STORAGE_H2_QUERY_MAX_SIZE:5000&#125;</span></span><br><span class="line"><span class="attr">    maxSizeOfArrayColumn:</span> <span class="string">$&#123;SW_STORAGE_MAX_SIZE_OF_ARRAY_COLUMN:20&#125;</span></span><br><span class="line"><span class="attr">    numOfSearchableValuesPerTag:</span> <span class="string">$&#123;SW_STORAGE_NUM_OF_SEARCHABLE_VALUES_PER_TAG:2&#125;</span></span><br><span class="line"><span class="attr">  mysql:</span></span><br><span class="line"><span class="attr">    properties:</span></span><br><span class="line"><span class="attr">      jdbcUrl:</span> <span class="string">$&#123;SW_JDBC_URL:"jdbc:mysql://localhost:3306/swtest"&#125;</span></span><br><span class="line">      <span class="string">dataSource.user:</span> <span class="string">$&#123;SW_DATA_SOURCE_USER:root&#125;</span></span><br><span class="line">      <span class="string">dataSource.password:</span> <span class="string">$&#123;SW_DATA_SOURCE_PASSWORD:root@1234&#125;</span></span><br><span class="line">      <span class="string">dataSource.cachePrepStmts:</span> <span class="string">$&#123;SW_DATA_SOURCE_CACHE_PREP_STMTS:true&#125;</span></span><br><span class="line">      <span class="string">dataSource.prepStmtCacheSize:</span> <span class="string">$&#123;SW_DATA_SOURCE_PREP_STMT_CACHE_SQL_SIZE:250&#125;</span></span><br><span class="line">      <span class="string">dataSource.prepStmtCacheSqlLimit:</span> <span class="string">$&#123;SW_DATA_SOURCE_PREP_STMT_CACHE_SQL_LIMIT:2048&#125;</span></span><br><span class="line">      <span class="string">dataSource.useServerPrepStmts:</span> <span class="string">$&#123;SW_DATA_SOURCE_USE_SERVER_PREP_STMTS:true&#125;</span></span><br><span class="line"><span class="attr">    metadataQueryMaxSize:</span> <span class="string">$&#123;SW_STORAGE_MYSQL_QUERY_MAX_SIZE:5000&#125;</span></span><br><span class="line"><span class="attr">    maxSizeOfArrayColumn:</span> <span class="string">$&#123;SW_STORAGE_MAX_SIZE_OF_ARRAY_COLUMN:20&#125;</span></span><br><span class="line"><span class="attr">    numOfSearchableValuesPerTag:</span> <span class="string">$&#123;SW_STORAGE_NUM_OF_SEARCHABLE_VALUES_PER_TAG:2&#125;</span></span><br><span class="line"><span class="attr">  tidb:</span></span><br><span class="line"><span class="attr">    properties:</span></span><br><span class="line"><span class="attr">      jdbcUrl:</span> <span class="string">$&#123;SW_JDBC_URL:"jdbc:mysql://localhost:4000/tidbswtest"&#125;</span></span><br><span class="line">      <span class="string">dataSource.user:</span> <span class="string">$&#123;SW_DATA_SOURCE_USER:root&#125;</span></span><br><span class="line">      <span class="string">dataSource.password:</span> <span class="string">$&#123;SW_DATA_SOURCE_PASSWORD:""&#125;</span></span><br><span class="line">      <span class="string">dataSource.cachePrepStmts:</span> <span class="string">$&#123;SW_DATA_SOURCE_CACHE_PREP_STMTS:true&#125;</span></span><br><span class="line">      <span class="string">dataSource.prepStmtCacheSize:</span> <span class="string">$&#123;SW_DATA_SOURCE_PREP_STMT_CACHE_SQL_SIZE:250&#125;</span></span><br><span class="line">      <span class="string">dataSource.prepStmtCacheSqlLimit:</span> <span class="string">$&#123;SW_DATA_SOURCE_PREP_STMT_CACHE_SQL_LIMIT:2048&#125;</span></span><br><span class="line">      <span class="string">dataSource.useServerPrepStmts:</span> <span class="string">$&#123;SW_DATA_SOURCE_USE_SERVER_PREP_STMTS:true&#125;</span></span><br><span class="line">      <span class="string">dataSource.useAffectedRows:</span> <span class="string">$&#123;SW_DATA_SOURCE_USE_AFFECTED_ROWS:true&#125;</span></span><br><span class="line"><span class="attr">    metadataQueryMaxSize:</span> <span class="string">$&#123;SW_STORAGE_MYSQL_QUERY_MAX_SIZE:5000&#125;</span></span><br><span class="line"><span class="attr">    maxSizeOfArrayColumn:</span> <span class="string">$&#123;SW_STORAGE_MAX_SIZE_OF_ARRAY_COLUMN:20&#125;</span></span><br><span class="line"><span class="attr">    numOfSearchableValuesPerTag:</span> <span class="string">$&#123;SW_STORAGE_NUM_OF_SEARCHABLE_VALUES_PER_TAG:2&#125;</span></span><br><span class="line"><span class="attr">  influxdb:</span></span><br><span class="line">    <span class="comment"># InfluxDB configuration</span></span><br><span class="line"><span class="attr">    url:</span> <span class="string">$&#123;SW_STORAGE_INFLUXDB_URL:http://localhost:8086&#125;</span></span><br><span class="line"><span class="attr">    user:</span> <span class="string">$&#123;SW_STORAGE_INFLUXDB_USER:root&#125;</span></span><br><span class="line"><span class="attr">    password:</span> <span class="string">$&#123;SW_STORAGE_INFLUXDB_PASSWORD:&#125;</span></span><br><span class="line"><span class="attr">    database:</span> <span class="string">$&#123;SW_STORAGE_INFLUXDB_DATABASE:skywalking&#125;</span></span><br><span class="line"><span class="attr">    actions:</span> <span class="string">$&#123;SW_STORAGE_INFLUXDB_ACTIONS:1000&#125;</span> <span class="comment"># the number of actions to collect</span></span><br><span class="line"><span class="attr">    duration:</span> <span class="string">$&#123;SW_STORAGE_INFLUXDB_DURATION:1000&#125;</span> <span class="comment"># the time to wait at most (milliseconds)</span></span><br><span class="line"><span class="attr">    batchEnabled:</span> <span class="string">$&#123;SW_STORAGE_INFLUXDB_BATCH_ENABLED:true&#125;</span></span><br><span class="line"><span class="attr">    fetchTaskLogMaxSize:</span> <span class="string">$&#123;SW_STORAGE_INFLUXDB_FETCH_TASK_LOG_MAX_SIZE:5000&#125;</span> <span class="comment"># the max number of fetch task log in a request</span></span><br><span class="line"></span><br><span class="line"><span class="attr">agent-analyzer:</span></span><br><span class="line"><span class="attr">  selector:</span> <span class="string">$&#123;SW_AGENT_ANALYZER:default&#125;</span></span><br><span class="line"><span class="attr">  default:</span></span><br><span class="line"><span class="attr">    sampleRate:</span> <span class="string">$&#123;SW_TRACE_SAMPLE_RATE:10000&#125;</span> <span class="comment"># The sample rate precision is 1/10000. 10000 means 100% sample in default.</span></span><br><span class="line"><span class="attr">    slowDBAccessThreshold:</span> <span class="string">$&#123;SW_SLOW_DB_THRESHOLD:default:200,mongodb:100&#125;</span> <span class="comment"># The slow database access thresholds. Unit ms.</span></span><br><span class="line"><span class="attr">    forceSampleErrorSegment:</span> <span class="string">$&#123;SW_FORCE_SAMPLE_ERROR_SEGMENT:true&#125;</span> <span class="comment"># When sampling mechanism active, this config can open(true) force save some error segment. true is default.</span></span><br><span class="line"><span class="attr">    segmentStatusAnalysisStrategy:</span> <span class="string">$&#123;SW_SEGMENT_STATUS_ANALYSIS_STRATEGY:FROM_SPAN_STATUS&#125;</span> <span class="comment"># Determine the final segment status from the status of spans. Available values are `FROM_SPAN_STATUS` , `FROM_ENTRY_SPAN` and `FROM_FIRST_SPAN`. `FROM_SPAN_STATUS` represents the segment status would be error if any span is in error status. `FROM_ENTRY_SPAN` means the segment status would be determined by the status of entry spans only. `FROM_FIRST_SPAN` means the segment status would be determined by the status of the first span only.</span></span><br><span class="line">    <span class="comment"># Nginx and Envoy agents can't get the real remote address.</span></span><br><span class="line">    <span class="comment"># Exit spans with the component in the list would not generate the client-side instance relation metrics.</span></span><br><span class="line"><span class="attr">    noUpstreamRealAddressAgents:</span> <span class="string">$&#123;SW_NO_UPSTREAM_REAL_ADDRESS:6000,9000&#125;</span></span><br><span class="line"><span class="attr">    slowTraceSegmentThreshold:</span> <span class="string">$&#123;SW_SLOW_TRACE_SEGMENT_THRESHOLD:-1&#125;</span> <span class="comment"># Setting this threshold about the latency would make the slow trace segments sampled if they cost more time, even the sampling mechanism activated. The default value is `-1`, which means would not sample slow traces. Unit, millisecond.</span></span><br><span class="line"><span class="attr">    meterAnalyzerActiveFiles:</span> <span class="string">$&#123;SW_METER_ANALYZER_ACTIVE_FILES:&#125;</span> <span class="comment"># Which files could be meter analyzed, files split by ","</span></span><br><span class="line"></span><br><span class="line"><span class="attr">receiver-sharing-server:</span></span><br><span class="line"><span class="attr">  selector:</span> <span class="string">$&#123;SW_RECEIVER_SHARING_SERVER:default&#125;</span></span><br><span class="line"><span class="attr">  default:</span></span><br><span class="line">    <span class="comment"># For Jetty server</span></span><br><span class="line"><span class="attr">    restHost:</span> <span class="string">$&#123;SW_RECEIVER_SHARING_REST_HOST:0.0.0.0&#125;</span></span><br><span class="line"><span class="attr">    restPort:</span> <span class="string">$&#123;SW_RECEIVER_SHARING_REST_PORT:0&#125;</span></span><br><span class="line"><span class="attr">    contextPath:</span> <span class="string">$&#123;SW_RECEIVER_SHARING_REST_CONTEXT_PATH:/&#125;</span></span><br><span class="line"><span class="attr">    restMinThreads:</span> <span class="string">$&#123;SW_RECEIVER_SHARING_JETTY_MIN_THREADS:1&#125;</span></span><br><span class="line"><span class="attr">    restMaxThreads:</span> <span class="string">$&#123;SW_RECEIVER_SHARING_JETTY_MAX_THREADS:200&#125;</span></span><br><span class="line"><span class="attr">    restIdleTimeOut:</span> <span class="string">$&#123;SW_RECEIVER_SHARING_JETTY_IDLE_TIMEOUT:30000&#125;</span></span><br><span class="line"><span class="attr">    restAcceptorPriorityDelta:</span> <span class="string">$&#123;SW_RECEIVER_SHARING_JETTY_DELTA:0&#125;</span></span><br><span class="line"><span class="attr">    restAcceptQueueSize:</span> <span class="string">$&#123;SW_RECEIVER_SHARING_JETTY_QUEUE_SIZE:0&#125;</span></span><br><span class="line">    <span class="comment"># For gRPC server</span></span><br><span class="line"><span class="attr">    gRPCHost:</span> <span class="string">$&#123;SW_RECEIVER_GRPC_HOST:0.0.0.0&#125;</span></span><br><span class="line"><span class="attr">    gRPCPort:</span> <span class="string">$&#123;SW_RECEIVER_GRPC_PORT:0&#125;</span></span><br><span class="line"><span class="attr">    maxConcurrentCallsPerConnection:</span> <span class="string">$&#123;SW_RECEIVER_GRPC_MAX_CONCURRENT_CALL:0&#125;</span></span><br><span class="line"><span class="attr">    maxMessageSize:</span> <span class="string">$&#123;SW_RECEIVER_GRPC_MAX_MESSAGE_SIZE:0&#125;</span></span><br><span class="line"><span class="attr">    gRPCThreadPoolQueueSize:</span> <span class="string">$&#123;SW_RECEIVER_GRPC_POOL_QUEUE_SIZE:0&#125;</span></span><br><span class="line"><span class="attr">    gRPCThreadPoolSize:</span> <span class="string">$&#123;SW_RECEIVER_GRPC_THREAD_POOL_SIZE:0&#125;</span></span><br><span class="line"><span class="attr">    gRPCSslEnabled:</span> <span class="string">$&#123;SW_RECEIVER_GRPC_SSL_ENABLED:false&#125;</span></span><br><span class="line"><span class="attr">    gRPCSslKeyPath:</span> <span class="string">$&#123;SW_RECEIVER_GRPC_SSL_KEY_PATH:""&#125;</span></span><br><span class="line"><span class="attr">    gRPCSslCertChainPath:</span> <span class="string">$&#123;SW_RECEIVER_GRPC_SSL_CERT_CHAIN_PATH:""&#125;</span></span><br><span class="line"><span class="attr">    authentication:</span> <span class="string">$&#123;SW_AUTHENTICATION:""&#125;</span></span><br><span class="line"><span class="attr">receiver-register:</span></span><br><span class="line"><span class="attr">  selector:</span> <span class="string">$&#123;SW_RECEIVER_REGISTER:default&#125;</span></span><br><span class="line"><span class="attr">  default:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">receiver-trace:</span></span><br><span class="line"><span class="attr">  selector:</span> <span class="string">$&#123;SW_RECEIVER_TRACE:default&#125;</span></span><br><span class="line"><span class="attr">  default:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">receiver-jvm:</span></span><br><span class="line"><span class="attr">  selector:</span> <span class="string">$&#123;SW_RECEIVER_JVM:default&#125;</span></span><br><span class="line"><span class="attr">  default:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">receiver-clr:</span></span><br><span class="line"><span class="attr">  selector:</span> <span class="string">$&#123;SW_RECEIVER_CLR:default&#125;</span></span><br><span class="line"><span class="attr">  default:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">receiver-profile:</span></span><br><span class="line"><span class="attr">  selector:</span> <span class="string">$&#123;SW_RECEIVER_PROFILE:default&#125;</span></span><br><span class="line"><span class="attr">  default:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">service-mesh:</span></span><br><span class="line"><span class="attr">  selector:</span> <span class="string">$&#123;SW_SERVICE_MESH:default&#125;</span></span><br><span class="line"><span class="attr">  default:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">envoy-metric:</span></span><br><span class="line"><span class="attr">  selector:</span> <span class="string">$&#123;SW_ENVOY_METRIC:default&#125;</span></span><br><span class="line"><span class="attr">  default:</span></span><br><span class="line"><span class="attr">    acceptMetricsService:</span> <span class="string">$&#123;SW_ENVOY_METRIC_SERVICE:true&#125;</span></span><br><span class="line"><span class="attr">    alsHTTPAnalysis:</span> <span class="string">$&#123;SW_ENVOY_METRIC_ALS_HTTP_ANALYSIS:""&#125;</span></span><br><span class="line">    <span class="comment"># `k8sServiceNameRule` allows you to customize the service name in ALS via Kubernetes metadata,</span></span><br><span class="line">    <span class="comment"># the available variables are `pod`, `service`, f.e., you can use `$&#123;service.metadata.name&#125;-$&#123;pod.metadata.labels.version&#125;`</span></span><br><span class="line">    <span class="comment"># to append the version number to the service name.</span></span><br><span class="line">    <span class="comment"># Be careful, when using environment variables to pass this configuration, use single quotes(`''`) to avoid it being evaluated by the shell.</span></span><br><span class="line"><span class="attr">    k8sServiceNameRule:</span> <span class="string">$&#123;K8S_SERVICE_NAME_RULE:"$&#123;service.metadata.name&#125;"&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">prometheus-fetcher:</span></span><br><span class="line"><span class="attr">  selector:</span> <span class="string">$&#123;SW_PROMETHEUS_FETCHER:-&#125;</span></span><br><span class="line"><span class="attr">  default:</span></span><br><span class="line"><span class="attr">    enabledRules:</span> <span class="string">$&#123;SW_PROMETHEUS_FETCHER_ENABLED_RULES:"self"&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">kafka-fetcher:</span></span><br><span class="line"><span class="attr">  selector:</span> <span class="string">$&#123;SW_KAFKA_FETCHER:-&#125;</span></span><br><span class="line"><span class="attr">  default:</span></span><br><span class="line"><span class="attr">    bootstrapServers:</span> <span class="string">$&#123;SW_KAFKA_FETCHER_SERVERS:localhost:9092&#125;</span></span><br><span class="line"><span class="attr">    partitions:</span> <span class="string">$&#123;SW_KAFKA_FETCHER_PARTITIONS:3&#125;</span></span><br><span class="line"><span class="attr">    replicationFactor:</span> <span class="string">$&#123;SW_KAFKA_FETCHER_PARTITIONS_FACTOR:2&#125;</span></span><br><span class="line"><span class="attr">    enableMeterSystem:</span> <span class="string">$&#123;SW_KAFKA_FETCHER_ENABLE_METER_SYSTEM:false&#125;</span></span><br><span class="line"><span class="attr">    isSharding:</span> <span class="string">$&#123;SW_KAFKA_FETCHER_IS_SHARDING:false&#125;</span></span><br><span class="line"><span class="attr">    consumePartitions:</span> <span class="string">$&#123;SW_KAFKA_FETCHER_CONSUME_PARTITIONS:""&#125;</span></span><br><span class="line"><span class="attr">    kafkaHandlerThreadPoolSize:</span> <span class="string">$&#123;SW_KAFKA_HANDLER_THREAD_POOL_SIZE:-1&#125;</span></span><br><span class="line"><span class="attr">    kafkaHandlerThreadPoolQueueSize:</span> <span class="string">$&#123;SW_KAFKA_HANDLER_THREAD_POOL_QUEUE_SIZE:-1&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">receiver-meter:</span></span><br><span class="line"><span class="attr">  selector:</span> <span class="string">$&#123;SW_RECEIVER_METER:default&#125;</span></span><br><span class="line"><span class="attr">  default:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">receiver-otel:</span></span><br><span class="line"><span class="attr">  selector:</span> <span class="string">$&#123;SW_OTEL_RECEIVER:-&#125;</span></span><br><span class="line"><span class="attr">  default:</span></span><br><span class="line"><span class="attr">    enabledHandlers:</span> <span class="string">$&#123;SW_OTEL_RECEIVER_ENABLED_HANDLERS:"oc"&#125;</span></span><br><span class="line"><span class="attr">    enabledOcRules:</span> <span class="string">$&#123;SW_OTEL_RECEIVER_ENABLED_OC_RULES:"istio-controlplane"&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">receiver_zipkin:</span></span><br><span class="line"><span class="attr">  selector:</span> <span class="string">$&#123;SW_RECEIVER_ZIPKIN:-&#125;</span></span><br><span class="line"><span class="attr">  default:</span></span><br><span class="line"><span class="attr">    host:</span> <span class="string">$&#123;SW_RECEIVER_ZIPKIN_HOST:0.0.0.0&#125;</span></span><br><span class="line"><span class="attr">    port:</span> <span class="string">$&#123;SW_RECEIVER_ZIPKIN_PORT:9411&#125;</span></span><br><span class="line"><span class="attr">    contextPath:</span> <span class="string">$&#123;SW_RECEIVER_ZIPKIN_CONTEXT_PATH:/&#125;</span></span><br><span class="line"><span class="attr">    jettyMinThreads:</span> <span class="string">$&#123;SW_RECEIVER_ZIPKIN_JETTY_MIN_THREADS:1&#125;</span></span><br><span class="line"><span class="attr">    jettyMaxThreads:</span> <span class="string">$&#123;SW_RECEIVER_ZIPKIN_JETTY_MAX_THREADS:200&#125;</span></span><br><span class="line"><span class="attr">    jettyIdleTimeOut:</span> <span class="string">$&#123;SW_RECEIVER_ZIPKIN_JETTY_IDLE_TIMEOUT:30000&#125;</span></span><br><span class="line"><span class="attr">    jettyAcceptorPriorityDelta:</span> <span class="string">$&#123;SW_RECEIVER_ZIPKIN_JETTY_DELTA:0&#125;</span></span><br><span class="line"><span class="attr">    jettyAcceptQueueSize:</span> <span class="string">$&#123;SW_RECEIVER_ZIPKIN_QUEUE_SIZE:0&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">receiver_jaeger:</span></span><br><span class="line"><span class="attr">  selector:</span> <span class="string">$&#123;SW_RECEIVER_JAEGER:-&#125;</span></span><br><span class="line"><span class="attr">  default:</span></span><br><span class="line"><span class="attr">    gRPCHost:</span> <span class="string">$&#123;SW_RECEIVER_JAEGER_HOST:0.0.0.0&#125;</span></span><br><span class="line"><span class="attr">    gRPCPort:</span> <span class="string">$&#123;SW_RECEIVER_JAEGER_PORT:14250&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">receiver-browser:</span></span><br><span class="line"><span class="attr">  selector:</span> <span class="string">$&#123;SW_RECEIVER_BROWSER:default&#125;</span></span><br><span class="line"><span class="attr">  default:</span></span><br><span class="line">    <span class="comment"># The sample rate precision is 1/10000. 10000 means 100% sample in default.</span></span><br><span class="line"><span class="attr">    sampleRate:</span> <span class="string">$&#123;SW_RECEIVER_BROWSER_SAMPLE_RATE:10000&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">query:</span></span><br><span class="line"><span class="attr">  selector:</span> <span class="string">$&#123;SW_QUERY:graphql&#125;</span></span><br><span class="line"><span class="attr">  graphql:</span></span><br><span class="line"><span class="attr">    path:</span> <span class="string">$&#123;SW_QUERY_GRAPHQL_PATH:/graphql&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">alarm:</span></span><br><span class="line"><span class="attr">  selector:</span> <span class="string">$&#123;SW_ALARM:default&#125;</span></span><br><span class="line"><span class="attr">  default:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">telemetry:</span></span><br><span class="line"><span class="attr">  selector:</span> <span class="string">$&#123;SW_TELEMETRY:none&#125;</span></span><br><span class="line"><span class="attr">  none:</span></span><br><span class="line"><span class="attr">  prometheus:</span></span><br><span class="line"><span class="attr">    host:</span> <span class="string">$&#123;SW_TELEMETRY_PROMETHEUS_HOST:0.0.0.0&#125;</span></span><br><span class="line"><span class="attr">    port:</span> <span class="string">$&#123;SW_TELEMETRY_PROMETHEUS_PORT:1234&#125;</span></span><br><span class="line"><span class="attr">    sslEnabled:</span> <span class="string">$&#123;SW_TELEMETRY_PROMETHEUS_SSL_ENABLED:false&#125;</span></span><br><span class="line"><span class="attr">    sslKeyPath:</span> <span class="string">$&#123;SW_TELEMETRY_PROMETHEUS_SSL_KEY_PATH:""&#125;</span></span><br><span class="line"><span class="attr">    sslCertChainPath:</span> <span class="string">$&#123;SW_TELEMETRY_PROMETHEUS_SSL_CERT_CHAIN_PATH:""&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">configuration:</span></span><br><span class="line"><span class="attr">  selector:</span> <span class="string">$&#123;SW_CONFIGURATION:none&#125;</span></span><br><span class="line"><span class="attr">  none:</span></span><br><span class="line"><span class="attr">  grpc:</span></span><br><span class="line"><span class="attr">    host:</span> <span class="string">$&#123;SW_DCS_SERVER_HOST:""&#125;</span></span><br><span class="line"><span class="attr">    port:</span> <span class="string">$&#123;SW_DCS_SERVER_PORT:80&#125;</span></span><br><span class="line"><span class="attr">    clusterName:</span> <span class="string">$&#123;SW_DCS_CLUSTER_NAME:SkyWalking&#125;</span></span><br><span class="line"><span class="attr">    period:</span> <span class="string">$&#123;SW_DCS_PERIOD:20&#125;</span></span><br><span class="line"><span class="attr">  apollo:</span></span><br><span class="line"><span class="attr">    apolloMeta:</span> <span class="string">$&#123;SW_CONFIG_APOLLO:http://localhost:8080&#125;</span></span><br><span class="line"><span class="attr">    apolloCluster:</span> <span class="string">$&#123;SW_CONFIG_APOLLO_CLUSTER:default&#125;</span></span><br><span class="line"><span class="attr">    apolloEnv:</span> <span class="string">$&#123;SW_CONFIG_APOLLO_ENV:""&#125;</span></span><br><span class="line"><span class="attr">    appId:</span> <span class="string">$&#123;SW_CONFIG_APOLLO_APP_ID:skywalking&#125;</span></span><br><span class="line"><span class="attr">    period:</span> <span class="string">$&#123;SW_CONFIG_APOLLO_PERIOD:5&#125;</span></span><br><span class="line"><span class="attr">  zookeeper:</span></span><br><span class="line"><span class="attr">    period:</span> <span class="string">$&#123;SW_CONFIG_ZK_PERIOD:60&#125;</span> <span class="comment"># Unit seconds, sync period. Default fetch every 60 seconds.</span></span><br><span class="line"><span class="attr">    nameSpace:</span> <span class="string">$&#123;SW_CONFIG_ZK_NAMESPACE:/default&#125;</span></span><br><span class="line"><span class="attr">    hostPort:</span> <span class="string">$&#123;SW_CONFIG_ZK_HOST_PORT:localhost:2181&#125;</span></span><br><span class="line">    <span class="comment"># Retry Policy</span></span><br><span class="line"><span class="attr">    baseSleepTimeMs:</span> <span class="string">$&#123;SW_CONFIG_ZK_BASE_SLEEP_TIME_MS:1000&#125;</span> <span class="comment"># initial amount of time to wait between retries</span></span><br><span class="line"><span class="attr">    maxRetries:</span> <span class="string">$&#123;SW_CONFIG_ZK_MAX_RETRIES:3&#125;</span> <span class="comment"># max number of times to retry</span></span><br><span class="line"><span class="attr">  etcd:</span></span><br><span class="line"><span class="attr">    period:</span> <span class="string">$&#123;SW_CONFIG_ETCD_PERIOD:60&#125;</span> <span class="comment"># Unit seconds, sync period. Default fetch every 60 seconds.</span></span><br><span class="line"><span class="attr">    group:</span> <span class="string">$&#123;SW_CONFIG_ETCD_GROUP:skywalking&#125;</span></span><br><span class="line"><span class="attr">    serverAddr:</span> <span class="string">$&#123;SW_CONFIG_ETCD_SERVER_ADDR:localhost:2379&#125;</span></span><br><span class="line"><span class="attr">    clusterName:</span> <span class="string">$&#123;SW_CONFIG_ETCD_CLUSTER_NAME:default&#125;</span></span><br><span class="line"><span class="attr">  consul:</span></span><br><span class="line">    <span class="comment"># Consul host and ports, separated by comma, e.g. 1.2.3.4:8500,2.3.4.5:8500</span></span><br><span class="line"><span class="attr">    hostAndPorts:</span> <span class="string">$&#123;SW_CONFIG_CONSUL_HOST_AND_PORTS:1.2.3.4:8500&#125;</span></span><br><span class="line">    <span class="comment"># Sync period in seconds. Defaults to 60 seconds.</span></span><br><span class="line"><span class="attr">    period:</span> <span class="string">$&#123;SW_CONFIG_CONSUL_PERIOD:60&#125;</span></span><br><span class="line">    <span class="comment"># Consul aclToken</span></span><br><span class="line"><span class="attr">    aclToken:</span> <span class="string">$&#123;SW_CONFIG_CONSUL_ACL_TOKEN:""&#125;</span></span><br><span class="line"><span class="attr">  k8s-configmap:</span></span><br><span class="line"><span class="attr">    period:</span> <span class="string">$&#123;SW_CONFIG_CONFIGMAP_PERIOD:60&#125;</span></span><br><span class="line"><span class="attr">    namespace:</span> <span class="string">$&#123;SW_CLUSTER_K8S_NAMESPACE:default&#125;</span></span><br><span class="line"><span class="attr">    labelSelector:</span> <span class="string">$&#123;SW_CLUSTER_K8S_LABEL:app=collector,release=skywalking&#125;</span></span><br><span class="line"><span class="attr">  nacos:</span></span><br><span class="line">    <span class="comment"># Nacos Server Host</span></span><br><span class="line"><span class="attr">    serverAddr:</span> <span class="string">$&#123;SW_CONFIG_NACOS_SERVER_ADDR:127.0.0.1&#125;</span></span><br><span class="line">    <span class="comment"># Nacos Server Port</span></span><br><span class="line"><span class="attr">    port:</span> <span class="string">$&#123;SW_CONFIG_NACOS_SERVER_PORT:8848&#125;</span></span><br><span class="line">    <span class="comment"># Nacos Configuration Group</span></span><br><span class="line"><span class="attr">    group:</span> <span class="string">$&#123;SW_CONFIG_NACOS_SERVER_GROUP:skywalking&#125;</span></span><br><span class="line">    <span class="comment"># Nacos Configuration namespace</span></span><br><span class="line"><span class="attr">    namespace:</span> <span class="string">$&#123;SW_CONFIG_NACOS_SERVER_NAMESPACE:&#125;</span></span><br><span class="line">    <span class="comment"># Unit seconds, sync period. Default fetch every 60 seconds.</span></span><br><span class="line"><span class="attr">    period:</span> <span class="string">$&#123;SW_CONFIG_NACOS_PERIOD:60&#125;</span></span><br><span class="line">    <span class="comment"># Nacos auth username</span></span><br><span class="line"><span class="attr">    username:</span> <span class="string">$&#123;SW_CONFIG_NACOS_USERNAME:""&#125;</span></span><br><span class="line"><span class="attr">    password:</span> <span class="string">$&#123;SW_CONFIG_NACOS_PASSWORD:""&#125;</span></span><br><span class="line">    <span class="comment"># Nacos auth accessKey</span></span><br><span class="line"><span class="attr">    accessKey:</span> <span class="string">$&#123;SW_CONFIG_NACOS_ACCESSKEY:""&#125;</span></span><br><span class="line"><span class="attr">    secretKey:</span> <span class="string">$&#123;SW_CONFIG_NACOS_SECRETKEY:""&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">exporter:</span></span><br><span class="line"><span class="attr">  selector:</span> <span class="string">$&#123;SW_EXPORTER:-&#125;</span></span><br><span class="line"><span class="attr">  grpc:</span></span><br><span class="line"><span class="attr">    targetHost:</span> <span class="string">$&#123;SW_EXPORTER_GRPC_HOST:127.0.0.1&#125;</span></span><br><span class="line"><span class="attr">    targetPort:</span> <span class="string">$&#123;SW_EXPORTER_GRPC_PORT:9870&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">health-checker:</span></span><br><span class="line"><span class="attr">  selector:</span> <span class="string">$&#123;SW_HEALTH_CHECKER:-&#125;</span></span><br><span class="line"><span class="attr">  default:</span></span><br><span class="line"><span class="attr">    checkIntervalSeconds:</span> <span class="string">$&#123;SW_HEALTH_CHECKER_INTERVAL_SECONDS:5&#125;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="插件安装"><a href="#插件安装" class="headerlink" title="插件安装"></a>插件安装</h3><p>Java代理插件都是可插入的。可以optional-plugins在代理或第三方存储库下的文件夹中提供可选插件。要使用这些插件，需要将目标插件jar文件放入/plugins。</p>
<p>目前已有的插件有：</p>
<ul>
<li><a href="https://github.com/apache/skywalking/blob/8.3.0/docs-hotfix/docs/en/setup/service-agent/java-agent/agent-optional-plugins/Spring-annotation-plugin.md" target="_blank" rel="noopener">Plugin of tracing Spring annotation beans</a></li>
<li><a href="https://github.com/apache/skywalking/blob/8.3.0/docs-hotfix/docs/en/setup/service-agent/java-agent/agent-optional-plugins/Oracle-Resin-plugins.md" target="_blank" rel="noopener">tracing Oracle and Resin</a></li>
<li><a href="https://github.com/apache/skywalking/blob/8.3.0/docs-hotfix/docs/en/setup/service-agent/java-agent/agent-optional-plugins/trace-ignore-plugin.md" target="_blank" rel="noopener">Filter traces through specified endpoint name patterns</a></li>
<li>Plugin of Gson serialization lib in optional plugin folder.</li>
<li>Plugin of Zookeeper 3.4.x in optional plugin folder. The reason of being optional plugin is, many business irrelevant traces are generated, which cause extra payload to agents and backends. At the same time, those traces may be just heartbeat(s).</li>
<li>Customize enhance Trace methods based on description files, rather than write plugin or change source codes.</li>
<li>Plugin of Spring Cloud Gateway 2.1.x in optional plugin folder. Please only active this plugin when you install agent in Spring Gateway. spring-cloud-gateway-2.x-plugin and spring-webflux-5.x-plugin are both required.</li>
<li>Plugin of Spring Transaction in optional plugin folder. The reason of being optional plugin is, many local span are generated, which also spend more CPU, memory and network.</li>
<li>Plugin of Kotlin coroutine provides the tracing across coroutines automatically. As it will add local spans to all across routines scenarios, Please assess the performance impact.</li>
<li>Plugin of quartz-scheduler-2.x in the optional plugin folder. The reason for being an optional plugin is, many task scheduling systems are based on quartz-scheduler, this will cause duplicate tracing and link different sub-tasks as they share the same quartz level trigger, such as ElasticJob.</li>
<li>Plugin of spring-webflux-5.x in the optional plugin folder. Please only activate this plugin when you use webflux alone as a web container. If you are using SpringMVC 5 or Spring Gateway, you don’t need this plugin.</li>
</ul>
<h3 id="前端配置"><a href="#前端配置" class="headerlink" title="前端配置"></a>前端配置</h3><p>前端配置在文件夹<code>webapp</code>的<code>webapp.yml</code>文件里面。</p>
<h2 id="客户端接入"><a href="#客户端接入" class="headerlink" title="客户端接入"></a>客户端接入</h2><h3 id="java应用"><a href="#java应用" class="headerlink" title="java应用"></a>java应用</h3><p>执行命令里面加上<br><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -javaagent:/path/<span class="keyword">to</span>/skywalking-<span class="built_in">agent</span>/skywalking-<span class="built_in">agent</span>.jar -Dskywalking_config=/path/<span class="keyword">to</span>/<span class="built_in">agent</span>.config -jar yourApp.jar</span><br></pre></td></tr></table></figure></p>
<p>这里另外设置了agent的配置，具体agent的配置可以参考<a href="https://github.com/apache/skywalking/blob/8.3.0/docs-hotfix/docs/en/setup/service-agent/java-agent/README.md" target="_blank" rel="noopener">官方文档</a>，这里贴上我自己的配置:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Licensed to the Apache Software Foundation (ASF) under one</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> or more contributor license agreements.  See the NOTICE file</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> distributed with this work <span class="keyword">for</span> additional information</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> regarding copyright ownership.  The ASF licenses this file</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> to you under the Apache License, Version 2.0 (the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="string">"License"</span>); you may not use this file except <span class="keyword">in</span> compliance</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> with the License.  You may obtain a copy of the License at</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">     http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Unless required by applicable law or agreed to <span class="keyword">in</span> writing, software</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> distributed under the License is distributed on an <span class="string">"AS IS"</span> BASIS,</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> See the License <span class="keyword">for</span> the specific language governing permissions and</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> limitations under the License.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The agent namespace</span></span><br><span class="line">agent.namespace=$&#123;SW_AGENT_NAMESPACE:LOCAL&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The service name <span class="keyword">in</span> UI</span></span><br><span class="line">agent.service_name=$&#123;SW_AGENT_NAME:Activiti&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The number of sampled traces per 3 seconds</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Negative or zero means off, by default</span></span><br><span class="line">agent.sample_n_per_3_secs=$&#123;SW_AGENT_SAMPLE:-1&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Authentication active is based on backend setting, see application.yml <span class="keyword">for</span> more details.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> agent.authentication = <span class="variable">$&#123;SW_AGENT_AUTHENTICATION:xxxx&#125;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The max amount of spans <span class="keyword">in</span> a single segment.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Through this config item, SkyWalking keep your application memory cost estimated.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> agent.span_limit_per_segment=<span class="variable">$&#123;SW_AGENT_SPAN_LIMIT:150&#125;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Ignore the segments <span class="keyword">if</span> their operation names end with these suffix.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> agent.ignore_suffix=<span class="variable">$&#123;SW_AGENT_IGNORE_SUFFIX:.jpg,.jpeg,.js,.css,.png,.bmp,.gif,.ico,.mp3,.mp4,.html,.svg&#125;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> If <span class="literal">true</span>, SkyWalking agent will save all instrumented classes files <span class="keyword">in</span> `/debugging` folder.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> SkyWalking team may ask <span class="keyword">for</span> these files <span class="keyword">in</span> order to resolve compatible problem.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> agent.is_open_debugging_class = <span class="variable">$&#123;SW_AGENT_OPEN_DEBUG:true&#125;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> If <span class="literal">true</span>, SkyWalking agent will cache all instrumented classes files to memory or disk files (decided by class cache mode),</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> allow other javaagent to enhance those classes that enhanced by SkyWalking agent.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> agent.is_cache_enhanced_class = <span class="variable">$&#123;SW_AGENT_CACHE_CLASS:false&#125;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The instrumented classes cache mode: MEMORY or FILE</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> MEMORY: cache class bytes to memory, <span class="keyword">if</span> instrumented classes is too many or too large, it may take up more memory</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> FILE: cache class bytes <span class="keyword">in</span> `/class-cache` folder, automatically clean up cached class files when the application exits</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> agent.class_cache_mode = <span class="variable">$&#123;SW_AGENT_CLASS_CACHE_MODE:MEMORY&#125;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The operationName max length</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Notice, <span class="keyword">in</span> the current practice, we don<span class="string">'t recommend the length over 190.</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> agent.operation_name_threshold=<span class="variable">$&#123;SW_AGENT_OPERATION_NAME_THRESHOLD:150&#125;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> If <span class="literal">true</span>, skywalking agent will <span class="built_in">enable</span> profile when user create a new profile task. Otherwise <span class="built_in">disable</span> profile.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> profile.active=<span class="variable">$&#123;SW_AGENT_PROFILE_ACTIVE:true&#125;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Parallel monitor segment count</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> profile.max_parallel=<span class="variable">$&#123;SW_AGENT_PROFILE_MAX_PARALLEL:5&#125;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Max monitor segment time(minutes), <span class="keyword">if</span> current segment monitor time out of <span class="built_in">limit</span>, <span class="keyword">then</span> stop it.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> profile.duration=<span class="variable">$&#123;SW_AGENT_PROFILE_DURATION:10&#125;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Max dump thread stack depth</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> profile.dump_max_stack_depth=<span class="variable">$&#123;SW_AGENT_PROFILE_DUMP_MAX_STACK_DEPTH:500&#125;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Snapshot transport to backend buffer size</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> profile.snapshot_transport_buffer_size=<span class="variable">$&#123;SW_AGENT_PROFILE_SNAPSHOT_TRANSPORT_BUFFER_SIZE:50&#125;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Backend service addresses.</span></span><br><span class="line">collector.backend_service=$&#123;SW_AGENT_COLLECTOR_BACKEND_SERVICES:127.0.0.1:11800&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Logging file_name</span></span><br><span class="line">logging.file_name=$&#123;SW_LOGGING_FILE_NAME:skywalking-api.log&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Logging level</span></span><br><span class="line">logging.level=$&#123;SW_LOGGING_LEVEL:INFO&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Logging dir</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> logging.dir=<span class="variable">$&#123;SW_LOGGING_DIR:""&#125;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Logging max_file_size, default: 300 * 1024 * 1024 = 314572800</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> logging.max_file_size=<span class="variable">$&#123;SW_LOGGING_MAX_FILE_SIZE:314572800&#125;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The max <span class="built_in">history</span> <span class="built_in">log</span> files. When rollover happened, <span class="keyword">if</span> <span class="built_in">log</span> files exceed this number,</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">then</span> the oldest file will be delete. Negative or zero means off, by default.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> logging.max_history_files=<span class="variable">$&#123;SW_LOGGING_MAX_HISTORY_FILES:-1&#125;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Listed exceptions would not be treated as an error. Because <span class="keyword">in</span> some codes, the exception is being used as a way of controlling business flow.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Besides, the annotation named IgnoredException <span class="keyword">in</span> the trace toolkit is another way to configure ignored exceptions.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> statuscheck.ignored_exceptions=<span class="variable">$&#123;SW_STATUSCHECK_IGNORED_EXCEPTIONS:&#125;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The max recursive depth when checking the exception traced by the agent. Typically, we don<span class="string">'t recommend setting this more than 10, which could cause a performance issue. Negative value and 0 would be ignored, which means all exceptions would make the span tagged in error status.</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> statuscheck.max_recursive_depth=<span class="variable">$&#123;SW_STATUSCHECK_MAX_RECURSIVE_DEPTH:1&#125;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Mount the specific folders of the plugins. Plugins <span class="keyword">in</span> mounted folders would work.</span></span><br><span class="line">plugin.mount=$&#123;SW_MOUNT_FOLDERS:plugins,activations&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Exclude activated plugins</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> plugin.exclude_plugins=<span class="variable">$&#123;SW_EXCLUDE_PLUGINS:&#125;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> mysql plugin configuration</span></span><br><span class="line">plugin.mysql.trace_sql_parameters=$&#123;SW_MYSQL_TRACE_SQL_PARAMETERS:true&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Kafka producer configuration</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> plugin.kafka.bootstrap_servers=<span class="variable">$&#123;SW_KAFKA_BOOTSTRAP_SERVERS:localhost:9092&#125;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Match spring bean with regex expression <span class="keyword">for</span> classname</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> plugin.springannotation.classname_match_regex=<span class="variable">$&#123;SW_SPRINGANNOTATION_CLASSNAME_MATCH_REGEX:&#125;</span></span></span><br></pre></td></tr></table></figure></p>
<h3 id="NodeJs接入"><a href="#NodeJs接入" class="headerlink" title="NodeJs接入"></a>NodeJs接入</h3><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">import <span class="built_in">Agent</span> <span class="keyword">from</span> <span class="string">'skywalking'</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">Agent</span>.start(&#123;</span><br><span class="line">  serviceName: <span class="string">''</span>,</span><br><span class="line">  serviceInstance: <span class="string">''</span>,</span><br><span class="line">  collectorAddress: <span class="string">''</span>,</span><br><span class="line">  authorization: <span class="string">''</span>,</span><br><span class="line">  maxBufferSize: <span class="number">1000</span>,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>参数包括：</p>
<p>Environment Variable | Description | Default<br>| — | — | — |<br>| <code>SW_AGENT_NAME</code> | The name of the service | <code>your-nodejs-service</code> |<br>| <code>SW_AGENT_INSTANCE</code> | The name of the service instance | Randomly generated |<br>| <code>SW_AGENT_COLLECTOR_BACKEND_SERVICES</code> | The backend OAP server address | <code>127.0.0.1:11800</code> |<br>| <code>SW_AGENT_AUTHENTICATION</code> | The authentication token to verify that the agent is trusted by the backend OAP, as for how to configure the backend, refer to <a href="https://github.com/apache/skywalking/blob/4f0f39ffccdc9b41049903cc540b8904f7c9728e/oap-server/server-bootstrap/src/main/resources/application.yml#L155-L158" target="_blank" rel="noopener">the yaml</a>. | not set |<br>| <code>SW_AGENT_LOGGING_LEVEL</code> | The logging level, could be one of <code>CRITICAL</code>, <code>FATAL</code>, <code>ERROR</code>, <code>WARN</code>(<code>WARNING</code>), <code>INFO</code>, <code>DEBUG</code> | <code>INFO</code> |<br>| <code>SW_AGENT_MAX_BUFFER_SIZE</code> | The maximum buffer size before sending the segment data to backend | <code>&#39;1000&#39;</code> |</p>
<h3 id="前端接入"><a href="#前端接入" class="headerlink" title="前端接入"></a>前端接入</h3><p>可以参考<a href="https://github.com/apache/skywalking-client-js" target="_blank" rel="noopener">官方文档</a></p>
<h2 id="高级功能"><a href="#高级功能" class="headerlink" title="高级功能"></a>高级功能</h2><h3 id="自己开发插件"><a href="#自己开发插件" class="headerlink" title="自己开发插件"></a>自己开发插件</h3><p>可以参考<a href="https://insights.thoughtworks.cn/skywalking-plugin-guide/" target="_blank" rel="noopener">文章</a>，已经写得很好了。。。我不需要再表述了.</p>
<p>开发插件后，可以给官方<a href="https://skywalking.apache.org/zh/2019-01-21-agent-plugin-practice/" target="_blank" rel="noopener">贡献一下</a></p>
<h3 id="浏览器端监控、使用标签查询、指标分析语言"><a href="#浏览器端监控、使用标签查询、指标分析语言" class="headerlink" title="浏览器端监控、使用标签查询、指标分析语言"></a>浏览器端监控、使用标签查询、指标分析语言</h3><p>参考<a href="https://skywalking.apache.org/zh/2020-10-29-skywalking8-2-release/" target="_blank" rel="noopener">官方文档</a></p>
<p>SkyWalking浏览器监视也提供以下数据: PV（page views，页面浏览量）， UV（unique visitors，独立访客数），浏览量前 N 的页面（Top N Page Views）等。这些数据可以为产品队伍优化他们的产品提供线索。</p>
<p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/plugin.intellij.assistant.mybaitslog-2020.1-1.0.3.jpg" alt="image"></p>
<p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/0081Kckwly1gkl5gnpi0dj30zk0m843n.jpg" alt="image"></p>
<h3 id="服务性能指标监控"><a href="#服务性能指标监控" class="headerlink" title="服务性能指标监控"></a>服务性能指标监控</h3><p>Skywalking还可以查看具体Service的性能指标，根据相关的性能指标可以分析系统的瓶颈所在并提出优化方案。</p>
<p>在服务调用拓扑图上点击相应的节点我们可以看到该服务的</p>
<ul>
<li>SLA: 服务可用性（主要是通过请求成功与失败次数来计算）</li>
<li>CPM: 每分钟调用次数</li>
<li>Avg Response Time: 平均响应时间</li>
</ul>
<p>从应用整体外部来看我们可以监测到应用在一定时间段内的</p>
<ul>
<li>服务可用性指标SLA</li>
<li>每分钟平均响应数</li>
<li>平均响应时间</li>
<li>服务进程PID</li>
<li>服务所在物理机的IP、HostName、Operation System</li>
</ul>
<h3 id="服务告警"><a href="#服务告警" class="headerlink" title="服务告警"></a>服务告警</h3><p>通过webhook的方式让我们可以自定义我们告警信息的通知方式。诸如:邮件通知、微信通知、短信通知等。</p>
<p>先来看一下告警的规则配置。在<code>alarm-settings.xml</code>中可以配置告警规则，告警规则支持自定义。</p>
<p>一份告警配置由以下几部分组成：</p>
<ul>
<li><code>service_resp_time_rule</code>：告警规则名称 <code>***_rule</code> （规则名称可以自定义但是必须以<code>_rule</code>结尾</li>
<li><code>indicator-name</code>：指标数据名称： 定义参见<code>http://t.cn/EGhfbmd</code></li>
<li><code>op</code>: 操作符： &gt; , &lt; , = 【当然你可以自己扩展开发其他的操作符】</li>
<li><code>threshold</code>：目标值：指标数据的目标数据 如sample中的1000就是服务响应时间，配合上操作符就是大于1000ms的服务响应</li>
<li><code>period</code>: 告警检查周期：多久检查一次当前的指标数据是否符合告警规则</li>
<li><code>counts</code>: 达到告警阈值的次数</li>
<li><code>silence-period</code>：忽略相同告警信息的周期</li>
<li><code>message</code>：告警信息</li>
<li><code>webhooks</code>：服务告警通知服务地</li>
</ul>
<p>Skywalking通过HttpClient的方式远程调用在配置项webhooks中定义的告警通知服务地址。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dinghuang.github.io/2020/12/08/Mysql最佳实践/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="强壮的病猫">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/dinghuang.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一只病猫">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/12/08/Mysql最佳实践/" itemprop="url">Mysql最佳实践</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-12-08T15:47:00+08:00">
                2020-12-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/" itemprop="url" rel="index">
                    <span itemprop="name">数据库</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/12/08/Mysql最佳实践/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/12/08/Mysql最佳实践/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <h1 id="建表规约"><a href="#建表规约" class="headerlink" title="建表规约"></a>建表规约</h1><h2 id="强制要求"><a href="#强制要求" class="headerlink" title="强制要求"></a>强制要求</h2><ol>
<li>表达是与否概念的字段，必须使用 <code>is_xxx</code> 的方式命名，数据类型是 <code>unsigned tinyint</code> （<code>1</code> 表示是， <code>0</code> 表示否）。<ul>
<li>说明： 任何字段如果为非负数，必须是 <code>unsigned</code>。</li>
<li>正例： 表达逻辑删除的字段名 <code>is_deleted</code>， 1 表示删除， 0 表示未删除。</li>
</ul>
</li>
<li>表名、字段名必须使用小写字母或数字，禁止出现数字开头，禁止两个下划线中间只出现数字。<ul>
<li>数据库字段名的修改代价很大，因为无法进行预发布，所以字段名称需要慎重考虑。</li>
<li>说明： MySQL 在 Windows 下不区分大小写，但在 Linux 下默认是区分大小写。因此，数据库名、表名、字段名，都不允许出现任何大写字母，避免节外生枝。</li>
<li>正例： <code>hap_admin</code>， <code>rdc_config</code>， <code>level3_name</code></li>
<li>反例： HapAdmin， rdcConfig， level_3_name</li>
</ul>
</li>
<li>表名不使用复数名词。<ul>
<li>说明： 表名应该仅仅表示表里面的实体内容，不应该表示实体数量，对应于 DO 类名也是单数形式，符合表达习惯。</li>
</ul>
</li>
<li>禁用保留字，如 <code>desc</code>、 <code>range</code>、 <code>match</code>、 <code>delayed</code> 等， 请参考 MySQL 官方保留字。</li>
<li>主键索引名为 <code>pk_字段名</code>； 唯一索引名为 <code>uk_字段名</code>； 普通索引名则为 <code>idx_字段名</code>。<ul>
<li>说明： pk_ 即 primary key； uk_ 即 unique key； idx_ 即 index 的简称。</li>
</ul>
</li>
<li>小数类型为 <code>decimal</code>，禁止使用 float 和 double。<ul>
<li>说明： float 和 double 在存储的时候，存在精度损失的问题，很可能在值的比较时，得到不正确的结果。如果存储的数据范围超过 decimal 的范围，建议将数据拆成整数和小数分开存储。</li>
</ul>
</li>
<li>如果存储的字符串长度几乎相等，使用 char 定长字符串类型。</li>
<li>varchar 是可变长字符串，不预先分配存储空间，长度不要超过5000，如果存储长度大于此值，定义字段类型为 text，独立出来一张表，用主键来对应，避免影响其它字段索引效率。<ul>
<li>说明： 该表的命名以 <code>原表名_字段缩写</code> 的格式命名。</li>
</ul>
</li>
<li><p>表必备字段： <code>id</code>, <code>create_date</code>, <code>last_update_date</code>, <code>create_by</code> , <code>last_update_by</code> , <code>object_version_number</code>。</p>
<ul>
<li>说明： 其中 id 必为主键，类型为 unsigned bigint、单表时自增、步长为 1。 </li>
<li><p><code>create_date</code>, <code>last_update_date</code> 的类型均为 datetime 类型，前者现在时表示主动创建，后者过去分词表示被动更新。</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">column</span>(<span class="attribute">name</span>: <span class="string">"object_version_number"</span>, <span class="attribute">type</span>: <span class="string">"BIGINT UNSIGNED"</span>, <span class="attribute">defaultValue</span>: <span class="string">"1"</span>)</span><br><span class="line"><span class="selector-tag">column</span>(<span class="attribute">name</span>: <span class="string">"created_by"</span>, <span class="attribute">type</span>: <span class="string">"BIGINT UNSIGNED"</span>, <span class="attribute">defaultValue</span>: <span class="string">"0"</span>)</span><br><span class="line"><span class="selector-tag">column</span>(<span class="attribute">name</span>: <span class="string">"creation_date"</span>, <span class="attribute">type</span>: <span class="string">"DATETIME"</span>, <span class="attribute">defaultValueComputed</span>: <span class="string">"CURRENT_TIMESTAMP"</span>)</span><br><span class="line"><span class="selector-tag">column</span>(<span class="attribute">name</span>: <span class="string">"last_updated_by"</span>, <span class="attribute">type</span>: <span class="string">"BIGINT UNSIGNED"</span>, <span class="attribute">defaultValue</span>: <span class="string">"0"</span>)</span><br><span class="line"><span class="selector-tag">column</span>(<span class="attribute">name</span>: <span class="string">"last_update_date"</span>, <span class="attribute">type</span>: <span class="string">"DATETIME"</span>, <span class="attribute">defaultValueComputed</span>: <span class="string">"CURRENT_TIMESTAMP"</span>)</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>表的命名最好是加上“业务名称_表的作用”。</p>
<ul>
<li>正例： <code>kanban_task</code> / <code>devops_project</code> / <code>website_config</code></li>
</ul>
</li>
<li><p>id类型没有特殊要求，必须使用bigint unsigned，禁止使用int，即使现在的数据量很小。id如果是数字类型的话，必须是8个字节。参见最后例子</p>
<ul>
<li>方便对接外部系统，还有可能产生很多废数据</li>
<li>避免废弃数据对系统id的影响</li>
<li>未来分库分表，自动生成id，一般也是8个字节</li>
</ul>
</li>
<li><p>更新数据表记录时，必须同时更新记录对应的 last_update_date 字段值为当前时间,</p>
<h2 id="推荐规约"><a href="#推荐规约" class="headerlink" title="推荐规约"></a>推荐规约</h2></li>
</ol>
<ol>
<li>库名与应用名称尽量一致。</li>
<li>如果修改字段含义或对字段表示的状态追加时，需要及时更新字段注释。</li>
<li>字段允许适当冗余，以提高查询性能，但必须考虑数据一致。冗余字段应遵循：<ul>
<li>不是频繁修改的字段。</li>
<li>不是 <code>varchar</code> 超长字段，更不能是 <code>text</code> 字段。</li>
</ul>
<ul>
<li>正例： 商品类目名称使用频率高， 字段长度短，名称基本一成不变， 可在相关联的表中冗余存储类目名称，避免关联查询。</li>
</ul>
</li>
<li>单表行数超过 500 万行或者单表容量超过 2GB，才推荐进行分库分表。<ul>
<li>说明： 如果预计三年后的数据量根本达不到这个级别，请不要在创建表时就分库分表。</li>
</ul>
</li>
</ol>
<h2 id="规约参考"><a href="#规约参考" class="headerlink" title="规约参考"></a>规约参考</h2><ol>
<li><p>合适的字符存储长度，不但节约数据库表空间、节约索引存储，更重要的是提升检索速度。</p>
<ul>
<li><p>正例： 如下表，其中无符号值可以避免误存负数，且扩大了表示范围。</p>
<p>|对象|年龄区间|类型|字节|表示范围|<br>|—-|——–|—-|—-|——–|<br>|人|150岁之内|<code>unsigned tinyint</code>|1|无符号值： 0 到 255|<br>|龟|数百岁|<code>unsigned smallint</code>|2|无符号值： 0 到 65535|<br>|恐龙化石|数千万年|<code>unsigned int</code>|4|无符号值： 0 到约 42.9 亿|<br>|太阳|约 50 亿年|<code>unsigned bigint</code>|8|无符号值： 0 到约 10 的 19 次方|</p>
</li>
</ul>
</li>
</ol>
<h1 id="索引规约"><a href="#索引规约" class="headerlink" title="索引规约"></a>索引规约</h1><h2 id="强制要求-1"><a href="#强制要求-1" class="headerlink" title="强制要求"></a>强制要求</h2><ol>
<li>业务上具有唯一特性的字段，即使是多个字段的组合，也必须建成唯一索引。<ul>
<li>说明：不要以为唯一索引影响了insert速度，这个速度损耗可以忽略，但提高查找速度是明显的；另外，即使在应用层做了非常完善的校验控制，只要没有唯一索引，根据墨菲定律，必然有脏数据产生。</li>
</ul>
</li>
<li>超过三个表禁止join。需要join的字段，数据类型必须绝对一致；多表关联查询时，保证被关联的字段需要有索引。<ul>
<li>说明：即使双表join也要注意表索引、SQL性能。</li>
</ul>
</li>
<li>在varchar字段上建立索引时，必须指定索引长度，没必要对全字段建立索引，根据实际文本区分度决定索引长度即可。<ul>
<li>说明：索引的长度与区分度是一对矛盾体，一般对字符串类型数据，长度为 20 的索引，区分度会高达90%以上，可以使用 count(distinct left(列名,索引长度))/count(*)的区分度来确定。</li>
</ul>
</li>
<li>页面搜索严禁左模糊或者全模糊，如果需要请走搜索引擎来解决(项目前期数据量不大可以不遵循这个要求，后续改进，不过需要留痕)。<ul>
<li>说明：索引文件具有B-Tree的最左前缀匹配特性，如果左边的值未确定，那么无法使用此索引。</li>
</ul>
</li>
</ol>
<h2 id="推荐规约-1"><a href="#推荐规约-1" class="headerlink" title="推荐规约"></a>推荐规约</h2><ol>
<li>如果有<code>order by</code>的场景，请注意利用索引的有序性。<code>order by</code> 最后的字段是组合索引的一部分，并且放在索引组合顺序的最后，避免出现file_sort的情况，影响查询性能。<ul>
<li>正例： where a=? and b=? order by c; 索引： a_b_c</li>
<li>反例： 索引中有范围查找，那么索引有序性无法利用，如： WHERE a&gt;10 ORDER BY b; 索引a_b无法排序。</li>
</ul>
</li>
<li>利用覆盖索引来进行查询操作， 避免回表。<ul>
<li>说明：如果一本书需要知道第 11 章是什么标题，会翻开第 11章对应的那一页吗？目录浏览一下就好，这个目录就是起到覆盖索引的作用。</li>
<li>正例：能够建立索引的种类分为主键索引、唯一索引、普通索引三种，而覆盖索引只是一种查询的一种效果，用explain 的结果，extra 列会出现： using index。</li>
</ul>
</li>
<li><p>利用延迟关联或者子查询优化超多分页场景。</p>
<ul>
<li>说明：MySQL 并不是跳过 offset 行，而是取 offset+N 行，然后返回放弃前offset行，返回N行，那当 offset 特别大的时候，效率就非常的低下，要么控制返回的总页数，要么对超过特定阈值的页数进行SQL改写。</li>
<li>正例：先快速定位需要获取的 id 段，然后再关联：  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> a.* <span class="keyword">FROM</span> 表 <span class="number">1</span> a, (<span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> 表 <span class="number">1</span> <span class="keyword">where</span> 条件 <span class="keyword">LIMIT</span> <span class="number">100000</span>,<span class="number">20</span> ) b <span class="keyword">where</span> a.id=b.id</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>SQL 性能优化的目标：至少要达到 range 级别，要求是ref级别，如果可以是consts最好。</p>
<ul>
<li>说明：<ol>
<li>consts 单表中最多只有一个匹配行（主键或者唯一索引），在优化阶段即可读取到数据。</li>
<li>ref 指的是使用普通的索引（<code>normal index</code>） 。</li>
<li>range 对索引进行范围检索。</li>
</ol>
</li>
<li>反例： explain 表的结果， type=index，索引物理文件全扫描，速度非常慢，这个 index 级别比较 range 还低，与全表扫描是小巫见大巫。</li>
</ul>
</li>
<li>建组合索引的时候，区分度最高的在最左边。<ul>
<li>正例： 如果 where a=? and b=? ， a列的几乎接近于唯一值，那么只需要单建 idx_a 索引即可。</li>
<li>说明： 存在非等号和等号混合判断条件时，在建索引时，请把等号条件的列前置。如： where a&gt;? and b=? 那么即使 a 的区分度更高，也必须把 b 放在索引的最前列。</li>
</ul>
</li>
<li>防止因字段类型不同造成的隐式转换，导致索引失效。</li>
</ol>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li>索引占磁盘空间，不要重复的索引，尽量短  </li>
<li>只给常用的查询条件加索引  </li>
<li>过滤性高的列建索引，取值范围固定的列不建索引 </li>
<li>唯一的记录添加唯一索引  </li>
<li>频繁更新的列不要建索引  </li>
<li>不要对索引列运算  </li>
<li>同样过滤效果下，保持索引长度最小  </li>
<li>合理利用组合索引，注意索引字段先后顺序  </li>
<li>多列组合索引，过滤性高的字段最前  </li>
<li>order by 字段建立索引，避免 filesort  </li>
<li>组合索引，不同的排序顺序不能使用索引  </li>
<li>&lt;&gt;!=无法使用索引</li>
</ul>
<h2 id="规约参考-1"><a href="#规约参考-1" class="headerlink" title="规约参考"></a>规约参考</h2><ol>
<li>创建索引时避免有如下极端误解：<ol>
<li>宁滥勿缺。 认为一个查询就需要建一个索引。</li>
<li>宁缺勿滥。认为索引会消耗空间、严重拖慢更新和新增速度。</li>
<li>抵制惟一索引。认为业务的惟一性一律需要在应用层通过“先查后插”方式解决。</li>
</ol>
</li>
</ol>
<h1 id="SQL-语句"><a href="#SQL-语句" class="headerlink" title="SQL 语句"></a>SQL 语句</h1><h2 id="强制要求-2"><a href="#强制要求-2" class="headerlink" title="强制要求"></a>强制要求</h2><ol>
<li>不要使用 count(列名)或 count(常量)来替代 <code>count(\*)</code>， count(*)是 SQL92 定义的标准统计行数的语法，跟数据库无关，跟 NULL 和非 NULL 无关。<ul>
<li>说明： count(*)会统计值为 NULL 的行，而 count(列名)不会统计此列为 NULL 值的行。</li>
</ul>
</li>
<li><code>count(distinct col)</code> 计算该列除 NULL 之外的不重复行数， 注意 count(distinct col1, col2) 如果其中一列全为 NULL，那么即使另一列有不同的值，也返回为 0。</li>
<li><p>当某一列的值全是 NULL 时， count(col)的返回结果为 0，但 sum(col)的返回结果为 NULL，因此使用 sum()时需注意 NPE 问题。</p>
<ul>
<li>正例： 可以使用如下方式来避免 sum 的 NPE 问题：   <figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT IF(<span class="name">ISNULL</span>(<span class="name">SUM</span>(<span class="name">g</span>)),<span class="number">0</span>,SUM(<span class="name">g</span>))</span><br><span class="line">FROM table<span class="comment">;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>使用 ISNULL()来判断是否为 NULL 值。</p>
<ul>
<li>说明： NULL 与任何值的直接比较都为 NULL。<ol>
<li>NULL&lt;&gt;NULL 的返回结果是 NULL， 而不是 false。</li>
<li>NULL=NULL 的返回结果是 NULL， 而不是 true。</li>
<li>NULL&lt;&gt;1 的返回结果是 NULL，而不是 true。</li>
</ol>
</li>
</ul>
</li>
<li>在代码中写分页查询逻辑时，若 count 为 0 应直接返回，避免执行后面的分页语句。</li>
<li>不得使用外键与级联，一切外键概念必须在应用层解决。<ul>
<li>说明：以学生和成绩的关系为例，学生表中的 student_id是主键，那么成绩表中的 student_id 则为外键。如果更新学生表中的 student_id，同时触发成绩表中的 student_id 更新， 即为级联更新。外键与级联更新适用于单机低并发，不适合分布式、高并发集群；级联更新是强阻塞，存在数据库更新风暴的风险:外键影响数据库的插入速度。</li>
</ul>
</li>
<li>禁止使用存储过程，存储过程难以调试和扩展，更没有移植性。</li>
<li>数据订正（特别是删除、 修改记录操作） 时，要先 select，避免出现误删除，确认无误才能执行更新语句。</li>
</ol>
<h2 id="推荐规约-2"><a href="#推荐规约-2" class="headerlink" title="推荐规约"></a>推荐规约</h2><ol>
<li>in 操作能避免则避免，若实在避免不了，需要仔细评估 in 后边的集合元素数量，控制在 1000 个之内。(多的话用 EXISTS 或 NOT EXISTS 代替)</li>
</ol>
<h2 id="规约参考-2"><a href="#规约参考-2" class="headerlink" title="规约参考"></a>规约参考</h2><ol>
<li><p>如果有全球化需要，所有的字符存储与表示，均以 utf-8 编码，注意字符统计函数的区别。</p>
<ul>
<li><p>说明：</p>
  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">LENGTH</span>(<span class="string">"轻松工作"</span>)；\\返回为 <span class="number">12</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">CHARACTER_LENGTH</span>(<span class="string">"轻松工作"</span>)；\\返回为 <span class="number">4</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>如果需要存储表情，那么选择 utf8mb4 来进行存储，注意它与 utf-8 编码的区别。</p>
</li>
</ul>
</li>
<li>不建议在开发代码中使用此语句 TRUNCATE TABLE<ul>
<li>TRUNCATE TABLE 比 DELETE 速度快，且使用的系统和事务日志资源少，但 TRUNCATE 无事务且不触发 trigger，有可能造成事故，故不建议在开发代码中使用此语句。</li>
<li>说明： TRUNCATE TABLE 在功能上与不带 WHERE 子句的 DELETE 语句相同。</li>
</ul>
</li>
</ol>
<h3 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h3><ul>
<li>能够快速缩小结果集的 WHERE 条件写在前面，如果有恒量条 件，也尽量放在前面 ，例如 where 1=1  </li>
<li>避免使用 GROUP BY、DISTINCT 等语句的使用，避免联表查 询和子查询 </li>
<li>能够使用索引的字段尽量进行有效的合理排列  </li>
<li>针对索引字段使用 &gt;, &gt;=, =, &lt;, &lt;=, IF NULL 和 BETWEEN 将会 使用索引，如果对某个索引字段进行 LIKE 查询，使用 LIKE   ‘%abc%’ 不能使用索引，使用 LIKE ‘abc%’ 将能够使用索引  </li>
<li>如果在 SQL 里使用了 MySQL部分自带函数，索引将失效</li>
<li>避免直接使用 select *,只取需要的字段，增加使用覆盖索引使用的可能  </li>
<li>对于大数据量的查询，尽量避免在 SQL 语句中使用 order by 字<br>句 </li>
<li>连表查询的情况下，要确保关联条件的数据类型一致，避免嵌<br>套子查询  </li>
<li>对于连续的数值，使用 between 代替 in  </li>
<li>where 语句中尽量不要使用 CASE 条件  </li>
<li>当只要一行数据时使用 LIMIT 1</li>
</ul>
<h1 id="ORM-映射"><a href="#ORM-映射" class="headerlink" title="ORM 映射"></a>ORM 映射</h1><h2 id="强制要求-3"><a href="#强制要求-3" class="headerlink" title="强制要求"></a>强制要求</h2><ol>
<li>在表查询中，一律不要使用 * 作为查询的字段列表，需要哪些字段必须明确写明。<ul>
<li>说明： <ol>
<li>增加查询分析器解析成本.</li>
<li>增减字段容易与 resultMap 配置不一致。</li>
</ol>
</li>
</ul>
</li>
<li>POJO 类的布尔属性不能加 is，而数据库字段必须加 is_，要求在 resultMap 中进行<br>字段与属性之间的映射。</li>
<li>不要用 resultClass 当返回参数，即使所有类属性名与数据库字段一一对应，也需要定义；反过来，每一个表也必然有一个与之对应。<ul>
<li>说明： 配置映射关系，使字段与 DO 类解耦，方便维护。</li>
</ul>
</li>
<li>sql.xml 配置参数使用： <code>#{}</code>， <code>#param#</code> 不要使用${} 此种方式容易出现 SQL 注入。</li>
<li><p>iBATIS 自带的 queryForList(String statementName,int start,int size)不推荐使用。</p>
<ul>
<li>说明：其实现方式是在数据库取到 statementName对应的SQL语句的所有记录，再通过 subList<br>取 start,size 的子集合。</li>
<li>正例：   <figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;<span class="keyword">String</span>, <span class="keyword">Object</span>&gt; <span class="built_in">map</span> = <span class="keyword">new</span> <span class="keyword">HashMap</span>&lt;<span class="keyword">String</span>, <span class="keyword">Object</span>&gt;();</span><br><span class="line"><span class="built_in">map</span>.put(<span class="string">"start"</span>, start);</span><br><span class="line"><span class="built_in">map</span>.put(<span class="string">"size"</span>, <span class="built_in">size</span>);</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>不允许直接拿 HashMap 与 Hashtable 作为查询结果集的输出。</p>
<ul>
<li>说明： resultClass=”Hashtable”， 会置入字段名和属性值，但是值的类型不可控。</li>
</ul>
</li>
<li>更新数据表记录时，必须同时更新记录对应的 gmt_modified 字段值为当前时间。</li>
</ol>
<h2 id="推荐规约-3"><a href="#推荐规约-3" class="headerlink" title="推荐规约"></a>推荐规约</h2><ol>
<li>不要写一个大而全的数据更新接口。 传入为 POJO 类，不管是不是自己的目标更新字<br>段，都进行 <code>update table set c1=value1,c2=value2,c3=value3;</code> 这是不对的。执行 SQL时， 不要更新无改动的字段，一是易出错； 二是效率低； 三是增加 binlog 存储。</li>
</ol>
<h2 id="规约参考-3"><a href="#规约参考-3" class="headerlink" title="规约参考"></a>规约参考</h2><ol>
<li><code>@Transactional</code> 事务不要滥用。事务会影响数据库的 QPS，另外使用事务的地方需要考虑各方面的回滚方案，包括缓存回滚、搜索引擎回滚、消息补偿、统计修正等。</li>
<li><code>&lt;isEqual&gt;</code>中的 <code>compareValue</code> 是与属性值对比的常量，一般是数字，表示相等时带上此条件； <code>&lt;isNotEmpty&gt;</code>表示不为空且不为 <code>null</code> 时执行；<code>&lt;isNotNull&gt;</code>表示不为 <code>null</code> 值时执行。</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dinghuang.github.io/2020/11/08/Git提交规范/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="强壮的病猫">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/dinghuang.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一只病猫">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/11/08/Git提交规范/" itemprop="url">Git提交规范</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-11-08T15:47:00+08:00">
                2020-11-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/GIT/" itemprop="url" rel="index">
                    <span itemprop="name">GIT</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/11/08/Git提交规范/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/11/08/Git提交规范/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <h1 id="设置用户"><a href="#设置用户" class="headerlink" title="设置用户"></a>设置用户</h1><p>首次拉代码后，在目录下用命令行设置用户信息</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git<span class="built_in"> config </span>core.ignorecase <span class="literal">false</span></span><br><span class="line">git<span class="built_in"> config </span>--global user.name <span class="string">"张三"</span></span><br><span class="line">git<span class="built_in"> config </span>--global user.email san.zhang@gmail.com</span><br></pre></td></tr></table></figure>
<h1 id="Git-Commit规范"><a href="#Git-Commit规范" class="headerlink" title="Git Commit规范"></a>Git Commit规范</h1><p>规定格式如下：<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="params">&lt;type&gt;</span>(<span class="params">&lt;scope&gt;</span>): <span class="params">&lt;subject&gt;</span> <span class="meta">#issue_number</span></span><br><span class="line"></span><br><span class="line"><span class="params">&lt;description&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>其中，type、scope、subject是必需的，description 可以省略。不管是哪一个部分，任何一行都不得超过72个字符（或100个字符）。这是为了避免自动换行影响美观。</p>
<h2 id="type-必须-取值说明"><a href="#type-必须-取值说明" class="headerlink" title="type(必须)取值说明"></a>type(必须)取值说明</h2><p>type用于说明 commit 的类别:</p>
<ul>
<li>feat: (feature)增加新功能</li>
<li>fix: 修补bug</li>
<li>docs: 文档（documentation）， 只改动了文档相关的内容</li>
<li>style: 不影响代码含义的改动，例如去掉空格、改变缩进、增删分号</li>
<li>build: 构造工具的或者外部依赖的改动，例如webpack，npm</li>
<li>refactor: 代码重构时使用</li>
<li>revert：回滚到上一个版本,执行git revert打印的message</li>
<li>test:  添加测试或者修改现有测试</li>
<li>pref: 提高性能的改动</li>
<li>chore: 不修改src或者test的其余修改，例如构建过程或辅助工具的变动</li>
<li>merge：代码合并</li>
<li>sync：同步主线或分支的Bug</li>
<li>ci: 与CI（持续集成服务）有关的改动</li>
</ul>
<h2 id="scope-可选-取值说明"><a href="#scope-可选-取值说明" class="headerlink" title="scope(可选)取值说明"></a>scope(可选)取值说明</h2><p>scope用于说明 commit影响的范围，比如数据层、控制层、视图层等等，视项目不同而不同。例如：<br>node-pc/common rrd-h5/activity，而we-sdk不需指定模块名。如果一次commit修改多个模块，建议拆分成多次commit，以便更好追踪和维护。后加入项目的新成员应遵循已有的 scope 约定（通过 git log可以查看某个文件的提交历史），不要自己编造。使用首字母小写的驼峰命名。除具体的模块、组件名之外，可以使用 base 表示基础结构、框架相关的改动，用 misc 表示杂项改动，用 all 表示大范围重构。</p>
<p>例如在Angular，可以是location，browser，compile，compile，rootScope， ngHref，ngClick，ngView等。如果你的修改影响了不止一个scope，你可以使用*代替。</p>
<h2 id="subject-必须"><a href="#subject-必须" class="headerlink" title="subject(必须)"></a>subject(必须)</h2><p>subject是 commit 目的的简短描述，50 个字符左右的简要说明。</p>
<h2 id="中文"><a href="#中文" class="headerlink" title="中文"></a>中文</h2><ul>
<li>结尾不加句号或其他标点符号。</li>
<li>根据以上规范git commit message将是如下的格式：<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">fix</span><span class="params">(DAO)</span></span>:用户查询缺少username属性 </span><br><span class="line"><span class="function"><span class="title">feat</span><span class="params">(Controller)</span></span>:用户查询接口开发</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>以上就是我们梳理的git commit规范，那么我们这样规范git commit到底有哪些好处呢？</p>
<ul>
<li>便于程序员对提交历史进行追溯，了解发生了什么情况。</li>
<li>一旦约束了commit message，意味着我们将慎重的进行每一次提交，不能再一股脑的把各种各样的改动都放在一个git commit里面，这样一来整个代码改动的历史也将更加清晰。</li>
<li>格式化的commit message才可以用于自动化输出Change log。</li>
</ul>
<h2 id="英文"><a href="#英文" class="headerlink" title="英文"></a>英文</h2><p>首字母小写，通常是动宾结构，描述做了什么事情，动词用一般现在时，禁止出现 update code ， fix bug 等无实际意义的描述，好的例子： select connector by sorting free memory （不需要形如 update about how to select connector … 的啰嗦写法）, fix success tip can not show on IE8 （不需要形如 fix bug of … 的啰嗦写法）</p>
<ul>
<li>以动词开头，使用第一人称现在时，比如change，而不是changed或changes</li>
<li>尽量使用简单句保证简洁性</li>
<li>第一个字母小写</li>
<li>结尾不加句号（.）</li>
<li>通过翻译检测工具确认英文的正确性和可读性</li>
</ul>
<h2 id="body"><a href="#body" class="headerlink" title="body"></a>body</h2><p>body填写详细描述，主要描述改动之前的情况及修改动机，对于小的修改不作要求，但是重大需求、更新等必须添加body来作说明。</p>
<h2 id="break-changes"><a href="#break-changes" class="headerlink" title="break changes"></a>break changes</h2><p>break changes指明是否产生了破坏性修改，涉及break changes的改动必须指明该项，类似版本升级、接口参数减少、接口删除、迁移等。</p>
<h2 id="affect-issues"><a href="#affect-issues" class="headerlink" title="affect issues"></a>affect issues</h2><p>affect issues指明是否影响了某个问题。例如我们使用jira时，我们在commit message中可以填写其影响的JIRA_ID，若要开启该功能需要先打通jira与gitlab。</p>
<h2 id="使用Commitizen工具"><a href="#使用Commitizen工具" class="headerlink" title="使用Commitizen工具"></a>使用Commitizen工具</h2><p>安装commitizen<br><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm <span class="keyword">install</span> -g commitizen</span><br></pre></td></tr></table></figure></p>
<p>安装完成后，使用<br><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">(base) [@dinghuangMacPro:test (master)]$git add .</span><br><span class="line">(base) [@dinghuangMacPro:test (master)]$git cz</span><br><span class="line"><span class="meta">#会出现下面的，按照提示写入</span></span><br><span class="line">(base) [@dinghuangMacPro:test (master)]$ git cz</span><br><span class="line">cz-cli@<span class="number">4.2</span><span class="number">.2</span>, cz-conventional-changelog@<span class="number">3.3</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line">? <span class="keyword">Select</span> the type <span class="keyword">of</span> change that you<span class="comment">'re committing: (Use arrow keys)</span></span><br><span class="line">❯ feat:     A <span class="keyword">new</span> feature</span><br><span class="line">  fix:      A bug fix</span><br><span class="line">  docs:     Documentation only changes</span><br><span class="line">  style:    Changes that <span class="keyword">do</span> <span class="keyword">not</span> affect the meaning <span class="keyword">of</span> the code (white-space, formatting, missing semi-colons, etc)</span><br><span class="line">  refactor: A code change that neither fixes a bug nor adds a feature</span><br><span class="line">  perf:     A code change that improves performance</span><br><span class="line">  test:     Adding missing tests <span class="keyword">or</span> correcting existing tests</span><br><span class="line">(Move up <span class="keyword">and</span> down <span class="keyword">to</span> reveal more choices)</span><br><span class="line"></span><br><span class="line"><span class="meta">#选择类型后</span></span><br><span class="line">? <span class="keyword">Select</span> the type <span class="keyword">of</span> change that you<span class="comment">'re committing: feat:     A new feature</span></span><br><span class="line">? What <span class="keyword">is</span> the scope <span class="keyword">of</span> this change (e.g. component <span class="keyword">or</span> file name): (press enter <span class="keyword">to</span> <span class="keyword">skip</span>) add aa.txt</span><br><span class="line">? Write a <span class="built_in">short</span>, imperative tense description <span class="keyword">of</span> the change (max <span class="number">82</span> chars):</span><br><span class="line"> (<span class="number">4</span>) 新增文件</span><br><span class="line">? Provide a longer description <span class="keyword">of</span> the change: (press enter <span class="keyword">to</span> <span class="keyword">skip</span>)</span><br><span class="line"> 长描述：这是我第一次的提交</span><br><span class="line">? Are there any breaking changes? No</span><br><span class="line">? Does this change affect any open issues? Yes</span><br><span class="line">? Add issue references (e.g. <span class="string">"fix #123"</span>, <span class="string">"re #123"</span>.):</span><br><span class="line"> feat <span class="meta">#123</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#查看生成的git commit信息</span></span><br><span class="line">(base) [@dinghuangMacPro:test (master)]$ git log</span><br><span class="line">commit <span class="number">00</span>d63b2c54c502bb75725e5a461d6ce9499910bc (HEAD -&gt; master)</span><br><span class="line">Author: 丁煌 &lt;dinghuang123@gmail.com&gt;</span><br><span class="line"><span class="built_in">Date</span>:   Wed Nov <span class="number">25</span> <span class="number">13</span>:<span class="number">39</span>:<span class="number">13</span> <span class="number">2020</span> +<span class="number">0800</span></span><br><span class="line"></span><br><span class="line">    feat(add aa.txt): 新增文件</span><br><span class="line"></span><br><span class="line">    长描述：这是我第一次的提交</span><br><span class="line"></span><br><span class="line">    feat <span class="meta">#123</span></span><br></pre></td></tr></table></figure></p>
<p>自动生成Change log<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install -g conventional-changelog-cli</span><br><span class="line">conventional-changelog -<span class="selector-tag">p</span> angular -<span class="selector-tag">i</span> CHANGELOG<span class="selector-class">.md</span> -s</span><br></pre></td></tr></table></figure></p>
<p>这个插件是根据当前分支提交的所有commit信息来生成对应的changelog，一般是在开发完成后，封代码后去进行生成。如果自动生成的有问题，可以根据自己的需求进行修改。</p>
<h1 id="分支规范"><a href="#分支规范" class="headerlink" title="分支规范"></a>分支规范</h1><h2 id="分支基本原则"><a href="#分支基本原则" class="headerlink" title="分支基本原则"></a>分支基本原则</h2><p>基本原则：master为保护分支，不直接在master上进行代码修改和提交。</p>
<p>开发日常需求或者项目时，从master分支上checkout一个feature分支进行开发或者bugfix分支进行bug修复，功能测试完毕并且项目发布上线后，将feature分支合并到主干master，并且打Tag发布，最后删除开发分支。</p>
<h2 id="分支命名规范"><a href="#分支命名规范" class="headerlink" title="分支命名规范"></a>分支命名规范</h2><p>例如：</p>
<ul>
<li>分支版本命名规则：分支类型 分支发布时间 分支功能。比如：feature_20200401_#issueNum<ul>
<li>分支类型包括：feature、bugfix、refactor三种类型，即新功能开发、bug修复和代码重构</li>
<li>时间使用年月日进行命名，不足2位补0</li>
<li>分支功能命名使用snake case命名法，即下划线命名。</li>
</ul>
</li>
<li>Tag包括3位版本，前缀使用v。比如v1.2.31。Tag命名规范：<ul>
<li>新功能开发使用第2位版本号，bug修复使用第3位版本号</li>
<li>核心基础库或者Node中间价可以在大版本发布请使用灰度版本号，在版本后面加上后缀，用中划线分隔。alpha或者belta后面加上次数，即第几次alpha(具体可以查看语义化版本)：<ul>
<li>v2.0.0-alpha-1</li>
<li>v2.0.0-belta-1</li>
</ul>
</li>
</ul>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dinghuang.github.io/2020/10/20/SpringBoot2.X Security Oauth2 JWT/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="强壮的病猫">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/dinghuang.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一只病猫">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/10/20/SpringBoot2.X Security Oauth2 JWT/" itemprop="url">SpringBoot2.X Security Oauth2 JWT</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-10-20T15:47:00+08:00">
                2020-10-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/10/20/SpringBoot2.X Security Oauth2 JWT/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/10/20/SpringBoot2.X Security Oauth2 JWT/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p><a href="hhttps://spring.io/projects/spring-security" target="_blank" rel="noopener">官网地址</a></p>
<p><a href="https://docs.spring.io/spring-security/site/docs/4.0.x/reference/html/introduction.html#what-is-acegi-security" target="_blank" rel="noopener">官方文档</a></p>
<p>Spring Security，这是一种基于 Spring AOP 和 Servlet 过滤器的安全框架。它提供全面的安全性解决方案，同时在 Web 请求级和方法调用级处理身份确认和授权。</p>
<p>Spring Security当前支持与所有以下技术的身份验证集</p>
<ul>
<li>HTTP BASIC authentication headers (an IETF RFC-based standard)</li>
<li>HTTP Digest authentication headers (an IETF RFC-based standard)</li>
<li>HTTP X.509 client certificate exchange (an IETF RFC-based standard)</li>
<li>LDAP (a very common approach to cross-platform authentication needs, especially in large environments)</li>
<li>Form-based authentication (for simple user interface needs)</li>
<li>OpenID authentication</li>
<li>Authentication based on pre-established request headers (such as Computer Associates Siteminder)</li>
<li>JA-SIG Central Authentication Service (otherwise known as CAS, which is a popular open source single sign-on system)</li>
<li>Transparent authentication context propagation for Remote Method Invocation (RMI) and HttpInvoker (a Spring remoting protocol)</li>
<li>Automatic “remember-me” authentication (so you can tick a box to avoid re-authentication for a predetermined period of time)</li>
<li>Anonymous authentication (allowing every unauthenticated call to automatically assume a particular security identity)</li>
<li>Run-as authentication (which is useful if one call should proceed with a different security identity)</li>
<li>Java Authentication and Authorization Service (JAAS)</li>
<li>JEE container autentication (so you can still use Container - Managed Authentication if desired)</li>
<li>Kerberos</li>
<li>Java Open Source Single Sign On (JOSSO) *</li>
<li>OpenNMS Network Management Platform *</li>
<li>AppFuse *</li>
<li>AndroMDA *</li>
<li>Mule ESB *</li>
<li>Direct Web Request (DWR) *</li>
<li>Grails *</li>
<li>Tapestry *</li>
<li>JTrac *</li>
<li>Jasypt *</li>
<li>Roller *</li>
<li>Elastic Path *</li>
<li>Atlassian Crowd *</li>
<li>Your own authentication systems (see below) </li>
</ul>
<p>涉及以下系统组件：<br>客户端：它可以是任何平台上的任何Web服务使用者。简而言之，它可以是另一个WebService，UI应用程序或Mobile平台，它们希望通过应用程序以安全的方式读写数据。<br>授权服务器：验证用户凭据，并颁发令牌。它根据不同的授予类型发行令牌。下面列出了最常见的<a href="hhttps://tools.ietf.org/html/draft-ietf-oauth-v2-31" target="_blank" rel="noopener">OAuth 2.0</a>授权类型：</p>
<ul>
<li>Authorization Code</li>
<li>Implicit</li>
<li>Password</li>
<li>Client Credentials</li>
<li>Device Code</li>
<li>Refresh Token</li>
</ul>
<p>名词解释可以看<a href="https://projects.spring.io/spring-security-oauth/docs/oauth2.html" target="_blank" rel="noopener">SpringOauth2官方文档</a></p>
<h1 id="架构设计"><a href="#架构设计" class="headerlink" title="架构设计"></a>架构设计</h1><p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/spring-boot-authentication-spring-security-architecture.png" alt="image"></p>
<h2 id="名词解释"><a href="#名词解释" class="headerlink" title="名词解释"></a>名词解释</h2><p>– WebSecurityConfigurerAdapter 是我们安全实施的关键。它提供HttpSecurity配置以配置cors，csrf，会话管理以及受保护资源的规则。我们还可以扩展和定制包含以下元素的默认配置。</p>
<p>– UserDetailsService 接口有一种方法可以按用户名加载User并返回UserDetailsSpring Security可以用于认证和验证的对象。</p>
<p>– UserDetails 包含用于构建身份验证对象的必要信息（例如：用户名，密码，授权机构）。</p>
<p>– UsernamePasswordAuthenticationToken 从登录请求中获取{用户名，密码}，AuthenticationManager将使用它来认证登录帐户。</p>
<p>– AuthenticationManager 有一个DaoAuthenticationProvider（与帮助UserDetailsService＆PasswordEncoder）来验证UsernamePasswordAuthenticationToken对象。如果成功，则AuthenticationManager返回完全填充的身份验证对象（包括授予的权限）。</p>
<p>– OncePerRequestFilter 对我们API的每个请求执行一次。它提供了一种doFilterInternal()方法，我们将实现解析和验证JWT，加载用户详细信息（使用UserDetailsService），检查授权（使用UsernamePasswordAuthenticationToken）。</p>
<p>– AuthenticationEntryPoint 当客户端未经身份验证访问受保护的资源时，将捕获未经授权的错误并返回401。</p>
<h2 id="认证流程"><a href="#认证流程" class="headerlink" title="认证流程"></a>认证流程</h2><p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/oauth-auth-code_c4oi91.png" alt="image"></p>
<h1 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h1><h2 id="引入maven包"><a href="#引入maven包" class="headerlink" title="引入maven包"></a>引入maven包</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span><span class="meta">?&gt;</span></span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">	<span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.1.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.security.oauth2<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-security-oauth2-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0.BUILD-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">packaging</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">modules</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">module</span>&gt;</span>auth-server<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">module</span>&gt;</span>client-app<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">module</span>&gt;</span>resource-server<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">modules</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.security.oauth<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-security-oauth2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.security.oauth.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-security-oauth2-autoconfigure<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.1.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.security<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-security-jwt<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.1.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.jsonwebtoken<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jjwt<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">version</span>&gt;</span>0.9.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>核心代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.security.oauth.config;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.AuthenticationException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.AuthenticationEntryPoint;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> dinghuang123@gmail.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2020/10/20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomerAuthenticationEntryPointConfiguration</span> <span class="keyword">implements</span> <span class="title">AuthenticationEntryPoint</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commence</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, AuthenticationException e)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        <span class="comment">//处理异常消息通知</span></span><br><span class="line">        httpServletResponse.getWriter().write(<span class="string">"暂无权限访问"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.security.oauth.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.AuthenticationProvider;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.UsernamePasswordAuthenticationToken;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.Authentication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.AuthenticationException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.authority.AuthorityUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.context.SecurityContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.User;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> dinghuang123@gmail.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2020/10/20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomerAuthenticationProviderConfiguration</span> <span class="keyword">implements</span> <span class="title">AuthenticationProvider</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Authentication <span class="title">authenticate</span><span class="params">(Authentication authentication)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">        <span class="comment">//这里做自定义的用户校验,可以对用户进行继承扩展</span></span><br><span class="line">        User user = <span class="keyword">new</span> User((String) authentication.getPrincipal(), (String) authentication.getCredentials(), AuthorityUtils.commaSeparatedStringToAuthorityList(<span class="string">"admin"</span>));</span><br><span class="line">        <span class="comment">//这里可以通过继承AbstractAuthenticationToken进行扩展</span></span><br><span class="line">        UsernamePasswordAuthenticationToken usernamePasswordAuthenticationToken = <span class="keyword">new</span> UsernamePasswordAuthenticationToken(authentication.getPrincipal(), authentication.getCredentials());</span><br><span class="line">        usernamePasswordAuthenticationToken.setDetails(user);</span><br><span class="line">        SecurityContextHolder.getContext().setAuthentication(usernamePasswordAuthenticationToken);</span><br><span class="line">        <span class="keyword">return</span> usernamePasswordAuthenticationToken;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(Class&lt;?&gt; aClass)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">package</span> <span class="selector-tag">org</span><span class="selector-class">.springframework</span><span class="selector-class">.security</span><span class="selector-class">.oauth</span><span class="selector-class">.config</span>;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">org</span><span class="selector-class">.springframework</span><span class="selector-class">.beans</span><span class="selector-class">.factory</span><span class="selector-class">.annotation</span><span class="selector-class">.Autowired</span>;</span><br><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">org</span><span class="selector-class">.springframework</span><span class="selector-class">.context</span><span class="selector-class">.annotation</span><span class="selector-class">.Configuration</span>;</span><br><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">org</span><span class="selector-class">.springframework</span><span class="selector-class">.security</span><span class="selector-class">.authentication</span><span class="selector-class">.AuthenticationManager</span>;</span><br><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">org</span><span class="selector-class">.springframework</span><span class="selector-class">.security</span><span class="selector-class">.core</span><span class="selector-class">.Authentication</span>;</span><br><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">org</span><span class="selector-class">.springframework</span><span class="selector-class">.security</span><span class="selector-class">.core</span><span class="selector-class">.AuthenticationException</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @author dinghuang123@gmail.com</span></span><br><span class="line"><span class="comment"> * @since 2020/10/20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">@<span class="keyword">Configuration</span></span><br><span class="line"><span class="keyword">public</span> class CustomerAuthenticationManager implements AuthenticationManager &#123;</span><br><span class="line"></span><br><span class="line">    @<span class="keyword">Autowired</span></span><br><span class="line">    private CustomerAuthenticationProviderConfiguration customerAuthenticationProviderConfiguration;</span><br><span class="line"></span><br><span class="line">    @<span class="keyword">Override</span></span><br><span class="line">    public Authentication authenticate(Authentication authentication) throws AuthenticationException &#123;</span><br><span class="line">        <span class="selector-tag">return</span> <span class="selector-tag">customerAuthenticationProviderConfiguration</span><span class="selector-class">.authenticate</span>(<span class="selector-tag">authentication</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.security.oauth.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth.properties.Oauth2ClientProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth.properties.Oauth2Properties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.builders.InMemoryClientDetailsServiceBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.configurers.ClientDetailsServiceConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.AuthorizationServerConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.EnableAuthorizationServer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configurers.AuthorizationServerEndpointsConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configurers.AuthorizationServerSecurityConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.TokenStore;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.store.JwtAccessTokenConverter;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> dinghuang123@gmail.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2020/10/20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAuthorizationServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomerAuthorizationServerConfiguration</span> <span class="keyword">extends</span> <span class="title">AuthorizationServerConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TokenStore tokenStore;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JwtAccessTokenConverter jwtAccessTokenConverter;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CustomerAuthenticationManager customerAuthenticationManager;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Oauth2Properties oauth2Properties;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CustomerWebResponseExceptionTranslator customerWebResponseExceptionTranslator;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthorizationServerEndpointsConfigurer authorizationServerEndpointsConfigurer)</span> </span>&#123;</span><br><span class="line">        authorizationServerEndpointsConfigurer.tokenEnhancer(jwtAccessTokenConverter)</span><br><span class="line">                .tokenStore(tokenStore)</span><br><span class="line">                .authenticationManager(customerAuthenticationManager)</span><br><span class="line">                .exceptionTranslator(customerWebResponseExceptionTranslator);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthorizationServerSecurityConfigurer authorizationServerSecurityConfigurer)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        authorizationServerSecurityConfigurer.tokenKeyAccess(<span class="string">"permitAll()"</span>)</span><br><span class="line">                .allowFormAuthenticationForClients()</span><br><span class="line">                .checkTokenAccess(<span class="string">"isAuthenticated"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(ClientDetailsServiceConfigurer clientDetailsServiceConfigurer)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        InMemoryClientDetailsServiceBuilder inMemoryClientDetailsServiceBuilder = clientDetailsServiceConfigurer.inMemory();</span><br><span class="line">        <span class="keyword">for</span> (Oauth2ClientProperties oauth2ClientProperties : oauth2Properties.getClients()) &#123;</span><br><span class="line">            inMemoryClientDetailsServiceBuilder.withClient(oauth2ClientProperties.getClientId())</span><br><span class="line">                    .secret(bCryptPasswordEncoder().encode(oauth2ClientProperties.getClientSecret()))</span><br><span class="line">                    .accessTokenValiditySeconds(oauth2ClientProperties.getAccessTokenValiditySeconds())</span><br><span class="line">                    .refreshTokenValiditySeconds(oauth2ClientProperties.getRefreshTokenValiditySeconds())</span><br><span class="line">                    .authorizedGrantTypes(<span class="string">"refresh_token"</span>, <span class="string">"password"</span>, <span class="string">"authorization_code"</span>)</span><br><span class="line">                    .scopes(oauth2ClientProperties.getScopes());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> BCryptPasswordEncoder <span class="title">bCryptPasswordEncoder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BCryptPasswordEncoder();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">package</span> <span class="selector-tag">org</span><span class="selector-class">.springframework</span><span class="selector-class">.security</span><span class="selector-class">.oauth</span><span class="selector-class">.config</span>;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">org</span><span class="selector-class">.springframework</span><span class="selector-class">.beans</span><span class="selector-class">.factory</span><span class="selector-class">.annotation</span><span class="selector-class">.Autowired</span>;</span><br><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">org</span><span class="selector-class">.springframework</span><span class="selector-class">.context</span><span class="selector-class">.annotation</span><span class="selector-class">.Configuration</span>;</span><br><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">org</span><span class="selector-class">.springframework</span><span class="selector-class">.security</span><span class="selector-class">.authentication</span><span class="selector-class">.AuthenticationManager</span>;</span><br><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">org</span><span class="selector-class">.springframework</span><span class="selector-class">.security</span><span class="selector-class">.config</span><span class="selector-class">.annotation</span><span class="selector-class">.web</span><span class="selector-class">.builders</span><span class="selector-class">.HttpSecurity</span>;</span><br><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">org</span><span class="selector-class">.springframework</span><span class="selector-class">.security</span><span class="selector-class">.config</span><span class="selector-class">.annotation</span><span class="selector-class">.web</span><span class="selector-class">.configuration</span><span class="selector-class">.EnableWebSecurity</span>;</span><br><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">org</span><span class="selector-class">.springframework</span><span class="selector-class">.security</span><span class="selector-class">.config</span><span class="selector-class">.annotation</span><span class="selector-class">.web</span><span class="selector-class">.configuration</span><span class="selector-class">.WebSecurityConfigurerAdapter</span>;</span><br><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">org</span><span class="selector-class">.springframework</span><span class="selector-class">.security</span><span class="selector-class">.oauth</span><span class="selector-class">.filter</span><span class="selector-class">.CustomerOauth2AuthenticationProcessingFilter</span>;</span><br><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">org</span><span class="selector-class">.springframework</span><span class="selector-class">.security</span><span class="selector-class">.web</span><span class="selector-class">.authentication</span><span class="selector-class">.AnonymousAuthenticationFilter</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @author dinghuang123@gmail.com</span></span><br><span class="line"><span class="comment"> * @since 2020/10/20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">@<span class="keyword">Configuration</span></span><br><span class="line">@<span class="keyword">EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> class CustomerSecurityConfiguration extends WebSecurityConfigurerAdapter &#123;</span><br><span class="line"></span><br><span class="line">    @<span class="keyword">Autowired</span></span><br><span class="line">    private CustomerAuthenticationManager customerAuthenticationManager;</span><br><span class="line">    @<span class="keyword">Autowired</span></span><br><span class="line">    private CustomerAuthenticationEntryPointConfiguration customerAuthenticationEntryPointConfiguration;</span><br><span class="line">    @<span class="keyword">Autowired</span></span><br><span class="line">    private CustomerOauth2AuthenticationProcessingFilter customerOauth2AuthenticationProcessingFilter;</span><br><span class="line"></span><br><span class="line">    @<span class="keyword">Override</span></span><br><span class="line">    protected void configure(HttpSecurity httpSecurity) throws  Exception&#123;</span><br><span class="line">        <span class="selector-tag">httpSecurity</span><span class="selector-class">.authorizeRequests</span>()<span class="selector-class">.anyRequest</span>()<span class="selector-class">.authenticated</span>()<span class="selector-class">.and</span>()<span class="selector-class">.addFilterBefore</span>(<span class="selector-tag">customerOauth2AuthenticationProcessingFilter</span>, <span class="selector-tag">AnonymousAuthenticationFilter</span><span class="selector-class">.class</span>)</span><br><span class="line">                <span class="selector-class">.csrf</span>()<span class="selector-class">.disable</span>()<span class="selector-class">.exceptionHandling</span>()<span class="selector-class">.authenticationEntryPoint</span>(<span class="selector-tag">customerAuthenticationEntryPointConfiguration</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @<span class="keyword">Override</span></span><br><span class="line">    public AuthenticationManager authenticationManager()&#123;</span><br><span class="line">        <span class="selector-tag">return</span> <span class="selector-tag">customerAuthenticationManager</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.security.oauth.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.common.exceptions.OAuth2Exception;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.error.WebResponseExceptionTranslator;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> dinghuang123@gmail.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2020/10/20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomerWebResponseExceptionTranslator</span> <span class="keyword">implements</span> <span class="title">WebResponseExceptionTranslator</span>&lt;<span class="title">OAuth2Exception</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseEntity&lt;OAuth2Exception&gt; <span class="title">translate</span><span class="params">(Exception e)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//自定义认证失败信息</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.security.oauth.config.token;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.AbstractAuthenticationToken;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.OAuth2Authentication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.AuthenticationKeyGenerator;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> dinghuang123@gmail.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2020/10/20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomerAuthenticationKeyGeneratorConfiguration</span> <span class="keyword">implements</span> <span class="title">AuthenticationKeyGenerator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">extractKey</span><span class="params">(OAuth2Authentication authentication)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//自定义token生成，可以用来实现ip控制登录用户只能有一个，顶掉登录</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.security.oauth.config.token;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.<span class="type">JwtHandlerAdapter</span>;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.<span class="type">Configuration</span>;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.common.<span class="type">OAuth2AccessToken</span>;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.<span class="type">OAuth2Authentication</span>;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.store.<span class="type">JwtAccessTokenConverter</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @author dinghuang123@gmail.com</span></span><br><span class="line"><span class="comment"> * @since 2020/10/20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">CustomerJwtAccessTokenConverterConfiguration</span> <span class="keyword">extends</span> <span class="title">JwtAccessTokenConverter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    public <span class="type">OAuth2AccessToken</span> enhance(<span class="type">OAuth2AccessToken</span> oAuth2AccessToken, <span class="type">OAuth2Authentication</span> oAuth2Authentication)&#123;</span><br><span class="line">       <span class="comment">//可以实现jwt的token放一些用户信息</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.enhance(oAuth2AccessToken,oAuth2Authentication);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.security.oauth.config.token;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.<span class="keyword">annotation</span>.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.<span class="keyword">annotation</span>.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.<span class="keyword">annotation</span>.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.<span class="keyword">data</span>.redis.connection.RedisConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth.properties.Oauth2Properties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.TokenStore;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.store.JwtAccessTokenConverter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth2.provider.token.store.redis.RedisTokenStore;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> dinghuang123<span class="doctag">@gmail</span>.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2020/10/20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomerJwtStoreConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisConnectionFactory redisConnectionFactory;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Oauth2Properties oauth2Properties;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CustomerAuthenticationKeyGeneratorConfiguration customerAuthenticationKeyGeneratorConfiguration;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CustomerJwtAccessTokenConverterConfiguration customerJwtAccessTokenConverterConfiguration;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> TokenStore redisTokenStore() &#123;</span><br><span class="line">        RedisTokenStore redisTokenStore = new RedisTokenStore(redisConnectionFactory);</span><br><span class="line">        redisTokenStore.setAuthenticationKeyGenerator(customerAuthenticationKeyGeneratorConfiguration);</span><br><span class="line">        <span class="keyword">return</span> redisTokenStore;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> JwtAccessTokenConverter jwtAccessTokenConverter() &#123;</span><br><span class="line">        customerJwtAccessTokenConverterConfiguration.setSigningKey(oauth2Properties.getJwtSigningKey());</span><br><span class="line">        <span class="keyword">return</span> customerJwtAccessTokenConverterConfiguration;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.security.oauth.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.InitializingBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.Authentication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.context.SecurityContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth.config.CustomerAuthenticationProviderConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.oauth.properties.Oauth2Properties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.AntPathMatcher;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> dinghuang123@gmail.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2020/10/20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomerOauth2AuthenticationProcessingFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span>, <span class="title">InitializingBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Oauth2Properties oauth2Properties;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CustomerAuthenticationProviderConfiguration customerAuthenticationProviderConfiguration;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        HttpServletRequest httpServletRequest = (HttpServletRequest) servletRequest;</span><br><span class="line">        <span class="comment">//白名单过滤</span></span><br><span class="line">        AntPathMatcher antPathMatcher = <span class="keyword">new</span> AntPathMatcher();</span><br><span class="line">        <span class="keyword">for</span> (String path : oauth2Properties.getPermitUrl().split(<span class="string">","</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (antPathMatcher.match(path, httpServletRequest.getPathInfo())) &#123;</span><br><span class="line">                filterChain.doFilter(servletRequest, servletResponse);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//自定义验证</span></span><br><span class="line">        Authentication authentication = getFromRequest(httpServletRequest);</span><br><span class="line">        <span class="keyword">if</span> (authentication == <span class="keyword">null</span>) &#123;</span><br><span class="line">            SecurityContextHolder.clearContext();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            SecurityContextHolder.getContext().setAuthentication(customerAuthenticationProviderConfiguration.authenticate(authentication));</span><br><span class="line">        &#125;</span><br><span class="line">        filterChain.doFilter(servletRequest, servletResponse);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Authentication <span class="title">getFromRequest</span><span class="params">(HttpServletRequest httpServletRequest)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//todo 这里可以自己去实现</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.security.oauth.properties;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> dinghuang123@gmail.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2020/10/20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Oauth2ClientProperties</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String clientId;</span><br><span class="line">    <span class="keyword">private</span> String clientSecret;</span><br><span class="line">    <span class="keyword">private</span> String scopes;</span><br><span class="line">    <span class="keyword">private</span> Integer accessTokenValiditySeconds;</span><br><span class="line">    <span class="keyword">private</span> Integer refreshTokenValiditySeconds;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getClientId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> clientId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setClientId</span><span class="params">(String clientId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.clientId = clientId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getClientSecret</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> clientSecret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setClientSecret</span><span class="params">(String clientSecret)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.clientSecret = clientSecret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getScopes</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> scopes;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setScopes</span><span class="params">(String scopes)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.scopes = scopes;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getAccessTokenValiditySeconds</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> accessTokenValiditySeconds;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAccessTokenValiditySeconds</span><span class="params">(Integer accessTokenValiditySeconds)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.accessTokenValiditySeconds = accessTokenValiditySeconds;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getRefreshTokenValiditySeconds</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> refreshTokenValiditySeconds;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRefreshTokenValiditySeconds</span><span class="params">(Integer refreshTokenValiditySeconds)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.refreshTokenValiditySeconds = refreshTokenValiditySeconds;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.security.oauth.properties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> dinghuang123@gmail.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2020/10/20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"security.oauth2"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Oauth2Properties</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String jwtSigningKey;</span><br><span class="line">    <span class="keyword">private</span> String permitUrl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Oauth2ClientProperties[] clients = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getJwtSigningKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> jwtSigningKey;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setJwtSigningKey</span><span class="params">(String jwtSigningKey)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.jwtSigningKey = jwtSigningKey;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPermitUrl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> permitUrl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPermitUrl</span><span class="params">(String permitUrl)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.permitUrl = permitUrl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Oauth2ClientProperties[] getClients() &#123;</span><br><span class="line">        <span class="keyword">return</span> clients;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setClients</span><span class="params">(Oauth2ClientProperties[] clients)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.clients = clients;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">server:</span></span><br><span class="line"><span class="symbol">  port:</span> <span class="number">8090</span></span><br><span class="line"><span class="symbol">spring:</span></span><br><span class="line"><span class="symbol">  redis:</span></span><br><span class="line"><span class="symbol">    host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line"><span class="symbol">    port:</span> <span class="number">6379</span></span><br><span class="line"><span class="symbol">    password:</span></span><br><span class="line"><span class="symbol">security:</span></span><br><span class="line"><span class="symbol">  oauth2:</span></span><br><span class="line"><span class="symbol">    jwtSigningKey:</span> admin</span><br><span class="line"><span class="symbol">    permitUrl:</span> <span class="meta-keyword">/oauth/</span>**</span><br><span class="line">    clients[<span class="number">0</span>]:</span><br><span class="line"><span class="symbol">      clientId:</span> client</span><br><span class="line"><span class="symbol">      clientSecret:</span> client</span><br><span class="line"><span class="symbol">      scopes:</span> all</span><br><span class="line"><span class="symbol">      accessTokenValiditySeconds:</span> <span class="number">864000</span></span><br><span class="line"><span class="symbol">      refreshTokenValiditySeconds:</span> <span class="number">864000</span></span><br><span class="line"><span class="symbol">logging:</span></span><br><span class="line"><span class="symbol">  level:</span></span><br><span class="line"><span class="symbol">    root:</span> WARN</span><br><span class="line">    org.springframework.web: INFO</span><br><span class="line">    org.springframework.security: INFO</span><br><span class="line">    org.springframework.security.oauth2: INFO</span><br></pre></td></tr></table></figure>
<h2 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h2><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">curl</span> -H <span class="string">"Content-Type: application/json"</span> -X POST <span class="string">"http://localhost:8090/oauth/token?client_id=client&amp;client_secret=client&amp;grant_type=pwssword&amp;username=admin&amp;password&amp;admin"</span></span><br></pre></td></tr></table></figure>
<p><a href="https://github.com/dinghuang/spring-security-oauth2-demo.git" target="_blank" rel="noopener">代码地址</a></p>
<h1 id="结合网关"><a href="#结合网关" class="headerlink" title="结合网关"></a>结合网关</h1><h2 id="架构设计-1"><a href="#架构设计-1" class="headerlink" title="架构设计"></a>架构设计</h2><p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/viaL4.png" alt="image"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dinghuang.github.io/2020/09/08/如何画架构设计图/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="强壮的病猫">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/dinghuang.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一只病猫">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/09/08/如何画架构设计图/" itemprop="url">如何画架构设计图</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-09-08T15:47:00+08:00">
                2020-09-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/架构/" itemprop="url" rel="index">
                    <span itemprop="name">架构</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/09/08/如何画架构设计图/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/09/08/如何画架构设计图/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <h1 id="如何画架构设计图"><a href="#如何画架构设计图" class="headerlink" title="如何画架构设计图"></a>如何画架构设计图</h1><p>转载于<a href="https://www.zhihu.com/question/27440059/answer/780182558?utm_campaign=shareopn&amp;utm_content=group2_Answer&amp;utm_medium=social&amp;utm_oi=771100730449731584&amp;utm_source=wechat_session&amp;s_r=0" target="_blank" rel="noopener">知乎</a></p>
<h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h2><h3 id="什么是架构"><a href="#什么是架构" class="headerlink" title="什么是架构"></a>什么是架构</h3><p>架构就是对系统中的实体以及实体之间的关系所进行的抽象描述，是一系列的决策。</p>
<p>架构是结构和愿景。</p>
<p>系统架构是概念的体现，是对物/信息的功能与形式元素之间的对应情况所做的分配，是对元素之间的关系以及元素同周边环境之间的关系所做的定义。</p>
<p>做好架构是个复杂的任务有了架构之后，就需要让干系人理解、遵循相关决策。</p>
<h3 id="什么是架构图"><a href="#什么是架构图" class="headerlink" title="什么是架构图"></a>什么是架构图</h3><p>系统架构图是为了抽象的表示软件系统的整体轮廓和各个组件之间的相互关系和约束边界，以及软件系统的物理部署和软件系统的演进方向的整体视图。</p>
<h3 id="架构图的作用"><a href="#架构图的作用" class="headerlink" title="架构图的作用"></a>架构图的作用</h3><p>一图胜千言。要让干系人理解、遵循架构决策，就需要把架构信息传递出去。架构图就是一个很好的载体。那么，画架构图是为了：</p>
<ul>
<li>解决沟通障碍</li>
<li>达成共识</li>
<li>减少歧义</li>
</ul>
<h2 id="架构图分类"><a href="#架构图分类" class="headerlink" title="架构图分类"></a>架构图分类</h2><p>搜集了很多资料，分类有很多，有一种比较流行的是4+1视图，分别为场景视图、逻辑视图、物理视图、处理流程视图和开发视图。</p>
<h3 id="场景视图"><a href="#场景视图" class="headerlink" title="场景视图"></a>场景视图</h3><p>场景视图用于描述系统的参与者与功能用例间的关系,反映系统的最终需求和交互设计,通常由用例图表示。<br><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/v2-d85450f5fde7b1b952c375aeb5b08ef9_1440w.jpg" alt="image"></p>
<h3 id="逻辑视图"><a href="#逻辑视图" class="headerlink" title="逻辑视图"></a>逻辑视图</h3><p>逻辑视图用于描述系统软件功能拆解后的组件关系,组件约束和边界,反映系统整体组成与系统如何构建的过程,通常由UML的组件图和类图来表示。</p>
<p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/v2-e3e7793037d994f51a70875c976bae8d_1440w.jpg" alt="image"></p>
<h3 id="物理视图"><a href="#物理视图" class="headerlink" title="物理视图"></a>物理视图</h3><p>物理视图用于描述系统软件到物理硬件的映射关系,反映出系统的组件是如何部署到一组可计算机器节点上,用于指导软件系统的部署实施过程</p>
<p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/v2-f8aa7bd39f8c1ff151d42abe295eac1e_1440w.jpg" alt="image"></p>
<h3 id="处理流程视图"><a href="#处理流程视图" class="headerlink" title="处理流程视图"></a>处理流程视图</h3><p>处理流程视图用于描述系统软件组件之间的通信时序,数据的输入输出,反映系统的功能流程与数据流程,通常由时序图和流程图表示。</p>
<p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/v2-f75cf601674f20a7b06df2a3cc2fb934_1440w.jpg" alt="image"></p>
<h3 id="开发视图"><a href="#开发视图" class="headerlink" title="开发视图"></a>开发视图</h3><p>开发视图用于描述系统的模块划分和组成,以及细化到内部包的组成设计,服务于开发人员,反映系统开发实施过程。<br><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/v2-594b11d0f1c0b0e2bba824f5d489e403_1440w.jpg" alt="image"></p>
<p>5 种架构视图从不同角度表示一个软件系统的不同特征，组合到一起作为架构蓝图描述系统架构。</p>
<h2 id="好的架构图"><a href="#好的架构图" class="headerlink" title="好的架构图"></a>好的架构图</h2><p>上面的分类是前人的经验总结，图也是从网上摘来的，那么这些图画的好不好呢？是不是我们要依葫芦画瓢去画这样一些图？</p>
<p>先不去管这些图好不好，我们通过对这些图的分类以及作用，思考了一下，总结下来，我们认为，在画出一个好的架构图之前， 首先应该要明确其受众，再想清楚要给他们传递什么信息 ，所以，不要为了画一个物理视图去画物理视图，为了画一个逻辑视图去画逻辑视图，而应该根据受众的不同，传递的信息的不同，用图准确地表达出来，最后的图可能就是在这样一些分类里。那么，画出的图好不好的一个直接标准就是：受众有没有准确接收到想传递的信息。</p>
<p>明确这两点之后，从受众角度来说，一个好的架构图是不需要解释的，它应该是自描述的，并且要具备一致性和足够的准确性，能够与代码相呼应。</p>
<h3 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h3><ul>
<li>方框代表什么？</li>
</ul>
<p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/v2-1542f3d3594594c88b2abad7926f32af_1440w.jpg" alt="image"></p>
<p>为什么适用方框而不是圆形，它有什么特殊的含义吗？随意使用方框或者其它形状可能会引起混淆。</p>
<ul>
<li>虚线、实线什么意思？箭头什么意思？颜色什么意思？</li>
</ul>
<p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/v2-f793c4721c9101087656c109c315585c_1440w.jpg" alt="image"></p>
<p>随意使用线条或者箭头可能会引起误会。</p>
<ul>
<li>运行时与编译时冲突？层级冲突？</li>
</ul>
<p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/v2-f793c4721c9101087656c109c315585c_1440w.jpg" alt="image"></p>
<p>架构是一项复杂的工作，只使用单个图表来表示架构很容易造成莫名其妙的语义混乱。</p>
<h2 id="如何更好的表达软件架构"><a href="#如何更好的表达软件架构" class="headerlink" title="如何更好的表达软件架构"></a>如何更好的表达软件架构</h2><h3 id="C4"><a href="#C4" class="headerlink" title="C4"></a>C4</h3><p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/v2-8576e8884006dfb5e2e88fa4405ae0f9_1440w.jpg" alt="image"></p>
<p>C4 模型使用容器（应用程序、数据存储、微服务等）、组件和代码来描述一个软件系统的静态结构。这几种图比较容易画，也给出了画图要点，但最关键的是，我们认为，它明确指出了每种图可能的受众以及意义。</p>
<p>下面的案例来自C4官网，然后加上了一些我们的理解。</p>
<h3 id="语境图-System-Context-Diagram"><a href="#语境图-System-Context-Diagram" class="headerlink" title="语境图(System Context Diagram)"></a>语境图(System Context Diagram)</h3><p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/v2-cf751ecece5c86fef705d44e422f088b_1440w.jpg" alt="image"></p>
<p>这是一个想象的待建设的互联网银行系统，它使用外部的大型机银行系统存取客户账户、交易信息，通过外部电邮系统给客户发邮件。可以看到，非常简单、清晰，相信不需要解释，都看的明白，里面包含了需要建设的系统本身，系统的客户，和这个系统有交互的周边系统。</p>
<h4 id="用途"><a href="#用途" class="headerlink" title="用途"></a>用途</h4><p>这样一个简单的图，可以告诉我们，要构建的系统是什么；它的用户是谁，谁会用它，它要如何融入已有的IT环境。这个图的受众可以是开发团队的内部人员、外部的技术或非技术人员。即：</p>
<ul>
<li>构建的系统是什么</li>
<li>谁会用它</li>
<li>如何融入已有的IT环境</li>
</ul>
<h4 id="怎么画"><a href="#怎么画" class="headerlink" title="怎么画"></a>怎么画</h4><p>中间是自己的系统，周围是用户和其它与之相互作用的系统。这个图的关键就是梳理清楚待建设系统的用户和高层次的依赖，梳理清楚了画下来只需要几分钟时间。</p>
<h3 id="容器图-Container-Diagram"><a href="#容器图-Container-Diagram" class="headerlink" title="容器图(Container Diagram)"></a>容器图(Container Diagram)</h3><p>容器图是把语境图里待建设的系统做了一个展开。</p>
<p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/v2-542d65da584b32dbfe6e63d208484670_1440w.jpg" alt="image"></p>
<p>上图中，除了用户和外围系统，要建设的系统包括一个基于java\spring mvc的web应用提供系统的功能入口，基于xamarin架构的手机app提供手机端的功能入口，一个基于java的api应用提供服务，一个mysql数据库用于存储，各个应用之间的交互都在箭头线上写明了。</p>
<p>看这张图的时候，不会去关注到图中是直角方框还是圆角方框，不会关注是实线箭头还是虚线箭头，甚至箭头的指向也没有引起太多注意。</p>
<p>我们有许多的画图方式，都对框、线的含义做了定义，这就需要画图的人和看图的人都清晰的理解这些定义，才能读全图里的信息，而现实是，这往往是非常高的一个要求，所以，很多图只能看个大概的含义。</p>
<h4 id="用途-1"><a href="#用途-1" class="headerlink" title="用途"></a>用途</h4><p>这个图的受众可以是团队内部或外部的开发人员，也可以是运维人员。用途可以罗列为：</p>
<ul>
<li>展现了软件系统的整体形态</li>
<li>体现了高层次的技术决策</li>
<li>系统中的职责是如何分布的，容器间的是如何交互的</li>
<li>告诉开发者在哪里写代码</li>
</ul>
<h4 id="怎么画-1"><a href="#怎么画-1" class="headerlink" title="怎么画"></a>怎么画</h4><p>用一个框图来表示，内部可能包括名称、技术选择、职责，以及这些框图之间的交互，如果涉及外部系统，最好明确边界</p>
<h3 id="组件图-Component-Diagram"><a href="#组件图-Component-Diagram" class="headerlink" title="组件图(Component Diagram)"></a>组件图(Component Diagram)</h3><p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/v2-b320fa5f7733cb8e7b9f45a910aadb3f_1440w.jpg" alt="image"></p>
<p>组件图是把某个容器进行展开，描述其内部的模块。</p>
<h4 id="用途-2"><a href="#用途-2" class="headerlink" title="用途"></a>用途</h4><p>这个图主要是给内部开发人员看的，怎么去做代码的组织和构建。其用途有</p>
<ul>
<li>描述了系统由哪些组件/服务组成</li>
<li>厘清了组件之间的关系和依赖</li>
<li>为软件开发如何分解交付提供了框架</li>
</ul>
<h3 id="类图-Code-Class-Diagram"><a href="#类图-Code-Class-Diagram" class="headerlink" title="类图(Code/Class Diagram)"></a>类图(Code/Class Diagram)</h3><p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/v2-bbfef0211b32a11ee209140f964ae233_1440w.jpg" alt="image"></p>
<h2 id="工具使用"><a href="#工具使用" class="headerlink" title="工具使用"></a>工具使用</h2><h3 id="本地协作"><a href="#本地协作" class="headerlink" title="本地协作"></a>本地协作</h3><h4 id="Mac-OmniGraffle"><a href="#Mac-OmniGraffle" class="headerlink" title="Mac:OmniGraffle"></a>Mac:OmniGraffle</h4><p>OmniGraffle 是由 The Omni Group 制作的一款绘图软件，它曾获得苹果设计奖。OmniGraffle 可以支持流程图、逻辑图或者网页产品模型设计等，功能非常强大。与 Graffle 对应的是在Windows平台广泛应用的 MS Visio（ Graffle 这个词据说就是为了和Visio区分而硬造出来的）</p>
<h4 id="Windows-Visio"><a href="#Windows-Visio" class="headerlink" title="Windows:Visio"></a>Windows:Visio</h4><p>Office Visio 是office软件系列中的负责绘制流程图和示意图的软件，是一款便于IT和商务人员就复杂信息、系统和流程进行可视化处理、分析和交流的软件。使用具有专业外观的 Office Visio 图表，可以促进对系统和流程的了解，深入了解复杂信息并利用这些知识做出更好的业务决策。<br>Microsoft Office Visio帮助您创建具有专业外观的图表，以便理解、记录和分析信息、数据、系统和过程。</p>
<h3 id="在线协作"><a href="#在线协作" class="headerlink" title="在线协作"></a>在线协作</h3><h4 id="Process-On"><a href="#Process-On" class="headerlink" title="Process On"></a>Process On</h4><p>是一款用HTML5、Canvas以及JavaScript技术开发而成的在线网页版作图工具。只需在工具栏拖放对应的图形到画布中,就可进行编辑，还支持流程图、思维导图、原型、拓扑图等，最让人心动的就是有实时协助的功能，从此再也不需要和同学、老师、领导之间来回传送文件，直接邀请，一起协作完成。</p>
<h2 id="案例分享"><a href="#案例分享" class="headerlink" title="案例分享"></a>案例分享</h2><p>下面是 城市运营态势 工具的一个架构图。作为一个应该自描述的架构图，这里不多做解释了。如果有看不明白的，那肯定是还画的不够好。</p>
<p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/v2-a6bc2de3271462f663b3d0203ba42050_1440w.jpg" alt="image"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dinghuang.github.io/2020/07/06/ELK日志管理系统/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="强壮的病猫">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/dinghuang.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一只病猫">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/07/06/ELK日志管理系统/" itemprop="url">ELK日志管理系统</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-07-06T18:33:00+08:00">
                2020-07-06
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JAVA/" itemprop="url" rel="index">
                    <span itemprop="name">JAVA</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/07/06/ELK日志管理系统/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/07/06/ELK日志管理系统/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>官方文档:<a href="https://www.elastic.co/guide/en/elastic-stack/current/overview.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elastic-stack/current/overview.html</a></p>
<h1 id="搭建"><a href="#搭建" class="headerlink" title="搭建"></a>搭建</h1><p>本教程基于Elasticsearch版本7.7.0</p>
<p>要在docker中搭建，要起3个套件</p>
<p>其中elasticearch会遇到docker内存问题，可以看这个解决<br><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docker.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/current/docker.html</a></p>
<p>或者<br>macOS with Docker for Mac</p>
<p>The vm.max_map_count setting must be set within the xhyve virtual machine:</p>
<p>From the command line, run:</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">screen ~<span class="regexp">/Library/</span>Containers<span class="regexp">/com.docker.docker/</span>Data<span class="regexp">/vms/</span><span class="number">0</span><span class="regexp">/tty</span></span><br></pre></td></tr></table></figure>
<p>Press enter and use<code>sysctl</code> to configure vm.max_map_count:<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl -w vm.<span class="attribute">max_map_count</span>=262144</span><br></pre></td></tr></table></figure></p>
<p>To exit the screen session, type Ctrl a d.</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker network create elasticsearch</span><br><span class="line">docker pull docker<span class="selector-class">.elastic</span><span class="selector-class">.co</span>/elasticsearch/elasticsearch:<span class="number">7.7</span>.<span class="number">0</span></span><br><span class="line">docker run -d -<span class="selector-tag">p</span> <span class="number">9200</span>:<span class="number">9200</span> -<span class="selector-tag">p</span> <span class="number">9300</span>:<span class="number">9300</span> --network elasticsearch -e <span class="string">"discovery.type=single-node"</span> --name elasticsearch docker<span class="selector-class">.elastic</span><span class="selector-class">.co</span>/elasticsearch/elasticsearch:<span class="number">7.7</span>.<span class="number">0</span></span><br><span class="line">docker pull docker<span class="selector-class">.elastic</span><span class="selector-class">.co</span>/kibana/kibana:<span class="number">7.7</span>.<span class="number">0</span></span><br><span class="line">docker run -d --link elasticsearch:elasticsearch --name kibana -<span class="selector-tag">p</span> <span class="number">5601</span>:<span class="number">5601</span> --network elasticsearch docker<span class="selector-class">.elastic</span><span class="selector-class">.co</span>/kibana/kibana:<span class="number">7.7</span>.<span class="number">0</span></span><br><span class="line">docker pull docker<span class="selector-class">.elastic</span><span class="selector-class">.co</span>/logstash/logstash:<span class="number">7.7</span>.<span class="number">0</span></span><br><span class="line">docker run -d -<span class="selector-tag">p</span> <span class="number">5044</span>:<span class="number">5044</span>  --network elasticsearch --link elasticsearch:elasticsearch --name logstash docker<span class="selector-class">.elastic</span><span class="selector-class">.co</span>/logstash/logstash:<span class="number">7.7</span>.<span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>遇到错误<br><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Security must be explicitly enabled when <span class="keyword">using</span> <span class="keyword">a</span> [basic] license. Enable security <span class="keyword">by</span> setting [xpack.security.enabled] <span class="built_in">to</span> [<span class="literal">true</span>] <span class="keyword">in</span> <span class="keyword">the</span> elasticsearch.yml <span class="built_in">file</span> <span class="keyword">and</span> restart <span class="keyword">the</span> node.</span><br></pre></td></tr></table></figure></p>
<p>编辑elasticsearch.yml，加入<code>xpack.security.enabled:true</code>,然后重启节点<br>重启时遇到错误:<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ERROR: [<span class="number">1</span>] bootstrap checks failed</span><br><span class="line"> [<span class="number">1</span>]: Transport SSL must be enabled <span class="keyword">if</span> security <span class="keyword">is</span> enabled <span class="keyword">on</span> a [basic] license. Please <span class="keyword">set</span> [xpack.security.transport.ssl.enabled] <span class="keyword">to</span> [<span class="literal">true</span>] <span class="keyword">or</span> disable security <span class="keyword">by</span> setting [xpack.security.enabled] <span class="keyword">to</span> [<span class="literal">false</span>]</span><br></pre></td></tr></table></figure></p>
<p>编辑elasticsearch.yml，加入<code>xpack.security.transport.ssl.enabled:true</code>,然后重启节点</p>
<p>执行设置用户名和密码的命令,这里需要为4个用户分别设置密码，<code>elastic, kibana, logstash_system,beats_system</code></p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/elasticsearch-<span class="built_in">setup</span>-passwords interactive</span><br></pre></td></tr></table></figure>
<h1 id="配置文件修改"><a href="#配置文件修改" class="headerlink" title="配置文件修改"></a>配置文件修改</h1><p>进入logstash容器里面修改配置文件<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it <span class="number">54</span>b504186a47 <span class="regexp">/bin/</span>bash <span class="comment"># 这里 54b504186a47是容器id</span></span><br><span class="line">vi <span class="regexp">/usr/</span>share<span class="regexp">/logstash/</span>config<span class="regexp">/logstash.yml</span></span><br></pre></td></tr></table></figure></p>
<p>logstash.yml配置文件如下<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">http<span class="selector-class">.host</span>: <span class="string">"0.0.0.0"</span></span><br><span class="line">xpack<span class="selector-class">.monitoring</span><span class="selector-class">.elasticsearch</span><span class="selector-class">.hosts</span>: [ <span class="string">"http://elasticsearch:9200"</span> ]</span><br><span class="line">path<span class="selector-class">.config</span>: /usr/share/logstash/config<span class="comment">/*.conf</span></span><br><span class="line"><span class="comment">path.logs: /var/log/logstash</span></span><br></pre></td></tr></table></figure></p>
<p>修改logstash-sample.conf<br><figure class="highlight puppet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">input</span> &#123;</span><br><span class="line">  tcp &#123;</span><br><span class="line">    <span class="attr">mode</span> =&gt; <span class="string">"server"</span></span><br><span class="line">    <span class="attr">host</span> =&gt; <span class="string">"0.0.0.0"</span></span><br><span class="line">    <span class="attr">codec</span> =&gt; json_lines</span><br><span class="line">    <span class="attr">port</span> =&gt; <span class="number">5044</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">output</span> &#123;</span><br><span class="line">  elasticsearch &#123;</span><br><span class="line">    <span class="attr">hosts</span> =&gt; [<span class="string">"http://elasticsearch:9200"</span>]</span><br><span class="line">    <span class="attr">index</span> =&gt; <span class="string">"springboot-logstash-%&#123;+YYYY.MM.dd&#125;"</span></span><br><span class="line">    <span class="comment">#user =&gt; "elastic"</span></span><br><span class="line">    <span class="comment">#password =&gt; "changeme"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这样logstash的读取就是通过一个tcp服务读取</p>
<h1 id="springboot结合"><a href="#springboot结合" class="headerlink" title="springboot结合"></a>springboot结合</h1><p>引入包<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>net.logstash.logback<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logstash-logback-encoder<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>添加配置文件<code>logback-spring.xml</code><br><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span><span class="meta">?&gt;</span></span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">include</span> <span class="attr">resource</span>=<span class="string">"org/springframework/boot/logging/logback/base.xml"</span> /&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"LOGSTASH"</span> <span class="attr">class</span>=<span class="string">"net.logstash.logback.appender.LogstashTcpSocketAppender"</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">destination</span>&gt;</span>127.0.0.1:5044<span class="tag">&lt;/<span class="name">destination</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="comment">&lt;!-- 日志输出编码 --&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">encoder</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span></span></span></span><br><span class="line"><span class="xml">                 class="net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder"&gt;</span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">providers</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">timestamp</span>&gt;</span></span></span><br><span class="line"><span class="xml">                    <span class="tag">&lt;<span class="name">timeZone</span>&gt;</span>UTC<span class="tag">&lt;/<span class="name">timeZone</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;/<span class="name">timestamp</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">pattern</span>&gt;</span></span></span><br><span class="line"><span class="xml">                    <span class="tag">&lt;<span class="name">pattern</span>&gt;</span></span></span><br><span class="line"><span class="xml">                        </span><span class="template-variable">&#123;</span></span><br><span class="line"><span class="template-variable">                        "logLevel": "%level",</span></span><br><span class="line"><span class="template-variable">                        "serviceName": "$&#123;springAppName:-&#125;</span><span class="xml">",</span></span><br><span class="line"><span class="xml">                        "pid": "$</span><span class="template-variable">&#123;PID:-&#125;</span><span class="xml">",</span></span><br><span class="line"><span class="xml">                        "thread": "%thread",</span></span><br><span class="line"><span class="xml">                        "class": "%logger</span><span class="template-variable">&#123;40&#125;</span><span class="xml">",</span></span><br><span class="line"><span class="xml">                        "rest": "%message"</span></span><br><span class="line"><span class="xml">                        &#125;</span></span><br><span class="line"><span class="xml">                    <span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;/<span class="name">providers</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">"INFO"</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"LOGSTASH"</span> /&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"CONSOLE"</span> /&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span></span><br></pre></td></tr></table></figure></p>
<p>启动应用，配置kibana的索引，如图所示<br><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/WechatIMG469.png" alt="image"></p>
<p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/WechatIMG470.png" alt="image"></p>
<p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/WechatIMG471.png" alt="image"></p>
<p>如果添加了索引，页面没有显示索引，还要继续添加的话，这个是Kibana的问题，重启一下Kibana容器就好了。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dinghuang.github.io/2020/06/23/业务埋点设计/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="强壮的病猫">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/dinghuang.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一只病猫">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/06/23/业务埋点设计/" itemprop="url">业务埋点设计</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-06-23T18:33:00+08:00">
                2020-06-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/程序设计/" itemprop="url" rel="index">
                    <span itemprop="name">程序设计</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/06/23/业务埋点设计/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/06/23/业务埋点设计/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <h1 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h1><p>可以先看一本书《精通Web Analytics 2.0》</p>
<h2 id="埋点是什么"><a href="#埋点是什么" class="headerlink" title="埋点是什么"></a>埋点是什么</h2><p>所谓埋点就是在应用中特定的流程收集一些信息，用来跟踪应用使用的状况，后续用来进一步优化产品或是提供运营的数据支撑，包括访问数（Visits），访客数（Visitor），停留时长（Time On Site），页面浏览数（Page Views）和跳出率（Bounce Rate）。这样的信息收集可以大致分为两种：页面统计（track this virtual page view），统计操作行为（track this button by an event）。</p>
<h2 id="埋点是谁的工作"><a href="#埋点是谁的工作" class="headerlink" title="埋点是谁的工作"></a>埋点是谁的工作</h2><p>现在公司通常都会有数据产品经理或业务线数据分析师，结合版本迭代过程进行埋点规划。如果是代码埋点，还需要开发完成相应的埋点代码。</p>
<h2 id="埋点的意义"><a href="#埋点的意义" class="headerlink" title="埋点的意义"></a>埋点的意义</h2><p>埋点就是为了对产品进行持续追踪，通过深度数据分析不断优化产品。好比去医院体检，医生测了你身体的各个健康指标，以此来判断你的健康状况。埋点的目的，其实就是随时或者定期监测你的产品的“健康”状况。</p>
<p>任何一个系统在设计初始阶段只关心核心业务的功能，等到系统上线以后，数据分析师对用户行为分析时会发现缺少很多数据，此时需要采用埋点的方法进行采集需要的数据。</p>
<p>业务人员主要通过自有或第三方的数据统计平台了解产品的概览性数据指标，包括新增用户数、活跃用户数等。这些指标能帮助企业宏观的了解用户访问的整体情况和趋势，从整体上把握产品的运营状况，但很难基于这些指标直接得到切实的产品改进策略。</p>
<p>而埋点将产品数据分析的深度下钻到流量分布和流动层面，通过对产品中的用户交互行为的统计分析，对宏观指标进行深入剖析，发现指标背后的问题，寻找人群的行为特点和关系，洞察用户行为与提升业务价值之间的潜在关联，了解组成特定数据现象的原因，并据此构建产品优化 迭代 和运营策略。</p>
<p>对于产品来说，用户在你的产品里做了什么、停留了多久、有什么异样，都是需要关注的。比如用户点击率怎么样？用户在核心使用路径上是否顺畅？有没有得到用户的认可？有没有因为设计按钮过多导致用户行为无效？用户希望有什么样的功能更新等等问题都可以通过埋点的方法实现。</p>
<p>埋点做好才能用来进行数据驱动产品和精细化运营。而埋点质量的好坏也直接影响到了产品运营的质量。因此它贯穿了产品的整个生命周期，为产品优化指明了方向。所以说，好的数据埋点，就成功了一半。</p>
<h2 id="when-amp-amp-where"><a href="#when-amp-amp-where" class="headerlink" title="when &amp;&amp; where"></a>when &amp;&amp; where</h2><p>埋点是目的导向。</p>
<p>在产品规划时就要思考数据埋点问题，如果在产品外发后再考虑怎么埋点，就会导致前期版本用户的数据无法收集，想要看某个数据时就会非常无奈，只有等到新版本完善来弥补。</p>
<p>思考要埋哪些点、埋点的形式，需要紧密结合产品迭代的方向、运营需求，并和数据开发等进行充分沟通以确认：</p>
<ul>
<li>埋点能够得到想要的数据解决/支持；</li>
<li>能够得到当前版本的复盘情况；</li>
<li>后续版本的数据支撑。</li>
</ul>
<p>通常的沟通过程以 埋点文档为载体；数据埋点评审为终结。</p>
<h3 id="当前版本的复盘情况："><a href="#当前版本的复盘情况：" class="headerlink" title="当前版本的复盘情况："></a>当前版本的复盘情况：</h3><ul>
<li>新版本功能使用情况，是否符合预期；</li>
<li>新功能上线后对其他功能点的影响？是否为整体均有积极作用；</li>
<li>版本运营活动目标群体的特征获取;</li>
<li>新增商业化目标的监测……</li>
</ul>
<h3 id="后续版本的数据支撑："><a href="#后续版本的数据支撑：" class="headerlink" title="后续版本的数据支撑："></a>后续版本的数据支撑：</h3><ul>
<li>规划方向的用户行为分析</li>
<li>画像特征分析</li>
</ul>
<h1 id="埋点指标："><a href="#埋点指标：" class="headerlink" title="埋点指标："></a>埋点指标：</h1><h2 id="基础指标"><a href="#基础指标" class="headerlink" title="基础指标"></a>基础指标</h2><p>基础指标是一些常用的参数指标，比如用户行为相关的，有用户数、新增用户数、活跃用户数等；用户设备相关的，比如电脑系统、地区、语言、国家、产品版本等；用户属性相关的，性别、年龄等。这一部分一般很难通过埋点拿到，但是通过一般第三方工具可以看个大概。</p>
<h2 id="用户行为数据指标"><a href="#用户行为数据指标" class="headerlink" title="用户行为数据指标"></a>用户行为数据指标</h2><p>用户行为的行为数据，就是埋点的核心了。这一部分根据不同的产品，收集的数据也不同。再拿PC端的腾讯视频举例，每个用户每天使用腾讯视频的时长是多少？每次看的是哪些视频？用户最喜欢看哪个频道的视频？每个频道的使用情况是怎么样的？用户一般是在一天中的哪个时间段打开腾讯视频的。想要看的数据非常多，而这些，都是要提前规划好，有目的性得去决定要埋什么点、怎么埋。如果你的目的是为了研究一下用户对弹幕的接受程度，那围绕弹幕，设置一些指标数据，比如发布弹幕的次数和频率？看视频时是否开启了弹幕？这样的话，就能够通过数据，看出用户对弹幕的真实反映，对于提升产品功能和运营都有很大帮助。</p>
<h2 id="核心质量指标"><a href="#核心质量指标" class="headerlink" title="核心质量指标"></a>核心质量指标</h2><p>Crash等一些因为产品质量引起的问题，都是用户所不能忍受的。而且用户量越大，越容易出现产品质量问题。尤其是一些产品，他的产品属性决定了，产品质量是吸引用户购买的一个很重要的因素。比如迅雷、photoshop等软件，核心质量的指标能帮助我们监控产品的“健康”情况。</p>
<p>这里说的质量指标，不单单指产品的 异常退出率、Crash率， 还包括和产品自身业务相关的指标。比如，对于视频编辑产品， 编辑成功率 是很重要的指标；对于迅雷， 下载成功率 是核心指标；对于在线类产品， 资源解析 成功率 是核心指标……</p>
<h2 id="访问与访客"><a href="#访问与访客" class="headerlink" title="访问与访客"></a>访问与访客</h2><p>访问次数（Visits）与访问人数（Vistors）是几乎所有应用都需要统计的指标，这也是最基础的指标。对于应用的统计来说，经常看到的DAU（日活跃用户数量），MAU（用户数量统计），UV（独立（IP）访客）等指标都是指统计访客（Vistors）。访问（Visits）是指会话层，用户打开应用花一段时间浏览又离开，从指标定义（访问次数）来说这被称之为统计会话（Session）数。一次会话（Session 或 Visit）是打开应用的第一个请求（打开应用）和最后一个请求决定的。如果用户打开应用然后放下手机或是离开电脑，并在接下来30分钟内没有任何动作，此次会话自动结束，通常也算作一次访问或会话期（30分钟是早起网页版应用约定俗成的会话数定义，目前用户停留在应用的时长变长，30分钟的限定也可能随之不同，总之是能代表一次用户访问的时长）。在计算访问人数（Vistors）时，埋点上报的数据是尽可能接近真实访客的人数。对于有需要统计独立访客这个指标的场景，这里还是需要强调一下，访问人数（Vistors）并不是真实独立的人，因此收集数据时必须知道访问人数虽然能够很好的反映使用应用的真实访问者的数量，但不等于使用应用的真实人数。（原因是，重复安装的应用，或是手机参数被修改都会使得独立访客的指标收到影响。计算访问人数的埋点都是依赖Cookie，用户打开应用，应用都会在此人的终端创建一个独立Cookie, Cookie会被保留，但还是难免会被用户手动清理或是Cookie被禁用导致同一用户使用应用Cookie不一致，所以独立访客只能高度接近于使用应用的真实人数。）</p>
<h2 id="停留时长"><a href="#停留时长" class="headerlink" title="停留时长"></a>停留时长</h2><p>停留时长用来衡量用户在应用的某一个页面或是一次访问（会话）所停留的时间。页面停留时长，表示在每个页面所花费的时间；例如：首页就是进入首页（10：00）到离开首页进入下一个页面(10:01)的时长，首页停留时长计算为1分钟。页面A是2分钟。停留时长的数据并不都是一定采集得到的，比如页面B进入时间（10：03），离开出现异常或是退出时间没有记录，这时候计算就是0 （所以指标计算时需要了解埋点的状况，剔除这样的无效数据）。应用的停留时长，表示一次访问（会话）所停留的时间，计算起来就是所有页面的访问时长，同样是上一个流程，应用的停留时长就是4分钟。</p>
<h2 id="跳出率"><a href="#跳出率" class="headerlink" title="跳出率"></a>跳出率</h2><p>跳出率的计算方法现在在各个公司还是很多种，最经常被使用的是：用户只访问了一个页面所占的会话比例（原因是：假设这种场景，用户来了访问了一个页面就离开了，想想用户使用的心里画面应该是：打开应用，心想什么鬼，然后关闭应用甚至卸载了。这个场景多可怕，这也是为什么跳出率指标被如此关注）跳出率可以分解到两个层次：一是整个应用的跳出率，二是重点的着陆页的跳出率，甚至是搜索关键词的跳出率。跳出率的指标可操作性非常强，通过统计跳出率可以直接发现页面的问题发现关键词的问题。</p>
<h2 id="退出率"><a href="#退出率" class="headerlink" title="退出率"></a>退出率</h2><p>退出率是针对页面的，这个指标的目标很简单，就是在针对某个页面有多少用户离开了应用，主要用户反映用户从应用离开的情况。哪些页面需要被改进最快的方式被发掘。（注意：退出率高不一定是坏事。例如：预测流程的最终节点的退出率就应该是高的）</p>
<h2 id="转化率"><a href="#转化率" class="headerlink" title="转化率"></a>转化率</h2><p>我们在产品上投入这么多，不就是为了衡量产出么？所以对于电商类应用，还有比转化率更值得关注的指标吗？转化率的计算方法是某种产出除以独立访客或是访问量，对于电商产品来说，就是提交订单用户数除以独立访客。转化率的计算看起来想到那简单，但却是埋点中最贴近业务的数据收集。这也是最体现埋点技巧的指标，需要结合业务特点制定计算方法。提交订单量/访客数是最基本的转化率，转化率还可以分层次，指定用户路径的，如：完成某条路径的提交订单数/访客数。</p>
<h2 id="参与度"><a href="#参与度" class="headerlink" title="参与度"></a>参与度</h2><p>参与度并不是一个指标，而是一系列的指标的统称，例如访问深度，访问频次，针对电商的下单次数，针对内容服务商的播放次数，及用户行为序列这些都可以是衡量参与度的指标。之所以把参与度列为一个指标，是希望大家明白把指标结合业务，产生化学反应，活学活用去发现事物的本质。</p>
<h1 id="数据采集普遍遇到的几个问题"><a href="#数据采集普遍遇到的几个问题" class="headerlink" title="数据采集普遍遇到的几个问题"></a>数据采集普遍遇到的几个问题</h1><ul>
<li>实时性，对于工具性产品在无网条件下的数据，无法实时上报；</li>
<li>完整性，由于用户隐私协议&amp;欧盟通用数据保护条例的，部分数据无法采集；</li>
<li>异常，android_id、idfa、idfv 随版本升级变化或无法获取。</li>
</ul>
<h1 id="怎么埋点"><a href="#怎么埋点" class="headerlink" title="怎么埋点"></a>怎么埋点</h1><h2 id="代码埋点"><a href="#代码埋点" class="headerlink" title="代码埋点"></a>代码埋点</h2><p>以为需要监测网站上/app上用户的行为，是需要在网页/app中加上一些代码的，当用户触发相应行为时，进行数据上报，也就是代码埋点。这样的代码，在网站上叫监测代码，在app中叫SDK（Software Development Kit）。市场上的第三方数据采集均支持代码埋点，GA, GrowingIO，神策等。</p>
<ul>
<li>优点<ul>
<li>采集的数据比较具有针对性，更加适合精细化数据分析。</li>
<li>同时也能提高数据的准确性。</li>
</ul>
</li>
<li>缺点<ul>
<li>每一个控件的埋点都需要添加相应的代码，不仅工作量大，而且限定了必须是技术开发人员才能完成。</li>
<li>每一次产品迭代，都需要更新埋点方案。</li>
</ul>
</li>
<li>适用场景<ul>
<li>有具体的业务分析需求，且按照各个事件埋点的方式不能满足。</li>
<li>需要对埋点事件进行传参等自定义属性设置。代码埋点虽然较复杂，但功能最完善，覆盖了埋点中的不同业务需求。</li>
</ul>
</li>
</ul>
<h2 id="可视化埋点"><a href="#可视化埋点" class="headerlink" title="可视化埋点"></a>可视化埋点</h2><p>利用可视化交互手段，数据产品/数据分析师可以通过可视化界面（管理后台连接设备） 配置事件，如下是腾讯移动分析的可视化埋点界面。可视化埋点仍需要先配置相关事件，再采集。</p>
<p>例如腾讯的<a href="https://mta.qq.com/" target="_blank" rel="noopener">https://mta.qq.com/</a><br><img src="https://mta.qq.com/v3/docs/assets/autotrack05.png" alt="image"></p>
<p>蚂蚁金服的移动开发平台<br><a href="https://tech.antfin.com/docs/2/49549" target="_blank" rel="noopener">https://tech.antfin.com/docs/2/49549</a></p>
<ul>
<li>优点<ul>
<li>业务人员可用，无需技术人员进行SDK嵌入，不懂代码的产品运营人员也可通过后台可视化界面配置和统计埋点并实时下发到客户端生效。</li>
<li>无需版本更新，由于不需要嵌入新SDK，不需要发布新版本，可谓即时生效。</li>
<li>对所有版本生效：新增埋点在所有版本生效，不存在迭代问题。</li>
</ul>
</li>
<li>缺点<ul>
<li>可覆盖的功能有限，目前并不是所有控件操作都可以通过这种方案进行定制。</li>
<li>不能自定义交互事件属性，由于获取的是交互事件元素的DOMpath，无法对具体事件设置参数。</li>
<li>不支持可以不断加载的内容瀑布流交互。</li>
</ul>
</li>
<li>适用场景<ul>
<li>分析或统计需求简单，不需要对埋点事件进行传参等自定义属性设置。</li>
<li>频繁上线或更新的H5类型的运营活动</li>
</ul>
</li>
</ul>
<h2 id="无埋点"><a href="#无埋点" class="headerlink" title="无埋点"></a>无埋点</h2><p>无埋点是指开发人员集成采集 SDK 后，SDK 便直接开始捕捉和监测用户在应用里的所有行为，并全部上报，不需要开发人员添加额外代码。</p>
<p>数据分析师/数据产品 通过管理后台的圈选功能来选出自己关注的用户行为，并给出事件命名。之后就可以结合时间属性、用户属性、事件进行分析了。所以无埋点并不是真的不用埋点了。目前市场第三方工具GrowingIO支持无埋点全量行为数据抓取<a href="https://growingio.jinshuju.com/" target="_blank" rel="noopener">https://growingio.jinshuju.com/</a></p>
<ul>
<li>优点<ul>
<li>因为无埋点对页面所有元素进行埋点，那么这个页面每个元素被点击的概率你也就知道，对点击概率比较大的元素可以进行深入分析。</li>
<li>可以在系统上线后使用，支持基于全量的数据回溯，因为无埋点在你部署SDK的时候数据就一直在收集，可帮助进行启发式、探索式的数据分析。</li>
<li>它技术门槛低，部署简单。</li>
</ul>
</li>
<li>缺点<ul>
<li>无埋点无法采集自定义属性，只使用通用大部门，通用的场景。</li>
<li>数据形式非业务导向，因为是对所有事件数据的自动收集，没有按照业务需求进行事件或区域设置，业务或数据人员在使用时或许不能直接使用，需要二次计算或处理。</li>
<li>兼容性不好，传输时效性较差等问题，因为是对所有的元素数据都收集，会给数据传输和服务器带来较大的压力。</li>
</ul>
</li>
<li>适用场景<ul>
<li>分析或统计需求简单，不需要对埋点事件进行传参等自定义属性设置的事件。</li>
<li>针对快速、频繁上线和迭代的H5类型的运营活动的评估。</li>
</ul>
</li>
</ul>
<p>总体来说，无埋点和可视化埋点更侧重结果的展现，对过程追溯少，更适合产品经理分析基础的产品功能流畅度、用户体验、产品路径设置等。代码埋点和后端埋点，不仅能展现结果，也会记录用户行为过程，支持深度的行为分析和偏好洞察，还可将行为数据与业务数据打通，适合产品和运营人员深度使用。</p>
<p>无论采用哪种埋点方式，都应该根据业务场景和产品阶段，梳理和构建数据分析体系。埋点规划混乱、数据采集无序、数据分析断层，最终将会让企业陷入“有数据而无价值”的境地。</p>
<h1 id="架构设计"><a href="#架构设计" class="headerlink" title="架构设计"></a>架构设计</h1><p><img src="http://qiniu.zlt2000.cn/FncpOSYb_pvFPf0kr9H7tU4ktdvq" alt="image"></p>
<p>通过 日志埋点 来实现业务监控和行为分析主要需要以下4个步骤</p>
<p>数据生成(埋点)<br>数据收集<br>数据解析(结构化)<br>数据落盘<br>数据使用(展示/分析)</p>
<h2 id="数据使用"><a href="#数据使用" class="headerlink" title="数据使用"></a>数据使用</h2><p><img src="http://qiniu.zlt2000.cn/FgAqw5FNDtsLfwUdNnlxShiJ64hk" alt="image"></p>
<h1 id="如何做数据埋点"><a href="#如何做数据埋点" class="headerlink" title="如何做数据埋点"></a>如何做数据埋点</h1><p>其实这个问题不应该问别人，应该问你自己，通过上文，我们已经知道了，如果你想绘制基础的人群画像你就需要获取用户机型、网络类型、操作系统，IP地域等数据；如果你想分析每一个注册转化率，你就需要获取每一个步骤的点击次数，然后制作成漏斗，看那一步转化率出现了问题……目的不一样，获取的数据也不一样，使用的埋点技术也不一样。<br><img src="https://img.shangyexinzhi.com/xztest-image/article/417f5f73ed680cfbab173acbf316212c.jpeg" alt="image"></p>
<p>那么，我们该如何选择埋点方式呢？</p>
<p>我们的目的是实现深度数据分析，不应该采用与其他企业通用的埋点方法，应该采用适合自己的埋点方法。也就是做到“因系统而异、避免千系统一面的情况。</p>
<p>在系统刚上线的初期阶段，我们可以采用无埋点的方式。因为我们通过UV、PV、点击率等基本指标及即可满足数据分析需求。如果产品上线时间很长，我们需要进行深度数据分析则选择代码埋点。它可以帮我们收集需要的属性。另外，如何埋点既可以在前端实现，也可以在后端实现，我们推荐在后端实现。因为后端数据可以保证数据的准确性。最后，如果您为了方便快捷并且免费，可以选择第三方统计工具，但是一定要选择适合自己业务的统计工具。</p>
<p>从业务过程中采集埋点，是数据驱动型公司的必要条件。一般公司的产品功能评审环节，不仅有 PRD (Product requirement document），还加入了对应的 DRD ( Data requirement document）。对于埋点而言，DRD 需要明确业务目标与埋点缺口之间的关系以及需求的优先级。埋点的需求大多来自于 DRD，整个过程会涉及多个角色，主要包括产品经理、业务数据负责人、开发工程师、测试工程师，如图所示。</p>
<p><img src="https://img.36krcdn.com/20200409/v2_d43dfb858dae4481bcefe8567e2b55fe_img_000" alt="image"></p>
<p>总之，如果您需要深度分析，选择后端（手动）埋点和无埋点组合的方案；如果您只是想看宏观数据，可以选择无埋点。无论采用哪种埋点方法，一定要慎重，根据需要来设置，最好不要出现错埋或者漏埋的情况。最后，数据分析师一定要和业务工程团队（部署实施埋点的部门）配合好才能实现完美的数据采集方案，有时候沟通比选择埋点方式更重。</p>
<h1 id="优秀的实践案例"><a href="#优秀的实践案例" class="headerlink" title="优秀的实践案例"></a>优秀的实践案例</h1><p>有赞埋点实践<a href="https://tech.youzan.com/track-1/" target="_blank" rel="noopener">https://tech.youzan.com/track-1/</a></p>
<p>美团点评前端无痕埋点实践<a href="https://tech.meituan.com/2017/03/02/mt-mobile-analytics-practice.html" target="_blank" rel="noopener">https://tech.meituan.com/2017/03/02/mt-mobile-analytics-practice.html</a></p>
<p>产品经理该如何做好数据埋点<a href="https://www.uisdc.com/product-manager-makes-data-event-tracking" target="_blank" rel="noopener">https://www.uisdc.com/product-manager-makes-data-event-tracking</a></p>
<p>数据统计埋点工作框架及细节规范<a href="https://www.inneed.club/articles/detail/pkx0epxgew" target="_blank" rel="noopener">https://www.inneed.club/articles/detail/pkx0epxgew</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dinghuang.github.io/2020/03/14/Activiti7.X结合SpringBoot2.1、Mybatis/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="强壮的病猫">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/dinghuang.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一只病猫">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/14/Activiti7.X结合SpringBoot2.1、Mybatis/" itemprop="url">Activiti7.X结合SpringBoot2.1、Mybatis</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-03-14T18:33:00+08:00">
                2020-03-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/03/14/Activiti7.X结合SpringBoot2.1、Mybatis/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/03/14/Activiti7.X结合SpringBoot2.1、Mybatis/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Activiti7-X结合SpringBoot2-1、Mybatis"><a href="#Activiti7-X结合SpringBoot2-1、Mybatis" class="headerlink" title="Activiti7.X结合SpringBoot2.1、Mybatis"></a>Activiti7.X结合SpringBoot2.1、Mybatis</h1><h2 id="Activiti简介"><a href="#Activiti简介" class="headerlink" title="Activiti简介"></a>Activiti简介</h2><h3 id="Activiti介绍"><a href="#Activiti介绍" class="headerlink" title="Activiti介绍"></a>Activiti介绍</h3><p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/2317879.png" alt="image"></p>
<p>Activiti 是由 jBPM 的创建者 Tom Baeyens 离开 JBoss 之后建立的项目，构建在开发 jBPM 版本 1 到 4 时积累的多年经验的基础之上，旨在创建下一代的 BPM 解决方案。</p>
<p>Activiti是一个开源的工作流引擎，它实现了BPMN 2.0规范，可以发布设计好的流程定义，并通过api进行流程调度。</p>
<p>Activiti 作为一个遵从 Apache 许可的工作流和业务流程管理开源平台，其核心是基于Java的超快速、超稳定的 BPMN2.0 流程引擎，强调流程服务的可嵌入性和可扩展性，同时更加强调面向业务人员。</p>
<p>Activiti 流程引擎重点关注在系统开发的易用性和轻量性上。每一项 BPM 业务功能 Activiti 流程引擎都以服务的形式提供给开发人员。通过使用这些服务，开发人员能够构建出功能丰富、轻便且高效的 BPM 应用程序。</p>
<p>Activiti是一个针对企业用户、开发人员、系统管理员的轻量级工作流业务管理平台，其核心是使用Java开发的快速、稳定的BPMN e 2.0流程引擎。Activiti是在ApacheV2许可下发布的，可以运行在任何类型的Java程序中，例如服务器、集群、云服务等。Activiti可以完美地与Spring集成。同时，基于简约思想的设计使Activiti非常轻量级。</p>
<p>目前Activiti有2个版本，一个本地的core，一个可以支持分布式的cloud，本文只介绍core，新版 Activiti 7.0.0 发布后，Activiti Cloud 现在是新一代商业自动化平台，提供一组旨在在分布式基础架构上运行的 Cloud原生构建块。Cloud可以参考<a href="https://activiti.gitbook.io/activiti-7-developers-guide/getting-started" target="_blank" rel="noopener">官网</a></p>
<p>Activiti 7.x 主要突出了 Spring Boot 2.x 应用程序中的 ProcessRuntime 和 TaskRuntime API 的使用。</p>
<h3 id="BPMN"><a href="#BPMN" class="headerlink" title="BPMN"></a>BPMN</h3><p>BPMN（Business Process Model And Notation）-业务流程模型和符号是由BPMI（Business Process Management Initiative）开发的一套标准的业务流程建模符号，使用BPMN提供的符号可以创建业务流程。</p>
<p>Activiti 就是使用BPMN 2.0 进行流程建模、流程执行管理，它包括很多的建模符号，比如：Event 用一个圆圈表示，它是流程中运行过程中发生的事情。</p>
<p>一个bpmn图形的例子：</p>
<p>首先当事人发起一个请假单<br>其次他所在部门的经理对请假单进行审核<br>然后人事经理进行复核并进行备案<br>最后请假流程结束</p>
<h2 id="创建应用"><a href="#创建应用" class="headerlink" title="创建应用"></a>创建应用</h2><p>代码库地址：<a href="https://github.com/dinghuang/activiti-service.git" target="_blank" rel="noopener">https://github.com/dinghuang/activiti-service.git</a></p>
<p>创建maven应用，pom引入包<br><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span><span class="meta">?&gt;</span></span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span></span><br><span class="line"><span class="xml">         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;</span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dinghuang-framework-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.dinghuang<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.1.0-RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>activiti<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>activiti<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>activiti project for Spring Boot<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.reporting.outputEncoding</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">mapstruct</span>&gt;</span>1.3.0.Final<span class="tag">&lt;/<span class="name">mapstruct</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">activiti.version</span>&gt;</span>7.1.0.M6<span class="tag">&lt;/<span class="name">activiti.version</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">spring-boot</span>&gt;</span>2.1.0.RELEASE<span class="tag">&lt;/<span class="name">spring-boot</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">fastjson</span>&gt;</span>1.2.47<span class="tag">&lt;/<span class="name">fastjson</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">commons-collections</span>&gt;</span>3.2.2<span class="tag">&lt;/<span class="name">commons-collections</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">commons-lang3</span>&gt;</span>3.8.1<span class="tag">&lt;/<span class="name">commons-lang3</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">swagger-annotations</span>&gt;</span>1.5.16<span class="tag">&lt;/<span class="name">swagger-annotations</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">springfox-swagger2</span>&gt;</span>2.7.0<span class="tag">&lt;/<span class="name">springfox-swagger2</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">druid</span>&gt;</span>1.1.10<span class="tag">&lt;/<span class="name">druid</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">mybatis-plus-boot-starter</span>&gt;</span>3.1.0<span class="tag">&lt;/<span class="name">mybatis-plus-boot-starter</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">feign-hystrix</span>&gt;</span>9.5.0<span class="tag">&lt;/<span class="name">feign-hystrix</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">lombok</span>&gt;</span>1.16.20<span class="tag">&lt;/<span class="name">lombok</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">mysql-connector-java</span>&gt;</span>8.0.15<span class="tag">&lt;/<span class="name">mysql-connector-java</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">liquibase-core</span>&gt;</span>3.5.3<span class="tag">&lt;/<span class="name">liquibase-core</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">validation-api</span>&gt;</span>2.0.1.Final<span class="tag">&lt;/<span class="name">validation-api</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">hibernate-validator</span>&gt;</span>6.0.15.Final<span class="tag">&lt;/<span class="name">hibernate-validator</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.activiti.dependencies<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>activiti-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$</span><span class="template-variable">&#123;activiti.version&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.12.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.activiti<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>activiti-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$</span><span class="template-variable">&#123;activiti.version&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.postgresql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>postgresql<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>42.2.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="comment">&lt;!-- Activiti生成流程图 --&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.activiti<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>activiti-image-generator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$</span><span class="template-variable">&#123;spring-boot&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.dinghuang<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dinghuang-framework-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.1.0-RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.6.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span></span><br><span class="line"><span class="xml">                    <span class="tag">&lt;<span class="name">source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span></span><br><span class="line"><span class="xml">                    <span class="tag">&lt;<span class="name">target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span></span><br><span class="line"><span class="xml">                    <span class="tag">&lt;<span class="name">annotationProcessorPaths</span>&gt;</span></span></span><br><span class="line"><span class="xml">                        <span class="comment">&lt;!--这个配置是因为lombok跟mapstruct一起用的时候maven对注解的解析器选择有点问题--&gt;</span></span></span><br><span class="line"><span class="xml">                        <span class="tag">&lt;<span class="name">path</span>&gt;</span></span></span><br><span class="line"><span class="xml">                            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mapstruct<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="xml">                            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mapstruct-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="xml">                            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$</span><span class="template-variable">&#123;mapstruct&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="xml">                        <span class="tag">&lt;/<span class="name">path</span>&gt;</span></span></span><br><span class="line"><span class="xml">                        <span class="tag">&lt;<span class="name">path</span>&gt;</span></span></span><br><span class="line"><span class="xml">                            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="xml">                            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="xml">                            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.16.20<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="xml">                        <span class="tag">&lt;/<span class="name">path</span>&gt;</span></span></span><br><span class="line"><span class="xml">                    <span class="tag">&lt;/<span class="name">annotationProcessorPaths</span>&gt;</span></span></span><br><span class="line"><span class="xml">                    <span class="tag">&lt;<span class="name">compilerArgs</span>&gt;</span></span></span><br><span class="line"><span class="xml">                        <span class="tag">&lt;<span class="name">compilerArg</span>&gt;</span></span></span><br><span class="line"><span class="xml">                            -Amapstruct.defaultComponentModel=spring</span></span><br><span class="line"><span class="xml">                        <span class="tag">&lt;/<span class="name">compilerArg</span>&gt;</span></span></span><br><span class="line"><span class="xml">                    <span class="tag">&lt;/<span class="name">compilerArgs</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="xml">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="xml">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">finalName</span>&gt;</span>demo<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span></span><br></pre></td></tr></table></figure></p>
<h3 id="与mysql结合"><a href="#与mysql结合" class="headerlink" title="与mysql结合"></a>与mysql结合</h3><p>在<code>resource</code>目录下准备文件<code>activiti.cfg.xml</code>，内容如下：<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml <span class="built_in">version</span>=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span>?&gt;</span><br><span class="line">&lt;beans xmlns=<span class="string">"http://www.springframework.org/schema/beans"</span></span><br><span class="line">       xmlns:xsi=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span><br><span class="line">       xsi:schemaLocation=<span class="string">"http://www.springframework.org/schema/beans</span></span><br><span class="line"><span class="string">                           http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;</span><br><span class="line">    &lt;bean <span class="built_in">id</span>=<span class="string">"processEngineConfiguration"</span> <span class="built_in">class</span>=<span class="string">"org.activiti.engine.impl.cfg.StandaloneProcessEngineConfiguration"</span>&gt;</span><br><span class="line">        &lt;<span class="keyword">property</span> <span class="built_in">name</span>=<span class="string">"databaseType"</span> value=<span class="string">"mysql"</span>&gt;&lt;/<span class="keyword">property</span>&gt;</span><br><span class="line">        &lt;<span class="keyword">property</span> <span class="built_in">name</span>=<span class="string">"jdbcUrl"</span> value=<span class="string">"jdbc:mysql://localhost:3306/activiti"</span>&gt;&lt;/<span class="keyword">property</span>&gt;</span><br><span class="line">        &lt;<span class="keyword">property</span> <span class="built_in">name</span>=<span class="string">"jdbcDriver"</span> value=<span class="string">"com.mysql.jdbc.Driver"</span>&gt;&lt;/<span class="keyword">property</span>&gt;</span><br><span class="line">        &lt;<span class="keyword">property</span> <span class="built_in">name</span>=<span class="string">"jdbcUsername"</span> value=<span class="string">"root"</span>&gt;&lt;/<span class="keyword">property</span>&gt;</span><br><span class="line">        &lt;<span class="keyword">property</span> <span class="built_in">name</span>=<span class="string">"jdbcPassword"</span> value=<span class="string">"root"</span>&gt;&lt;/<span class="keyword">property</span>&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure></p>
<p>执行下面的代码，初始化db数据库或者配置springboot配置文件，会自动生成25个表，代码执行如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.dinghuang.activiti.conf;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.impl.db.DbSchemaCreate;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> dinghuang123@gmail.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2020/2/28</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        DbSchemaCreate.main(args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>配置文件如下：<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr"> activiti:</span></span><br><span class="line">  <span class="comment"># 自动建表</span></span><br><span class="line"><span class="attr">  database-schema:</span> <span class="string">ACTIVITI</span></span><br><span class="line">  <span class="comment">#表示启动时检查数据库表，不存在则创建</span></span><br><span class="line"><span class="attr">  database-schema-update:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment">#表示哪种情况下使用历史表，这里配置为full表示全部记录历史，方便绘制流程图</span></span><br><span class="line"><span class="attr">  history-level:</span> <span class="string">full</span></span><br><span class="line">  <span class="comment">#表示使用历史表，如果不配置，则工程启动后可以检查数据库，只建立了17张表，历史表没有建立，则流程图及运行节点无法展示</span></span><br><span class="line"><span class="attr">  db-history-used:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">project:</span></span><br><span class="line"><span class="attr">  manifest:</span></span><br><span class="line"><span class="attr">    file:</span></span><br><span class="line"><span class="attr">      path:</span> <span class="attr">classpath:/default-project.json</span></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line"><span class="attr">  level:</span></span><br><span class="line">    <span class="string">org.activiti:</span> <span class="string">debug</span></span><br></pre></td></tr></table></figure></p>
<h4 id="数据库说明"><a href="#数据库说明" class="headerlink" title="数据库说明"></a>数据库说明</h4><p>数据库会生成25张表，ER图如图所示：<br><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/activiti.png" alt="image"><br>表的列表：<br><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/WechatIMG430.png" alt="image"></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">ACT_RE_*</span>: RE表示repository，这个前缀的表包含了流程定义和流程静态资源</span><br><span class="line"><span class="attribute">ACT_RU_*</span>: RU表示runtime，这些运行时的表，包含流程实例，任务，变量，异步任务等运行中的数据。Activiti只在流程实例执行过程中保存这些数据， 在流程结束时就会删除这些记录。</span><br><span class="line"><span class="attribute">ACT_ID_*</span>: ID表示identity，这些表包含身份信息，比如用户，组等。这些表现在已废弃。</span><br><span class="line"><span class="attribute">ACT_HI_*</span>: HI表示history，这些表包含历史数据，比如历史流程实例， 变量，任务等。</span><br><span class="line"><span class="attribute">ACT_GE_*</span>: 通用数据， 用于不同场景下。</span><br><span class="line"><span class="attribute">ACT_EVT_*</span>: EVT表示EVENT，目前只有一张表ACT_EVT_LOG，存储事件处理日志，方便管理员跟踪处理</span><br></pre></td></tr></table></figure>
<p>具体表详解可以参考<a href="https://www.chenmin.info/2018/07/28/Activiti-23%E5%BC%A0%E8%A1%A8%E5%8F%8A7%E5%A4%A7%E6%9C%8D%E5%8A%A1%E8%AF%A6%E8%A7%A3/#7%E5%A4%A7%E6%9C%8D%E5%8A%A1%E4%BB%8B%E7%BB%8D" target="_blank" rel="noopener">文章</a></p>
<h3 id="表详解"><a href="#表详解" class="headerlink" title="表详解"></a>表详解</h3><table>
<thead>
<tr>
<th>表</th>
<th>意义</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>ACT_EVT_LOG</td>
<td>事件处理日志</td>
<td></td>
</tr>
<tr>
<td>ACT_GE_BYTEARRAY</td>
<td>二进制数据表</td>
<td>存储流程定义相关的部署信息。即流程定义文档的存放地。每部署一次就会增加两条记录，一条是关于bpmn规则文件的，一条是图片的（如果部署时只指定了bpmn一个文件，activiti会在部署时解析bpmn文件内容自动生成流程图）。两个文件不是很大，都是以二进制形式存储在数据库中。</td>
</tr>
<tr>
<td>ACT_GE_PROPERTY</td>
<td>主键生成表</td>
<td>主张表将生成下次流程部署的主键ID。    </td>
</tr>
<tr>
<td>ACT_HI_ACTINST</td>
<td>历史节点表</td>
<td>只记录usertask内容,某一次流程的执行一共经历了多少个活动</td>
</tr>
<tr>
<td>ACT_HI_ATTACHMENT</td>
<td>历史附件表</td>
<td></td>
</tr>
<tr>
<td>ACT_HI_COMMENT</td>
<td>历史意见表</td>
<td></td>
</tr>
<tr>
<td>ACT_HI_DETAIL</td>
<td>历史详情表，提供历史变量的查询</td>
<td>流程中产生的变量详细，包括控制流程流转的变量等</td>
</tr>
<tr>
<td>ACT_HI_IDENTITYLINK</td>
<td>历史流程人员表</td>
<td></td>
</tr>
<tr>
<td>ACT_HI_PROCINST</td>
<td>历史流程实例表</td>
<td></td>
</tr>
<tr>
<td>ACT_HI_TASKINST</td>
<td>历史任务实例表</td>
<td>一次流程的执行一共经历了多少个任务</td>
</tr>
<tr>
<td>ACT_HI_VARINST</td>
<td>历史变量表</td>
<td></td>
</tr>
<tr>
<td>ACT_PROCDEF_INFO</td>
<td></td>
<td></td>
</tr>
<tr>
<td>ACT_RE_DEPLOYMENT</td>
<td>部署信息表</td>
<td>存放流程定义的显示名和部署时间，每部署一次增加一条记录</td>
</tr>
<tr>
<td>ACT_RE_MODEL</td>
<td>流程设计模型部署表</td>
<td>流程设计器设计流程后，保存数据到该表</td>
</tr>
<tr>
<td>ACT_RE_PROCDEF</td>
<td>流程定义数据表</td>
<td>存放流程定义的属性信息，部署每个新的流程定义都会在这张表中增加一条记录。注意：当流程定义的key相同的情况下，使用的是版本升级</td>
</tr>
<tr>
<td>ACT_RU_EVENT_SUBSCR</td>
<td>throwEvent，catchEvent时间监听信息表</td>
<td></td>
</tr>
<tr>
<td>ACT_RU_EXECUTION</td>
<td>运行时流程执行实例表</td>
<td>历史流程变量</td>
</tr>
<tr>
<td>ACT_RU_IDENTITYLINK</td>
<td>运行时流程人员表</td>
<td>主要存储任务节点与参与者的相关信息</td>
</tr>
<tr>
<td>ACT_RU_INTEGRATION</td>
<td></td>
<td></td>
</tr>
<tr>
<td>ACT_RU_JOB</td>
<td>运行时定时任务数据表    </td>
</tr>
<tr>
<td>ACT_RU_TIMER_JOB</td>
<td></td>
<td></td>
</tr>
<tr>
<td>ACT_RU_SUSPENDED_JOB</td>
<td></td>
<td></td>
</tr>
<tr>
<td>ACT_RU_TASK</td>
<td>运行时任务节点表</td>
<td></td>
</tr>
<tr>
<td>ACT_RU_TIMER_JOB</td>
<td></td>
<td></td>
</tr>
<tr>
<td>ACT_RU_VARIABLE</td>
<td>运行时流程变量数据表</td>
<td>通过JavaBean设置的流程变量，在act_ru_variable中存储的类型为serializable，变量真正存储的地方在act_ge_bytearray中。</td>
</tr>
<tr>
<td>ACT_ID_GROUP</td>
<td>用户组信息表</td>
<td>已废弃    </td>
</tr>
<tr>
<td>ACT_ID_INFO</td>
<td>用户扩展信息表</td>
<td>已废弃</td>
</tr>
<tr>
<td>ACT_ID_MEMBERSHIP</td>
<td>用户与用户组对应信息表</td>
<td>已废弃    </td>
</tr>
<tr>
<td>ACT_ID_USER</td>
<td>用户信息表</td>
<td>已废弃</td>
</tr>
</tbody>
</table>
<h2 id="工作流使用"><a href="#工作流使用" class="headerlink" title="工作流使用"></a>工作流使用</h2><p>activiti7内置了Spring security框架,官方demo跟spring结合的必须与spring-security结合，这里我不用spring-security，因为现在没有用户表了，所以自定义一些用户角色表去结合，更容易理解。</p>
<blockquote>
<p>关于security问题<br>activiti7最新的类似Runtime API和Task API都集成了security。<br>如果使用上述的API,那么必须要使用security，不能屏蔽security，否则会报错。<br>使用引擎服务类的时候，可以排除security，因为这些是最原始的API。但是activiti7官方已经明确说了，随时可能会干掉这些API。不建议开发人员直接使用引擎类以及引擎配置了、服务类等。</p>
</blockquote>
<h3 id="相关配置类"><a href="#相关配置类" class="headerlink" title="相关配置类"></a>相关配置类</h3><h4 id="自定义id策略"><a href="#自定义id策略" class="headerlink" title="自定义id策略"></a>自定义id策略</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">package</span> <span class="selector-tag">org</span><span class="selector-class">.dinghuang</span><span class="selector-class">.activiti</span><span class="selector-class">.conf</span>;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">com</span><span class="selector-class">.baomidou</span><span class="selector-class">.mybatisplus</span><span class="selector-class">.core</span><span class="selector-class">.toolkit</span><span class="selector-class">.IdWorker</span>;</span><br><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">org</span><span class="selector-class">.activiti</span><span class="selector-class">.engine</span><span class="selector-class">.impl</span><span class="selector-class">.cfg</span><span class="selector-class">.IdGenerator</span>;</span><br><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">org</span><span class="selector-class">.springframework</span><span class="selector-class">.stereotype</span><span class="selector-class">.Component</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义id策略</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @author dinghuang123@gmail.com</span></span><br><span class="line"><span class="comment"> * @since 2020/3/4</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">@<span class="keyword">Component</span></span><br><span class="line"><span class="keyword">public</span> class ActivitiIdGeneratorConfiguration implements IdGenerator &#123;</span><br><span class="line"></span><br><span class="line">    @<span class="keyword">Override</span></span><br><span class="line">    public String getNextId() &#123;</span><br><span class="line">        <span class="selector-tag">return</span> <span class="selector-tag">String</span><span class="selector-class">.valueOf</span>(<span class="selector-tag">IdWorker</span><span class="selector-class">.getId</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="自定义用户组"><a href="#自定义用户组" class="headerlink" title="自定义用户组"></a>自定义用户组</h4><p>activiti7已经抛弃了identity相关的表，同时与springSecurity结合，所以这边如果想自定义可以这么改，但是实际用途不大，最重要的是要结合自己的用户表设计来。<br><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">package org.dinghuang.activiti.conf;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.activiti.api.runtime.shared.identity.UserGroupManager;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.<span class="built_in">List</span>;</span><br><span class="line"><span class="keyword">import</span> java.util.<span class="built_in">Map</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="markdown">/**</span></span></span><br><span class="line"><span class="comment"><span class="markdown"> * 重写用户权限</span></span></span><br><span class="line"><span class="comment"><span class="markdown"> *</span></span></span><br><span class="line"><span class="comment"><span class="markdown"> * @author dinghuang123@gmail.com</span></span></span><br><span class="line"><span class="comment"><span class="markdown"> * @since 2020/3/2</span></span></span><br><span class="line"><span class="comment"><span class="markdown"> */</span></span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">ActivitiUserGroupManagerConfiguration</span> <span class="keyword">implements</span> <span class="title">UserGroupManager</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    private <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(ActivitiUserGroupManagerConfiguration.<span class="keyword">class</span>);</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">static</span> <span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; roles = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="number">3</span>);</span><br><span class="line">    public <span class="keyword">static</span> <span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; groups = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="number">1</span>);</span><br><span class="line">    public <span class="keyword">static</span> <span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; users = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="number">3</span>);</span><br><span class="line">    public <span class="keyword">static</span> <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">String</span>&gt; userRoleMap = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        roles.add(<span class="string">"workCreate"</span>);</span><br><span class="line">        roles.add(<span class="string">"workPermit"</span>);</span><br><span class="line">        roles.add(<span class="string">"workLeader"</span>);</span><br><span class="line"></span><br><span class="line">        groups.add(<span class="string">"workGroupA"</span>);</span><br><span class="line"></span><br><span class="line">        users.add(<span class="string">"admin"</span>);</span><br><span class="line">        users.add(<span class="string">"laowang"</span>);</span><br><span class="line">        users.add(<span class="string">"xiaofang"</span>);</span><br><span class="line"></span><br><span class="line">        userRoleMap.put(<span class="string">"admin"</span>, <span class="string">"workCreate"</span>);</span><br><span class="line">        userRoleMap.put(<span class="string">"laowang"</span>, <span class="string">"workPermit"</span>);</span><br><span class="line">        userRoleMap.put(<span class="string">"xiaofang"</span>, <span class="string">"workLeader"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    public <span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; getUserGroups(<span class="built_in">String</span> s) &#123;</span><br><span class="line">        LOGGER.info(<span class="string">"get user groups"</span>);</span><br><span class="line">        <span class="keyword">return</span> groups;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    public <span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; getUserRoles(<span class="built_in">String</span> s) &#123;</span><br><span class="line">        <span class="built_in">String</span> role = userRoleMap.<span class="keyword">get</span>(s);</span><br><span class="line">        <span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        list.add(role);</span><br><span class="line">        LOGGER.info(<span class="string">"get user roles"</span>);</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    public <span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; getGroups() &#123;</span><br><span class="line">        LOGGER.info(<span class="string">"get groups"</span>);</span><br><span class="line">        <span class="keyword">return</span> groups;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    public <span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; getUsers() &#123;</span><br><span class="line">        LOGGER.info(<span class="string">"get users"</span>);</span><br><span class="line">        <span class="keyword">return</span> users;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="其他自定义配置"><a href="#其他自定义配置" class="headerlink" title="其他自定义配置"></a>其他自定义配置</h4><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.dinghuang.activiti.conf;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.activiti.api.runtime.shared.identity.UserGroupManager;</span><br><span class="line"><span class="keyword">import</span> org.activiti.core.common.spring.project.ProjectModelService;</span><br><span class="line"><span class="keyword">import</span> org.activiti.engine.impl.history.HistoryLevel;</span><br><span class="line"><span class="keyword">import</span> org.activiti.spring.SpringAsyncExecutor;</span><br><span class="line"><span class="keyword">import</span> org.activiti.spring.SpringProcessEngineConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.dinghuang.activiti.controller.ActivitiController;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Primary;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.support.PathMatchingResourcePatternResolver;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.PlatformTransactionManager;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> dinghuang123@gmail.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2020/3/2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivitiSpringIdentityAutoConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(ActivitiController.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CORE_POOL_SIZE = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_POOL_SIZE = <span class="number">30</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> KEEP_ALIVE_SECONDS = <span class="number">300</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> QUEUE_CAPACITY = <span class="number">300</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DataSource dataSource;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PlatformTransactionManager platformTransactionManager;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserGroupManager userGroupManager;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ActivitiIdGeneratorConfiguration activitiIdGeneratorConfiguration;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ProjectModelService projectModelService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理引擎配置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function">SpringProcessEngineConfiguration <span class="title">springProcessEngineConfiguration</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        SpringProcessEngineConfiguration configuration = <span class="keyword">new</span> SpringProcessEngineConfiguration(projectModelService);</span><br><span class="line">        configuration.setDataSource(<span class="keyword">this</span>.dataSource);</span><br><span class="line">        configuration.setTransactionManager(<span class="keyword">this</span>.platformTransactionManager);</span><br><span class="line">        SpringAsyncExecutor asyncExecutor = <span class="keyword">new</span> SpringAsyncExecutor();</span><br><span class="line">        asyncExecutor.setTaskExecutor(workFlowAsync());</span><br><span class="line">        configuration.setAsyncExecutor(asyncExecutor);</span><br><span class="line">        configuration.setDatabaseSchemaUpdate(<span class="string">"true"</span>);</span><br><span class="line">        configuration.setUserGroupManager(<span class="keyword">this</span>.userGroupManager);</span><br><span class="line">        configuration.setHistoryLevel(HistoryLevel.FULL);</span><br><span class="line">        configuration.setDbHistoryUsed(<span class="keyword">true</span>);</span><br><span class="line">        configuration.setIdGenerator(<span class="keyword">this</span>.activitiIdGeneratorConfiguration);</span><br><span class="line">        Resource[] resources = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">// 启动自动部署流程</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            resources = <span class="keyword">new</span> PathMatchingResourcePatternResolver().getResources(<span class="string">"classpath*:bpmn/*.bpmn"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            LOGGER.<span class="keyword">error</span>(<span class="string">"Start the automated deployment process error"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        configuration.setDeploymentResources(resources);</span><br><span class="line">        <span class="keyword">return</span> configuration;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 线程池</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="meta">@Bean</span>(<span class="string">"workFlowTaskExecutor"</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="function">ThreadPoolTaskExecutor <span class="title">workFlowAsync</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ThreadPoolTaskExecutor executor = <span class="keyword">new</span> ThreadPoolTaskExecutor();</span><br><span class="line">        executor.setCorePoolSize(CORE_POOL_SIZE);</span><br><span class="line">        executor.setMaxPoolSize(MAX_POOL_SIZE);</span><br><span class="line">        executor.setKeepAliveSeconds(KEEP_ALIVE_SECONDS);</span><br><span class="line">        executor.setQueueCapacity(QUEUE_CAPACITY);</span><br><span class="line">        executor.setThreadNamePrefix(<span class="string">"workFlowTaskExecutor-"</span>);</span><br><span class="line">        executor.initialize();</span><br><span class="line">        <span class="keyword">return</span> executor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为去掉了springSecurity,所以启动类得排除springSecurity的自动配置。<br><figure class="highlight d"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.dinghuang.activiti;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.EnableWebMvc;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.view.InternalResourceViewResolver;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@SpringBootApplication</span>(exclude = &#123;</span><br><span class="line">        org.springframework.boot.autoconfigure.security.servlet.SecurityAutoConfiguration.<span class="keyword">class</span>,</span><br><span class="line">        org.springframework.boot.actuate.autoconfigure.security.servlet.ManagementWebSecurityAutoConfiguration.<span class="keyword">class</span>,</span><br><span class="line">        org.activiti.core.common.spring.identity.config.ActivitiSpringIdentityAutoConfiguration.<span class="keyword">class</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">@EnableWebMvc</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> ActivitiApplication &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> main(String[] args) &#123;</span><br><span class="line">        SpringApplication.run(ActivitiApplication.<span class="keyword">class</span>, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> InternalResourceViewResolver setupViewResolver() &#123;</span><br><span class="line">        InternalResourceViewResolver resolver = <span class="keyword">new</span> InternalResourceViewResolver();</span><br><span class="line">        <span class="comment">/** 设置视图路径的前缀 */</span></span><br><span class="line">        resolver.setPrefix(<span class="string">"resources/templates"</span>);</span><br><span class="line">        <span class="comment">/** 设置视图路径的后缀 */</span></span><br><span class="line">        resolver.setSuffix(<span class="string">".html"</span>);</span><br><span class="line">        <span class="keyword">return</span> resolver;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="流程绘制"><a href="#流程绘制" class="headerlink" title="流程绘制"></a>流程绘制</h2><p>流程绘制这里提供2种，一种用IDEA下载ActiBPM插件去画，这里给一段我自己画的xml<br><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span> standalone=<span class="string">"yes"</span><span class="meta">?&gt;</span></span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">definitions</span> <span class="attr">xmlns</span>=<span class="string">"http://www.omg.org/spec/BPMN/20100524/MODEL"</span> <span class="attr">xmlns:activiti</span>=<span class="string">"http://activiti.org/bpmn"</span> <span class="attr">xmlns:bpmndi</span>=<span class="string">"http://www.omg.org/spec/BPMN/20100524/DI"</span> <span class="attr">xmlns:dc</span>=<span class="string">"http://www.omg.org/spec/DD/20100524/DC"</span> <span class="attr">xmlns:di</span>=<span class="string">"http://www.omg.org/spec/DD/20100524/DI"</span> <span class="attr">xmlns:tns</span>=<span class="string">"http://sourceforge.net/bpmn/definitions/a123123"</span> <span class="attr">xmlns:xsd</span>=<span class="string">"http://www.w3.org/2001/XMLSchema"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xmlns:yaoqiang</span>=<span class="string">"http://bpmn.sourceforge.net"</span> <span class="attr">expressionLanguage</span>=<span class="string">"http://www.w3.org/1999/XPath"</span> <span class="attr">id</span>=<span class="string">"m1583310491794"</span> <span class="attr">name</span>=<span class="string">""</span> <span class="attr">targetNamespace</span>=<span class="string">"http://sourceforge.net/bpmn/definitions/a123123"</span> <span class="attr">typeLanguage</span>=<span class="string">"http://www.w3.org/2001/XMLSchema"</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">process</span> <span class="attr">id</span>=<span class="string">"dinghuangTest"</span> <span class="attr">isClosed</span>=<span class="string">"false"</span> <span class="attr">isExecutable</span>=<span class="string">"true"</span> <span class="attr">name</span>=<span class="string">"请假流程"</span> <span class="attr">processType</span>=<span class="string">"None"</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">startEvent</span> <span class="attr">id</span>=<span class="string">"_2"</span> <span class="attr">name</span>=<span class="string">"开始"</span>/&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">userTask</span> <span class="attr">activiti:assignee</span>=<span class="string">"bilu"</span> <span class="attr">activiti:candidateGroups</span>=<span class="string">"manager"</span> <span class="attr">activiti:exclusive</span>=<span class="string">"true"</span> <span class="attr">id</span>=<span class="string">"_3"</span> <span class="attr">name</span>=<span class="string">"部门经理审批"</span>/&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">endEvent</span> <span class="attr">id</span>=<span class="string">"_4"</span> <span class="attr">name</span>=<span class="string">"结束"</span>/&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">"_5"</span> <span class="attr">sourceRef</span>=<span class="string">"_2"</span> <span class="attr">targetRef</span>=<span class="string">"_3"</span>/&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">"_6"</span> <span class="attr">name</span>=<span class="string">"事情不重要"</span> <span class="attr">sourceRef</span>=<span class="string">"_3"</span> <span class="attr">targetRef</span>=<span class="string">"_4"</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">conditionExpression</span> <span class="attr">xsi:type</span>=<span class="string">"tFormalExpression"</span>&gt;</span>&lt;![CDATA[$</span><span class="template-variable">&#123;!important&#125;</span><span class="xml">]]&gt;<span class="tag">&lt;/<span class="name">conditionExpression</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">userTask</span> <span class="attr">activiti:candidateGroups</span>=<span class="string">"admin"</span> <span class="attr">activiti:exclusive</span>=<span class="string">"true"</span> <span class="attr">id</span>=<span class="string">"_7"</span> <span class="attr">name</span>=<span class="string">"总经理审批"</span>/&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">"_8"</span> <span class="attr">name</span>=<span class="string">"事情重要"</span> <span class="attr">sourceRef</span>=<span class="string">"_3"</span> <span class="attr">targetRef</span>=<span class="string">"_7"</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">conditionExpression</span> <span class="attr">xsi:type</span>=<span class="string">"tFormalExpression"</span>&gt;</span>&lt;![CDATA[$</span><span class="template-variable">&#123;important&#125;</span><span class="xml">]]&gt;<span class="tag">&lt;/<span class="name">conditionExpression</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">sequenceFlow</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">sequenceFlow</span> <span class="attr">id</span>=<span class="string">"_9"</span> <span class="attr">name</span>=<span class="string">"审批通过"</span> <span class="attr">sourceRef</span>=<span class="string">"_7"</span> <span class="attr">targetRef</span>=<span class="string">"_4"</span>/&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">process</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;<span class="name">bpmndi:BPMNDiagram</span> <span class="attr">documentation</span>=<span class="string">"background=#3C3F41;count=1;horizontalcount=1;orientation=0;width=842.4;height=1195.2;imageableWidth=832.4;imageableHeight=1185.2;imageableX=5.0;imageableY=5.0"</span> <span class="attr">id</span>=<span class="string">"Diagram-_1"</span> <span class="attr">name</span>=<span class="string">"New Diagram"</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">bpmndi:BPMNPlane</span> <span class="attr">bpmnElement</span>=<span class="string">"dinghuangTest"</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">bpmndi:BPMNShape</span> <span class="attr">bpmnElement</span>=<span class="string">"_2"</span> <span class="attr">id</span>=<span class="string">"Shape-_2"</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">dc:Bounds</span> <span class="attr">height</span>=<span class="string">"32.0"</span> <span class="attr">width</span>=<span class="string">"32.0"</span> <span class="attr">x</span>=<span class="string">"100.0"</span> <span class="attr">y</span>=<span class="string">"135.0"</span>/&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">bpmndi:BPMNLabel</span>&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">dc:Bounds</span> <span class="attr">height</span>=<span class="string">"32.0"</span> <span class="attr">width</span>=<span class="string">"32.0"</span> <span class="attr">x</span>=<span class="string">"0.0"</span> <span class="attr">y</span>=<span class="string">"0.0"</span>/&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">bpmndi:BPMNLabel</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">bpmndi:BPMNShape</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">bpmndi:BPMNShape</span> <span class="attr">bpmnElement</span>=<span class="string">"_3"</span> <span class="attr">id</span>=<span class="string">"Shape-_3"</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">dc:Bounds</span> <span class="attr">height</span>=<span class="string">"55.0"</span> <span class="attr">width</span>=<span class="string">"85.0"</span> <span class="attr">x</span>=<span class="string">"235.0"</span> <span class="attr">y</span>=<span class="string">"140.0"</span>/&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">bpmndi:BPMNLabel</span>&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">dc:Bounds</span> <span class="attr">height</span>=<span class="string">"55.0"</span> <span class="attr">width</span>=<span class="string">"85.0"</span> <span class="attr">x</span>=<span class="string">"0.0"</span> <span class="attr">y</span>=<span class="string">"0.0"</span>/&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">bpmndi:BPMNLabel</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">bpmndi:BPMNShape</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">bpmndi:BPMNShape</span> <span class="attr">bpmnElement</span>=<span class="string">"_4"</span> <span class="attr">id</span>=<span class="string">"Shape-_4"</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">dc:Bounds</span> <span class="attr">height</span>=<span class="string">"32.0"</span> <span class="attr">width</span>=<span class="string">"32.0"</span> <span class="attr">x</span>=<span class="string">"565.0"</span> <span class="attr">y</span>=<span class="string">"160.0"</span>/&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">bpmndi:BPMNLabel</span>&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">dc:Bounds</span> <span class="attr">height</span>=<span class="string">"32.0"</span> <span class="attr">width</span>=<span class="string">"32.0"</span> <span class="attr">x</span>=<span class="string">"0.0"</span> <span class="attr">y</span>=<span class="string">"0.0"</span>/&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">bpmndi:BPMNLabel</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">bpmndi:BPMNShape</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">bpmndi:BPMNShape</span> <span class="attr">bpmnElement</span>=<span class="string">"_7"</span> <span class="attr">id</span>=<span class="string">"Shape-_7"</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">dc:Bounds</span> <span class="attr">height</span>=<span class="string">"55.0"</span> <span class="attr">width</span>=<span class="string">"85.0"</span> <span class="attr">x</span>=<span class="string">"415.0"</span> <span class="attr">y</span>=<span class="string">"55.0"</span>/&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">bpmndi:BPMNLabel</span>&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">dc:Bounds</span> <span class="attr">height</span>=<span class="string">"55.0"</span> <span class="attr">width</span>=<span class="string">"85.0"</span> <span class="attr">x</span>=<span class="string">"0.0"</span> <span class="attr">y</span>=<span class="string">"0.0"</span>/&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">bpmndi:BPMNLabel</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">bpmndi:BPMNShape</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">bpmndi:BPMNEdge</span> <span class="attr">bpmnElement</span>=<span class="string">"_5"</span> <span class="attr">id</span>=<span class="string">"BPMNEdge__5"</span> <span class="attr">sourceElement</span>=<span class="string">"_2"</span> <span class="attr">targetElement</span>=<span class="string">"_3"</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">di:waypoint</span> <span class="attr">x</span>=<span class="string">"132.0"</span> <span class="attr">y</span>=<span class="string">"151.0"</span>/&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">di:waypoint</span> <span class="attr">x</span>=<span class="string">"235.0"</span> <span class="attr">y</span>=<span class="string">"167.5"</span>/&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">bpmndi:BPMNLabel</span>&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">dc:Bounds</span> <span class="attr">height</span>=<span class="string">"0.0"</span> <span class="attr">width</span>=<span class="string">"0.0"</span> <span class="attr">x</span>=<span class="string">"0.0"</span> <span class="attr">y</span>=<span class="string">"0.0"</span>/&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">bpmndi:BPMNLabel</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">bpmndi:BPMNEdge</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">bpmndi:BPMNEdge</span> <span class="attr">bpmnElement</span>=<span class="string">"_6"</span> <span class="attr">id</span>=<span class="string">"BPMNEdge__6"</span> <span class="attr">sourceElement</span>=<span class="string">"_3"</span> <span class="attr">targetElement</span>=<span class="string">"_4"</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">di:waypoint</span> <span class="attr">x</span>=<span class="string">"320.0"</span> <span class="attr">y</span>=<span class="string">"167.5"</span>/&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">di:waypoint</span> <span class="attr">x</span>=<span class="string">"565.0"</span> <span class="attr">y</span>=<span class="string">"176.0"</span>/&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">bpmndi:BPMNLabel</span>&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">dc:Bounds</span> <span class="attr">height</span>=<span class="string">"0.0"</span> <span class="attr">width</span>=<span class="string">"0.0"</span> <span class="attr">x</span>=<span class="string">"0.0"</span> <span class="attr">y</span>=<span class="string">"0.0"</span>/&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">bpmndi:BPMNLabel</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">bpmndi:BPMNEdge</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">bpmndi:BPMNEdge</span> <span class="attr">bpmnElement</span>=<span class="string">"_8"</span> <span class="attr">id</span>=<span class="string">"BPMNEdge__8"</span> <span class="attr">sourceElement</span>=<span class="string">"_3"</span> <span class="attr">targetElement</span>=<span class="string">"_7"</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">di:waypoint</span> <span class="attr">x</span>=<span class="string">"320.0"</span> <span class="attr">y</span>=<span class="string">"167.5"</span>/&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">di:waypoint</span> <span class="attr">x</span>=<span class="string">"415.0"</span> <span class="attr">y</span>=<span class="string">"82.5"</span>/&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">bpmndi:BPMNLabel</span>&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">dc:Bounds</span> <span class="attr">height</span>=<span class="string">"0.0"</span> <span class="attr">width</span>=<span class="string">"0.0"</span> <span class="attr">x</span>=<span class="string">"0.0"</span> <span class="attr">y</span>=<span class="string">"0.0"</span>/&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">bpmndi:BPMNLabel</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">bpmndi:BPMNEdge</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;<span class="name">bpmndi:BPMNEdge</span> <span class="attr">bpmnElement</span>=<span class="string">"_9"</span> <span class="attr">id</span>=<span class="string">"BPMNEdge__9"</span> <span class="attr">sourceElement</span>=<span class="string">"_7"</span> <span class="attr">targetElement</span>=<span class="string">"_4"</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">di:waypoint</span> <span class="attr">x</span>=<span class="string">"500.0"</span> <span class="attr">y</span>=<span class="string">"82.5"</span>/&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">di:waypoint</span> <span class="attr">x</span>=<span class="string">"565.0"</span> <span class="attr">y</span>=<span class="string">"176.0"</span>/&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">bpmndi:BPMNLabel</span>&gt;</span></span></span><br><span class="line"><span class="xml">          <span class="tag">&lt;<span class="name">dc:Bounds</span> <span class="attr">height</span>=<span class="string">"0.0"</span> <span class="attr">width</span>=<span class="string">"0.0"</span> <span class="attr">x</span>=<span class="string">"0.0"</span> <span class="attr">y</span>=<span class="string">"0.0"</span>/&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;/<span class="name">bpmndi:BPMNLabel</span>&gt;</span></span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">bpmndi:BPMNEdge</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">bpmndi:BPMNPlane</span>&gt;</span></span></span><br><span class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">bpmndi:BPMNDiagram</span>&gt;</span></span></span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">definitions</span>&gt;</span></span></span><br></pre></td></tr></table></figure></p>
<p>这是一个很简单的流程，如图所示:<br><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/WechatIMG432.png" alt="image"></p>
<h3 id="前端实现自定义流程、输出流程图"><a href="#前端实现自定义流程、输出流程图" class="headerlink" title="前端实现自定义流程、输出流程图"></a>前端实现自定义流程、输出流程图</h3><p>官方提供bpmn.js可以实现前端拖动画图，github地址：<a href="https://github.com/bpmn-io/bpmn-js" target="_blank" rel="noopener">https://github.com/bpmn-io/bpmn-js</a></p>
<p>可以把这个加到项目中，这里就不解释了。</p>
<p>前端实现输出流程图效果如下，流程节点会高亮显示：</p>
<p><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/WechatIMG433.png" alt="image"></p>
<p>这里是我写的一个小demo，代码可以查看我的github代码库。项目启动后，访问<a href="http://localhost:8080/v1/activiti/index" target="_blank" rel="noopener">http://localhost:8080/v1/activiti/index</a></p>
<h2 id="接口调试"><a href="#接口调试" class="headerlink" title="接口调试"></a>接口调试</h2><p>服务启动后访问地址：<a href="http://localhost:8080/swagger-ui.html#/" target="_blank" rel="noopener">http://localhost:8080/swagger-ui.html#/</a><br>接口已经写在代码中，如果需要调试的话，顺序是</p>
<ul>
<li>启动实例流程</li>
<li>根据用户名称查询任务列表（用户名bilu，拿到任务id后去完成任务）</li>
<li>审批approve</li>
<li>回退 back<br><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/WechatIMG434.png" alt="image"></li>
</ul>
<h3 id="实现随意跳转和回退撤回功能"><a href="#实现随意跳转和回退撤回功能" class="headerlink" title="实现随意跳转和回退撤回功能"></a>实现随意跳转和回退撤回功能</h3><p>因为activiti7是以图的形式来操作的，所以这边就要考虑连线的情况。</p>
<p>本文写了并行和串行的撤回以及撤回功能的连线的图，最终效果图如图所示<br><img src="https://minios.strongsickcat.com/dinghuang-blog-picture/WechatIMG451.png" alt="image"></p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown">/**</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">    * 输出图像</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">    *</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">    * @param response               响应实体</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">    * @param bpmnModel              图像对象</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">    * @param flowIds                已执行的线集合</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">    * @param executedActivityIdList void 已执行的节点ID集合</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">    */</span></span></span></span><br><span class="line">   public <span class="keyword">void</span> outputImg(HttpServletResponse response, BpmnModel bpmnModel, <span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; flowIds, <span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; executedActivityIdList) &#123;</span><br><span class="line">       InputStream imageStream = <span class="keyword">null</span>;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           imageStream = <span class="keyword">new</span> DefaultProcessDiagramGenerator().generateDiagram(bpmnModel, executedActivityIdList, flowIds, <span class="string">"宋体"</span>, <span class="string">"微软雅黑"</span>, <span class="string">"黑体"</span>, <span class="keyword">true</span>, <span class="string">"png"</span>);</span><br><span class="line">           <span class="comment">// 输出资源内容到相应对象</span></span><br><span class="line">           byte[] b = <span class="keyword">new</span> byte[<span class="number">1024</span>];</span><br><span class="line">           <span class="built_in">int</span> len;</span><br><span class="line">           <span class="keyword">while</span> ((len = imageStream.read(b, <span class="number">0</span>, <span class="number">1024</span>)) != <span class="number">-1</span>) &#123;</span><br><span class="line">               response.getOutputStream().write(b, <span class="number">0</span>, len);</span><br><span class="line">           &#125;</span><br><span class="line">           response.getOutputStream().flush();</span><br><span class="line">       &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">           LOGGER.error(<span class="string">"out put process img error！"</span>, e);</span><br><span class="line">       &#125; <span class="keyword">finally</span> &#123; <span class="comment">// 流关闭</span></span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               <span class="keyword">if</span> (imageStream != <span class="keyword">null</span>) &#123;</span><br><span class="line">                   imageStream.close();</span><br><span class="line">               &#125;</span><br><span class="line">           &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">               LOGGER.error(<span class="string">"IoException"</span>, e);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   public <span class="keyword">void</span> showImg(<span class="built_in">String</span> instanceKey, HttpServletResponse response) &#123;</span><br><span class="line">       <span class="keyword">if</span> (instanceKey == <span class="keyword">null</span>) &#123;</span><br><span class="line">           LOGGER.error(<span class="string">"process instance not exist"</span>);</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//获取流程实例</span></span><br><span class="line">       HistoricProcessInstance processInstance = historyService.createHistoricProcessInstanceQuery().processInstanceId(instanceKey).singleResult();</span><br><span class="line">       <span class="keyword">if</span> (processInstance == <span class="keyword">null</span>) &#123;</span><br><span class="line">           LOGGER.error(<span class="string">"process instance &#123;&#125; not exist"</span>, instanceKey);</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 根据流程对象获取流程对象模型</span></span><br><span class="line">       BpmnModel bpmnModel = repositoryService.getBpmnModel(processInstance.getProcessDefinitionId());</span><br><span class="line"></span><br><span class="line">       <span class="comment">//查看已执行的节点集合, 获取流程历史中已执行节点，并按照节点在流程中执行先后顺序排序</span></span><br><span class="line">       <span class="comment">// 构造历史流程查询</span></span><br><span class="line">       HistoricActivityInstanceQuery historyInstanceQuery = historyService.createHistoricActivityInstanceQuery().processInstanceId(instanceKey);</span><br><span class="line">       <span class="comment">// 查询历史节点,根据id排序</span></span><br><span class="line">       <span class="built_in">List</span>&lt;HistoricActivityInstance&gt; historicActivityInstanceList = historyInstanceQuery.orderBy(HistoricActivityInstanceQueryProperty.HISTORIC_ACTIVITY_INSTANCE_ID).asc().list();</span><br><span class="line">       <span class="keyword">if</span> (historicActivityInstanceList == <span class="keyword">null</span> || historicActivityInstanceList.size() == <span class="number">0</span>) &#123;</span><br><span class="line">           LOGGER.info(<span class="string">"process instance history node info not exist"</span>, instanceKey);</span><br><span class="line">           outputImg(response, bpmnModel, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, FlowNode&gt; flowNodeMap = getFlowNodeMap(historicActivityInstanceList, processInstance.getProcessDefinitionId());</span><br><span class="line">       <span class="comment">//处理撤回这种情况 根据id排序</span></span><br><span class="line">       <span class="built_in">List</span>&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(instanceKey).orderBy(TaskQueryProperty.TASK_ID).asc().list();</span><br><span class="line">       <span class="built_in">Set</span>&lt;<span class="built_in">String</span>&gt; executedActivityIdList = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</span><br><span class="line">       <span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; taskIdList = tasks == <span class="keyword">null</span> ? <span class="keyword">null</span> : tasks.stream().map(TaskInfo::getId).collect(Collectors.toList());</span><br><span class="line">       <span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; taskKeyList = tasks == <span class="keyword">null</span> ? <span class="keyword">null</span> : tasks.stream().map(TaskInfo::getTaskDefinitionKey).collect(Collectors.toList());</span><br><span class="line">       <span class="keyword">if</span> (tasks != <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="comment">//串行</span></span><br><span class="line">           <span class="keyword">if</span> (tasks.size() == <span class="number">1</span>) &#123;</span><br><span class="line">               <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; historicActivityInstanceList.size(); i++) &#123;</span><br><span class="line">                   <span class="keyword">if</span> (historicActivityInstanceList.<span class="keyword">get</span>(i).getTaskId() == <span class="keyword">null</span> || !historicActivityInstanceList.<span class="keyword">get</span>(i).getActivityId().equals(tasks.<span class="keyword">get</span>(<span class="number">0</span>).getTaskDefinitionKey())) &#123;</span><br><span class="line">                       executedActivityIdList.add(historicActivityInstanceList.<span class="keyword">get</span>(i).getActivityId());</span><br><span class="line">                   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                       executedActivityIdList.add(historicActivityInstanceList.<span class="keyword">get</span>(i).getActivityId());</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="built_in">List</span>&lt;HistoricVariableInstance&gt; historicVariableInstances = historyService.createHistoricVariableInstanceQuery()</span><br><span class="line">                       .processInstanceId(processInstance.getId()).list();</span><br><span class="line">               <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, HistoricVariableInstance&gt; historicVariableInstanceMap = historicVariableInstances.stream()</span><br><span class="line">                       .collect(Collectors.toMap(HistoricVariableInstance::getVariableName,</span><br><span class="line">                               historicVariableInstance -&gt; historicVariableInstance, BinaryOperator.maxBy(Comparator.comparing(HistoricVariableInstance::getId))));</span><br><span class="line">               <span class="comment">//并行</span></span><br><span class="line">               Collection&lt;FlowElement&gt; flowElementCollection = bpmnModel.getMainProcess().getFlowElements();</span><br><span class="line">               <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt;&gt; parentMap = <span class="keyword">new</span> HashMap&lt;&gt;(tasks.size());</span><br><span class="line">               <span class="keyword">for</span> (FlowElement flowElement : flowElementCollection) &#123;</span><br><span class="line">                   <span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; parentCodeList = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">                   <span class="keyword">if</span> (flowNodeMap.<span class="keyword">get</span>(flowElement.getId()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                       <span class="built_in">List</span>&lt;SequenceFlow&gt; sequenceFlows = flowNodeMap.<span class="keyword">get</span>(flowElement.getId()).getIncomingFlows();</span><br><span class="line">                       <span class="keyword">if</span> (sequenceFlows != <span class="keyword">null</span> &amp;&amp; !sequenceFlows.isEmpty()) &#123;</span><br><span class="line">                           <span class="keyword">for</span> (SequenceFlow sequenceFlow : sequenceFlows) &#123;</span><br><span class="line">                               parentCodeList.add(sequenceFlow.getSourceRef());</span><br><span class="line">                           &#125;</span><br><span class="line">                           parentMap.put(flowElement.getId(), parentCodeList);</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="built_in">Set</span>&lt;<span class="built_in">String</span>&gt; sameParentTaskCode = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</span><br><span class="line">               <span class="keyword">for</span> (Task task : tasks) &#123;</span><br><span class="line">                   <span class="comment">//找到所有任务拥有相同父级的集合任务</span></span><br><span class="line">                   <span class="keyword">for</span> (<span class="built_in">String</span> taskKey : parentMap.<span class="keyword">get</span>(task.getTaskDefinitionKey())) &#123;</span><br><span class="line">                       <span class="keyword">for</span> (<span class="built_in">String</span> key : parentMap.keySet()) &#123;</span><br><span class="line">                           <span class="keyword">if</span> (parentMap.<span class="keyword">get</span>(key).contains(taskKey)) &#123;</span><br><span class="line">                               sameParentTaskCode.add(key);</span><br><span class="line">                               <span class="keyword">break</span>;</span><br><span class="line">                           &#125;</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="comment">//说明是并行，但是做完的任务</span></span><br><span class="line">               <span class="keyword">for</span> (<span class="built_in">String</span> sameParentTask : sameParentTaskCode) &#123;</span><br><span class="line">                   <span class="keyword">if</span> (!taskKeyList.contains(sameParentTask)) &#123;</span><br><span class="line">                       <span class="built_in">List</span>&lt;SequenceFlow&gt; sequenceFlows = flowNodeMap.<span class="keyword">get</span>(sameParentTask).getOutgoingFlows();</span><br><span class="line">                       <span class="keyword">if</span> (sequenceFlows != <span class="keyword">null</span> &amp;&amp; !sequenceFlows.isEmpty()) &#123;</span><br><span class="line">                           <span class="keyword">for</span> (SequenceFlow sequenceFlow : sequenceFlows) &#123;</span><br><span class="line">                               <span class="keyword">if</span> (querySequenceFlowCondition(sequenceFlow, historicVariableInstanceMap)) &#123;</span><br><span class="line">                                   executedActivityIdList.add(sequenceFlow.getTargetRef());</span><br><span class="line">                               &#125;</span><br><span class="line">                           &#125;</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="keyword">for</span> (<span class="built_in">String</span> taskKey : sameParentTaskCode) &#123;</span><br><span class="line">                   <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; historicActivityInstanceList.size(); i++) &#123;</span><br><span class="line">                       <span class="keyword">if</span> (historicActivityInstanceList.<span class="keyword">get</span>(i).getTaskId() == <span class="keyword">null</span> || !historicActivityInstanceList.<span class="keyword">get</span>(i).getActivityId().equals(taskKey)) &#123;</span><br><span class="line">                           executedActivityIdList.add(historicActivityInstanceList.<span class="keyword">get</span>(i).getActivityId());</span><br><span class="line">                       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                           executedActivityIdList.add(historicActivityInstanceList.<span class="keyword">get</span>(i).getActivityId());</span><br><span class="line">                           <span class="keyword">break</span>;</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125;</span><br><span class="line"></span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//获取流程走过的线</span></span><br><span class="line">       <span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; executedActivityIdListResult = <span class="keyword">new</span> ArrayList&lt;&gt;(executedActivityIdList);</span><br><span class="line">       <span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; flowIds = getHighLightedFlows(bpmnModel, historicActivityInstanceList, executedActivityIdListResult, taskIdList);</span><br><span class="line">       <span class="comment">//输出图像，并设置高亮</span></span><br><span class="line">       outputImg(response, bpmnModel, flowIds, executedActivityIdListResult);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   private <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, FlowNode&gt; getFlowNodeMap(<span class="built_in">List</span>&lt;HistoricActivityInstance&gt; historicActivityInstanceList, <span class="built_in">String</span> processDefinitionId) &#123;</span><br><span class="line">       org.activiti.bpmn.model.Process process = repositoryService</span><br><span class="line">               .getBpmnModel(processDefinitionId)</span><br><span class="line">               .getMainProcess();</span><br><span class="line">       <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, FlowNode&gt; flowNodeMap = <span class="keyword">new</span> HashMap&lt;&gt;(historicActivityInstanceList.size());</span><br><span class="line">       <span class="keyword">for</span> (HistoricActivityInstance historicActivityInstance : historicActivityInstanceList) &#123;</span><br><span class="line">           <span class="keyword">if</span> (flowNodeMap.<span class="keyword">get</span>(historicActivityInstance.getActivityId()) == <span class="keyword">null</span>) &#123;</span><br><span class="line">               FlowNode sourceNode = (FlowNode) process.getFlowElement(historicActivityInstance.getActivityId());</span><br><span class="line">               flowNodeMap.put(historicActivityInstance.getActivityId(), sourceNode);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> flowNodeMap;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment"><span class="markdown">/**</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">    * 撤回任务</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">    *</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">    * @param currentTaskId currentTaskId</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">    * @param targetTaskId  targetTaskId 目标任务，如果为空，默认返回上级，如果找到上级有2个，那目标任务必须得传</span></span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="code">    */</span></span></span></span><br><span class="line">   <span class="meta">@Transactional</span>(rollbackFor = Exception.<span class="keyword">class</span>)</span><br><span class="line">   public <span class="keyword">void</span> backTask(<span class="built_in">String</span> currentTaskId, <span class="built_in">String</span> targetTaskId) &#123;</span><br><span class="line">       <span class="comment">//准备数据</span></span><br><span class="line">       TaskService taskService = processEngine.getTaskService();</span><br><span class="line">       <span class="comment">// 当前任务</span></span><br><span class="line">       Task currentTask = taskService.createTaskQuery().taskId(currentTaskId).singleResult();</span><br><span class="line">       <span class="built_in">String</span> processInstanceId = currentTask.getProcessInstanceId();</span><br><span class="line">       <span class="comment">// 获取流程定义</span></span><br><span class="line">       <span class="comment">//任务历史数据</span></span><br><span class="line">       <span class="built_in">List</span>&lt;HistoricTaskInstance&gt; historicTaskInstances = historyService</span><br><span class="line">               .createHistoricTaskInstanceQuery()</span><br><span class="line">               .processInstanceId(currentTask.getProcessInstanceId())</span><br><span class="line">               .orderBy(HistoricTaskInstanceQueryProperty.HISTORIC_TASK_INSTANCE_ID)</span><br><span class="line">               .desc()</span><br><span class="line">               .list();</span><br><span class="line">       <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, HistoricTaskInstance&gt; historicTaskInstanceMap = historicTaskInstances.stream().collect(Collectors.toMap(HistoricTaskInstance::getId, <span class="built_in">Function</span>.identity()));</span><br><span class="line">       <span class="comment">//所有节点操作数据</span></span><br><span class="line">       HistoricActivityInstanceQuery historyInstanceQuery = historyService.createHistoricActivityInstanceQuery().processInstanceId(processInstanceId);</span><br><span class="line">       <span class="built_in">List</span>&lt;HistoricActivityInstance&gt; historicActivityInstanceList = historyInstanceQuery.orderBy(HistoricActivityInstanceQueryProperty.HISTORIC_ACTIVITY_INSTANCE_ID).asc().list();</span><br><span class="line">       <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">List</span>&lt;HistoricActivityInstance&gt;&gt; historicActivityInstanceMap = historicActivityInstanceList.stream().collect(Collectors.groupingBy(HistoricActivityInstance::getActivityId));</span><br><span class="line">       <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, FlowNode&gt; flowNodeMap = getFlowNodeMap(historicActivityInstanceList, currentTask.getProcessDefinitionId());</span><br><span class="line">       <span class="comment">//排除当前任务外的所有正在进行的任务</span></span><br><span class="line">       <span class="built_in">List</span>&lt;Task&gt; taskList = taskService.createTaskQuery().processInstanceId(processInstanceId).list().stream().filter(task -&gt; !task.getId().equals(currentTask.getId())).collect(Collectors.toList());</span><br><span class="line">       handleBackTask(currentTask, currentTask.getTaskDefinitionKey(), targetTaskId, historicTaskInstanceMap, historicActivityInstanceMap, flowNodeMap, taskList, historicActivityInstanceList);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Transactional</span>(rollbackFor = Exception.<span class="keyword">class</span>)</span><br><span class="line">   public <span class="keyword">void</span> handleBackTask(Task currentTask, <span class="built_in">String</span> taskDefinitionKey, <span class="built_in">String</span> targetTaskId, <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, HistoricTaskInstance&gt; historicTaskInstanceMap, <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">List</span>&lt;HistoricActivityInstance&gt;&gt; historicActivityInstanceMap, <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, FlowNode&gt; flowNodeMap, <span class="built_in">List</span>&lt;Task&gt; taskList, <span class="built_in">List</span>&lt;HistoricActivityInstance&gt; historicActivityInstanceList) &#123;</span><br><span class="line">       <span class="comment">//判断是否并行</span></span><br><span class="line">       <span class="keyword">if</span> (taskList == <span class="keyword">null</span> || taskList.isEmpty()) &#123;</span><br><span class="line">           <span class="comment">//串行</span></span><br><span class="line">           handleSerial(currentTask, taskDefinitionKey, targetTaskId, historicTaskInstanceMap, historicActivityInstanceMap, flowNodeMap, taskList, historicActivityInstanceList);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="comment">//并行</span></span><br><span class="line">           handleParallel(currentTask, taskDefinitionKey, targetTaskId, historicTaskInstanceMap, historicActivityInstanceMap, flowNodeMap, taskList, historicActivityInstanceList);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Transactional</span>(rollbackFor = Exception.<span class="keyword">class</span>)</span><br><span class="line">   public <span class="keyword">void</span> handleParallel(Task currentTask, <span class="built_in">String</span> taskDefinitionKey, <span class="built_in">String</span> targetTaskId, <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, HistoricTaskInstance&gt; historicTaskInstanceMap, <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">List</span>&lt;HistoricActivityInstance&gt;&gt; historicActivityInstanceMap, <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, FlowNode&gt; flowNodeMap, <span class="built_in">List</span>&lt;Task&gt; taskList, <span class="built_in">List</span>&lt;HistoricActivityInstance&gt; historicActivityInstanceList) &#123;</span><br><span class="line">       <span class="built_in">List</span>&lt;SequenceFlow&gt; sequenceFlows = flowNodeMap.<span class="keyword">get</span>(taskDefinitionKey).getIncomingFlows();</span><br><span class="line">       <span class="keyword">if</span> (sequenceFlows.size() == <span class="number">1</span>) &#123;</span><br><span class="line">           <span class="comment">//当前节点的上级节点只有一条</span></span><br><span class="line">           SequenceFlow sequenceFlow = sequenceFlows.<span class="keyword">get</span>(<span class="number">0</span>);</span><br><span class="line">           <span class="comment">//查询历史节点</span></span><br><span class="line">           HistoricActivityInstance historicActivityInstance = historicActivityInstanceList.stream().filter(query -&gt; query.getActivityId().equals(sequenceFlow.getSourceRef())).collect(Collectors.toList()).<span class="keyword">get</span>(<span class="number">0</span>);</span><br><span class="line">           <span class="comment">//判断来源类型</span></span><br><span class="line">           <span class="keyword">if</span> (historicActivityInstance.getActivityType().equals(PARALLEL_GATEWAY)) &#123;</span><br><span class="line">               <span class="comment">//网关</span></span><br><span class="line">               <span class="comment">//查找网关的父任务</span></span><br><span class="line">               <span class="built_in">Set</span>&lt;<span class="built_in">String</span>&gt; parentFlowNodes = queryParentFlowNode(historicActivityInstance.getActivityId(), flowNodeMap);</span><br><span class="line">               <span class="keyword">if</span> (!parentFlowNodes.isEmpty()) &#123;</span><br><span class="line">                   <span class="keyword">if</span> (parentFlowNodes.size() == <span class="number">1</span>) &#123;</span><br><span class="line">                       <span class="comment">//如果只有一个父节点</span></span><br><span class="line">                       <span class="built_in">String</span> activityId = <span class="keyword">new</span> ArrayList&lt;&gt;(parentFlowNodes).<span class="keyword">get</span>(<span class="number">0</span>);</span><br><span class="line">                       <span class="keyword">if</span> (historicActivityInstanceMap.<span class="keyword">get</span>(activityId).<span class="keyword">get</span>(<span class="number">0</span>).getActivityType().equals(USER_TASK)) &#123;</span><br><span class="line">                           <span class="comment">//用户任务</span></span><br><span class="line">                           deleteTaskMultiple(flowNodeMap, <span class="keyword">null</span>, <span class="keyword">null</span>, activityId, currentTask, taskList, historicActivityInstance.getActivityId());</span><br><span class="line">                       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                           <span class="comment">//递归去查找父任务的前一个</span></span><br><span class="line">                           handleBackTask(currentTask, historicActivityInstanceMap.<span class="keyword">get</span>(activityId).<span class="keyword">get</span>(<span class="number">0</span>).getActivityId(), targetTaskId, historicTaskInstanceMap, historicActivityInstanceMap, flowNodeMap, taskList, historicActivityInstanceList);</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                       <span class="comment">//当前节点的上级节点有多条 这里需要指定要回退的taskId</span></span><br><span class="line">                       deleteTaskMultiple(flowNodeMap, historicTaskInstanceMap, targetTaskId, <span class="keyword">null</span>, currentTask, taskList, historicActivityInstance.getActivityId());</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   <span class="comment">//没有父级任务，图有问题</span></span><br><span class="line">                   <span class="keyword">throw</span> <span class="keyword">new</span> CommonValidateException(<span class="string">"bpmn doc error"</span>);</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (historicActivityInstance.getActivityType().equals(USER_TASK)) &#123;</span><br><span class="line">               <span class="comment">//用户任务</span></span><br><span class="line">               deleteTaskMultiple(flowNodeMap, <span class="keyword">null</span>, <span class="keyword">null</span>, historicActivityInstance.getActivityId(), currentTask, taskList, historicActivityInstance.getActivityId());</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="comment">//todo 还没想好这种场景</span></span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> CommonValidateException(BPMN_NOT_SUPPORT);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="comment">//当前节点的上级节点有多条 这里需要指定要回退的taskId</span></span><br><span class="line">           deleteTaskMultiple(flowNodeMap, historicTaskInstanceMap, targetTaskId, <span class="keyword">null</span>, currentTask, taskList, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Transactional</span>(rollbackFor = Exception.<span class="keyword">class</span>)</span><br><span class="line">   public <span class="keyword">void</span> handleSerial(Task currentTask, <span class="built_in">String</span> taskDefinitionKey, <span class="built_in">String</span> targetTaskId, <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, HistoricTaskInstance&gt; historicTaskInstanceMap, <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">List</span>&lt;HistoricActivityInstance&gt;&gt; historicActivityInstanceMap, <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, FlowNode&gt; flowNodeMap, <span class="built_in">List</span>&lt;Task&gt; taskList, <span class="built_in">List</span>&lt;HistoricActivityInstance&gt; historicActivityInstanceList) &#123;</span><br><span class="line">       FlowNode currentNode = flowNodeMap.<span class="keyword">get</span>(taskDefinitionKey);</span><br><span class="line">       <span class="built_in">List</span>&lt;SequenceFlow&gt; sequenceFlows = currentNode.getIncomingFlows();</span><br><span class="line">       <span class="keyword">if</span> (sequenceFlows.size() == <span class="number">1</span>) &#123;</span><br><span class="line">           SequenceFlow sequenceFlow = sequenceFlows.<span class="keyword">get</span>(<span class="number">0</span>);</span><br><span class="line">           HistoricActivityInstance historicActivityInstance = historicActivityInstanceMap.<span class="keyword">get</span>(sequenceFlow.getSourceRef()).<span class="keyword">get</span>(<span class="number">0</span>);</span><br><span class="line">           <span class="comment">//网关</span></span><br><span class="line">           <span class="keyword">if</span> (historicActivityInstance.getActivityType().equals(PARALLEL_GATEWAY) || historicActivityInstance.getActivityType().equals(EXCLUSIVE_GATEWAY)) &#123;</span><br><span class="line">               <span class="comment">//查找网关的父任务</span></span><br><span class="line">               <span class="built_in">Set</span>&lt;<span class="built_in">String</span>&gt; parentFlowNodes = queryParentFlowNode(historicActivityInstance.getActivityId(), flowNodeMap);</span><br><span class="line">               <span class="keyword">if</span> (!parentFlowNodes.isEmpty()) &#123;</span><br><span class="line">                   handleBackTaskSingle(parentFlowNodes, currentTask, targetTaskId, historicTaskInstanceMap, historicActivityInstanceMap, flowNodeMap, taskList, historicActivityInstanceList);</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   <span class="comment">//当前节点的上级节点有多条 这里需要指定要回退的taskId</span></span><br><span class="line">                   deleteTaskMultiple(flowNodeMap, historicTaskInstanceMap, targetTaskId, <span class="keyword">null</span>, currentTask, taskList, <span class="keyword">null</span>);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (historicActivityInstance.getActivityType().equals(USER_TASK)) &#123;</span><br><span class="line">               deleteTaskSingle(flowNodeMap, historicActivityInstance.getActivityId(), currentTask.getId());</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="comment">//todo 还没想好这种场景</span></span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> CommonValidateException(BPMN_NOT_SUPPORT);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, HistoricVariableInstance&gt; historicVariableInstanceMap = getHistoricVariableInstanceMap(currentTask.getProcessInstanceId());</span><br><span class="line">           <span class="comment">//串行的也有多条连线，可能是通过排他网关过来的</span></span><br><span class="line">           <span class="built_in">Set</span>&lt;HistoricActivityInstance&gt; historicActivityInstances = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">           <span class="keyword">for</span> (SequenceFlow sequenceFlow : sequenceFlows) &#123;</span><br><span class="line">               <span class="comment">//这边他的parent可能是没做过的，要找做过的</span></span><br><span class="line">               <span class="keyword">if</span> (historicActivityInstanceMap.<span class="keyword">get</span>(sequenceFlow.getSourceRef()) != <span class="keyword">null</span> &amp;&amp; querySequenceFlowCondition(sequenceFlow, historicVariableInstanceMap)) &#123;</span><br><span class="line">                   historicActivityInstances.addAll(historicActivityInstanceMap.<span class="keyword">get</span>(sequenceFlow.getSourceRef()));</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="comment">//走过的只有一个</span></span><br><span class="line">           <span class="keyword">if</span> (historicActivityInstances.size() == <span class="number">1</span>) &#123;</span><br><span class="line">               <span class="built_in">List</span>&lt;HistoricActivityInstance&gt; historicActivityInstancesList = <span class="keyword">new</span> ArrayList&lt;&gt;(historicActivityInstances);</span><br><span class="line">               <span class="keyword">if</span> (historicActivityInstancesList.<span class="keyword">get</span>(<span class="number">0</span>).getActivityType().equals(USER_TASK)) &#123;</span><br><span class="line">                   deleteTaskSingle(flowNodeMap, historicActivityInstancesList.<span class="keyword">get</span>(<span class="number">0</span>).getActivityId(), currentTask.getId());</span><br><span class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (historicActivityInstancesList.<span class="keyword">get</span>(<span class="number">0</span>).getActivityType().equals(EXCLUSIVE_GATEWAY)) &#123;</span><br><span class="line">                   <span class="comment">//排他网关</span></span><br><span class="line">                   <span class="built_in">Set</span>&lt;<span class="built_in">String</span>&gt; parentFlowNodes = queryParentFlowNode(historicActivityInstancesList.<span class="keyword">get</span>(<span class="number">0</span>).getActivityId(), flowNodeMap);</span><br><span class="line">                   handleBackTaskSingle(parentFlowNodes, currentTask, targetTaskId, historicTaskInstanceMap, historicActivityInstanceMap, flowNodeMap, taskList, historicActivityInstanceList);</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   <span class="comment">//todo 还没想好这种场景</span></span><br><span class="line">                   <span class="keyword">throw</span> <span class="keyword">new</span> CommonValidateException(BPMN_NOT_SUPPORT);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="comment">//当前节点的上级节点有多条 这里需要指定要回退的taskId</span></span><br><span class="line">               deleteTaskMultiple(flowNodeMap, historicTaskInstanceMap, targetTaskId, <span class="keyword">null</span>, currentTask, taskList, <span class="keyword">null</span>);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   private <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, HistoricVariableInstance&gt; getHistoricVariableInstanceMap(<span class="built_in">String</span> processInstanceId) &#123;</span><br><span class="line">       <span class="built_in">List</span>&lt;HistoricVariableInstance&gt; historicVariableInstances = historyService.createHistoricVariableInstanceQuery()</span><br><span class="line">               .processInstanceId(processInstanceId).list();</span><br><span class="line">       <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, HistoricVariableInstance&gt; historicVariableInstanceMap = historicVariableInstances.stream()</span><br><span class="line">               .collect(Collectors.toMap(HistoricVariableInstance::getVariableName,</span><br><span class="line">                       historicVariableInstance -&gt; historicVariableInstance, BinaryOperator.maxBy(Comparator.comparing(HistoricVariableInstance::getId))));</span><br><span class="line">       <span class="keyword">return</span> historicVariableInstanceMap;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Transactional</span>(rollbackFor = Exception.<span class="keyword">class</span>)</span><br><span class="line">   public <span class="keyword">void</span> handleBackTaskSingle(<span class="built_in">Set</span>&lt;<span class="built_in">String</span>&gt; parentFlowNodes, Task currentTask, <span class="built_in">String</span> targetTaskId, <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, HistoricTaskInstance&gt; historicTaskInstanceMap, <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">List</span>&lt;HistoricActivityInstance&gt;&gt; historicActivityInstanceMap, <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, FlowNode&gt; flowNodeMap, <span class="built_in">List</span>&lt;Task&gt; taskList, <span class="built_in">List</span>&lt;HistoricActivityInstance&gt; historicActivityInstanceList) &#123;</span><br><span class="line">       <span class="keyword">if</span> (parentFlowNodes.size() == <span class="number">1</span>) &#123;</span><br><span class="line">           <span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; parentFlowNodeList = <span class="keyword">new</span> ArrayList&lt;&gt;(parentFlowNodes);</span><br><span class="line">           <span class="keyword">if</span> (historicActivityInstanceMap.<span class="keyword">get</span>(parentFlowNodeList.<span class="keyword">get</span>(<span class="number">0</span>)).<span class="keyword">get</span>(<span class="number">0</span>).getActivityType().equals(USER_TASK)) &#123;</span><br><span class="line">               deleteTaskSingle(flowNodeMap, parentFlowNodeList.<span class="keyword">get</span>(<span class="number">0</span>), currentTask.getId());</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="comment">//递归去查找父任务的前一个</span></span><br><span class="line">               handleBackTask(currentTask, historicActivityInstanceMap.<span class="keyword">get</span>(parentFlowNodeList.<span class="keyword">get</span>(<span class="number">0</span>)).<span class="keyword">get</span>(<span class="number">0</span>).getActivityId(), targetTaskId, historicTaskInstanceMap, historicActivityInstanceMap, flowNodeMap, taskList, historicActivityInstanceList);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="comment">//当前节点的上级节点有多条 这里需要指定要回退的taskId</span></span><br><span class="line">           deleteTaskMultiple(flowNodeMap, historicTaskInstanceMap, targetTaskId, <span class="keyword">null</span>, currentTask, taskList, <span class="keyword">null</span>);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   private <span class="keyword">void</span> validatorTargetTask(<span class="built_in">Map</span>&lt;<span class="built_in">String</span>, HistoricTaskInstance&gt; historicTaskInstanceMap, <span class="built_in">String</span> targetTaskId) &#123;</span><br><span class="line">       <span class="keyword">if</span> (StringUtils.isEmpty(targetTaskId) || StringUtils.isBlank(targetTaskId)) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> CommonValidateException(<span class="string">"target task id cannot be null"</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (historicTaskInstanceMap == <span class="keyword">null</span> || historicTaskInstanceMap.isEmpty()) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> CommonValidateException(<span class="string">"historic task instance cannot be null"</span>);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Transactional</span>(rollbackFor = Exception.<span class="keyword">class</span>)</span><br><span class="line">   public <span class="keyword">void</span> deleteTaskMultiple(<span class="built_in">Map</span>&lt;<span class="built_in">String</span>, FlowNode&gt; flowNodeMap, <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, HistoricTaskInstance&gt; historicTaskInstanceMap, <span class="built_in">String</span> targetTaskId, <span class="built_in">String</span> targetTaskDefinitionKey, Task currentTask, <span class="built_in">List</span>&lt;Task&gt; taskList, <span class="built_in">String</span> targetParentTaskDefinitionKey) &#123;</span><br><span class="line">       <span class="keyword">if</span> (StringUtils.isEmpty(targetTaskDefinitionKey) || StringUtils.isBlank(targetTaskDefinitionKey)) &#123;</span><br><span class="line">           validatorTargetTask(historicTaskInstanceMap, targetTaskId);</span><br><span class="line">           targetTaskDefinitionKey = historicTaskInstanceMap.<span class="keyword">get</span>(targetTaskId).getTaskDefinitionKey();</span><br><span class="line">       &#125;</span><br><span class="line">       FlowNode targetNode = flowNodeMap.<span class="keyword">get</span>(targetTaskDefinitionKey);</span><br><span class="line">       ManagementService managementService = processEngine.getManagementService();</span><br><span class="line">       <span class="comment">//删除当前任务</span></span><br><span class="line">       managementService.executeCommand(<span class="keyword">new</span> DeleteTaskCmd(currentTask.getId()));</span><br><span class="line">       <span class="comment">// 删除当前运行的其他相同父任务的子任务</span></span><br><span class="line">       <span class="built_in">Set</span>&lt;Task&gt; sameParentTasks = getSameParentTasks(flowNodeMap, taskList, targetParentTaskDefinitionKey);</span><br><span class="line">       <span class="keyword">for</span> (Task task : sameParentTasks) &#123;</span><br><span class="line">           managementService.executeCommand(<span class="keyword">new</span> DeleteTaskCmd(task.getId()));</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// 流程执行到来源节点</span></span><br><span class="line">       managementService.executeCommand(<span class="keyword">new</span> SetFLowNodeAndGoCmd(targetNode, currentTask.getExecutionId()));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Transactional</span>(rollbackFor = Exception.<span class="keyword">class</span>)</span><br><span class="line">   public <span class="keyword">void</span> deleteTaskSingle(<span class="built_in">Map</span>&lt;<span class="built_in">String</span>, FlowNode&gt; flowNodeMap, <span class="built_in">String</span> targetTaskActivitiId, <span class="built_in">String</span> currentTaskId) &#123;</span><br><span class="line">       ManagementService managementService = processEngine.getManagementService();</span><br><span class="line">       FlowNode targetNode = flowNodeMap.<span class="keyword">get</span>(targetTaskActivitiId);</span><br><span class="line">       <span class="comment">// 删除当前运行任务</span></span><br><span class="line">       <span class="built_in">String</span> executionEntityId = managementService.executeCommand(<span class="keyword">new</span> DeleteTaskCmd(currentTaskId));</span><br><span class="line">       <span class="comment">// 流程执行到来源节点</span></span><br><span class="line">       managementService.executeCommand(<span class="keyword">new</span> SetFLowNodeAndGoCmd(targetNode, executionEntityId));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   private <span class="built_in">Set</span>&lt;<span class="built_in">String</span>&gt; queryParentFlowNode(<span class="built_in">String</span> activityId, <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, FlowNode&gt; flowNodeMap) &#123;</span><br><span class="line">       <span class="built_in">Set</span>&lt;<span class="built_in">String</span>&gt; flowNodeList = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">       <span class="keyword">for</span> (<span class="built_in">String</span> key : flowNodeMap.keySet()) &#123;</span><br><span class="line">           <span class="keyword">if</span> (!key.equals(activityId)) &#123;</span><br><span class="line">               FlowNode flowNode = flowNodeMap.<span class="keyword">get</span>(key);</span><br><span class="line">               <span class="built_in">List</span>&lt;SequenceFlow&gt; sequenceFlows = flowNode.getOutgoingFlows();</span><br><span class="line">               <span class="keyword">for</span> (SequenceFlow sequenceFlow : sequenceFlows) &#123;</span><br><span class="line">                   <span class="keyword">if</span> (sequenceFlow.getTargetRef().equals(activityId)) &#123;</span><br><span class="line">                       flowNodeList.add(key);</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> flowNodeList;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   private <span class="built_in">Set</span>&lt;Task&gt; getSameParentTasks(<span class="built_in">Map</span>&lt;<span class="built_in">String</span>, FlowNode&gt; flowNodeMap, <span class="built_in">List</span>&lt;Task&gt; taskList, <span class="built_in">String</span> taskDefinitionKey) &#123;</span><br><span class="line">       <span class="keyword">if</span> (taskDefinitionKey == <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">new</span> HashSet&lt;&gt;(taskList);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="built_in">Set</span>&lt;Task&gt; tasks = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">       <span class="keyword">for</span> (Task task : taskList) &#123;</span><br><span class="line">           <span class="built_in">List</span>&lt;SequenceFlow&gt; sequenceFlows = flowNodeMap.<span class="keyword">get</span>(task.getTaskDefinitionKey()).getIncomingFlows();</span><br><span class="line">           <span class="keyword">for</span> (SequenceFlow sequenceFlow : sequenceFlows) &#123;</span><br><span class="line">               <span class="keyword">if</span> (sequenceFlow.getSourceRef().equals(taskDefinitionKey)) &#123;</span><br><span class="line">                   tasks.add(task);</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> tasks;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Transactional</span>(rollbackFor = Exception.<span class="keyword">class</span>)</span><br><span class="line">   public <span class="keyword">void</span> importBpmnFile(MultipartFile file, <span class="built_in">String</span> type, <span class="built_in">String</span> typeName) &#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           InputStream fileInputStream = file.getInputStream();</span><br><span class="line">           <span class="comment">//创建转换对象</span></span><br><span class="line">           BpmnXMLConverter bpmnXMLConverter = <span class="keyword">new</span> BpmnXMLConverter();</span><br><span class="line">           <span class="comment">//读取xml文件</span></span><br><span class="line">           XMLInputFactory xmlInputFactory = XMLInputFactory.newInstance();</span><br><span class="line">           XMLStreamReader xmlStreamReader = xmlInputFactory.createXMLStreamReader(fileInputStream);</span><br><span class="line">           <span class="comment">//将xml文件转换成BpmnModel</span></span><br><span class="line">           BpmnModel bpmnModel = bpmnXMLConverter.convertToBpmnModel(xmlStreamReader);</span><br><span class="line">           bpmnModel.getMainProcess().setId(type);</span><br><span class="line">           bpmnModel.getMainProcess().setName(typeName);</span><br><span class="line">           Deployment deployment = repositoryService.createDeployment()</span><br><span class="line">                   .addBpmnModel(typeName + <span class="string">".bpmn"</span>, bpmnModel)</span><br><span class="line">                   .key(IdWorker.getIdStr())</span><br><span class="line">                   .deploy();</span><br><span class="line">           ProcessDefinition processDefinition = repositoryService.createProcessDefinitionQuery().deploymentId(deployment.getId()).singleResult();</span><br><span class="line">           BpmnModel model = repositoryService.getBpmnModel(processDefinition.getId());</span><br><span class="line">           <span class="keyword">if</span> (model != <span class="keyword">null</span>) &#123;</span><br><span class="line">               Collection&lt;FlowElement&gt; flowElementCollection = model.getMainProcess().getFlowElements();</span><br><span class="line">               <span class="keyword">for</span> (FlowElement e : flowElementCollection) &#123;</span><br><span class="line">                   LOGGER.info(<span class="string">"flowelement id:"</span> + e.getId() + <span class="string">"  name:"</span> + e.getName() + <span class="string">"   class:"</span> + e.getClass().toString());</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           activitiRepository.updateActReProcdef(processDefinition.getId());</span><br><span class="line">       &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">           LOGGER.error(<span class="string">"导入流程定义失败:&#123;&#125;"</span>, e.getMessage(), e);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
      <div id="sidebar-dimmer"></div>
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/dinghuang.png"
                alt="强壮的病猫" />
            
              <p class="site-author-name" itemprop="name">强壮的病猫</p>
              <p class="site-description motion-element" itemprop="description">学习、生活、闲谈、足球</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">29</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">14</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">14</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/dinghuang" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-globe"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:dinghuang123@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.strongsickcat.com" target="_blank" title="Google">
                      
                        <i class="fa fa-fw fa-google"></i>Google</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 &mdash; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">强壮的病猫</span>

  
</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
      <div id="needsharebutton-float">
        <span class="btn">
          <i class="fa fa-share-alt" aria-hidden="true"></i>
        </span>
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  

    
      <script id="dsq-count-scr" src="https://dinghuang-1.disqus.com/count.js" async></script>
    

    

  




	





  














  





  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  
  
  
  <link rel="stylesheet" href="/lib/needsharebutton/needsharebutton.css">

  
  
  <script src="/lib/needsharebutton/needsharebutton.js"></script>

  <script>
    
      pbOptions = {};
      
          pbOptions.iconStyle = "box";
      
          pbOptions.boxForm = "horizontal";
      
          pbOptions.position = "bottomCenter";
      
          pbOptions.networks = "Weibo,Wechat,Douban,QQZone,Twitter,Facebook";
      
      new needShareButton('#needsharebutton-postbottom', pbOptions);
    
    
      flOptions = {};
      
          flOptions.iconStyle = "box";
      
          flOptions.boxForm = "horizontal";
      
          flOptions.position = "middleRight";
      
          flOptions.networks = "Weibo,Wechat,Douban,QQZone,Twitter,Facebook";
      
      new needShareButton('#needsharebutton-float', flOptions);
    
  </script>

  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

</body>
</html>
